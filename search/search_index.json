{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Bievenido a mi web Aqu\u00ed estar\u00e9 posteando todas las pr\u00e1cticas que haga durante el curso 2021/2022 de 2\u00ba ASIR. Este blog est\u00e1 hecho con 2 objetivos principales en mente: Simpleza para m\u00ed a la hora de hacer tareas, y para los profesores a la hora de corregirlas. Crear documentaciones que sirvan tanto para futuros estudiantes del IES Gonzalo Nazareno como para m\u00ed, o cualquier estudiante de ASIR en general. Espero que lo posteado aqu\u00ed te sea utilidad, intento hacer mis pr\u00e1cticas siempre lo mejor posible.","title":"Principal"},{"location":"#bievenido-a-mi-web","text":"Aqu\u00ed estar\u00e9 posteando todas las pr\u00e1cticas que haga durante el curso 2021/2022 de 2\u00ba ASIR. Este blog est\u00e1 hecho con 2 objetivos principales en mente: Simpleza para m\u00ed a la hora de hacer tareas, y para los profesores a la hora de corregirlas. Crear documentaciones que sirvan tanto para futuros estudiantes del IES Gonzalo Nazareno como para m\u00ed, o cualquier estudiante de ASIR en general. Espero que lo posteado aqu\u00ed te sea utilidad, intento hacer mis pr\u00e1cticas siempre lo mejor posible.","title":"Bievenido a mi web"},{"location":"2021-09-22-ej1-pull-request/","text":"Paso 1 Hacemos fork del repositorio https://github.com/josedom24/prueba-pr-asir para tenerlo en nuestra cuenta de Github. Paso 2 Clonamos este repositorio (el repo de nuestra cuenta, no el original) a nuestra m\u00e1quina git clone git@github.com:adriasir123/prueba-pr-asir.git Paso 3 Creamos una nueva branch para los cambios git checkout -b adrian_jaramillo Github al aceptar Pull Requests fusiona branches, de ah\u00ed que tengamos que crear una Paso 4 A\u00f1adimos un nuevo remote, apuntando al repositorio original. Hacemos esto para poder hacer pull desde la versi\u00f3n original del repositorio, y traernos siempre los \u00faltimos cambios. git remote add upstream https://github.com/josedom24/prueba-pr-asir.git Como curiosidad, git remote show muestra la lista de remotes. Ahora tengo origin y upstream. Ahora tenemos que hacer lo siguiente para enlazar la branch main de upstream, a mi branch personalizada. git branch --set-upstream-to=upstream/main adrian_jaramillo Despu\u00e9s de haber hecho esto, AHORA S\u00cd puedo hacer pull desde upstream, aunque me aparece el siguiente warning: hint: Pulling without specifying how to reconcile divergent branches is hint: discouraged. You can squelch this message by running one of the following hint: commands sometime before your next pull: hint: hint: git config pull.rebase false # merge (the default strategy) hint: git config pull.rebase true # rebase hint: git config pull.ff only # fast-forward only hint: hint: You can replace \"git config\" with \"git config --global\" to set a default hint: preference for all repositories. You can also pass --rebase, --no-rebase, hint: or --ff-only on the command line to override the configured default per hint: invocation. A pesar de ser tan intimidante, podemos hacer pull sin problemas. Paso 5 Antes de modificar el repositorio, tenemos que asegurarnos de que estamos en la \u00faltima versi\u00f3n del repositorio original , para no quedarnos atr\u00e1s en commits y crear conflictos. Para ello, hacemos atlas@olympus:~/Desktop/iaw/ud1-intro/prueba-pr-asir$ git status On branch adrian_jaramillo Your branch is up to date with 'upstream/main'. En el caso de habernos quedado atr\u00e1s en commits, har\u00edamos git pull Paso 6 En el paso anterior, nos hemos asegurado de estar en la \u00faltima versi\u00f3n del repositorio. Procedemos a hacer los siguientes cambios... Cambio 1 Modifico README.md para a\u00f1adir un enlace a la lista, con mis iniciales \"ajr\" y apuntando al fichero que crear\u00e9 en el directorio files **\u00bfQu\u00e9 asignatura te gusta m\u00e1s? Y \u00bfpor qu\u00e9?** * [jdmr](files/jdmr.md) * [ada](files/ada.md) * [lpt](files/lpt.md) * [cmgpdg](files/cmgpdg.md) * [dpg](files/dpg.md) * [dpg2](files/dpg2.md) * [oeb](files/oeb.md) * [ajr](files/ajr.md) Al final de esa lista, vemos mi l\u00ednea a\u00f1adida. Cambio 2 Creo el fichero files/ajr.md atlas@olympus:~/Desktop/iaw/ud1-intro/prueba-pr-asir/files$ ls -la total 40 drwxr-xr-x 2 atlas atlas 4096 Sep 23 06:50 . drwxr-xr-x 4 atlas atlas 4096 Sep 23 06:41 .. -rw-r--r-- 1 atlas atlas 418 Sep 22 13:44 ada.md -rw-r--r-- 1 atlas atlas 400 Sep 23 06:50 ajr.md -rw-r--r-- 1 atlas atlas 119 Sep 22 14:16 cmgpdg.md -rw-r--r-- 1 atlas atlas 313 Sep 22 14:16 dpg.md -rw-r--r-- 1 atlas atlas 166 Sep 22 13:44 jdmr.md -rw-r--r-- 1 atlas atlas 1024 Sep 22 14:16 .jdmr.md.swp -rw-r--r-- 1 atlas atlas 265 Sep 22 14:16 lpt.md -rw-r--r-- 1 atlas atlas 115 Sep 22 14:28 oeb.md Lo vemos en la segunda fila, y su contenido es el siguiente # \u00bfQu\u00e9 asignatura te gusta m\u00e1s? Sinceramente nunca tuve una asignatura preferida, me gusta aprender en general. Pero si tengo que elegir, siempre me inclino m\u00e1s por cualquier tema relacionado con sysadmin: - **Sistemas operativos** - **Redes** - **\u00a1\u00a1VIRTUALIZACI\u00d3N!!** ## \u00bfPor qu\u00e9? *\u00bfNecesitamos un por qu\u00e9 para dar una explicaci\u00f3n l\u00f3gica a nuestros gustos? ;)* > Quote de ejemplo Paso 7 A\u00f1adimos nuestros cambios para el siguiente commit git add . Este comando a\u00f1ade TODOS los cambios del repositorio al siguiente commit Hacemos el commit, con un mensaje significativo git commit -m \"Modificaciones de AJR\" Hacemos push a nuestro repo git push origin Paso 8 Despu\u00e9s del push, tendremos en github el bot\u00f3n \"Compare & Pull Request\" Aqu\u00ed muestro el pull request \u00bfLo siguiente? Esperar a que el due\u00f1o del repositorio acepte los cambios. Paso 9 Para finalizar este ejercicio, mi repositorio se debe actualizar con todos los cambios posteriores que mis compa\u00f1eros hagan git pull git push origin URL a mi repositorio: https://github.com/adriasir123/prueba-pr-asir/tree/adrian_jaramillo","title":"ej1-pull-request"},{"location":"2021-09-22-ej1-pull-request/#paso-1","text":"Hacemos fork del repositorio https://github.com/josedom24/prueba-pr-asir para tenerlo en nuestra cuenta de Github.","title":"Paso 1"},{"location":"2021-09-22-ej1-pull-request/#paso-2","text":"Clonamos este repositorio (el repo de nuestra cuenta, no el original) a nuestra m\u00e1quina git clone git@github.com:adriasir123/prueba-pr-asir.git","title":"Paso 2"},{"location":"2021-09-22-ej1-pull-request/#paso-3","text":"Creamos una nueva branch para los cambios git checkout -b adrian_jaramillo Github al aceptar Pull Requests fusiona branches, de ah\u00ed que tengamos que crear una","title":"Paso 3"},{"location":"2021-09-22-ej1-pull-request/#paso-4","text":"A\u00f1adimos un nuevo remote, apuntando al repositorio original. Hacemos esto para poder hacer pull desde la versi\u00f3n original del repositorio, y traernos siempre los \u00faltimos cambios. git remote add upstream https://github.com/josedom24/prueba-pr-asir.git Como curiosidad, git remote show muestra la lista de remotes. Ahora tengo origin y upstream. Ahora tenemos que hacer lo siguiente para enlazar la branch main de upstream, a mi branch personalizada. git branch --set-upstream-to=upstream/main adrian_jaramillo Despu\u00e9s de haber hecho esto, AHORA S\u00cd puedo hacer pull desde upstream, aunque me aparece el siguiente warning: hint: Pulling without specifying how to reconcile divergent branches is hint: discouraged. You can squelch this message by running one of the following hint: commands sometime before your next pull: hint: hint: git config pull.rebase false # merge (the default strategy) hint: git config pull.rebase true # rebase hint: git config pull.ff only # fast-forward only hint: hint: You can replace \"git config\" with \"git config --global\" to set a default hint: preference for all repositories. You can also pass --rebase, --no-rebase, hint: or --ff-only on the command line to override the configured default per hint: invocation. A pesar de ser tan intimidante, podemos hacer pull sin problemas.","title":"Paso 4"},{"location":"2021-09-22-ej1-pull-request/#paso-5","text":"Antes de modificar el repositorio, tenemos que asegurarnos de que estamos en la \u00faltima versi\u00f3n del repositorio original , para no quedarnos atr\u00e1s en commits y crear conflictos. Para ello, hacemos atlas@olympus:~/Desktop/iaw/ud1-intro/prueba-pr-asir$ git status On branch adrian_jaramillo Your branch is up to date with 'upstream/main'. En el caso de habernos quedado atr\u00e1s en commits, har\u00edamos git pull","title":"Paso 5"},{"location":"2021-09-22-ej1-pull-request/#paso-6","text":"En el paso anterior, nos hemos asegurado de estar en la \u00faltima versi\u00f3n del repositorio. Procedemos a hacer los siguientes cambios...","title":"Paso 6"},{"location":"2021-09-22-ej1-pull-request/#cambio-1","text":"Modifico README.md para a\u00f1adir un enlace a la lista, con mis iniciales \"ajr\" y apuntando al fichero que crear\u00e9 en el directorio files **\u00bfQu\u00e9 asignatura te gusta m\u00e1s? Y \u00bfpor qu\u00e9?** * [jdmr](files/jdmr.md) * [ada](files/ada.md) * [lpt](files/lpt.md) * [cmgpdg](files/cmgpdg.md) * [dpg](files/dpg.md) * [dpg2](files/dpg2.md) * [oeb](files/oeb.md) * [ajr](files/ajr.md) Al final de esa lista, vemos mi l\u00ednea a\u00f1adida.","title":"Cambio 1"},{"location":"2021-09-22-ej1-pull-request/#cambio-2","text":"Creo el fichero files/ajr.md atlas@olympus:~/Desktop/iaw/ud1-intro/prueba-pr-asir/files$ ls -la total 40 drwxr-xr-x 2 atlas atlas 4096 Sep 23 06:50 . drwxr-xr-x 4 atlas atlas 4096 Sep 23 06:41 .. -rw-r--r-- 1 atlas atlas 418 Sep 22 13:44 ada.md -rw-r--r-- 1 atlas atlas 400 Sep 23 06:50 ajr.md -rw-r--r-- 1 atlas atlas 119 Sep 22 14:16 cmgpdg.md -rw-r--r-- 1 atlas atlas 313 Sep 22 14:16 dpg.md -rw-r--r-- 1 atlas atlas 166 Sep 22 13:44 jdmr.md -rw-r--r-- 1 atlas atlas 1024 Sep 22 14:16 .jdmr.md.swp -rw-r--r-- 1 atlas atlas 265 Sep 22 14:16 lpt.md -rw-r--r-- 1 atlas atlas 115 Sep 22 14:28 oeb.md Lo vemos en la segunda fila, y su contenido es el siguiente # \u00bfQu\u00e9 asignatura te gusta m\u00e1s? Sinceramente nunca tuve una asignatura preferida, me gusta aprender en general. Pero si tengo que elegir, siempre me inclino m\u00e1s por cualquier tema relacionado con sysadmin: - **Sistemas operativos** - **Redes** - **\u00a1\u00a1VIRTUALIZACI\u00d3N!!** ## \u00bfPor qu\u00e9? *\u00bfNecesitamos un por qu\u00e9 para dar una explicaci\u00f3n l\u00f3gica a nuestros gustos? ;)* > Quote de ejemplo","title":"Cambio 2"},{"location":"2021-09-22-ej1-pull-request/#paso-7","text":"A\u00f1adimos nuestros cambios para el siguiente commit git add . Este comando a\u00f1ade TODOS los cambios del repositorio al siguiente commit Hacemos el commit, con un mensaje significativo git commit -m \"Modificaciones de AJR\" Hacemos push a nuestro repo git push origin","title":"Paso 7"},{"location":"2021-09-22-ej1-pull-request/#paso-8","text":"Despu\u00e9s del push, tendremos en github el bot\u00f3n \"Compare & Pull Request\" Aqu\u00ed muestro el pull request \u00bfLo siguiente? Esperar a que el due\u00f1o del repositorio acepte los cambios.","title":"Paso 8"},{"location":"2021-09-22-ej1-pull-request/#paso-9","text":"Para finalizar este ejercicio, mi repositorio se debe actualizar con todos los cambios posteriores que mis compa\u00f1eros hagan git pull git push origin URL a mi repositorio: https://github.com/adriasir123/prueba-pr-asir/tree/adrian_jaramillo","title":"Paso 9"},{"location":"2021-10-14-ej2-pr-pag-compa%C3%B1ero/","text":"Ejercicio 2: Pull Request sobre p\u00e1gina de compa\u00f1ero Parte 1 Un pantallazo donde se vea el PR que has propuesto al repositorio de un compa\u00f1ero. Parte 2 Un pantallazo donde se vea el PR de un compa\u00f1ero en tu repositorio. Parte 3 Un pantallazo donde se vea tu p\u00e1gina con el cambio propuesto. Parte 4 Vuelve a mandar la URL de tu repositorio. https://github.com/adriasir123/practica-app-web-estatica-iaw-21-22","title":"ej2-pr-pag-compa\u00f1ero"},{"location":"2021-10-14-ej2-pr-pag-compa%C3%B1ero/#ejercicio-2-pull-request-sobre-pagina-de-companero","text":"","title":"Ejercicio 2: Pull Request sobre p\u00e1gina de compa\u00f1ero"},{"location":"2021-10-14-ej2-pr-pag-compa%C3%B1ero/#parte-1","text":"Un pantallazo donde se vea el PR que has propuesto al repositorio de un compa\u00f1ero.","title":"Parte 1"},{"location":"2021-10-14-ej2-pr-pag-compa%C3%B1ero/#parte-2","text":"Un pantallazo donde se vea el PR de un compa\u00f1ero en tu repositorio.","title":"Parte 2"},{"location":"2021-10-14-ej2-pr-pag-compa%C3%B1ero/#parte-3","text":"Un pantallazo donde se vea tu p\u00e1gina con el cambio propuesto.","title":"Parte 3"},{"location":"2021-10-14-ej2-pr-pag-compa%C3%B1ero/#parte-4","text":"Vuelve a mandar la URL de tu repositorio. https://github.com/adriasir123/practica-app-web-estatica-iaw-21-22","title":"Parte 4"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/","text":"Parte 1 Elije generador de p\u00e1ginas est\u00e1ticas y servicio donde desplegar la p\u00e1gina web MkDocs Neocities Parte 2 Documentar la instalaci\u00f3n de MkDocs en el entorno de desarrollo. sudo apt install pip pip install mkdocs Generamos la estructura inicial mkdocs new sysadmin-docs INFO - Creating project directory: sysadmin-docs INFO - Writing config file: sysadmin-docs/mkdocs.yml INFO - Writing initial docs: sysadmin-docs/docs/index.md Entramos cd sysadmin-docs Esta es la estructura generada vagrant@webestatica:~/sysadmin-docs$ tree . \u251c\u2500\u2500 docs \u2502 \u2514\u2500\u2500 index.md \u2514\u2500\u2500 mkdocs.yml 1 directory, 2 files Estando en la ra\u00edz de nuestro proyecto, ejecutamos mkdocs serve -a 0.0.0.0:8000 Lo ejecutamos de esta manera porque mi entorno de desarrollo es una VM, y necesito acceso externo. INFO - Building documentation... WARNING - Config value: 'dev_addr'. Warning: The use of the IP address '0.0.0.0' suggests a production environment or the use of a proxy to connect to the MkDocs server. However, the MkDocs' server is intended for local development purposes only. Please use a third party production-ready server instead. INFO - Cleaning site directory INFO - Documentation built in 0.05 seconds INFO - [08:43:27] Serving on http://0.0.0.0:8000/ Nos aparece ese warning, pero en nuestro caso no es relevante y lo ignoramos. Como vemos, mkdocs serve genera todo el c\u00f3digo necesario para que la web funcione, e inicia un servidor web para que podamos acceder a ella. Entramos a nuestra web: \u00a1\u00a1Dato importante! El servidor web que lanza MkDocs soporta auto-reloading . Esto significa que ante cualquier cambio de configuraci\u00f3n, ficheros, tema... etc: El servidor volver\u00e1 a generar todo el c\u00f3digo necesario Nuestro navegador se autorecargar\u00e1 ( \u00a1no hace falta hacer f5! ) y veremos los cambios autom\u00e1ticamente \u00bfEn qu\u00e9 lenguaje est\u00e1 desarrollado MkDocs? Python \u00bfQu\u00e9 sistema de plantillas utiliza? Jinja2 Parte 3 Cambiar el nombre de la p\u00e1gina El fichero a modificar es mkdocs.yml , con el siguiente contenido: site_name: Sysadmin Docs Nuestra p\u00e1gina ahora se ver\u00eda as\u00ed: Cambiar el tema de la p\u00e1gina Instalamos el tema: pip install mkdocs-windmill Modificamos mkdocs.yml site_name: Sysadmin Docs theme: windmill As\u00ed se ver\u00eda nuestra p\u00e1gina tras modificar el tema: Parte 4 A\u00f1ade 3 p\u00e1ginas a la web con: - Encabezado - P\u00e1rrafos - Enlace - Lista - Imagen P\u00e1gina about A\u00f1adimos docs/about.md Modificamos mkdocs.yml para definir la nav bar, y que la p\u00e1gina sea accesible: site_name: Sysadmin Docs theme: windmill nav: - Home: index.md - About: about.md As\u00ed se ver\u00eda: P\u00e1gina \"Secci\u00f3n 1\" A\u00f1adimos docs/seccion1.md Modificamos mkdocs.yml para que la p\u00e1gina sea accesible: site_name: Sysadmin Docs theme: windmill nav: - Home: index.md - Secci\u00f3n 1: seccion1.md - About: about.md As\u00ed se ver\u00eda: P\u00e1gina \"Secci\u00f3n 2\" A\u00f1adimos docs/seccion2.md Modificamos mkdocs.yml para que la p\u00e1gina sea accesible: site_name: Sysadmin Docs theme: windmill nav: - Home: index.md - Secci\u00f3n 1: seccion1.md - Secci\u00f3n 2: seccion2.md - About: about.md As\u00ed se ver\u00eda: El c\u00f3digo que estas desarrollando, configuraci\u00f3n del generado, p\u00e1ginas en markdown... todo debe estar en un repositorio Git (no es necesario que el c\u00f3digo generado se guarde en el repositorio, ev\u00edtalo usando el fichero .gitignore) Repositorio: https://github.com/adriasir123/practica-app-web-estatica-iaw-21-22 En el fichero .gitignore se excluye: site/ Parte 5 Explicar el proceso de despliegue en Neocities Generar ficheros Si no tenemos HTML, \u00bfno tenemos web que desplegar verdad? Por ello, antes de nada, generamos el c\u00f3digo: mkdocs build INFO - Cleaning site directory INFO - Building documentation to directory: /home/vagrant/sysadmin-docs/site INFO - Documentation built in 0.04 seconds Vemos que nos ha generado un directorio site con todo lo necesario. Esto nos encontramos: vagrant@webestatica:~/sysadmin-docs$ ls -la site/ total 64 drwxr-xr-x 10 vagrant vagrant 4096 Oct 10 21:28 . drwxr-xr-x 5 vagrant vagrant 4096 Oct 10 21:28 .. -rw-r--r-- 1 vagrant vagrant 1858 Oct 10 21:28 404.html drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 about drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 css drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 fonts drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 img -rw-r--r-- 1 vagrant vagrant 5899 Oct 10 21:28 index.html drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 js drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 search -rw-r--r-- 1 vagrant vagrant 2054 Oct 10 21:28 search.html drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 seccion1 drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 seccion2 -rw-r--r-- 1 vagrant vagrant 609 Oct 10 21:28 sitemap.xml -rw-r--r-- 1 vagrant vagrant 197 Oct 10 21:28 sitemap.xml.gz Despliegue en Neocities Crear cuenta https://neocities.org/ Nuestra web ser\u00e1 accesible en: https://sysadmin-docs.neocities.org/ Instalar Neocities CLI https://neocities.org/cli sudo apt update sudo apt install rubygems sudo gem install neocities Una vez instalada la herramienta, \u00a1no estamos logeados! Para conseguir esto no existe un comando concreto... al ejecutar cualquier orden que necesite comunicarse con el hosting nos pedir\u00e1 logearnos. Por ejemplo: neocities list / Con este comando mostramos ficheros remotos, y por lo tanto nos pide autenticaci\u00f3n: Please login to get your API key: sitename: sysadmin-docs password: \u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022 The api key for sysadmin-docs has been stored in /home/vagrant/.config/neocities/config. index.html \u00a1Cuidado! En el sitename escribimos s\u00f3lo la primera parte de nuestro nombre web. Neocities genera una estructura web de prueba, que tendremos que borrar. En mi caso borr\u00e9 todo menos index.html ... ni siquiera desde la CLI nos permite borrarlo. Subir ficheros El siguiente comando subir\u00e1 recursivamente todo el contenido del directorio que le indiquemos ( \u00a1su contenido , el directorio indicado no lo sube! ) neocities push site/ Uploading search.html ... SUCCESS Uploading sitemap.xml ... SUCCESS Uploading js/elasticlunr.js ... SUCCESS Uploading js/elasticlunr.min.js ... SUCCESS Uploading js/bootstrap-3.3.7.js ... SUCCESS Uploading js/highlight.pack.js ... SUCCESS Uploading js/jquery-3.2.1.js ... SUCCESS Uploading js/base.js ... SUCCESS Uploading js/bootstrap-3.3.7.min.js ... SUCCESS Uploading js/jquery-3.2.1.min.js ... SUCCESS Uploading sitemap.xml.gz ... ERROR: sitemap.xml.gz is not a valid file type (or contains not allowed content) for this site, files have not been uploaded (invalid_file_type) Uploading seccion1/index.html ... SUCCESS Uploading about/index.html ... SUCCESS Uploading 404.html ... SUCCESS Uploading css/base.css ... SUCCESS Uploading css/font-awesome-4.7.0.css ... SUCCESS Uploading css/highlight.css ... SUCCESS Uploading css/bootstrap-3.3.7.min.css ... SUCCESS Uploading css/font-awesome-4.7.0.min.css ... SUCCESS Uploading css/bootstrap-3.3.7.css ... SUCCESS Uploading seccion2/index.html ... SUCCESS Uploading img/favicon.ico ... SUCCESS Uploading search/search_index.json ... SUCCESS Uploading fonts/glyphicons-halflings-regular.svg ... SUCCESS Uploading fonts/fontawesome-webfont.ttf ... SUCCESS Uploading fonts/fontawesome-webfont.woff2 ... SUCCESS Uploading fonts/fontawesome-webfont.eot ... SUCCESS Uploading fonts/fontawesome-webfont.svg ... SUCCESS Uploading fonts/glyphicons-halflings-regular.woff ... SUCCESS Uploading fonts/glyphicons-halflings-regular.woff2 ... SUCCESS Uploading fonts/glyphicons-halflings-regular.ttf ... SUCCESS Uploading fonts/fontawesome-webfont.woff ... SUCCESS Uploading fonts/glyphicons-halflings-regular.eot ... SUCCESS Uploading index.html ... SUCCESS Vemos que hay un error, pero no es relevante. Es un fichero .gz que MkDocs crea, pero no tiene funci\u00f3n en que la web funcione o no. neocities push sobreescribe, por lo tanto el antiguo index.html que no pod\u00edamos borrar, ya est\u00e1 reemplazado. Si queremos hacer una prueba de push, sin que suba nada, podemos hacer: neocities push --dry-run site/ Teniendo el c\u00f3digo subido, ya tendremos nuestra web: Parte 6 Usar Git Hook para automatizar: generaci\u00f3n de la p\u00e1gina + despliegue en Neocities. Mostrar al profesor un ejemplo de como al modificar la p\u00e1gina se realiza la puesta en producci\u00f3n de forma autom\u00e1tica. Creamos el fichero de Git Hook: touch .git/hooks/pre-push Su contenido ser\u00e1: #!/bin/sh mkdocs build neocities push site/ Lo hacemos ejecutable: chmod u+x .git/hooks/pre-push Un Git Hook de \"pre-push\" es un script que se ejecuta antes de que la acci\u00f3n de push tome efecto. Por lo tanto, al hacer git push , esto pasar\u00eda: INFO - Cleaning site directory INFO - Building documentation to directory: /home/vagrant/sysadmin-docs/site INFO - Documentation built in 0.11 seconds Uploading search.html ... EXISTS Uploading sitemap.xml ... EXISTS Uploading js/elasticlunr.js ... EXISTS Uploading js/elasticlunr.min.js ... EXISTS Uploading js/bootstrap-3.3.7.js ... EXISTS Uploading js/highlight.pack.js ... EXISTS Uploading js/jquery-3.2.1.js ... EXISTS Uploading js/base.js ... EXISTS Uploading js/bootstrap-3.3.7.min.js ... EXISTS Uploading js/jquery-3.2.1.min.js ... EXISTS Uploading sitemap.xml.gz ... ERROR: sitemap.xml.gz is not a valid file type (or contains not allowed content) for this site, files have not been uploaded (invalid_file_type) Uploading seccion1/index.html ... EXISTS Uploading about/index.html ... SUCCESS Uploading 404.html ... EXISTS Uploading css/base.css ... EXISTS Uploading css/font-awesome-4.7.0.css ... EXISTS Uploading css/highlight.css ... EXISTS Uploading css/bootstrap-3.3.7.min.css ... EXISTS Uploading css/font-awesome-4.7.0.min.css ... EXISTS Uploading css/bootstrap-3.3.7.css ... EXISTS Uploading seccion2/index.html ... EXISTS Uploading img/favicon.ico ... EXISTS Uploading search/search_index.json ... SUCCESS Uploading fonts/glyphicons-halflings-regular.svg ... EXISTS Uploading fonts/fontawesome-webfont.ttf ... EXISTS Uploading fonts/fontawesome-webfont.woff2 ... EXISTS Uploading fonts/fontawesome-webfont.eot ... EXISTS Uploading fonts/fontawesome-webfont.svg ... EXISTS Uploading fonts/glyphicons-halflings-regular.woff ... EXISTS Uploading fonts/glyphicons-halflings-regular.woff2 ... EXISTS Uploading fonts/glyphicons-halflings-regular.ttf ... EXISTS Uploading fonts/fontawesome-webfont.woff ... EXISTS Uploading fonts/glyphicons-halflings-regular.eot ... EXISTS Uploading index.html ... SUCCESS Enumerating objects: 7, done. Counting objects: 100% (7/7), done. Compressing objects: 100% (4/4), done. Writing objects: 100% (4/4), 529 bytes | 529.00 KiB/s, done. Total 4 (delta 1), reused 0 (delta 0), pack-reused 0 remote: Resolving deltas: 100% (1/1), completed with 1 local object. To github.com:adriasir123/practica-app-web-estatica-iaw-21-22.git e0be61b..ecf9afe main -> main He a\u00f1adido una l\u00ednea a la p\u00e1gina \"About\" para hacer esta prueba: Esa l\u00ednea se ha a\u00f1adido autom\u00e1ticamente al hacer push, porque el hook generaba la p\u00e1gina y luego hac\u00eda push a Neocities.","title":"app-web-estatica"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#parte-1","text":"Elije generador de p\u00e1ginas est\u00e1ticas y servicio donde desplegar la p\u00e1gina web MkDocs Neocities","title":"Parte 1"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#parte-2","text":"Documentar la instalaci\u00f3n de MkDocs en el entorno de desarrollo. sudo apt install pip pip install mkdocs Generamos la estructura inicial mkdocs new sysadmin-docs INFO - Creating project directory: sysadmin-docs INFO - Writing config file: sysadmin-docs/mkdocs.yml INFO - Writing initial docs: sysadmin-docs/docs/index.md Entramos cd sysadmin-docs Esta es la estructura generada vagrant@webestatica:~/sysadmin-docs$ tree . \u251c\u2500\u2500 docs \u2502 \u2514\u2500\u2500 index.md \u2514\u2500\u2500 mkdocs.yml 1 directory, 2 files Estando en la ra\u00edz de nuestro proyecto, ejecutamos mkdocs serve -a 0.0.0.0:8000 Lo ejecutamos de esta manera porque mi entorno de desarrollo es una VM, y necesito acceso externo. INFO - Building documentation... WARNING - Config value: 'dev_addr'. Warning: The use of the IP address '0.0.0.0' suggests a production environment or the use of a proxy to connect to the MkDocs server. However, the MkDocs' server is intended for local development purposes only. Please use a third party production-ready server instead. INFO - Cleaning site directory INFO - Documentation built in 0.05 seconds INFO - [08:43:27] Serving on http://0.0.0.0:8000/ Nos aparece ese warning, pero en nuestro caso no es relevante y lo ignoramos. Como vemos, mkdocs serve genera todo el c\u00f3digo necesario para que la web funcione, e inicia un servidor web para que podamos acceder a ella. Entramos a nuestra web: \u00a1\u00a1Dato importante! El servidor web que lanza MkDocs soporta auto-reloading . Esto significa que ante cualquier cambio de configuraci\u00f3n, ficheros, tema... etc: El servidor volver\u00e1 a generar todo el c\u00f3digo necesario Nuestro navegador se autorecargar\u00e1 ( \u00a1no hace falta hacer f5! ) y veremos los cambios autom\u00e1ticamente \u00bfEn qu\u00e9 lenguaje est\u00e1 desarrollado MkDocs? Python \u00bfQu\u00e9 sistema de plantillas utiliza? Jinja2","title":"Parte 2"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#parte-3","text":"Cambiar el nombre de la p\u00e1gina El fichero a modificar es mkdocs.yml , con el siguiente contenido: site_name: Sysadmin Docs Nuestra p\u00e1gina ahora se ver\u00eda as\u00ed: Cambiar el tema de la p\u00e1gina Instalamos el tema: pip install mkdocs-windmill Modificamos mkdocs.yml site_name: Sysadmin Docs theme: windmill As\u00ed se ver\u00eda nuestra p\u00e1gina tras modificar el tema:","title":"Parte 3"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#parte-4","text":"A\u00f1ade 3 p\u00e1ginas a la web con: - Encabezado - P\u00e1rrafos - Enlace - Lista - Imagen","title":"Parte 4"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#pagina-about","text":"A\u00f1adimos docs/about.md Modificamos mkdocs.yml para definir la nav bar, y que la p\u00e1gina sea accesible: site_name: Sysadmin Docs theme: windmill nav: - Home: index.md - About: about.md As\u00ed se ver\u00eda:","title":"P\u00e1gina about"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#pagina-seccion-1","text":"A\u00f1adimos docs/seccion1.md Modificamos mkdocs.yml para que la p\u00e1gina sea accesible: site_name: Sysadmin Docs theme: windmill nav: - Home: index.md - Secci\u00f3n 1: seccion1.md - About: about.md As\u00ed se ver\u00eda:","title":"P\u00e1gina \"Secci\u00f3n 1\""},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#pagina-seccion-2","text":"A\u00f1adimos docs/seccion2.md Modificamos mkdocs.yml para que la p\u00e1gina sea accesible: site_name: Sysadmin Docs theme: windmill nav: - Home: index.md - Secci\u00f3n 1: seccion1.md - Secci\u00f3n 2: seccion2.md - About: about.md As\u00ed se ver\u00eda: El c\u00f3digo que estas desarrollando, configuraci\u00f3n del generado, p\u00e1ginas en markdown... todo debe estar en un repositorio Git (no es necesario que el c\u00f3digo generado se guarde en el repositorio, ev\u00edtalo usando el fichero .gitignore) Repositorio: https://github.com/adriasir123/practica-app-web-estatica-iaw-21-22 En el fichero .gitignore se excluye: site/","title":"P\u00e1gina \"Secci\u00f3n 2\""},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#parte-5","text":"Explicar el proceso de despliegue en Neocities","title":"Parte 5"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#generar-ficheros","text":"Si no tenemos HTML, \u00bfno tenemos web que desplegar verdad? Por ello, antes de nada, generamos el c\u00f3digo: mkdocs build INFO - Cleaning site directory INFO - Building documentation to directory: /home/vagrant/sysadmin-docs/site INFO - Documentation built in 0.04 seconds Vemos que nos ha generado un directorio site con todo lo necesario. Esto nos encontramos: vagrant@webestatica:~/sysadmin-docs$ ls -la site/ total 64 drwxr-xr-x 10 vagrant vagrant 4096 Oct 10 21:28 . drwxr-xr-x 5 vagrant vagrant 4096 Oct 10 21:28 .. -rw-r--r-- 1 vagrant vagrant 1858 Oct 10 21:28 404.html drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 about drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 css drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 fonts drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 img -rw-r--r-- 1 vagrant vagrant 5899 Oct 10 21:28 index.html drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 js drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 search -rw-r--r-- 1 vagrant vagrant 2054 Oct 10 21:28 search.html drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 seccion1 drwxr-xr-x 2 vagrant vagrant 4096 Oct 10 21:28 seccion2 -rw-r--r-- 1 vagrant vagrant 609 Oct 10 21:28 sitemap.xml -rw-r--r-- 1 vagrant vagrant 197 Oct 10 21:28 sitemap.xml.gz","title":"Generar ficheros"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#despliegue-en-neocities","text":"","title":"Despliegue en Neocities"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#crear-cuenta","text":"https://neocities.org/ Nuestra web ser\u00e1 accesible en: https://sysadmin-docs.neocities.org/","title":"Crear cuenta"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#instalar-neocities-cli","text":"https://neocities.org/cli sudo apt update sudo apt install rubygems sudo gem install neocities Una vez instalada la herramienta, \u00a1no estamos logeados! Para conseguir esto no existe un comando concreto... al ejecutar cualquier orden que necesite comunicarse con el hosting nos pedir\u00e1 logearnos. Por ejemplo: neocities list / Con este comando mostramos ficheros remotos, y por lo tanto nos pide autenticaci\u00f3n: Please login to get your API key: sitename: sysadmin-docs password: \u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022 The api key for sysadmin-docs has been stored in /home/vagrant/.config/neocities/config. index.html \u00a1Cuidado! En el sitename escribimos s\u00f3lo la primera parte de nuestro nombre web. Neocities genera una estructura web de prueba, que tendremos que borrar. En mi caso borr\u00e9 todo menos index.html ... ni siquiera desde la CLI nos permite borrarlo.","title":"Instalar Neocities CLI"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#subir-ficheros","text":"El siguiente comando subir\u00e1 recursivamente todo el contenido del directorio que le indiquemos ( \u00a1su contenido , el directorio indicado no lo sube! ) neocities push site/ Uploading search.html ... SUCCESS Uploading sitemap.xml ... SUCCESS Uploading js/elasticlunr.js ... SUCCESS Uploading js/elasticlunr.min.js ... SUCCESS Uploading js/bootstrap-3.3.7.js ... SUCCESS Uploading js/highlight.pack.js ... SUCCESS Uploading js/jquery-3.2.1.js ... SUCCESS Uploading js/base.js ... SUCCESS Uploading js/bootstrap-3.3.7.min.js ... SUCCESS Uploading js/jquery-3.2.1.min.js ... SUCCESS Uploading sitemap.xml.gz ... ERROR: sitemap.xml.gz is not a valid file type (or contains not allowed content) for this site, files have not been uploaded (invalid_file_type) Uploading seccion1/index.html ... SUCCESS Uploading about/index.html ... SUCCESS Uploading 404.html ... SUCCESS Uploading css/base.css ... SUCCESS Uploading css/font-awesome-4.7.0.css ... SUCCESS Uploading css/highlight.css ... SUCCESS Uploading css/bootstrap-3.3.7.min.css ... SUCCESS Uploading css/font-awesome-4.7.0.min.css ... SUCCESS Uploading css/bootstrap-3.3.7.css ... SUCCESS Uploading seccion2/index.html ... SUCCESS Uploading img/favicon.ico ... SUCCESS Uploading search/search_index.json ... SUCCESS Uploading fonts/glyphicons-halflings-regular.svg ... SUCCESS Uploading fonts/fontawesome-webfont.ttf ... SUCCESS Uploading fonts/fontawesome-webfont.woff2 ... SUCCESS Uploading fonts/fontawesome-webfont.eot ... SUCCESS Uploading fonts/fontawesome-webfont.svg ... SUCCESS Uploading fonts/glyphicons-halflings-regular.woff ... SUCCESS Uploading fonts/glyphicons-halflings-regular.woff2 ... SUCCESS Uploading fonts/glyphicons-halflings-regular.ttf ... SUCCESS Uploading fonts/fontawesome-webfont.woff ... SUCCESS Uploading fonts/glyphicons-halflings-regular.eot ... SUCCESS Uploading index.html ... SUCCESS Vemos que hay un error, pero no es relevante. Es un fichero .gz que MkDocs crea, pero no tiene funci\u00f3n en que la web funcione o no. neocities push sobreescribe, por lo tanto el antiguo index.html que no pod\u00edamos borrar, ya est\u00e1 reemplazado. Si queremos hacer una prueba de push, sin que suba nada, podemos hacer: neocities push --dry-run site/ Teniendo el c\u00f3digo subido, ya tendremos nuestra web:","title":"Subir ficheros"},{"location":"2021-10-5-implantacion-despliegue-aplicacion-web-estatica/#parte-6","text":"Usar Git Hook para automatizar: generaci\u00f3n de la p\u00e1gina + despliegue en Neocities. Mostrar al profesor un ejemplo de como al modificar la p\u00e1gina se realiza la puesta en producci\u00f3n de forma autom\u00e1tica. Creamos el fichero de Git Hook: touch .git/hooks/pre-push Su contenido ser\u00e1: #!/bin/sh mkdocs build neocities push site/ Lo hacemos ejecutable: chmod u+x .git/hooks/pre-push Un Git Hook de \"pre-push\" es un script que se ejecuta antes de que la acci\u00f3n de push tome efecto. Por lo tanto, al hacer git push , esto pasar\u00eda: INFO - Cleaning site directory INFO - Building documentation to directory: /home/vagrant/sysadmin-docs/site INFO - Documentation built in 0.11 seconds Uploading search.html ... EXISTS Uploading sitemap.xml ... EXISTS Uploading js/elasticlunr.js ... EXISTS Uploading js/elasticlunr.min.js ... EXISTS Uploading js/bootstrap-3.3.7.js ... EXISTS Uploading js/highlight.pack.js ... EXISTS Uploading js/jquery-3.2.1.js ... EXISTS Uploading js/base.js ... EXISTS Uploading js/bootstrap-3.3.7.min.js ... EXISTS Uploading js/jquery-3.2.1.min.js ... EXISTS Uploading sitemap.xml.gz ... ERROR: sitemap.xml.gz is not a valid file type (or contains not allowed content) for this site, files have not been uploaded (invalid_file_type) Uploading seccion1/index.html ... EXISTS Uploading about/index.html ... SUCCESS Uploading 404.html ... EXISTS Uploading css/base.css ... EXISTS Uploading css/font-awesome-4.7.0.css ... EXISTS Uploading css/highlight.css ... EXISTS Uploading css/bootstrap-3.3.7.min.css ... EXISTS Uploading css/font-awesome-4.7.0.min.css ... EXISTS Uploading css/bootstrap-3.3.7.css ... EXISTS Uploading seccion2/index.html ... EXISTS Uploading img/favicon.ico ... EXISTS Uploading search/search_index.json ... SUCCESS Uploading fonts/glyphicons-halflings-regular.svg ... EXISTS Uploading fonts/fontawesome-webfont.ttf ... EXISTS Uploading fonts/fontawesome-webfont.woff2 ... EXISTS Uploading fonts/fontawesome-webfont.eot ... EXISTS Uploading fonts/fontawesome-webfont.svg ... EXISTS Uploading fonts/glyphicons-halflings-regular.woff ... EXISTS Uploading fonts/glyphicons-halflings-regular.woff2 ... EXISTS Uploading fonts/glyphicons-halflings-regular.ttf ... EXISTS Uploading fonts/fontawesome-webfont.woff ... EXISTS Uploading fonts/glyphicons-halflings-regular.eot ... EXISTS Uploading index.html ... SUCCESS Enumerating objects: 7, done. Counting objects: 100% (7/7), done. Compressing objects: 100% (4/4), done. Writing objects: 100% (4/4), 529 bytes | 529.00 KiB/s, done. Total 4 (delta 1), reused 0 (delta 0), pack-reused 0 remote: Resolving deltas: 100% (1/1), completed with 1 local object. To github.com:adriasir123/practica-app-web-estatica-iaw-21-22.git e0be61b..ecf9afe main -> main He a\u00f1adido una l\u00ednea a la p\u00e1gina \"About\" para hacer esta prueba: Esa l\u00ednea se ha a\u00f1adido autom\u00e1ticamente al hacer push, porque el hook generaba la p\u00e1gina y luego hac\u00eda push a Neocities.","title":"Parte 6"},{"location":"ej1-apps-flask-apache2-mod_wsgi/","text":"Ejercicio 1: Desplegando aplicaciones flask con Apache + mod_wsgi En esta tarea se usa la aplicaci\u00f3n Guestbook . Crear venv mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source bin/activate Descargar Guestbook sudo apt install git git clone https://github.com/josedom24/guestbook.git pip install -r requirements.txt sudo apt install redis Probar funcionamiento Por ahora, usando el servidor de desarrollo: python3 app.py Fichero wsgi /home/vagrant/guestbook/app/wsgi.py from app import prog as application Hacer que Apache sirva Guestbook sudo apt install apache2 sudo apt install libapache2-mod-wsgi-py3 Creo /etc/apache2/sites-available/guestbook.conf : <VirtualHost *:80> ServerName www.guestbook.com DocumentRoot /home/vagrant/guestbook/app <Directory /home/vagrant/guestbook/app> Require all granted </Directory> WSGIDaemonProcess guestbook python-path=/home/vagrant/guestbook/app:/home/vagrant/venv/lib/python3.9/site-packages WSGIProcessGroup guestbook WSGIScriptAlias / /home/vagrant/guestbook/app/wsgi.py process-group=guestbook </VirtualHost> Lo habilito: sudo a2ensite guestbook.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej1-apps-flask-apache2-mod_wsgi resolutions 192.168.121.136 www.guestbook.com Probar funcionamiento Apache","title":"Ejercicio 1: Apache + mod_wsgi"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#ejercicio-1-desplegando-aplicaciones-flask-con-apache-mod_wsgi","text":"En esta tarea se usa la aplicaci\u00f3n Guestbook .","title":"Ejercicio 1: Desplegando aplicaciones flask con Apache + mod_wsgi"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#crear-venv","text":"mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source bin/activate","title":"Crear venv"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#descargar-guestbook","text":"sudo apt install git git clone https://github.com/josedom24/guestbook.git pip install -r requirements.txt sudo apt install redis","title":"Descargar Guestbook"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#probar-funcionamiento","text":"Por ahora, usando el servidor de desarrollo: python3 app.py","title":"Probar funcionamiento"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#fichero-wsgi","text":"/home/vagrant/guestbook/app/wsgi.py from app import prog as application","title":"Fichero wsgi"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#hacer-que-apache-sirva-guestbook","text":"sudo apt install apache2 sudo apt install libapache2-mod-wsgi-py3 Creo /etc/apache2/sites-available/guestbook.conf : <VirtualHost *:80> ServerName www.guestbook.com DocumentRoot /home/vagrant/guestbook/app <Directory /home/vagrant/guestbook/app> Require all granted </Directory> WSGIDaemonProcess guestbook python-path=/home/vagrant/guestbook/app:/home/vagrant/venv/lib/python3.9/site-packages WSGIProcessGroup guestbook WSGIScriptAlias / /home/vagrant/guestbook/app/wsgi.py process-group=guestbook </VirtualHost> Lo habilito: sudo a2ensite guestbook.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej1-apps-flask-apache2-mod_wsgi resolutions 192.168.121.136 www.guestbook.com","title":"Hacer que Apache sirva Guestbook"},{"location":"ej1-apps-flask-apache2-mod_wsgi/#probar-funcionamiento-apache","text":"","title":"Probar funcionamiento Apache"},{"location":"ej1-instalar-configurar-bind9/","text":"Ejercicio 1: Instalaci\u00f3n y configuraci\u00f3n del servidor bind9 en nuestra red local Entrega Parte 1 Configurar /etc/resolv.conf en cliente apuntando a nuestro DNS vagrant@cliente:~$ cat /etc/resolv.conf nameserver 10.0.0.2 Parte 2 Entregar definici\u00f3n de zonas en /etc/bind/named.conf.local // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; }; Entregar zona directa db.iesgn.org $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj Entregar zona inversa db.10.0.0 $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. 2 IN PTR adrianj.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org. Parte 3 Realizar consultas DNS desde cliente dig adrianj.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> adrianj.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15723 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: cb6d28d55ed4ee5f0100000061943df81878244ad357cd14 (good) ;; QUESTION SECTION: ;adrianj.iesgn.org. IN A ;; ANSWER SECTION: adrianj.iesgn.org. 86400 IN A 10.0.0.2 ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:25:44 UTC 2021 ;; MSG SIZE rcvd: 90 dig www.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> www.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12016 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 3d295ae1abc12a8e0100000061943e403a6b9d7c17e6de01 (good) ;; QUESTION SECTION: ;www.iesgn.org. IN A ;; ANSWER SECTION: www.iesgn.org. 86400 IN CNAME adrianj.iesgn.org. adrianj.iesgn.org. 86400 IN A 10.0.0.2 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:26:56 UTC 2021 ;; MSG SIZE rcvd: 108 dig ftp.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> ftp.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58577 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: cffc03df6e9131a00100000061943e7b8644c93e1bbe2730 (good) ;; QUESTION SECTION: ;ftp.iesgn.org. IN A ;; ANSWER SECTION: ftp.iesgn.org. 86400 IN A 10.0.0.201 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:27:55 UTC 2021 ;; MSG SIZE rcvd: 86 dig NS iesgn.org ; <<>> DiG 9.16.22-Debian <<>> NS iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 19235 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: f8e47d8761996cfe0100000061943eb5c98b7df98b471892 (good) ;; QUESTION SECTION: ;iesgn.org. IN NS ;; ANSWER SECTION: iesgn.org. 86400 IN NS adrianj.iesgn.org. ;; ADDITIONAL SECTION: adrianj.iesgn.org. 86400 IN A 10.0.0.2 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:28:53 UTC 2021 ;; MSG SIZE rcvd: 104 dig MX iesgn.org ; <<>> DiG 9.16.22-Debian <<>> MX iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22032 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 01b2ad2987fc1e2d0100000061943efe0b5bff60f70d13d1 (good) ;; QUESTION SECTION: ;iesgn.org. IN MX ;; ANSWER SECTION: iesgn.org. 86400 IN MX 10 correo.iesgn.org. ;; ADDITIONAL SECTION: correo.iesgn.org. 86400 IN A 10.0.0.200 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:30:06 UTC 2021 ;; MSG SIZE rcvd: 105 dig www.josedomingo.org ; <<>> DiG 9.16.22-Debian <<>> www.josedomingo.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 9813 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: ef95496b3df04c9a0100000061943f350ccd2fde7ab6eda8 (good) ;; QUESTION SECTION: ;www.josedomingo.org. IN A ;; ANSWER SECTION: www.josedomingo.org. 900 IN CNAME endor.josedomingo.org. endor.josedomingo.org. 900 IN A 37.187.119.60 ;; Query time: 1136 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:31:01 UTC 2021 ;; MSG SIZE rcvd: 112 dig -x 10.0.0.2 ; <<>> DiG 9.16.22-Debian <<>> -x 10.0.0.2 ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51481 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: ec34bd720d4b97710100000061943f724de5cec28b58d9ab (good) ;; QUESTION SECTION: ;2.0.0.10.in-addr.arpa. IN PTR ;; ANSWER SECTION: 2.0.0.10.in-addr.arpa. 86400 IN PTR adrianj.iesgn.org. ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:32:02 UTC 2021 ;; MSG SIZE rcvd: 109 Escenario Ejercicio 1 Crear el escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :server do |server| server.vm.box = \"debian/bullseye64\" server.vm.hostname = \"server\" server.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end end Ejercicio 2 En server : Instalar Apache 2 VirtualHosts www.iesgn.org departamentos.iesgn.org sudo apt update sudo apt install apache2 En www.iesgn.org.conf : <VirtualHost *:80> ServerName www.iesgn.org DocumentRoot /var/www/www </VirtualHost> En departamentos.iesgn.org.conf : <VirtualHost *:80> ServerName departamentos.iesgn.org DocumentRoot /var/www/departamentos </VirtualHost> Los habilito y reinicio: sudo a2ensite www.iesgn.org.conf departamentos.iesgn.org.conf sudo systemctl restart apache2 Ejercicio 3 En server , instalar bind9 sudo apt install bind9 Ejercicio 4 Cambiar el hostname de server a: adrianj.iesgn.org Modifico /etc/hostname : vagrant@server:~$ cat /etc/hostname adrianj Hago que el cambio de hostname tome efecto ahora: sudo hostname adrianj Verifico: vagrant@server:~$ hostname adrianj Actualizo el prompt: vagrant@server:~$ bash vagrant@adrianj:~$ Modifico /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 adrianj.iesgn.org adrianj Compruebo nombre largo: vagrant@adrianj:~$ hostname -f adrianj.iesgn.org Compruebo nombre corto: vagrant@adrianj:~$ ping adrianj -c 1 PING adrianj.iesgn.org (127.0.1.1) 56(84) bytes of data. 64 bytes from adrianj.iesgn.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.056 ms --- adrianj.iesgn.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.056/0.056/0.056/0.000 ms Servidor bind9 Ejercicio 1 Definici\u00f3n de zonas en /etc/bind/named.conf.local // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; }; Ejercicio 2 Zona directa db.iesgn.org $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj Ejercicio 3 Zona inversa db.10.0.0 $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. 2 IN PTR adrianj.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org. Ejercicio 4 Comprobar configuraciones y reiniciar el servidor Verifico la zona directa: sudo named-checkzone iesgn.org db.iesgn.org zone iesgn.org/IN: loaded serial 2001062501 OK Verifico la zona inversa: sudo named-checkzone 0.0.10.in-addr.arpa db.10.0.0 zone 0.0.10.in-addr.arpa/IN: loaded serial 2001062501 OK Reinicio: sudo systemctl restart bind9","title":"Ejercicio 1: bind9"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-1-instalacion-y-configuracion-del-servidor-bind9-en-nuestra-red-local","text":"","title":"Ejercicio 1: Instalaci\u00f3n y configuraci\u00f3n del servidor bind9 en nuestra red local"},{"location":"ej1-instalar-configurar-bind9/#entrega","text":"","title":"Entrega"},{"location":"ej1-instalar-configurar-bind9/#parte-1","text":"Configurar /etc/resolv.conf en cliente apuntando a nuestro DNS vagrant@cliente:~$ cat /etc/resolv.conf nameserver 10.0.0.2","title":"Parte 1"},{"location":"ej1-instalar-configurar-bind9/#parte-2","text":"Entregar definici\u00f3n de zonas en /etc/bind/named.conf.local // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; }; Entregar zona directa db.iesgn.org $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj Entregar zona inversa db.10.0.0 $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. 2 IN PTR adrianj.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org.","title":"Parte 2"},{"location":"ej1-instalar-configurar-bind9/#parte-3","text":"Realizar consultas DNS desde cliente dig adrianj.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> adrianj.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15723 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: cb6d28d55ed4ee5f0100000061943df81878244ad357cd14 (good) ;; QUESTION SECTION: ;adrianj.iesgn.org. IN A ;; ANSWER SECTION: adrianj.iesgn.org. 86400 IN A 10.0.0.2 ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:25:44 UTC 2021 ;; MSG SIZE rcvd: 90 dig www.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> www.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12016 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 3d295ae1abc12a8e0100000061943e403a6b9d7c17e6de01 (good) ;; QUESTION SECTION: ;www.iesgn.org. IN A ;; ANSWER SECTION: www.iesgn.org. 86400 IN CNAME adrianj.iesgn.org. adrianj.iesgn.org. 86400 IN A 10.0.0.2 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:26:56 UTC 2021 ;; MSG SIZE rcvd: 108 dig ftp.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> ftp.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58577 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: cffc03df6e9131a00100000061943e7b8644c93e1bbe2730 (good) ;; QUESTION SECTION: ;ftp.iesgn.org. IN A ;; ANSWER SECTION: ftp.iesgn.org. 86400 IN A 10.0.0.201 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:27:55 UTC 2021 ;; MSG SIZE rcvd: 86 dig NS iesgn.org ; <<>> DiG 9.16.22-Debian <<>> NS iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 19235 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: f8e47d8761996cfe0100000061943eb5c98b7df98b471892 (good) ;; QUESTION SECTION: ;iesgn.org. IN NS ;; ANSWER SECTION: iesgn.org. 86400 IN NS adrianj.iesgn.org. ;; ADDITIONAL SECTION: adrianj.iesgn.org. 86400 IN A 10.0.0.2 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:28:53 UTC 2021 ;; MSG SIZE rcvd: 104 dig MX iesgn.org ; <<>> DiG 9.16.22-Debian <<>> MX iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22032 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 01b2ad2987fc1e2d0100000061943efe0b5bff60f70d13d1 (good) ;; QUESTION SECTION: ;iesgn.org. IN MX ;; ANSWER SECTION: iesgn.org. 86400 IN MX 10 correo.iesgn.org. ;; ADDITIONAL SECTION: correo.iesgn.org. 86400 IN A 10.0.0.200 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:30:06 UTC 2021 ;; MSG SIZE rcvd: 105 dig www.josedomingo.org ; <<>> DiG 9.16.22-Debian <<>> www.josedomingo.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 9813 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: ef95496b3df04c9a0100000061943f350ccd2fde7ab6eda8 (good) ;; QUESTION SECTION: ;www.josedomingo.org. IN A ;; ANSWER SECTION: www.josedomingo.org. 900 IN CNAME endor.josedomingo.org. endor.josedomingo.org. 900 IN A 37.187.119.60 ;; Query time: 1136 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:31:01 UTC 2021 ;; MSG SIZE rcvd: 112 dig -x 10.0.0.2 ; <<>> DiG 9.16.22-Debian <<>> -x 10.0.0.2 ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51481 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: ec34bd720d4b97710100000061943f724de5cec28b58d9ab (good) ;; QUESTION SECTION: ;2.0.0.10.in-addr.arpa. IN PTR ;; ANSWER SECTION: 2.0.0.10.in-addr.arpa. 86400 IN PTR adrianj.iesgn.org. ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Tue Nov 16 23:32:02 UTC 2021 ;; MSG SIZE rcvd: 109","title":"Parte 3"},{"location":"ej1-instalar-configurar-bind9/#escenario","text":"","title":"Escenario"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-1","text":"Crear el escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :server do |server| server.vm.box = \"debian/bullseye64\" server.vm.hostname = \"server\" server.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end end","title":"Ejercicio 1"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-2","text":"En server : Instalar Apache 2 VirtualHosts www.iesgn.org departamentos.iesgn.org sudo apt update sudo apt install apache2 En www.iesgn.org.conf : <VirtualHost *:80> ServerName www.iesgn.org DocumentRoot /var/www/www </VirtualHost> En departamentos.iesgn.org.conf : <VirtualHost *:80> ServerName departamentos.iesgn.org DocumentRoot /var/www/departamentos </VirtualHost> Los habilito y reinicio: sudo a2ensite www.iesgn.org.conf departamentos.iesgn.org.conf sudo systemctl restart apache2","title":"Ejercicio 2"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-3","text":"En server , instalar bind9 sudo apt install bind9","title":"Ejercicio 3"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-4","text":"Cambiar el hostname de server a: adrianj.iesgn.org Modifico /etc/hostname : vagrant@server:~$ cat /etc/hostname adrianj Hago que el cambio de hostname tome efecto ahora: sudo hostname adrianj Verifico: vagrant@server:~$ hostname adrianj Actualizo el prompt: vagrant@server:~$ bash vagrant@adrianj:~$ Modifico /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 adrianj.iesgn.org adrianj Compruebo nombre largo: vagrant@adrianj:~$ hostname -f adrianj.iesgn.org Compruebo nombre corto: vagrant@adrianj:~$ ping adrianj -c 1 PING adrianj.iesgn.org (127.0.1.1) 56(84) bytes of data. 64 bytes from adrianj.iesgn.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.056 ms --- adrianj.iesgn.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.056/0.056/0.056/0.000 ms","title":"Ejercicio 4"},{"location":"ej1-instalar-configurar-bind9/#servidor-bind9","text":"","title":"Servidor bind9"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-1_1","text":"Definici\u00f3n de zonas en /etc/bind/named.conf.local // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; };","title":"Ejercicio 1"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-2_1","text":"Zona directa db.iesgn.org $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj","title":"Ejercicio 2"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-3_1","text":"Zona inversa db.10.0.0 $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. 2 IN PTR adrianj.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org.","title":"Ejercicio 3"},{"location":"ej1-instalar-configurar-bind9/#ejercicio-4_1","text":"Comprobar configuraciones y reiniciar el servidor Verifico la zona directa: sudo named-checkzone iesgn.org db.iesgn.org zone iesgn.org/IN: loaded serial 2001062501 OK Verifico la zona inversa: sudo named-checkzone 0.0.10.in-addr.arpa db.10.0.0 zone 0.0.10.in-addr.arpa/IN: loaded serial 2001062501 OK Reinicio: sudo systemctl restart bind9","title":"Ejercicio 4"},{"location":"ej1-instalar-configurar-dhcp/","text":"Ejercicio 1: Instalaci\u00f3n y configuraci\u00f3n DHCP ENTREGA Parte 1 Configuraci\u00f3n de isc-dhcp-server sudo apt update && sudo apt install isc-dhcp-server En /etc/default/isc-dhcp-server : Descomentar la l\u00ednea: DHCPDv4_CONF=/etc/dhcp/dhcpd.conf Especificar por qu\u00e9 interfaz escuchar\u00e1 y servir\u00e1 IPs: INTERFACESv4=\"eth1\" En /etc/dhcp/dhcpd.conf : subnet 192.168.0.0 netmask 255.255.255.0 { range 192.168.0.100 192.168.0.110; option subnet-mask 255.255.255.0; option routers 192.168.0.1; option domain-name-servers 8.8.8.8, 8.8.4.4; max-lease-time 3600; } Reiniciar el servicio: sudo systemctl restart isc-dhcp-server Parte 2 Mostrar lista de concesiones DHCP sudo dhcp-lease-list --lease To get manufacturer names please download http://standards.ieee.org/regauth/oui/oui.txt to /usr/local/etc/oui.txt Use of uninitialized value $db_cand in -r at /usr/sbin/dhcp-lease-list line 77. Reading leases from /var/lib/dhcp/dhcpd.leases MAC IP hostname valid until manufacturer =============================================================================================== 52:54:00:ac:7b:64 192.168.0.101 cliente 2021-10-18 18:21:40 -NA- Parte 3 Configurar el cliente por DHCP En /etc/network/interfaces configurar eth1 de la siguiente manera: auto eth1 iface eth1 inet dhcp Pedimos configuraci\u00f3n DHCP por eth1 : sudo dhclient eth1 Parte 4 Hacer un ip a en cliente 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:b9:cb:6d brd ff:ff:ff:ff:ff:ff altname enp0s5 altname ens5 inet 192.168.121.68/24 brd 192.168.121.255 scope global dynamic eth0 valid_lft 3534sec preferred_lft 3534sec inet6 fe80::5054:ff:feb9:cb6d/64 scope link valid_lft forever preferred_lft forever 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:ac:7b:64 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.0.101/24 brd 192.168.0.255 scope global dynamic eth1 valid_lft 3147sec preferred_lft 3147sec inet6 fe80::5054:ff:feac:7b64/64 scope link valid_lft forever preferred_lft forever Parte 5 Servidor DHCP tiene que actuar como router NAT echo \"1\" > /proc/sys/net/ipv4/ip_forward sudo modprobe iptable_nat sudo iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE Comprobaci\u00f3n de resoluci\u00f3n DNS en el cliente. Mediante ping: vagrant@cliente:~$ ping www.example.org PING www.example.org (93.184.216.34) 56(84) bytes of data. 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=1 ttl=52 time=120 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=2 ttl=52 time=121 ms ^C --- www.example.org ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 120.205/120.573/120.941/0.368 ms Mediante dig: dig www.example.org ; <<>> DiG 9.16.15-Debian <<>> www.example.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 6677 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 512 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 16060 IN A 93.184.216.34 ;; Query time: 24 msec ;; SERVER: 8.8.8.8#53(8.8.8.8) ;; WHEN: Mon Oct 18 19:07:53 UTC 2021 ;; MSG SIZE rcvd: 60 Cuando dig se usa sin especificar un DNS, hace la query con nuestro primer nameserver por defecto. Utiliza 8.8.8.8 , por lo que es una manera de comprobar si nuestra configuraci\u00f3n DNS dada por el DHCP es correcta. Escenario Servidor DHCP Cliente Vagrantfile: Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :servidor do |servidor| servidor.vm.box = \"debian/bullseye64\" servidor.vm.hostname = \"servidor\" servidor.vm.network :private_network, :libvirt__network_name => \"ej1-dhcp\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1-dhcp\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end end Realizaci\u00f3n Comprobar la configuraci\u00f3n de red del cliente 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:ac:7b:64 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.0.101/24 brd 192.168.0.255 scope global dynamic eth1 valid_lft 2910sec preferred_lft 2910sec inet6 fe80::5054:ff:feac:7b64/64 scope link valid_lft forever preferred_lft forever Vemos que son correctos los par\u00e1metros: Rango de IP M\u00e1scara Tiempo de concesi\u00f3n (ha pasado un rato desde que ped\u00ed configuraci\u00f3n hasta que hice el copypaste, por eso el lifetime ha bajado) vagrant@cliente:~$ ip r default via 192.168.0.1 dev eth1 192.168.0.0/24 dev eth1 proto kernel scope link src 192.168.0.101 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.68 Vemos que ha surtido efecto el par\u00e1metro option routers vagrant@cliente:~$ cat /etc/resolv.conf nameserver 8.8.8.8 nameserver 8.8.4.4 Vemos que ha surtido efecto el par\u00e1metro option domain-name-servers","title":"Ejercicio 1"},{"location":"ej1-instalar-configurar-dhcp/#ejercicio-1-instalacion-y-configuracion-dhcp","text":"","title":"Ejercicio 1: Instalaci\u00f3n y configuraci\u00f3n DHCP"},{"location":"ej1-instalar-configurar-dhcp/#entrega","text":"","title":"ENTREGA"},{"location":"ej1-instalar-configurar-dhcp/#parte-1","text":"Configuraci\u00f3n de isc-dhcp-server sudo apt update && sudo apt install isc-dhcp-server En /etc/default/isc-dhcp-server : Descomentar la l\u00ednea: DHCPDv4_CONF=/etc/dhcp/dhcpd.conf Especificar por qu\u00e9 interfaz escuchar\u00e1 y servir\u00e1 IPs: INTERFACESv4=\"eth1\" En /etc/dhcp/dhcpd.conf : subnet 192.168.0.0 netmask 255.255.255.0 { range 192.168.0.100 192.168.0.110; option subnet-mask 255.255.255.0; option routers 192.168.0.1; option domain-name-servers 8.8.8.8, 8.8.4.4; max-lease-time 3600; } Reiniciar el servicio: sudo systemctl restart isc-dhcp-server","title":"Parte 1"},{"location":"ej1-instalar-configurar-dhcp/#parte-2","text":"Mostrar lista de concesiones DHCP sudo dhcp-lease-list --lease To get manufacturer names please download http://standards.ieee.org/regauth/oui/oui.txt to /usr/local/etc/oui.txt Use of uninitialized value $db_cand in -r at /usr/sbin/dhcp-lease-list line 77. Reading leases from /var/lib/dhcp/dhcpd.leases MAC IP hostname valid until manufacturer =============================================================================================== 52:54:00:ac:7b:64 192.168.0.101 cliente 2021-10-18 18:21:40 -NA-","title":"Parte 2"},{"location":"ej1-instalar-configurar-dhcp/#parte-3","text":"Configurar el cliente por DHCP En /etc/network/interfaces configurar eth1 de la siguiente manera: auto eth1 iface eth1 inet dhcp Pedimos configuraci\u00f3n DHCP por eth1 : sudo dhclient eth1","title":"Parte 3"},{"location":"ej1-instalar-configurar-dhcp/#parte-4","text":"Hacer un ip a en cliente 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:b9:cb:6d brd ff:ff:ff:ff:ff:ff altname enp0s5 altname ens5 inet 192.168.121.68/24 brd 192.168.121.255 scope global dynamic eth0 valid_lft 3534sec preferred_lft 3534sec inet6 fe80::5054:ff:feb9:cb6d/64 scope link valid_lft forever preferred_lft forever 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:ac:7b:64 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.0.101/24 brd 192.168.0.255 scope global dynamic eth1 valid_lft 3147sec preferred_lft 3147sec inet6 fe80::5054:ff:feac:7b64/64 scope link valid_lft forever preferred_lft forever","title":"Parte 4"},{"location":"ej1-instalar-configurar-dhcp/#parte-5","text":"Servidor DHCP tiene que actuar como router NAT echo \"1\" > /proc/sys/net/ipv4/ip_forward sudo modprobe iptable_nat sudo iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE Comprobaci\u00f3n de resoluci\u00f3n DNS en el cliente. Mediante ping: vagrant@cliente:~$ ping www.example.org PING www.example.org (93.184.216.34) 56(84) bytes of data. 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=1 ttl=52 time=120 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=2 ttl=52 time=121 ms ^C --- www.example.org ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 120.205/120.573/120.941/0.368 ms Mediante dig: dig www.example.org ; <<>> DiG 9.16.15-Debian <<>> www.example.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 6677 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 512 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 16060 IN A 93.184.216.34 ;; Query time: 24 msec ;; SERVER: 8.8.8.8#53(8.8.8.8) ;; WHEN: Mon Oct 18 19:07:53 UTC 2021 ;; MSG SIZE rcvd: 60 Cuando dig se usa sin especificar un DNS, hace la query con nuestro primer nameserver por defecto. Utiliza 8.8.8.8 , por lo que es una manera de comprobar si nuestra configuraci\u00f3n DNS dada por el DHCP es correcta.","title":"Parte 5"},{"location":"ej1-instalar-configurar-dhcp/#escenario","text":"Servidor DHCP Cliente Vagrantfile: Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :servidor do |servidor| servidor.vm.box = \"debian/bullseye64\" servidor.vm.hostname = \"servidor\" servidor.vm.network :private_network, :libvirt__network_name => \"ej1-dhcp\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1-dhcp\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end end","title":"Escenario"},{"location":"ej1-instalar-configurar-dhcp/#realizacion","text":"Comprobar la configuraci\u00f3n de red del cliente 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:ac:7b:64 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.0.101/24 brd 192.168.0.255 scope global dynamic eth1 valid_lft 2910sec preferred_lft 2910sec inet6 fe80::5054:ff:feac:7b64/64 scope link valid_lft forever preferred_lft forever Vemos que son correctos los par\u00e1metros: Rango de IP M\u00e1scara Tiempo de concesi\u00f3n (ha pasado un rato desde que ped\u00ed configuraci\u00f3n hasta que hice el copypaste, por eso el lifetime ha bajado) vagrant@cliente:~$ ip r default via 192.168.0.1 dev eth1 192.168.0.0/24 dev eth1 proto kernel scope link src 192.168.0.101 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.68 Vemos que ha surtido efecto el par\u00e1metro option routers vagrant@cliente:~$ cat /etc/resolv.conf nameserver 8.8.8.8 nameserver 8.8.4.4 Vemos que ha surtido efecto el par\u00e1metro option domain-name-servers","title":"Realizaci\u00f3n"},{"location":"ej1-iptables-nodo/","text":"Ejercicio 1 iptables: cortafuegos por nodo Preliminares Escenario Vagrant . configure ( \"2\" ) do | config | config . vm . synced_folder \".\" , \"/vagrant\" , disabled : true config . vm . define :ej1iptables1 do | ej1iptables1 | ej1iptables1 . vm . box = \"debian/bullseye64\" ej1iptables1 . vm . hostname = \"ej1iptables1\" ej1iptables1 . vm . network :private_network , :libvirt__network_name => \"ej1-iptables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.2\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end config . vm . define :ej1iptables2 do | ej1iptables2 | ej1iptables2 . vm . box = \"debian/bullseye64\" ej1iptables2 . vm . hostname = \"ej1iptables2\" ej1iptables2 . vm . network :private_network , :libvirt__network_name => \"ej1-iptables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.3\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end end Instalo un servidor web para dejar abierto el puerto 80: sudo apt update sudo apt install apache2 Limpieza de reglas previas En mi caso no necesito hacer este paso ya que parto de una m\u00e1quina vagrant nueva. Igualmente, dejar\u00e9 los comandos explicados por aqu\u00ed. Borrar todas las reglas de todas las cadenas en la tabla filter: sudo iptables -F Borrar todas las reglas de todas las cadenas en la tabla nat: sudo iptables -t nat -F Poner los contadores a cero en todas las cadenas de la tabla filter: sudo iptables -Z Poner los contadores a cero en todas las cadenas de la tabla nat: sudo iptables -t nat -Z Tr\u00e1fico ssh entrante Estamos conectados a la m\u00e1quina por ssh, as\u00ed que tenemos que permitir el tr\u00e1fico ssh entrante antes de cambiar las pol\u00edticas por defecto a DROP (para no perder la conexi\u00f3n) : sudo iptables -A INPUT -s 192.168.121.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -d 192.168.121.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Cambiar pol\u00edtica por defecto sudo iptables -P INPUT DROP sudo iptables -P OUTPUT DROP Debido a estas pol\u00edticas DROP que hemos aplicado... No puedo hacer ping a localhost: vagrant@ej1iptables1:~$ ping 127 .0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. ^C --- 127.0.0.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2049ms No puedo hacer ping a Internet: vagrant@ej1iptables1:~$ ping 1 .1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. ^C --- 1.1.1.1 ping statistics --- 4 packets transmitted, 0 received, 100% packet loss, time 3062ms Si no se nos corta la conexi\u00f3n ssh a la m\u00e1quina despu\u00e9s de este paso, el par de reglas que aplicamos antes funcionan. Tr\u00e1fico loopback sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT sudo iptables -A INPUT -i lo -p icmp -j ACCEPT Ya funciona el ping a localhost: vagrant@ej1iptables1:~$ ping 127 .0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.097 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.090 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1006ms rtt min/avg/max/mdev = 0.090/0.093/0.097/0.003 ms Tr\u00e1fico ICMP saliente sudo iptables -A OUTPUT -o eth0 -p icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -i eth0 -p icmp --icmp-type echo-reply -j ACCEPT Ya funciona el ping a Internet: vagrant@ej1iptables1:~$ ping 1 .1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=11.2 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=17.3 ms 64 bytes from 1.1.1.1: icmp_seq=3 ttl=54 time=46.9 ms ^C --- 1.1.1.1 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2004ms rtt min/avg/max/mdev = 11.218/25.145/46.884/15.573 ms Tr\u00e1fico DNS saliente sudo iptables -A OUTPUT -o eth0 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth0 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS funcionan: vagrant@ej1iptables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21960 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 176 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Tue Jan 25 21:14:54 UTC 2022 ;; MSG SIZE rcvd: 60 Tr\u00e1fico http saliente sudo iptables -A OUTPUT -o eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona: vagrant@ej1iptables1:~$ curl http://portquiz.net:80 Port test successful! Your IP: 90.168.73.6 Tr\u00e1fico https saliente sudo iptables -A OUTPUT -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona: vagrant@ej1iptables1:~$ curl portquiz.net:443 Port test successful! Your IP: 90.168.73.6 Tr\u00e1fico http entrante sudo iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej1-iptables-nodo$ telnet 192 .168.121.148 80 Trying 192.168.121.148... Connected to 192.168.121.148. Escape character is '^]'. Ejercicios Ejercicio 1 Permitir conexiones ssh al exterior sudo iptables -A OUTPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona conectando a mi host: vagrant@ej1iptables1:~$ ssh atlas@192.168.121.1 The authenticity of host '192.168.121.1 (192.168.121.1)' can't be established. ECDSA key fingerprint is SHA256:xbn++TBj5GyQdixTeO+cP7UGJzvMspD3AVK0JD1RbLw. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added '192.168.121.1' (ECDSA) to the list of known hosts. atlas@192.168.121.1's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Fri Sep 17 11:55:03 2021 atlas@olympus:~$ Ejercicio 2 Denegar tr\u00e1fico http entrante desde nuestro host Antes de a\u00f1adir la regla de bloqueo, debemos tener en cuenta nuestra situaci\u00f3n actual de reglas en INPUT: Como se puede ver, si a\u00f1adi\u00e9ramos la regla de bloqueo al final no servir\u00eda para nada porque siempre har\u00eda match con la que permite todo el tr\u00e1fico http entrante (la marcada en rojo) . \u00bfSoluci\u00f3n? A\u00f1adirla por encima de la regla marcada en rojo. Necesitamos saber el n\u00famero de l\u00ednea espec\u00edfico, as\u00ed que ejecutamos: sudo iptables -L -v -n --line-numbers Vamos a a\u00f1adir la regla de bloqueo en la posici\u00f3n marcada para que funcione: sudo iptables -I INPUT 7 -s 192.168.121.1 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j DROP Ya tenemos la regla en la posici\u00f3n que quer\u00edamos. Ahora comprobamos que bloquea el tr\u00e1fico: atlas@olympus:~/vagrant/ej1-iptables-nodo$ telnet 192 .168.121.148 80 Trying 192.168.121.148... Ejercicio 3 Permitir tr\u00e1fico DNS saliente s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 Nos encontramos en una situaci\u00f3n parecida a la del ejercicio anterior, pero en este caso tenemos que borrar 2 reglas antiguas que permit\u00edan el tr\u00e1fico DNS saliente a todo: Incluso si a\u00f1adi\u00e9ramos las nuevas reglas por encima de estas, cuando hici\u00e9semos dig a 1.1.1.1 llegar\u00eda a hacer match con estas reglas y permitir\u00eda el tr\u00e1fico, y eso no es lo que queremos. Primero, borramos las reglas antiguas: sudo iptables -D OUTPUT -o eth0 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -D INPUT -i eth0 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Segundo, a\u00f1adimos las nuevas reglas: sudo iptables -A OUTPUT -d 192.168.202.2 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -s 192.168.202.2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@ej1iptables1:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 44911 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 5 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: a5bc7b7e522180d07f1d986561f12cdcd431eb1130baa84c (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86010 IN A 93.184.216.34 ;; AUTHORITY SECTION: example.org. 72269 IN NS a.iana-servers.net. example.org. 72269 IN NS b.iana-servers.net. ;; ADDITIONAL SECTION: a.iana-servers.net. 158669 IN A 199.43.135.53 b.iana-servers.net. 158669 IN A 199.43.133.53 a.iana-servers.net. 158669 IN AAAA 2001:500:8f::53 b.iana-servers.net. 158669 IN AAAA 2001:500:8d::53 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Jan 26 11:13:30 UTC 2022 ;; MSG SIZE rcvd: 224 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@ej1iptables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached Ejercicio 4 Bloquear tr\u00e1fico http saliente a www.josedomingo.org (utilizar la ip). \u00bfSe puede acceder a fp.josedomingo.org? De nuevo, tendr\u00edamos una situaci\u00f3n de conflicto de reglas si la siguiente la a\u00f1adi\u00e9ramos al final, porque antes tenemos una que permite todo el tr\u00e1fico http saliente y los matchs se quedar\u00edan siempre ah\u00ed: Tendremos que a\u00f1adir la regla de bloqueo por encima de la anterior mostrada: sudo iptables -I OUTPUT 4 -d 37.187.119.60 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j DROP Se nos quedar\u00edan las reglas as\u00ed: Pruebo que no funciona el tr\u00e1fico http saliente a www.josedomingo.org : vagrant@ej1iptables1:~$ curl www.josedomingo.org Se quedar\u00e1 esperando infinitamente porque no hay conexi\u00f3n. Pruebo a ver si funciona el tr\u00e1fico http saliente a fp.josedomingo.org : vagrant@ej1iptables1:~$ curl fp.josedomingo.org Tampoco hay conexi\u00f3n. No funciona ya que fp.josedomingo.org se acaba traduciendo a la misma IP que hemos bloqueado antes. Pruebo que cualquier otro tr\u00e1fico http saliente funciona: vagrant@ej1iptables1:~$ telnet www.example.org 80 Trying 93.184.216.34... Connected to www.example.org. Escape character is '^]'. Ejercicio 5 Permitir tr\u00e1fico saliente a babuino-smtp.gonzalonazareno.org por el puerto 25 sudo iptables -A OUTPUT -d 192.168.203.3 -p tcp --dport 25 -j ACCEPT sudo iptables -A INPUT -s 192.168.203.3 -p tcp --sport 25 -j ACCEPT Pruebo que funciona con telnet: vagrant@ej1iptables1:~$ telnet babuino-smtp.gonzalonazareno.org 25 Trying 192.168.203.3... Connected to babuino-smtp.gonzalonazareno.org. Escape character is '^]'. 220 babuino-smtp.gonzalonazareno.org ESMTP Postfix (Debian/GNU) Ejercicio 6 Parte 1 Instalar mariadb-server y habilitar conexiones remotas sudo apt install mariadb-server /etc/mysql/mariadb.conf.d/50-server.cnf : bind-address = 0.0.0.0 Reinicio: sudo systemctl restart mariadb Parte 2 Permitir tr\u00e1fico entrante desde mi host sudo iptables -A INPUT -s 192.168.121.1 -p tcp --dport 3306 -j ACCEPT sudo iptables -A OUTPUT -d 192.168.121.1 -p tcp --sport 3306 -j ACCEPT Pruebo que funciona: atlas@olympus:~/vagrant/ej1-iptables-nodo$ nc -zvw10 192 .168.121.148 3306 Connection to 192.168.121.148 3306 port [tcp/mysql] succeeded! Parte 3 Comprobar que desde otro cliente bloquea el tr\u00e1fico vagrant@ej1iptables2:~$ nc -zvw10 192 .168.0.2 3306 192.168.0.2: inverse host lookup failed: Unknown host (UNKNOWN) [192.168.0.2] 3306 (mysql) : Connection timed out","title":"Ejercicio 1 iptables: por nodo"},{"location":"ej1-iptables-nodo/#ejercicio-1-iptables-cortafuegos-por-nodo","text":"","title":"Ejercicio 1 iptables: cortafuegos por nodo"},{"location":"ej1-iptables-nodo/#preliminares","text":"","title":"Preliminares"},{"location":"ej1-iptables-nodo/#escenario","text":"Vagrant . configure ( \"2\" ) do | config | config . vm . synced_folder \".\" , \"/vagrant\" , disabled : true config . vm . define :ej1iptables1 do | ej1iptables1 | ej1iptables1 . vm . box = \"debian/bullseye64\" ej1iptables1 . vm . hostname = \"ej1iptables1\" ej1iptables1 . vm . network :private_network , :libvirt__network_name => \"ej1-iptables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.2\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end config . vm . define :ej1iptables2 do | ej1iptables2 | ej1iptables2 . vm . box = \"debian/bullseye64\" ej1iptables2 . vm . hostname = \"ej1iptables2\" ej1iptables2 . vm . network :private_network , :libvirt__network_name => \"ej1-iptables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.3\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end end Instalo un servidor web para dejar abierto el puerto 80: sudo apt update sudo apt install apache2","title":"Escenario"},{"location":"ej1-iptables-nodo/#limpieza-de-reglas-previas","text":"En mi caso no necesito hacer este paso ya que parto de una m\u00e1quina vagrant nueva. Igualmente, dejar\u00e9 los comandos explicados por aqu\u00ed. Borrar todas las reglas de todas las cadenas en la tabla filter: sudo iptables -F Borrar todas las reglas de todas las cadenas en la tabla nat: sudo iptables -t nat -F Poner los contadores a cero en todas las cadenas de la tabla filter: sudo iptables -Z Poner los contadores a cero en todas las cadenas de la tabla nat: sudo iptables -t nat -Z","title":"Limpieza de reglas previas"},{"location":"ej1-iptables-nodo/#trafico-ssh-entrante","text":"Estamos conectados a la m\u00e1quina por ssh, as\u00ed que tenemos que permitir el tr\u00e1fico ssh entrante antes de cambiar las pol\u00edticas por defecto a DROP (para no perder la conexi\u00f3n) : sudo iptables -A INPUT -s 192.168.121.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -d 192.168.121.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT","title":"Tr\u00e1fico ssh entrante"},{"location":"ej1-iptables-nodo/#cambiar-politica-por-defecto","text":"sudo iptables -P INPUT DROP sudo iptables -P OUTPUT DROP Debido a estas pol\u00edticas DROP que hemos aplicado... No puedo hacer ping a localhost: vagrant@ej1iptables1:~$ ping 127 .0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. ^C --- 127.0.0.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2049ms No puedo hacer ping a Internet: vagrant@ej1iptables1:~$ ping 1 .1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. ^C --- 1.1.1.1 ping statistics --- 4 packets transmitted, 0 received, 100% packet loss, time 3062ms Si no se nos corta la conexi\u00f3n ssh a la m\u00e1quina despu\u00e9s de este paso, el par de reglas que aplicamos antes funcionan.","title":"Cambiar pol\u00edtica por defecto"},{"location":"ej1-iptables-nodo/#trafico-loopback","text":"sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT sudo iptables -A INPUT -i lo -p icmp -j ACCEPT Ya funciona el ping a localhost: vagrant@ej1iptables1:~$ ping 127 .0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.097 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.090 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1006ms rtt min/avg/max/mdev = 0.090/0.093/0.097/0.003 ms","title":"Tr\u00e1fico loopback"},{"location":"ej1-iptables-nodo/#trafico-icmp-saliente","text":"sudo iptables -A OUTPUT -o eth0 -p icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -i eth0 -p icmp --icmp-type echo-reply -j ACCEPT Ya funciona el ping a Internet: vagrant@ej1iptables1:~$ ping 1 .1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=11.2 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=17.3 ms 64 bytes from 1.1.1.1: icmp_seq=3 ttl=54 time=46.9 ms ^C --- 1.1.1.1 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2004ms rtt min/avg/max/mdev = 11.218/25.145/46.884/15.573 ms","title":"Tr\u00e1fico ICMP saliente"},{"location":"ej1-iptables-nodo/#trafico-dns-saliente","text":"sudo iptables -A OUTPUT -o eth0 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth0 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS funcionan: vagrant@ej1iptables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21960 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 176 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Tue Jan 25 21:14:54 UTC 2022 ;; MSG SIZE rcvd: 60","title":"Tr\u00e1fico DNS saliente"},{"location":"ej1-iptables-nodo/#trafico-http-saliente","text":"sudo iptables -A OUTPUT -o eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona: vagrant@ej1iptables1:~$ curl http://portquiz.net:80 Port test successful! Your IP: 90.168.73.6","title":"Tr\u00e1fico http saliente"},{"location":"ej1-iptables-nodo/#trafico-https-saliente","text":"sudo iptables -A OUTPUT -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona: vagrant@ej1iptables1:~$ curl portquiz.net:443 Port test successful! Your IP: 90.168.73.6","title":"Tr\u00e1fico https saliente"},{"location":"ej1-iptables-nodo/#trafico-http-entrante","text":"sudo iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej1-iptables-nodo$ telnet 192 .168.121.148 80 Trying 192.168.121.148... Connected to 192.168.121.148. Escape character is '^]'.","title":"Tr\u00e1fico http entrante"},{"location":"ej1-iptables-nodo/#ejercicios","text":"","title":"Ejercicios"},{"location":"ej1-iptables-nodo/#ejercicio-1","text":"Permitir conexiones ssh al exterior sudo iptables -A OUTPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona conectando a mi host: vagrant@ej1iptables1:~$ ssh atlas@192.168.121.1 The authenticity of host '192.168.121.1 (192.168.121.1)' can't be established. ECDSA key fingerprint is SHA256:xbn++TBj5GyQdixTeO+cP7UGJzvMspD3AVK0JD1RbLw. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added '192.168.121.1' (ECDSA) to the list of known hosts. atlas@192.168.121.1's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Fri Sep 17 11:55:03 2021 atlas@olympus:~$","title":"Ejercicio 1"},{"location":"ej1-iptables-nodo/#ejercicio-2","text":"Denegar tr\u00e1fico http entrante desde nuestro host Antes de a\u00f1adir la regla de bloqueo, debemos tener en cuenta nuestra situaci\u00f3n actual de reglas en INPUT: Como se puede ver, si a\u00f1adi\u00e9ramos la regla de bloqueo al final no servir\u00eda para nada porque siempre har\u00eda match con la que permite todo el tr\u00e1fico http entrante (la marcada en rojo) . \u00bfSoluci\u00f3n? A\u00f1adirla por encima de la regla marcada en rojo. Necesitamos saber el n\u00famero de l\u00ednea espec\u00edfico, as\u00ed que ejecutamos: sudo iptables -L -v -n --line-numbers Vamos a a\u00f1adir la regla de bloqueo en la posici\u00f3n marcada para que funcione: sudo iptables -I INPUT 7 -s 192.168.121.1 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j DROP Ya tenemos la regla en la posici\u00f3n que quer\u00edamos. Ahora comprobamos que bloquea el tr\u00e1fico: atlas@olympus:~/vagrant/ej1-iptables-nodo$ telnet 192 .168.121.148 80 Trying 192.168.121.148...","title":"Ejercicio 2"},{"location":"ej1-iptables-nodo/#ejercicio-3","text":"Permitir tr\u00e1fico DNS saliente s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 Nos encontramos en una situaci\u00f3n parecida a la del ejercicio anterior, pero en este caso tenemos que borrar 2 reglas antiguas que permit\u00edan el tr\u00e1fico DNS saliente a todo: Incluso si a\u00f1adi\u00e9ramos las nuevas reglas por encima de estas, cuando hici\u00e9semos dig a 1.1.1.1 llegar\u00eda a hacer match con estas reglas y permitir\u00eda el tr\u00e1fico, y eso no es lo que queremos. Primero, borramos las reglas antiguas: sudo iptables -D OUTPUT -o eth0 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -D INPUT -i eth0 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Segundo, a\u00f1adimos las nuevas reglas: sudo iptables -A OUTPUT -d 192.168.202.2 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -s 192.168.202.2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@ej1iptables1:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 44911 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 5 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: a5bc7b7e522180d07f1d986561f12cdcd431eb1130baa84c (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86010 IN A 93.184.216.34 ;; AUTHORITY SECTION: example.org. 72269 IN NS a.iana-servers.net. example.org. 72269 IN NS b.iana-servers.net. ;; ADDITIONAL SECTION: a.iana-servers.net. 158669 IN A 199.43.135.53 b.iana-servers.net. 158669 IN A 199.43.133.53 a.iana-servers.net. 158669 IN AAAA 2001:500:8f::53 b.iana-servers.net. 158669 IN AAAA 2001:500:8d::53 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Jan 26 11:13:30 UTC 2022 ;; MSG SIZE rcvd: 224 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@ej1iptables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached","title":"Ejercicio 3"},{"location":"ej1-iptables-nodo/#ejercicio-4","text":"Bloquear tr\u00e1fico http saliente a www.josedomingo.org (utilizar la ip). \u00bfSe puede acceder a fp.josedomingo.org? De nuevo, tendr\u00edamos una situaci\u00f3n de conflicto de reglas si la siguiente la a\u00f1adi\u00e9ramos al final, porque antes tenemos una que permite todo el tr\u00e1fico http saliente y los matchs se quedar\u00edan siempre ah\u00ed: Tendremos que a\u00f1adir la regla de bloqueo por encima de la anterior mostrada: sudo iptables -I OUTPUT 4 -d 37.187.119.60 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j DROP Se nos quedar\u00edan las reglas as\u00ed: Pruebo que no funciona el tr\u00e1fico http saliente a www.josedomingo.org : vagrant@ej1iptables1:~$ curl www.josedomingo.org Se quedar\u00e1 esperando infinitamente porque no hay conexi\u00f3n. Pruebo a ver si funciona el tr\u00e1fico http saliente a fp.josedomingo.org : vagrant@ej1iptables1:~$ curl fp.josedomingo.org Tampoco hay conexi\u00f3n. No funciona ya que fp.josedomingo.org se acaba traduciendo a la misma IP que hemos bloqueado antes. Pruebo que cualquier otro tr\u00e1fico http saliente funciona: vagrant@ej1iptables1:~$ telnet www.example.org 80 Trying 93.184.216.34... Connected to www.example.org. Escape character is '^]'.","title":"Ejercicio 4"},{"location":"ej1-iptables-nodo/#ejercicio-5","text":"Permitir tr\u00e1fico saliente a babuino-smtp.gonzalonazareno.org por el puerto 25 sudo iptables -A OUTPUT -d 192.168.203.3 -p tcp --dport 25 -j ACCEPT sudo iptables -A INPUT -s 192.168.203.3 -p tcp --sport 25 -j ACCEPT Pruebo que funciona con telnet: vagrant@ej1iptables1:~$ telnet babuino-smtp.gonzalonazareno.org 25 Trying 192.168.203.3... Connected to babuino-smtp.gonzalonazareno.org. Escape character is '^]'. 220 babuino-smtp.gonzalonazareno.org ESMTP Postfix (Debian/GNU)","title":"Ejercicio 5"},{"location":"ej1-iptables-nodo/#ejercicio-6","text":"","title":"Ejercicio 6"},{"location":"ej1-iptables-nodo/#parte-1","text":"Instalar mariadb-server y habilitar conexiones remotas sudo apt install mariadb-server /etc/mysql/mariadb.conf.d/50-server.cnf : bind-address = 0.0.0.0 Reinicio: sudo systemctl restart mariadb","title":"Parte 1"},{"location":"ej1-iptables-nodo/#parte-2","text":"Permitir tr\u00e1fico entrante desde mi host sudo iptables -A INPUT -s 192.168.121.1 -p tcp --dport 3306 -j ACCEPT sudo iptables -A OUTPUT -d 192.168.121.1 -p tcp --sport 3306 -j ACCEPT Pruebo que funciona: atlas@olympus:~/vagrant/ej1-iptables-nodo$ nc -zvw10 192 .168.121.148 3306 Connection to 192.168.121.148 3306 port [tcp/mysql] succeeded!","title":"Parte 2"},{"location":"ej1-iptables-nodo/#parte-3","text":"Comprobar que desde otro cliente bloquea el tr\u00e1fico vagrant@ej1iptables2:~$ nc -zvw10 192 .168.0.2 3306 192.168.0.2: inverse host lookup failed: Unknown host (UNKNOWN) [192.168.0.2] 3306 (mysql) : Connection timed out","title":"Parte 3"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/","text":"Ejercicio 1: Mapear URL a ubicaciones de un sistema de ficheros ENTREGA Parte 1 Mostrar configuraci\u00f3n completa del virtualhost <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.mapeo.com DocumentRoot /srv/mapeo RedirectMatch ^/$ /principal <Directory /srv/mapeo/principal> Options -Indexes Options -FollowSymLinks Options -MultiViews </Directory> Alias /principal/documentos /home/vagrant/doc <Directory /home/vagrant/doc> Options Indexes SymLinksIfOwnerMatch Require all granted </Directory> ErrorDocument 404 \"/error/404.html\" ErrorDocument 403 \"/error/403.html\" # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Parte 2 Con F12 de firefox, entrega screenshot para mostrar el redireccionamiento de www.mapeo.com a principal Parte 3 Mostrar screenshot en www.mapeo.com/principal/documentos Parte 4 Mostrar screenshot de 404 custom Mostrar screenshot de 403 custom EJERCICIOS Ejercicio 0 Crear virtualhost www.mapeo.com con DocumentRoot /srv/mapeo Creo /etc/apache2/sites-available/mapeo.conf : <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.mapeo.com DocumentRoot /srv/mapeo # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet En /etc/apache2/apache2.conf descomento: <Directory /srv/> Options Indexes FollowSymLinks AllowOverride None Require all granted </Directory> Habilito el nuevo VirtualHost: sudo a2ensite mapeo.conf Reinicio apache: sudo systemctl restart apache2 En mi m\u00e1quina a\u00f1ado a /etc/hosts lo siguiente: # ej1mapeourls resolutions 192.168.121.8 www.mapeo.com Veo que funciona con un index.html de prueba: Ejercicio 1 Redireccionar www.mapeo.com a www.mapeo.com/principal, con mensaje de bienvenida En /etc/apache2/sites-available/mapeo.conf a\u00f1ado: RedirectMatch ^/$ /principal Reinicio apache: sudo systemctl restart apache2 Compruebo que la redirecci\u00f3n funciona: Ejercicio 2 En www.mapeo.com/principal se deniega: Listado de contenidos Enlaces simb\u00f3licos Negociaci\u00f3n de contenidos La configuraci\u00f3n a\u00f1adida en /etc/apache2/sites-available/mapeo.conf ser\u00eda: <Directory /srv/mapeo/principal> Options -Indexes Options -FollowSymLinks Options -MultiViews </Directory> Reinicio apache: sudo systemctl restart apache2 Denegaci\u00f3n de listado de contenidos Modifico el nombre del index.html en /srv/mapeo/principal a otro cualquiera. Hago esto porque Indexes primero busca un index.html en el directorio, y si no lo encuentra, intenta listar el contenido. Muestro que deniega el listado: Denegaci\u00f3n de enlaces simb\u00f3licos Creo uno de prueba: sudo ln -s ~/test.txt test.txt Muestro que deniega el acceso: Denegaci\u00f3n de negociaci\u00f3n de contenidos Creo 2 index.html de prueba, uno en espa\u00f1ol y otro en ingl\u00e9s: -rw-r--r-- 1 root root 378 Oct 24 17:45 index.html.en -rw-r--r-- 1 root root 383 Oct 24 17:44 index.html.es Muestro que deniega el acceso: Ejercicio 3 Hacer Alias de www.mapeo.com/principal/documentos a /home/vagrant/doc Se permitir\u00e1: Indexes SymLinksIfOwnerMatch En /home/vagrant/doc he creado la siguiente estructura de pruebas: lrwxrwxrwx 1 vagrant vagrant 23 Oct 24 18:17 dummy.pdf -> /home/vagrant/dummy.pdf -rw-r--r-- 1 vagrant vagrant 3028 Feb 24 2017 sample.pdf Vemos que dummy.pdf mantiene el mismo owner que el enlace simb\u00f3lico en el fichero original: vagrant@ej1mapeourls:~$ ls -la total 56 drwxr-xr-x 5 vagrant vagrant 4096 Oct 24 18:15 . drwxr-xr-x 3 root root 4096 Aug 29 17:07 .. -rw-r--r-- 1 vagrant vagrant 220 Aug 4 20:25 .bash_logout -rw-r--r-- 1 vagrant vagrant 3526 Aug 4 20:25 .bashrc drwxr-xr-x 3 vagrant vagrant 4096 Oct 22 11:55 .local -rw-r--r-- 1 vagrant vagrant 807 Aug 4 20:25 .profile drwx------ 2 vagrant vagrant 4096 Oct 22 11:46 .ssh -rw-r--r-- 1 vagrant vagrant 216 Oct 24 18:15 .wget-hsts drwxr-xr-x 2 vagrant vagrant 4096 Oct 24 18:17 doc -rw-r--r-- 1 vagrant vagrant 13264 Aug 27 2007 dummy.pdf -rw-r--r-- 1 vagrant vagrant 7 Oct 24 17:27 test.txt A\u00f1ado lo siguiente a /etc/apache2/sites-available/mapeo.conf para la configuraci\u00f3n del Alias: Alias /principal/documentos /home/vagrant/doc <Directory /home/vagrant/doc> Options Indexes SymLinksIfOwnerMatch Require all granted </Directory> Reinicio apache: sudo systemctl restart apache2 Muestro que funciona: En caso de que el owner entre enlace simb\u00f3lico y fichero original difiriese, simplemente har\u00eda que no se nos mostrase en ese listado, aunque el fichero existiera. El hecho de que dummy.pdf se muestre, es prueba de que SymLinksIfOwnerMatch est\u00e1 funcionando. Ejercicio 4 Crear /srv/mapeo/error sudo mkdir /srv/mapeo/error Crear en ese directorio 2 html de error custom -rw-r--r-- 1 root root 2599 Oct 24 22:52 403.html -rw-r--r-- 1 root root 1367 Oct 24 22:43 404.html A\u00f1adir a /etc/apache2/sites-available/mapeo.conf lo siguiente: ErrorDocument 404 \"/error/404.html\" ErrorDocument 403 \"/error/403.html\" Reiniciar apache: sudo systemctl restart apache2 Entro con una URL inventada para probar el 404 Entro a www.mapeo.com/principal para probar el 403, ya que ten\u00eda el Indexes y el MultiViews prohibido","title":"Ejercicio 1: Mapeo de URLs"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicio-1-mapear-url-a-ubicaciones-de-un-sistema-de-ficheros","text":"","title":"Ejercicio 1: Mapear URL a ubicaciones de un sistema de ficheros"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#entrega","text":"","title":"ENTREGA"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#parte-1","text":"Mostrar configuraci\u00f3n completa del virtualhost <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.mapeo.com DocumentRoot /srv/mapeo RedirectMatch ^/$ /principal <Directory /srv/mapeo/principal> Options -Indexes Options -FollowSymLinks Options -MultiViews </Directory> Alias /principal/documentos /home/vagrant/doc <Directory /home/vagrant/doc> Options Indexes SymLinksIfOwnerMatch Require all granted </Directory> ErrorDocument 404 \"/error/404.html\" ErrorDocument 403 \"/error/403.html\" # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet","title":"Parte 1"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#parte-2","text":"Con F12 de firefox, entrega screenshot para mostrar el redireccionamiento de www.mapeo.com a principal","title":"Parte 2"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#parte-3","text":"Mostrar screenshot en www.mapeo.com/principal/documentos","title":"Parte 3"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#parte-4","text":"Mostrar screenshot de 404 custom Mostrar screenshot de 403 custom","title":"Parte 4"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicios","text":"","title":"EJERCICIOS"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicio-0","text":"Crear virtualhost www.mapeo.com con DocumentRoot /srv/mapeo Creo /etc/apache2/sites-available/mapeo.conf : <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.mapeo.com DocumentRoot /srv/mapeo # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet En /etc/apache2/apache2.conf descomento: <Directory /srv/> Options Indexes FollowSymLinks AllowOverride None Require all granted </Directory> Habilito el nuevo VirtualHost: sudo a2ensite mapeo.conf Reinicio apache: sudo systemctl restart apache2 En mi m\u00e1quina a\u00f1ado a /etc/hosts lo siguiente: # ej1mapeourls resolutions 192.168.121.8 www.mapeo.com Veo que funciona con un index.html de prueba:","title":"Ejercicio 0"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicio-1","text":"Redireccionar www.mapeo.com a www.mapeo.com/principal, con mensaje de bienvenida En /etc/apache2/sites-available/mapeo.conf a\u00f1ado: RedirectMatch ^/$ /principal Reinicio apache: sudo systemctl restart apache2 Compruebo que la redirecci\u00f3n funciona:","title":"Ejercicio 1"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicio-2","text":"En www.mapeo.com/principal se deniega: Listado de contenidos Enlaces simb\u00f3licos Negociaci\u00f3n de contenidos La configuraci\u00f3n a\u00f1adida en /etc/apache2/sites-available/mapeo.conf ser\u00eda: <Directory /srv/mapeo/principal> Options -Indexes Options -FollowSymLinks Options -MultiViews </Directory> Reinicio apache: sudo systemctl restart apache2","title":"Ejercicio 2"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#denegacion-de-listado-de-contenidos","text":"Modifico el nombre del index.html en /srv/mapeo/principal a otro cualquiera. Hago esto porque Indexes primero busca un index.html en el directorio, y si no lo encuentra, intenta listar el contenido. Muestro que deniega el listado:","title":"Denegaci\u00f3n de listado de contenidos"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#denegacion-de-enlaces-simbolicos","text":"Creo uno de prueba: sudo ln -s ~/test.txt test.txt Muestro que deniega el acceso:","title":"Denegaci\u00f3n de enlaces simb\u00f3licos"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#denegacion-de-negociacion-de-contenidos","text":"Creo 2 index.html de prueba, uno en espa\u00f1ol y otro en ingl\u00e9s: -rw-r--r-- 1 root root 378 Oct 24 17:45 index.html.en -rw-r--r-- 1 root root 383 Oct 24 17:44 index.html.es Muestro que deniega el acceso:","title":"Denegaci\u00f3n de negociaci\u00f3n de contenidos"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicio-3","text":"Hacer Alias de www.mapeo.com/principal/documentos a /home/vagrant/doc Se permitir\u00e1: Indexes SymLinksIfOwnerMatch En /home/vagrant/doc he creado la siguiente estructura de pruebas: lrwxrwxrwx 1 vagrant vagrant 23 Oct 24 18:17 dummy.pdf -> /home/vagrant/dummy.pdf -rw-r--r-- 1 vagrant vagrant 3028 Feb 24 2017 sample.pdf Vemos que dummy.pdf mantiene el mismo owner que el enlace simb\u00f3lico en el fichero original: vagrant@ej1mapeourls:~$ ls -la total 56 drwxr-xr-x 5 vagrant vagrant 4096 Oct 24 18:15 . drwxr-xr-x 3 root root 4096 Aug 29 17:07 .. -rw-r--r-- 1 vagrant vagrant 220 Aug 4 20:25 .bash_logout -rw-r--r-- 1 vagrant vagrant 3526 Aug 4 20:25 .bashrc drwxr-xr-x 3 vagrant vagrant 4096 Oct 22 11:55 .local -rw-r--r-- 1 vagrant vagrant 807 Aug 4 20:25 .profile drwx------ 2 vagrant vagrant 4096 Oct 22 11:46 .ssh -rw-r--r-- 1 vagrant vagrant 216 Oct 24 18:15 .wget-hsts drwxr-xr-x 2 vagrant vagrant 4096 Oct 24 18:17 doc -rw-r--r-- 1 vagrant vagrant 13264 Aug 27 2007 dummy.pdf -rw-r--r-- 1 vagrant vagrant 7 Oct 24 17:27 test.txt A\u00f1ado lo siguiente a /etc/apache2/sites-available/mapeo.conf para la configuraci\u00f3n del Alias: Alias /principal/documentos /home/vagrant/doc <Directory /home/vagrant/doc> Options Indexes SymLinksIfOwnerMatch Require all granted </Directory> Reinicio apache: sudo systemctl restart apache2 Muestro que funciona: En caso de que el owner entre enlace simb\u00f3lico y fichero original difiriese, simplemente har\u00eda que no se nos mostrase en ese listado, aunque el fichero existiera. El hecho de que dummy.pdf se muestre, es prueba de que SymLinksIfOwnerMatch est\u00e1 funcionando.","title":"Ejercicio 3"},{"location":"ej1-mapeo-urls-al-sistema-ficheros/#ejercicio-4","text":"Crear /srv/mapeo/error sudo mkdir /srv/mapeo/error Crear en ese directorio 2 html de error custom -rw-r--r-- 1 root root 2599 Oct 24 22:52 403.html -rw-r--r-- 1 root root 1367 Oct 24 22:43 404.html A\u00f1adir a /etc/apache2/sites-available/mapeo.conf lo siguiente: ErrorDocument 404 \"/error/404.html\" ErrorDocument 403 \"/error/403.html\" Reiniciar apache: sudo systemctl restart apache2 Entro con una URL inventada para probar el 404 Entro a www.mapeo.com/principal para probar el 403, ya que ten\u00eda el Indexes y el MultiViews prohibido","title":"Ejercicio 4"},{"location":"ej1-nftables-nodo/","text":"Ejercicio 1 nftables: cortafuegos por nodo Preliminares Escenario Vagrant . configure ( \"2\" ) do | config | config . vm . synced_folder \".\" , \"/vagrant\" , disabled : true config . vm . define :ej1nftables1 do | ej1nftables1 | ej1nftables1 . vm . box = \"debian/bullseye64\" ej1nftables1 . vm . hostname = \"ej1nftables1\" ej1nftables1 . vm . network :private_network , :libvirt__network_name => \"ej1-nftables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.2\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end config . vm . define :ej1nftables2 do | ej1nftables2 | ej1nftables2 . vm . box = \"debian/bullseye64\" ej1nftables2 . vm . hostname = \"ej1nftables2\" ej1nftables2 . vm . network :private_network , :libvirt__network_name => \"ej1-nftables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.3\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end end Instalo un servidor web para dejar abierto el puerto 80: sudo apt update sudo apt install apache2 Preparaci\u00f3n nftables Creo la tabla filter: sudo nft add table inet filter Creo las cadenas input/output en filter: sudo nft add chain inet filter input { type filter hook input priority 0 \\; counter \\; policy accept \\; } sudo nft add chain inet filter output { type filter hook output priority 0 \\; counter \\; policy accept \\; } Tr\u00e1fico ssh entrante sudo nft add rule inet filter input ip saddr 192.168.121.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter output ip daddr 192.168.121.0/24 tcp sport 22 ct state established counter accept Cambiar pol\u00edticas por defecto sudo nft chain inet filter input { policy drop \\; } sudo nft chain inet filter output { policy drop \\; } Despu\u00e9s de este paso me sigue funcionando la conexi\u00f3n SSH a la m\u00e1quina, por lo que las reglas del paso anterior funcionan. Todo tr\u00e1fico diferente a este, no funciona por ahora. Tr\u00e1fico loopback sudo nft add rule inet filter output oifname \"lo\" counter accept sudo nft add rule inet filter input iifname \"lo\" counter accept Ya funciona el ping a localhost: vagrant@ej1nftables1:~$ ping 127 .0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.025 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.073 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1017ms rtt min/avg/max/mdev = 0.025/0.049/0.073/0.024 ms Tr\u00e1fico ICMP saliente sudo nft add rule inet filter output oifname \"eth0\" icmp type echo-request counter accept sudo nft add rule inet filter input iifname \"eth0\" icmp type echo-reply counter accept Ya funciona el ping a Internet: vagrant@ej1nftables1:~$ ping 1 .1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=368 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=135 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 135.491/251.525/367.559/116.034 ms Tr\u00e1fico DNS saliente sudo nft add rule inet filter output oifname \"eth0\" udp dport 53 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth0\" udp sport 53 ct state established counter accept Probamos que las consultas DNS funcionan: vagrant@ej1nftables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 65305 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 132 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Thu Jan 27 12:41:50 UTC 2022 ;; MSG SIZE rcvd: 60 Tr\u00e1fico http/https saliente sudo nft add rule inet filter output oifname \"eth0\" ip protocol tcp tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth0\" ip protocol tcp tcp sport { 80,443 } ct state established counter accept Compruebo que funciona http: vagrant@ej1nftables1:~$ curl http://portquiz.net:80 Port test successful! Your IP: 158.99.1.24 Compruebo que funciona https: vagrant@ej1nftables1:~$ curl portquiz.net:443 Port test successful! Your IP: 158.99.1.24 Tr\u00e1fico http entrante sudo nft add rule inet filter input iifname \"eth0\" tcp dport 80 ct state new,established counter accept sudo nft add rule inet filter output oifname \"eth0\" tcp sport 80 ct state established counter accept Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej1-nftables-nodo$ telnet 192 .168.121.65 80 Trying 192.168.121.65... Connected to 192.168.121.65. Escape character is '^]'. Ejercicios Ejercicio 1 Permitir conexiones ssh al exterior sudo nft add rule inet filter output tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input tcp sport 22 ct state established counter accept Pruebo que funciona conectando a mi host: vagrant@ej1nftables1:~$ ssh atlas@192.168.121.1 The authenticity of host '192.168.121.1 (192.168.121.1)' can't be established. ECDSA key fingerprint is SHA256:xbn++TBj5GyQdixTeO+cP7UGJzvMspD3AVK0JD1RbLw. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added '192.168.121.1' (ECDSA) to the list of known hosts. atlas@192.168.121.1's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Wed Jan 26 10:32:49 2022 from 192.168.121.148 atlas@olympus:~$ Ejercicio 2 Denegar tr\u00e1fico http entrante desde el host Antes de a\u00f1adir la regla de bloqueo, debemos tener en cuenta nuestra situaci\u00f3n actual de reglas en INPUT: Como se puede ver, si a\u00f1adi\u00e9ramos la regla de bloqueo al final no servir\u00eda para nada porque siempre har\u00eda match con la que permite todo el tr\u00e1fico http entrante (la marcada en rojo) . \u00bfSoluci\u00f3n? A\u00f1adirla por encima de la regla marcada en rojo. Necesitamos saber el handle de la regla que est\u00e1 por encima de la posici\u00f3n donde queremos la nueva regla, as\u00ed que ejecutamos: sudo nft -n -a list ruleset Vamos a a\u00f1adir la regla de bloqueo usando el handle marcado para que se coloque justo debajo, y as\u00ed estar\u00e1 en la posici\u00f3n que queremos: sudo nft add rule inet filter input position 18 ip saddr 192.168.121.1 tcp dport 80 ct state new,established counter drop Muestro c\u00f3mo han quedado: Compruebo que bloquea el tr\u00e1fico: atlas@olympus:~/vagrant/ej1-nftables-nodo$ telnet 192 .168.121.65 80 Trying 192.168.121.65... Ejercicio 3 Permitir tr\u00e1fico DNS saliente s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 Nos encontramos en una situaci\u00f3n parecida a la del ejercicio anterior, pero en este caso tenemos que borrar 2 reglas antiguas que permit\u00edan el tr\u00e1fico DNS saliente a todo: Incluso si a\u00f1adi\u00e9ramos las nuevas reglas por encima de estas, cuando hici\u00e9semos dig a 1.1.1.1 llegar\u00eda a hacer match con estas reglas y permitir\u00eda el tr\u00e1fico, y eso no es lo que queremos. Para borrar estas reglas, primero tenemos que saber sus handles: Ya podemos borrarlas: sudo nft delete rule inet filter input handle 14 sudo nft delete rule inet filter output handle 13 A\u00f1adimos las nuevas reglas: sudo nft add rule inet filter output ip daddr 192.168.202.2 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter input ip saddr 192.168.202.2 udp sport 53 ct state established counter accept Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@ej1nftables1:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 18296 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 5 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: ce3cd730cac8cfacd646547461f3e6ed8a244c9fe1c24ed8 (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; AUTHORITY SECTION: example.org. 66421 IN NS a.iana-servers.net. example.org. 66421 IN NS b.iana-servers.net. ;; ADDITIONAL SECTION: a.iana-servers.net. 152765 IN A 199.43.135.53 b.iana-servers.net. 152765 IN A 199.43.133.53 a.iana-servers.net. 152765 IN AAAA 2001:500:8f::53 b.iana-servers.net. 152765 IN AAAA 2001:500:8d::53 ;; Query time: 492 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Fri Jan 28 12:51:57 UTC 2022 ;; MSG SIZE rcvd: 224 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@ej1nftables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached Ejercicio 4 Bloquear tr\u00e1fico http saliente a www.josedomingo.org (utilizar la ip). \u00bfSe puede acceder a fp.josedomingo.org? De nuevo, tendr\u00edamos una situaci\u00f3n de conflicto de reglas si la siguiente la a\u00f1adi\u00e9ramos al final, porque antes tenemos una que permite todo el tr\u00e1fico http/https saliente y los matchs se quedar\u00edan siempre ah\u00ed: Tendremos que a\u00f1adir la regla de bloqueo por encima de la anterior mostrada: sudo nft add rule inet filter output position 11 ip daddr 37.187.119.60 tcp dport 80 ct state new,established counter drop Se nos quedar\u00edan las reglas as\u00ed: Pruebo que no funciona el tr\u00e1fico http saliente a www.josedomingo.org : vagrant@ej1nftables1:~$ curl www.josedomingo.org Se quedar\u00e1 esperando infinitamente porque no hay conexi\u00f3n. Pruebo a ver si funciona el tr\u00e1fico http saliente a fp.josedomingo.org : vagrant@ej1nftables1:~$ curl fp.josedomingo.org Tampoco hay conexi\u00f3n. No funciona ya que fp.josedomingo.org se acaba traduciendo a la misma IP que hemos bloqueado antes. Pruebo que cualquier otro tr\u00e1fico http saliente funciona: vagrant@ej1nftables1:~$ telnet www.example.org 80 Trying 93.184.216.34... Connected to www.example.org. Escape character is '^]'. Ejercicio 5 Permitir tr\u00e1fico saliente a babuino-smtp.gonzalonazareno.org por el puerto 25 sudo nft add rule inet filter output ip daddr 192.168.203.3 tcp dport 25 ct state new,established counter accept sudo nft add rule inet filter input ip saddr 192.168.203.3 tcp sport 25 ct state established counter accept Pruebo que funciona con telnet: vagrant@ej1nftables1:~$ telnet babuino-smtp.gonzalonazareno.org 25 Trying 192.168.203.3... Connected to babuino-smtp.gonzalonazareno.org. Escape character is '^]'. 220 babuino-smtp.gonzalonazareno.org ESMTP Postfix (Debian/GNU) Ejercicio 6 Parte 1 Instalar mariadb-server y habilitar conexiones remotas sudo apt install mariadb-server /etc/mysql/mariadb.conf.d/50-server.cnf : bind-address = 0.0.0.0 Reinicio: sudo systemctl restart mariadb Parte 2 Permitir tr\u00e1fico entrante desde mi host sudo nft add rule inet filter input ip saddr 192.168.121.1 tcp dport 3306 counter accept sudo nft add rule inet filter output ip daddr 192.168.121.1 tcp sport 3306 counter accept Pruebo que funciona: atlas@olympus:~/vagrant/ej1-nftables-nodo$ nc -zvw10 192 .168.121.65 3306 Connection to 192.168.121.65 3306 port [tcp/mysql] succeeded! Parte 3 Comprobar que desde otro cliente bloquea el tr\u00e1fico vagrant@ej1nftables2:~$ nc -zvw10 192 .168.0.2 3306 192.168.0.2: inverse host lookup failed: Unknown host (UNKNOWN) [192.168.0.2] 3306 (mysql) : Connection timed out","title":"Ejercicio 1 nftables: por nodo"},{"location":"ej1-nftables-nodo/#ejercicio-1-nftables-cortafuegos-por-nodo","text":"","title":"Ejercicio 1 nftables: cortafuegos por nodo"},{"location":"ej1-nftables-nodo/#preliminares","text":"","title":"Preliminares"},{"location":"ej1-nftables-nodo/#escenario","text":"Vagrant . configure ( \"2\" ) do | config | config . vm . synced_folder \".\" , \"/vagrant\" , disabled : true config . vm . define :ej1nftables1 do | ej1nftables1 | ej1nftables1 . vm . box = \"debian/bullseye64\" ej1nftables1 . vm . hostname = \"ej1nftables1\" ej1nftables1 . vm . network :private_network , :libvirt__network_name => \"ej1-nftables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.2\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end config . vm . define :ej1nftables2 do | ej1nftables2 | ej1nftables2 . vm . box = \"debian/bullseye64\" ej1nftables2 . vm . hostname = \"ej1nftables2\" ej1nftables2 . vm . network :private_network , :libvirt__network_name => \"ej1-nftables-nodo\" , :libvirt__dhcp_enabled => false , :ip => \"192.168.0.3\" , :libvirt__netmask => '255.255.255.0' , :libvirt__forward_mode => \"veryisolated\" end end Instalo un servidor web para dejar abierto el puerto 80: sudo apt update sudo apt install apache2","title":"Escenario"},{"location":"ej1-nftables-nodo/#preparacion-nftables","text":"Creo la tabla filter: sudo nft add table inet filter Creo las cadenas input/output en filter: sudo nft add chain inet filter input { type filter hook input priority 0 \\; counter \\; policy accept \\; } sudo nft add chain inet filter output { type filter hook output priority 0 \\; counter \\; policy accept \\; }","title":"Preparaci\u00f3n nftables"},{"location":"ej1-nftables-nodo/#trafico-ssh-entrante","text":"sudo nft add rule inet filter input ip saddr 192.168.121.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter output ip daddr 192.168.121.0/24 tcp sport 22 ct state established counter accept","title":"Tr\u00e1fico ssh entrante"},{"location":"ej1-nftables-nodo/#cambiar-politicas-por-defecto","text":"sudo nft chain inet filter input { policy drop \\; } sudo nft chain inet filter output { policy drop \\; } Despu\u00e9s de este paso me sigue funcionando la conexi\u00f3n SSH a la m\u00e1quina, por lo que las reglas del paso anterior funcionan. Todo tr\u00e1fico diferente a este, no funciona por ahora.","title":"Cambiar pol\u00edticas por defecto"},{"location":"ej1-nftables-nodo/#trafico-loopback","text":"sudo nft add rule inet filter output oifname \"lo\" counter accept sudo nft add rule inet filter input iifname \"lo\" counter accept Ya funciona el ping a localhost: vagrant@ej1nftables1:~$ ping 127 .0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.025 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.073 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1017ms rtt min/avg/max/mdev = 0.025/0.049/0.073/0.024 ms","title":"Tr\u00e1fico loopback"},{"location":"ej1-nftables-nodo/#trafico-icmp-saliente","text":"sudo nft add rule inet filter output oifname \"eth0\" icmp type echo-request counter accept sudo nft add rule inet filter input iifname \"eth0\" icmp type echo-reply counter accept Ya funciona el ping a Internet: vagrant@ej1nftables1:~$ ping 1 .1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=368 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=135 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 135.491/251.525/367.559/116.034 ms","title":"Tr\u00e1fico ICMP saliente"},{"location":"ej1-nftables-nodo/#trafico-dns-saliente","text":"sudo nft add rule inet filter output oifname \"eth0\" udp dport 53 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth0\" udp sport 53 ct state established counter accept Probamos que las consultas DNS funcionan: vagrant@ej1nftables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 65305 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 132 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Thu Jan 27 12:41:50 UTC 2022 ;; MSG SIZE rcvd: 60","title":"Tr\u00e1fico DNS saliente"},{"location":"ej1-nftables-nodo/#trafico-httphttps-saliente","text":"sudo nft add rule inet filter output oifname \"eth0\" ip protocol tcp tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth0\" ip protocol tcp tcp sport { 80,443 } ct state established counter accept Compruebo que funciona http: vagrant@ej1nftables1:~$ curl http://portquiz.net:80 Port test successful! Your IP: 158.99.1.24 Compruebo que funciona https: vagrant@ej1nftables1:~$ curl portquiz.net:443 Port test successful! Your IP: 158.99.1.24","title":"Tr\u00e1fico http/https saliente"},{"location":"ej1-nftables-nodo/#trafico-http-entrante","text":"sudo nft add rule inet filter input iifname \"eth0\" tcp dport 80 ct state new,established counter accept sudo nft add rule inet filter output oifname \"eth0\" tcp sport 80 ct state established counter accept Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej1-nftables-nodo$ telnet 192 .168.121.65 80 Trying 192.168.121.65... Connected to 192.168.121.65. Escape character is '^]'.","title":"Tr\u00e1fico http entrante"},{"location":"ej1-nftables-nodo/#ejercicios","text":"","title":"Ejercicios"},{"location":"ej1-nftables-nodo/#ejercicio-1","text":"Permitir conexiones ssh al exterior sudo nft add rule inet filter output tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input tcp sport 22 ct state established counter accept Pruebo que funciona conectando a mi host: vagrant@ej1nftables1:~$ ssh atlas@192.168.121.1 The authenticity of host '192.168.121.1 (192.168.121.1)' can't be established. ECDSA key fingerprint is SHA256:xbn++TBj5GyQdixTeO+cP7UGJzvMspD3AVK0JD1RbLw. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added '192.168.121.1' (ECDSA) to the list of known hosts. atlas@192.168.121.1's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Wed Jan 26 10:32:49 2022 from 192.168.121.148 atlas@olympus:~$","title":"Ejercicio 1"},{"location":"ej1-nftables-nodo/#ejercicio-2","text":"Denegar tr\u00e1fico http entrante desde el host Antes de a\u00f1adir la regla de bloqueo, debemos tener en cuenta nuestra situaci\u00f3n actual de reglas en INPUT: Como se puede ver, si a\u00f1adi\u00e9ramos la regla de bloqueo al final no servir\u00eda para nada porque siempre har\u00eda match con la que permite todo el tr\u00e1fico http entrante (la marcada en rojo) . \u00bfSoluci\u00f3n? A\u00f1adirla por encima de la regla marcada en rojo. Necesitamos saber el handle de la regla que est\u00e1 por encima de la posici\u00f3n donde queremos la nueva regla, as\u00ed que ejecutamos: sudo nft -n -a list ruleset Vamos a a\u00f1adir la regla de bloqueo usando el handle marcado para que se coloque justo debajo, y as\u00ed estar\u00e1 en la posici\u00f3n que queremos: sudo nft add rule inet filter input position 18 ip saddr 192.168.121.1 tcp dport 80 ct state new,established counter drop Muestro c\u00f3mo han quedado: Compruebo que bloquea el tr\u00e1fico: atlas@olympus:~/vagrant/ej1-nftables-nodo$ telnet 192 .168.121.65 80 Trying 192.168.121.65...","title":"Ejercicio 2"},{"location":"ej1-nftables-nodo/#ejercicio-3","text":"Permitir tr\u00e1fico DNS saliente s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 Nos encontramos en una situaci\u00f3n parecida a la del ejercicio anterior, pero en este caso tenemos que borrar 2 reglas antiguas que permit\u00edan el tr\u00e1fico DNS saliente a todo: Incluso si a\u00f1adi\u00e9ramos las nuevas reglas por encima de estas, cuando hici\u00e9semos dig a 1.1.1.1 llegar\u00eda a hacer match con estas reglas y permitir\u00eda el tr\u00e1fico, y eso no es lo que queremos. Para borrar estas reglas, primero tenemos que saber sus handles: Ya podemos borrarlas: sudo nft delete rule inet filter input handle 14 sudo nft delete rule inet filter output handle 13 A\u00f1adimos las nuevas reglas: sudo nft add rule inet filter output ip daddr 192.168.202.2 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter input ip saddr 192.168.202.2 udp sport 53 ct state established counter accept Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@ej1nftables1:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 18296 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 5 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: ce3cd730cac8cfacd646547461f3e6ed8a244c9fe1c24ed8 (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; AUTHORITY SECTION: example.org. 66421 IN NS a.iana-servers.net. example.org. 66421 IN NS b.iana-servers.net. ;; ADDITIONAL SECTION: a.iana-servers.net. 152765 IN A 199.43.135.53 b.iana-servers.net. 152765 IN A 199.43.133.53 a.iana-servers.net. 152765 IN AAAA 2001:500:8f::53 b.iana-servers.net. 152765 IN AAAA 2001:500:8d::53 ;; Query time: 492 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Fri Jan 28 12:51:57 UTC 2022 ;; MSG SIZE rcvd: 224 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@ej1nftables1:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached","title":"Ejercicio 3"},{"location":"ej1-nftables-nodo/#ejercicio-4","text":"Bloquear tr\u00e1fico http saliente a www.josedomingo.org (utilizar la ip). \u00bfSe puede acceder a fp.josedomingo.org? De nuevo, tendr\u00edamos una situaci\u00f3n de conflicto de reglas si la siguiente la a\u00f1adi\u00e9ramos al final, porque antes tenemos una que permite todo el tr\u00e1fico http/https saliente y los matchs se quedar\u00edan siempre ah\u00ed: Tendremos que a\u00f1adir la regla de bloqueo por encima de la anterior mostrada: sudo nft add rule inet filter output position 11 ip daddr 37.187.119.60 tcp dport 80 ct state new,established counter drop Se nos quedar\u00edan las reglas as\u00ed: Pruebo que no funciona el tr\u00e1fico http saliente a www.josedomingo.org : vagrant@ej1nftables1:~$ curl www.josedomingo.org Se quedar\u00e1 esperando infinitamente porque no hay conexi\u00f3n. Pruebo a ver si funciona el tr\u00e1fico http saliente a fp.josedomingo.org : vagrant@ej1nftables1:~$ curl fp.josedomingo.org Tampoco hay conexi\u00f3n. No funciona ya que fp.josedomingo.org se acaba traduciendo a la misma IP que hemos bloqueado antes. Pruebo que cualquier otro tr\u00e1fico http saliente funciona: vagrant@ej1nftables1:~$ telnet www.example.org 80 Trying 93.184.216.34... Connected to www.example.org. Escape character is '^]'.","title":"Ejercicio 4"},{"location":"ej1-nftables-nodo/#ejercicio-5","text":"Permitir tr\u00e1fico saliente a babuino-smtp.gonzalonazareno.org por el puerto 25 sudo nft add rule inet filter output ip daddr 192.168.203.3 tcp dport 25 ct state new,established counter accept sudo nft add rule inet filter input ip saddr 192.168.203.3 tcp sport 25 ct state established counter accept Pruebo que funciona con telnet: vagrant@ej1nftables1:~$ telnet babuino-smtp.gonzalonazareno.org 25 Trying 192.168.203.3... Connected to babuino-smtp.gonzalonazareno.org. Escape character is '^]'. 220 babuino-smtp.gonzalonazareno.org ESMTP Postfix (Debian/GNU)","title":"Ejercicio 5"},{"location":"ej1-nftables-nodo/#ejercicio-6","text":"","title":"Ejercicio 6"},{"location":"ej1-nftables-nodo/#parte-1","text":"Instalar mariadb-server y habilitar conexiones remotas sudo apt install mariadb-server /etc/mysql/mariadb.conf.d/50-server.cnf : bind-address = 0.0.0.0 Reinicio: sudo systemctl restart mariadb","title":"Parte 1"},{"location":"ej1-nftables-nodo/#parte-2","text":"Permitir tr\u00e1fico entrante desde mi host sudo nft add rule inet filter input ip saddr 192.168.121.1 tcp dport 3306 counter accept sudo nft add rule inet filter output ip daddr 192.168.121.1 tcp sport 3306 counter accept Pruebo que funciona: atlas@olympus:~/vagrant/ej1-nftables-nodo$ nc -zvw10 192 .168.121.65 3306 Connection to 192.168.121.65 3306 port [tcp/mysql] succeeded!","title":"Parte 2"},{"location":"ej1-nftables-nodo/#parte-3","text":"Comprobar que desde otro cliente bloquea el tr\u00e1fico vagrant@ej1nftables2:~$ nc -zvw10 192 .168.0.2 3306 192.168.0.2: inverse host lookup failed: Unknown host (UNKNOWN) [192.168.0.2] 3306 (mysql) : Connection timed out","title":"Parte 3"},{"location":"ej1-phpmyadmin/","text":"Ejercicio 1: Instalaci\u00f3n de phpmyadmin ENTREGA Parte 1 Captura donde se vea la base de datos creada en el punto 1 Parte 2 \u00bfC\u00f3mo has quitado la configuraci\u00f3n de acceso a phpmyadmin en el punto 5? sudo a2disconf phpmyadmin sudo systemctl restart apache2 Parte 3 Captura del VirtualHost Parte 4 Captura accediendo a phpmyadmin con el usuario del punto 1 A la derecha en rojo muestro el campo donde se indica con qu\u00e9 usuario hemos iniciado sesi\u00f3n. REALIZACI\u00d3N Paso 0 Instalar mariadb-server sudo apt update sudo apt install mariadb-server Hacer que el usuario root acceda con contrase\u00f1a Por defecto el usuario root puede hacer login sin contrase\u00f1a, porque internamente mariadb lo almacena con una password inv\u00e1lida: MariaDB [(none)]> SELECT host, user, password FROM mysql.user; +-----------+-------------+----------+ | Host | User | Password | +-----------+-------------+----------+ | localhost | mariadb.sys | | | localhost | root | invalid | | localhost | mysql | invalid | +-----------+-------------+----------+ Este funcionamiento es intencional, para que luego nosotros manualmente cambiemos a la contrase\u00f1a que queramos. Cambio la contrase\u00f1a con: ALTER USER 'root'@'localhost' IDENTIFIED BY 'vagrant'; Despu\u00e9s de esto, la contrase\u00f1a se almacena: MariaDB [(none)]> SELECT host, user, password FROM mysql.user; +-----------+-------------+-------------------------------------------+ | Host | User | Password | +-----------+-------------+-------------------------------------------+ | localhost | mariadb.sys | | | localhost | root | *04E6E1273D1783DF7D57DC5479FE01CFFDFD0058 | | localhost | mysql | invalid | +-----------+-------------+-------------------------------------------+ Ya podr\u00edamos hacer login normalmente con: mysql -u root -p A partir de ahora, de cualquier manera que intentemos entrar con root ( con sudo o sin sudo por ejemplo ), nos obligar\u00e1 a escribir la contrase\u00f1a. Paso 1 Acceder a mariadb con root y contrase\u00f1a mysql -u root -p Crear base de datos CREATE DATABASE `phpmyadmin_db`; Crear usuario con permisos sobre phpmyadmin_db CREATE USER 'phpmyadmin_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpmyadmin_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpmyadmin_db`.* TO 'phpmyadmin_user'@localhost; FLUSH PRIVILEGES; Muestro que los cambios se han hecho: MariaDB [(none)]> SHOW GRANTS FOR 'phpmyadmin_user'@localhost; +------------------------------------------------------------------------------------------------------------------------+ | Grants for phpmyadmin_user@localhost | +------------------------------------------------------------------------------------------------------------------------+ | GRANT USAGE ON *.* TO `phpmyadmin_user`@`localhost` IDENTIFIED BY PASSWORD '*A4B6157319038724E3560894F7F932C8886EBFCF' | | GRANT ALL PRIVILEGES ON `phpmyadmin_db`.* TO `phpmyadmin_user`@`localhost` | +------------------------------------------------------------------------------------------------------------------------+ Paso 2 Instalar phpmyadmin desde repositorios sudo apt install phpmyadmin Nos pregunta qu\u00e9 servidor web queremos dejar configurado para phpmyadmin , y eligimos apache2 : Decimos que s\u00ed para que configure la base de datos phpmyadmin_db que usar\u00e1 phpmyadmin : Especificamos m\u00e9todo de conexi\u00f3n a MariaDB por Unix socket: Dejamos por defecto el m\u00e9todo de autenticaci\u00f3n con MariaDB: Base de datos a utilizar por phpmyadmin : Usuario para la conexi\u00f3n con esa base de datos: Escribimos 1234 , la contrase\u00f1a del usuario phpmyadmin_user . La necesitar\u00e1 para poder acceder y configurar su base de datos: Confirmamos la contrase\u00f1a: Termina la instalaci\u00f3n Comprobar el acceso en /phpmyadmin Por defecto, tenemos este \"error\": Lo escribo entre comillas porque no es un error en s\u00ed, sino que apache no tiene funcionando la ejecuci\u00f3n de c\u00f3digo php. Nos est\u00e1 mostrando el index.php en crudo. Para solucionarlo: sudo apt install php sudo a2enmod php7.4 Hacemos Ctrl F5 para recargar ignorando la cach\u00e9, y ya funciona: Paso 3 \u00bfSe ha creado en el DocumentRoot un directorio que se llama phpmyadmin? No. \u00bfC\u00f3mo es que podemos acceder? El paquete phpmyadmin nos gener\u00f3 el enlace simb\u00f3lico phpmyadmin.conf en /etc/apache2/conf-available , que por defecto se habilita en conf-enabled . El fichero original /etc/phpmyadmin/apache.conf contiene 2 directivas que hacen que funcione el acceso: Alias /phpmyadmin /usr/share/phpmyadmin <Directory /usr/share/phpmyadmin> (he mostrado s\u00f3lo lo necesario, en el fichero original hay mucho m\u00e1s) Lo que exista en conf-enabled es configuraci\u00f3n global, por lo tanto este Alias y Directory se tendr\u00edan en cuenta desde cualquier VirtualHost. Paso 5 Deshabilitar acceso a phpmyadmin sudo a2disconf phpmyadmin sudo systemctl restart apache2 Comprobar que no se puede acceder Crear VirtualHost con ServerName basededatos.adrianjaramillo.org y que muestre phpmyadmin Creo /etc/apache2/sites-available/phpmyadmin.conf con el siguiente contenido: <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName basededatos.adrianjaramillo.org DocumentRoot /usr/share/phpmyadmin <Directory /usr/share/phpmyadmin> Options SymLinksIfOwnerMatch DirectoryIndex index.php # limit libapache2-mod-php to files and directories necessary by pma <IfModule mod_php7.c> php_admin_value upload_tmp_dir /var/lib/phpmyadmin/tmp php_admin_value open_basedir /usr/share/phpmyadmin/:/usr/share/doc/phpmyadmin/:/etc/phpmyadmin/:/var/lib/phpmyadmin/:/usr/share/php/:/usr/share/javascript/ </IfModule> </Directory> # Disallow web access to directories that don't need it <Directory /usr/share/phpmyadmin/templates> Require all denied </Directory> <Directory /usr/share/phpmyadmin/libraries> Require all denied </Directory> # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite phpmyadmin.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej1-phpmyadmin resolutions 192.168.121.96 basededatos.adrianjaramillo.org Muestro que accedo a phpmyadmin desde nombre y funciona: Paso 6 Acceder a phpmyadmin con el usuario del punto 1 phpmyadmin_user A la derecha vemos que estamos conectados con el usuario requerido: Comprobar que podemos gestionar su base de datos Muestro que puedo crear una tabla : Muestro que puedo borrar una tabla :","title":"Ejercicio 1: phpMyAdmin"},{"location":"ej1-phpmyadmin/#ejercicio-1-instalacion-de-phpmyadmin","text":"","title":"Ejercicio 1: Instalaci\u00f3n de phpmyadmin"},{"location":"ej1-phpmyadmin/#entrega","text":"","title":"ENTREGA"},{"location":"ej1-phpmyadmin/#parte-1","text":"Captura donde se vea la base de datos creada en el punto 1","title":"Parte 1"},{"location":"ej1-phpmyadmin/#parte-2","text":"\u00bfC\u00f3mo has quitado la configuraci\u00f3n de acceso a phpmyadmin en el punto 5? sudo a2disconf phpmyadmin sudo systemctl restart apache2","title":"Parte 2"},{"location":"ej1-phpmyadmin/#parte-3","text":"Captura del VirtualHost","title":"Parte 3"},{"location":"ej1-phpmyadmin/#parte-4","text":"Captura accediendo a phpmyadmin con el usuario del punto 1 A la derecha en rojo muestro el campo donde se indica con qu\u00e9 usuario hemos iniciado sesi\u00f3n.","title":"Parte 4"},{"location":"ej1-phpmyadmin/#realizacion","text":"","title":"REALIZACI\u00d3N"},{"location":"ej1-phpmyadmin/#paso-0","text":"Instalar mariadb-server sudo apt update sudo apt install mariadb-server Hacer que el usuario root acceda con contrase\u00f1a Por defecto el usuario root puede hacer login sin contrase\u00f1a, porque internamente mariadb lo almacena con una password inv\u00e1lida: MariaDB [(none)]> SELECT host, user, password FROM mysql.user; +-----------+-------------+----------+ | Host | User | Password | +-----------+-------------+----------+ | localhost | mariadb.sys | | | localhost | root | invalid | | localhost | mysql | invalid | +-----------+-------------+----------+ Este funcionamiento es intencional, para que luego nosotros manualmente cambiemos a la contrase\u00f1a que queramos. Cambio la contrase\u00f1a con: ALTER USER 'root'@'localhost' IDENTIFIED BY 'vagrant'; Despu\u00e9s de esto, la contrase\u00f1a se almacena: MariaDB [(none)]> SELECT host, user, password FROM mysql.user; +-----------+-------------+-------------------------------------------+ | Host | User | Password | +-----------+-------------+-------------------------------------------+ | localhost | mariadb.sys | | | localhost | root | *04E6E1273D1783DF7D57DC5479FE01CFFDFD0058 | | localhost | mysql | invalid | +-----------+-------------+-------------------------------------------+ Ya podr\u00edamos hacer login normalmente con: mysql -u root -p A partir de ahora, de cualquier manera que intentemos entrar con root ( con sudo o sin sudo por ejemplo ), nos obligar\u00e1 a escribir la contrase\u00f1a.","title":"Paso 0"},{"location":"ej1-phpmyadmin/#paso-1","text":"Acceder a mariadb con root y contrase\u00f1a mysql -u root -p Crear base de datos CREATE DATABASE `phpmyadmin_db`; Crear usuario con permisos sobre phpmyadmin_db CREATE USER 'phpmyadmin_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpmyadmin_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpmyadmin_db`.* TO 'phpmyadmin_user'@localhost; FLUSH PRIVILEGES; Muestro que los cambios se han hecho: MariaDB [(none)]> SHOW GRANTS FOR 'phpmyadmin_user'@localhost; +------------------------------------------------------------------------------------------------------------------------+ | Grants for phpmyadmin_user@localhost | +------------------------------------------------------------------------------------------------------------------------+ | GRANT USAGE ON *.* TO `phpmyadmin_user`@`localhost` IDENTIFIED BY PASSWORD '*A4B6157319038724E3560894F7F932C8886EBFCF' | | GRANT ALL PRIVILEGES ON `phpmyadmin_db`.* TO `phpmyadmin_user`@`localhost` | +------------------------------------------------------------------------------------------------------------------------+","title":"Paso 1"},{"location":"ej1-phpmyadmin/#paso-2","text":"Instalar phpmyadmin desde repositorios sudo apt install phpmyadmin Nos pregunta qu\u00e9 servidor web queremos dejar configurado para phpmyadmin , y eligimos apache2 : Decimos que s\u00ed para que configure la base de datos phpmyadmin_db que usar\u00e1 phpmyadmin : Especificamos m\u00e9todo de conexi\u00f3n a MariaDB por Unix socket: Dejamos por defecto el m\u00e9todo de autenticaci\u00f3n con MariaDB: Base de datos a utilizar por phpmyadmin : Usuario para la conexi\u00f3n con esa base de datos: Escribimos 1234 , la contrase\u00f1a del usuario phpmyadmin_user . La necesitar\u00e1 para poder acceder y configurar su base de datos: Confirmamos la contrase\u00f1a: Termina la instalaci\u00f3n Comprobar el acceso en /phpmyadmin Por defecto, tenemos este \"error\": Lo escribo entre comillas porque no es un error en s\u00ed, sino que apache no tiene funcionando la ejecuci\u00f3n de c\u00f3digo php. Nos est\u00e1 mostrando el index.php en crudo. Para solucionarlo: sudo apt install php sudo a2enmod php7.4 Hacemos Ctrl F5 para recargar ignorando la cach\u00e9, y ya funciona:","title":"Paso 2"},{"location":"ej1-phpmyadmin/#paso-3","text":"\u00bfSe ha creado en el DocumentRoot un directorio que se llama phpmyadmin? No. \u00bfC\u00f3mo es que podemos acceder? El paquete phpmyadmin nos gener\u00f3 el enlace simb\u00f3lico phpmyadmin.conf en /etc/apache2/conf-available , que por defecto se habilita en conf-enabled . El fichero original /etc/phpmyadmin/apache.conf contiene 2 directivas que hacen que funcione el acceso: Alias /phpmyadmin /usr/share/phpmyadmin <Directory /usr/share/phpmyadmin> (he mostrado s\u00f3lo lo necesario, en el fichero original hay mucho m\u00e1s) Lo que exista en conf-enabled es configuraci\u00f3n global, por lo tanto este Alias y Directory se tendr\u00edan en cuenta desde cualquier VirtualHost.","title":"Paso 3"},{"location":"ej1-phpmyadmin/#paso-5","text":"Deshabilitar acceso a phpmyadmin sudo a2disconf phpmyadmin sudo systemctl restart apache2 Comprobar que no se puede acceder Crear VirtualHost con ServerName basededatos.adrianjaramillo.org y que muestre phpmyadmin Creo /etc/apache2/sites-available/phpmyadmin.conf con el siguiente contenido: <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName basededatos.adrianjaramillo.org DocumentRoot /usr/share/phpmyadmin <Directory /usr/share/phpmyadmin> Options SymLinksIfOwnerMatch DirectoryIndex index.php # limit libapache2-mod-php to files and directories necessary by pma <IfModule mod_php7.c> php_admin_value upload_tmp_dir /var/lib/phpmyadmin/tmp php_admin_value open_basedir /usr/share/phpmyadmin/:/usr/share/doc/phpmyadmin/:/etc/phpmyadmin/:/var/lib/phpmyadmin/:/usr/share/php/:/usr/share/javascript/ </IfModule> </Directory> # Disallow web access to directories that don't need it <Directory /usr/share/phpmyadmin/templates> Require all denied </Directory> <Directory /usr/share/phpmyadmin/libraries> Require all denied </Directory> # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite phpmyadmin.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej1-phpmyadmin resolutions 192.168.121.96 basededatos.adrianjaramillo.org Muestro que accedo a phpmyadmin desde nombre y funciona:","title":"Paso 5"},{"location":"ej1-phpmyadmin/#paso-6","text":"Acceder a phpmyadmin con el usuario del punto 1 phpmyadmin_user A la derecha vemos que estamos conectados con el usuario requerido: Comprobar que podemos gestionar su base de datos Muestro que puedo crear una tabla : Muestro que puedo borrar una tabla :","title":"Paso 6"},{"location":"ej1-playbook-sencillo/","text":"Parte 1 Prepara una m\u00e1quina virtual en KVM que es la que vamos a configurar de forma autom\u00e1tica con ansible. Ya la tengo, hecha en Vagrant con libvirt. Parte 2 Crea un playbook que realice las siguientes tareas de forma autom\u00e1tica. Se usan m\u00f3dulos espec\u00edficos para cada una de ellas. Tarea 1 Crear un usuario \"adrianj\" en el servidor remoto - name: Creando usuario adrianj... user: name: adrianj password: '$6$Rjn7CUlYJXM8Fvrk$4r/qu2Q6Abiq4iGJjOW2RtclK14AyB9/3va/ZWu3oPIjIo10sNPgoyM6/sthvocwux.7hXFk/O8QpNNUW3Xsr1' # He usado mkpasswd --method=sha-512 # en plano: 1234 Tarea 2 Descarga el fichero https://wordpress.org/latest.zip - name: Descargando Wordpress... get_url: url: https://wordpress.org/latest.zip dest: /tmp Tarea 3 Descomprime ese fichero en el home del usuario \"adrianj\" - name: Descompresi\u00f3n block: - name: Instalando unzip... become_user: root apt: pkg: - unzip - name: Descomprimiendo Wordpress en el home de adrianj... unarchive: src: /tmp/wordpress-5.8.1.zip dest: /home/adrianj remote_src: yes Tarea 4 Instala mariadb - name: Instalando MariaDB... apt: pkg: - mariadb-server Tarea 5 Crea una base de datos que se llame adrian_wordpress - name: Instalar python3-pip + pymysql + crear BD block: - name: Instalando python3-pip... apt: pkg: - python3-pip - name: Instalando pymysql... pip: name: pymysql - name: Creando la base de datos adrian_wordpress... mysql_db: login_unix_socket: /var/run/mysqld/mysqld.sock name: adrian_wordpress state: present Tarea 6 Crea el usuario \"adrian_jaramillo\" con privilegios sobre la base de datos \"adrian_wordpress\" - name: Creando usuario con privilegios sobre adrian_wordpress... mysql_user: login_unix_socket: /var/run/mysqld/mysqld.sock name: adrian_jaramillo password: '1234' priv: 'adrian_wordpress.*:ALL' state: present Tarea 7 Clonar repositorio https://github.com/josedom24/ansible_ejemplos.git en el home del usuario \"adrianj\" - name: Git + directorio vac\u00edo + repo block: - name: Instalando git... apt: pkg: - git - name: Creando un directorio vac\u00edo para el repo... file: path: /home/adrianj/repo state: directory - name: Clonando repo al home de adrianj... git: repo: https://github.com/josedom24/ansible_ejemplos.git dest: /home/adrianj/repo Parte 3 Entrega la url del repositorio donde has guardado el playbook https://github.com/adriasir123/ej1-playbook-sencillo Muestra la ejecuci\u00f3n del playbook PLAY [nodo1] ******************************************************************************** TASK [Gathering Facts] ********************************************************************** ok: [nodo1] TASK [Creando usuario adrianj...] *********************************************************** ok: [nodo1] TASK [Descargando Wordpress...] ************************************************************* ok: [nodo1] TASK [Instalando unzip...] ****************************************************************** ok: [nodo1] TASK [Descomprimiendo Wordpress en el home de adrianj...] *********************************** ok: [nodo1] TASK [Instalando MariaDB...] **************************************************************** ok: [nodo1] TASK [Instalando python3-pip...] ************************************************************ ok: [nodo1] TASK [Instalando pymysql...] **************************************************************** ok: [nodo1] TASK [Creando la base de datos adrian_wordpress...] ***************************************** ok: [nodo1] TASK [Creando usuario con privilegios sobre adrian_wordpress...] **************************** ok: [nodo1] TASK [Instalando git...] ******************************************************************** ok: [nodo1] TASK [Creando un directorio vac\u00edo para el repo...] ****************************************** ok: [nodo1] TASK [Clonando repo al home de adrianj...] ************************************************** ok: [nodo1] PLAY RECAP ********************************************************************************** nodo1 : ok=13 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"Ejercicio 1: Playbook sencillo"},{"location":"ej1-playbook-sencillo/#parte-1","text":"Prepara una m\u00e1quina virtual en KVM que es la que vamos a configurar de forma autom\u00e1tica con ansible. Ya la tengo, hecha en Vagrant con libvirt.","title":"Parte 1"},{"location":"ej1-playbook-sencillo/#parte-2","text":"Crea un playbook que realice las siguientes tareas de forma autom\u00e1tica. Se usan m\u00f3dulos espec\u00edficos para cada una de ellas.","title":"Parte 2"},{"location":"ej1-playbook-sencillo/#tarea-1","text":"Crear un usuario \"adrianj\" en el servidor remoto - name: Creando usuario adrianj... user: name: adrianj password: '$6$Rjn7CUlYJXM8Fvrk$4r/qu2Q6Abiq4iGJjOW2RtclK14AyB9/3va/ZWu3oPIjIo10sNPgoyM6/sthvocwux.7hXFk/O8QpNNUW3Xsr1' # He usado mkpasswd --method=sha-512 # en plano: 1234","title":"Tarea 1"},{"location":"ej1-playbook-sencillo/#tarea-2","text":"Descarga el fichero https://wordpress.org/latest.zip - name: Descargando Wordpress... get_url: url: https://wordpress.org/latest.zip dest: /tmp","title":"Tarea 2"},{"location":"ej1-playbook-sencillo/#tarea-3","text":"Descomprime ese fichero en el home del usuario \"adrianj\" - name: Descompresi\u00f3n block: - name: Instalando unzip... become_user: root apt: pkg: - unzip - name: Descomprimiendo Wordpress en el home de adrianj... unarchive: src: /tmp/wordpress-5.8.1.zip dest: /home/adrianj remote_src: yes","title":"Tarea 3"},{"location":"ej1-playbook-sencillo/#tarea-4","text":"Instala mariadb - name: Instalando MariaDB... apt: pkg: - mariadb-server","title":"Tarea 4"},{"location":"ej1-playbook-sencillo/#tarea-5","text":"Crea una base de datos que se llame adrian_wordpress - name: Instalar python3-pip + pymysql + crear BD block: - name: Instalando python3-pip... apt: pkg: - python3-pip - name: Instalando pymysql... pip: name: pymysql - name: Creando la base de datos adrian_wordpress... mysql_db: login_unix_socket: /var/run/mysqld/mysqld.sock name: adrian_wordpress state: present","title":"Tarea 5"},{"location":"ej1-playbook-sencillo/#tarea-6","text":"Crea el usuario \"adrian_jaramillo\" con privilegios sobre la base de datos \"adrian_wordpress\" - name: Creando usuario con privilegios sobre adrian_wordpress... mysql_user: login_unix_socket: /var/run/mysqld/mysqld.sock name: adrian_jaramillo password: '1234' priv: 'adrian_wordpress.*:ALL' state: present","title":"Tarea 6"},{"location":"ej1-playbook-sencillo/#tarea-7","text":"Clonar repositorio https://github.com/josedom24/ansible_ejemplos.git en el home del usuario \"adrianj\" - name: Git + directorio vac\u00edo + repo block: - name: Instalando git... apt: pkg: - git - name: Creando un directorio vac\u00edo para el repo... file: path: /home/adrianj/repo state: directory - name: Clonando repo al home de adrianj... git: repo: https://github.com/josedom24/ansible_ejemplos.git dest: /home/adrianj/repo","title":"Tarea 7"},{"location":"ej1-playbook-sencillo/#parte-3","text":"Entrega la url del repositorio donde has guardado el playbook https://github.com/adriasir123/ej1-playbook-sencillo Muestra la ejecuci\u00f3n del playbook PLAY [nodo1] ******************************************************************************** TASK [Gathering Facts] ********************************************************************** ok: [nodo1] TASK [Creando usuario adrianj...] *********************************************************** ok: [nodo1] TASK [Descargando Wordpress...] ************************************************************* ok: [nodo1] TASK [Instalando unzip...] ****************************************************************** ok: [nodo1] TASK [Descomprimiendo Wordpress en el home de adrianj...] *********************************** ok: [nodo1] TASK [Instalando MariaDB...] **************************************************************** ok: [nodo1] TASK [Instalando python3-pip...] ************************************************************ ok: [nodo1] TASK [Instalando pymysql...] **************************************************************** ok: [nodo1] TASK [Creando la base de datos adrian_wordpress...] ***************************************** ok: [nodo1] TASK [Creando usuario con privilegios sobre adrian_wordpress...] **************************** ok: [nodo1] TASK [Instalando git...] ******************************************************************** ok: [nodo1] TASK [Creando un directorio vac\u00edo para el repo...] ****************************************** ok: [nodo1] TASK [Clonando repo al home de adrianj...] ************************************************** ok: [nodo1] PLAY RECAP ********************************************************************************** nodo1 : ok=13 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"Parte 3"},{"location":"ej2-apache2-gunicorn/","text":"Ejercicio 2: Desplegando aplicaciones flask con Apache + gunicorn En esta tarea se usa la aplicaci\u00f3n Guestbook . Crear venv mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source bin/activate Descargar Guestbook sudo apt install git git clone https://github.com/josedom24/guestbook.git pip install -r requirements.txt sudo apt install redis Fichero wsgi /home/vagrant/guestbook/app/wsgi.py from app import prog as application Instalar Gunicorn pip install gunicorn Probar funcionamiento gunicorn -w 2 -b :8080 wsgi Crear unidad systemd /etc/systemd/system/gunicorn-guestbook.service : [Unit] Description=gunicorn-guestbook After=network.target [Install] WantedBy=multi-user.target [Service] User=www-data Group=www-data Restart=always ExecStart=/home/vagrant/venv/bin/gunicorn -w 2 -b :8080 wsgi ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/home/vagrant/guestbook/app Environment=PYTHONPATH='/home/vagrant/guestbook/app:/home/vagrant/venv/lib/python3.9/site-packages' PrivateTmp=true La activo e inicio: sudo systemctl enable gunicorn-guestbook.service sudo systemctl start gunicorn-guestbook.service Pruebo que funciona: Apache + Gunicorn sudo apt install apache2 sudo a2enmod proxy_http Creo /etc/apache2/sites-available/guestbook.conf : <VirtualHost *:80> ServerName www.guestbook-gunicorn.com DocumentRoot /home/vagrant/guestbook/app <Directory /home/vagrant/guestbook/app> Require all granted </Directory> ProxyPass / http://127.0.0.1:8080/ ProxyPassReverse / http://127.0.0.1:8080/ </VirtualHost> Lo habilito: sudo a2ensite guestbook.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej2-guestbook-gunicorn resolutions 192.168.121.2 www.guestbook-gunicorn.com Pruebo que funciona: Nginx + Gunicorn sudo apt install nginx Creo /etc/nginx/sites-available/guestbook.conf : server { listen 80; server_name www.guestbook-gunicorn.com; root /home/vagrant/guestbook/app; location / { proxy_pass http://localhost:8080; include proxy_params; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/guestbook.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona:","title":"Ejercicio 2: Apache/Nginx + Gunicorn"},{"location":"ej2-apache2-gunicorn/#ejercicio-2-desplegando-aplicaciones-flask-con-apache-gunicorn","text":"En esta tarea se usa la aplicaci\u00f3n Guestbook .","title":"Ejercicio 2: Desplegando aplicaciones flask con Apache + gunicorn"},{"location":"ej2-apache2-gunicorn/#crear-venv","text":"mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source bin/activate","title":"Crear venv"},{"location":"ej2-apache2-gunicorn/#descargar-guestbook","text":"sudo apt install git git clone https://github.com/josedom24/guestbook.git pip install -r requirements.txt sudo apt install redis","title":"Descargar Guestbook"},{"location":"ej2-apache2-gunicorn/#fichero-wsgi","text":"/home/vagrant/guestbook/app/wsgi.py from app import prog as application","title":"Fichero wsgi"},{"location":"ej2-apache2-gunicorn/#instalar-gunicorn","text":"pip install gunicorn","title":"Instalar Gunicorn"},{"location":"ej2-apache2-gunicorn/#probar-funcionamiento","text":"gunicorn -w 2 -b :8080 wsgi","title":"Probar funcionamiento"},{"location":"ej2-apache2-gunicorn/#crear-unidad-systemd","text":"/etc/systemd/system/gunicorn-guestbook.service : [Unit] Description=gunicorn-guestbook After=network.target [Install] WantedBy=multi-user.target [Service] User=www-data Group=www-data Restart=always ExecStart=/home/vagrant/venv/bin/gunicorn -w 2 -b :8080 wsgi ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/home/vagrant/guestbook/app Environment=PYTHONPATH='/home/vagrant/guestbook/app:/home/vagrant/venv/lib/python3.9/site-packages' PrivateTmp=true La activo e inicio: sudo systemctl enable gunicorn-guestbook.service sudo systemctl start gunicorn-guestbook.service Pruebo que funciona:","title":"Crear unidad systemd"},{"location":"ej2-apache2-gunicorn/#apache-gunicorn","text":"sudo apt install apache2 sudo a2enmod proxy_http Creo /etc/apache2/sites-available/guestbook.conf : <VirtualHost *:80> ServerName www.guestbook-gunicorn.com DocumentRoot /home/vagrant/guestbook/app <Directory /home/vagrant/guestbook/app> Require all granted </Directory> ProxyPass / http://127.0.0.1:8080/ ProxyPassReverse / http://127.0.0.1:8080/ </VirtualHost> Lo habilito: sudo a2ensite guestbook.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej2-guestbook-gunicorn resolutions 192.168.121.2 www.guestbook-gunicorn.com Pruebo que funciona:","title":"Apache + Gunicorn"},{"location":"ej2-apache2-gunicorn/#nginx-gunicorn","text":"sudo apt install nginx Creo /etc/nginx/sites-available/guestbook.conf : server { listen 80; server_name www.guestbook-gunicorn.com; root /home/vagrant/guestbook/app; location / { proxy_pass http://localhost:8080; include proxy_params; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/guestbook.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona:","title":"Nginx + Gunicorn"},{"location":"ej2-bookmedik/","text":"Ejercicio 2: Instalaci\u00f3n de BookMedik ENTREGA Parte 1 Captura del VirtualHost Parte 2 Contenido del fichero core/controller/Database.php <?php class Database { public static $db; public static $con; function Database(){ $this->user=\"bookmedik_user\";$this->pass=\"1234\";$this->host=\"localhost\";$this->ddbb=\"bookmedik\"; } function connect(){ $con = new mysqli($this->host,$this->user,$this->pass,$this->ddbb); $con->query(\"set sql_mode=''\"); return $con; } public static function getCon(){ if(self::$con==null && self::$db==null){ self::$db = new Database(); self::$con = self::$db->connect(); } return self::$con; } } ?> Parte 3 Captura de bookmedik, despu\u00e9s de login Parte 4 Indicar ruta completa al fichero donde se modifica memory_limit /etc/php/7.4/apache2/php.ini Captura de info.php donde se vea el cambio REALIZACI\u00d3N Paso 0 Instalar mariadb-server sudo apt update sudo apt install mariadb-server Paso 1 Descargar schema.sql (copia de seguridad de la BD) del repositorio https://github.com/evilnapsis/bookmedik En el repositorio, abrir la versi\u00f3n \"raw\" de schema.sql . Despu\u00e9s, descargar este fichero usando la URL en modo raw: wget https://raw.githubusercontent.com/evilnapsis/bookmedik/master/schema.sql Importar la copia de seguridad schema.sql sudo mysql -u root < schema.sql Vemos que se ha creado la base de datos bookmedik : MariaDB [(none)]> show databases; +--------------------+ | Database | +--------------------+ | bookmedik | | information_schema | | mysql | | performance_schema | +--------------------+ Crear usuario con privilegios sobre bookmedik CREATE USER 'bookmedik_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'bookmedik_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `bookmedik`.* TO 'bookmedik_user'@localhost; FLUSH PRIVILEGES; Paso 2 Instalar apache2 y php sudo apt install apache2 sudo apt install php php-mysql Crear VirtualHost con ServerName bookmedik.adrianjaramillo.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName bookmedik.adrianjaramillo.org DocumentRoot /var/www/bookmedik # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite bookmedik.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej2-bookmedik resolutions 192.168.121.67 bookmedik.adrianjaramillo.org Clonar https://github.com/evilnapsis/bookmedik en el DocumentRoot /var/www/bookmedik git clone https://github.com/evilnapsis/bookmedik . Este clonado no nos crea un directorio donde mete el repositorio, sino que directamente clona los contenidos al directorio actual. La \u00fanica condici\u00f3n para que este clonado funcione, es que el directorio destino est\u00e9 vac\u00edo. Paso 3 Modifica core/controller/Database.php con los datos de acceso a la BD creada en el paso 1 Este es el fragmento modificado: function Database(){ $this->user=\"bookmedik_user\";$this->pass=\"1234\";$this->host=\"localhost\";$this->ddbb=\"bookmedik\"; } Paso 4 Acceder a bookmedik.adrianjaramillo.org con usuario admin y contrase\u00f1a admin Paso 5 Cambia el memory_limit a 256M en php.ini Antes de nada, tenemos que averiguar d\u00f3nde se encuentra nuestro fichero php.ini . \u00a1OJO! Hay 2 ficheros php.ini , as\u00ed que tenemos que encontrar el usado por apache, EL DE CLI NO . Me descargo un fichero info.php de prueba en /var/www/bookmedik para encontrar la ruta al php.ini que se est\u00e1 usando: sudo wget https://gist.githubusercontent.com/SyntaxC4/5648247/raw/94277156638f9c309f2e36e19bff378ba7364907/info.php Aqu\u00ed muestro la ruta: En /etc/php/7.4/apache2/php.ini modificamos tal que as\u00ed: ; Maximum amount of memory a script may consume ; http://php.net/memory-limit memory_limit = 256M Reiniciamos apache sudo systemctl restart apache2 Muestro que el valor memory_limit es ahora el correcto:","title":"Ejercicio 2: BookMedik"},{"location":"ej2-bookmedik/#ejercicio-2-instalacion-de-bookmedik","text":"","title":"Ejercicio 2: Instalaci\u00f3n de BookMedik"},{"location":"ej2-bookmedik/#entrega","text":"","title":"ENTREGA"},{"location":"ej2-bookmedik/#parte-1","text":"Captura del VirtualHost","title":"Parte 1"},{"location":"ej2-bookmedik/#parte-2","text":"Contenido del fichero core/controller/Database.php <?php class Database { public static $db; public static $con; function Database(){ $this->user=\"bookmedik_user\";$this->pass=\"1234\";$this->host=\"localhost\";$this->ddbb=\"bookmedik\"; } function connect(){ $con = new mysqli($this->host,$this->user,$this->pass,$this->ddbb); $con->query(\"set sql_mode=''\"); return $con; } public static function getCon(){ if(self::$con==null && self::$db==null){ self::$db = new Database(); self::$con = self::$db->connect(); } return self::$con; } } ?>","title":"Parte 2"},{"location":"ej2-bookmedik/#parte-3","text":"Captura de bookmedik, despu\u00e9s de login","title":"Parte 3"},{"location":"ej2-bookmedik/#parte-4","text":"Indicar ruta completa al fichero donde se modifica memory_limit /etc/php/7.4/apache2/php.ini Captura de info.php donde se vea el cambio","title":"Parte 4"},{"location":"ej2-bookmedik/#realizacion","text":"","title":"REALIZACI\u00d3N"},{"location":"ej2-bookmedik/#paso-0","text":"Instalar mariadb-server sudo apt update sudo apt install mariadb-server","title":"Paso 0"},{"location":"ej2-bookmedik/#paso-1","text":"Descargar schema.sql (copia de seguridad de la BD) del repositorio https://github.com/evilnapsis/bookmedik En el repositorio, abrir la versi\u00f3n \"raw\" de schema.sql . Despu\u00e9s, descargar este fichero usando la URL en modo raw: wget https://raw.githubusercontent.com/evilnapsis/bookmedik/master/schema.sql Importar la copia de seguridad schema.sql sudo mysql -u root < schema.sql Vemos que se ha creado la base de datos bookmedik : MariaDB [(none)]> show databases; +--------------------+ | Database | +--------------------+ | bookmedik | | information_schema | | mysql | | performance_schema | +--------------------+ Crear usuario con privilegios sobre bookmedik CREATE USER 'bookmedik_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'bookmedik_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `bookmedik`.* TO 'bookmedik_user'@localhost; FLUSH PRIVILEGES;","title":"Paso 1"},{"location":"ej2-bookmedik/#paso-2","text":"Instalar apache2 y php sudo apt install apache2 sudo apt install php php-mysql Crear VirtualHost con ServerName bookmedik.adrianjaramillo.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName bookmedik.adrianjaramillo.org DocumentRoot /var/www/bookmedik # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite bookmedik.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej2-bookmedik resolutions 192.168.121.67 bookmedik.adrianjaramillo.org Clonar https://github.com/evilnapsis/bookmedik en el DocumentRoot /var/www/bookmedik git clone https://github.com/evilnapsis/bookmedik . Este clonado no nos crea un directorio donde mete el repositorio, sino que directamente clona los contenidos al directorio actual. La \u00fanica condici\u00f3n para que este clonado funcione, es que el directorio destino est\u00e9 vac\u00edo.","title":"Paso 2"},{"location":"ej2-bookmedik/#paso-3","text":"Modifica core/controller/Database.php con los datos de acceso a la BD creada en el paso 1 Este es el fragmento modificado: function Database(){ $this->user=\"bookmedik_user\";$this->pass=\"1234\";$this->host=\"localhost\";$this->ddbb=\"bookmedik\"; }","title":"Paso 3"},{"location":"ej2-bookmedik/#paso-4","text":"Acceder a bookmedik.adrianjaramillo.org con usuario admin y contrase\u00f1a admin","title":"Paso 4"},{"location":"ej2-bookmedik/#paso-5","text":"Cambia el memory_limit a 256M en php.ini Antes de nada, tenemos que averiguar d\u00f3nde se encuentra nuestro fichero php.ini . \u00a1OJO! Hay 2 ficheros php.ini , as\u00ed que tenemos que encontrar el usado por apache, EL DE CLI NO . Me descargo un fichero info.php de prueba en /var/www/bookmedik para encontrar la ruta al php.ini que se est\u00e1 usando: sudo wget https://gist.githubusercontent.com/SyntaxC4/5648247/raw/94277156638f9c309f2e36e19bff378ba7364907/info.php Aqu\u00ed muestro la ruta: En /etc/php/7.4/apache2/php.ini modificamos tal que as\u00ed: ; Maximum amount of memory a script may consume ; http://php.net/memory-limit memory_limit = 256M Reiniciamos apache sudo systemctl restart apache2 Muestro que el valor memory_limit es ahora el correcto:","title":"Paso 5"},{"location":"ej2-control-acceso-autenticacion-autorizacion/","text":"Ejercicio 2: Control de acceso, autenticaci\u00f3n y autorizaci\u00f3n ENTREGA Parte 1 Captura accediendo a departamentos.iesgn.org/intranet desde nuestro host Captura accediendo a departamentos.iesgn.org/intranet desde cliente Parte 2 Captura accediendo a departamentos.iesgn.org/internet desde nuestro host Captura accediendo a departamentos.iesgn.org/internet desde cliente Parte 3 Mostrar que la autenticaci\u00f3n b\u00e1sica funciona Parte 4 Captura con las cabeceras HTTP donde se vea la autenticaci\u00f3n b\u00e1sica Se manda una cabecera Authorization en la petici\u00f3n, con el mensaje dmlwOnZpcA== en texto plano. Con cualquier decodificador online de Base64 podemos averiguar lo que significa: Pues bien, ah\u00ed tenemos el usuario y la contrase\u00f1a que he introducido durante la autenticaci\u00f3n b\u00e1sica. Parte 5 Mostrar que la autenticaci\u00f3n digest funciona Pruebo el acceso con nodirectivo1 : Pruebo el acceso con directivo1 : Parte 6 Captura con las cabeceras HTTP donde se vea la autenticaci\u00f3n digest Parte 7 Mostrar el funcionamiento del ejercicio 4 Prueba de acceso desde cliente: Prueba de acceso desde mi m\u00e1quina: Entregar la configuraci\u00f3n realizada Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> <RequireAny> <RequireAll> Require ip 10.0.0 </RequireAll> <RequireAll> Require ip 192.168.121 AuthType Digest AuthName \"directivos\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </RequireAll> </RequireAny> </Directory> Reinicio Apache: sudo systemctl restart apache2.service Preliminares Control de acceso \u00bfControl de acceso por defecto de 000-default? En 000-default.conf no hay control de acceso definido, pero como el DocumentRoot est\u00e1 en /var/www/html , le afecta la siguiente directiva de apache2.conf : <Directory /var/www/> Options Indexes FollowSymLinks AllowOverride None Require all granted </Directory> EJERCICIOS Ejercicio 0 Definir escenario Vagrant: Servidor: Interfaz eth0 (NAT) actuando como p\u00fablica Interfaz privada (veryisolated) Cliente conectado a la red privada Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :ej2controlacceso do |ej2controlacceso| ej2controlacceso.vm.box = \"debian/bullseye64\" ej2controlacceso.vm.hostname = \"ej2controlacceso\" ej2controlacceso.vm.network :private_network, :libvirt__network_name => \"ej2controlaccesonet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej2controlaccesonet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end end Crear VirtualHost departamentos.iesgn.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName departamentos.iesgn.org DocumentRoot /var/www/departamentos # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Ejercicio 1 A departamentos.iesgn.org/intranet : Se permite acceso desde cliente Se deniega acceso desde nuestra m\u00e1quina Modificar /etc/apache2/sites-available/departamentos.conf : <Directory /var/www/departamentos/intranet> Require ip 10.0.0 </Directory> Reiniciar Apache: sudo systemctl restart apache2.service Prueba de acceso desde mi m\u00e1quina: Prueba de acceso desde cliente: He usado \"lynx\". A departamentos.iesgn.org/internet : Se permite acceso desde nuestra m\u00e1quina Se deniega acceso desde cliente Modificar /etc/apache2/sites-available/departamentos.conf : <Directory /var/www/departamentos/internet> Require ip 192.168.121 </Directory> Reiniciar Apache: sudo systemctl restart apache2.service Prueba de acceso desde mi m\u00e1quina: Prueba de acceso desde cliente: Ejercicio 2 Autenticaci\u00f3n b\u00e1sica en departamentos.iesgn.org/secreto Creo el fichero htpasswd : sudo htpasswd -c /etc/apache2/.htpasswd vip He a\u00f1adido un usuario \"vip\" con contrase\u00f1a \"vip\". Comprobamos que se ha creado htpasswd y sus contenidos: vagrant@ej2controlacceso:/etc/apache2$ cat .htpasswd vip:$apr1$p6ga61LF$dl2YMKRkVM7GW8AuRUsIN/ Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> AuthType Basic AuthName \"Acceso para VIPs\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </Directory> Reinicio Apache: sudo systemctl restart apache2.service Pruebo que funciona: Comprobar las cabeceras HTTP durante la autenticaci\u00f3n b\u00e1sica \u00bfC\u00f3mo se manda la contrase\u00f1a entre el cliente y el servidor? Se manda una cabecera Authorization en la petici\u00f3n, con el mensaje dmlwOnZpcA== en texto plano. Con cualquier decodificador online de Base64 podemos averiguar lo que significa: Pues bien, ah\u00ed tenemos el usuario y la contrase\u00f1a que he introducido durante la autenticaci\u00f3n b\u00e1sica. Ejercicio 3 Modificar la autenticaci\u00f3n a tipo digest, y hacer que departamentos.iesgn.org/secreto s\u00f3lo sea accesible por usuarios del grupo directivos Sobreescribo el antiguo fichero htpasswd a\u00f1adiendo un usuario directivo: sudo htdigest -c /etc/apache2/.htpasswd directivos directivo1 A\u00f1ado tambi\u00e9n un usuario no directivo: sudo htdigest /etc/apache2/.htpasswd nodirectivos nodirectivo1 Ambos usuarios tienen como contrase\u00f1a \"1234\". Ahora el fichero .htpasswd luce de la siguiente manera: directivo1:directivos:4fdd1584741ce8cc0d722a82af5d2a1f nodirectivo1:nodirectivos:305a303414ab365e1637a8f26f2c30cc Habilito el m\u00f3dulo necesario: sudo a2enmod auth_digest Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> AuthType Digest AuthName \"directivos\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </Directory> Reinicio Apache: sudo systemctl restart apache2.service Pruebo el acceso con nodirectivo1 : Pruebo el acceso con directivo1 : Comprobar las cabeceras HTTP durante la autenticaci\u00f3n digest \u00bfC\u00f3mo funciona esta autenticaci\u00f3n? Ahora en la cabecera Authorization de la petici\u00f3n, se manda un campo response que contiene las credenciales enviadas encriptadas. No hay manera de sacar la contrase\u00f1a en texto plano a partir de ese mensaje encriptado, ya que el sistema se hizo as\u00ed intencionamente para que no fuese posible. Ejercicio 4 Para acceder a departamentos.iesgn.org/secreto : No pide autenticaci\u00f3n desde la intranet Pide autenticaci\u00f3n desde nuestro host Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> <RequireAny> <RequireAll> Require ip 10.0.0 </RequireAll> <RequireAll> Require ip 192.168.121 AuthType Digest AuthName \"directivos\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </RequireAll> </RequireAny> </Directory> Reinicio Apache: sudo systemctl restart apache2.service Prueba de acceso desde cliente: Prueba de acceso desde mi m\u00e1quina:","title":"Ejercicio 2: Control de acceso"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicio-2-control-de-acceso-autenticacion-y-autorizacion","text":"","title":"Ejercicio 2: Control de acceso, autenticaci\u00f3n y autorizaci\u00f3n"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#entrega","text":"","title":"ENTREGA"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-1","text":"Captura accediendo a departamentos.iesgn.org/intranet desde nuestro host Captura accediendo a departamentos.iesgn.org/intranet desde cliente","title":"Parte 1"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-2","text":"Captura accediendo a departamentos.iesgn.org/internet desde nuestro host Captura accediendo a departamentos.iesgn.org/internet desde cliente","title":"Parte 2"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-3","text":"Mostrar que la autenticaci\u00f3n b\u00e1sica funciona","title":"Parte 3"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-4","text":"Captura con las cabeceras HTTP donde se vea la autenticaci\u00f3n b\u00e1sica Se manda una cabecera Authorization en la petici\u00f3n, con el mensaje dmlwOnZpcA== en texto plano. Con cualquier decodificador online de Base64 podemos averiguar lo que significa: Pues bien, ah\u00ed tenemos el usuario y la contrase\u00f1a que he introducido durante la autenticaci\u00f3n b\u00e1sica.","title":"Parte 4"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-5","text":"Mostrar que la autenticaci\u00f3n digest funciona Pruebo el acceso con nodirectivo1 : Pruebo el acceso con directivo1 :","title":"Parte 5"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-6","text":"Captura con las cabeceras HTTP donde se vea la autenticaci\u00f3n digest","title":"Parte 6"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#parte-7","text":"Mostrar el funcionamiento del ejercicio 4 Prueba de acceso desde cliente: Prueba de acceso desde mi m\u00e1quina: Entregar la configuraci\u00f3n realizada Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> <RequireAny> <RequireAll> Require ip 10.0.0 </RequireAll> <RequireAll> Require ip 192.168.121 AuthType Digest AuthName \"directivos\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </RequireAll> </RequireAny> </Directory> Reinicio Apache: sudo systemctl restart apache2.service","title":"Parte 7"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#preliminares","text":"","title":"Preliminares"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#control-de-acceso","text":"\u00bfControl de acceso por defecto de 000-default? En 000-default.conf no hay control de acceso definido, pero como el DocumentRoot est\u00e1 en /var/www/html , le afecta la siguiente directiva de apache2.conf : <Directory /var/www/> Options Indexes FollowSymLinks AllowOverride None Require all granted </Directory>","title":"Control de acceso"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicios","text":"","title":"EJERCICIOS"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicio-0","text":"Definir escenario Vagrant: Servidor: Interfaz eth0 (NAT) actuando como p\u00fablica Interfaz privada (veryisolated) Cliente conectado a la red privada Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :ej2controlacceso do |ej2controlacceso| ej2controlacceso.vm.box = \"debian/bullseye64\" ej2controlacceso.vm.hostname = \"ej2controlacceso\" ej2controlacceso.vm.network :private_network, :libvirt__network_name => \"ej2controlaccesonet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej2controlaccesonet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end end Crear VirtualHost departamentos.iesgn.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName departamentos.iesgn.org DocumentRoot /var/www/departamentos # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet","title":"Ejercicio 0"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicio-1","text":"A departamentos.iesgn.org/intranet : Se permite acceso desde cliente Se deniega acceso desde nuestra m\u00e1quina Modificar /etc/apache2/sites-available/departamentos.conf : <Directory /var/www/departamentos/intranet> Require ip 10.0.0 </Directory> Reiniciar Apache: sudo systemctl restart apache2.service Prueba de acceso desde mi m\u00e1quina: Prueba de acceso desde cliente: He usado \"lynx\". A departamentos.iesgn.org/internet : Se permite acceso desde nuestra m\u00e1quina Se deniega acceso desde cliente Modificar /etc/apache2/sites-available/departamentos.conf : <Directory /var/www/departamentos/internet> Require ip 192.168.121 </Directory> Reiniciar Apache: sudo systemctl restart apache2.service Prueba de acceso desde mi m\u00e1quina: Prueba de acceso desde cliente:","title":"Ejercicio 1"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicio-2","text":"Autenticaci\u00f3n b\u00e1sica en departamentos.iesgn.org/secreto Creo el fichero htpasswd : sudo htpasswd -c /etc/apache2/.htpasswd vip He a\u00f1adido un usuario \"vip\" con contrase\u00f1a \"vip\". Comprobamos que se ha creado htpasswd y sus contenidos: vagrant@ej2controlacceso:/etc/apache2$ cat .htpasswd vip:$apr1$p6ga61LF$dl2YMKRkVM7GW8AuRUsIN/ Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> AuthType Basic AuthName \"Acceso para VIPs\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </Directory> Reinicio Apache: sudo systemctl restart apache2.service Pruebo que funciona: Comprobar las cabeceras HTTP durante la autenticaci\u00f3n b\u00e1sica \u00bfC\u00f3mo se manda la contrase\u00f1a entre el cliente y el servidor? Se manda una cabecera Authorization en la petici\u00f3n, con el mensaje dmlwOnZpcA== en texto plano. Con cualquier decodificador online de Base64 podemos averiguar lo que significa: Pues bien, ah\u00ed tenemos el usuario y la contrase\u00f1a que he introducido durante la autenticaci\u00f3n b\u00e1sica.","title":"Ejercicio 2"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicio-3","text":"Modificar la autenticaci\u00f3n a tipo digest, y hacer que departamentos.iesgn.org/secreto s\u00f3lo sea accesible por usuarios del grupo directivos Sobreescribo el antiguo fichero htpasswd a\u00f1adiendo un usuario directivo: sudo htdigest -c /etc/apache2/.htpasswd directivos directivo1 A\u00f1ado tambi\u00e9n un usuario no directivo: sudo htdigest /etc/apache2/.htpasswd nodirectivos nodirectivo1 Ambos usuarios tienen como contrase\u00f1a \"1234\". Ahora el fichero .htpasswd luce de la siguiente manera: directivo1:directivos:4fdd1584741ce8cc0d722a82af5d2a1f nodirectivo1:nodirectivos:305a303414ab365e1637a8f26f2c30cc Habilito el m\u00f3dulo necesario: sudo a2enmod auth_digest Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> AuthType Digest AuthName \"directivos\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </Directory> Reinicio Apache: sudo systemctl restart apache2.service Pruebo el acceso con nodirectivo1 : Pruebo el acceso con directivo1 : Comprobar las cabeceras HTTP durante la autenticaci\u00f3n digest \u00bfC\u00f3mo funciona esta autenticaci\u00f3n? Ahora en la cabecera Authorization de la petici\u00f3n, se manda un campo response que contiene las credenciales enviadas encriptadas. No hay manera de sacar la contrase\u00f1a en texto plano a partir de ese mensaje encriptado, ya que el sistema se hizo as\u00ed intencionamente para que no fuese posible.","title":"Ejercicio 3"},{"location":"ej2-control-acceso-autenticacion-autorizacion/#ejercicio-4","text":"Para acceder a departamentos.iesgn.org/secreto : No pide autenticaci\u00f3n desde la intranet Pide autenticaci\u00f3n desde nuestro host Modifico /etc/apache2/sites-available/departamentos.conf : <Directory \"/var/www/departamentos/secreto\"> <RequireAny> <RequireAll> Require ip 10.0.0 </RequireAll> <RequireAll> Require ip 192.168.121 AuthType Digest AuthName \"directivos\" AuthUserFile /etc/apache2/.htpasswd Require valid-user </RequireAll> </RequireAny> </Directory> Reinicio Apache: sudo systemctl restart apache2.service Prueba de acceso desde cliente: Prueba de acceso desde mi m\u00e1quina:","title":"Ejercicio 4"},{"location":"ej2-instalar-configurar-slave/","text":"Ejercicio 2: Instalaci\u00f3n y configuraci\u00f3n de un servidor DNS esclavo Entrega Parte 1 Mostrar la definici\u00f3n de zonas en maestro /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; Mostrar la zona directa en maestro /etc/bind/db.iesgn.org : $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 jaramillor IN A 10.0.0.10 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj Mostrar la zona inversa en maestro /etc/bind/db.10.0.0 : $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. 2 IN PTR adrianj.iesgn.org. 10 IN PTR jaramillor.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org. Mostrar la definici\u00f3n de zonas en esclavo /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type slave; file \"/var/cache/bind/db.iesgn.org\"; masters { 10.0.0.2; }; }; zone \"0.0.10.in-addr.arpa\" { type slave; file \"/var/cache/bind/db.10.0.0\"; masters { 10.0.0.2; }; }; Parte 2 Mostrar si los ficheros de zona del maestro tienen errores Verifico la zona directa: sudo named-checkzone iesgn.org db.iesgn.org zone iesgn.org/IN: loaded serial 2001062501 OK Verifico la zona inversa: sudo named-checkzone 0.0.10.in-addr.arpa db.10.0.0 zone 0.0.10.in-addr.arpa/IN: loaded serial 2001062501 OK Parte 3 Comprobar si named.conf tiene errores tanto en maestro como en esclavo En maestro: sudo named-checkconf named.conf En esclavo: sudo named-checkconf named.conf No me devuelve output en ambos casos, significa que no hay errores. Parte 4 Mostrar en /var/log/syslog la transferencia de zonas Comando: sudo cat /var/log/syslog | grep named | grep transfer Transferencia de zona directa: Nov 18 00:43:58 bullseye named[2538]: transfer of 'iesgn.org/IN' from 10.0.0.2#53: connected using 10.0.0.10#58761 Nov 18 00:43:58 bullseye named[2538]: zone iesgn.org/IN: transferred serial 2001062504 Nov 18 00:43:58 bullseye named[2538]: transfer of 'iesgn.org/IN' from 10.0.0.2#53: Transfer status: success Nov 18 00:43:58 bullseye named[2538]: transfer of 'iesgn.org/IN' from 10.0.0.2#53: Transfer completed: 1 messages, 14 records, 364 bytes, 0.004 secs (91000 bytes/sec) (serial 2001062504) Transferencia de zona inversa: Nov 18 00:53:00 bullseye named[2538]: transfer of '0.0.10.in-addr.arpa/IN' from 10.0.0.2#53: connected using 10.0.0.10#58699 Nov 18 00:53:00 bullseye named[2538]: zone 0.0.10.in-addr.arpa/IN: transferred serial 2001062502 Nov 18 00:53:00 bullseye named[2538]: transfer of '0.0.10.in-addr.arpa/IN' from 10.0.0.2#53: Transfer status: success Nov 18 00:53:00 bullseye named[2538]: transfer of '0.0.10.in-addr.arpa/IN' from 10.0.0.2#53: Transfer completed: 1 messages, 11 records, 326 bytes, 0.004 secs (81500 bytes/sec) (serial 2001062502) Parte 5 Entregar la configuraci\u00f3n DNS de cliente /etc/resolv.conf : nameserver 10.0.0.2 nameserver 10.0.0.10 Parte 6 Realizar una consulta dig a maestro y esclavo para comprobar que las respuestas son con autoridad Al maestro: Al esclavo: Buscamos esa flag \"aa\", que quiere decir \"Authoritative Answer\". Nos devolver\u00e1 esa flag siempre que hagamos consultas sobre zonas en las que los servidores tengan autoridad. La RFC 1035 dice lo siguiente: Si por ejemplo hiciese una consulta en una zona sobre la que mi servidor NO TIENE autoridad, pasar\u00eda lo siguiente: No aparece la flag \"aa\". Parte 7 Solicitar copia completa de una zona desde cliente \u00bfqu\u00e9 tiene que ocurrir? dig @10.0.0.2 iesgn.org axfr ; <<>> DiG 9.16.22-Debian <<>> @10.0.0.2 iesgn.org axfr ; (1 server found) ;; global options: +cmd ; Transfer failed. No permite la transferencia. Solicitar copia completa de una zona desde esclavo \u00bfqu\u00e9 tiene que ocurrir? dig @10.0.0.2 iesgn.org axfr ; <<>> DiG 9.16.22-Debian <<>> @10.0.0.2 iesgn.org axfr ; (1 server found) ;; global options: +cmd iesgn.org. 86400 IN SOA adrianj.iesgn.org. admin.iesgn.org. 2001062503 21600 3600 604800 86400 iesgn.org. 86400 IN NS adrianj.iesgn.org. iesgn.org. 86400 IN NS jaramillor.iesgn.org. iesgn.org. 86400 IN MX 10 correo.iesgn.org. adrianj.iesgn.org. 86400 IN A 10.0.0.2 cliente1.iesgn.org. 86400 IN A 10.0.0.3 cliente2.iesgn.org. 86400 IN A 10.0.0.4 cliente3.iesgn.org. 86400 IN A 10.0.0.5 correo.iesgn.org. 86400 IN A 10.0.0.200 departamentos.iesgn.org. 86400 IN CNAME adrianj.iesgn.org. ftp.iesgn.org. 86400 IN A 10.0.0.201 jaramillor.iesgn.org. 86400 IN A 10.0.0.10 www.iesgn.org. 86400 IN CNAME adrianj.iesgn.org. iesgn.org. 86400 IN SOA adrianj.iesgn.org. admin.iesgn.org. 2001062503 21600 3600 604800 86400 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Wed Nov 17 23:50:34 UTC 2021 ;; XFR size: 14 records (messages 1, bytes 403) Permite la transferencia. Parte 8 Realizar consulta desde cliente y comprobar qu\u00e9 servidor responde Seg\u00fan nuestro orden en resolv.conf , siempre nos responder\u00e1 el maestro, salvo que \u00e9ste falle. Parte 9 Apagar maestro y hacer consulta desde cliente \u00bfqui\u00e9n responde? Responde el esclavo. Realizaci\u00f3n Ejercicio 1 Instalar un servidor DNS como esclavo del DNS configurado en el ejercicio 1. Parte 1 A\u00f1adir otra m\u00e1quina al escenario del ej1, para instalar el esclavo ah\u00ed Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :server do |server| server.vm.box = \"debian/bullseye64\" server.vm.hostname = \"server\" server.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :slavedns do |slavedns| slavedns.vm.box = \"debian/bullseye64\" slavedns.vm.hostname = \"slavedns\" slavedns.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.10\", :libvirt__forward_mode => \"veryisolated\" end end Parte 2 Cambiar el hostname de slavedns a: jaramillor.iesgn.org Modifico /etc/hostname : vagrant@slavedns:~$ cat /etc/hostname jaramillor Hago que el cambio de hostname tome efecto ahora: sudo hostname jaramillor Verifico: vagrant@slavedns:~$ hostname jaramillor Actualizo el prompt: vagrant@slavedns:~$ bash vagrant@jaramillor:~$ Modifico /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 jaramillor.iesgn.org jaramillor Compruebo nombre largo: vagrant@jaramillor:~$ hostname -f jaramillor.iesgn.org Compruebo nombre corto: vagrant@jaramillor:~$ ping jaramillor -c 1 PING jaramillor.iesgn.org (127.0.1.1) 56(84) bytes of data. 64 bytes from jaramillor.iesgn.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.089 ms --- jaramillor.iesgn.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.089/0.089/0.089/0.000 ms Parte 3 Instalar bind9 sudo apt update sudo apt install bind9 Parte 4 Modificar la definici\u00f3n de zonas del maestro para habilitar transferencia al esclavo /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; Parte 5 Modificar la zona directa con el nuevo esclavo /etc/bind/db.iesgn.org : $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 jaramillor IN A 10.0.0.10 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj Parte 6 Modificar la zona inversa con el nuevo esclavo /etc/bind/db.10.0.0 : $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. 2 IN PTR adrianj.iesgn.org. 10 IN PTR jaramillor.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org. Parte 7 Reiniciar DNS maestro sudo systemctl restart bind9 Parte 8 Modificar la definici\u00f3n de zonas del esclavo /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type slave; file \"/var/cache/bind/db.iesgn.org\"; masters { 10.0.0.2; }; }; zone \"0.0.10.in-addr.arpa\" { type slave; file \"/var/cache/bind/db.10.0.0\"; masters { 10.0.0.2; }; }; Parte 9 Reiniciar DNS esclavo sudo systemctl restart bind9 Ejercicio 2 Comprobar si los ficheros de zona del maestro tienen errores Verifico la zona directa: sudo named-checkzone iesgn.org db.iesgn.org zone iesgn.org/IN: loaded serial 2001062501 OK Verifico la zona inversa: sudo named-checkzone 0.0.10.in-addr.arpa db.10.0.0 zone 0.0.10.in-addr.arpa/IN: loaded serial 2001062501 OK Ejercicio 3 Comprobar si named.conf tiene errores tanto en maestro como en esclavo En maestro: sudo named-checkconf named.conf En esclavo: sudo named-checkconf named.conf Ejercicio 4 Reiniciar ambos servidores DNS sudo systemctl restart bind9 Comprobar en /var/log/syslog si hay alg\u00fan error (incrementar n\u00famero de serie en SOA si se modifican zonas en el maestro) sudo cat /var/log/syslog | grep named No hay errores. Ejercicio 5 Configurar cliente para utilizar maestro y esclavo como servidores DNS /etc/resolv.conf : nameserver 10.0.0.2 nameserver 10.0.0.10","title":"Ejercicio 2: Slave DNS"},{"location":"ej2-instalar-configurar-slave/#ejercicio-2-instalacion-y-configuracion-de-un-servidor-dns-esclavo","text":"","title":"Ejercicio 2: Instalaci\u00f3n y configuraci\u00f3n de un servidor DNS esclavo"},{"location":"ej2-instalar-configurar-slave/#entrega","text":"","title":"Entrega"},{"location":"ej2-instalar-configurar-slave/#parte-1","text":"Mostrar la definici\u00f3n de zonas en maestro /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; Mostrar la zona directa en maestro /etc/bind/db.iesgn.org : $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 jaramillor IN A 10.0.0.10 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj Mostrar la zona inversa en maestro /etc/bind/db.10.0.0 : $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. 2 IN PTR adrianj.iesgn.org. 10 IN PTR jaramillor.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org. Mostrar la definici\u00f3n de zonas en esclavo /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type slave; file \"/var/cache/bind/db.iesgn.org\"; masters { 10.0.0.2; }; }; zone \"0.0.10.in-addr.arpa\" { type slave; file \"/var/cache/bind/db.10.0.0\"; masters { 10.0.0.2; }; };","title":"Parte 1"},{"location":"ej2-instalar-configurar-slave/#parte-2","text":"Mostrar si los ficheros de zona del maestro tienen errores Verifico la zona directa: sudo named-checkzone iesgn.org db.iesgn.org zone iesgn.org/IN: loaded serial 2001062501 OK Verifico la zona inversa: sudo named-checkzone 0.0.10.in-addr.arpa db.10.0.0 zone 0.0.10.in-addr.arpa/IN: loaded serial 2001062501 OK","title":"Parte 2"},{"location":"ej2-instalar-configurar-slave/#parte-3","text":"Comprobar si named.conf tiene errores tanto en maestro como en esclavo En maestro: sudo named-checkconf named.conf En esclavo: sudo named-checkconf named.conf No me devuelve output en ambos casos, significa que no hay errores.","title":"Parte 3"},{"location":"ej2-instalar-configurar-slave/#parte-4","text":"Mostrar en /var/log/syslog la transferencia de zonas Comando: sudo cat /var/log/syslog | grep named | grep transfer Transferencia de zona directa: Nov 18 00:43:58 bullseye named[2538]: transfer of 'iesgn.org/IN' from 10.0.0.2#53: connected using 10.0.0.10#58761 Nov 18 00:43:58 bullseye named[2538]: zone iesgn.org/IN: transferred serial 2001062504 Nov 18 00:43:58 bullseye named[2538]: transfer of 'iesgn.org/IN' from 10.0.0.2#53: Transfer status: success Nov 18 00:43:58 bullseye named[2538]: transfer of 'iesgn.org/IN' from 10.0.0.2#53: Transfer completed: 1 messages, 14 records, 364 bytes, 0.004 secs (91000 bytes/sec) (serial 2001062504) Transferencia de zona inversa: Nov 18 00:53:00 bullseye named[2538]: transfer of '0.0.10.in-addr.arpa/IN' from 10.0.0.2#53: connected using 10.0.0.10#58699 Nov 18 00:53:00 bullseye named[2538]: zone 0.0.10.in-addr.arpa/IN: transferred serial 2001062502 Nov 18 00:53:00 bullseye named[2538]: transfer of '0.0.10.in-addr.arpa/IN' from 10.0.0.2#53: Transfer status: success Nov 18 00:53:00 bullseye named[2538]: transfer of '0.0.10.in-addr.arpa/IN' from 10.0.0.2#53: Transfer completed: 1 messages, 11 records, 326 bytes, 0.004 secs (81500 bytes/sec) (serial 2001062502)","title":"Parte 4"},{"location":"ej2-instalar-configurar-slave/#parte-5","text":"Entregar la configuraci\u00f3n DNS de cliente /etc/resolv.conf : nameserver 10.0.0.2 nameserver 10.0.0.10","title":"Parte 5"},{"location":"ej2-instalar-configurar-slave/#parte-6","text":"Realizar una consulta dig a maestro y esclavo para comprobar que las respuestas son con autoridad Al maestro: Al esclavo: Buscamos esa flag \"aa\", que quiere decir \"Authoritative Answer\". Nos devolver\u00e1 esa flag siempre que hagamos consultas sobre zonas en las que los servidores tengan autoridad. La RFC 1035 dice lo siguiente: Si por ejemplo hiciese una consulta en una zona sobre la que mi servidor NO TIENE autoridad, pasar\u00eda lo siguiente: No aparece la flag \"aa\".","title":"Parte 6"},{"location":"ej2-instalar-configurar-slave/#parte-7","text":"Solicitar copia completa de una zona desde cliente \u00bfqu\u00e9 tiene que ocurrir? dig @10.0.0.2 iesgn.org axfr ; <<>> DiG 9.16.22-Debian <<>> @10.0.0.2 iesgn.org axfr ; (1 server found) ;; global options: +cmd ; Transfer failed. No permite la transferencia. Solicitar copia completa de una zona desde esclavo \u00bfqu\u00e9 tiene que ocurrir? dig @10.0.0.2 iesgn.org axfr ; <<>> DiG 9.16.22-Debian <<>> @10.0.0.2 iesgn.org axfr ; (1 server found) ;; global options: +cmd iesgn.org. 86400 IN SOA adrianj.iesgn.org. admin.iesgn.org. 2001062503 21600 3600 604800 86400 iesgn.org. 86400 IN NS adrianj.iesgn.org. iesgn.org. 86400 IN NS jaramillor.iesgn.org. iesgn.org. 86400 IN MX 10 correo.iesgn.org. adrianj.iesgn.org. 86400 IN A 10.0.0.2 cliente1.iesgn.org. 86400 IN A 10.0.0.3 cliente2.iesgn.org. 86400 IN A 10.0.0.4 cliente3.iesgn.org. 86400 IN A 10.0.0.5 correo.iesgn.org. 86400 IN A 10.0.0.200 departamentos.iesgn.org. 86400 IN CNAME adrianj.iesgn.org. ftp.iesgn.org. 86400 IN A 10.0.0.201 jaramillor.iesgn.org. 86400 IN A 10.0.0.10 www.iesgn.org. 86400 IN CNAME adrianj.iesgn.org. iesgn.org. 86400 IN SOA adrianj.iesgn.org. admin.iesgn.org. 2001062503 21600 3600 604800 86400 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Wed Nov 17 23:50:34 UTC 2021 ;; XFR size: 14 records (messages 1, bytes 403) Permite la transferencia.","title":"Parte 7"},{"location":"ej2-instalar-configurar-slave/#parte-8","text":"Realizar consulta desde cliente y comprobar qu\u00e9 servidor responde Seg\u00fan nuestro orden en resolv.conf , siempre nos responder\u00e1 el maestro, salvo que \u00e9ste falle.","title":"Parte 8"},{"location":"ej2-instalar-configurar-slave/#parte-9","text":"Apagar maestro y hacer consulta desde cliente \u00bfqui\u00e9n responde? Responde el esclavo.","title":"Parte 9"},{"location":"ej2-instalar-configurar-slave/#realizacion","text":"","title":"Realizaci\u00f3n"},{"location":"ej2-instalar-configurar-slave/#ejercicio-1","text":"Instalar un servidor DNS como esclavo del DNS configurado en el ejercicio 1.","title":"Ejercicio 1"},{"location":"ej2-instalar-configurar-slave/#parte-1_1","text":"A\u00f1adir otra m\u00e1quina al escenario del ej1, para instalar el esclavo ah\u00ed Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :server do |server| server.vm.box = \"debian/bullseye64\" server.vm.hostname = \"server\" server.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :slavedns do |slavedns| slavedns.vm.box = \"debian/bullseye64\" slavedns.vm.hostname = \"slavedns\" slavedns.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.10\", :libvirt__forward_mode => \"veryisolated\" end end","title":"Parte 1"},{"location":"ej2-instalar-configurar-slave/#parte-2_1","text":"Cambiar el hostname de slavedns a: jaramillor.iesgn.org Modifico /etc/hostname : vagrant@slavedns:~$ cat /etc/hostname jaramillor Hago que el cambio de hostname tome efecto ahora: sudo hostname jaramillor Verifico: vagrant@slavedns:~$ hostname jaramillor Actualizo el prompt: vagrant@slavedns:~$ bash vagrant@jaramillor:~$ Modifico /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 jaramillor.iesgn.org jaramillor Compruebo nombre largo: vagrant@jaramillor:~$ hostname -f jaramillor.iesgn.org Compruebo nombre corto: vagrant@jaramillor:~$ ping jaramillor -c 1 PING jaramillor.iesgn.org (127.0.1.1) 56(84) bytes of data. 64 bytes from jaramillor.iesgn.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.089 ms --- jaramillor.iesgn.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.089/0.089/0.089/0.000 ms","title":"Parte 2"},{"location":"ej2-instalar-configurar-slave/#parte-3_1","text":"Instalar bind9 sudo apt update sudo apt install bind9","title":"Parte 3"},{"location":"ej2-instalar-configurar-slave/#parte-4_1","text":"Modificar la definici\u00f3n de zonas del maestro para habilitar transferencia al esclavo /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type master; file \"/etc/bind/db.iesgn.org\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; }; zone \"0.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.0\"; allow-transfer { 10.0.0.10; }; also-notify { 10.0.0.10; }; };","title":"Parte 4"},{"location":"ej2-instalar-configurar-slave/#parte-5_1","text":"Modificar la zona directa con el nuevo esclavo /etc/bind/db.iesgn.org : $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 jaramillor IN A 10.0.0.10 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.5 www IN CNAME adrianj departamentos IN CNAME adrianj","title":"Parte 5"},{"location":"ej2-instalar-configurar-slave/#parte-6_1","text":"Modificar la zona inversa con el nuevo esclavo /etc/bind/db.10.0.0 : $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. 2 IN PTR adrianj.iesgn.org. 10 IN PTR jaramillor.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 5 IN PTR cliente3.iesgn.org.","title":"Parte 6"},{"location":"ej2-instalar-configurar-slave/#parte-7_1","text":"Reiniciar DNS maestro sudo systemctl restart bind9","title":"Parte 7"},{"location":"ej2-instalar-configurar-slave/#parte-8_1","text":"Modificar la definici\u00f3n de zonas del esclavo /etc/bind/named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization include \"/etc/bind/zones.rfc1918\"; zone \"iesgn.org\" { type slave; file \"/var/cache/bind/db.iesgn.org\"; masters { 10.0.0.2; }; }; zone \"0.0.10.in-addr.arpa\" { type slave; file \"/var/cache/bind/db.10.0.0\"; masters { 10.0.0.2; }; };","title":"Parte 8"},{"location":"ej2-instalar-configurar-slave/#parte-9_1","text":"Reiniciar DNS esclavo sudo systemctl restart bind9","title":"Parte 9"},{"location":"ej2-instalar-configurar-slave/#ejercicio-2","text":"Comprobar si los ficheros de zona del maestro tienen errores Verifico la zona directa: sudo named-checkzone iesgn.org db.iesgn.org zone iesgn.org/IN: loaded serial 2001062501 OK Verifico la zona inversa: sudo named-checkzone 0.0.10.in-addr.arpa db.10.0.0 zone 0.0.10.in-addr.arpa/IN: loaded serial 2001062501 OK","title":"Ejercicio 2"},{"location":"ej2-instalar-configurar-slave/#ejercicio-3","text":"Comprobar si named.conf tiene errores tanto en maestro como en esclavo En maestro: sudo named-checkconf named.conf En esclavo: sudo named-checkconf named.conf","title":"Ejercicio 3"},{"location":"ej2-instalar-configurar-slave/#ejercicio-4","text":"Reiniciar ambos servidores DNS sudo systemctl restart bind9 Comprobar en /var/log/syslog si hay alg\u00fan error (incrementar n\u00famero de serie en SOA si se modifican zonas en el maestro) sudo cat /var/log/syslog | grep named No hay errores.","title":"Ejercicio 4"},{"location":"ej2-instalar-configurar-slave/#ejercicio-5","text":"Configurar cliente para utilizar maestro y esclavo como servidores DNS /etc/resolv.conf : nameserver 10.0.0.2 nameserver 10.0.0.10","title":"Ejercicio 5"},{"location":"ej2-iptables-perimetral/","text":"Ejercicio 2 iptables: cortafuegos perimetral Preliminares Escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :perimetral do |perimetral| perimetral.vm.box = \"debian/bullseye64\" perimetral.vm.hostname = \"perimetral\" perimetral.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" perimetral.vm.network :private_network, :libvirt__network_name => \"ej2-iptables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :local do |local| local.vm.box = \"debian/bullseye64\" local.vm.hostname = \"local\" local.vm.network :private_network, :libvirt__network_name => \"ej2-iptables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.3\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end Cambio la ruta por defecto del cortafuegos: sudo ip route del default sudo ip route add default via 192.168.1.1 Cambio la ruta por defecto de la m\u00e1quina de la LAN: sudo ip route del default sudo ip route add default via 192.168.100.2 Instalo un servidor web y un servidor de correos en la m\u00e1quina de la LAN para dejar abierto el puerto 80 y el 25: sudo apt update sudo apt install apache2 sudo apt install postfix Tr\u00e1fico ssh entrante al cortafuegos sudo iptables -A INPUT -s 192.168.121.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -d 192.168.121.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pol\u00edticas por defecto sudo iptables -P INPUT DROP sudo iptables -P OUTPUT DROP sudo iptables -P FORWARD DROP No puedo hacer ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. ^C --- 127.0.0.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2052ms No puedo hacer ping a Internet: vagrant@perimetral:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. ^C --- 1.1.1.1 ping statistics --- 4 packets transmitted, 0 received, 100% packet loss, time 3077ms Si no se nos corta la conexi\u00f3n ssh a la m\u00e1quina despu\u00e9s de este paso, el par de reglas que aplicamos antes funcionan. Activar bit de forward echo 1 > /proc/sys/net/ipv4/ip_forward SNAT sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth1 -j MASQUERADE Tr\u00e1fico ssh saliente cortafuegos -> LAN sudo iptables -A OUTPUT -p tcp -o eth2 -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp -i eth2 -s 192.168.100.0/24 --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona: vagrant@perimetral:~$ ssh vagrant@192.168.100.3 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Mon Jan 31 08:25:49 2022 from 192.168.100.2 vagrant@local:~$ Tr\u00e1fico loopback sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT sudo iptables -A INPUT -i lo -p icmp -j ACCEPT Ya funciona el ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.023 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.076 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1005ms rtt min/avg/max/mdev = 0.023/0.049/0.076/0.026 ms Tr\u00e1fico ICMP Permito ping entrante desde la red externa: sudo iptables -A INPUT -i eth1 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A OUTPUT -o eth1 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ ping 192.168.1.110 PING 192.168.1.110 (192.168.1.110) 56(84) bytes of data. 64 bytes from 192.168.1.110: icmp_seq=1 ttl=64 time=0.147 ms 64 bytes from 192.168.1.110: icmp_seq=2 ttl=64 time=0.301 ms ^C --- 192.168.1.110 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1024ms rtt min/avg/max/mdev = 0.147/0.224/0.301/0.077 ms Permito ping saliente cortafuegos -> LAN: sudo iptables -A OUTPUT -o eth2 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona: vagrant@perimetral:~$ ping 192.168.100.3 PING 192.168.100.3 (192.168.100.3) 56(84) bytes of data. 64 bytes from 192.168.100.3: icmp_seq=1 ttl=64 time=0.268 ms 64 bytes from 192.168.100.3: icmp_seq=2 ttl=64 time=0.443 ms ^C --- 192.168.100.3 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1009ms rtt min/avg/max/mdev = 0.268/0.355/0.443/0.087 ms FORWARD: tr\u00e1fico icmp saliente LAN -> Internet sudo iptables -A FORWARD -o eth1 -i eth2 -s 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona el ping a Internet: vagrant@local:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=53 time=42.5 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=53 time=132 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 42.503/87.035/131.567/44.532 ms FORWARD: tr\u00e1fico DNS saliente desde LAN sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -o eth2 -i eth1 -d 192.168.100.0/24 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3057 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 508 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Mon Jan 31 11:34:11 UTC 2022 ;; MSG SIZE rcvd: 60 FORWARD: tr\u00e1fico http/https saliente desde LAN sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT sudo iptables -A FORWARD -o eth2 -i eth1 -d 192.168.100.0/24 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT Compruebo que funciona http: vagrant@local:~$ curl portquiz.net:80 Port test successful! Your IP: 158.99.1.24 Compruebo que funciona https: vagrant@local:~$ curl portquiz.net:443 Port test successful! Your IP: 158.99.1.24 FORWARD: tr\u00e1fico http entrante hacia LAN sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Necesito una regla DNAT: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to 192.168.100.3 Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ telnet 192.168.1.110 80 Trying 192.168.1.110... Connected to 192.168.1.110. Escape character is '^]'. Ejercicios Ejercicio 0 Guardar la configuraci\u00f3n del cortafuegos de forma persistente sudo apt install iptables-persistent (s\u00f3lo con instalar este paquete es suficiente, ya que durante la instalaci\u00f3n se nos pregunta que si queremos guardar las reglas y s\u00f3lo tenemos que responder que s\u00ed) Ejercicio 1 Permitir tr\u00e1fico ssh saliente desde la m\u00e1quina cortafuegos sudo iptables -A OUTPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona conectando a mi host: vagrant@perimetral:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Tue Feb 1 06:35:39 2022 from 192.168.1.110 atlas@olympus:~$ Ejercicio 2 Permitir tr\u00e1fico DNS saliente desde el cortafuegos s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 sudo iptables -A OUTPUT -d 192.168.202.2 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -s 192.168.202.2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@perimetral:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27464 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: ecefbd1dc86382b6f96bcd7a61fa34bcef09c617d031a22a (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 33449 IN A 93.184.216.34 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Feb 02 07:37:32 UTC 2022 ;; MSG SIZE rcvd: 88 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@perimetral:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached Ejercicio 3 Permitir que el cortafuegos pueda navegar por Internet sudo iptables -A OUTPUT -o eth1 -p tcp -m multiport --dports 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth1 -p tcp -m multiport --sports 80,443 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona http: vagrant@perimetral:~$ curl portquiz.net:80 Port test successful! Your IP: 90.168.73.6 Compruebo que funciona https: vagrant@perimetral:~$ curl portquiz.net:443 Port test successful! Your IP: 90.168.73.6 Ejercicio 4 Los equipos de la red local deben poder tener conexi\u00f3n al exterior Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan 2 cosas: SNAT Reglas forward para el tr\u00e1fico ICMP saliente Resumen de comandos para que funcione: sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth1 -j MASQUERADE sudo iptables -A FORWARD -o eth1 -i eth2 -s 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Ejercicio 5 Tr\u00e1fico ssh saliente cortafuegos -> LAN Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo iptables -A OUTPUT -p tcp -o eth2 -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp -i eth2 -s 192.168.100.0/24 --sport 22 -m state --state ESTABLISHED -j ACCEPT Ejercicio 6 Permitir ping entrante LAN -> cortafuegos: sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A OUTPUT -o eth2 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona: vagrant@local:~$ ping 192.168.100.2 PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data. 64 bytes from 192.168.100.2: icmp_seq=1 ttl=64 time=0.355 ms 64 bytes from 192.168.100.2: icmp_seq=2 ttl=64 time=0.259 ms ^C --- 192.168.100.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1010ms rtt min/avg/max/mdev = 0.259/0.307/0.355/0.048 ms Ejercicio 7 Permitir tr\u00e1fico ssh al exterior desde la LAN sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona conectando a mi host para que atraviese el cortafuegos: vagrant@local:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Tue Feb 1 21:40:41 2022 from 192.168.1.113 atlas@olympus:~$ Ejercicio 8 Permitir acceso desde el exterior al servidor de correos de la LAN sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --dport 25 -j ACCEPT sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --sport 25 -j ACCEPT sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ telnet 192.168.1.113 25 Trying 192.168.1.113... Connected to 192.168.1.113. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU) Permitir acceso desde el cortafuegos al servidor de correos de la LAN sudo iptables -A OUTPUT -d 192.168.100.3 -p tcp --dport 25 -j ACCEPT sudo iptables -A INPUT -s 192.168.100.3 -p tcp --sport 25 -j ACCEPT Pruebo que funciona desde el cortafuegos: vagrant@perimetral:~$ telnet 192.168.100.3 25 Trying 192.168.100.3... Connected to 192.168.100.3. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU) Ejercicio 9 Permitir tr\u00e1fico ssh desde el exterior a la LAN sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 22 -j DNAT --to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ ssh vagrant@192.168.1.113 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Feb 1 20:01:00 2022 from 192.168.100.2 vagrant@local:~$ Ejercicio 10 Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22 sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 2222 -j DNAT --to-destination 192.168.100.3:22 Pruebo que funciona: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ ssh -p 2222 vagrant@192.168.1.113 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Feb 1 23:54:20 2022 from 192.168.1.106 vagrant@local:~$ Ejercicio 11 Permitir consultas DNS desde la LAN s\u00f3lo al servidor 192.168.202.2. Comprueba que no puedes hacer un dig @1.1.1.1 sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -d 192.168.202.2 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -s 192.168.202.2 -d 192.168.100.0/24 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@local:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21410 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: a69a6f7c799135d6042bcb5f61fa3a83c62614c5b25bc08b (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 31970 IN A 93.184.216.34 ;; Query time: 4 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Feb 02 08:02:11 UTC 2022 ;; MSG SIZE rcvd: 88 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached Ejercicio 12 Permite que los equipos de la LAN puedan navegar por Internet Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT sudo iptables -A FORWARD -o eth2 -i eth1 -d 192.168.100.0/24 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT","title":"Ejercicio 2 iptables: perimetral"},{"location":"ej2-iptables-perimetral/#ejercicio-2-iptables-cortafuegos-perimetral","text":"","title":"Ejercicio 2 iptables: cortafuegos perimetral"},{"location":"ej2-iptables-perimetral/#preliminares","text":"","title":"Preliminares"},{"location":"ej2-iptables-perimetral/#escenario","text":"Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :perimetral do |perimetral| perimetral.vm.box = \"debian/bullseye64\" perimetral.vm.hostname = \"perimetral\" perimetral.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" perimetral.vm.network :private_network, :libvirt__network_name => \"ej2-iptables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :local do |local| local.vm.box = \"debian/bullseye64\" local.vm.hostname = \"local\" local.vm.network :private_network, :libvirt__network_name => \"ej2-iptables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.3\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end Cambio la ruta por defecto del cortafuegos: sudo ip route del default sudo ip route add default via 192.168.1.1 Cambio la ruta por defecto de la m\u00e1quina de la LAN: sudo ip route del default sudo ip route add default via 192.168.100.2 Instalo un servidor web y un servidor de correos en la m\u00e1quina de la LAN para dejar abierto el puerto 80 y el 25: sudo apt update sudo apt install apache2 sudo apt install postfix","title":"Escenario"},{"location":"ej2-iptables-perimetral/#trafico-ssh-entrante-al-cortafuegos","text":"sudo iptables -A INPUT -s 192.168.121.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -d 192.168.121.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT","title":"Tr\u00e1fico ssh entrante al cortafuegos"},{"location":"ej2-iptables-perimetral/#politicas-por-defecto","text":"sudo iptables -P INPUT DROP sudo iptables -P OUTPUT DROP sudo iptables -P FORWARD DROP No puedo hacer ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. ^C --- 127.0.0.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2052ms No puedo hacer ping a Internet: vagrant@perimetral:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. ^C --- 1.1.1.1 ping statistics --- 4 packets transmitted, 0 received, 100% packet loss, time 3077ms Si no se nos corta la conexi\u00f3n ssh a la m\u00e1quina despu\u00e9s de este paso, el par de reglas que aplicamos antes funcionan.","title":"Pol\u00edticas por defecto"},{"location":"ej2-iptables-perimetral/#activar-bit-de-forward","text":"echo 1 > /proc/sys/net/ipv4/ip_forward","title":"Activar bit de forward"},{"location":"ej2-iptables-perimetral/#snat","text":"sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth1 -j MASQUERADE","title":"SNAT"},{"location":"ej2-iptables-perimetral/#trafico-ssh-saliente-cortafuegos-lan","text":"sudo iptables -A OUTPUT -p tcp -o eth2 -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp -i eth2 -s 192.168.100.0/24 --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona: vagrant@perimetral:~$ ssh vagrant@192.168.100.3 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Mon Jan 31 08:25:49 2022 from 192.168.100.2 vagrant@local:~$","title":"Tr\u00e1fico ssh saliente cortafuegos -&gt; LAN"},{"location":"ej2-iptables-perimetral/#trafico-loopback","text":"sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT sudo iptables -A INPUT -i lo -p icmp -j ACCEPT Ya funciona el ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.023 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.076 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1005ms rtt min/avg/max/mdev = 0.023/0.049/0.076/0.026 ms","title":"Tr\u00e1fico loopback"},{"location":"ej2-iptables-perimetral/#trafico-icmp","text":"Permito ping entrante desde la red externa: sudo iptables -A INPUT -i eth1 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A OUTPUT -o eth1 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ ping 192.168.1.110 PING 192.168.1.110 (192.168.1.110) 56(84) bytes of data. 64 bytes from 192.168.1.110: icmp_seq=1 ttl=64 time=0.147 ms 64 bytes from 192.168.1.110: icmp_seq=2 ttl=64 time=0.301 ms ^C --- 192.168.1.110 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1024ms rtt min/avg/max/mdev = 0.147/0.224/0.301/0.077 ms Permito ping saliente cortafuegos -> LAN: sudo iptables -A OUTPUT -o eth2 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona: vagrant@perimetral:~$ ping 192.168.100.3 PING 192.168.100.3 (192.168.100.3) 56(84) bytes of data. 64 bytes from 192.168.100.3: icmp_seq=1 ttl=64 time=0.268 ms 64 bytes from 192.168.100.3: icmp_seq=2 ttl=64 time=0.443 ms ^C --- 192.168.100.3 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1009ms rtt min/avg/max/mdev = 0.268/0.355/0.443/0.087 ms","title":"Tr\u00e1fico ICMP"},{"location":"ej2-iptables-perimetral/#forward-trafico-icmp-saliente-lan-internet","text":"sudo iptables -A FORWARD -o eth1 -i eth2 -s 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona el ping a Internet: vagrant@local:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=53 time=42.5 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=53 time=132 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 42.503/87.035/131.567/44.532 ms","title":"FORWARD: tr\u00e1fico icmp saliente LAN -&gt; Internet"},{"location":"ej2-iptables-perimetral/#forward-trafico-dns-saliente-desde-lan","text":"sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -o eth2 -i eth1 -d 192.168.100.0/24 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3057 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 508 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Mon Jan 31 11:34:11 UTC 2022 ;; MSG SIZE rcvd: 60","title":"FORWARD: tr\u00e1fico DNS saliente desde LAN"},{"location":"ej2-iptables-perimetral/#forward-trafico-httphttps-saliente-desde-lan","text":"sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT sudo iptables -A FORWARD -o eth2 -i eth1 -d 192.168.100.0/24 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT Compruebo que funciona http: vagrant@local:~$ curl portquiz.net:80 Port test successful! Your IP: 158.99.1.24 Compruebo que funciona https: vagrant@local:~$ curl portquiz.net:443 Port test successful! Your IP: 158.99.1.24","title":"FORWARD: tr\u00e1fico http/https saliente desde LAN"},{"location":"ej2-iptables-perimetral/#forward-trafico-http-entrante-hacia-lan","text":"sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Necesito una regla DNAT: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to 192.168.100.3 Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ telnet 192.168.1.110 80 Trying 192.168.1.110... Connected to 192.168.1.110. Escape character is '^]'.","title":"FORWARD: tr\u00e1fico http entrante hacia LAN"},{"location":"ej2-iptables-perimetral/#ejercicios","text":"","title":"Ejercicios"},{"location":"ej2-iptables-perimetral/#ejercicio-0","text":"Guardar la configuraci\u00f3n del cortafuegos de forma persistente sudo apt install iptables-persistent (s\u00f3lo con instalar este paquete es suficiente, ya que durante la instalaci\u00f3n se nos pregunta que si queremos guardar las reglas y s\u00f3lo tenemos que responder que s\u00ed)","title":"Ejercicio 0"},{"location":"ej2-iptables-perimetral/#ejercicio-1","text":"Permitir tr\u00e1fico ssh saliente desde la m\u00e1quina cortafuegos sudo iptables -A OUTPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona conectando a mi host: vagrant@perimetral:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Tue Feb 1 06:35:39 2022 from 192.168.1.110 atlas@olympus:~$","title":"Ejercicio 1"},{"location":"ej2-iptables-perimetral/#ejercicio-2","text":"Permitir tr\u00e1fico DNS saliente desde el cortafuegos s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 sudo iptables -A OUTPUT -d 192.168.202.2 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -s 192.168.202.2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@perimetral:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27464 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: ecefbd1dc86382b6f96bcd7a61fa34bcef09c617d031a22a (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 33449 IN A 93.184.216.34 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Feb 02 07:37:32 UTC 2022 ;; MSG SIZE rcvd: 88 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@perimetral:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached","title":"Ejercicio 2"},{"location":"ej2-iptables-perimetral/#ejercicio-3","text":"Permitir que el cortafuegos pueda navegar por Internet sudo iptables -A OUTPUT -o eth1 -p tcp -m multiport --dports 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth1 -p tcp -m multiport --sports 80,443 -m state --state ESTABLISHED -j ACCEPT Compruebo que funciona http: vagrant@perimetral:~$ curl portquiz.net:80 Port test successful! Your IP: 90.168.73.6 Compruebo que funciona https: vagrant@perimetral:~$ curl portquiz.net:443 Port test successful! Your IP: 90.168.73.6","title":"Ejercicio 3"},{"location":"ej2-iptables-perimetral/#ejercicio-4","text":"Los equipos de la red local deben poder tener conexi\u00f3n al exterior Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan 2 cosas: SNAT Reglas forward para el tr\u00e1fico ICMP saliente Resumen de comandos para que funcione: sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth1 -j MASQUERADE sudo iptables -A FORWARD -o eth1 -i eth2 -s 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT","title":"Ejercicio 4"},{"location":"ej2-iptables-perimetral/#ejercicio-5","text":"Tr\u00e1fico ssh saliente cortafuegos -> LAN Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo iptables -A OUTPUT -p tcp -o eth2 -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p tcp -i eth2 -s 192.168.100.0/24 --sport 22 -m state --state ESTABLISHED -j ACCEPT","title":"Ejercicio 5"},{"location":"ej2-iptables-perimetral/#ejercicio-6","text":"Permitir ping entrante LAN -> cortafuegos: sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A OUTPUT -o eth2 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona: vagrant@local:~$ ping 192.168.100.2 PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data. 64 bytes from 192.168.100.2: icmp_seq=1 ttl=64 time=0.355 ms 64 bytes from 192.168.100.2: icmp_seq=2 ttl=64 time=0.259 ms ^C --- 192.168.100.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1010ms rtt min/avg/max/mdev = 0.259/0.307/0.355/0.048 ms","title":"Ejercicio 6"},{"location":"ej2-iptables-perimetral/#ejercicio-7","text":"Permitir tr\u00e1fico ssh al exterior desde la LAN sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona conectando a mi host para que atraviese el cortafuegos: vagrant@local:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Tue Feb 1 21:40:41 2022 from 192.168.1.113 atlas@olympus:~$","title":"Ejercicio 7"},{"location":"ej2-iptables-perimetral/#ejercicio-8","text":"Permitir acceso desde el exterior al servidor de correos de la LAN sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --dport 25 -j ACCEPT sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --sport 25 -j ACCEPT sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ telnet 192.168.1.113 25 Trying 192.168.1.113... Connected to 192.168.1.113. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU) Permitir acceso desde el cortafuegos al servidor de correos de la LAN sudo iptables -A OUTPUT -d 192.168.100.3 -p tcp --dport 25 -j ACCEPT sudo iptables -A INPUT -s 192.168.100.3 -p tcp --sport 25 -j ACCEPT Pruebo que funciona desde el cortafuegos: vagrant@perimetral:~$ telnet 192.168.100.3 25 Trying 192.168.100.3... Connected to 192.168.100.3. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU)","title":"Ejercicio 8"},{"location":"ej2-iptables-perimetral/#ejercicio-9","text":"Permitir tr\u00e1fico ssh desde el exterior a la LAN sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.100.0/24 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 22 -j DNAT --to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ ssh vagrant@192.168.1.113 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Feb 1 20:01:00 2022 from 192.168.100.2 vagrant@local:~$","title":"Ejercicio 9"},{"location":"ej2-iptables-perimetral/#ejercicio-10","text":"Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22 sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 2222 -j DNAT --to-destination 192.168.100.3:22 Pruebo que funciona: atlas@olympus:~/vagrant/ej2-iptables-perimetral$ ssh -p 2222 vagrant@192.168.1.113 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Feb 1 23:54:20 2022 from 192.168.1.106 vagrant@local:~$","title":"Ejercicio 10"},{"location":"ej2-iptables-perimetral/#ejercicio-11","text":"Permitir consultas DNS desde la LAN s\u00f3lo al servidor 192.168.202.2. Comprueba que no puedes hacer un dig @1.1.1.1 sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -d 192.168.202.2 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth2 -s 192.168.202.2 -d 192.168.100.0/24 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@local:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21410 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: a69a6f7c799135d6042bcb5f61fa3a83c62614c5b25bc08b (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 31970 IN A 93.184.216.34 ;; Query time: 4 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Feb 02 08:02:11 UTC 2022 ;; MSG SIZE rcvd: 88 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.22-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached","title":"Ejercicio 11"},{"location":"ej2-iptables-perimetral/#ejercicio-12","text":"Permite que los equipos de la LAN puedan navegar por Internet Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.100.0/24 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT sudo iptables -A FORWARD -o eth2 -i eth1 -d 192.168.100.0/24 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -m time --timestart 01:00 --timestop 22:00 -j ACCEPT","title":"Ejercicio 12"},{"location":"ej2-nftables-perimetral/","text":"Ejercicio 2 nftables: cortafuegos perimetral Preliminares Escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :perimetral do |perimetral| perimetral.vm.box = \"debian/bullseye64\" perimetral.vm.hostname = \"perimetral\" perimetral.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" perimetral.vm.network :private_network, :libvirt__network_name => \"ej2-nftables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :local do |local| local.vm.box = \"debian/bullseye64\" local.vm.hostname = \"local\" local.vm.network :private_network, :libvirt__network_name => \"ej2-nftables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.3\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end Cambio la ruta por defecto del cortafuegos: sudo ip route del default sudo ip route add default via 172.22.0.1 Cambio la ruta por defecto de la m\u00e1quina de la LAN: sudo ip route del default sudo ip route add default via 192.168.100.2 Instalo un servidor web y un servidor de correos en la m\u00e1quina de la LAN para dejar abierto el puerto 80 y el 25: sudo apt update sudo apt install apache2 postfix Preparaci\u00f3n nftables Creo las tablas filter y nat: sudo nft add table inet filter sudo nft add table inet nat Creo las cadenas de filter: sudo nft add chain inet filter input { type filter hook input priority 0 \\; counter \\; policy accept \\; } sudo nft add chain inet filter output { type filter hook output priority 0 \\; counter \\; policy accept \\; } sudo nft add chain inet filter forward { type filter hook forward priority 0 \\; counter \\; policy accept \\; } Creo las cadenas de nat: sudo nft add chain inet nat prerouting { type nat hook prerouting priority 0 \\; } sudo nft add chain inet nat postrouting { type nat hook postrouting priority 100 \\; } Tr\u00e1fico ssh entrante al cortafuegos sudo nft add rule inet filter input ip saddr 192.168.121.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter output ip daddr 192.168.121.0/24 tcp sport 22 ct state established counter accept Pol\u00edticas por defecto sudo nft chain inet filter input { policy drop \\; } sudo nft chain inet filter output { policy drop \\; } sudo nft chain inet filter forward { policy drop \\; } No puedo hacer ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. ^C --- 127.0.0.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2049ms No puedo hacer ping a Internet: vagrant@perimetral:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. ^C --- 1.1.1.1 ping statistics --- 4 packets transmitted, 0 received, 100% packet loss, time 3075ms Si no se nos corta la conexi\u00f3n ssh a la m\u00e1quina despu\u00e9s de este paso, el par de reglas que aplicamos antes funcionan. Activar bit de forward echo 1 > /proc/sys/net/ipv4/ip_forward SNAT sudo nft add rule inet nat postrouting oifname \"eth1\" ip saddr 192.168.100.0/24 counter masquerade Tr\u00e1fico ssh saliente cortafuegos -> LAN sudo nft add rule inet filter output oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth2\" ip saddr 192.168.100.0/24 tcp sport 22 ct state established counter accept Pruebo que funciona: vagrant@perimetral:~$ ssh vagrant@192.168.100.3 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Wed Feb 2 09:05:39 2022 from 192.168.121.1 vagrant@local:~$ Tr\u00e1fico loopback sudo nft add rule inet filter output oifname \"lo\" counter accept sudo nft add rule inet filter input iifname \"lo\" counter accept Ya funciona el ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.102 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.033 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1014ms rtt min/avg/max/mdev = 0.033/0.067/0.102/0.034 ms Tr\u00e1fico ICMP Permito ping entrante desde la red externa: sudo nft add rule inet filter input iifname \"eth1\" icmp type echo-request counter accept sudo nft add rule inet filter output oifname \"eth1\" icmp type echo-reply counter accept Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ ping 172.22.7.193 PING 172.22.7.193 (172.22.7.193) 56(84) bytes of data. 64 bytes from 172.22.7.193: icmp_seq=1 ttl=64 time=0.278 ms 64 bytes from 172.22.7.193: icmp_seq=2 ttl=64 time=0.232 ms ^C --- 172.22.7.193 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1028ms rtt min/avg/max/mdev = 0.232/0.255/0.278/0.023 ms Permito ping saliente cortafuegos -> LAN: sudo nft add rule inet filter output oifname \"eth2\" icmp type echo-request counter accept sudo nft add rule inet filter input iifname \"eth2\" icmp type echo-reply counter accept Pruebo que funciona: vagrant@perimetral:~$ ping 192.168.100.3 PING 192.168.100.3 (192.168.100.3) 56(84) bytes of data. 64 bytes from 192.168.100.3: icmp_seq=1 ttl=64 time=0.398 ms 64 bytes from 192.168.100.3: icmp_seq=2 ttl=64 time=0.325 ms ^C --- 192.168.100.3 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1031ms rtt min/avg/max/mdev = 0.325/0.361/0.398/0.036 ms FORWARD: tr\u00e1fico icmp saliente LAN -> Internet sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 icmp type echo-request counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 icmp type echo-reply counter accept Pruebo que funciona el ping a Internet: vagrant@local:~$ ping 1.1.1.1 -c 2 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=438 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=171 ms --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1000ms rtt min/avg/max/mdev = 170.639/304.483/438.327/133.844 ms FORWARD: tr\u00e1fico DNS saliente desde LAN sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 udp sport 53 ct state established counter accept Pruebo que funciona: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 7637 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 516 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Wed Feb 02 12:00:55 UTC 2022 ;; MSG SIZE rcvd: 60 FORWARD: tr\u00e1fico http/https saliente desde LAN sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip protocol tcp ip saddr 192.168.100.0/24 tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip protocol tcp ip daddr 192.168.100.0/24 tcp sport { 80,443 } ct state established counter accept Compruebo que funciona http: vagrant@local:~$ curl portquiz.net:80 Port test successful! Your IP: 158.99.1.24 Compruebo que funciona https: vagrant@local:~$ curl portquiz.net:443 Port test successful! Your IP: 158.99.1.24 FORWARD: tr\u00e1fico http entrante hacia LAN sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 80 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp sport 80 ct state established counter accept Necesito una regla DNAT: sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 80 counter dnat ip to 192.168.100.3 Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ telnet 172.22.7.193 80 Trying 172.22.7.193... Connected to 172.22.7.193. Escape character is '^]'. Ejercicios Ejercicio 0 Guardar la configuraci\u00f3n del cortafuegos de forma persistente nft list ruleset > /etc/nftables.conf sudo systemctl enable nftables sudo systemctl start nftables Ejercicio 1 Permitir tr\u00e1fico ssh saliente al exterior desde la m\u00e1quina cortafuegos sudo nft add rule inet filter output oifname \"eth1\" tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth1\" tcp sport 22 ct state established counter accept Pruebo que funciona conectando a mi host: vagrant@perimetral:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Wed Feb 2 22:45:29 2022 from 192.168.1.114 atlas@olympus:~$ Ejercicio 2 Permitir tr\u00e1fico DNS saliente desde el cortafuegos s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 sudo nft add rule inet filter output ip daddr 192.168.202.2 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter input ip saddr 192.168.202.2 udp sport 53 ct state established counter accept Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@perimetral:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 39297 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 7eeeb71280505e6e78cad2c561fa79dd3cddfb164ad3691c (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 15752 IN A 93.184.216.34 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Feb 02 12:32:29 UTC 2022 ;; MSG SIZE rcvd: 88 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@perimetral:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached Ejercicio 3 Permitir que el cortafuegos pueda navegar por Internet sudo nft add rule inet filter output oifname \"eth1\" ip protocol tcp tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth1\" ip protocol tcp tcp sport { 80,443 } ct state established counter accept Compruebo que funciona http: vagrant@perimetral:~$ telnet 52.47.209.216 80 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Compruebo que funciona https: vagrant@perimetral:~$ telnet 52.47.209.216 443 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Ejercicio 4 Los equipos de la red local deben poder tener conexi\u00f3n al exterior Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan 2 cosas: SNAT Reglas forward para el tr\u00e1fico ICMP saliente Resumen de comandos para que funcione: sudo nft add rule inet nat postrouting oifname \"eth1\" ip saddr 192.168.100.0/24 counter masquerade sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 icmp type echo-request counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 icmp type echo-reply counter accept Ejercicio 5 Tr\u00e1fico ssh saliente cortafuegos -> LAN Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo nft add rule inet filter output oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth2\" ip saddr 192.168.100.0/24 tcp sport 22 ct state established counter accept Ejercicio 6 Permitir ping entrante LAN -> cortafuegos: sudo nft add rule inet filter input iifname \"eth2\" icmp type echo-request counter accept sudo nft add rule inet filter output oifname \"eth2\" icmp type echo-reply counter accept Pruebo que funciona: vagrant@local:~$ ping 192.168.100.2 PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data. 64 bytes from 192.168.100.2: icmp_seq=1 ttl=64 time=0.312 ms 64 bytes from 192.168.100.2: icmp_seq=2 ttl=64 time=0.539 ms ^C --- 192.168.100.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1006ms rtt min/avg/max/mdev = 0.312/0.425/0.539/0.113 ms Ejercicio 7 Permitir tr\u00e1fico ssh al exterior desde la LAN sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp sport 22 ct state established counter accept Pruebo que funciona conectando a mi host para que atraviese el cortafuegos: vagrant@local:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Thu Feb 3 01:31:42 2022 from 192.168.1.114 atlas@olympus:~$ Ejercicio 8 Permitir acceso desde el exterior al servidor de correos de la LAN sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 25 counter accept sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp sport 25 counter accept sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 25 counter dnat ip to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ telnet 172.22.7.193 25 Trying 172.22.7.193... Connected to 172.22.7.193. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU) Permitir acceso desde el cortafuegos al servidor de correos de la LAN sudo nft add rule inet filter output ip daddr 192.168.100.3 tcp dport 25 counter accept sudo nft add rule inet filter input ip saddr 192.168.100.3 tcp sport 25 counter accept Pruebo que funciona desde el cortafuegos: vagrant@perimetral:~$ telnet 192.168.100.3 25 Trying 192.168.100.3... Connected to 192.168.100.3. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU) Ejercicio 9 Permitir tr\u00e1fico ssh desde el exterior a la LAN sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp sport 22 ct state established counter accept sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 22 counter dnat ip to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ ssh vagrant@172.22.7.193 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Feb 3 07:37:45 2022 from 192.168.100.2 vagrant@local:~$ Ejercicio 10 Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22 sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 2222 counter dnat ip to 192.168.100.3:22 Pruebo que funciona: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ ssh -p 2222 vagrant@172.22.7.193 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Feb 3 08:06:47 2022 from 172.22.9.227 vagrant@local:~$ Ejercicio 11 Permitir consultas DNS desde la LAN s\u00f3lo al servidor 192.168.202.2. Comprueba que no puedes hacer un dig @1.1.1.1 sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 ip daddr 192.168.202.2 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip saddr 192.168.202.2 ip daddr 192.168.100.0/24 udp sport 53 ct state established counter accept Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@local:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45511 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 5 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: e8ba7a0a4e288162253fa85561fb919daab6c9aee27df0e8 (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 83378 IN A 93.184.216.34 ;; AUTHORITY SECTION: example.org. 82302 IN NS b.iana-servers.net. example.org. 82302 IN NS a.iana-servers.net. ;; ADDITIONAL SECTION: a.iana-servers.net. 82275 IN A 199.43.135.53 b.iana-servers.net. 82275 IN A 199.43.133.53 a.iana-servers.net. 82275 IN AAAA 2001:500:8f::53 b.iana-servers.net. 82275 IN AAAA 2001:500:8d::53 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Thu Feb 03 08:26:05 UTC 2022 ;; MSG SIZE rcvd: 224 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached Ejercicio 12 Permite que los equipos de la LAN puedan navegar por Internet Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip protocol tcp ip saddr 192.168.100.0/24 tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip protocol tcp ip daddr 192.168.100.0/24 tcp sport { 80,443 } ct state established counter accept","title":"Ejercicio 2 nftables: perimetral"},{"location":"ej2-nftables-perimetral/#ejercicio-2-nftables-cortafuegos-perimetral","text":"","title":"Ejercicio 2 nftables: cortafuegos perimetral"},{"location":"ej2-nftables-perimetral/#preliminares","text":"","title":"Preliminares"},{"location":"ej2-nftables-perimetral/#escenario","text":"Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :perimetral do |perimetral| perimetral.vm.box = \"debian/bullseye64\" perimetral.vm.hostname = \"perimetral\" perimetral.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" perimetral.vm.network :private_network, :libvirt__network_name => \"ej2-nftables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :local do |local| local.vm.box = \"debian/bullseye64\" local.vm.hostname = \"local\" local.vm.network :private_network, :libvirt__network_name => \"ej2-nftables-perimetral\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.3\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end Cambio la ruta por defecto del cortafuegos: sudo ip route del default sudo ip route add default via 172.22.0.1 Cambio la ruta por defecto de la m\u00e1quina de la LAN: sudo ip route del default sudo ip route add default via 192.168.100.2 Instalo un servidor web y un servidor de correos en la m\u00e1quina de la LAN para dejar abierto el puerto 80 y el 25: sudo apt update sudo apt install apache2 postfix","title":"Escenario"},{"location":"ej2-nftables-perimetral/#preparacion-nftables","text":"Creo las tablas filter y nat: sudo nft add table inet filter sudo nft add table inet nat Creo las cadenas de filter: sudo nft add chain inet filter input { type filter hook input priority 0 \\; counter \\; policy accept \\; } sudo nft add chain inet filter output { type filter hook output priority 0 \\; counter \\; policy accept \\; } sudo nft add chain inet filter forward { type filter hook forward priority 0 \\; counter \\; policy accept \\; } Creo las cadenas de nat: sudo nft add chain inet nat prerouting { type nat hook prerouting priority 0 \\; } sudo nft add chain inet nat postrouting { type nat hook postrouting priority 100 \\; }","title":"Preparaci\u00f3n nftables"},{"location":"ej2-nftables-perimetral/#trafico-ssh-entrante-al-cortafuegos","text":"sudo nft add rule inet filter input ip saddr 192.168.121.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter output ip daddr 192.168.121.0/24 tcp sport 22 ct state established counter accept","title":"Tr\u00e1fico ssh entrante al cortafuegos"},{"location":"ej2-nftables-perimetral/#politicas-por-defecto","text":"sudo nft chain inet filter input { policy drop \\; } sudo nft chain inet filter output { policy drop \\; } sudo nft chain inet filter forward { policy drop \\; } No puedo hacer ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. ^C --- 127.0.0.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2049ms No puedo hacer ping a Internet: vagrant@perimetral:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. ^C --- 1.1.1.1 ping statistics --- 4 packets transmitted, 0 received, 100% packet loss, time 3075ms Si no se nos corta la conexi\u00f3n ssh a la m\u00e1quina despu\u00e9s de este paso, el par de reglas que aplicamos antes funcionan.","title":"Pol\u00edticas por defecto"},{"location":"ej2-nftables-perimetral/#activar-bit-de-forward","text":"echo 1 > /proc/sys/net/ipv4/ip_forward","title":"Activar bit de forward"},{"location":"ej2-nftables-perimetral/#snat","text":"sudo nft add rule inet nat postrouting oifname \"eth1\" ip saddr 192.168.100.0/24 counter masquerade","title":"SNAT"},{"location":"ej2-nftables-perimetral/#trafico-ssh-saliente-cortafuegos-lan","text":"sudo nft add rule inet filter output oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth2\" ip saddr 192.168.100.0/24 tcp sport 22 ct state established counter accept Pruebo que funciona: vagrant@perimetral:~$ ssh vagrant@192.168.100.3 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Wed Feb 2 09:05:39 2022 from 192.168.121.1 vagrant@local:~$","title":"Tr\u00e1fico ssh saliente cortafuegos -&gt; LAN"},{"location":"ej2-nftables-perimetral/#trafico-loopback","text":"sudo nft add rule inet filter output oifname \"lo\" counter accept sudo nft add rule inet filter input iifname \"lo\" counter accept Ya funciona el ping a localhost: vagrant@perimetral:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.102 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.033 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1014ms rtt min/avg/max/mdev = 0.033/0.067/0.102/0.034 ms","title":"Tr\u00e1fico loopback"},{"location":"ej2-nftables-perimetral/#trafico-icmp","text":"Permito ping entrante desde la red externa: sudo nft add rule inet filter input iifname \"eth1\" icmp type echo-request counter accept sudo nft add rule inet filter output oifname \"eth1\" icmp type echo-reply counter accept Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ ping 172.22.7.193 PING 172.22.7.193 (172.22.7.193) 56(84) bytes of data. 64 bytes from 172.22.7.193: icmp_seq=1 ttl=64 time=0.278 ms 64 bytes from 172.22.7.193: icmp_seq=2 ttl=64 time=0.232 ms ^C --- 172.22.7.193 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1028ms rtt min/avg/max/mdev = 0.232/0.255/0.278/0.023 ms Permito ping saliente cortafuegos -> LAN: sudo nft add rule inet filter output oifname \"eth2\" icmp type echo-request counter accept sudo nft add rule inet filter input iifname \"eth2\" icmp type echo-reply counter accept Pruebo que funciona: vagrant@perimetral:~$ ping 192.168.100.3 PING 192.168.100.3 (192.168.100.3) 56(84) bytes of data. 64 bytes from 192.168.100.3: icmp_seq=1 ttl=64 time=0.398 ms 64 bytes from 192.168.100.3: icmp_seq=2 ttl=64 time=0.325 ms ^C --- 192.168.100.3 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1031ms rtt min/avg/max/mdev = 0.325/0.361/0.398/0.036 ms","title":"Tr\u00e1fico ICMP"},{"location":"ej2-nftables-perimetral/#forward-trafico-icmp-saliente-lan-internet","text":"sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 icmp type echo-request counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 icmp type echo-reply counter accept Pruebo que funciona el ping a Internet: vagrant@local:~$ ping 1.1.1.1 -c 2 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=438 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=171 ms --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1000ms rtt min/avg/max/mdev = 170.639/304.483/438.327/133.844 ms","title":"FORWARD: tr\u00e1fico icmp saliente LAN -&gt; Internet"},{"location":"ej2-nftables-perimetral/#forward-trafico-dns-saliente-desde-lan","text":"sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 udp sport 53 ct state established counter accept Pruebo que funciona: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 7637 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 86400 IN A 93.184.216.34 ;; Query time: 516 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Wed Feb 02 12:00:55 UTC 2022 ;; MSG SIZE rcvd: 60","title":"FORWARD: tr\u00e1fico DNS saliente desde LAN"},{"location":"ej2-nftables-perimetral/#forward-trafico-httphttps-saliente-desde-lan","text":"sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip protocol tcp ip saddr 192.168.100.0/24 tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip protocol tcp ip daddr 192.168.100.0/24 tcp sport { 80,443 } ct state established counter accept Compruebo que funciona http: vagrant@local:~$ curl portquiz.net:80 Port test successful! Your IP: 158.99.1.24 Compruebo que funciona https: vagrant@local:~$ curl portquiz.net:443 Port test successful! Your IP: 158.99.1.24","title":"FORWARD: tr\u00e1fico http/https saliente desde LAN"},{"location":"ej2-nftables-perimetral/#forward-trafico-http-entrante-hacia-lan","text":"sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 80 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp sport 80 ct state established counter accept Necesito una regla DNAT: sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 80 counter dnat ip to 192.168.100.3 Compruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ telnet 172.22.7.193 80 Trying 172.22.7.193... Connected to 172.22.7.193. Escape character is '^]'.","title":"FORWARD: tr\u00e1fico http entrante hacia LAN"},{"location":"ej2-nftables-perimetral/#ejercicios","text":"","title":"Ejercicios"},{"location":"ej2-nftables-perimetral/#ejercicio-0","text":"Guardar la configuraci\u00f3n del cortafuegos de forma persistente nft list ruleset > /etc/nftables.conf sudo systemctl enable nftables sudo systemctl start nftables","title":"Ejercicio 0"},{"location":"ej2-nftables-perimetral/#ejercicio-1","text":"Permitir tr\u00e1fico ssh saliente al exterior desde la m\u00e1quina cortafuegos sudo nft add rule inet filter output oifname \"eth1\" tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth1\" tcp sport 22 ct state established counter accept Pruebo que funciona conectando a mi host: vagrant@perimetral:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Wed Feb 2 22:45:29 2022 from 192.168.1.114 atlas@olympus:~$","title":"Ejercicio 1"},{"location":"ej2-nftables-perimetral/#ejercicio-2","text":"Permitir tr\u00e1fico DNS saliente desde el cortafuegos s\u00f3lo a 192.168.202.2. Comprobar que no se puede hacer un dig @1.1.1.1 sudo nft add rule inet filter output ip daddr 192.168.202.2 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter input ip saddr 192.168.202.2 udp sport 53 ct state established counter accept Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@perimetral:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 39297 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 7eeeb71280505e6e78cad2c561fa79dd3cddfb164ad3691c (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 15752 IN A 93.184.216.34 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Wed Feb 02 12:32:29 UTC 2022 ;; MSG SIZE rcvd: 88 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@perimetral:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached","title":"Ejercicio 2"},{"location":"ej2-nftables-perimetral/#ejercicio-3","text":"Permitir que el cortafuegos pueda navegar por Internet sudo nft add rule inet filter output oifname \"eth1\" ip protocol tcp tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth1\" ip protocol tcp tcp sport { 80,443 } ct state established counter accept Compruebo que funciona http: vagrant@perimetral:~$ telnet 52.47.209.216 80 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Compruebo que funciona https: vagrant@perimetral:~$ telnet 52.47.209.216 443 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'.","title":"Ejercicio 3"},{"location":"ej2-nftables-perimetral/#ejercicio-4","text":"Los equipos de la red local deben poder tener conexi\u00f3n al exterior Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan 2 cosas: SNAT Reglas forward para el tr\u00e1fico ICMP saliente Resumen de comandos para que funcione: sudo nft add rule inet nat postrouting oifname \"eth1\" ip saddr 192.168.100.0/24 counter masquerade sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 icmp type echo-request counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 icmp type echo-reply counter accept","title":"Ejercicio 4"},{"location":"ej2-nftables-perimetral/#ejercicio-5","text":"Tr\u00e1fico ssh saliente cortafuegos -> LAN Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo nft add rule inet filter output oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter input iifname \"eth2\" ip saddr 192.168.100.0/24 tcp sport 22 ct state established counter accept","title":"Ejercicio 5"},{"location":"ej2-nftables-perimetral/#ejercicio-6","text":"Permitir ping entrante LAN -> cortafuegos: sudo nft add rule inet filter input iifname \"eth2\" icmp type echo-request counter accept sudo nft add rule inet filter output oifname \"eth2\" icmp type echo-reply counter accept Pruebo que funciona: vagrant@local:~$ ping 192.168.100.2 PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data. 64 bytes from 192.168.100.2: icmp_seq=1 ttl=64 time=0.312 ms 64 bytes from 192.168.100.2: icmp_seq=2 ttl=64 time=0.539 ms ^C --- 192.168.100.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1006ms rtt min/avg/max/mdev = 0.312/0.425/0.539/0.113 ms","title":"Ejercicio 6"},{"location":"ej2-nftables-perimetral/#ejercicio-7","text":"Permitir tr\u00e1fico ssh al exterior desde la LAN sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp sport 22 ct state established counter accept Pruebo que funciona conectando a mi host para que atraviese el cortafuegos: vagrant@local:~$ ssh atlas@192.168.1.106 atlas@192.168.1.106's password: Linux olympus 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have new mail. Last login: Thu Feb 3 01:31:42 2022 from 192.168.1.114 atlas@olympus:~$","title":"Ejercicio 7"},{"location":"ej2-nftables-perimetral/#ejercicio-8","text":"Permitir acceso desde el exterior al servidor de correos de la LAN sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 25 counter accept sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp sport 25 counter accept sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 25 counter dnat ip to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ telnet 172.22.7.193 25 Trying 172.22.7.193... Connected to 172.22.7.193. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU) Permitir acceso desde el cortafuegos al servidor de correos de la LAN sudo nft add rule inet filter output ip daddr 192.168.100.3 tcp dport 25 counter accept sudo nft add rule inet filter input ip saddr 192.168.100.3 tcp sport 25 counter accept Pruebo que funciona desde el cortafuegos: vagrant@perimetral:~$ telnet 192.168.100.3 25 Trying 192.168.100.3... Connected to 192.168.100.3. Escape character is '^]'. 220 local ESMTP Postfix (Debian/GNU)","title":"Ejercicio 8"},{"location":"ej2-nftables-perimetral/#ejercicio-9","text":"Permitir tr\u00e1fico ssh desde el exterior a la LAN sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip daddr 192.168.100.0/24 tcp dport 22 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 tcp sport 22 ct state established counter accept sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 22 counter dnat ip to 192.168.100.3 Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ ssh vagrant@172.22.7.193 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Feb 3 07:37:45 2022 from 192.168.100.2 vagrant@local:~$","title":"Ejercicio 9"},{"location":"ej2-nftables-perimetral/#ejercicio-10","text":"Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22 sudo nft add rule inet nat prerouting iifname \"eth1\" tcp dport 2222 counter dnat ip to 192.168.100.3:22 Pruebo que funciona: atlas@olympus:~/vagrant/ej2-nftables-perimetral$ ssh -p 2222 vagrant@172.22.7.193 Linux local 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Feb 3 08:06:47 2022 from 172.22.9.227 vagrant@local:~$","title":"Ejercicio 10"},{"location":"ej2-nftables-perimetral/#ejercicio-11","text":"Permitir consultas DNS desde la LAN s\u00f3lo al servidor 192.168.202.2. Comprueba que no puedes hacer un dig @1.1.1.1 sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip saddr 192.168.100.0/24 ip daddr 192.168.202.2 udp dport 53 ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip saddr 192.168.202.2 ip daddr 192.168.100.0/24 udp sport 53 ct state established counter accept Pruebo que las consultas DNS a 192.168.202.2 funcionan: vagrant@local:~$ dig @192.168.202.2 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.202.2 www.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45511 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 5 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: e8ba7a0a4e288162253fa85561fb919daab6c9aee27df0e8 (good) ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 83378 IN A 93.184.216.34 ;; AUTHORITY SECTION: example.org. 82302 IN NS b.iana-servers.net. example.org. 82302 IN NS a.iana-servers.net. ;; ADDITIONAL SECTION: a.iana-servers.net. 82275 IN A 199.43.135.53 b.iana-servers.net. 82275 IN A 199.43.133.53 a.iana-servers.net. 82275 IN AAAA 2001:500:8f::53 b.iana-servers.net. 82275 IN AAAA 2001:500:8d::53 ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Thu Feb 03 08:26:05 UTC 2022 ;; MSG SIZE rcvd: 224 Pruebo que las consultas DNS a 1.1.1.1 no funcionan: vagrant@local:~$ dig @1.1.1.1 www.example.org ; <<>> DiG 9.16.15-Debian <<>> @1.1.1.1 www.example.org ; (1 server found) ;; global options: +cmd ;; connection timed out; no servers could be reached","title":"Ejercicio 11"},{"location":"ej2-nftables-perimetral/#ejercicio-12","text":"Permite que los equipos de la LAN puedan navegar por Internet Este paso ya se hizo en las preliminares as\u00ed que no lo repito. Se necesitan estas reglas: sudo nft add rule inet filter forward iifname \"eth2\" oifname \"eth1\" ip protocol tcp ip saddr 192.168.100.0/24 tcp dport { 80,443 } ct state new,established counter accept sudo nft add rule inet filter forward iifname \"eth1\" oifname \"eth2\" ip protocol tcp ip daddr 192.168.100.0/24 tcp sport { 80,443 } ct state established counter accept","title":"Ejercicio 12"},{"location":"ej2-reserva-dhcp/","text":"Ejercicio 2: Reserva DHCP ENTREGA Parte 1 Crear una reserva en 192.168.0.105 para cliente2 A\u00f1adir a /etc/dhcp/dhcpd.conf el siguiente bloque: host cliente2 { hardware ethernet 52:54:00:78:7e:d7; fixed-address 192.168.0.105; } Hay 2 \u00fanicos campos importantes: hardware ethernet : MAC de la interfaz en cliente2 a recibir la IP fija fixed-address : IP fija que recibir\u00e1 cliente2 Reiniciamos el servicio sudo systemctl restart isc-dhcp-server.service Parte 2 Hacer ip a en cliente2 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:78:7e:d7 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.0.105/24 brd 192.168.0.255 scope global dynamic eth1 valid_lft 3568sec preferred_lft 3568sec inet6 fe80::5054:ff:fe78:7ed7/64 scope link valid_lft forever preferred_lft forever Parte 3 \u00bfSe guarda una concesi\u00f3n en /var/lib/dhcp/dhcpd.leases para la reserva hecha? Como mostrar\u00e9 a continuaci\u00f3n en mi fichero: no, no se guarda . cat /var/lib/dhcp/dhcpd.leases # The format of this file is documented in the dhcpd.leases(5) manual page. # This lease file was written by isc-dhcp-4.4.1 # authoring-byte-order entry is generated, DO NOT DELETE authoring-byte-order little-endian; lease 192.168.0.100 { starts 1 2021/10/18 16:15:09; ends 1 2021/10/18 16:28:50; tstp 1 2021/10/18 16:28:50; cltt 1 2021/10/18 16:15:09; binding state free; hardware ethernet 52:54:00:ac:7b:64; uid \"\\377\\000\\254{d\\000\\001\\000\\001)\\000I\\365RT\\000\\254{d\"; } lease 192.168.0.102 { starts 1 2021/10/18 21:54:59; ends 1 2021/10/18 22:54:59; tstp 1 2021/10/18 22:54:59; cltt 1 2021/10/18 21:54:59; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:78:7e:d7; uid \"\\377\\000x~\\327\\000\\001\\000\\001)\\000\\251\\262RT\\000x~\\327\"; client-hostname \"cliente2\"; } lease 192.168.0.101 { starts 1 2021/10/18 22:00:32; ends 1 2021/10/18 23:00:32; tstp 1 2021/10/18 23:00:32; cltt 1 2021/10/18 22:00:32; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:ac:7b:64; client-hostname \"cliente\"; } server-duid \"\\000\\001\\000\\001)\\000\\255.RT\\000V\\3362\"; lease 192.168.0.102 { starts 1 2021/10/18 21:54:59; ends 1 2021/10/18 22:24:37; tstp 1 2021/10/18 22:24:37; cltt 1 2021/10/18 21:54:59; binding state free; hardware ethernet 52:54:00:78:7e:d7; uid \"\\377\\000x~\\327\\000\\001\\000\\001)\\000\\251\\262RT\\000x~\\327\"; } lease 192.168.0.101 { starts 1 2021/10/18 22:27:03; ends 1 2021/10/18 23:27:03; cltt 1 2021/10/18 22:27:03; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:ac:7b:64; client-hostname \"cliente\"; } La raz\u00f3n es que este fichero s\u00f3lo almacena las \" dynamic leases \", no las reservas . Escenario Cambios en Vagrantfile con respecto al escenario anterior en \"ejercicio 1 DHCP\": config.vm.define :cliente2 do |cliente2| cliente2.vm.box = \"debian/bullseye64\" cliente2.vm.hostname = \"cliente2\" cliente2.vm.network :private_network, :libvirt__network_name => \"ej1-dhcp\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end Realizaci\u00f3n Pedir nueva configuraci\u00f3n DHCP en cliente2 sudo dhclient -r eth1 sudo dhclient eth1","title":"Ejercicio 2: reservas"},{"location":"ej2-reserva-dhcp/#ejercicio-2-reserva-dhcp","text":"","title":"Ejercicio 2: Reserva DHCP"},{"location":"ej2-reserva-dhcp/#entrega","text":"","title":"ENTREGA"},{"location":"ej2-reserva-dhcp/#parte-1","text":"Crear una reserva en 192.168.0.105 para cliente2 A\u00f1adir a /etc/dhcp/dhcpd.conf el siguiente bloque: host cliente2 { hardware ethernet 52:54:00:78:7e:d7; fixed-address 192.168.0.105; } Hay 2 \u00fanicos campos importantes: hardware ethernet : MAC de la interfaz en cliente2 a recibir la IP fija fixed-address : IP fija que recibir\u00e1 cliente2 Reiniciamos el servicio sudo systemctl restart isc-dhcp-server.service","title":"Parte 1"},{"location":"ej2-reserva-dhcp/#parte-2","text":"Hacer ip a en cliente2 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:78:7e:d7 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.0.105/24 brd 192.168.0.255 scope global dynamic eth1 valid_lft 3568sec preferred_lft 3568sec inet6 fe80::5054:ff:fe78:7ed7/64 scope link valid_lft forever preferred_lft forever","title":"Parte 2"},{"location":"ej2-reserva-dhcp/#parte-3","text":"\u00bfSe guarda una concesi\u00f3n en /var/lib/dhcp/dhcpd.leases para la reserva hecha? Como mostrar\u00e9 a continuaci\u00f3n en mi fichero: no, no se guarda . cat /var/lib/dhcp/dhcpd.leases # The format of this file is documented in the dhcpd.leases(5) manual page. # This lease file was written by isc-dhcp-4.4.1 # authoring-byte-order entry is generated, DO NOT DELETE authoring-byte-order little-endian; lease 192.168.0.100 { starts 1 2021/10/18 16:15:09; ends 1 2021/10/18 16:28:50; tstp 1 2021/10/18 16:28:50; cltt 1 2021/10/18 16:15:09; binding state free; hardware ethernet 52:54:00:ac:7b:64; uid \"\\377\\000\\254{d\\000\\001\\000\\001)\\000I\\365RT\\000\\254{d\"; } lease 192.168.0.102 { starts 1 2021/10/18 21:54:59; ends 1 2021/10/18 22:54:59; tstp 1 2021/10/18 22:54:59; cltt 1 2021/10/18 21:54:59; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:78:7e:d7; uid \"\\377\\000x~\\327\\000\\001\\000\\001)\\000\\251\\262RT\\000x~\\327\"; client-hostname \"cliente2\"; } lease 192.168.0.101 { starts 1 2021/10/18 22:00:32; ends 1 2021/10/18 23:00:32; tstp 1 2021/10/18 23:00:32; cltt 1 2021/10/18 22:00:32; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:ac:7b:64; client-hostname \"cliente\"; } server-duid \"\\000\\001\\000\\001)\\000\\255.RT\\000V\\3362\"; lease 192.168.0.102 { starts 1 2021/10/18 21:54:59; ends 1 2021/10/18 22:24:37; tstp 1 2021/10/18 22:24:37; cltt 1 2021/10/18 21:54:59; binding state free; hardware ethernet 52:54:00:78:7e:d7; uid \"\\377\\000x~\\327\\000\\001\\000\\001)\\000\\251\\262RT\\000x~\\327\"; } lease 192.168.0.101 { starts 1 2021/10/18 22:27:03; ends 1 2021/10/18 23:27:03; cltt 1 2021/10/18 22:27:03; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:ac:7b:64; client-hostname \"cliente\"; } La raz\u00f3n es que este fichero s\u00f3lo almacena las \" dynamic leases \", no las reservas .","title":"Parte 3"},{"location":"ej2-reserva-dhcp/#escenario","text":"Cambios en Vagrantfile con respecto al escenario anterior en \"ejercicio 1 DHCP\": config.vm.define :cliente2 do |cliente2| cliente2.vm.box = \"debian/bullseye64\" cliente2.vm.hostname = \"cliente2\" cliente2.vm.network :private_network, :libvirt__network_name => \"ej1-dhcp\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end","title":"Escenario"},{"location":"ej2-reserva-dhcp/#realizacion","text":"Pedir nueva configuraci\u00f3n DHCP en cliente2 sudo dhclient -r eth1 sudo dhclient eth1","title":"Realizaci\u00f3n"},{"location":"ej2-router-nat-vagrant/","text":"ENUNCIADO El escenario a crear con Vagrant debe ser el siguiente: Router : red p\u00fablica (conectada a br0) + red privada (veryisolated). IP 10.0.0.1 en red privada. Cliente : interfaz en la misma red privada que router, IP 10.0.0.2. REALIZACI\u00d3N Configuraci\u00f3n de la red p\u00fablica KVM Creaci\u00f3n del bridge, y enlace de la interfaz f\u00edsica al mismo sudo ip link add br0 type bridge sudo ip link set enp4s0 master br0 Cambios en /etc/network/interfaces ### # Changes due to br0 public network config ### # Specify that the physical interface that should be connected to the bridge # should be configured manually, to avoid conflicts with NetworkManager iface enp4s0 inet manual # The br0 bridge settings iface br0 inet dhcp bridge_ports enp4s0 Levantamos el bridge sudo ifup br0 Estos son los cambios necesarios en el host. En el Vagrantfile a\u00f1adimos lo siguiente para que \"Router\" tenga una interfaz conectada a nuestro bridge (creando as\u00ed la interfaz p\u00fablica) router.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" Despu\u00e9s de hacer todo esto, deber\u00edamos tener una interfaz en \"Router\" con IP de nuestra red real. Si no consigui\u00e9ramos tener IP de la red real, tendr\u00edamos que hacer lo siguiente... En vagrant (una de las 2 opciones): vagrant destroy router vagrant reload router En nuestro host sudo systemctl restart networking ENTREGA Vagrantfile Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :router do |router| router.vm.box = \"debian/bullseye64\" router.vm.hostname = \"router\" router.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" router.vm.network :private_network, :libvirt__network_name => \"interna\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.1\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"interna\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end end Screenshot con ping cliente -> router Si queremos estar incluso m\u00e1s seguros de que el enlace funciona como deber\u00eda, hacemos lo siguiente As\u00ed nos aseguramos de que llegamos al destino por donde deber\u00eda, y no siguiendo un camino alternativo.","title":"Ejercicio 2: router NAT vagrant"},{"location":"ej2-router-nat-vagrant/#enunciado","text":"El escenario a crear con Vagrant debe ser el siguiente: Router : red p\u00fablica (conectada a br0) + red privada (veryisolated). IP 10.0.0.1 en red privada. Cliente : interfaz en la misma red privada que router, IP 10.0.0.2.","title":"ENUNCIADO"},{"location":"ej2-router-nat-vagrant/#realizacion","text":"","title":"REALIZACI\u00d3N"},{"location":"ej2-router-nat-vagrant/#configuracion-de-la-red-publica-kvm","text":"Creaci\u00f3n del bridge, y enlace de la interfaz f\u00edsica al mismo sudo ip link add br0 type bridge sudo ip link set enp4s0 master br0 Cambios en /etc/network/interfaces ### # Changes due to br0 public network config ### # Specify that the physical interface that should be connected to the bridge # should be configured manually, to avoid conflicts with NetworkManager iface enp4s0 inet manual # The br0 bridge settings iface br0 inet dhcp bridge_ports enp4s0 Levantamos el bridge sudo ifup br0 Estos son los cambios necesarios en el host. En el Vagrantfile a\u00f1adimos lo siguiente para que \"Router\" tenga una interfaz conectada a nuestro bridge (creando as\u00ed la interfaz p\u00fablica) router.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" Despu\u00e9s de hacer todo esto, deber\u00edamos tener una interfaz en \"Router\" con IP de nuestra red real. Si no consigui\u00e9ramos tener IP de la red real, tendr\u00edamos que hacer lo siguiente... En vagrant (una de las 2 opciones): vagrant destroy router vagrant reload router En nuestro host sudo systemctl restart networking","title":"Configuraci\u00f3n de la red p\u00fablica KVM"},{"location":"ej2-router-nat-vagrant/#entrega","text":"","title":"ENTREGA"},{"location":"ej2-router-nat-vagrant/#vagrantfile","text":"Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :router do |router| router.vm.box = \"debian/bullseye64\" router.vm.hostname = \"router\" router.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" router.vm.network :private_network, :libvirt__network_name => \"interna\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.1\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"interna\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end end","title":"Vagrantfile"},{"location":"ej2-router-nat-vagrant/#screenshot-con-ping-cliente-router","text":"Si queremos estar incluso m\u00e1s seguros de que el enlace funciona como deber\u00eda, hacemos lo siguiente As\u00ed nos aseguramos de que llegamos al destino por donde deber\u00eda, y no siguiendo un camino alternativo.","title":"Screenshot con ping cliente -&gt; router"},{"location":"ej3-apache-.htaccess/","text":"Ejercicio 3: Configuraci\u00f3n de Apache mediante .htaccess ENTREGA Parte 1 Captura del acceso a ej3-apache-htaccess.x10host.com/nas Parte 2 Entregar captura donde se muestre la redirecci\u00f3n de ej3-apache-htaccess.x10host.com/google a www.google.es Parte 3 Mostrar que funciona la autenticaci\u00f3n en ej3-apache-htaccess.x10host.com/prohibido EJERCICIOS Ejercicio 0 Si necesitamos configurar el servidor web del hosting, \u00bfqu\u00e9 podemos hacer? Usar ficheros .htaccess donde los necesitemos (se pueden usar varios en un mismo VirtualHost, pero siempre 1 s\u00f3lo por directorio) . \u00bfPara qu\u00e9 sirve la directiva AllowOverride de Apache? Permite el uso de ficheros .htaccess para sobreescribir la configuraci\u00f3n de Apache a partir de un directorio espec\u00edfico. Ejercicio 1 Habilitar Indexes en la URL ej3-apache-htaccess.x10host.com/nas Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/nas/.htaccess con el contenido: Options +Indexes Muestro que funciona: Ejercicio 2 Crear una redirecci\u00f3n permanente para ej3-apache-htaccess.x10host.com/google a www.google.es Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/.htaccess con el contenido: RedirectPermanent /google https://www.google.es/ Muestro que funciona: Ejercicio 3 Pedir autenticaci\u00f3n en ej3-apache-htaccess.x10host.com/prohibido Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/prohibido/.htpasswd : admin:$apr1$qh75ojvl$AhjZXOFVsd.5.zRlmVGDj0 El contenido est\u00e1 generado con https://hostingcanada.org/htpasswd-generator/ . Importante usar el modo \"Apache specific salted MD5\" , los m\u00e1s avanzados no funcionan con x10hosting. Las credenciales de acceso que he creado son: Username: admin Password: admin Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/prohibido/.htaccess con el contenido: AuthType Basic AuthName \"Access restricted\" AuthUserFile .htpasswd Require valid-user Muestro que funciona:","title":"Ejercicio 3: .htaccess con Apache"},{"location":"ej3-apache-.htaccess/#ejercicio-3-configuracion-de-apache-mediante-htaccess","text":"","title":"Ejercicio 3: Configuraci\u00f3n de Apache mediante .htaccess"},{"location":"ej3-apache-.htaccess/#entrega","text":"","title":"ENTREGA"},{"location":"ej3-apache-.htaccess/#parte-1","text":"Captura del acceso a ej3-apache-htaccess.x10host.com/nas","title":"Parte 1"},{"location":"ej3-apache-.htaccess/#parte-2","text":"Entregar captura donde se muestre la redirecci\u00f3n de ej3-apache-htaccess.x10host.com/google a www.google.es","title":"Parte 2"},{"location":"ej3-apache-.htaccess/#parte-3","text":"Mostrar que funciona la autenticaci\u00f3n en ej3-apache-htaccess.x10host.com/prohibido","title":"Parte 3"},{"location":"ej3-apache-.htaccess/#ejercicios","text":"","title":"EJERCICIOS"},{"location":"ej3-apache-.htaccess/#ejercicio-0","text":"Si necesitamos configurar el servidor web del hosting, \u00bfqu\u00e9 podemos hacer? Usar ficheros .htaccess donde los necesitemos (se pueden usar varios en un mismo VirtualHost, pero siempre 1 s\u00f3lo por directorio) . \u00bfPara qu\u00e9 sirve la directiva AllowOverride de Apache? Permite el uso de ficheros .htaccess para sobreescribir la configuraci\u00f3n de Apache a partir de un directorio espec\u00edfico.","title":"Ejercicio 0"},{"location":"ej3-apache-.htaccess/#ejercicio-1","text":"Habilitar Indexes en la URL ej3-apache-htaccess.x10host.com/nas Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/nas/.htaccess con el contenido: Options +Indexes Muestro que funciona:","title":"Ejercicio 1"},{"location":"ej3-apache-.htaccess/#ejercicio-2","text":"Crear una redirecci\u00f3n permanente para ej3-apache-htaccess.x10host.com/google a www.google.es Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/.htaccess con el contenido: RedirectPermanent /google https://www.google.es/ Muestro que funciona:","title":"Ejercicio 2"},{"location":"ej3-apache-.htaccess/#ejercicio-3","text":"Pedir autenticaci\u00f3n en ej3-apache-htaccess.x10host.com/prohibido Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/prohibido/.htpasswd : admin:$apr1$qh75ojvl$AhjZXOFVsd.5.zRlmVGDj0 El contenido est\u00e1 generado con https://hostingcanada.org/htpasswd-generator/ . Importante usar el modo \"Apache specific salted MD5\" , los m\u00e1s avanzados no funcionan con x10hosting. Las credenciales de acceso que he creado son: Username: admin Password: admin Creo el fichero /domains/ej3-apache-htaccess.x10host.com/public_html/prohibido/.htaccess con el contenido: AuthType Basic AuthName \"Access restricted\" AuthUserFile .htpasswd Require valid-user Muestro que funciona:","title":"Ejercicio 3"},{"location":"ej3-apache-uwsgi/","text":"Ejercicio 3: Desplegando aplicaciones flask con Apache/Nginx + uwsgi En esta tarea se usa la aplicaci\u00f3n Guestbook . Crear venv mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source bin/activate Descargar Guestbook sudo apt install git git clone https://github.com/josedom24/guestbook.git pip install -r requirements.txt sudo apt install redis Fichero wsgi /home/vagrant/guestbook/app/wsgi.py from app import prog as application Instalar uwsgi sudo apt install libpython3.9-dev build-essential pip install uwsgi Probar funcionamiento uwsgi --http :8080 --chdir /home/vagrant/guestbook/app --wsgi-file wsgi.py --process 4 --threads 2 --master Creo /home/vagrant/guestbook/app/guestbook.ini : [uwsgi] http = :8080 chdir = /home/vagrant/guestbook/app wsgi-file = wsgi.py processes = 4 threads = 2 Ejecuto: uwsgi guestbook.ini Pruebo que funciona: Crear unidad systemd /etc/systemd/system/uwsgi-guestbook.service : [Unit] Description=uwsgi-guestbook After=network.target [Install] WantedBy=multi-user.target [Service] User=www-data Group=www-data Restart=always ExecStart=/home/vagrant/venv/bin/uwsgi /home/vagrant/guestbook/app/guestbook.ini ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/home/vagrant/guestbook/app Environment=PYTHONPATH='/home/vagrant/guestbook/app:/home/vagrant/venv/lib/python3.9/site-packages' PrivateTmp=true La activo e inicio: sudo systemctl enable uwsgi-guestbook.service sudo systemctl start uwsgi-guestbook.service Pruebo que funciona: Apache + uWSGI sudo apt install apache2 sudo a2enmod proxy_http Creo /etc/apache2/sites-available/guestbook.conf : <VirtualHost *:80> ServerName www.guestbook-uwsgi.com DocumentRoot /home/vagrant/guestbook/app <Directory /home/vagrant/guestbook/app> Require all granted </Directory> ProxyPass / http://127.0.0.1:8080/ ProxyPassReverse / http://127.0.0.1:8080/ </VirtualHost> Lo habilito: sudo a2ensite guestbook.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej3-apache-nginx-uwsgi resolutions 192.168.121.93 www.guestbook-uwsgi.com Pruebo que funciona: Nginx + uWSGI sudo apt install nginx Creo /etc/nginx/sites-available/guestbook.conf : server { listen 80; server_name www.guestbook-uwsgi.com; root /home/vagrant/guestbook/app; location / { proxy_pass http://localhost:8080; include proxy_params; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/guestbook.conf /etc/nginx/sites-enabled Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona:","title":"Ejercicio 3: Apache/Nginx + uWSGI"},{"location":"ej3-apache-uwsgi/#ejercicio-3-desplegando-aplicaciones-flask-con-apachenginx-uwsgi","text":"En esta tarea se usa la aplicaci\u00f3n Guestbook .","title":"Ejercicio 3: Desplegando aplicaciones flask con Apache/Nginx + uwsgi"},{"location":"ej3-apache-uwsgi/#crear-venv","text":"mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source bin/activate","title":"Crear venv"},{"location":"ej3-apache-uwsgi/#descargar-guestbook","text":"sudo apt install git git clone https://github.com/josedom24/guestbook.git pip install -r requirements.txt sudo apt install redis","title":"Descargar Guestbook"},{"location":"ej3-apache-uwsgi/#fichero-wsgi","text":"/home/vagrant/guestbook/app/wsgi.py from app import prog as application","title":"Fichero wsgi"},{"location":"ej3-apache-uwsgi/#instalar-uwsgi","text":"sudo apt install libpython3.9-dev build-essential pip install uwsgi","title":"Instalar uwsgi"},{"location":"ej3-apache-uwsgi/#probar-funcionamiento","text":"uwsgi --http :8080 --chdir /home/vagrant/guestbook/app --wsgi-file wsgi.py --process 4 --threads 2 --master Creo /home/vagrant/guestbook/app/guestbook.ini : [uwsgi] http = :8080 chdir = /home/vagrant/guestbook/app wsgi-file = wsgi.py processes = 4 threads = 2 Ejecuto: uwsgi guestbook.ini Pruebo que funciona:","title":"Probar funcionamiento"},{"location":"ej3-apache-uwsgi/#crear-unidad-systemd","text":"/etc/systemd/system/uwsgi-guestbook.service : [Unit] Description=uwsgi-guestbook After=network.target [Install] WantedBy=multi-user.target [Service] User=www-data Group=www-data Restart=always ExecStart=/home/vagrant/venv/bin/uwsgi /home/vagrant/guestbook/app/guestbook.ini ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/home/vagrant/guestbook/app Environment=PYTHONPATH='/home/vagrant/guestbook/app:/home/vagrant/venv/lib/python3.9/site-packages' PrivateTmp=true La activo e inicio: sudo systemctl enable uwsgi-guestbook.service sudo systemctl start uwsgi-guestbook.service Pruebo que funciona:","title":"Crear unidad systemd"},{"location":"ej3-apache-uwsgi/#apache-uwsgi","text":"sudo apt install apache2 sudo a2enmod proxy_http Creo /etc/apache2/sites-available/guestbook.conf : <VirtualHost *:80> ServerName www.guestbook-uwsgi.com DocumentRoot /home/vagrant/guestbook/app <Directory /home/vagrant/guestbook/app> Require all granted </Directory> ProxyPass / http://127.0.0.1:8080/ ProxyPassReverse / http://127.0.0.1:8080/ </VirtualHost> Lo habilito: sudo a2ensite guestbook.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej3-apache-nginx-uwsgi resolutions 192.168.121.93 www.guestbook-uwsgi.com Pruebo que funciona:","title":"Apache + uWSGI"},{"location":"ej3-apache-uwsgi/#nginx-uwsgi","text":"sudo apt install nginx Creo /etc/nginx/sites-available/guestbook.conf : server { listen 80; server_name www.guestbook-uwsgi.com; root /home/vagrant/guestbook/app; location / { proxy_pass http://localhost:8080; include proxy_params; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/guestbook.conf /etc/nginx/sites-enabled Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona:","title":"Nginx + uWSGI"},{"location":"ej3-config-escenario-router-nat/","text":"EJ3: Configuraci\u00f3n del escenario router-nat ENTREGA Parte 1 Desde cliente hacer traceroute a nombre de una web vagrant@cliente:~$ traceroute www.example.org traceroute to www.example.org (93.184.216.34), 30 hops max, 60 byte packets 1 10.0.0.1 (10.0.0.1) 0.542 ms 0.459 ms 0.499 ms 2 Livebox (192.168.1.1) 14.445 ms 14.415 ms 16.238 ms 3 90.163.182.30 (90.163.182.30) 22.066 ms 22.038 ms 24.943 ms 4 10.255.120.1 (10.255.120.1) 33.108 ms 33.069 ms 29.791 ms 5 10.34.142.58 (10.34.142.58) 32.956 ms 10.34.142.62 (10.34.142.62) 40.640 ms 40.567 ms 6 10.34.149.130 (10.34.149.130) 45.527 ms 17.344 ms 10.34.149.134 (10.34.149.134) 19.203 ms 7 10.34.206.61 (10.34.206.61) 17.103 ms 25.263 ms 25.178 ms 8 bundle-ether101-14.madtr6.madrid.opentransit.net (193.251.249.1) 32.250 ms bundle-ether104-14.madtr5.madrid.opentransit.net (193.251.247.13) 37.302 ms 32.108 ms 9 telia-8.gw.opentransit.net (193.251.150.76) 32.050 ms 193.251.129.16 (193.251.129.16) 39.332 ms telia-8.gw.opentransit.net (193.251.150.76) 37.063 ms 10 prs-bb2-link.ip.twelve99.net (62.115.123.220) 131.479 ms 135.389 ms 137.604 ms 11 prs-bb2-link.ip.twelve99.net (62.115.123.220) 139.376 ms 143.863 ms ash-bb2-link.ip.twelve99.net (62.115.112.242) 120.468 ms 12 rest-bb1-link.ip.twelve99.net (62.115.122.159) 112.756 ms ash-b2-link.ip.twelve99.net (62.115.123.125) 135.059 ms ash-b2-link.ip.twelve99.net (62.115.123.123) 114.004 ms 13 ash-b2-link.ip.twelve99.net (62.115.123.125) 125.977 ms ash-b2-link.ip.twelve99.net (62.115.123.123) 118.836 ms verizon-ic342246-ash-b2.ip.twelve99-cust.net (62.115.175.71) 125.925 ms 14 verizon-ic-315152-ash-b1.ip.twelve99-cust.net (213.248.83.119) 128.754 ms 128.715 ms ae-66.core1.dcb.edgecastcdn.net (152.195.65.129) 128.692 ms 15 ae-65.core1.dcb.edgecastcdn.net (152.195.64.129) 135.092 ms ae-66.core1.dcb.edgecastcdn.net (152.195.65.129) 134.537 ms 128.926 ms 16 www.example.org (93.184.216.34) 134.311 ms 146.229 ms 139.666 ms Parte 2 Screenshot accediendo por ssh a las dos m\u00e1quinas con las condiciones: Nunca por eth0 Configurar las conexiones directas en ~/.ssh/config Elijo la manera de acceso a\u00f1adiendo mi clave ssh p\u00fablica personal a ambas m\u00e1quinas. He escrito lo siguiente en ~/.ssh/config # Conexiones ej3 config escenario router nat Host router HostName 192.168.1.132 User vagrant Host cliente HostName 10.0.0.2 User vagrant ProxyJump router Accedo a router: Accedo a cliente: Parte 3 Integrar el playbook de ansible en vagrant. Ense\u00f1ar funcionamiento a profesor. En el Vagrantfile, he a\u00f1adido lo siguiente: config.vm.provision \"ansible\" do |ansible| ansible.playbook = \"/home/atlas/Desktop/servicios/ud1-vagrant-ansible/ej3-config-escenario-router-nat/site.yaml\" end REALIZACI\u00d3N Crear playbook en ansible con los roles... Common Actualizar paquetes en ambos nodos - name: Actualizando paquetes... become: yes apt: update_cache=yes upgrade=yes Router Convertir en router-nat y cambiar salida por eth1. Ambas configuraciones deben ser persistentes. ### # Parte router-nat ### # M\u00f3dulo iptable_nat - name: Cargando el m\u00f3dulo iptable_nat... modprobe: name: iptable_nat state: present - name: Haciendo iptable_nat persistente... lineinfile: path: /etc/modules line: iptable_nat # Forwarding # # Necesario instalar plugin: # ansible-galaxy collection install ansible.posix - name: Habilitando ipv4 forwarding (persistente)... ansible.posix.sysctl: name: net.ipv4.ip_forward value: '1' sysctl_set: yes # Esta acci\u00f3n a\u00f1ade un 1 al fichero # /proc/sys/net/ipv4/ip_forward # # Tambi\u00e9n modifica el fichero # /etc/sysctl.conf # # y as\u00ed los cambios son persistentes # Iptables - name: A\u00f1adiendo regla iptable SNAT... command: iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o eth1 -j MASQUERADE - name: Instalando iptables-persistent... apt: name: iptables-persistent # Las reglas que hubiera, se guardan en /etc/iptables/rules.v4 # Este fichero se carga autom\u00e1ticamente en boot ### # Parte rutas ### - name: Borrando ruta por defecto... command: ip route del default - name: A\u00f1adiendo nueva ruta por defecto... command: ip route add default via 192.168.1.1 - name: Haciendo la ruta por defecto persistente... copy: src: interfaces-router dest: /etc/network/interfaces owner: root group: root mode: u=rw,g=r,o=r Cliente Cambiar salida por eth1 y que sea persistente - name: Borrando ruta por defecto... command: ip route del default - name: A\u00f1adiendo nueva ruta por defecto... command: ip route add default via 10.0.0.1 - name: Haciendo la ruta por defecto persistente... copy: src: interfaces-cliente dest: /etc/network/interfaces owner: root group: root mode: u=rw,g=r,o=r","title":"Ejercicio 3: Configuraci\u00f3n escenario router NAT"},{"location":"ej3-config-escenario-router-nat/#ej3-configuracion-del-escenario-router-nat","text":"","title":"EJ3: Configuraci\u00f3n del escenario router-nat"},{"location":"ej3-config-escenario-router-nat/#entrega","text":"","title":"ENTREGA"},{"location":"ej3-config-escenario-router-nat/#parte-1","text":"Desde cliente hacer traceroute a nombre de una web vagrant@cliente:~$ traceroute www.example.org traceroute to www.example.org (93.184.216.34), 30 hops max, 60 byte packets 1 10.0.0.1 (10.0.0.1) 0.542 ms 0.459 ms 0.499 ms 2 Livebox (192.168.1.1) 14.445 ms 14.415 ms 16.238 ms 3 90.163.182.30 (90.163.182.30) 22.066 ms 22.038 ms 24.943 ms 4 10.255.120.1 (10.255.120.1) 33.108 ms 33.069 ms 29.791 ms 5 10.34.142.58 (10.34.142.58) 32.956 ms 10.34.142.62 (10.34.142.62) 40.640 ms 40.567 ms 6 10.34.149.130 (10.34.149.130) 45.527 ms 17.344 ms 10.34.149.134 (10.34.149.134) 19.203 ms 7 10.34.206.61 (10.34.206.61) 17.103 ms 25.263 ms 25.178 ms 8 bundle-ether101-14.madtr6.madrid.opentransit.net (193.251.249.1) 32.250 ms bundle-ether104-14.madtr5.madrid.opentransit.net (193.251.247.13) 37.302 ms 32.108 ms 9 telia-8.gw.opentransit.net (193.251.150.76) 32.050 ms 193.251.129.16 (193.251.129.16) 39.332 ms telia-8.gw.opentransit.net (193.251.150.76) 37.063 ms 10 prs-bb2-link.ip.twelve99.net (62.115.123.220) 131.479 ms 135.389 ms 137.604 ms 11 prs-bb2-link.ip.twelve99.net (62.115.123.220) 139.376 ms 143.863 ms ash-bb2-link.ip.twelve99.net (62.115.112.242) 120.468 ms 12 rest-bb1-link.ip.twelve99.net (62.115.122.159) 112.756 ms ash-b2-link.ip.twelve99.net (62.115.123.125) 135.059 ms ash-b2-link.ip.twelve99.net (62.115.123.123) 114.004 ms 13 ash-b2-link.ip.twelve99.net (62.115.123.125) 125.977 ms ash-b2-link.ip.twelve99.net (62.115.123.123) 118.836 ms verizon-ic342246-ash-b2.ip.twelve99-cust.net (62.115.175.71) 125.925 ms 14 verizon-ic-315152-ash-b1.ip.twelve99-cust.net (213.248.83.119) 128.754 ms 128.715 ms ae-66.core1.dcb.edgecastcdn.net (152.195.65.129) 128.692 ms 15 ae-65.core1.dcb.edgecastcdn.net (152.195.64.129) 135.092 ms ae-66.core1.dcb.edgecastcdn.net (152.195.65.129) 134.537 ms 128.926 ms 16 www.example.org (93.184.216.34) 134.311 ms 146.229 ms 139.666 ms","title":"Parte 1"},{"location":"ej3-config-escenario-router-nat/#parte-2","text":"Screenshot accediendo por ssh a las dos m\u00e1quinas con las condiciones: Nunca por eth0 Configurar las conexiones directas en ~/.ssh/config Elijo la manera de acceso a\u00f1adiendo mi clave ssh p\u00fablica personal a ambas m\u00e1quinas. He escrito lo siguiente en ~/.ssh/config # Conexiones ej3 config escenario router nat Host router HostName 192.168.1.132 User vagrant Host cliente HostName 10.0.0.2 User vagrant ProxyJump router Accedo a router: Accedo a cliente:","title":"Parte 2"},{"location":"ej3-config-escenario-router-nat/#parte-3","text":"Integrar el playbook de ansible en vagrant. Ense\u00f1ar funcionamiento a profesor. En el Vagrantfile, he a\u00f1adido lo siguiente: config.vm.provision \"ansible\" do |ansible| ansible.playbook = \"/home/atlas/Desktop/servicios/ud1-vagrant-ansible/ej3-config-escenario-router-nat/site.yaml\" end","title":"Parte 3"},{"location":"ej3-config-escenario-router-nat/#realizacion","text":"Crear playbook en ansible con los roles...","title":"REALIZACI\u00d3N"},{"location":"ej3-config-escenario-router-nat/#common","text":"Actualizar paquetes en ambos nodos - name: Actualizando paquetes... become: yes apt: update_cache=yes upgrade=yes","title":"Common"},{"location":"ej3-config-escenario-router-nat/#router","text":"Convertir en router-nat y cambiar salida por eth1. Ambas configuraciones deben ser persistentes. ### # Parte router-nat ### # M\u00f3dulo iptable_nat - name: Cargando el m\u00f3dulo iptable_nat... modprobe: name: iptable_nat state: present - name: Haciendo iptable_nat persistente... lineinfile: path: /etc/modules line: iptable_nat # Forwarding # # Necesario instalar plugin: # ansible-galaxy collection install ansible.posix - name: Habilitando ipv4 forwarding (persistente)... ansible.posix.sysctl: name: net.ipv4.ip_forward value: '1' sysctl_set: yes # Esta acci\u00f3n a\u00f1ade un 1 al fichero # /proc/sys/net/ipv4/ip_forward # # Tambi\u00e9n modifica el fichero # /etc/sysctl.conf # # y as\u00ed los cambios son persistentes # Iptables - name: A\u00f1adiendo regla iptable SNAT... command: iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o eth1 -j MASQUERADE - name: Instalando iptables-persistent... apt: name: iptables-persistent # Las reglas que hubiera, se guardan en /etc/iptables/rules.v4 # Este fichero se carga autom\u00e1ticamente en boot ### # Parte rutas ### - name: Borrando ruta por defecto... command: ip route del default - name: A\u00f1adiendo nueva ruta por defecto... command: ip route add default via 192.168.1.1 - name: Haciendo la ruta por defecto persistente... copy: src: interfaces-router dest: /etc/network/interfaces owner: root group: root mode: u=rw,g=r,o=r","title":"Router"},{"location":"ej3-config-escenario-router-nat/#cliente","text":"Cambiar salida por eth1 y que sea persistente - name: Borrando ruta por defecto... command: ip route del default - name: A\u00f1adiendo nueva ruta por defecto... command: ip route add default via 10.0.0.1 - name: Haciendo la ruta por defecto persistente... copy: src: interfaces-cliente dest: /etc/network/interfaces owner: root group: root mode: u=rw,g=r,o=r","title":"Cliente"},{"location":"ej3-delegacion-subdominio-bind9/","text":"Ejercicio 3: Delegaci\u00f3n de subdominios con bind9 Entrega Realizar las siguientes consultas desde cliente. Parte 1 dig www.informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> www.informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45194 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 4b05b345b807917401000000619ad9b4073217deccc47a09 (good) ;; QUESTION SECTION: ;www.informatica.iesgn.org. IN A ;; ANSWER SECTION: www.informatica.iesgn.org. 86400 IN CNAME sweb.informatica.iesgn.org. sweb.informatica.iesgn.org. 86400 IN A 10.0.0.52 ;; Query time: 96 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:43:48 UTC 2021 ;; MSG SIZE rcvd: 117 dig ftp.informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> ftp.informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 31505 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 7897922eed5f0acb01000000619ada1198bb5211fb4cf940 (good) ;; QUESTION SECTION: ;ftp.informatica.iesgn.org. IN A ;; ANSWER SECTION: ftp.informatica.iesgn.org. 86400 IN CNAME sweb.informatica.iesgn.org. sweb.informatica.iesgn.org. 86307 IN A 10.0.0.52 ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:45:21 UTC 2021 ;; MSG SIZE rcvd: 117 Parte 2 dig NS informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> NS informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 48818 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 0056b02be3bb838301000000619adae91b06c7f48ca54b49 (good) ;; QUESTION SECTION: ;informatica.iesgn.org. IN NS ;; ANSWER SECTION: informatica.iesgn.org. 86400 IN NS adrianj-ns.informatica.iesgn.org. ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:48:57 UTC 2021 ;; MSG SIZE rcvd: 103 \u00bfEs el mismo que el servidor DNS con autoridad para la zona iesgn.org ? dig NS iesgn.org ; <<>> DiG 9.16.22-Debian <<>> NS iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36865 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 3 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 7a0344b5113fcb0b01000000619adb55de76d31d7232e8de (good) ;; QUESTION SECTION: ;iesgn.org. IN NS ;; ANSWER SECTION: iesgn.org. 86400 IN NS adrianj.iesgn.org. iesgn.org. 86400 IN NS jaramillor.iesgn.org. ;; ADDITIONAL SECTION: adrianj.iesgn.org. 86400 IN A 10.0.0.2 jaramillor.iesgn.org. 86400 IN A 10.0.0.10 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:50:45 UTC 2021 ;; MSG SIZE rcvd: 145 No, no son los mismos servidores DNS. Parte 3 dig MX informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> MX informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22488 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 838d443349ddf15a01000000619adbeb9351de6157a5e8fa (good) ;; QUESTION SECTION: ;informatica.iesgn.org. IN MX ;; ANSWER SECTION: informatica.iesgn.org. 86400 IN MX 10 correo.informatica.iesgn.org. ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:53:15 UTC 2021 ;; MSG SIZE rcvd: 101 Realizaci\u00f3n Este ejercicio parte del escenario usado en Ejercicio 2: Slave DNS . Se delegar\u00e1 el subdominio informatica.iesgn.org a adrianj-ns.informatica.iesgn.org (se encuentra en otra m\u00e1quina) Ejercicio 1 A\u00f1adir otra m\u00e1quina al escenario del ej2, para instalar ah\u00ed el DNS al que delegaremos el subdominio Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :server do |server| server.vm.box = \"debian/bullseye64\" server.vm.hostname = \"server\" server.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :slavedns do |slavedns| slavedns.vm.box = \"debian/bullseye64\" slavedns.vm.hostname = \"slavedns\" slavedns.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.10\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :subdominio do |subdominio| subdominio.vm.box = \"debian/bullseye64\" subdominio.vm.hostname = \"subdominio\" subdominio.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.50\", :libvirt__forward_mode => \"veryisolated\" end end Ejercicio 2 Cambiar el hostname de subdominio a: adrianj-ns.informatica.iesgn.org Modifico /etc/hostname : vagrant@subdominio:~$ cat /etc/hostname adrianj-ns Hago que el cambio de hostname tome efecto ahora: sudo hostname adrianj-ns Verifico: vagrant@subdominio:~$ hostname adrianj-ns Actualizo el prompt: vagrant@subdominio:~$ bash vagrant@adrianj-ns:~$ Modifico /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 adrianj-ns.informatica.iesgn.org adrianj-ns Compruebo nombre largo: vagrant@adrianj-ns:~$ hostname -f adrianj-ns.informatica.iesgn.org Compruebo nombre corto: vagrant@adrianj-ns:~$ ping adrianj-ns -c 1 PING adrianj-ns.informatica.iesgn.org (127.0.1.1) 56(84) bytes of data. 64 bytes from adrianj-ns.informatica.iesgn.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.015 ms --- adrianj-ns.informatica.iesgn.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.015/0.015/0.015/0.000 ms Ejercicio 3 Instalar bind9 sudo apt update sudo apt install bind9 Ejercicio 4 A\u00f1adir la delegaci\u00f3n de informatica.iesgn.org en adrianj.iesgn.org db.iesgn.org : $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062505 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 jaramillor IN A 10.0.0.10 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.6 cliente4 IN A 10.0.0.7 www IN CNAME adrianj departamentos IN CNAME adrianj ; Definici\u00f3n de subdominio $ORIGIN informatica.iesgn.org. @ IN NS adrianj-ns.informatica.iesgn.org. adrianj-ns IN A 10.0.0.50 ; glue record Reinicio: sudo systemctl restart bind9 Ejercicio 5 Definir la zona informatica.iesgn.org en adrianj-ns named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization // include \"/etc/bind/zones.rfc1918\"; zone \"informatica.iesgn.org\" { type master; file \"/etc/bind/db.informatica.iesgn.org\"; }; Ejercicio 6 Definir zona directa para informatica.iesgn.org db.informatica.iesgn.org : $ORIGIN informatica.iesgn.org. $TTL 86400 @ IN SOA adrianj-ns.informatica.iesgn.org. admin.informatica.iesgn.org. ( 2001062505 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj-ns.informatica.iesgn.org. @ IN MX 10 correo.informatica.iesgn.org. adrianj-ns IN A 10.0.0.50 correo IN A 10.0.0.51 sweb IN A 10.0.0.52 www IN CNAME sweb ftp IN CNAME sweb Reinicio: sudo systemctl restart bind9 Ejercicio 7 Actualizar la zona inversa en adrianj.iesgn.org con las nuevas m\u00e1quinas del subdominio db.10.0.0 : $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062502 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. 2 IN PTR adrianj.iesgn.org. 10 IN PTR jaramillor.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 6 IN PTR cliente3.iesgn.org. ; M\u00e1quinas del subdominio 50 IN PTR adrianj-ns.informatica.iesgn.org. 51 IN PTR correo.informatica.iesgn.org. 52 IN PTR sweb.informatica.iesgn.org. Reinicio: sudo systemctl restart bind9","title":"Ejercicio 3: Delegaci\u00f3n subdominios"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-3-delegacion-de-subdominios-con-bind9","text":"","title":"Ejercicio 3: Delegaci\u00f3n de subdominios con bind9"},{"location":"ej3-delegacion-subdominio-bind9/#entrega","text":"Realizar las siguientes consultas desde cliente.","title":"Entrega"},{"location":"ej3-delegacion-subdominio-bind9/#parte-1","text":"dig www.informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> www.informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45194 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 4b05b345b807917401000000619ad9b4073217deccc47a09 (good) ;; QUESTION SECTION: ;www.informatica.iesgn.org. IN A ;; ANSWER SECTION: www.informatica.iesgn.org. 86400 IN CNAME sweb.informatica.iesgn.org. sweb.informatica.iesgn.org. 86400 IN A 10.0.0.52 ;; Query time: 96 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:43:48 UTC 2021 ;; MSG SIZE rcvd: 117 dig ftp.informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> ftp.informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 31505 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 7897922eed5f0acb01000000619ada1198bb5211fb4cf940 (good) ;; QUESTION SECTION: ;ftp.informatica.iesgn.org. IN A ;; ANSWER SECTION: ftp.informatica.iesgn.org. 86400 IN CNAME sweb.informatica.iesgn.org. sweb.informatica.iesgn.org. 86307 IN A 10.0.0.52 ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:45:21 UTC 2021 ;; MSG SIZE rcvd: 117","title":"Parte 1"},{"location":"ej3-delegacion-subdominio-bind9/#parte-2","text":"dig NS informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> NS informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 48818 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 0056b02be3bb838301000000619adae91b06c7f48ca54b49 (good) ;; QUESTION SECTION: ;informatica.iesgn.org. IN NS ;; ANSWER SECTION: informatica.iesgn.org. 86400 IN NS adrianj-ns.informatica.iesgn.org. ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:48:57 UTC 2021 ;; MSG SIZE rcvd: 103 \u00bfEs el mismo que el servidor DNS con autoridad para la zona iesgn.org ? dig NS iesgn.org ; <<>> DiG 9.16.22-Debian <<>> NS iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36865 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 3 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 7a0344b5113fcb0b01000000619adb55de76d31d7232e8de (good) ;; QUESTION SECTION: ;iesgn.org. IN NS ;; ANSWER SECTION: iesgn.org. 86400 IN NS adrianj.iesgn.org. iesgn.org. 86400 IN NS jaramillor.iesgn.org. ;; ADDITIONAL SECTION: adrianj.iesgn.org. 86400 IN A 10.0.0.2 jaramillor.iesgn.org. 86400 IN A 10.0.0.10 ;; Query time: 0 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:50:45 UTC 2021 ;; MSG SIZE rcvd: 145 No, no son los mismos servidores DNS.","title":"Parte 2"},{"location":"ej3-delegacion-subdominio-bind9/#parte-3","text":"dig MX informatica.iesgn.org ; <<>> DiG 9.16.22-Debian <<>> MX informatica.iesgn.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22488 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 838d443349ddf15a01000000619adbeb9351de6157a5e8fa (good) ;; QUESTION SECTION: ;informatica.iesgn.org. IN MX ;; ANSWER SECTION: informatica.iesgn.org. 86400 IN MX 10 correo.informatica.iesgn.org. ;; Query time: 4 msec ;; SERVER: 10.0.0.2#53(10.0.0.2) ;; WHEN: Sun Nov 21 23:53:15 UTC 2021 ;; MSG SIZE rcvd: 101","title":"Parte 3"},{"location":"ej3-delegacion-subdominio-bind9/#realizacion","text":"Este ejercicio parte del escenario usado en Ejercicio 2: Slave DNS . Se delegar\u00e1 el subdominio informatica.iesgn.org a adrianj-ns.informatica.iesgn.org (se encuentra en otra m\u00e1quina)","title":"Realizaci\u00f3n"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-1","text":"A\u00f1adir otra m\u00e1quina al escenario del ej2, para instalar ah\u00ed el DNS al que delegaremos el subdominio Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :server do |server| server.vm.box = \"debian/bullseye64\" server.vm.hostname = \"server\" server.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :cliente do |cliente| cliente.vm.box = \"debian/bullseye64\" cliente.vm.hostname = \"cliente\" cliente.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :slavedns do |slavedns| slavedns.vm.box = \"debian/bullseye64\" slavedns.vm.hostname = \"slavedns\" slavedns.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.10\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :subdominio do |subdominio| subdominio.vm.box = \"debian/bullseye64\" subdominio.vm.hostname = \"subdominio\" subdominio.vm.network :private_network, :libvirt__network_name => \"ej1bind9\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.50\", :libvirt__forward_mode => \"veryisolated\" end end","title":"Ejercicio 1"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-2","text":"Cambiar el hostname de subdominio a: adrianj-ns.informatica.iesgn.org Modifico /etc/hostname : vagrant@subdominio:~$ cat /etc/hostname adrianj-ns Hago que el cambio de hostname tome efecto ahora: sudo hostname adrianj-ns Verifico: vagrant@subdominio:~$ hostname adrianj-ns Actualizo el prompt: vagrant@subdominio:~$ bash vagrant@adrianj-ns:~$ Modifico /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 adrianj-ns.informatica.iesgn.org adrianj-ns Compruebo nombre largo: vagrant@adrianj-ns:~$ hostname -f adrianj-ns.informatica.iesgn.org Compruebo nombre corto: vagrant@adrianj-ns:~$ ping adrianj-ns -c 1 PING adrianj-ns.informatica.iesgn.org (127.0.1.1) 56(84) bytes of data. 64 bytes from adrianj-ns.informatica.iesgn.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.015 ms --- adrianj-ns.informatica.iesgn.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.015/0.015/0.015/0.000 ms","title":"Ejercicio 2"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-3","text":"Instalar bind9 sudo apt update sudo apt install bind9","title":"Ejercicio 3"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-4","text":"A\u00f1adir la delegaci\u00f3n de informatica.iesgn.org en adrianj.iesgn.org db.iesgn.org : $ORIGIN iesgn.org. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062505 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. @ IN MX 10 correo.iesgn.org. adrianj IN A 10.0.0.2 jaramillor IN A 10.0.0.10 correo IN A 10.0.0.200 ftp IN A 10.0.0.201 cliente1 IN A 10.0.0.3 cliente2 IN A 10.0.0.4 cliente3 IN A 10.0.0.6 cliente4 IN A 10.0.0.7 www IN CNAME adrianj departamentos IN CNAME adrianj ; Definici\u00f3n de subdominio $ORIGIN informatica.iesgn.org. @ IN NS adrianj-ns.informatica.iesgn.org. adrianj-ns IN A 10.0.0.50 ; glue record Reinicio: sudo systemctl restart bind9","title":"Ejercicio 4"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-5","text":"Definir la zona informatica.iesgn.org en adrianj-ns named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization // include \"/etc/bind/zones.rfc1918\"; zone \"informatica.iesgn.org\" { type master; file \"/etc/bind/db.informatica.iesgn.org\"; };","title":"Ejercicio 5"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-6","text":"Definir zona directa para informatica.iesgn.org db.informatica.iesgn.org : $ORIGIN informatica.iesgn.org. $TTL 86400 @ IN SOA adrianj-ns.informatica.iesgn.org. admin.informatica.iesgn.org. ( 2001062505 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj-ns.informatica.iesgn.org. @ IN MX 10 correo.informatica.iesgn.org. adrianj-ns IN A 10.0.0.50 correo IN A 10.0.0.51 sweb IN A 10.0.0.52 www IN CNAME sweb ftp IN CNAME sweb Reinicio: sudo systemctl restart bind9","title":"Ejercicio 6"},{"location":"ej3-delegacion-subdominio-bind9/#ejercicio-7","text":"Actualizar la zona inversa en adrianj.iesgn.org con las nuevas m\u00e1quinas del subdominio db.10.0.0 : $ORIGIN 0.0.10.in-addr.arpa. $TTL 86400 @ IN SOA adrianj.iesgn.org. admin.iesgn.org. ( 2001062502 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS adrianj.iesgn.org. @ IN NS jaramillor.iesgn.org. 2 IN PTR adrianj.iesgn.org. 10 IN PTR jaramillor.iesgn.org. 200 IN PTR correo.iesgn.org. 201 IN PTR ftp.iesgn.org. 3 IN PTR cliente1.iesgn.org. 4 IN PTR cliente2.iesgn.org. 6 IN PTR cliente3.iesgn.org. ; M\u00e1quinas del subdominio 50 IN PTR adrianj-ns.informatica.iesgn.org. 51 IN PTR correo.informatica.iesgn.org. 52 IN PTR sweb.informatica.iesgn.org. Reinicio: sudo systemctl restart bind9","title":"Ejercicio 7"},{"location":"ej3-phpfpm/","text":"Ejercicio 3: Ejecuci\u00f3n de PHP con PHP-FPM ENTREGA Parte 1 Captura para comprobar que se est\u00e1n ejecutando procesos php-fpm Mediante top : Mediante systemctl : Parte 2 Configurar Apache para que utilice php-fpm Activo el m\u00f3dulo: sudo a2enmod proxy_fcgi Activo la configuraci\u00f3n php-fpm global: sudo a2enconf php7.4-fpm Reinicio apache: sudo systemctl restart apache2 Parte 3 Captura de info.php donde se vea que se utiliza php-fpm Parte 4 Captura de phpBB funcionando Captura de ConcreteCMS funcionando Parte 5 Hacer que php-fpm escuche por socket TCP Modificar /etc/php/7.4/fpm/pool.d/www.conf : listen = 127.0.0.1:9000 Reiniciar php-fpm: sudo systemctl restart php7.4-fpm.service Hacer que Apache se comunique con php-fpm por socket TCP Modificar /etc/apache2/conf-available/php7.4-fpm.conf : <FilesMatch \".+\\.ph(ar|p|tml)$\"> SetHandler \"proxy:fcgi://127.0.0.1:9000/\" </FilesMatch> Reiniciar Apache: sudo systemctl restart apache2.service Parte 6 Indicar el fichero modificado para cambiar el memory_limit /etc/php/7.4/fpm/php.ini Captura de info.php donde se vea el cambio REALIZACI\u00d3N Los siguientes pasos se realizan sobre el escenario de la pr\u00e1ctica \"Implantaci\u00f3n de aplicaciones web php\". Paso 1 Desinstalar el m\u00f3dulo de apache que permite ejecutar PHP sudo apt purge libapache2-mod-php7.4 Sabemos que ha surtido efecto porque al probar nuestra web, no funciona y ahora nos devuelve c\u00f3digo php en crudo: Paso 2 Instalar php-fpm sudo apt install php7.4-fpm Paso 3 Configurar Apache para que utilice php-fpm globalmente (para todos los VirtualHost) Activo el m\u00f3dulo: sudo a2enmod proxy_fcgi Activo la configuraci\u00f3n php-fpm global: sudo a2enconf php7.4-fpm Reinicio apache: sudo systemctl restart apache2 Paso 4 Acceder a un info.php para comprobar que se est\u00e1 usando php-fpm En el DocumentRoot de phpBB me descargo un info.php : sudo wget https://gist.githubusercontent.com/carlosomarsuarez/9c7860d74535f4f0960e/raw/ac8170c4142933a48fd7ed8b88eb9d4f190ec32c/info.php Accedo al fichero: Comprobar que phpBB sigue funcionando Comprobar que ConcreteCMS sigue funcionando Paso 5 Hacer que php-fpm escuche por socket TCP Modificar /etc/php/7.4/fpm/pool.d/www.conf : listen = 127.0.0.1:9000 Reiniciar php-fpm: sudo systemctl restart php7.4-fpm.service Hacer que Apache se comunique con php-fpm por socket TCP Modificar /etc/apache2/conf-available/php7.4-fpm.conf : <FilesMatch \".+\\.ph(ar|p|tml)$\"> SetHandler \"proxy:fcgi://127.0.0.1:9000/\" </FilesMatch> Reiniciar Apache: sudo systemctl restart apache2.service Paso 6 Comprobar que phpBB sigue funcionando Comprobar que ConcreteCMS sigue funcionando Paso 7 Cambiar el memory_limit de php-fpm a 256M Modificar /etc/php/7.4/fpm/php.ini : memory_limit = 256M Reiniciar php-fpm: sudo systemctl restart php7.4-fpm.service Comprobamos que el cambio haya tomado efecto mirando el info.php :","title":"Ejercicio 3: php-fpm"},{"location":"ej3-phpfpm/#ejercicio-3-ejecucion-de-php-con-php-fpm","text":"","title":"Ejercicio 3: Ejecuci\u00f3n de PHP con PHP-FPM"},{"location":"ej3-phpfpm/#entrega","text":"","title":"ENTREGA"},{"location":"ej3-phpfpm/#parte-1","text":"Captura para comprobar que se est\u00e1n ejecutando procesos php-fpm Mediante top : Mediante systemctl :","title":"Parte 1"},{"location":"ej3-phpfpm/#parte-2","text":"Configurar Apache para que utilice php-fpm Activo el m\u00f3dulo: sudo a2enmod proxy_fcgi Activo la configuraci\u00f3n php-fpm global: sudo a2enconf php7.4-fpm Reinicio apache: sudo systemctl restart apache2","title":"Parte 2"},{"location":"ej3-phpfpm/#parte-3","text":"Captura de info.php donde se vea que se utiliza php-fpm","title":"Parte 3"},{"location":"ej3-phpfpm/#parte-4","text":"Captura de phpBB funcionando Captura de ConcreteCMS funcionando","title":"Parte 4"},{"location":"ej3-phpfpm/#parte-5","text":"Hacer que php-fpm escuche por socket TCP Modificar /etc/php/7.4/fpm/pool.d/www.conf : listen = 127.0.0.1:9000 Reiniciar php-fpm: sudo systemctl restart php7.4-fpm.service Hacer que Apache se comunique con php-fpm por socket TCP Modificar /etc/apache2/conf-available/php7.4-fpm.conf : <FilesMatch \".+\\.ph(ar|p|tml)$\"> SetHandler \"proxy:fcgi://127.0.0.1:9000/\" </FilesMatch> Reiniciar Apache: sudo systemctl restart apache2.service","title":"Parte 5"},{"location":"ej3-phpfpm/#parte-6","text":"Indicar el fichero modificado para cambiar el memory_limit /etc/php/7.4/fpm/php.ini Captura de info.php donde se vea el cambio","title":"Parte 6"},{"location":"ej3-phpfpm/#realizacion","text":"Los siguientes pasos se realizan sobre el escenario de la pr\u00e1ctica \"Implantaci\u00f3n de aplicaciones web php\".","title":"REALIZACI\u00d3N"},{"location":"ej3-phpfpm/#paso-1","text":"Desinstalar el m\u00f3dulo de apache que permite ejecutar PHP sudo apt purge libapache2-mod-php7.4 Sabemos que ha surtido efecto porque al probar nuestra web, no funciona y ahora nos devuelve c\u00f3digo php en crudo:","title":"Paso 1"},{"location":"ej3-phpfpm/#paso-2","text":"Instalar php-fpm sudo apt install php7.4-fpm","title":"Paso 2"},{"location":"ej3-phpfpm/#paso-3","text":"Configurar Apache para que utilice php-fpm globalmente (para todos los VirtualHost) Activo el m\u00f3dulo: sudo a2enmod proxy_fcgi Activo la configuraci\u00f3n php-fpm global: sudo a2enconf php7.4-fpm Reinicio apache: sudo systemctl restart apache2","title":"Paso 3"},{"location":"ej3-phpfpm/#paso-4","text":"Acceder a un info.php para comprobar que se est\u00e1 usando php-fpm En el DocumentRoot de phpBB me descargo un info.php : sudo wget https://gist.githubusercontent.com/carlosomarsuarez/9c7860d74535f4f0960e/raw/ac8170c4142933a48fd7ed8b88eb9d4f190ec32c/info.php Accedo al fichero: Comprobar que phpBB sigue funcionando Comprobar que ConcreteCMS sigue funcionando","title":"Paso 4"},{"location":"ej3-phpfpm/#paso-5","text":"Hacer que php-fpm escuche por socket TCP Modificar /etc/php/7.4/fpm/pool.d/www.conf : listen = 127.0.0.1:9000 Reiniciar php-fpm: sudo systemctl restart php7.4-fpm.service Hacer que Apache se comunique con php-fpm por socket TCP Modificar /etc/apache2/conf-available/php7.4-fpm.conf : <FilesMatch \".+\\.ph(ar|p|tml)$\"> SetHandler \"proxy:fcgi://127.0.0.1:9000/\" </FilesMatch> Reiniciar Apache: sudo systemctl restart apache2.service","title":"Paso 5"},{"location":"ej3-phpfpm/#paso-6","text":"Comprobar que phpBB sigue funcionando Comprobar que ConcreteCMS sigue funcionando","title":"Paso 6"},{"location":"ej3-phpfpm/#paso-7","text":"Cambiar el memory_limit de php-fpm a 256M Modificar /etc/php/7.4/fpm/php.ini : memory_limit = 256M Reiniciar php-fpm: sudo systemctl restart php7.4-fpm.service Comprobamos que el cambio haya tomado efecto mirando el info.php :","title":"Paso 7"},{"location":"ej4-modulos-apache/","text":"Ejercicio 4: M\u00f3dulos en Apache mod_userdir Este m\u00f3dulo permite que cada usuario aloje su web en un directorio ( public_html por defecto). Entrega Parte 1 Mostrar la configuraci\u00f3n de mod_userdir donde se vea el cambio de nombre del directorio public_html por sitio_web Modifico /etc/apache2/mods-available/userdir.conf : <IfModule mod_userdir.c> UserDir sitio_web UserDir disabled root <Directory /home/*/sitio_web> AllowOverride FileInfo AuthConfig Limit Indexes Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec Require method GET POST OPTIONS </Directory> </IfModule> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Parte 2 Captura donde se vea el acceso a la p\u00e1gina personal de vagrant Ejercicios Ejercicio 1 Activar el m\u00f3dulo sudo a2enmod userdir Reinicio Apache: sudo systemctl restart apache2 Comprobar su funcionamiento Creo el directorio necesario para el usuario vagrant : mkdir ~/public_html Me bajo un index.html de prueba en ese directorio: wget https://gist.githubusercontent.com/chrisvfritz/bc010e6ed25b802da7eb/raw/18eaa48addae7e3021f6bcea03b7a6557e3f0132/index.html Lo edito un poco para que se adapte a mi escenario. Muestro que puedo acceder: Ejercicio 2 Mostrar la configuraci\u00f3n por defecto de mod_userdir /etc/apache2/mods-available/userdir.conf : <IfModule mod_userdir.c> UserDir public_html UserDir disabled root <Directory /home/*/public_html> AllowOverride FileInfo AuthConfig Limit Indexes Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec Require method GET POST OPTIONS </Directory> </IfModule> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Ejercicio 3 Cambiar el nombre de directorio public_html por sitio_web Modifico /etc/apache2/mods-available/userdir.conf : <IfModule mod_userdir.c> UserDir sitio_web UserDir disabled root <Directory /home/*/sitio_web> AllowOverride FileInfo AuthConfig Limit Indexes Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec Require method GET POST OPTIONS </Directory> </IfModule> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Renombro el antiguo directorio con el nuevo nombre: mv public_html/ sitio_web Reinicio Apache: sudo systemctl restart apache2 Ejercicio 4 Mostrar que la web sigue funcionando despu\u00e9s del cambio de nombre al directorio mod_rewrite Entrega Parte 1 Entregar la regla de reescritura configurada Creo el fichero /var/www/html/php/.htaccess con el siguiente contenido: Options FollowSymLinks RewriteEngine On RewriteBase /php/ RewriteRule ^([A-Za-z]+)/([0-9]+)$ index.php?monto=$2&pais=$1 Parte 2 Captura donde se vea el acceso a www.conversordemoneda.com/php/moneda/cantidad Ejercicios Ejercicio 1 Crear directorio php en el DocumentRoot por defecto sudo mkdir /var/www/html/php Ejercicio 2 A\u00f1adir el conversor de monedas al directorio php Creo /var/www/html/php/index.php con el siguiente contenido: <!DOCTYPE html> <html lang=\"es\"> <head> <title>Conversor de Monedas</title> <meta charset=\"UTF-8\"> </head> <body> <form action=\"index.php\" method=\"get\"> <input type=\"text\" size=\"30\" name=\"monto\" /><br/> <select name=\"pais\"> <option name=\"Dolar\">Dolar</option> <option name=\"Libra\">Libra</option> <option name=\"Yen\">Yen</option> </select> <input type=\"submit\" value=\"convertir\" /> </form> <?php // averiguamos si se ha introducido un dinero if (isset($_GET['monto'])) { define (\"cantidad\", $_GET['monto']); } else { define (\"cantidad\", 0); } if($_GET){ // definimos los pa\u00edses $tasacambios = array (\"Libra\"=>0.86,\"Dolar\"=>1.34,\"Yen\"=>103.56); // imprimimos el monto ingresado echo \"<b>\".cantidad.\" euros</b><br/> \".$_GET[\"pais\"].\" = \".cantidad*$tasacambios[$_GET[\"pais\"]]; } ?> </body> </html> Ejercicio 3 Modificar el VirtualHost por defecto para que se acceda por nombre Modifico /etc/apache2/sites-available/000-default.conf : <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.conversordemoneda.com DocumentRoot /var/www/html # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej4-modulos-apache 192.168.121.204 www.conversordemoneda.com Ejercicio 4 Hacer que Apache funcione con php sudo apt install php Ejercicio 5 Probar que el conversor funciona, primero, sin utilizar rewrite Hago la prueba con: www.conversordemoneda.com/php/index.php?monto=100&pais=Libra : Ejercicio 6 Configurar mod_rewrite para que modificando un .htaccess , se pueda acceder a www.conversordemoneda.com/php/moneda/cantidad (moneda=Dolar,Libra,Yen cantidad=euros a convertir) Activo el m\u00f3dulo: sudo a2enmod rewrite Habilitar ficheros .htaccess en /etc/apache2/apache2.conf para el VirtualHost por defecto: <Directory /var/www/> Options Indexes FollowSymLinks AllowOverride All Require all granted </Directory> Creo el fichero /var/www/html/php/.htaccess con el siguiente contenido: Options FollowSymLinks RewriteEngine On RewriteBase /php/ RewriteRule ^([A-Za-z]+)/([0-9]+)$ index.php?monto=$2&pais=$1 Reinicio Apache: sudo systemctl restart apache2 Muestro que funciona:","title":"Ejercicio 4: M\u00f3dulos en Apache"},{"location":"ej4-modulos-apache/#ejercicio-4-modulos-en-apache","text":"","title":"Ejercicio 4: M\u00f3dulos en Apache"},{"location":"ej4-modulos-apache/#mod_userdir","text":"Este m\u00f3dulo permite que cada usuario aloje su web en un directorio ( public_html por defecto).","title":"mod_userdir"},{"location":"ej4-modulos-apache/#entrega","text":"","title":"Entrega"},{"location":"ej4-modulos-apache/#parte-1","text":"Mostrar la configuraci\u00f3n de mod_userdir donde se vea el cambio de nombre del directorio public_html por sitio_web Modifico /etc/apache2/mods-available/userdir.conf : <IfModule mod_userdir.c> UserDir sitio_web UserDir disabled root <Directory /home/*/sitio_web> AllowOverride FileInfo AuthConfig Limit Indexes Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec Require method GET POST OPTIONS </Directory> </IfModule> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet","title":"Parte 1"},{"location":"ej4-modulos-apache/#parte-2","text":"Captura donde se vea el acceso a la p\u00e1gina personal de vagrant","title":"Parte 2"},{"location":"ej4-modulos-apache/#ejercicios","text":"","title":"Ejercicios"},{"location":"ej4-modulos-apache/#ejercicio-1","text":"Activar el m\u00f3dulo sudo a2enmod userdir Reinicio Apache: sudo systemctl restart apache2 Comprobar su funcionamiento Creo el directorio necesario para el usuario vagrant : mkdir ~/public_html Me bajo un index.html de prueba en ese directorio: wget https://gist.githubusercontent.com/chrisvfritz/bc010e6ed25b802da7eb/raw/18eaa48addae7e3021f6bcea03b7a6557e3f0132/index.html Lo edito un poco para que se adapte a mi escenario. Muestro que puedo acceder:","title":"Ejercicio 1"},{"location":"ej4-modulos-apache/#ejercicio-2","text":"Mostrar la configuraci\u00f3n por defecto de mod_userdir /etc/apache2/mods-available/userdir.conf : <IfModule mod_userdir.c> UserDir public_html UserDir disabled root <Directory /home/*/public_html> AllowOverride FileInfo AuthConfig Limit Indexes Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec Require method GET POST OPTIONS </Directory> </IfModule> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet","title":"Ejercicio 2"},{"location":"ej4-modulos-apache/#ejercicio-3","text":"Cambiar el nombre de directorio public_html por sitio_web Modifico /etc/apache2/mods-available/userdir.conf : <IfModule mod_userdir.c> UserDir sitio_web UserDir disabled root <Directory /home/*/sitio_web> AllowOverride FileInfo AuthConfig Limit Indexes Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec Require method GET POST OPTIONS </Directory> </IfModule> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Renombro el antiguo directorio con el nuevo nombre: mv public_html/ sitio_web Reinicio Apache: sudo systemctl restart apache2","title":"Ejercicio 3"},{"location":"ej4-modulos-apache/#ejercicio-4","text":"Mostrar que la web sigue funcionando despu\u00e9s del cambio de nombre al directorio","title":"Ejercicio 4"},{"location":"ej4-modulos-apache/#mod_rewrite","text":"","title":"mod_rewrite"},{"location":"ej4-modulos-apache/#entrega_1","text":"","title":"Entrega"},{"location":"ej4-modulos-apache/#parte-1_1","text":"Entregar la regla de reescritura configurada Creo el fichero /var/www/html/php/.htaccess con el siguiente contenido: Options FollowSymLinks RewriteEngine On RewriteBase /php/ RewriteRule ^([A-Za-z]+)/([0-9]+)$ index.php?monto=$2&pais=$1","title":"Parte 1"},{"location":"ej4-modulos-apache/#parte-2_1","text":"Captura donde se vea el acceso a www.conversordemoneda.com/php/moneda/cantidad","title":"Parte 2"},{"location":"ej4-modulos-apache/#ejercicios_1","text":"","title":"Ejercicios"},{"location":"ej4-modulos-apache/#ejercicio-1_1","text":"Crear directorio php en el DocumentRoot por defecto sudo mkdir /var/www/html/php","title":"Ejercicio 1"},{"location":"ej4-modulos-apache/#ejercicio-2_1","text":"A\u00f1adir el conversor de monedas al directorio php Creo /var/www/html/php/index.php con el siguiente contenido: <!DOCTYPE html> <html lang=\"es\"> <head> <title>Conversor de Monedas</title> <meta charset=\"UTF-8\"> </head> <body> <form action=\"index.php\" method=\"get\"> <input type=\"text\" size=\"30\" name=\"monto\" /><br/> <select name=\"pais\"> <option name=\"Dolar\">Dolar</option> <option name=\"Libra\">Libra</option> <option name=\"Yen\">Yen</option> </select> <input type=\"submit\" value=\"convertir\" /> </form> <?php // averiguamos si se ha introducido un dinero if (isset($_GET['monto'])) { define (\"cantidad\", $_GET['monto']); } else { define (\"cantidad\", 0); } if($_GET){ // definimos los pa\u00edses $tasacambios = array (\"Libra\"=>0.86,\"Dolar\"=>1.34,\"Yen\"=>103.56); // imprimimos el monto ingresado echo \"<b>\".cantidad.\" euros</b><br/> \".$_GET[\"pais\"].\" = \".cantidad*$tasacambios[$_GET[\"pais\"]]; } ?> </body> </html>","title":"Ejercicio 2"},{"location":"ej4-modulos-apache/#ejercicio-3_1","text":"Modificar el VirtualHost por defecto para que se acceda por nombre Modifico /etc/apache2/sites-available/000-default.conf : <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.conversordemoneda.com DocumentRoot /var/www/html # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # ej4-modulos-apache 192.168.121.204 www.conversordemoneda.com","title":"Ejercicio 3"},{"location":"ej4-modulos-apache/#ejercicio-4_1","text":"Hacer que Apache funcione con php sudo apt install php","title":"Ejercicio 4"},{"location":"ej4-modulos-apache/#ejercicio-5","text":"Probar que el conversor funciona, primero, sin utilizar rewrite Hago la prueba con: www.conversordemoneda.com/php/index.php?monto=100&pais=Libra :","title":"Ejercicio 5"},{"location":"ej4-modulos-apache/#ejercicio-6","text":"Configurar mod_rewrite para que modificando un .htaccess , se pueda acceder a www.conversordemoneda.com/php/moneda/cantidad (moneda=Dolar,Libra,Yen cantidad=euros a convertir) Activo el m\u00f3dulo: sudo a2enmod rewrite Habilitar ficheros .htaccess en /etc/apache2/apache2.conf para el VirtualHost por defecto: <Directory /var/www/> Options Indexes FollowSymLinks AllowOverride All Require all granted </Directory> Creo el fichero /var/www/html/php/.htaccess con el siguiente contenido: Options FollowSymLinks RewriteEngine On RewriteBase /php/ RewriteRule ^([A-Za-z]+)/([0-9]+)$ index.php?monto=$2&pais=$1 Reinicio Apache: sudo systemctl restart apache2 Muestro que funciona:","title":"Ejercicio 6"},{"location":"ej5-vps/","text":"Ejercicio 5: Contrataci\u00f3n y configuraci\u00f3n de un VPS ENTREGA Nombre completo de la m\u00e1quina, para que se pueda acceder con el usuario profesor kampe.adrianjaramillo.tk CONFIGURACI\u00d3N DEL VPS Paso 1 Modificar hostname Editamos el fichero /etc/hostname : root@localhost:~# cat /etc/hostname kampe Este cambio tomar\u00e1 lugar al reiniciar, pero si no queremos hacerlo, ejecutamos: sudo hostname kampe Este comando es temporal, lo que hace el cambio permanente realmente es haber editado previamente el fichero /etc/hostname . Verificamos que el cambio ha surtido efecto: root@localhost:~# hostname kampe El hostname ha cambiado pero nuestro prompt no. Esto se debe a que la shell en la que nos encontramos se encuentra \"desactualizada\" por as\u00ed decirlo. Para arreglar esto, simplemente abrimos una nueva shell y ya deber\u00edamos de tener nuestro hostname actualizado en el prompt: root@localhost:~# bash root@kampe:~# Cambiar FQDN de la m\u00e1quina a kampe.adrianjaramillo.tk Modifico /etc/hosts de la siguiente manera: 127.0.0.1 localhost.localdomain localhost 87.106.228.149 kampe.adrianjaramillo.tk kampe # The following lines are desirable for IPv6 capable hosts ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters Comprobar el funcionamiento haciendo hostname -f root@kampe:~# hostname -f kampe.adrianjaramillo.tk Compruebo el nombre corto blackmamba@kampe:~$ ping kampe PING kampe.adrianjaramillo.tk (87.106.228.149) 56(84) bytes of data. 64 bytes from kampe.adrianjaramillo.tk (87.106.228.149): icmp_seq=1 ttl=64 time=0.021 ms 64 bytes from kampe.adrianjaramillo.tk (87.106.228.149): icmp_seq=2 ttl=64 time=0.040 ms ^C --- kampe.adrianjaramillo.tk ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1010ms rtt min/avg/max/mdev = 0.021/0.030/0.040/0.009 ms Paso 2 Crear usuario normal, con contrase\u00f1a robusta adduser blackmamba Su password es: ?UdLbQ?*3'd6)@C3 Habilitar sudo para blackmamba usermod -aG sudo blackmamba Habilitar sudo sin contrase\u00f1a para blackmamba A\u00f1adir lo siguiente en /etc/sudoers : blackmamba ALL=(ALL) NOPASSWD:ALL Importante que se a\u00f1ada al final del fichero . Pasar mi clave p\u00fablica SSH a blackmamba ssh-copy-id blackmamba@kampe.adrianjaramillo.tk Cambiar los siguientes par\u00e1metros en /etc/ssh/sshd_config ChallengeResponseAuthentication no PasswordAuthentication no UsePAM no PermitRootLogin no PermitRootLogin prohibit-password Reiniciar ssh sudo systemctl restart ssh Comprobar que no se puede acceder como root atlas@olympus:~$ ssh root@kampe.adrianjaramillo.tk root@kampe.adrianjaramillo.tk: Permission denied (publickey). Paso 3 Crear registro DNS tipo A con el nombre de la m\u00e1quina y la IP p\u00fablica asociada Comprobar que la resoluci\u00f3n funciona dig kampe.adrianjaramillo.tk ; <<>> DiG 9.16.15-Debian <<>> kampe.adrianjaramillo.tk ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 43729 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 9 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 5a78a81a29a907cc4f5f5213617bcc35d6b26dd93853c9e2 (good) ;; QUESTION SECTION: ;kampe.adrianjaramillo.tk. IN A ;; ANSWER SECTION: kampe.adrianjaramillo.tk. 3083 IN A 87.106.228.149 ;; AUTHORITY SECTION: tk. 172283 IN NS b.ns.tk. tk. 172283 IN NS a.ns.tk. tk. 172283 IN NS c.ns.tk. tk. 172283 IN NS d.ns.tk. ;; ADDITIONAL SECTION: a.ns.tk. 172283 IN A 194.0.38.1 b.ns.tk. 172283 IN A 194.0.39.1 c.ns.tk. 172283 IN A 194.0.40.1 d.ns.tk. 172283 IN A 194.0.41.1 a.ns.tk. 172283 IN AAAA 2001:678:50::1 b.ns.tk. 172283 IN AAAA 2001:678:54::1 c.ns.tk. 172283 IN AAAA 2001:678:58::1 d.ns.tk. 172283 IN AAAA 2001:678:5c::1 ;; Query time: 4 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Fri Oct 29 12:25:57 CEST 2021 ;; MSG SIZE rcvd: 340 Paso 4 Crear usuario profesor, con contrase\u00f1a robusta sudo adduser profesor Su password es: ?UdLbQ?*3'd6)@C4 Habilitar sudo para profesor sudo usermod -aG sudo profesor Habilitar sudo sin contrase\u00f1a para profesor A\u00f1adir lo siguiente en /etc/sudoers : profesor ALL=(ALL) NOPASSWD:ALL Importante que se a\u00f1ada al final del fichero A\u00f1adir clave p\u00fablica SSH de josedom a profesor Tras descargar su clave, la paso a mi VPS: scp Downloads/josedom-ssh.pub blackmamba@kampe.adrianjaramillo.tk:/home/blackmamba A\u00f1ado esa clave ssh p\u00fablica al usuario profesor: mkdir /home/profesor/.ssh && touch /home/profesor/.ssh/authorized_keys && cat /home/blackmamba/josedom-ssh.pub > /home/profesor/.ssh/authorized_keys","title":"Ejercicio 5: VPS"},{"location":"ej5-vps/#ejercicio-5-contratacion-y-configuracion-de-un-vps","text":"","title":"Ejercicio 5: Contrataci\u00f3n y configuraci\u00f3n de un VPS"},{"location":"ej5-vps/#entrega","text":"Nombre completo de la m\u00e1quina, para que se pueda acceder con el usuario profesor kampe.adrianjaramillo.tk","title":"ENTREGA"},{"location":"ej5-vps/#configuracion-del-vps","text":"","title":"CONFIGURACI\u00d3N DEL VPS"},{"location":"ej5-vps/#paso-1","text":"Modificar hostname Editamos el fichero /etc/hostname : root@localhost:~# cat /etc/hostname kampe Este cambio tomar\u00e1 lugar al reiniciar, pero si no queremos hacerlo, ejecutamos: sudo hostname kampe Este comando es temporal, lo que hace el cambio permanente realmente es haber editado previamente el fichero /etc/hostname . Verificamos que el cambio ha surtido efecto: root@localhost:~# hostname kampe El hostname ha cambiado pero nuestro prompt no. Esto se debe a que la shell en la que nos encontramos se encuentra \"desactualizada\" por as\u00ed decirlo. Para arreglar esto, simplemente abrimos una nueva shell y ya deber\u00edamos de tener nuestro hostname actualizado en el prompt: root@localhost:~# bash root@kampe:~# Cambiar FQDN de la m\u00e1quina a kampe.adrianjaramillo.tk Modifico /etc/hosts de la siguiente manera: 127.0.0.1 localhost.localdomain localhost 87.106.228.149 kampe.adrianjaramillo.tk kampe # The following lines are desirable for IPv6 capable hosts ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters Comprobar el funcionamiento haciendo hostname -f root@kampe:~# hostname -f kampe.adrianjaramillo.tk Compruebo el nombre corto blackmamba@kampe:~$ ping kampe PING kampe.adrianjaramillo.tk (87.106.228.149) 56(84) bytes of data. 64 bytes from kampe.adrianjaramillo.tk (87.106.228.149): icmp_seq=1 ttl=64 time=0.021 ms 64 bytes from kampe.adrianjaramillo.tk (87.106.228.149): icmp_seq=2 ttl=64 time=0.040 ms ^C --- kampe.adrianjaramillo.tk ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1010ms rtt min/avg/max/mdev = 0.021/0.030/0.040/0.009 ms","title":"Paso 1"},{"location":"ej5-vps/#paso-2","text":"Crear usuario normal, con contrase\u00f1a robusta adduser blackmamba Su password es: ?UdLbQ?*3'd6)@C3 Habilitar sudo para blackmamba usermod -aG sudo blackmamba Habilitar sudo sin contrase\u00f1a para blackmamba A\u00f1adir lo siguiente en /etc/sudoers : blackmamba ALL=(ALL) NOPASSWD:ALL Importante que se a\u00f1ada al final del fichero . Pasar mi clave p\u00fablica SSH a blackmamba ssh-copy-id blackmamba@kampe.adrianjaramillo.tk Cambiar los siguientes par\u00e1metros en /etc/ssh/sshd_config ChallengeResponseAuthentication no PasswordAuthentication no UsePAM no PermitRootLogin no PermitRootLogin prohibit-password Reiniciar ssh sudo systemctl restart ssh Comprobar que no se puede acceder como root atlas@olympus:~$ ssh root@kampe.adrianjaramillo.tk root@kampe.adrianjaramillo.tk: Permission denied (publickey).","title":"Paso 2"},{"location":"ej5-vps/#paso-3","text":"Crear registro DNS tipo A con el nombre de la m\u00e1quina y la IP p\u00fablica asociada Comprobar que la resoluci\u00f3n funciona dig kampe.adrianjaramillo.tk ; <<>> DiG 9.16.15-Debian <<>> kampe.adrianjaramillo.tk ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 43729 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 9 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 5a78a81a29a907cc4f5f5213617bcc35d6b26dd93853c9e2 (good) ;; QUESTION SECTION: ;kampe.adrianjaramillo.tk. IN A ;; ANSWER SECTION: kampe.adrianjaramillo.tk. 3083 IN A 87.106.228.149 ;; AUTHORITY SECTION: tk. 172283 IN NS b.ns.tk. tk. 172283 IN NS a.ns.tk. tk. 172283 IN NS c.ns.tk. tk. 172283 IN NS d.ns.tk. ;; ADDITIONAL SECTION: a.ns.tk. 172283 IN A 194.0.38.1 b.ns.tk. 172283 IN A 194.0.39.1 c.ns.tk. 172283 IN A 194.0.40.1 d.ns.tk. 172283 IN A 194.0.41.1 a.ns.tk. 172283 IN AAAA 2001:678:50::1 b.ns.tk. 172283 IN AAAA 2001:678:54::1 c.ns.tk. 172283 IN AAAA 2001:678:58::1 d.ns.tk. 172283 IN AAAA 2001:678:5c::1 ;; Query time: 4 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Fri Oct 29 12:25:57 CEST 2021 ;; MSG SIZE rcvd: 340","title":"Paso 3"},{"location":"ej5-vps/#paso-4","text":"Crear usuario profesor, con contrase\u00f1a robusta sudo adduser profesor Su password es: ?UdLbQ?*3'd6)@C4 Habilitar sudo para profesor sudo usermod -aG sudo profesor Habilitar sudo sin contrase\u00f1a para profesor A\u00f1adir lo siguiente en /etc/sudoers : profesor ALL=(ALL) NOPASSWD:ALL Importante que se a\u00f1ada al final del fichero A\u00f1adir clave p\u00fablica SSH de josedom a profesor Tras descargar su clave, la paso a mi VPS: scp Downloads/josedom-ssh.pub blackmamba@kampe.adrianjaramillo.tk:/home/blackmamba A\u00f1ado esa clave ssh p\u00fablica al usuario profesor: mkdir /home/profesor/.ssh && touch /home/profesor/.ssh/authorized_keys && cat /home/blackmamba/josedom-ssh.pub > /home/profesor/.ssh/authorized_keys","title":"Paso 4"},{"location":"ej6-apache-proxy-inverso/","text":"Ejercicio 6: Apache2 como proxy inverso Entrega Parte 1 Entregar configuraci\u00f3n de la manera 1 Activo el m\u00f3dulo: sudo a2enmod proxy_http Creo 2 VirtualHosts con las siguientes configuraciones: <VirtualHost *:80> ServerName www.app1.org ProxyPass \"/\" \"http://interno.example1.org/\" </VirtualHost> <VirtualHost *:80> ServerName www.app2.org ProxyPass \"/\" \"http://interno.example2.org/\" </VirtualHost> Los habilito: sudo a2ensite app1.conf app2.conf Reinicio Apache: sudo systemctl restart apache2 Parte 2 Entregar resoluci\u00f3n est\u00e1tica para acceder a las p\u00e1ginas de la manera 1 Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.app1.org www.app2.org Los 2 nombres apuntan a la IP de proxy . Parte 3 Capturas del acceso a las p\u00e1ginas como se indica en la manera 1 Muestro que www.app1.org funciona: Muestro que www.app2.org funciona: Parte 4 Entregar configuraci\u00f3n de la manera 2 Creo 1 VirtualHost con la siguiente configuraci\u00f3n: <VirtualHost *:80> ServerName www.servidor.org ProxyPass \"/app1\" \"http://interno.example1.org/\" ProxyPass \"/app2\" \"http://interno.example2.org/\" </VirtualHost> Lo habilito: sudo a2ensite servidor.conf Reinicio Apache: sudo systemctl restart apache2 Parte 5 Entregar resoluci\u00f3n est\u00e1tica para acceder a las p\u00e1ginas de la manera 2 Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.servidor.org Ese nombre apunta a la IP de proxy . Parte 6 Capturas del acceso a las p\u00e1ginas como se indica en la manera 2 Muestro que www.servidor.org/app1 funciona: Muestro que www.servidor.org/app2 funciona: Ejercicios Ejercicio 1 Descargar ejercicio_proxy.zip . Contiene el Vagrantfile y el ansible para configurar el escenario. wget https://fp.josedomingo.org/sri2122/u03/doc/ejercicio_proxy/ejercicio_proxy.zip unzip ejercicio_proxy.zip Muestro la estructura que ha dejado ese zip: atlas@olympus:~/vagrant/ej6-apache-proxy-inverso$ tree . \u251c\u2500\u2500 ansible \u2502 \u251c\u2500\u2500 ansible.cfg \u2502 \u251c\u2500\u2500 group_vars \u2502 \u2502 \u2514\u2500\u2500 all \u2502 \u251c\u2500\u2500 hosts \u2502 \u251c\u2500\u2500 roles \u2502 \u2502 \u251c\u2500\u2500 apache2 \u2502 \u2502 \u2502 \u251c\u2500\u2500 files \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500 index_vhost1.html \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500 index_vhost2.html \u2502 \u2502 \u2502 \u251c\u2500\u2500 handlers \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u2502 \u2502 \u251c\u2500\u2500 tasks \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u2502 \u2502 \u2514\u2500\u2500 templates \u2502 \u2502 \u2502 \u2514\u2500\u2500 etc \u2502 \u2502 \u2502 \u2514\u2500\u2500 apache2 \u2502 \u2502 \u2502 \u2514\u2500\u2500 sites-available \u2502 \u2502 \u2502 \u2514\u2500\u2500 vhost.j2 \u2502 \u2502 \u2514\u2500\u2500 commons \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u2514\u2500\u2500 site.yaml \u2514\u2500\u2500 Vagrantfile 13 directories, 11 files Ejercicio 2 Mostrar el escenario: \u201cproxy\u201d: Interfaz eth0 actuando como p\u00fablica Interfaz en red privada veryisolated \u201cservidorweb\u201d: Interfaz conectada a la misma red privada que proxy Muestro el Vagrantfile descargado: # -*- mode: ruby -*- # vi: set ft=ruby : Vagrant.configure(\"2\") do |config| config.vm.define :proxy do |proxy| proxy.vm.box = \"debian/bullseye64\" proxy.vm.hostname = \"proxy\" proxy.vm.synced_folder \".\", \"/vagrant\", disabled: true proxy.vm.network :private_network, :libvirt__network_name => \"red_privada1\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.10\", :libvirt__forward_mode => \"veryisolated\" proxy.vm.provision \"shell\", run: \"always\", inline: <<-SHELL apt-get update && apt upgrade -y sysctl -w net.ipv4.ip_forward=1 iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE echo \"10.0.0.6 interno.example1.org interno.example2.org\" >> /etc/hosts SHELL end config.vm.define :servidorweb do |servidorweb| servidorweb.vm.box = \"debian/bullseye64\" servidorweb.vm.hostname = \"servidorweb\" servidorweb.vm.synced_folder \".\", \"/vagrant\", disabled: true servidorweb.vm.network :private_network, :libvirt__network_name => \"red_privada1\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.6\", :libvirt__forward_mode => \"veryisolated\" servidorweb.vm.provision \"shell\", run: \"always\", inline: <<-SHELL ip r del default ip r add default via 10.0.0.10 SHELL end end Ejercicio 3 Crear el escenario vagrant vagrant up Ejercicio 4 Ejecutar el ansible para configurar \u201cservidorweb\u201d Modifico el fichero hosts con la IP actual de mi \u201cservidorweb\u201d: all: children: grupo_sw: hosts: servidor_web: ansible_ssh_host: 192.168.121.73 ansible_ssh_user: vagrant ansible_ssh_private_key_file: ../.vagrant/machines/servidorweb/libvirt/private_key Ejecuto el playbook: ansible-playbook site.yaml Este ansible, en la m\u00e1quina \u201cservidorweb\u201d: Instala Apache Configura 2 VirtualHosts Ejercicio 5 Instalar Apache en \"proxy\" sudo apt install apache2 Ejercicio 6 Configurar \"proxy\" para acceder a las p\u00e1ginas de \u201cservidorweb\u201d... Manera 1: acceder a la primera en www.app1.org y a la segunda en www.app2.org En mi m\u00e1quina Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.app1.org www.app2.org Los 2 nombres apuntan a la IP de proxy . En proxy Activo el m\u00f3dulo: sudo a2enmod proxy_http Creo 2 VirtualHosts con las siguientes configuraciones: <VirtualHost *:80> ServerName www.app1.org ProxyPass \"/\" \"http://interno.example1.org/\" </VirtualHost> <VirtualHost *:80> ServerName www.app2.org ProxyPass \"/\" \"http://interno.example2.org/\" </VirtualHost> Los habilito: sudo a2ensite app1.conf app2.conf Reinicio Apache: sudo systemctl restart apache2 Muestro que www.app1.org funciona: Muestro que www.app2.org funciona: Ejercicio 7 Configurar \"proxy\" para acceder a las p\u00e1ginas de \u201cservidorweb\u201d... Manera 2: acceder a la primera en www.servidor.org/app1 y a la segunda en www.servidor.org/app2 En mi m\u00e1quina Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.servidor.org Ese nombre apunta a la IP de proxy . En proxy Creo 1 VirtualHost con la siguiente configuraci\u00f3n: <VirtualHost *:80> ServerName www.servidor.org ProxyPass \"/app1\" \"http://interno.example1.org/\" ProxyPass \"/app2\" \"http://interno.example2.org/\" </VirtualHost> Lo habilito: sudo a2ensite servidor.conf Reinicio Apache: sudo systemctl restart apache2 Muestro que www.servidor.org/app1 funciona: Muestro que www.servidor.org/app2 funciona:","title":"Ejercicio 6: Apache proxy inverso"},{"location":"ej6-apache-proxy-inverso/#ejercicio-6-apache2-como-proxy-inverso","text":"","title":"Ejercicio 6: Apache2 como proxy inverso"},{"location":"ej6-apache-proxy-inverso/#entrega","text":"","title":"Entrega"},{"location":"ej6-apache-proxy-inverso/#parte-1","text":"Entregar configuraci\u00f3n de la manera 1 Activo el m\u00f3dulo: sudo a2enmod proxy_http Creo 2 VirtualHosts con las siguientes configuraciones: <VirtualHost *:80> ServerName www.app1.org ProxyPass \"/\" \"http://interno.example1.org/\" </VirtualHost> <VirtualHost *:80> ServerName www.app2.org ProxyPass \"/\" \"http://interno.example2.org/\" </VirtualHost> Los habilito: sudo a2ensite app1.conf app2.conf Reinicio Apache: sudo systemctl restart apache2","title":"Parte 1"},{"location":"ej6-apache-proxy-inverso/#parte-2","text":"Entregar resoluci\u00f3n est\u00e1tica para acceder a las p\u00e1ginas de la manera 1 Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.app1.org www.app2.org Los 2 nombres apuntan a la IP de proxy .","title":"Parte 2"},{"location":"ej6-apache-proxy-inverso/#parte-3","text":"Capturas del acceso a las p\u00e1ginas como se indica en la manera 1 Muestro que www.app1.org funciona: Muestro que www.app2.org funciona:","title":"Parte 3"},{"location":"ej6-apache-proxy-inverso/#parte-4","text":"Entregar configuraci\u00f3n de la manera 2 Creo 1 VirtualHost con la siguiente configuraci\u00f3n: <VirtualHost *:80> ServerName www.servidor.org ProxyPass \"/app1\" \"http://interno.example1.org/\" ProxyPass \"/app2\" \"http://interno.example2.org/\" </VirtualHost> Lo habilito: sudo a2ensite servidor.conf Reinicio Apache: sudo systemctl restart apache2","title":"Parte 4"},{"location":"ej6-apache-proxy-inverso/#parte-5","text":"Entregar resoluci\u00f3n est\u00e1tica para acceder a las p\u00e1ginas de la manera 2 Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.servidor.org Ese nombre apunta a la IP de proxy .","title":"Parte 5"},{"location":"ej6-apache-proxy-inverso/#parte-6","text":"Capturas del acceso a las p\u00e1ginas como se indica en la manera 2 Muestro que www.servidor.org/app1 funciona: Muestro que www.servidor.org/app2 funciona:","title":"Parte 6"},{"location":"ej6-apache-proxy-inverso/#ejercicios","text":"","title":"Ejercicios"},{"location":"ej6-apache-proxy-inverso/#ejercicio-1","text":"Descargar ejercicio_proxy.zip . Contiene el Vagrantfile y el ansible para configurar el escenario. wget https://fp.josedomingo.org/sri2122/u03/doc/ejercicio_proxy/ejercicio_proxy.zip unzip ejercicio_proxy.zip Muestro la estructura que ha dejado ese zip: atlas@olympus:~/vagrant/ej6-apache-proxy-inverso$ tree . \u251c\u2500\u2500 ansible \u2502 \u251c\u2500\u2500 ansible.cfg \u2502 \u251c\u2500\u2500 group_vars \u2502 \u2502 \u2514\u2500\u2500 all \u2502 \u251c\u2500\u2500 hosts \u2502 \u251c\u2500\u2500 roles \u2502 \u2502 \u251c\u2500\u2500 apache2 \u2502 \u2502 \u2502 \u251c\u2500\u2500 files \u2502 \u2502 \u2502 \u2502 \u251c\u2500\u2500 index_vhost1.html \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500 index_vhost2.html \u2502 \u2502 \u2502 \u251c\u2500\u2500 handlers \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u2502 \u2502 \u251c\u2500\u2500 tasks \u2502 \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u2502 \u2502 \u2514\u2500\u2500 templates \u2502 \u2502 \u2502 \u2514\u2500\u2500 etc \u2502 \u2502 \u2502 \u2514\u2500\u2500 apache2 \u2502 \u2502 \u2502 \u2514\u2500\u2500 sites-available \u2502 \u2502 \u2502 \u2514\u2500\u2500 vhost.j2 \u2502 \u2502 \u2514\u2500\u2500 commons \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u2514\u2500\u2500 site.yaml \u2514\u2500\u2500 Vagrantfile 13 directories, 11 files","title":"Ejercicio 1"},{"location":"ej6-apache-proxy-inverso/#ejercicio-2","text":"Mostrar el escenario: \u201cproxy\u201d: Interfaz eth0 actuando como p\u00fablica Interfaz en red privada veryisolated \u201cservidorweb\u201d: Interfaz conectada a la misma red privada que proxy Muestro el Vagrantfile descargado: # -*- mode: ruby -*- # vi: set ft=ruby : Vagrant.configure(\"2\") do |config| config.vm.define :proxy do |proxy| proxy.vm.box = \"debian/bullseye64\" proxy.vm.hostname = \"proxy\" proxy.vm.synced_folder \".\", \"/vagrant\", disabled: true proxy.vm.network :private_network, :libvirt__network_name => \"red_privada1\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.10\", :libvirt__forward_mode => \"veryisolated\" proxy.vm.provision \"shell\", run: \"always\", inline: <<-SHELL apt-get update && apt upgrade -y sysctl -w net.ipv4.ip_forward=1 iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE echo \"10.0.0.6 interno.example1.org interno.example2.org\" >> /etc/hosts SHELL end config.vm.define :servidorweb do |servidorweb| servidorweb.vm.box = \"debian/bullseye64\" servidorweb.vm.hostname = \"servidorweb\" servidorweb.vm.synced_folder \".\", \"/vagrant\", disabled: true servidorweb.vm.network :private_network, :libvirt__network_name => \"red_privada1\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.6\", :libvirt__forward_mode => \"veryisolated\" servidorweb.vm.provision \"shell\", run: \"always\", inline: <<-SHELL ip r del default ip r add default via 10.0.0.10 SHELL end end","title":"Ejercicio 2"},{"location":"ej6-apache-proxy-inverso/#ejercicio-3","text":"Crear el escenario vagrant vagrant up","title":"Ejercicio 3"},{"location":"ej6-apache-proxy-inverso/#ejercicio-4","text":"Ejecutar el ansible para configurar \u201cservidorweb\u201d Modifico el fichero hosts con la IP actual de mi \u201cservidorweb\u201d: all: children: grupo_sw: hosts: servidor_web: ansible_ssh_host: 192.168.121.73 ansible_ssh_user: vagrant ansible_ssh_private_key_file: ../.vagrant/machines/servidorweb/libvirt/private_key Ejecuto el playbook: ansible-playbook site.yaml Este ansible, en la m\u00e1quina \u201cservidorweb\u201d: Instala Apache Configura 2 VirtualHosts","title":"Ejercicio 4"},{"location":"ej6-apache-proxy-inverso/#ejercicio-5","text":"Instalar Apache en \"proxy\" sudo apt install apache2","title":"Ejercicio 5"},{"location":"ej6-apache-proxy-inverso/#ejercicio-6","text":"Configurar \"proxy\" para acceder a las p\u00e1ginas de \u201cservidorweb\u201d... Manera 1: acceder a la primera en www.app1.org y a la segunda en www.app2.org","title":"Ejercicio 6"},{"location":"ej6-apache-proxy-inverso/#en-mi-maquina","text":"Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.app1.org www.app2.org Los 2 nombres apuntan a la IP de proxy .","title":"En mi m\u00e1quina"},{"location":"ej6-apache-proxy-inverso/#en-proxy","text":"Activo el m\u00f3dulo: sudo a2enmod proxy_http Creo 2 VirtualHosts con las siguientes configuraciones: <VirtualHost *:80> ServerName www.app1.org ProxyPass \"/\" \"http://interno.example1.org/\" </VirtualHost> <VirtualHost *:80> ServerName www.app2.org ProxyPass \"/\" \"http://interno.example2.org/\" </VirtualHost> Los habilito: sudo a2ensite app1.conf app2.conf Reinicio Apache: sudo systemctl restart apache2 Muestro que www.app1.org funciona: Muestro que www.app2.org funciona:","title":"En proxy"},{"location":"ej6-apache-proxy-inverso/#ejercicio-7","text":"Configurar \"proxy\" para acceder a las p\u00e1ginas de \u201cservidorweb\u201d... Manera 2: acceder a la primera en www.servidor.org/app1 y a la segunda en www.servidor.org/app2","title":"Ejercicio 7"},{"location":"ej6-apache-proxy-inverso/#en-mi-maquina_1","text":"Modifico /etc/hosts : # ej6-apache-proxy-inverso 192.168.121.65 www.servidor.org Ese nombre apunta a la IP de proxy .","title":"En mi m\u00e1quina"},{"location":"ej6-apache-proxy-inverso/#en-proxy_1","text":"Creo 1 VirtualHost con la siguiente configuraci\u00f3n: <VirtualHost *:80> ServerName www.servidor.org ProxyPass \"/app1\" \"http://interno.example1.org/\" ProxyPass \"/app2\" \"http://interno.example2.org/\" </VirtualHost> Lo habilito: sudo a2ensite servidor.conf Reinicio Apache: sudo systemctl restart apache2 Muestro que www.servidor.org/app1 funciona: Muestro que www.servidor.org/app2 funciona:","title":"En proxy"},{"location":"ejercicios-correo/","text":"Ejercicios correo en escenario libvirt Ejercicio 1: Usuarios del mismo servidor Parte 1 Instalar postfix en apolo sudo apt install postfix Selecciono \"Internet Site\": Escribo mi nombre de dominio. Se tomar\u00e1 como dominio origen de los correos que se env\u00eden desde apolo: Parte 2 Instalar mailutils sudo apt install mailutils Parte 3 Usar mail para enviar un correo desde el usuario vagrant al usuario profesor vagrant@apolo:~$ mail profesor@localhost Cc: Subject: Correo para profesor Correo de prueba (para que este correo se env\u00ede, es necesario estar en una nueva l\u00ednea del cuerpo y pulsar Ctrl+D) Parte 4 Leer el correo enviado usando mail en el usuario profesor profesor@apolo:~$ mail \"/var/mail/profesor\": 1 message 1 new >N 1 vagrant@apolo.adri Tue Jan 18 09:38 13/528 Correo para profesor ? 1 Return-Path: <vagrant@apolo.adrianj.gonzalonazareno.org> X-Original-To: profesor@localhost Delivered-To: profesor@localhost Received: by apolo.adrianj.gonzalonazareno.org (Postfix, from userid 1000) id C5521C02CA; Tue, 18 Jan 2022 09:38:24 +0000 (UTC) To: <profesor@localhost> Subject: Correo para profesor X-Mailer: mail (GNU Mailutils 3.10) Message-Id: <20220118093824.C5521C02CA@apolo.adrianj.gonzalonazareno.org> Date: Tue, 18 Jan 2022 09:38:24 +0000 (UTC) From: vagrant@apolo.adrianj.gonzalonazareno.org Correo de prueba ? Ejercicio 2: Usuarios del servidor a correos de internet Parte 1 A\u00f1adir babuino-smtp.gonzalonazareno.org como relayhost en postfix Modifico /etc/postfix/main.cf : relayhost = babuino-smtp.gonzalonazareno.org Modifico los nameserver en apolo de la siguiente manera en /etc/dhcp/dhclient.conf : supersede domain-name-servers 192.168.202.2,127.0.0.1; (he colocado la ip de papion-dns en primer orden para que al hacer relay se resuelva babuino-smtp.gonzalonazareno.org desde nuestra red y no desde Internet. Esto sucede porque apolo no tiene la zona gonzalonazareno.org y por ende acaba preguntando recursivamente) Parte 2 Enviar un correo a adristudy@gmail.com con mail vagrant@apolo:~$ mail -r vagrant@adrianj.gonzalonazareno.org adristudy@gmail.com Cc: Subject: Correo externo Prueba de correo a gmail (es necesario a\u00f1adir con -r la direcci\u00f3n de origen. As\u00ed evitamos que mail use el hostname completo de la m\u00e1quina como dominio de origen, lo cual ser\u00eda incorrecto) Parte 3 Mostrar /var/log/mail.log para verificar que el correo se ha enviado correctamente Muestro la l\u00ednea relevante: Jan 19 09:21:16 apolo postfix/smtp[2764]: 3EA6BC0D9E: to=<adristudy@gmail.com>, relay=babuino-smtp.gonzalonazareno.org[192.168.203.3]:25, delay=0.16, delays=0.06/0.03/0.06/0.01, dsn=2.0.0, status=sent (250 2.0.0 Ok: queued as 571FBFF778) Parte 4 Mostrar el correo en gmail Parte 5 \u00bfC\u00f3mo podemos ver el correo original (en bruto)? Parte 6 Indicar en las cabeceras la ruta de servidores SMTP tomada por el correo desde apolo a gmail (los apartados \"Received\" se leen inversamente) Ejercicio 3: correos desde internet a usuarios del servidor Parte 1 A\u00f1adir registro MX a la vista externa de bind Modifico db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. @ IN MX 10 zeus.adrianj.gonzalonazareno.org. zeus IN A 172.22.0.213 ; clase ; zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus python IN CNAME zeus Reinicio bind sudo systemctl restart bind9 Parte 2 DNAT en zeus redirigiendo el puerto 25 a apolo sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Guardo la regla: iptables-save > /etc/iptables/rules.v4 Parte 3 Responder desde gmail al correo recibido en el ejercicio anterior Muestro mi respuesta: Parte 4 Comprobar en apolo que se ha recibido correctamente el correo mirando /var/log/mail.log Jan 19 09:55:10 apolo postfix/smtpd[2896]: connect from babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/smtpd[2896]: CACBDC0D97: client=babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/cleanup[2900]: CACBDC0D97: message-id=<CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: from=<adristudy@gmail.com>, size=3692, nrcpt=1 (queue active) Jan 19 09:55:10 apolo postfix/smtpd[2896]: disconnect from babuino-smtp.gonzalonazareno.org[192.168.203.3] ehlo=2 starttls=1 mail=1 rcpt=1 data=1 quit=1 commands=7 Jan 19 09:55:10 apolo postfix/local[2901]: CACBDC0D97: to=<vagrant@adrianj.gonzalonazareno.org>, relay=local, delay=0.03, delays=0.02/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox) Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: removed Muestro el correo recibido: vagrant@apolo:~$ mail \"/var/mail/vagrant\": 5 messages 5 new >N 1 adristudy Wed Jan 19 09:41 72/3840 Re: Correo externo N 2 adristudy Wed Jan 19 09:42 70/3685 Re: Correo externo N 3 adristudy Wed Jan 19 09:42 71/3760 Re: Correo externo N 4 adristudy Wed Jan 19 09:47 70/3733 Re: Correo externo N 5 adristudy Wed Jan 19 09:55 71/3760 Re: Correo externo ? 5 Return-Path: <adristudy@gmail.com> X-Original-To: vagrant@adrianj.gonzalonazareno.org Delivered-To: vagrant@adrianj.gonzalonazareno.org Received: from babuino-smtp.gonzalonazareno.org (babuino-smtp.gonzalonazareno.org [192.168.203.3]) by apolo.adrianj.gonzalonazareno.org (Postfix) with ESMTPS id CACBDC0D97 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: from mail-pf1-f179.google.com (mail-pf1-f179.google.com [209.85.210.179]) by babuino-smtp.gonzalonazareno.org (Postfix) with ESMTPS id A2EDAFF779 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: by mail-pf1-f179.google.com with SMTP id i17so2054870pfk.11 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 01:55:10 -0800 (PST) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=SBed1/6ifJBmc3cotOM2KN5vYhx3Emlvd0snQssj4+19q2o0LEwG4yrLoDdmdoGCGk 7akg1xd+ldFO9NFUDRRra5c7y/P0rZ/lOX8TILS7HRYVNnOtn3ko1e540sKhXYFzLeTR MBTBO0f/ru8+6zgQEMRHixsA7FGJldQLLv7TgJEzWSAFORcLg9VmHouXTH5e9+H/44E0 zmkZI7WKS8vcjkVCaCt6Dfh/cjzI2NmQeMXGZzjVN30pLzu4YqcWyPjtjUv30SXSloLt Uz94rZ7Regq/geNg5GyzsYHWBuRINEjDHHbdN7TI9oOWEOt852gu2OgPLVw7Ls+8htyH gktA== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20210112; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=32Kq/nf+UvzvxQJ6ik5lUXbV7vsSA/vYiuKrf3UMopF8/xpmUziglRPbV6YKT77Klj 00L/lqWR03204+B/rMc2fJuZgvL9mF1K7bhU5tUajx7K681EUyEfsb3SoHtFo5rACvpN faB5tspK0JGZpJrzlje+kOn2cMTTmA0fmbG9H1ZaZpbHqS8I88gUe5hTFd6g9b8Duo6D sLhcEt/PDaqpklT20i1dYq9PliJwrfV4w8Fphd1QB8JX6Q+LrfhrD59aLYNxgEXzb4+D le8cMo/T9FBRm1CGwOI4rikgOU7I7gAGk3lfdj7kz2z4WsgZbzNnhi10011eOzZkfWlJ CUSA== X-Gm-Message-State: AOAM532fkZWJWnHiaF36A5Nc+fDMpsESW9z6MSRbA510wCRAVfpBggip Q1wcux1gIM2rqaJXsGRIiqgfjOexLLwBjtgCxx9vw/Rd2Ic= X-Google-Smtp-Source: ABdhPJwFZl8S+5mmB9d4DO93QwZgmwFk0vh06sVosKBDr2J4J3PVhfQWB1g22JvwPa0VNnRtPizZaX37r8W8+b/Q3Yc= X-Received: by 2002:a63:7c10:: with SMTP id x16mr26938561pgc.128.1642586106377; Wed, 19 Jan 2022 01:55:06 -0800 (PST) MIME-Version: 1.0 References: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> In-Reply-To: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> From: adristudy <adristudy@gmail.com> Date: Wed, 19 Jan 2022 10:54:55 +0100 Message-ID: <CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Subject: Re: Correo externo To: vagrant@adrianj.gonzalonazareno.org Content-Type: multipart/alternative; boundary=\"0000000000006238fe05d5ec61c4\" --0000000000006238fe05d5ec61c4 Content-Type: text/plain; charset=\"UTF-8\" respuesta para apolo On Wed, 19 Jan 2022 at 10:21, <vagrant@adrianj.gonzalonazareno.org> wrote: > Prueba de correo a gmail > --0000000000006238fe05d5ec61c4 Content-Type: text/html; charset=\"UTF-8\" Content-Transfer-Encoding: quoted-printable <div dir=3D\"ltr\"><div dir=3D\"ltr\"><div dir=3D\"ltr\">respuesta para apolo</di= v></div></div><br><div class=3D\"gmail_quote\"><div dir=3D\"ltr\" class=3D\"gmai= l_attr\">On Wed, 19 Jan 2022 at 10:21, &lt;<a href=3D\"mailto:vagrant@adrianj= .gonzalonazareno.org\">vagrant@adrianj.gonzalonazareno.org</a>&gt; wrote:<br= ></div><blockquote class=3D\"gmail_quote\" style=3D\"margin:0px 0px 0px 0.8ex;= border-left:1px solid rgb(204,204,204);padding-left:1ex\">Prueba de correo a= gmail<br> </blockquote></div> --0000000000006238fe05d5ec61c4-- (escribo 5 porque es el \u00faltimo recibido)","title":"Ejercicios en escenario libvirt"},{"location":"ejercicios-correo/#ejercicios-correo-en-escenario-libvirt","text":"","title":"Ejercicios correo en escenario libvirt"},{"location":"ejercicios-correo/#ejercicio-1-usuarios-del-mismo-servidor","text":"","title":"Ejercicio 1: Usuarios del mismo servidor"},{"location":"ejercicios-correo/#parte-1","text":"Instalar postfix en apolo sudo apt install postfix Selecciono \"Internet Site\": Escribo mi nombre de dominio. Se tomar\u00e1 como dominio origen de los correos que se env\u00eden desde apolo:","title":"Parte 1"},{"location":"ejercicios-correo/#parte-2","text":"Instalar mailutils sudo apt install mailutils","title":"Parte 2"},{"location":"ejercicios-correo/#parte-3","text":"Usar mail para enviar un correo desde el usuario vagrant al usuario profesor vagrant@apolo:~$ mail profesor@localhost Cc: Subject: Correo para profesor Correo de prueba (para que este correo se env\u00ede, es necesario estar en una nueva l\u00ednea del cuerpo y pulsar Ctrl+D)","title":"Parte 3"},{"location":"ejercicios-correo/#parte-4","text":"Leer el correo enviado usando mail en el usuario profesor profesor@apolo:~$ mail \"/var/mail/profesor\": 1 message 1 new >N 1 vagrant@apolo.adri Tue Jan 18 09:38 13/528 Correo para profesor ? 1 Return-Path: <vagrant@apolo.adrianj.gonzalonazareno.org> X-Original-To: profesor@localhost Delivered-To: profesor@localhost Received: by apolo.adrianj.gonzalonazareno.org (Postfix, from userid 1000) id C5521C02CA; Tue, 18 Jan 2022 09:38:24 +0000 (UTC) To: <profesor@localhost> Subject: Correo para profesor X-Mailer: mail (GNU Mailutils 3.10) Message-Id: <20220118093824.C5521C02CA@apolo.adrianj.gonzalonazareno.org> Date: Tue, 18 Jan 2022 09:38:24 +0000 (UTC) From: vagrant@apolo.adrianj.gonzalonazareno.org Correo de prueba ?","title":"Parte 4"},{"location":"ejercicios-correo/#ejercicio-2-usuarios-del-servidor-a-correos-de-internet","text":"","title":"Ejercicio 2: Usuarios del servidor a correos de internet"},{"location":"ejercicios-correo/#parte-1_1","text":"A\u00f1adir babuino-smtp.gonzalonazareno.org como relayhost en postfix Modifico /etc/postfix/main.cf : relayhost = babuino-smtp.gonzalonazareno.org Modifico los nameserver en apolo de la siguiente manera en /etc/dhcp/dhclient.conf : supersede domain-name-servers 192.168.202.2,127.0.0.1; (he colocado la ip de papion-dns en primer orden para que al hacer relay se resuelva babuino-smtp.gonzalonazareno.org desde nuestra red y no desde Internet. Esto sucede porque apolo no tiene la zona gonzalonazareno.org y por ende acaba preguntando recursivamente)","title":"Parte 1"},{"location":"ejercicios-correo/#parte-2_1","text":"Enviar un correo a adristudy@gmail.com con mail vagrant@apolo:~$ mail -r vagrant@adrianj.gonzalonazareno.org adristudy@gmail.com Cc: Subject: Correo externo Prueba de correo a gmail (es necesario a\u00f1adir con -r la direcci\u00f3n de origen. As\u00ed evitamos que mail use el hostname completo de la m\u00e1quina como dominio de origen, lo cual ser\u00eda incorrecto)","title":"Parte 2"},{"location":"ejercicios-correo/#parte-3_1","text":"Mostrar /var/log/mail.log para verificar que el correo se ha enviado correctamente Muestro la l\u00ednea relevante: Jan 19 09:21:16 apolo postfix/smtp[2764]: 3EA6BC0D9E: to=<adristudy@gmail.com>, relay=babuino-smtp.gonzalonazareno.org[192.168.203.3]:25, delay=0.16, delays=0.06/0.03/0.06/0.01, dsn=2.0.0, status=sent (250 2.0.0 Ok: queued as 571FBFF778)","title":"Parte 3"},{"location":"ejercicios-correo/#parte-4_1","text":"Mostrar el correo en gmail","title":"Parte 4"},{"location":"ejercicios-correo/#parte-5","text":"\u00bfC\u00f3mo podemos ver el correo original (en bruto)?","title":"Parte 5"},{"location":"ejercicios-correo/#parte-6","text":"Indicar en las cabeceras la ruta de servidores SMTP tomada por el correo desde apolo a gmail (los apartados \"Received\" se leen inversamente)","title":"Parte 6"},{"location":"ejercicios-correo/#ejercicio-3-correos-desde-internet-a-usuarios-del-servidor","text":"","title":"Ejercicio 3: correos desde internet a usuarios del servidor"},{"location":"ejercicios-correo/#parte-1_2","text":"A\u00f1adir registro MX a la vista externa de bind Modifico db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. @ IN MX 10 zeus.adrianj.gonzalonazareno.org. zeus IN A 172.22.0.213 ; clase ; zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus python IN CNAME zeus Reinicio bind sudo systemctl restart bind9","title":"Parte 1"},{"location":"ejercicios-correo/#parte-2_2","text":"DNAT en zeus redirigiendo el puerto 25 a apolo sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Guardo la regla: iptables-save > /etc/iptables/rules.v4","title":"Parte 2"},{"location":"ejercicios-correo/#parte-3_2","text":"Responder desde gmail al correo recibido en el ejercicio anterior Muestro mi respuesta:","title":"Parte 3"},{"location":"ejercicios-correo/#parte-4_2","text":"Comprobar en apolo que se ha recibido correctamente el correo mirando /var/log/mail.log Jan 19 09:55:10 apolo postfix/smtpd[2896]: connect from babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/smtpd[2896]: CACBDC0D97: client=babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/cleanup[2900]: CACBDC0D97: message-id=<CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: from=<adristudy@gmail.com>, size=3692, nrcpt=1 (queue active) Jan 19 09:55:10 apolo postfix/smtpd[2896]: disconnect from babuino-smtp.gonzalonazareno.org[192.168.203.3] ehlo=2 starttls=1 mail=1 rcpt=1 data=1 quit=1 commands=7 Jan 19 09:55:10 apolo postfix/local[2901]: CACBDC0D97: to=<vagrant@adrianj.gonzalonazareno.org>, relay=local, delay=0.03, delays=0.02/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox) Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: removed Muestro el correo recibido: vagrant@apolo:~$ mail \"/var/mail/vagrant\": 5 messages 5 new >N 1 adristudy Wed Jan 19 09:41 72/3840 Re: Correo externo N 2 adristudy Wed Jan 19 09:42 70/3685 Re: Correo externo N 3 adristudy Wed Jan 19 09:42 71/3760 Re: Correo externo N 4 adristudy Wed Jan 19 09:47 70/3733 Re: Correo externo N 5 adristudy Wed Jan 19 09:55 71/3760 Re: Correo externo ? 5 Return-Path: <adristudy@gmail.com> X-Original-To: vagrant@adrianj.gonzalonazareno.org Delivered-To: vagrant@adrianj.gonzalonazareno.org Received: from babuino-smtp.gonzalonazareno.org (babuino-smtp.gonzalonazareno.org [192.168.203.3]) by apolo.adrianj.gonzalonazareno.org (Postfix) with ESMTPS id CACBDC0D97 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: from mail-pf1-f179.google.com (mail-pf1-f179.google.com [209.85.210.179]) by babuino-smtp.gonzalonazareno.org (Postfix) with ESMTPS id A2EDAFF779 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: by mail-pf1-f179.google.com with SMTP id i17so2054870pfk.11 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 01:55:10 -0800 (PST) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=SBed1/6ifJBmc3cotOM2KN5vYhx3Emlvd0snQssj4+19q2o0LEwG4yrLoDdmdoGCGk 7akg1xd+ldFO9NFUDRRra5c7y/P0rZ/lOX8TILS7HRYVNnOtn3ko1e540sKhXYFzLeTR MBTBO0f/ru8+6zgQEMRHixsA7FGJldQLLv7TgJEzWSAFORcLg9VmHouXTH5e9+H/44E0 zmkZI7WKS8vcjkVCaCt6Dfh/cjzI2NmQeMXGZzjVN30pLzu4YqcWyPjtjUv30SXSloLt Uz94rZ7Regq/geNg5GyzsYHWBuRINEjDHHbdN7TI9oOWEOt852gu2OgPLVw7Ls+8htyH gktA== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20210112; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=32Kq/nf+UvzvxQJ6ik5lUXbV7vsSA/vYiuKrf3UMopF8/xpmUziglRPbV6YKT77Klj 00L/lqWR03204+B/rMc2fJuZgvL9mF1K7bhU5tUajx7K681EUyEfsb3SoHtFo5rACvpN faB5tspK0JGZpJrzlje+kOn2cMTTmA0fmbG9H1ZaZpbHqS8I88gUe5hTFd6g9b8Duo6D sLhcEt/PDaqpklT20i1dYq9PliJwrfV4w8Fphd1QB8JX6Q+LrfhrD59aLYNxgEXzb4+D le8cMo/T9FBRm1CGwOI4rikgOU7I7gAGk3lfdj7kz2z4WsgZbzNnhi10011eOzZkfWlJ CUSA== X-Gm-Message-State: AOAM532fkZWJWnHiaF36A5Nc+fDMpsESW9z6MSRbA510wCRAVfpBggip Q1wcux1gIM2rqaJXsGRIiqgfjOexLLwBjtgCxx9vw/Rd2Ic= X-Google-Smtp-Source: ABdhPJwFZl8S+5mmB9d4DO93QwZgmwFk0vh06sVosKBDr2J4J3PVhfQWB1g22JvwPa0VNnRtPizZaX37r8W8+b/Q3Yc= X-Received: by 2002:a63:7c10:: with SMTP id x16mr26938561pgc.128.1642586106377; Wed, 19 Jan 2022 01:55:06 -0800 (PST) MIME-Version: 1.0 References: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> In-Reply-To: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> From: adristudy <adristudy@gmail.com> Date: Wed, 19 Jan 2022 10:54:55 +0100 Message-ID: <CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Subject: Re: Correo externo To: vagrant@adrianj.gonzalonazareno.org Content-Type: multipart/alternative; boundary=\"0000000000006238fe05d5ec61c4\" --0000000000006238fe05d5ec61c4 Content-Type: text/plain; charset=\"UTF-8\" respuesta para apolo On Wed, 19 Jan 2022 at 10:21, <vagrant@adrianj.gonzalonazareno.org> wrote: > Prueba de correo a gmail > --0000000000006238fe05d5ec61c4 Content-Type: text/html; charset=\"UTF-8\" Content-Transfer-Encoding: quoted-printable <div dir=3D\"ltr\"><div dir=3D\"ltr\"><div dir=3D\"ltr\">respuesta para apolo</di= v></div></div><br><div class=3D\"gmail_quote\"><div dir=3D\"ltr\" class=3D\"gmai= l_attr\">On Wed, 19 Jan 2022 at 10:21, &lt;<a href=3D\"mailto:vagrant@adrianj= .gonzalonazareno.org\">vagrant@adrianj.gonzalonazareno.org</a>&gt; wrote:<br= ></div><blockquote class=3D\"gmail_quote\" style=3D\"margin:0px 0px 0px 0.8ex;= border-left:1px solid rgb(204,204,204);padding-left:1ex\">Prueba de correo a= gmail<br> </blockquote></div> --0000000000006238fe05d5ec61c4-- (escribo 5 porque es el \u00faltimo recibido)","title":"Parte 4"},{"location":"ejs-docker-intro/","text":"Ejercicios correo en escenario libvirt Ejercicio 1: Usuarios del mismo servidor Parte 1 Instalar postfix en apolo sudo apt install postfix Selecciono \"Internet Site\": Escribo mi nombre de dominio. Se tomar\u00e1 como dominio origen de los correos que se env\u00eden desde apolo: Parte 2 Instalar mailutils sudo apt install mailutils Parte 3 Usar mail para enviar un correo desde el usuario vagrant al usuario profesor vagrant@apolo:~$ mail profesor@localhost Cc: Subject: Correo para profesor Correo de prueba (para que este correo se env\u00ede, es necesario estar en una nueva l\u00ednea del cuerpo y pulsar Ctrl+D) Parte 4 Leer el correo enviado usando mail en el usuario profesor profesor@apolo:~$ mail \"/var/mail/profesor\": 1 message 1 new >N 1 vagrant@apolo.adri Tue Jan 18 09:38 13/528 Correo para profesor ? 1 Return-Path: <vagrant@apolo.adrianj.gonzalonazareno.org> X-Original-To: profesor@localhost Delivered-To: profesor@localhost Received: by apolo.adrianj.gonzalonazareno.org (Postfix, from userid 1000) id C5521C02CA; Tue, 18 Jan 2022 09:38:24 +0000 (UTC) To: <profesor@localhost> Subject: Correo para profesor X-Mailer: mail (GNU Mailutils 3.10) Message-Id: <20220118093824.C5521C02CA@apolo.adrianj.gonzalonazareno.org> Date: Tue, 18 Jan 2022 09:38:24 +0000 (UTC) From: vagrant@apolo.adrianj.gonzalonazareno.org Correo de prueba ? Ejercicio 2: Usuarios del servidor a correos de internet Parte 1 A\u00f1adir babuino-smtp.gonzalonazareno.org como relayhost en postfix Modifico /etc/postfix/main.cf : relayhost = babuino-smtp.gonzalonazareno.org Modifico los nameserver en apolo de la siguiente manera en /etc/dhcp/dhclient.conf : supersede domain-name-servers 192.168.202.2,127.0.0.1; (he colocado la ip de papion-dns en primer orden para que al hacer relay se resuelva babuino-smtp.gonzalonazareno.org desde nuestra red y no desde Internet. Esto sucede porque apolo no tiene la zona gonzalonazareno.org y por ende acaba preguntando recursivamente) Parte 2 Enviar un correo a adristudy@gmail.com con mail vagrant@apolo:~$ mail -r vagrant@adrianj.gonzalonazareno.org adristudy@gmail.com Cc: Subject: Correo externo Prueba de correo a gmail (es necesario a\u00f1adir con -r la direcci\u00f3n de origen. As\u00ed evitamos que mail use el hostname completo de la m\u00e1quina como dominio de origen, lo cual ser\u00eda incorrecto) Parte 3 Mostrar /var/log/mail.log para verificar que el correo se ha enviado correctamente Muestro la l\u00ednea relevante: Jan 19 09:21:16 apolo postfix/smtp[2764]: 3EA6BC0D9E: to=<adristudy@gmail.com>, relay=babuino-smtp.gonzalonazareno.org[192.168.203.3]:25, delay=0.16, delays=0.06/0.03/0.06/0.01, dsn=2.0.0, status=sent (250 2.0.0 Ok: queued as 571FBFF778) Parte 4 Mostrar el correo en gmail Parte 5 \u00bfC\u00f3mo podemos ver el correo original (en bruto)? Parte 6 Indicar en las cabeceras la ruta de servidores SMTP tomada por el correo desde apolo a gmail (los apartados \"Received\" se leen inversamente) Ejercicio 3: correos desde internet a usuarios del servidor Parte 1 A\u00f1adir registro MX a la vista externa de bind Modifico db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. @ IN MX 10 zeus.adrianj.gonzalonazareno.org. zeus IN A 172.22.0.213 ; clase ; zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus python IN CNAME zeus Reinicio bind sudo systemctl restart bind9 Parte 2 DNAT en zeus redirigiendo el puerto 25 a apolo sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Guardo la regla: iptables-save > /etc/iptables/rules.v4 Parte 3 Responder desde gmail al correo recibido en el ejercicio anterior Muestro mi respuesta: Parte 4 Comprobar en apolo que se ha recibido correctamente el correo mirando /var/log/mail.log Jan 19 09:55:10 apolo postfix/smtpd[2896]: connect from babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/smtpd[2896]: CACBDC0D97: client=babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/cleanup[2900]: CACBDC0D97: message-id=<CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: from=<adristudy@gmail.com>, size=3692, nrcpt=1 (queue active) Jan 19 09:55:10 apolo postfix/smtpd[2896]: disconnect from babuino-smtp.gonzalonazareno.org[192.168.203.3] ehlo=2 starttls=1 mail=1 rcpt=1 data=1 quit=1 commands=7 Jan 19 09:55:10 apolo postfix/local[2901]: CACBDC0D97: to=<vagrant@adrianj.gonzalonazareno.org>, relay=local, delay=0.03, delays=0.02/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox) Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: removed Muestro el correo recibido: vagrant@apolo:~$ mail \"/var/mail/vagrant\": 5 messages 5 new >N 1 adristudy Wed Jan 19 09:41 72/3840 Re: Correo externo N 2 adristudy Wed Jan 19 09:42 70/3685 Re: Correo externo N 3 adristudy Wed Jan 19 09:42 71/3760 Re: Correo externo N 4 adristudy Wed Jan 19 09:47 70/3733 Re: Correo externo N 5 adristudy Wed Jan 19 09:55 71/3760 Re: Correo externo ? 5 Return-Path: <adristudy@gmail.com> X-Original-To: vagrant@adrianj.gonzalonazareno.org Delivered-To: vagrant@adrianj.gonzalonazareno.org Received: from babuino-smtp.gonzalonazareno.org (babuino-smtp.gonzalonazareno.org [192.168.203.3]) by apolo.adrianj.gonzalonazareno.org (Postfix) with ESMTPS id CACBDC0D97 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: from mail-pf1-f179.google.com (mail-pf1-f179.google.com [209.85.210.179]) by babuino-smtp.gonzalonazareno.org (Postfix) with ESMTPS id A2EDAFF779 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: by mail-pf1-f179.google.com with SMTP id i17so2054870pfk.11 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 01:55:10 -0800 (PST) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=SBed1/6ifJBmc3cotOM2KN5vYhx3Emlvd0snQssj4+19q2o0LEwG4yrLoDdmdoGCGk 7akg1xd+ldFO9NFUDRRra5c7y/P0rZ/lOX8TILS7HRYVNnOtn3ko1e540sKhXYFzLeTR MBTBO0f/ru8+6zgQEMRHixsA7FGJldQLLv7TgJEzWSAFORcLg9VmHouXTH5e9+H/44E0 zmkZI7WKS8vcjkVCaCt6Dfh/cjzI2NmQeMXGZzjVN30pLzu4YqcWyPjtjUv30SXSloLt Uz94rZ7Regq/geNg5GyzsYHWBuRINEjDHHbdN7TI9oOWEOt852gu2OgPLVw7Ls+8htyH gktA== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20210112; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=32Kq/nf+UvzvxQJ6ik5lUXbV7vsSA/vYiuKrf3UMopF8/xpmUziglRPbV6YKT77Klj 00L/lqWR03204+B/rMc2fJuZgvL9mF1K7bhU5tUajx7K681EUyEfsb3SoHtFo5rACvpN faB5tspK0JGZpJrzlje+kOn2cMTTmA0fmbG9H1ZaZpbHqS8I88gUe5hTFd6g9b8Duo6D sLhcEt/PDaqpklT20i1dYq9PliJwrfV4w8Fphd1QB8JX6Q+LrfhrD59aLYNxgEXzb4+D le8cMo/T9FBRm1CGwOI4rikgOU7I7gAGk3lfdj7kz2z4WsgZbzNnhi10011eOzZkfWlJ CUSA== X-Gm-Message-State: AOAM532fkZWJWnHiaF36A5Nc+fDMpsESW9z6MSRbA510wCRAVfpBggip Q1wcux1gIM2rqaJXsGRIiqgfjOexLLwBjtgCxx9vw/Rd2Ic= X-Google-Smtp-Source: ABdhPJwFZl8S+5mmB9d4DO93QwZgmwFk0vh06sVosKBDr2J4J3PVhfQWB1g22JvwPa0VNnRtPizZaX37r8W8+b/Q3Yc= X-Received: by 2002:a63:7c10:: with SMTP id x16mr26938561pgc.128.1642586106377; Wed, 19 Jan 2022 01:55:06 -0800 (PST) MIME-Version: 1.0 References: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> In-Reply-To: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> From: adristudy <adristudy@gmail.com> Date: Wed, 19 Jan 2022 10:54:55 +0100 Message-ID: <CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Subject: Re: Correo externo To: vagrant@adrianj.gonzalonazareno.org Content-Type: multipart/alternative; boundary=\"0000000000006238fe05d5ec61c4\" --0000000000006238fe05d5ec61c4 Content-Type: text/plain; charset=\"UTF-8\" respuesta para apolo On Wed, 19 Jan 2022 at 10:21, <vagrant@adrianj.gonzalonazareno.org> wrote: > Prueba de correo a gmail > --0000000000006238fe05d5ec61c4 Content-Type: text/html; charset=\"UTF-8\" Content-Transfer-Encoding: quoted-printable <div dir=3D\"ltr\"><div dir=3D\"ltr\"><div dir=3D\"ltr\">respuesta para apolo</di= v></div></div><br><div class=3D\"gmail_quote\"><div dir=3D\"ltr\" class=3D\"gmai= l_attr\">On Wed, 19 Jan 2022 at 10:21, &lt;<a href=3D\"mailto:vagrant@adrianj= .gonzalonazareno.org\">vagrant@adrianj.gonzalonazareno.org</a>&gt; wrote:<br= ></div><blockquote class=3D\"gmail_quote\" style=3D\"margin:0px 0px 0px 0.8ex;= border-left:1px solid rgb(204,204,204);padding-left:1ex\">Prueba de correo a= gmail<br> </blockquote></div> --0000000000006238fe05d5ec61c4-- (escribo 5 porque es el \u00faltimo recibido)","title":"Ejercicios correo en escenario libvirt"},{"location":"ejs-docker-intro/#ejercicios-correo-en-escenario-libvirt","text":"","title":"Ejercicios correo en escenario libvirt"},{"location":"ejs-docker-intro/#ejercicio-1-usuarios-del-mismo-servidor","text":"","title":"Ejercicio 1: Usuarios del mismo servidor"},{"location":"ejs-docker-intro/#parte-1","text":"Instalar postfix en apolo sudo apt install postfix Selecciono \"Internet Site\": Escribo mi nombre de dominio. Se tomar\u00e1 como dominio origen de los correos que se env\u00eden desde apolo:","title":"Parte 1"},{"location":"ejs-docker-intro/#parte-2","text":"Instalar mailutils sudo apt install mailutils","title":"Parte 2"},{"location":"ejs-docker-intro/#parte-3","text":"Usar mail para enviar un correo desde el usuario vagrant al usuario profesor vagrant@apolo:~$ mail profesor@localhost Cc: Subject: Correo para profesor Correo de prueba (para que este correo se env\u00ede, es necesario estar en una nueva l\u00ednea del cuerpo y pulsar Ctrl+D)","title":"Parte 3"},{"location":"ejs-docker-intro/#parte-4","text":"Leer el correo enviado usando mail en el usuario profesor profesor@apolo:~$ mail \"/var/mail/profesor\": 1 message 1 new >N 1 vagrant@apolo.adri Tue Jan 18 09:38 13/528 Correo para profesor ? 1 Return-Path: <vagrant@apolo.adrianj.gonzalonazareno.org> X-Original-To: profesor@localhost Delivered-To: profesor@localhost Received: by apolo.adrianj.gonzalonazareno.org (Postfix, from userid 1000) id C5521C02CA; Tue, 18 Jan 2022 09:38:24 +0000 (UTC) To: <profesor@localhost> Subject: Correo para profesor X-Mailer: mail (GNU Mailutils 3.10) Message-Id: <20220118093824.C5521C02CA@apolo.adrianj.gonzalonazareno.org> Date: Tue, 18 Jan 2022 09:38:24 +0000 (UTC) From: vagrant@apolo.adrianj.gonzalonazareno.org Correo de prueba ?","title":"Parte 4"},{"location":"ejs-docker-intro/#ejercicio-2-usuarios-del-servidor-a-correos-de-internet","text":"","title":"Ejercicio 2: Usuarios del servidor a correos de internet"},{"location":"ejs-docker-intro/#parte-1_1","text":"A\u00f1adir babuino-smtp.gonzalonazareno.org como relayhost en postfix Modifico /etc/postfix/main.cf : relayhost = babuino-smtp.gonzalonazareno.org Modifico los nameserver en apolo de la siguiente manera en /etc/dhcp/dhclient.conf : supersede domain-name-servers 192.168.202.2,127.0.0.1; (he colocado la ip de papion-dns en primer orden para que al hacer relay se resuelva babuino-smtp.gonzalonazareno.org desde nuestra red y no desde Internet. Esto sucede porque apolo no tiene la zona gonzalonazareno.org y por ende acaba preguntando recursivamente)","title":"Parte 1"},{"location":"ejs-docker-intro/#parte-2_1","text":"Enviar un correo a adristudy@gmail.com con mail vagrant@apolo:~$ mail -r vagrant@adrianj.gonzalonazareno.org adristudy@gmail.com Cc: Subject: Correo externo Prueba de correo a gmail (es necesario a\u00f1adir con -r la direcci\u00f3n de origen. As\u00ed evitamos que mail use el hostname completo de la m\u00e1quina como dominio de origen, lo cual ser\u00eda incorrecto)","title":"Parte 2"},{"location":"ejs-docker-intro/#parte-3_1","text":"Mostrar /var/log/mail.log para verificar que el correo se ha enviado correctamente Muestro la l\u00ednea relevante: Jan 19 09:21:16 apolo postfix/smtp[2764]: 3EA6BC0D9E: to=<adristudy@gmail.com>, relay=babuino-smtp.gonzalonazareno.org[192.168.203.3]:25, delay=0.16, delays=0.06/0.03/0.06/0.01, dsn=2.0.0, status=sent (250 2.0.0 Ok: queued as 571FBFF778)","title":"Parte 3"},{"location":"ejs-docker-intro/#parte-4_1","text":"Mostrar el correo en gmail","title":"Parte 4"},{"location":"ejs-docker-intro/#parte-5","text":"\u00bfC\u00f3mo podemos ver el correo original (en bruto)?","title":"Parte 5"},{"location":"ejs-docker-intro/#parte-6","text":"Indicar en las cabeceras la ruta de servidores SMTP tomada por el correo desde apolo a gmail (los apartados \"Received\" se leen inversamente)","title":"Parte 6"},{"location":"ejs-docker-intro/#ejercicio-3-correos-desde-internet-a-usuarios-del-servidor","text":"","title":"Ejercicio 3: correos desde internet a usuarios del servidor"},{"location":"ejs-docker-intro/#parte-1_2","text":"A\u00f1adir registro MX a la vista externa de bind Modifico db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. @ IN MX 10 zeus.adrianj.gonzalonazareno.org. zeus IN A 172.22.0.213 ; clase ; zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus python IN CNAME zeus Reinicio bind sudo systemctl restart bind9","title":"Parte 1"},{"location":"ejs-docker-intro/#parte-2_2","text":"DNAT en zeus redirigiendo el puerto 25 a apolo sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Guardo la regla: iptables-save > /etc/iptables/rules.v4","title":"Parte 2"},{"location":"ejs-docker-intro/#parte-3_2","text":"Responder desde gmail al correo recibido en el ejercicio anterior Muestro mi respuesta:","title":"Parte 3"},{"location":"ejs-docker-intro/#parte-4_2","text":"Comprobar en apolo que se ha recibido correctamente el correo mirando /var/log/mail.log Jan 19 09:55:10 apolo postfix/smtpd[2896]: connect from babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/smtpd[2896]: CACBDC0D97: client=babuino-smtp.gonzalonazareno.org[192.168.203.3] Jan 19 09:55:10 apolo postfix/cleanup[2900]: CACBDC0D97: message-id=<CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: from=<adristudy@gmail.com>, size=3692, nrcpt=1 (queue active) Jan 19 09:55:10 apolo postfix/smtpd[2896]: disconnect from babuino-smtp.gonzalonazareno.org[192.168.203.3] ehlo=2 starttls=1 mail=1 rcpt=1 data=1 quit=1 commands=7 Jan 19 09:55:10 apolo postfix/local[2901]: CACBDC0D97: to=<vagrant@adrianj.gonzalonazareno.org>, relay=local, delay=0.03, delays=0.02/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox) Jan 19 09:55:10 apolo postfix/qmgr[2654]: CACBDC0D97: removed Muestro el correo recibido: vagrant@apolo:~$ mail \"/var/mail/vagrant\": 5 messages 5 new >N 1 adristudy Wed Jan 19 09:41 72/3840 Re: Correo externo N 2 adristudy Wed Jan 19 09:42 70/3685 Re: Correo externo N 3 adristudy Wed Jan 19 09:42 71/3760 Re: Correo externo N 4 adristudy Wed Jan 19 09:47 70/3733 Re: Correo externo N 5 adristudy Wed Jan 19 09:55 71/3760 Re: Correo externo ? 5 Return-Path: <adristudy@gmail.com> X-Original-To: vagrant@adrianj.gonzalonazareno.org Delivered-To: vagrant@adrianj.gonzalonazareno.org Received: from babuino-smtp.gonzalonazareno.org (babuino-smtp.gonzalonazareno.org [192.168.203.3]) by apolo.adrianj.gonzalonazareno.org (Postfix) with ESMTPS id CACBDC0D97 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: from mail-pf1-f179.google.com (mail-pf1-f179.google.com [209.85.210.179]) by babuino-smtp.gonzalonazareno.org (Postfix) with ESMTPS id A2EDAFF779 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 09:55:10 +0000 (UTC) Received: by mail-pf1-f179.google.com with SMTP id i17so2054870pfk.11 for <vagrant@adrianj.gonzalonazareno.org>; Wed, 19 Jan 2022 01:55:10 -0800 (PST) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=SBed1/6ifJBmc3cotOM2KN5vYhx3Emlvd0snQssj4+19q2o0LEwG4yrLoDdmdoGCGk 7akg1xd+ldFO9NFUDRRra5c7y/P0rZ/lOX8TILS7HRYVNnOtn3ko1e540sKhXYFzLeTR MBTBO0f/ru8+6zgQEMRHixsA7FGJldQLLv7TgJEzWSAFORcLg9VmHouXTH5e9+H/44E0 zmkZI7WKS8vcjkVCaCt6Dfh/cjzI2NmQeMXGZzjVN30pLzu4YqcWyPjtjUv30SXSloLt Uz94rZ7Regq/geNg5GyzsYHWBuRINEjDHHbdN7TI9oOWEOt852gu2OgPLVw7Ls+8htyH gktA== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20210112; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bh=UBRzoQFstQM7RXR6pMZdQeQN69KQeIge6p3HzfH8Cnw=; b=32Kq/nf+UvzvxQJ6ik5lUXbV7vsSA/vYiuKrf3UMopF8/xpmUziglRPbV6YKT77Klj 00L/lqWR03204+B/rMc2fJuZgvL9mF1K7bhU5tUajx7K681EUyEfsb3SoHtFo5rACvpN faB5tspK0JGZpJrzlje+kOn2cMTTmA0fmbG9H1ZaZpbHqS8I88gUe5hTFd6g9b8Duo6D sLhcEt/PDaqpklT20i1dYq9PliJwrfV4w8Fphd1QB8JX6Q+LrfhrD59aLYNxgEXzb4+D le8cMo/T9FBRm1CGwOI4rikgOU7I7gAGk3lfdj7kz2z4WsgZbzNnhi10011eOzZkfWlJ CUSA== X-Gm-Message-State: AOAM532fkZWJWnHiaF36A5Nc+fDMpsESW9z6MSRbA510wCRAVfpBggip Q1wcux1gIM2rqaJXsGRIiqgfjOexLLwBjtgCxx9vw/Rd2Ic= X-Google-Smtp-Source: ABdhPJwFZl8S+5mmB9d4DO93QwZgmwFk0vh06sVosKBDr2J4J3PVhfQWB1g22JvwPa0VNnRtPizZaX37r8W8+b/Q3Yc= X-Received: by 2002:a63:7c10:: with SMTP id x16mr26938561pgc.128.1642586106377; Wed, 19 Jan 2022 01:55:06 -0800 (PST) MIME-Version: 1.0 References: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> In-Reply-To: <20220119092116.3EA6BC0D9E@apolo.adrianj.gonzalonazareno.org> From: adristudy <adristudy@gmail.com> Date: Wed, 19 Jan 2022 10:54:55 +0100 Message-ID: <CAG5uPReLQZ4YoD=8YG+JrvE6SYUjseL0M-NyD83KNoGHHbmzEw@mail.gmail.com> Subject: Re: Correo externo To: vagrant@adrianj.gonzalonazareno.org Content-Type: multipart/alternative; boundary=\"0000000000006238fe05d5ec61c4\" --0000000000006238fe05d5ec61c4 Content-Type: text/plain; charset=\"UTF-8\" respuesta para apolo On Wed, 19 Jan 2022 at 10:21, <vagrant@adrianj.gonzalonazareno.org> wrote: > Prueba de correo a gmail > --0000000000006238fe05d5ec61c4 Content-Type: text/html; charset=\"UTF-8\" Content-Transfer-Encoding: quoted-printable <div dir=3D\"ltr\"><div dir=3D\"ltr\"><div dir=3D\"ltr\">respuesta para apolo</di= v></div></div><br><div class=3D\"gmail_quote\"><div dir=3D\"ltr\" class=3D\"gmai= l_attr\">On Wed, 19 Jan 2022 at 10:21, &lt;<a href=3D\"mailto:vagrant@adrianj= .gonzalonazareno.org\">vagrant@adrianj.gonzalonazareno.org</a>&gt; wrote:<br= ></div><blockquote class=3D\"gmail_quote\" style=3D\"margin:0px 0px 0px 0.8ex;= border-left:1px solid rgb(204,204,204);padding-left:1ex\">Prueba de correo a= gmail<br> </blockquote></div> --0000000000006238fe05d5ec61c4-- (escribo 5 porque es el \u00faltimo recibido)","title":"Parte 4"},{"location":"perimetral-iptables-escenario/","text":"Pr\u00e1ctica iptables: perimetral sobre escenario ATENCI\u00d3N: La IP p\u00fablica de Zeus en este escenario es posible que cambie durante las demostraciones ya que este es un escenario que funciona tanto en clase como en casa, y existen 2 direccionamientos distintos. Parte 1 Mostrar escenario del que se parte Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :zeus do |zeus| zeus.vm.box = \"debian/bullseye64\" zeus.vm.hostname = \"zeus\" zeus.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" zeus.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.1\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" zeus.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :hera do |hera| hera.vm.box = \"rockylinux/8\" hera.vm.hostname = \"hera\" hera.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.200\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :apolo do |apolo| apolo.vm.box = \"debian/bullseye64\" apolo.vm.hostname = \"apolo\" apolo.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.102\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :ares do |ares| ares.vm.box = \"generic/ubuntu2004\" ares.vm.hostname = \"ares\" ares.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.101\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end Parte 2 Mostrar el estado iptables del que se parte Tabla filter: vagrant@zeus:~$ sudo iptables -L -v -n # Warning: iptables-legacy tables present, use iptables-legacy to see them Chain INPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Tabla nat: vagrant@zeus:~$ sudo iptables -L -v -n -t nat # Warning: iptables-legacy tables present, use iptables-legacy to see them Chain PREROUTING (policy ACCEPT 437 packets, 87098 bytes) pkts bytes target prot opt in out source destination 0 0 DNAT udp -- eth1 * 0.0.0.0/0 0.0.0.0/0 udp dpt:53 to:10.0.1.102:53 0 0 DNAT tcp -- eth1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 to:172.16.0.200:80 0 0 DNAT tcp -- eth1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:25 to:10.0.1.102:25 Chain INPUT (policy ACCEPT 41 packets, 10816 bytes) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 12 packets, 873 bytes) pkts bytes target prot opt in out source destination Chain POSTROUTING (policy ACCEPT 4 packets, 257 bytes) pkts bytes target prot opt in out source destination 36 2986 MASQUERADE all -- * eth1 0.0.0.0/0 0.0.0.0/0 Mismas reglas NAT pero en comandos: sudo iptables -t nat -A PREROUTING -i eth1 -p udp --dport 53 -j DNAT --to-destination 10.0.1.102:53 sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.200:80 sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE Parte 3 Redigir puertos 2222-22 en Zeus desde el exterior DNAT para mi casa y para clase: sudo iptables -t nat -A PREROUTING -i eth1 -s 172.22.0.0/16 -p tcp --dport 2222 -j DNAT --to-destination 172.22.0.213:22 sudo iptables -t nat -A PREROUTING -i eth1 -s 192.168.1.0/24 -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.115:22 Parte 4 Permitir tr\u00e1fico ssh entrante exterior \u2192 Zeus sudo iptables -A INPUT -i eth1 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -o eth1 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh zeus-casa Linux zeus 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 @@@@@@@@ @@@@@@@@ @@@ @@@ @@@@@@ @@! @@! @@! @@@ !@@ @!! @!!!:! @!@ !@! !@@!! !!: !!: !!: !!! !:! :.::.: : : :: ::: :.:: : ::.: : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sun Feb 6 16:53:51 2022 from 192.168.1.106 vagrant@zeus:~$ (no escribo el puerto 2222 al conectar porque ya est\u00e1 en mi config ssh. Ver la siguiente parte para m\u00e1s informaci\u00f3n) Que funcione esta conexi\u00f3n significa que tanto las reglas de este paso como del anterior funcionan. Parte 5 Permitir tr\u00e1fico ssh para hacer proxyjump desde zeus Seg\u00fan como estaba planteado nuestro escenario, se ten\u00eda que acceder a la DMZ y a la LAN a trav\u00e9s de zeus por ssh. Esto nos obliga a a\u00f1adir reglas INPUT/OUPUT desde zeus hacia estas redes, para que el salto SSH pueda funcionar. Muestro la parte correspondiente de mi .ssh/config , para que sepamos de d\u00f3nde partimos: ##################### # escenario libvirt # ##################### Host zeus-clase HostName 172.22.0.213 User vagrant Port 2222 Host zeus-casa HostName 192.168.1.115 User vagrant Port 2222 Host apolo-clase HostName 10.0.1.102 User vagrant ProxyJump zeus-clase Host apolo-casa HostName 10.0.1.102 User vagrant ProxyJump zeus-casa Host ares-clase HostName 10.0.1.101 User vagrant ProxyJump zeus-clase Host ares-casa HostName 10.0.1.101 User vagrant ProxyJump zeus-casa Host hera-clase HostName 172.16.0.200 User vagrant ProxyJump zeus-clase Host hera-casa HostName 172.16.0.200 User vagrant ProxyJump zeus-casa Tr\u00e1fico ssh saliente zeus \u2192 DMZ: sudo iptables -A OUTPUT -o eth2 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth2 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Tr\u00e1fico ssh saliente zeus \u2192 LAN: sudo iptables -A OUTPUT -o eth3 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth3 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que puedo conectar a Hera desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh hera-casa @@@ @@@ @@@@@@@@ @@@@@@@ @@@@@@ @@! @@@ @@! @@! @@@ @@! @@@ @!@!@!@! @!!!:! @!@!!@! @!@!@!@! !!: !!! !!: !!: :!! !!: !!! : : : : :: ::: : : : : : : Last login: Sun Feb 6 16:08:56 2022 from 172.16.0.1 [vagrant@hera ~]$ Pruebo que puedo conectar a Apolo desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh apolo-casa Linux apolo 5.10.0-10-amd64 #1 SMP Debian 5.10.84-1 (2021-12-08) x86_64 @@@@@@ @@@@@@@ @@@@@@ @@@ @@@@@@ @@! @@@ @@! @@@ @@! @@@ @@! @@! @@@ @!@!@!@! @!@@!@! @!@ !@! @!! @!@ !@! !!: !!! !!: !!: !!! !!: !!: !!! : : : : : :. : : ::.: : : :. : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have mail. Last login: Sun Feb 6 16:07:35 2022 from 10.0.1.1 vagrant@apolo:~$ Pruebo que puedo conectar a Ares desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh ares-casa @@@@@@ @@@@@@@ @@@@@@@@ @@@@@@ @@! @@@ @@! @@@ @@! !@@ @!@!@!@! @!@!!@! @!!!:! !@@!! !!: !!! !!: :!! !!: !:! : : : : : : : :: ::: ::.: : Last login: Thu Feb 3 12:06:44 2022 from 192.168.121.1 vagrant@ares:~$ Parte 6 Pol\u00edticas por defecto sudo iptables -P INPUT DROP sudo iptables -P OUTPUT DROP sudo iptables -P FORWARD DROP Si no se nos cortan las conexiones ssh a las m\u00e1quinas despu\u00e9s de este paso, las reglas que aplicamos antes funcionan. Parte 7 Permitir tr\u00e1fico ssh Apolo-Hera \u2192 Zeus sudo iptables -A INPUT -s 10.0.1.102,172.16.0.200 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -d 10.0.1.102,172.16.0.200 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Apolo: vagrant@apolo:~$ ssh vagrant@10.0.1.1 Linux zeus 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 @@@@@@@@ @@@@@@@@ @@@ @@@ @@@@@@ @@! @@! @@! @@@ !@@ @!! @!!!:! @!@ !@! !@@!! !!: !!: !!: !!! !:! :.::.: : : :: ::: :.:: : ::.: : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sun Feb 6 17:38:17 2022 from 10.0.1.102 vagrant@zeus:~$ Pruebo que funciona desde Hera: [vagrant@hera ~]$ ssh vagrant@172.16.0.1 Linux zeus 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 @@@@@@@@ @@@@@@@@ @@@ @@@ @@@@@@ @@! @@! @@! @@@ !@@ @!! @!!!:! @!@ !@! !@@!! !!: !!: !!: !!! !:! :.::.: : : :: ::: :.:: : ::.: : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sun Feb 6 17:38:19 2022 from 10.0.1.102 vagrant@zeus:~$ Parte 8 Permitir tr\u00e1fico loopback en Zeus sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT sudo iptables -A INPUT -i lo -p icmp -j ACCEPT Ya funciona el ping a localhost: vagrant@zeus:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.064 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.095 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1020ms rtt min/avg/max/mdev = 0.064/0.079/0.095/0.015 ms Parte 9 Permitir ping entrante DMZ \u2192 Zeus sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A OUTPUT -o eth2 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona desde Hera: [vagrant@hera ~]$ ping 172.16.0.1 PING 172.16.0.1 (172.16.0.1) 56(84) bytes of data. 64 bytes from 172.16.0.1: icmp_seq=1 ttl=64 time=0.267 ms 64 bytes from 172.16.0.1: icmp_seq=2 ttl=64 time=0.492 ms ^C --- 172.16.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1020ms rtt min/avg/max/mdev = 0.267/0.379/0.492/0.114 ms Parte 10 Rechazar ping entrante LAN \u2192 Zeus sudo iptables -A INPUT -i eth3 -p icmp -m icmp --icmp-type echo-request -j REJECT Pruebo que bloquea el ping desde Ares: vagrant@ares:~$ ping 10.0.1.1 PING 10.0.1.1 (10.0.1.1) 56(84) bytes of data. ^C --- 10.0.1.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2037ms Parte 11 Bloquear ping entrante exterior \u2192 Zeus La pol\u00edtica por defecto de INPUT la tenemos a DROP, y tampoco tenemos reglas en este momento que acepten el ping entrante desde el exterior (eth1) : Chain INPUT (policy DROP 37915 packets, 1859K bytes) pkts bytes target prot opt in out source destination 19351 1298K ACCEPT tcp -- eth1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:22 state NEW,ESTABLISHED 221 47538 ACCEPT tcp -- eth2 * 0.0.0.0/0 0.0.0.0/0 tcp spt:22 state ESTABLISHED 83 14061 ACCEPT tcp -- eth3 * 0.0.0.0/0 0.0.0.0/0 tcp spt:22 state ESTABLISHED 115 14256 ACCEPT tcp -- * * 10.0.1.102 0.0.0.0/0 tcp dpt:22 state NEW,ESTABLISHED 66 9222 ACCEPT tcp -- * * 172.16.0.200 0.0.0.0/0 tcp dpt:22 state NEW,ESTABLISHED 8 672 ACCEPT icmp -- lo * 0.0.0.0/0 0.0.0.0/0 6 504 ACCEPT icmp -- eth2 * 0.0.0.0/0 0.0.0.0/0 icmptype 8 11 924 REJECT icmp -- eth3 * 0.0.0.0/0 0.0.0.0/0 icmptype 8 reject-with icmp-port-unreachable Esto significa que no necesitamos a\u00f1adir ninguna regla adicional para que se deniegue el ping entrante a Zeus desde el exterior. Parte 12 Permitir ping saliente Zeus \u2192 LAN-DMZ sudo iptables -A OUTPUT -d 10.0.1.0/24,172.16.0.0/16 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -s 10.0.1.0/24,172.16.0.0/16 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona el ping a Hera: vagrant@zeus:~$ ping 172.16.0.200 PING 172.16.0.200 (172.16.0.200) 56(84) bytes of data. 64 bytes from 172.16.0.200: icmp_seq=1 ttl=64 time=0.675 ms 64 bytes from 172.16.0.200: icmp_seq=2 ttl=64 time=0.584 ms ^C --- 172.16.0.200 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1030ms rtt min/avg/max/mdev = 0.584/0.629/0.675/0.045 ms Pruebo que funciona el ping a Ares: vagrant@zeus:~$ ping 10.0.1.101 PING 10.0.1.101 (10.0.1.101) 56(84) bytes of data. 64 bytes from 10.0.1.101: icmp_seq=1 ttl=64 time=0.532 ms 64 bytes from 10.0.1.101: icmp_seq=2 ttl=64 time=0.359 ms ^C --- 10.0.1.101 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1020ms rtt min/avg/max/mdev = 0.359/0.445/0.532/0.086 ms Parte 13 Permitir ping saliente Zeus \u2192 exterior sudo iptables -A OUTPUT -o eth1 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -i eth1 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona: vagrant@zeus:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=55 time=19.1 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=55 time=19.8 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 19.103/19.468/19.834/0.365 ms Parte 14 Permitir ping Hera \u2192 LAN sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona haciendo ping a Ares: [vagrant@hera ~]$ ping 10.0.1.101 PING 10.0.1.101 (10.0.1.101) 56(84) bytes of data. 64 bytes from 10.0.1.101: icmp_seq=1 ttl=63 time=1.94 ms 64 bytes from 10.0.1.101: icmp_seq=2 ttl=63 time=0.898 ms ^C --- 10.0.1.101 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.898/1.417/1.937/0.520 ms Parte 15 Permitir tr\u00e1fico ssh Hera \u2192 LAN sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona haciendo ssh a Ares: [vagrant@hera ~]$ ssh vagrant@10.0.1.101 @@@@@@ @@@@@@@ @@@@@@@@ @@@@@@ @@! @@@ @@! @@@ @@! !@@ @!@!@!@! @!@!!@! @!!!:! !@@!! !!: !!! !!: :!! !!: !:! : : : : : : : :: ::: ::.: : Last login: Mon Feb 7 00:09:02 2022 from 172.16.0.200 vagrant@ares:~$ Parte 16 Permitir tr\u00e1fico ssh LAN \u2192 Hera sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Ares: vagrant@ares:~$ ssh vagrant@172.16.0.200 @@@ @@@ @@@@@@@@ @@@@@@@ @@@@@@ @@! @@@ @@! @@! @@@ @@! @@@ @!@!@!@! @!!!:! @!@!!@! @!@!@!@! !!: !!! !!: !!: :!! !!: !!! : : : : :: ::: : : : : : : Last login: Sun Feb 6 16:56:24 2022 from 172.16.0.1 [vagrant@hera ~]$ Parte 17 Permitir ping LAN-DMZ \u2192 exterior sudo iptables -A FORWARD -s 10.0.1.0/24,172.16.0.0/16 -o eth1 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 10.0.1.0/24,172.16.0.0/16 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Tenemos, porque lo hicimos en una anterior pr\u00e1ctica sobre el escenario, una regla de SNAT que entra en juego en este apartado, as\u00ed que no la tenemos que volver a a\u00f1adir. Es la siguiente: sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE Pruebo que funciona desde Hera: [vagrant@hera ~]$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=19.4 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=14.7 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 14.739/17.069/19.400/2.334 ms Pruebo que funciona desde Ares: vagrant@ares:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=14.4 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=14.1 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 14.081/14.255/14.430/0.174 ms Parte 18 LAN puede navegar sudo iptables -A FORWARD -i eth3 -o eth1 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth3 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http desde Ares: vagrant@ares:~$ telnet 52.47.209.216 80 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Pruebo que funciona el tr\u00e1fico https desde Apolo: vagrant@apolo:~$ telnet 52.47.209.216 443 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Parte 19 Hera puede navegar sudo iptables -A FORWARD -s 172.16.0.200 -o eth1 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 172.16.0.200 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http: [vagrant@hera ~]$ telnet 52.47.209.216 80 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Pruebo que funciona el tr\u00e1fico https: [vagrant@hera ~]$ telnet 52.47.209.216 443 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Parte 20 Tenemos que instalar en Hera un servidor de correos y un servidor ftp. Servidor de correo Instalo: sudo dnf install postfix Modifico /etc/postfix/main.cf para que acepte peticiones desde cualquier IP y no s\u00f3lo desde localhost (es como est\u00e1 por defecto) : inet_interfaces = all Inicio postfix: sudo systemctl start postfix Compruebo que est\u00e1 escuchando el puerto correctamente: [vagrant@hera ~]$ sudo ss -tulpn | grep LISTEN tcp LISTEN 0 128 0.0.0.0:111 0.0.0.0:* users:((\"rpcbind\",pid=603,fd=4),(\"systemd\",pid=1,fd=88)) tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:* users:((\"sshd\",pid=670,fd=4)) tcp LISTEN 0 100 0.0.0.0:25 0.0.0.0:* users:((\"master\",pid=32765,fd=16)) tcp LISTEN 0 128 [::]:111 [::]:* users:((\"rpcbind\",pid=603,fd=6),(\"systemd\",pid=1,fd=90)) tcp LISTEN 0 128 *:80 *:* users:((\"httpd\",pid=720,fd=4),(\"httpd\",pid=719,fd=4),(\"httpd\",pid=718,fd=4),(\"httpd\",pid=701,fd=4)) tcp LISTEN 0 128 [::]:22 [::]:* users:((\"sshd\",pid=670,fd=6)) tcp LISTEN 0 100 [::]:25 [::]:* users:((\"master\",pid=32765,fd=17)) Servidor FTP sudo dnf install vsftpd sudo systemctl start vsftpd Compruebo que est\u00e1 escuchando el puerto correctamente: [vagrant@hera ~]$ sudo ss -tulpn | grep LISTEN tcp LISTEN 0 128 0.0.0.0:111 0.0.0.0:* users:((\"rpcbind\",pid=603,fd=4),(\"systemd\",pid=1,fd=88)) tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:* users:((\"sshd\",pid=670,fd=4)) tcp LISTEN 0 100 0.0.0.0:25 0.0.0.0:* users:((\"master\",pid=32765,fd=16)) tcp LISTEN 0 128 [::]:111 [::]:* users:((\"rpcbind\",pid=603,fd=6),(\"systemd\",pid=1,fd=90)) tcp LISTEN 0 128 *:80 *:* users:((\"httpd\",pid=720,fd=4),(\"httpd\",pid=719,fd=4),(\"httpd\",pid=718,fd=4),(\"httpd\",pid=701,fd=4)) tcp LISTEN 0 32 *:21 *:* users:((\"vsftpd\",pid=32862,fd=3)) tcp LISTEN 0 128 [::]:22 [::]:* users:((\"sshd\",pid=670,fd=6)) tcp LISTEN 0 100 [::]:25 [::]:* users:((\"master\",pid=32765,fd=17)) Parte 21 Permitir tr\u00e1fico exterior \u2192 Hera para Web-FTP La regla DNAT web ya la ten\u00eda previamente, as\u00ed que no hace falta a\u00f1adirla. La recuerdo: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.200:80 A\u00f1ado la regla DNAT FTP: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 21 -j DNAT --to-destination 172.16.0.200:21 Reglas forward web: sudo iptables -A FORWARD -i eth1 -d 172.16.0.200 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth1 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http a Hera desde mi host: atlas@olympus:~$ telnet 172.22.0.213 80 Trying 172.22.0.213... Connected to 172.22.0.213. Escape character is '^]'. Reglas forward ftp: sudo iptables -A FORWARD -i eth1 -d 172.16.0.200 -p tcp --dport 21 -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth1 -p tcp --sport 21 -j ACCEPT Pruebo que funciona el tr\u00e1fico ftp a Hera desde mi host: atlas@olympus:~$ telnet 172.22.0.213 21 Trying 172.22.0.213... Connected to 172.22.0.213. Escape character is '^]'. 220 (vsFTPd 3.0.3) Parte 22 Permitir tr\u00e1fico LAN \u2192 Hera para Web-FTP Reglas forward web: sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http a Hera desde Ares: vagrant@ares:~$ telnet 172.16.0.200 80 Trying 172.16.0.200... Connected to 172.16.0.200. Escape character is '^]'. Reglas forward ftp: sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 21 -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 21 -j ACCEPT Pruebo que funciona el tr\u00e1fico ftp a Hera desde Apolo: vagrant@apolo:~$ telnet 172.16.0.200 21 Trying 172.16.0.200... Connected to 172.16.0.200. Escape character is '^]'. 220 (vsFTPd 3.0.3) Parte 23 Permitir tr\u00e1fico LAN \u2192 Hera al servidor correo, pero no se podr\u00e1 acceder desde otro sitio sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 25 -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 25 -j ACCEPT Pruebo que funciona desde Ares: vagrant@ares:~$ telnet 172.16.0.200 25 Trying 172.16.0.200... Connected to 172.16.0.200. Escape character is '^]'. 220 hera.localdomain ESMTP Postfix Realmente no tendr\u00eda por qu\u00e9 hacerlo porque no influye, pero para que quede todo m\u00e1s limpio, eliminar\u00e9 la regla DNAT 25 que ten\u00edamos previamente por el escenario: Desde el exterior igualmente no podr\u00edamos tener acceso al servidor de correos antiguo de Apolo porque aunque tengamos esa regla DNAT, no hemos hecho en ning\u00fan momento reglas forward hacia Apolo. La elimino: sudo iptables -t nat -D PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Parte 24 Permitir tr\u00e1fico DMZ \u2192 Ares al servidor mysql. No se podr\u00e1 acceder desde el exterior sudo iptables -A FORWARD -i eth2 -d 10.0.1.101 -p tcp --dport 3306 -j ACCEPT sudo iptables -A FORWARD -s 10.0.1.101 -o eth2 -p tcp --sport 3306 -j ACCEPT Pruebo que funciona desde Hera: [vagrant@hera ~]$ sudo mysql -u root -h 10.0.1.101 -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 45 Server version: 10.3.31-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. MariaDB [(none)]> Desde el exterior no podremos acceder claramente, porque no existe una regla DNAT v\u00e1lida: Parte 25 Bloquear ICMP Flood limitando el n\u00famero de peticiones por segundo Desde el exterior y la LAN hemos bloqueado el tr\u00e1fico ICMP as\u00ed que no tenemos que preocuparnos por ataques de flood. Desde la DMZ s\u00ed tenemos permitido el tr\u00e1fico, as\u00ed que lo tenemos que limitar . Primero voy a realizar un ataque desde Hera a Zeus sin l\u00edmite de protecci\u00f3n y mostrar\u00e9 lo que suceder\u00eda. Este es el comando de ataque que ejecutar\u00e9 en Hera: sudo ping -f -s 56500 172.16.0.1 Hago el ataque, y as\u00ed se quedar\u00edan los contadores despu\u00e9s de varios segundos: Borro la regla, y la vuelvo a a\u00f1adir con un l\u00edmite de protecci\u00f3n: sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 1 -j ACCEPT Vuelvo a lanzar el ataque, y veo c\u00f3mo se quedan los contadores despu\u00e9s de varios segundos: 4 paquetes, habiendo limitado el tr\u00e1fico a 1 por segundo significa que he lanzado el ataque por 4 segundos, pero s\u00f3lo 1 paquete se permiti\u00f3 gracias al l\u00edmite. Funciona correctamente. Parte 26 Bloquear SYN Flood Necesitamos esta regla para limitar: sudo iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT PERO en mi caso no la necesito, porque he comprobado que la pol\u00edtica por defecto DROP en INPUT bloquea el ataque de flood. Este es el comando de ataque que necesitamos, usando como ejemplo el puerto 80 (partiendo de que sabemos que est\u00e1 abierto y redirigido a Hera) : sudo hping3 -p 80 --flood --rand-source 192.168.1.115 Borro los contadores para esta prueba, y lanzo el ataque durante varios segundos. Vemos que la pol\u00edtica DROP ha cortado el ataque: Sabemos que esos paquetes son del ataque porque el contador estaba a 0 previamente, y me fij\u00e9 que no aumentase al no hacer nada por varios segundos. Tambi\u00e9n hay que tener en cuenta que esa cantidad de paquetes en varios segundos no es algo normal, teniendo en cuenta que durante la prueba el \u00fanico tr\u00e1fico que estaba llegando a Zeus era el ataque. Parte 27 Bloquear escaneos de puertos a Zeus. L\u00f3gica base Seg\u00fan he investigado existen ciertas reglas que dicen bloquear los escaneos de puertos, pero al probarlas no funcionan. Despu\u00e9s de indagar he llegado a este post que dice algo bastante interesante: \"Lo l\u00f3gico es usar una pol\u00edtica DROP y s\u00f3lo permitir el tr\u00e1fico que queramos. No hay manera alguna de bloquear escaneos de puertos sin que se llegue a bloquear tr\u00e1fico leg\u00edtimo.\" Esto adem\u00e1s de interesante tiene mucho sentido, porque si bloque\u00e1ramos tr\u00e1fico a todos los puertos a su vez perder\u00edamos todo tipo de conexi\u00f3n que fuese leg\u00edtima. Evidentemente esto no es lo que queremos. Al final, esto se traduce a que cuando se use nmap se mostrar\u00e1n los puertos abiertos, pero ninguno m\u00e1s. Queda como tarea del administrador el que el tr\u00e1fico a esos puertos est\u00e9 correctamente protegido y dirigido. Prueba 1 Partiendo de la l\u00f3gica base que es casi cierta en su totalidad, realmente hay algunas medidas que podemos tomar. Intentaremos logear accesos a un puerto que sabemos que est\u00e1 cerrado. Si intentan acceder a \u00e9l, se puede entender que es un atacante porque alguien que quiera acceder leg\u00edtimamente sabr\u00eda qu\u00e9 puertos est\u00e1n abiertos. Regla: sudo iptables -A INPUT -p tcp -m tcp --dport 19 -j LOG --log-level 1 --log-prefix \"PortScan\" Lanzamos nmap desde nuestro host a Zeus: atlas@olympus:~$ nmap 172.22.0.213 -Pn Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-08 12:20 CET Nmap scan report for 172.22.0.213 Host is up (0.0011s latency). Not shown: 998 filtered ports PORT STATE SERVICE 22/tcp open ssh 2222/tcp open EtherNetIP-1 Nmap done: 1 IP address (1 host up) scanned in 8.15 seconds Mostramos lo que ha aparecido en /var/log/syslog : Feb 8 11:20:47 zeus kernel: [ 453.591450] PortScanIN=eth1 OUT= MAC=52:54:00:6d:6e:a7:06:68:af:97:62:7f:08:00 SRC=172.22.9.227 DST=172.22.0.213 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=63993 DF PROTO=TCP SPT=35550 DPT=19 WINDOW=64240 RES=0x00 SYN URGP=0 Esto funciona, e incluso logea la IP de origen del atacante, pero no es una soluci\u00f3n. Esto simplemente es un log, no estamos bloqueando el ataque nmap y el atacante seguir\u00e1 teniendo una respuesta de los puertos abiertos. Soluci\u00f3n 1: Bloquear Null scan Lanzo este ataque desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sN 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 08:48 CET Stats: 0:00:14 elapsed; 0 hosts completed (1 up), 1 undergoing NULL Scan NULL Scan Timing: About 66.60% done; ETC: 08:48 (0:00:08 remaining) Stats: 0:00:21 elapsed; 0 hosts completed (1 up), 1 undergoing NULL Scan NULL Scan Timing: About 99.99% done; ETC: 08:48 (0:00:00 remaining) Nmap scan report for 172.22.0.213 Host is up (0.00041s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.27 seconds Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear al atacante por IP: sudo iptables -A INPUT -p tcp --tcp-flags ALL NONE -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> Null scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL NONE -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Null scan\" -j DROP Compruebo /var/log/syslog : Soluci\u00f3n 2: Bloquear Xmas scan Lanzo este ataque desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sX 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 09:08 CET Nmap scan report for 172.22.0.213 Host is up (0.00026s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.25 seconds Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando, no me aparece ninguna informaci\u00f3n sobre los puertos abiertos. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear al atacante por IP: sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> XMAS scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> XMAS-PSH scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL ALL -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> XMAS-ALL scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Xmas/PSH scan\" -j DROP sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Xmas scan\" -j DROP sudo iptables -A INPUT -p tcp --tcp-flags ALL ALL -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Xmas/All scan\" -j DROP Compruebo /var/log/syslog : Soluci\u00f3n 3: Bloquear FIN scan Lanzo este ataque desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sF 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 09:32 CET Nmap scan report for 172.22.0.213 Host is up (0.00017s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.20 seconds Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando, no me aparece ninguna informaci\u00f3n sobre los puertos abiertos. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear al atacante por IP: sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> FIN scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist FIN scan\" -j DROP Compruebo /var/log/syslog : Soluci\u00f3n 4: Bloquear UDP scan Lanzo el scan desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sU 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 10:45 CET Nmap scan report for 172.22.0.213 Host is up (0.00016s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.19 seconds atlas@olympus:~$ Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando, no me aparece ninguna informaci\u00f3n sobre los puertos abiertos. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear el tr\u00e1fico espec\u00edfico anormal: sudo iptables -A INPUT -p udp -m limit --limit 6/h --limit-burst 1 -m length --length 0:28 -j LOG --log-prefix \"Firewall>0 length udp \" sudo iptables -A INPUT -p udp -m length --length 0:28 -m comment --comment \"Drop UDP packet with no content\" -j DROP En syslog no me aparece nada porque no tengo tr\u00e1fico udp permitido. Parte 28 Modificar el cortafuegos todo lo necesario para que los servicios antiguos sigan funcionando. Tr\u00e1fico DNS externa \u2192 Apolo sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 10.0.1.102 -o eth1 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde mi host: atlas@olympus:~$ dig NS adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> NS adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 1376 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 976da02d0426b93be97b71876204c09c9e25924aa113dc62 (good) ;; QUESTION SECTION: ;adrianj.gonzalonazareno.org. IN NS ;; ANSWER SECTION: adrianj.gonzalonazareno.org. 86229 IN NS zeus.adrianj.gonzalonazareno.org. ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Thu Feb 10 08:36:59 CET 2022 ;; MSG SIZE rcvd: 103 Tr\u00e1fico DNS Apolo \u2192 externa sudo iptables -A FORWARD -s 10.0.1.102 -o eth1 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Apolo: vagrant@apolo:~$ dig @127.0.0.1 www.google.es ; <<>> DiG 9.16.22-Debian <<>> @127.0.0.1 www.google.es ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 9760 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: fc8dc3dfcf8ed8c7010000006204c5d28d2cd0f4696bab50 (good) ;; QUESTION SECTION: ;www.google.es. IN A ;; ANSWER SECTION: www.google.es. 300 IN A 216.58.215.131 ;; Query time: 92 msec ;; SERVER: 127.0.0.1#53(127.0.0.1) ;; WHEN: Thu Feb 10 07:59:14 UTC 2022 ;; MSG SIZE rcvd: 86 Pruebo que funciona desde Ares: vagrant@ares:~$ dig fp.josedomingo.org ; <<>> DiG 9.16.1-Ubuntu <<>> fp.josedomingo.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45695 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 653a9b32ddd84ca8010000006204c6b054cab2e10d50bf35 (good) ;; QUESTION SECTION: ;fp.josedomingo.org. IN A ;; ANSWER SECTION: fp.josedomingo.org. 900 IN CNAME endor.josedomingo.org. endor.josedomingo.org. 900 IN A 37.187.119.60 ;; Query time: 2705 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Feb 10 08:03:32 UTC 2022 ;; MSG SIZE rcvd: 111 (funciona sin reglas adicionales porque Ares y Apolo est\u00e1n en la misma red) Para que Zeus pueda hacer consultas DNS usando Apolo, necesitamos reglas adicionales: sudo iptables -A OUTPUT -d 10.0.1.102 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -s 10.0.1.102 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Zeus: vagrant@zeus:~$ dig www.josedomingo.org ; <<>> DiG 9.16.22-Debian <<>> www.josedomingo.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37724 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 1e95cdcc67defb84010000006204c9120b793d41bff868be (good) ;; QUESTION SECTION: ;www.josedomingo.org. IN A ;; ANSWER SECTION: www.josedomingo.org. 889 IN CNAME endor.josedomingo.org. endor.josedomingo.org. 290 IN A 37.187.119.60 ;; Query time: 0 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Feb 10 08:13:06 UTC 2022 ;; MSG SIZE rcvd: 112 Para que desde la DMZ se puedan hacer consultas DNS usando Apolo, necesitamos reglas adicionales: sudo iptables -A FORWARD -i eth2 -d 10.0.1.102 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 10.0.1.102 -o eth2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Hera: [vagrant@hera ~]$ dig stackoverflow.com ; <<>> DiG 9.11.26-RedHat-9.11.26-6.el8 <<>> stackoverflow.com ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 64139 ;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: fcf5085ad3e0c20e010000006204cb4d63eb8fac5764ecd5 (good) ;; QUESTION SECTION: ;stackoverflow.com. IN A ;; ANSWER SECTION: stackoverflow.com. 300 IN A 151.101.1.69 stackoverflow.com. 300 IN A 151.101.193.69 stackoverflow.com. 300 IN A 151.101.129.69 stackoverflow.com. 300 IN A 151.101.65.69 ;; Query time: 1944 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Feb 10 08:22:36 UTC 2022 ;; MSG SIZE rcvd: 138 Tr\u00e1fico http externa \u2192 Hera La regla DNAT no hace falta a\u00f1adirla, porque ya la ten\u00edamos de antes: Las reglas forward no hacen falta a\u00f1adirlas porque ya las hemos hecho durante esta pr\u00e1ctica: Desde fuera, compruebo que puedo acceder a www.adrianj.gonzalonazareno.org : Tr\u00e1fico correo Apolo \u2192 externa sudo iptables -A FORWARD -s 10.0.1.102 -o eth1 -p tcp --dport 25 -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p tcp --sport 25 -j ACCEPT Env\u00edo un correo a mi gmail desde Apolo: vagrant@apolo:~$ mail -r vagrant@adrianj.gonzalonazareno.org adristudy@gmail.com Cc: Subject: hola hola Muestro que me ha llegado: Tr\u00e1fico correo externa \u2192 Apolo Vuelvo a a\u00f1adir la regla DNAT que previamente elimin\u00e9: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Habilito el tr\u00e1fico de vuelta: sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p tcp --dport 25 -j ACCEPT Env\u00edo desde gmail un correo a Apolo: Compruebo en Apolo que me haya llegado: Muestro el contenido para que se vea que es el correo correcto: Parte 29 El cortafuegos tiene que funcionar despu\u00e9s de un reinicio Necesitamos el paquete iptables-persistent , que no tenemos que instalar porque ya se hizo en pr\u00e1cticas sobre el escenario anteriores. Teniendo el paquete instalado, para guardar las reglas ejecuto este comando: iptables-save > /etc/iptables/rules.v4 Se guardar\u00e1n en ese fichero, y eso las har\u00e1 persistentes en reinicios.","title":"Pr\u00e1ctica iptables: perimetral escenario"},{"location":"perimetral-iptables-escenario/#practica-iptables-perimetral-sobre-escenario","text":"ATENCI\u00d3N: La IP p\u00fablica de Zeus en este escenario es posible que cambie durante las demostraciones ya que este es un escenario que funciona tanto en clase como en casa, y existen 2 direccionamientos distintos.","title":"Pr\u00e1ctica iptables: perimetral sobre escenario"},{"location":"perimetral-iptables-escenario/#parte-1","text":"Mostrar escenario del que se parte Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :zeus do |zeus| zeus.vm.box = \"debian/bullseye64\" zeus.vm.hostname = \"zeus\" zeus.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" zeus.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.1\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" zeus.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :hera do |hera| hera.vm.box = \"rockylinux/8\" hera.vm.hostname = \"hera\" hera.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.200\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :apolo do |apolo| apolo.vm.box = \"debian/bullseye64\" apolo.vm.hostname = \"apolo\" apolo.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.102\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :ares do |ares| ares.vm.box = \"generic/ubuntu2004\" ares.vm.hostname = \"ares\" ares.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.101\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end","title":"Parte 1"},{"location":"perimetral-iptables-escenario/#parte-2","text":"Mostrar el estado iptables del que se parte Tabla filter: vagrant@zeus:~$ sudo iptables -L -v -n # Warning: iptables-legacy tables present, use iptables-legacy to see them Chain INPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Tabla nat: vagrant@zeus:~$ sudo iptables -L -v -n -t nat # Warning: iptables-legacy tables present, use iptables-legacy to see them Chain PREROUTING (policy ACCEPT 437 packets, 87098 bytes) pkts bytes target prot opt in out source destination 0 0 DNAT udp -- eth1 * 0.0.0.0/0 0.0.0.0/0 udp dpt:53 to:10.0.1.102:53 0 0 DNAT tcp -- eth1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 to:172.16.0.200:80 0 0 DNAT tcp -- eth1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:25 to:10.0.1.102:25 Chain INPUT (policy ACCEPT 41 packets, 10816 bytes) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 12 packets, 873 bytes) pkts bytes target prot opt in out source destination Chain POSTROUTING (policy ACCEPT 4 packets, 257 bytes) pkts bytes target prot opt in out source destination 36 2986 MASQUERADE all -- * eth1 0.0.0.0/0 0.0.0.0/0 Mismas reglas NAT pero en comandos: sudo iptables -t nat -A PREROUTING -i eth1 -p udp --dport 53 -j DNAT --to-destination 10.0.1.102:53 sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.200:80 sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE","title":"Parte 2"},{"location":"perimetral-iptables-escenario/#parte-3","text":"Redigir puertos 2222-22 en Zeus desde el exterior DNAT para mi casa y para clase: sudo iptables -t nat -A PREROUTING -i eth1 -s 172.22.0.0/16 -p tcp --dport 2222 -j DNAT --to-destination 172.22.0.213:22 sudo iptables -t nat -A PREROUTING -i eth1 -s 192.168.1.0/24 -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.115:22","title":"Parte 3"},{"location":"perimetral-iptables-escenario/#parte-4","text":"Permitir tr\u00e1fico ssh entrante exterior \u2192 Zeus sudo iptables -A INPUT -i eth1 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -o eth1 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh zeus-casa Linux zeus 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 @@@@@@@@ @@@@@@@@ @@@ @@@ @@@@@@ @@! @@! @@! @@@ !@@ @!! @!!!:! @!@ !@! !@@!! !!: !!: !!: !!! !:! :.::.: : : :: ::: :.:: : ::.: : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sun Feb 6 16:53:51 2022 from 192.168.1.106 vagrant@zeus:~$ (no escribo el puerto 2222 al conectar porque ya est\u00e1 en mi config ssh. Ver la siguiente parte para m\u00e1s informaci\u00f3n) Que funcione esta conexi\u00f3n significa que tanto las reglas de este paso como del anterior funcionan.","title":"Parte 4"},{"location":"perimetral-iptables-escenario/#parte-5","text":"Permitir tr\u00e1fico ssh para hacer proxyjump desde zeus Seg\u00fan como estaba planteado nuestro escenario, se ten\u00eda que acceder a la DMZ y a la LAN a trav\u00e9s de zeus por ssh. Esto nos obliga a a\u00f1adir reglas INPUT/OUPUT desde zeus hacia estas redes, para que el salto SSH pueda funcionar. Muestro la parte correspondiente de mi .ssh/config , para que sepamos de d\u00f3nde partimos: ##################### # escenario libvirt # ##################### Host zeus-clase HostName 172.22.0.213 User vagrant Port 2222 Host zeus-casa HostName 192.168.1.115 User vagrant Port 2222 Host apolo-clase HostName 10.0.1.102 User vagrant ProxyJump zeus-clase Host apolo-casa HostName 10.0.1.102 User vagrant ProxyJump zeus-casa Host ares-clase HostName 10.0.1.101 User vagrant ProxyJump zeus-clase Host ares-casa HostName 10.0.1.101 User vagrant ProxyJump zeus-casa Host hera-clase HostName 172.16.0.200 User vagrant ProxyJump zeus-clase Host hera-casa HostName 172.16.0.200 User vagrant ProxyJump zeus-casa Tr\u00e1fico ssh saliente zeus \u2192 DMZ: sudo iptables -A OUTPUT -o eth2 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth2 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Tr\u00e1fico ssh saliente zeus \u2192 LAN: sudo iptables -A OUTPUT -o eth3 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -i eth3 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que puedo conectar a Hera desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh hera-casa @@@ @@@ @@@@@@@@ @@@@@@@ @@@@@@ @@! @@@ @@! @@! @@@ @@! @@@ @!@!@!@! @!!!:! @!@!!@! @!@!@!@! !!: !!! !!: !!: :!! !!: !!! : : : : :: ::: : : : : : : Last login: Sun Feb 6 16:08:56 2022 from 172.16.0.1 [vagrant@hera ~]$ Pruebo que puedo conectar a Apolo desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh apolo-casa Linux apolo 5.10.0-10-amd64 #1 SMP Debian 5.10.84-1 (2021-12-08) x86_64 @@@@@@ @@@@@@@ @@@@@@ @@@ @@@@@@ @@! @@@ @@! @@@ @@! @@@ @@! @@! @@@ @!@!@!@! @!@@!@! @!@ !@! @!! @!@ !@! !!: !!! !!: !!: !!! !!: !!: !!! : : : : : :. : : ::.: : : :. : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. You have mail. Last login: Sun Feb 6 16:07:35 2022 from 10.0.1.1 vagrant@apolo:~$ Pruebo que puedo conectar a Ares desde mi host: atlas@olympus:~/vagrant/escenario-libvirt$ ssh ares-casa @@@@@@ @@@@@@@ @@@@@@@@ @@@@@@ @@! @@@ @@! @@@ @@! !@@ @!@!@!@! @!@!!@! @!!!:! !@@!! !!: !!! !!: :!! !!: !:! : : : : : : : :: ::: ::.: : Last login: Thu Feb 3 12:06:44 2022 from 192.168.121.1 vagrant@ares:~$","title":"Parte 5"},{"location":"perimetral-iptables-escenario/#parte-6","text":"Pol\u00edticas por defecto sudo iptables -P INPUT DROP sudo iptables -P OUTPUT DROP sudo iptables -P FORWARD DROP Si no se nos cortan las conexiones ssh a las m\u00e1quinas despu\u00e9s de este paso, las reglas que aplicamos antes funcionan.","title":"Parte 6"},{"location":"perimetral-iptables-escenario/#parte-7","text":"Permitir tr\u00e1fico ssh Apolo-Hera \u2192 Zeus sudo iptables -A INPUT -s 10.0.1.102,172.16.0.200 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A OUTPUT -d 10.0.1.102,172.16.0.200 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Apolo: vagrant@apolo:~$ ssh vagrant@10.0.1.1 Linux zeus 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 @@@@@@@@ @@@@@@@@ @@@ @@@ @@@@@@ @@! @@! @@! @@@ !@@ @!! @!!!:! @!@ !@! !@@!! !!: !!: !!: !!! !:! :.::.: : : :: ::: :.:: : ::.: : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sun Feb 6 17:38:17 2022 from 10.0.1.102 vagrant@zeus:~$ Pruebo que funciona desde Hera: [vagrant@hera ~]$ ssh vagrant@172.16.0.1 Linux zeus 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64 @@@@@@@@ @@@@@@@@ @@@ @@@ @@@@@@ @@! @@! @@! @@@ !@@ @!! @!!!:! @!@ !@! !@@!! !!: !!: !!: !!! !:! :.::.: : : :: ::: :.:: : ::.: : The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sun Feb 6 17:38:19 2022 from 10.0.1.102 vagrant@zeus:~$","title":"Parte 7"},{"location":"perimetral-iptables-escenario/#parte-8","text":"Permitir tr\u00e1fico loopback en Zeus sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT sudo iptables -A INPUT -i lo -p icmp -j ACCEPT Ya funciona el ping a localhost: vagrant@zeus:~$ ping 127.0.0.1 PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data. 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.064 ms 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.095 ms ^C --- 127.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1020ms rtt min/avg/max/mdev = 0.064/0.079/0.095/0.015 ms","title":"Parte 8"},{"location":"perimetral-iptables-escenario/#parte-9","text":"Permitir ping entrante DMZ \u2192 Zeus sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A OUTPUT -o eth2 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona desde Hera: [vagrant@hera ~]$ ping 172.16.0.1 PING 172.16.0.1 (172.16.0.1) 56(84) bytes of data. 64 bytes from 172.16.0.1: icmp_seq=1 ttl=64 time=0.267 ms 64 bytes from 172.16.0.1: icmp_seq=2 ttl=64 time=0.492 ms ^C --- 172.16.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1020ms rtt min/avg/max/mdev = 0.267/0.379/0.492/0.114 ms","title":"Parte 9"},{"location":"perimetral-iptables-escenario/#parte-10","text":"Rechazar ping entrante LAN \u2192 Zeus sudo iptables -A INPUT -i eth3 -p icmp -m icmp --icmp-type echo-request -j REJECT Pruebo que bloquea el ping desde Ares: vagrant@ares:~$ ping 10.0.1.1 PING 10.0.1.1 (10.0.1.1) 56(84) bytes of data. ^C --- 10.0.1.1 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 2037ms","title":"Parte 10"},{"location":"perimetral-iptables-escenario/#parte-11","text":"Bloquear ping entrante exterior \u2192 Zeus La pol\u00edtica por defecto de INPUT la tenemos a DROP, y tampoco tenemos reglas en este momento que acepten el ping entrante desde el exterior (eth1) : Chain INPUT (policy DROP 37915 packets, 1859K bytes) pkts bytes target prot opt in out source destination 19351 1298K ACCEPT tcp -- eth1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:22 state NEW,ESTABLISHED 221 47538 ACCEPT tcp -- eth2 * 0.0.0.0/0 0.0.0.0/0 tcp spt:22 state ESTABLISHED 83 14061 ACCEPT tcp -- eth3 * 0.0.0.0/0 0.0.0.0/0 tcp spt:22 state ESTABLISHED 115 14256 ACCEPT tcp -- * * 10.0.1.102 0.0.0.0/0 tcp dpt:22 state NEW,ESTABLISHED 66 9222 ACCEPT tcp -- * * 172.16.0.200 0.0.0.0/0 tcp dpt:22 state NEW,ESTABLISHED 8 672 ACCEPT icmp -- lo * 0.0.0.0/0 0.0.0.0/0 6 504 ACCEPT icmp -- eth2 * 0.0.0.0/0 0.0.0.0/0 icmptype 8 11 924 REJECT icmp -- eth3 * 0.0.0.0/0 0.0.0.0/0 icmptype 8 reject-with icmp-port-unreachable Esto significa que no necesitamos a\u00f1adir ninguna regla adicional para que se deniegue el ping entrante a Zeus desde el exterior.","title":"Parte 11"},{"location":"perimetral-iptables-escenario/#parte-12","text":"Permitir ping saliente Zeus \u2192 LAN-DMZ sudo iptables -A OUTPUT -d 10.0.1.0/24,172.16.0.0/16 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -s 10.0.1.0/24,172.16.0.0/16 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona el ping a Hera: vagrant@zeus:~$ ping 172.16.0.200 PING 172.16.0.200 (172.16.0.200) 56(84) bytes of data. 64 bytes from 172.16.0.200: icmp_seq=1 ttl=64 time=0.675 ms 64 bytes from 172.16.0.200: icmp_seq=2 ttl=64 time=0.584 ms ^C --- 172.16.0.200 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1030ms rtt min/avg/max/mdev = 0.584/0.629/0.675/0.045 ms Pruebo que funciona el ping a Ares: vagrant@zeus:~$ ping 10.0.1.101 PING 10.0.1.101 (10.0.1.101) 56(84) bytes of data. 64 bytes from 10.0.1.101: icmp_seq=1 ttl=64 time=0.532 ms 64 bytes from 10.0.1.101: icmp_seq=2 ttl=64 time=0.359 ms ^C --- 10.0.1.101 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1020ms rtt min/avg/max/mdev = 0.359/0.445/0.532/0.086 ms","title":"Parte 12"},{"location":"perimetral-iptables-escenario/#parte-13","text":"Permitir ping saliente Zeus \u2192 exterior sudo iptables -A OUTPUT -o eth1 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A INPUT -i eth1 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona: vagrant@zeus:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=55 time=19.1 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=55 time=19.8 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 19.103/19.468/19.834/0.365 ms","title":"Parte 13"},{"location":"perimetral-iptables-escenario/#parte-14","text":"Permitir ping Hera \u2192 LAN sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Pruebo que funciona haciendo ping a Ares: [vagrant@hera ~]$ ping 10.0.1.101 PING 10.0.1.101 (10.0.1.101) 56(84) bytes of data. 64 bytes from 10.0.1.101: icmp_seq=1 ttl=63 time=1.94 ms 64 bytes from 10.0.1.101: icmp_seq=2 ttl=63 time=0.898 ms ^C --- 10.0.1.101 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.898/1.417/1.937/0.520 ms","title":"Parte 14"},{"location":"perimetral-iptables-escenario/#parte-15","text":"Permitir tr\u00e1fico ssh Hera \u2192 LAN sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona haciendo ssh a Ares: [vagrant@hera ~]$ ssh vagrant@10.0.1.101 @@@@@@ @@@@@@@ @@@@@@@@ @@@@@@ @@! @@@ @@! @@@ @@! !@@ @!@!@!@! @!@!!@! @!!!:! !@@!! !!: !!! !!: :!! !!: !:! : : : : : : : :: ::: ::.: : Last login: Mon Feb 7 00:09:02 2022 from 172.16.0.200 vagrant@ares:~$","title":"Parte 15"},{"location":"perimetral-iptables-escenario/#parte-16","text":"Permitir tr\u00e1fico ssh LAN \u2192 Hera sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Ares: vagrant@ares:~$ ssh vagrant@172.16.0.200 @@@ @@@ @@@@@@@@ @@@@@@@ @@@@@@ @@! @@@ @@! @@! @@@ @@! @@@ @!@!@!@! @!!!:! @!@!!@! @!@!@!@! !!: !!! !!: !!: :!! !!: !!! : : : : :: ::: : : : : : : Last login: Sun Feb 6 16:56:24 2022 from 172.16.0.1 [vagrant@hera ~]$","title":"Parte 16"},{"location":"perimetral-iptables-escenario/#parte-17","text":"Permitir ping LAN-DMZ \u2192 exterior sudo iptables -A FORWARD -s 10.0.1.0/24,172.16.0.0/16 -o eth1 -p icmp -m icmp --icmp-type echo-request -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 10.0.1.0/24,172.16.0.0/16 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT Tenemos, porque lo hicimos en una anterior pr\u00e1ctica sobre el escenario, una regla de SNAT que entra en juego en este apartado, as\u00ed que no la tenemos que volver a a\u00f1adir. Es la siguiente: sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE Pruebo que funciona desde Hera: [vagrant@hera ~]$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=19.4 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=14.7 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 14.739/17.069/19.400/2.334 ms Pruebo que funciona desde Ares: vagrant@ares:~$ ping 1.1.1.1 PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data. 64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=14.4 ms 64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=14.1 ms ^C --- 1.1.1.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 14.081/14.255/14.430/0.174 ms","title":"Parte 17"},{"location":"perimetral-iptables-escenario/#parte-18","text":"LAN puede navegar sudo iptables -A FORWARD -i eth3 -o eth1 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -o eth3 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http desde Ares: vagrant@ares:~$ telnet 52.47.209.216 80 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Pruebo que funciona el tr\u00e1fico https desde Apolo: vagrant@apolo:~$ telnet 52.47.209.216 443 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'.","title":"Parte 18"},{"location":"perimetral-iptables-escenario/#parte-19","text":"Hera puede navegar sudo iptables -A FORWARD -s 172.16.0.200 -o eth1 -p tcp -m multiport --dport 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 172.16.0.200 -p tcp -m multiport --sport 80,443 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http: [vagrant@hera ~]$ telnet 52.47.209.216 80 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'. Pruebo que funciona el tr\u00e1fico https: [vagrant@hera ~]$ telnet 52.47.209.216 443 Trying 52.47.209.216... Connected to 52.47.209.216. Escape character is '^]'.","title":"Parte 19"},{"location":"perimetral-iptables-escenario/#parte-20","text":"Tenemos que instalar en Hera un servidor de correos y un servidor ftp.","title":"Parte 20"},{"location":"perimetral-iptables-escenario/#servidor-de-correo","text":"Instalo: sudo dnf install postfix Modifico /etc/postfix/main.cf para que acepte peticiones desde cualquier IP y no s\u00f3lo desde localhost (es como est\u00e1 por defecto) : inet_interfaces = all Inicio postfix: sudo systemctl start postfix Compruebo que est\u00e1 escuchando el puerto correctamente: [vagrant@hera ~]$ sudo ss -tulpn | grep LISTEN tcp LISTEN 0 128 0.0.0.0:111 0.0.0.0:* users:((\"rpcbind\",pid=603,fd=4),(\"systemd\",pid=1,fd=88)) tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:* users:((\"sshd\",pid=670,fd=4)) tcp LISTEN 0 100 0.0.0.0:25 0.0.0.0:* users:((\"master\",pid=32765,fd=16)) tcp LISTEN 0 128 [::]:111 [::]:* users:((\"rpcbind\",pid=603,fd=6),(\"systemd\",pid=1,fd=90)) tcp LISTEN 0 128 *:80 *:* users:((\"httpd\",pid=720,fd=4),(\"httpd\",pid=719,fd=4),(\"httpd\",pid=718,fd=4),(\"httpd\",pid=701,fd=4)) tcp LISTEN 0 128 [::]:22 [::]:* users:((\"sshd\",pid=670,fd=6)) tcp LISTEN 0 100 [::]:25 [::]:* users:((\"master\",pid=32765,fd=17))","title":"Servidor de correo"},{"location":"perimetral-iptables-escenario/#servidor-ftp","text":"sudo dnf install vsftpd sudo systemctl start vsftpd Compruebo que est\u00e1 escuchando el puerto correctamente: [vagrant@hera ~]$ sudo ss -tulpn | grep LISTEN tcp LISTEN 0 128 0.0.0.0:111 0.0.0.0:* users:((\"rpcbind\",pid=603,fd=4),(\"systemd\",pid=1,fd=88)) tcp LISTEN 0 128 0.0.0.0:22 0.0.0.0:* users:((\"sshd\",pid=670,fd=4)) tcp LISTEN 0 100 0.0.0.0:25 0.0.0.0:* users:((\"master\",pid=32765,fd=16)) tcp LISTEN 0 128 [::]:111 [::]:* users:((\"rpcbind\",pid=603,fd=6),(\"systemd\",pid=1,fd=90)) tcp LISTEN 0 128 *:80 *:* users:((\"httpd\",pid=720,fd=4),(\"httpd\",pid=719,fd=4),(\"httpd\",pid=718,fd=4),(\"httpd\",pid=701,fd=4)) tcp LISTEN 0 32 *:21 *:* users:((\"vsftpd\",pid=32862,fd=3)) tcp LISTEN 0 128 [::]:22 [::]:* users:((\"sshd\",pid=670,fd=6)) tcp LISTEN 0 100 [::]:25 [::]:* users:((\"master\",pid=32765,fd=17))","title":"Servidor FTP"},{"location":"perimetral-iptables-escenario/#parte-21","text":"Permitir tr\u00e1fico exterior \u2192 Hera para Web-FTP La regla DNAT web ya la ten\u00eda previamente, as\u00ed que no hace falta a\u00f1adirla. La recuerdo: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.200:80 A\u00f1ado la regla DNAT FTP: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 21 -j DNAT --to-destination 172.16.0.200:21 Reglas forward web: sudo iptables -A FORWARD -i eth1 -d 172.16.0.200 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth1 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http a Hera desde mi host: atlas@olympus:~$ telnet 172.22.0.213 80 Trying 172.22.0.213... Connected to 172.22.0.213. Escape character is '^]'. Reglas forward ftp: sudo iptables -A FORWARD -i eth1 -d 172.16.0.200 -p tcp --dport 21 -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth1 -p tcp --sport 21 -j ACCEPT Pruebo que funciona el tr\u00e1fico ftp a Hera desde mi host: atlas@olympus:~$ telnet 172.22.0.213 21 Trying 172.22.0.213... Connected to 172.22.0.213. Escape character is '^]'. 220 (vsFTPd 3.0.3)","title":"Parte 21"},{"location":"perimetral-iptables-escenario/#parte-22","text":"Permitir tr\u00e1fico LAN \u2192 Hera para Web-FTP Reglas forward web: sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona el tr\u00e1fico http a Hera desde Ares: vagrant@ares:~$ telnet 172.16.0.200 80 Trying 172.16.0.200... Connected to 172.16.0.200. Escape character is '^]'. Reglas forward ftp: sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 21 -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 21 -j ACCEPT Pruebo que funciona el tr\u00e1fico ftp a Hera desde Apolo: vagrant@apolo:~$ telnet 172.16.0.200 21 Trying 172.16.0.200... Connected to 172.16.0.200. Escape character is '^]'. 220 (vsFTPd 3.0.3)","title":"Parte 22"},{"location":"perimetral-iptables-escenario/#parte-23","text":"Permitir tr\u00e1fico LAN \u2192 Hera al servidor correo, pero no se podr\u00e1 acceder desde otro sitio sudo iptables -A FORWARD -i eth3 -d 172.16.0.200 -p tcp --dport 25 -j ACCEPT sudo iptables -A FORWARD -s 172.16.0.200 -o eth3 -p tcp --sport 25 -j ACCEPT Pruebo que funciona desde Ares: vagrant@ares:~$ telnet 172.16.0.200 25 Trying 172.16.0.200... Connected to 172.16.0.200. Escape character is '^]'. 220 hera.localdomain ESMTP Postfix Realmente no tendr\u00eda por qu\u00e9 hacerlo porque no influye, pero para que quede todo m\u00e1s limpio, eliminar\u00e9 la regla DNAT 25 que ten\u00edamos previamente por el escenario: Desde el exterior igualmente no podr\u00edamos tener acceso al servidor de correos antiguo de Apolo porque aunque tengamos esa regla DNAT, no hemos hecho en ning\u00fan momento reglas forward hacia Apolo. La elimino: sudo iptables -t nat -D PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25","title":"Parte 23"},{"location":"perimetral-iptables-escenario/#parte-24","text":"Permitir tr\u00e1fico DMZ \u2192 Ares al servidor mysql. No se podr\u00e1 acceder desde el exterior sudo iptables -A FORWARD -i eth2 -d 10.0.1.101 -p tcp --dport 3306 -j ACCEPT sudo iptables -A FORWARD -s 10.0.1.101 -o eth2 -p tcp --sport 3306 -j ACCEPT Pruebo que funciona desde Hera: [vagrant@hera ~]$ sudo mysql -u root -h 10.0.1.101 -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 45 Server version: 10.3.31-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. MariaDB [(none)]> Desde el exterior no podremos acceder claramente, porque no existe una regla DNAT v\u00e1lida:","title":"Parte 24"},{"location":"perimetral-iptables-escenario/#parte-25","text":"Bloquear ICMP Flood limitando el n\u00famero de peticiones por segundo Desde el exterior y la LAN hemos bloqueado el tr\u00e1fico ICMP as\u00ed que no tenemos que preocuparnos por ataques de flood. Desde la DMZ s\u00ed tenemos permitido el tr\u00e1fico, as\u00ed que lo tenemos que limitar . Primero voy a realizar un ataque desde Hera a Zeus sin l\u00edmite de protecci\u00f3n y mostrar\u00e9 lo que suceder\u00eda. Este es el comando de ataque que ejecutar\u00e9 en Hera: sudo ping -f -s 56500 172.16.0.1 Hago el ataque, y as\u00ed se quedar\u00edan los contadores despu\u00e9s de varios segundos: Borro la regla, y la vuelvo a a\u00f1adir con un l\u00edmite de protecci\u00f3n: sudo iptables -A INPUT -i eth2 -p icmp -m icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 1 -j ACCEPT Vuelvo a lanzar el ataque, y veo c\u00f3mo se quedan los contadores despu\u00e9s de varios segundos: 4 paquetes, habiendo limitado el tr\u00e1fico a 1 por segundo significa que he lanzado el ataque por 4 segundos, pero s\u00f3lo 1 paquete se permiti\u00f3 gracias al l\u00edmite. Funciona correctamente.","title":"Parte 25"},{"location":"perimetral-iptables-escenario/#parte-26","text":"Bloquear SYN Flood Necesitamos esta regla para limitar: sudo iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT PERO en mi caso no la necesito, porque he comprobado que la pol\u00edtica por defecto DROP en INPUT bloquea el ataque de flood. Este es el comando de ataque que necesitamos, usando como ejemplo el puerto 80 (partiendo de que sabemos que est\u00e1 abierto y redirigido a Hera) : sudo hping3 -p 80 --flood --rand-source 192.168.1.115 Borro los contadores para esta prueba, y lanzo el ataque durante varios segundos. Vemos que la pol\u00edtica DROP ha cortado el ataque: Sabemos que esos paquetes son del ataque porque el contador estaba a 0 previamente, y me fij\u00e9 que no aumentase al no hacer nada por varios segundos. Tambi\u00e9n hay que tener en cuenta que esa cantidad de paquetes en varios segundos no es algo normal, teniendo en cuenta que durante la prueba el \u00fanico tr\u00e1fico que estaba llegando a Zeus era el ataque.","title":"Parte 26"},{"location":"perimetral-iptables-escenario/#parte-27","text":"Bloquear escaneos de puertos a Zeus.","title":"Parte 27"},{"location":"perimetral-iptables-escenario/#logica-base","text":"Seg\u00fan he investigado existen ciertas reglas que dicen bloquear los escaneos de puertos, pero al probarlas no funcionan. Despu\u00e9s de indagar he llegado a este post que dice algo bastante interesante: \"Lo l\u00f3gico es usar una pol\u00edtica DROP y s\u00f3lo permitir el tr\u00e1fico que queramos. No hay manera alguna de bloquear escaneos de puertos sin que se llegue a bloquear tr\u00e1fico leg\u00edtimo.\" Esto adem\u00e1s de interesante tiene mucho sentido, porque si bloque\u00e1ramos tr\u00e1fico a todos los puertos a su vez perder\u00edamos todo tipo de conexi\u00f3n que fuese leg\u00edtima. Evidentemente esto no es lo que queremos. Al final, esto se traduce a que cuando se use nmap se mostrar\u00e1n los puertos abiertos, pero ninguno m\u00e1s. Queda como tarea del administrador el que el tr\u00e1fico a esos puertos est\u00e9 correctamente protegido y dirigido.","title":"L\u00f3gica base"},{"location":"perimetral-iptables-escenario/#prueba-1","text":"Partiendo de la l\u00f3gica base que es casi cierta en su totalidad, realmente hay algunas medidas que podemos tomar. Intentaremos logear accesos a un puerto que sabemos que est\u00e1 cerrado. Si intentan acceder a \u00e9l, se puede entender que es un atacante porque alguien que quiera acceder leg\u00edtimamente sabr\u00eda qu\u00e9 puertos est\u00e1n abiertos. Regla: sudo iptables -A INPUT -p tcp -m tcp --dport 19 -j LOG --log-level 1 --log-prefix \"PortScan\" Lanzamos nmap desde nuestro host a Zeus: atlas@olympus:~$ nmap 172.22.0.213 -Pn Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-08 12:20 CET Nmap scan report for 172.22.0.213 Host is up (0.0011s latency). Not shown: 998 filtered ports PORT STATE SERVICE 22/tcp open ssh 2222/tcp open EtherNetIP-1 Nmap done: 1 IP address (1 host up) scanned in 8.15 seconds Mostramos lo que ha aparecido en /var/log/syslog : Feb 8 11:20:47 zeus kernel: [ 453.591450] PortScanIN=eth1 OUT= MAC=52:54:00:6d:6e:a7:06:68:af:97:62:7f:08:00 SRC=172.22.9.227 DST=172.22.0.213 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=63993 DF PROTO=TCP SPT=35550 DPT=19 WINDOW=64240 RES=0x00 SYN URGP=0 Esto funciona, e incluso logea la IP de origen del atacante, pero no es una soluci\u00f3n. Esto simplemente es un log, no estamos bloqueando el ataque nmap y el atacante seguir\u00e1 teniendo una respuesta de los puertos abiertos.","title":"Prueba 1"},{"location":"perimetral-iptables-escenario/#solucion-1-bloquear-null-scan","text":"Lanzo este ataque desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sN 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 08:48 CET Stats: 0:00:14 elapsed; 0 hosts completed (1 up), 1 undergoing NULL Scan NULL Scan Timing: About 66.60% done; ETC: 08:48 (0:00:08 remaining) Stats: 0:00:21 elapsed; 0 hosts completed (1 up), 1 undergoing NULL Scan NULL Scan Timing: About 99.99% done; ETC: 08:48 (0:00:00 remaining) Nmap scan report for 172.22.0.213 Host is up (0.00041s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.27 seconds Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear al atacante por IP: sudo iptables -A INPUT -p tcp --tcp-flags ALL NONE -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> Null scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL NONE -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Null scan\" -j DROP Compruebo /var/log/syslog :","title":"Soluci\u00f3n 1: Bloquear Null scan"},{"location":"perimetral-iptables-escenario/#solucion-2-bloquear-xmas-scan","text":"Lanzo este ataque desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sX 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 09:08 CET Nmap scan report for 172.22.0.213 Host is up (0.00026s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.25 seconds Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando, no me aparece ninguna informaci\u00f3n sobre los puertos abiertos. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear al atacante por IP: sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> XMAS scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> XMAS-PSH scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL ALL -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> XMAS-ALL scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Xmas/PSH scan\" -j DROP sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Xmas scan\" -j DROP sudo iptables -A INPUT -p tcp --tcp-flags ALL ALL -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist Xmas/All scan\" -j DROP Compruebo /var/log/syslog :","title":"Soluci\u00f3n 2: Bloquear Xmas scan"},{"location":"perimetral-iptables-escenario/#solucion-3-bloquear-fin-scan","text":"Lanzo este ataque desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sF 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 09:32 CET Nmap scan report for 172.22.0.213 Host is up (0.00017s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.20 seconds Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando, no me aparece ninguna informaci\u00f3n sobre los puertos abiertos. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear al atacante por IP: sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix \"Firewall> FIN scan \" sudo iptables -A INPUT -p tcp --tcp-flags ALL FIN -m recent --name blacklist_60 --set -m comment --comment \"Drop/Blacklist FIN scan\" -j DROP Compruebo /var/log/syslog :","title":"Soluci\u00f3n 3: Bloquear FIN scan"},{"location":"perimetral-iptables-escenario/#solucion-4-bloquear-udp-scan","text":"Lanzo el scan desde mi host a Zeus: atlas@olympus:~$ sudo nmap -sU 172.22.0.213 Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-09 10:45 CET Nmap scan report for 172.22.0.213 Host is up (0.00016s latency). All 1000 scanned ports on 172.22.0.213 are open|filtered MAC Address: 52:54:00:6D:6E:A7 (QEMU virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 21.19 seconds atlas@olympus:~$ Gracias a las pol\u00edticas por defecto DROP de la tabla filter, este tipo de escaneo est\u00e1 fallando, no me aparece ninguna informaci\u00f3n sobre los puertos abiertos. Lo \u00faltimo que queda ser\u00eda logear el ataque y bloquear el tr\u00e1fico espec\u00edfico anormal: sudo iptables -A INPUT -p udp -m limit --limit 6/h --limit-burst 1 -m length --length 0:28 -j LOG --log-prefix \"Firewall>0 length udp \" sudo iptables -A INPUT -p udp -m length --length 0:28 -m comment --comment \"Drop UDP packet with no content\" -j DROP En syslog no me aparece nada porque no tengo tr\u00e1fico udp permitido.","title":"Soluci\u00f3n 4: Bloquear UDP scan"},{"location":"perimetral-iptables-escenario/#parte-28","text":"Modificar el cortafuegos todo lo necesario para que los servicios antiguos sigan funcionando.","title":"Parte 28"},{"location":"perimetral-iptables-escenario/#trafico-dns-externa-apolo","text":"sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 10.0.1.102 -o eth1 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde mi host: atlas@olympus:~$ dig NS adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> NS adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 1376 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 976da02d0426b93be97b71876204c09c9e25924aa113dc62 (good) ;; QUESTION SECTION: ;adrianj.gonzalonazareno.org. IN NS ;; ANSWER SECTION: adrianj.gonzalonazareno.org. 86229 IN NS zeus.adrianj.gonzalonazareno.org. ;; Query time: 0 msec ;; SERVER: 192.168.202.2#53(192.168.202.2) ;; WHEN: Thu Feb 10 08:36:59 CET 2022 ;; MSG SIZE rcvd: 103","title":"Tr\u00e1fico DNS externa \u2192 Apolo"},{"location":"perimetral-iptables-escenario/#trafico-dns-apolo-externa","text":"sudo iptables -A FORWARD -s 10.0.1.102 -o eth1 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Apolo: vagrant@apolo:~$ dig @127.0.0.1 www.google.es ; <<>> DiG 9.16.22-Debian <<>> @127.0.0.1 www.google.es ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 9760 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: fc8dc3dfcf8ed8c7010000006204c5d28d2cd0f4696bab50 (good) ;; QUESTION SECTION: ;www.google.es. IN A ;; ANSWER SECTION: www.google.es. 300 IN A 216.58.215.131 ;; Query time: 92 msec ;; SERVER: 127.0.0.1#53(127.0.0.1) ;; WHEN: Thu Feb 10 07:59:14 UTC 2022 ;; MSG SIZE rcvd: 86 Pruebo que funciona desde Ares: vagrant@ares:~$ dig fp.josedomingo.org ; <<>> DiG 9.16.1-Ubuntu <<>> fp.josedomingo.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45695 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 653a9b32ddd84ca8010000006204c6b054cab2e10d50bf35 (good) ;; QUESTION SECTION: ;fp.josedomingo.org. IN A ;; ANSWER SECTION: fp.josedomingo.org. 900 IN CNAME endor.josedomingo.org. endor.josedomingo.org. 900 IN A 37.187.119.60 ;; Query time: 2705 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Feb 10 08:03:32 UTC 2022 ;; MSG SIZE rcvd: 111 (funciona sin reglas adicionales porque Ares y Apolo est\u00e1n en la misma red) Para que Zeus pueda hacer consultas DNS usando Apolo, necesitamos reglas adicionales: sudo iptables -A OUTPUT -d 10.0.1.102 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -s 10.0.1.102 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Zeus: vagrant@zeus:~$ dig www.josedomingo.org ; <<>> DiG 9.16.22-Debian <<>> www.josedomingo.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37724 ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 1e95cdcc67defb84010000006204c9120b793d41bff868be (good) ;; QUESTION SECTION: ;www.josedomingo.org. IN A ;; ANSWER SECTION: www.josedomingo.org. 889 IN CNAME endor.josedomingo.org. endor.josedomingo.org. 290 IN A 37.187.119.60 ;; Query time: 0 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Feb 10 08:13:06 UTC 2022 ;; MSG SIZE rcvd: 112 Para que desde la DMZ se puedan hacer consultas DNS usando Apolo, necesitamos reglas adicionales: sudo iptables -A FORWARD -i eth2 -d 10.0.1.102 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT sudo iptables -A FORWARD -s 10.0.1.102 -o eth2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT Pruebo que funciona desde Hera: [vagrant@hera ~]$ dig stackoverflow.com ; <<>> DiG 9.11.26-RedHat-9.11.26-6.el8 <<>> stackoverflow.com ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 64139 ;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: fcf5085ad3e0c20e010000006204cb4d63eb8fac5764ecd5 (good) ;; QUESTION SECTION: ;stackoverflow.com. IN A ;; ANSWER SECTION: stackoverflow.com. 300 IN A 151.101.1.69 stackoverflow.com. 300 IN A 151.101.193.69 stackoverflow.com. 300 IN A 151.101.129.69 stackoverflow.com. 300 IN A 151.101.65.69 ;; Query time: 1944 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Feb 10 08:22:36 UTC 2022 ;; MSG SIZE rcvd: 138","title":"Tr\u00e1fico DNS Apolo \u2192 externa"},{"location":"perimetral-iptables-escenario/#trafico-http-externa-hera","text":"La regla DNAT no hace falta a\u00f1adirla, porque ya la ten\u00edamos de antes: Las reglas forward no hacen falta a\u00f1adirlas porque ya las hemos hecho durante esta pr\u00e1ctica: Desde fuera, compruebo que puedo acceder a www.adrianj.gonzalonazareno.org :","title":"Tr\u00e1fico http externa \u2192 Hera"},{"location":"perimetral-iptables-escenario/#trafico-correo-apolo-externa","text":"sudo iptables -A FORWARD -s 10.0.1.102 -o eth1 -p tcp --dport 25 -j ACCEPT sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p tcp --sport 25 -j ACCEPT Env\u00edo un correo a mi gmail desde Apolo: vagrant@apolo:~$ mail -r vagrant@adrianj.gonzalonazareno.org adristudy@gmail.com Cc: Subject: hola hola Muestro que me ha llegado:","title":"Tr\u00e1fico correo Apolo \u2192 externa"},{"location":"perimetral-iptables-escenario/#trafico-correo-externa-apolo","text":"Vuelvo a a\u00f1adir la regla DNAT que previamente elimin\u00e9: sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 25 -j DNAT --to-destination 10.0.1.102:25 Habilito el tr\u00e1fico de vuelta: sudo iptables -A FORWARD -i eth1 -d 10.0.1.102 -p tcp --dport 25 -j ACCEPT Env\u00edo desde gmail un correo a Apolo: Compruebo en Apolo que me haya llegado: Muestro el contenido para que se vea que es el correo correcto:","title":"Tr\u00e1fico correo externa \u2192 Apolo"},{"location":"perimetral-iptables-escenario/#parte-29","text":"El cortafuegos tiene que funcionar despu\u00e9s de un reinicio Necesitamos el paquete iptables-persistent , que no tenemos que instalar porque ya se hizo en pr\u00e1cticas sobre el escenario anteriores. Teniendo el paquete instalado, para guardar las reglas ejecuto este comando: iptables-save > /etc/iptables/rules.v4 Se guardar\u00e1n en ese fichero, y eso las har\u00e1 persistentes en reinicios.","title":"Parte 29"},{"location":"practica-aumento-rendimiento-web/","text":"Pr\u00e1ctica: Aumento de rendimiento en servidores web HAProxy: Balanceador de carga Parte 1 Crear y configurar el escenario usando el repositorio vagrant_ansible_haproxy Clono el repo: git clone https://github.com/josedom24/vagrant_ansible_haproxy.git Creo las m\u00e1quinas: vagrant up Entro en cada una de ellas y apunto sus IPs: frontend: 192.168.121.61 backend1: 192.168.121.196 backend2: 192.168.121.20 Modifico ansible/hosts con estas IPs: [servidor_ha] frontend ansible_ssh_host=192.168.121.61 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/frontend/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 [servidores_web] backend1 ansible_ssh_host=192.168.121.196 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend1/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 backend2 ansible_ssh_host=192.168.121.20 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend2/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook para configurar el escenario: ansible-playbook site.yaml Podemos llegar a encontrarnos con este fallo, y lo documento para que se sepa: Para arreglarlo tendr\u00edamos que entrar en cada m\u00e1quina y cambiar los repositorios en /etc/apt/sources.list a https: Una vez hecho esto, vuelvo a ejecutar el playbook y ya funcionar\u00eda: atlas@olympus:~/vagrant/vagrant_ansible_haproxy/ansible$ ansible-playbook site.yaml PLAY [all] ************************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ ok: [frontend] ok: [backend1] ok: [backend2] TASK [commons : Ensure system is updated] ***************************************************************************************************************** ok: [backend2] ok: [backend1] ok: [frontend] PLAY [servidor_ha] **************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************ ok: [frontend] TASK [haproxy : install haproxy] ************************************************************************************************************************** changed: [frontend] PLAY [servidores_web] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************ ok: [backend2] ok: [backend1] TASK [nginx : install nginx, php-fpm] ********************************************************************************************************************* changed: [backend1] changed: [backend2] TASK [nginx : Copy info.php] ****************************************************************************************************************************** changed: [backend1] changed: [backend2] TASK [nginx : Copy virtualhost default] ******************************************************************************************************************* changed: [backend1] changed: [backend2] RUNNING HANDLER [nginx : restart nginx] ******************************************************************************************************************* changed: [backend2] changed: [backend1] PLAY [servidores_web] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************ ok: [backend1] ok: [backend2] TASK [mariadb : ensure mariadb is installed] ************************************************************************************************************** changed: [backend1] changed: [backend2] TASK [mariadb : ensure mariadb binds to internal interface] *********************************************************************************************** changed: [backend2] changed: [backend1] RUNNING HANDLER [mariadb : restart mariadb] *************************************************************************************************************** changed: [backend2] changed: [backend1] PLAY [servidores_web] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************ ok: [backend1] ok: [backend2] TASK [wordpress : install unzip] ************************************************************************************************************************** changed: [backend2] changed: [backend1] TASK [wordpress : download wordpress] ********************************************************************************************************************* changed: [backend2] changed: [backend1] TASK [wordpress : unzip wordpress] ************************************************************************************************************************ changed: [backend2] changed: [backend1] TASK [wordpress : Copy wordpress.sql] ********************************************************************************************************************* changed: [backend1] changed: [backend2] TASK [wordpress : create database wordpress] ************************************************************************************************************** changed: [backend2] changed: [backend1] TASK [wordpress : create user mysql wordpress] ************************************************************************************************************ changed: [backend1] => (item=localhost) changed: [backend2] => (item=localhost) TASK [wordpress : copy wp-config.php] ********************************************************************************************************************* changed: [backend1] changed: [backend2] RUNNING HANDLER [wordpress : restart nginx] *************************************************************************************************************** changed: [backend1] changed: [backend2] PLAY RECAP ************************************************************************************************************************************************ backend1 : ok=20 changed=15 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 backend2 : ok=20 changed=15 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 frontend : ok=4 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Parte 2 Configurar HAProxy en frontend Al final de /etc/haproxy/haproxy.cfg a\u00f1ado: frontend servidores_web bind *:80 mode http stats enable stats uri /ha_stats stats auth cda:cda default_backend servidores_web_backend backend servidores_web_backend mode http balance roundrobin server backend1 10.0.0.10:80 check server backend2 10.0.0.11:80 check Reinicio HAProxy: sudo systemctl restart haproxy Compruebo que ha empezado a escuchar en el puerto 80: vagrant@frontend:/etc/haproxy$ sudo lsof -i -P -n | grep LISTEN sshd 524 root 3u IPv4 12470 0t0 TCP *:22 (LISTEN) sshd 524 root 4u IPv6 12481 0t0 TCP *:22 (LISTEN) haproxy 20027 haproxy 7u IPv4 41481 0t0 TCP *:80 (LISTEN) Parte 3 Configurar la resoluci\u00f3n est\u00e1tica y acceder a wordpress /etc/hosts : # haproxy 192.168.121.61 www.example.org En cada nodo tenemos un info.php , as\u00ed que podemos comprobar si el balanceo funciona mirando los hostnames: Parte 4 Calcular el rendimiento haciendo 5 pruebas. Obtener la media de Requests per second Hago una primera prueba con: ab -t 10 -c 100 http://www.example.org/wordpress/ Estos son los resultados: This is ApacheBench, Version 2.3 <$Revision: 1879490 $> Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking www.example.org (be patient) Finished 917 requests Server Software: nginx/1.18.0 Server Hostname: www.example.org Server Port: 80 Document Path: /wordpress/ Document Length: 26892 bytes Concurrency Level: 100 Time taken for tests: 10.009 seconds Complete requests: 917 Failed requests: 508 (Connect: 0, Receive: 0, Length: 508, Exceptions: 0) Total transferred: 24881439 bytes HTML transferred: 24672135 bytes Requests per second: 91.62 [#/sec] (mean) Time per request: 1091.467 [ms] (mean) Time per request: 10.915 [ms] (mean, across all concurrent requests) Transfer rate: 2427.70 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.5 0 2 Processing: 14 954 945.3 559 2454 Waiting: 10 933 937.0 539 2427 Total: 14 954 945.2 559 2454 Percentage of the requests served within a certain time (ms) 50% 556 66% 1356 75% 2086 80% 2279 90% 2389 95% 2399 98% 2418 99% 2436 100% 2454 (longest request) La parte que nos importa: Requests per second: 91.62 [#/sec] (mean) Hago 4 pruebas m\u00e1s y saco una media: Requests per second: 102.89 [#/sec] (mean) Requests per second: 101.58 [#/sec] (mean) Requests per second: 101.68 [#/sec] (mean) Requests per second: 99.28 [#/sec] (mean) Parte 5 5.1 Instalar hatop sudo apt install hatop 5.2 Acceder a las estad\u00edsticas/administraci\u00f3n sudo hatop -s /run/haproxy/admin.sock 5.3 Deshabilitar el nodo backend1 Pulso F10 encima del nodo para que entre en mantenimiento: 5.4 Volver a hacer las pruebas de rendimiento Requests per second: 43.26 [#/sec] (mean) Requests per second: 38.94 [#/sec] (mean) Requests per second: 45.58 [#/sec] (mean) Requests per second: 45.73 [#/sec] (mean) Requests per second: 45.78 [#/sec] (mean) 5.5 \u00bfSe nota la diferencia entre balancear y no balancear? S\u00ed, b\u00e1sicamente porque al tener un solo nodo el rendimiento baja a la mitad (l\u00f3gicamente) . 5.6 Habilitar de nuevo el nodo backend1 Hago lo mismo que para deshabilitarlo, pero esta vez pulso F9: Parte 6 A\u00f1adir un nuevo nodo backend3 donde se instale Wordpress. 6.1 Modificar el Vagrantfile config.vm.define :backend3 do |backend3| backend3.vm.box = \"debian/bullseye64\" backend3.vm.hostname = \"backend3\" backend3.vm.synced_folder \".\", \"/vagrant\", disabled: true backend3.vm.network :private_network, :libvirt__network_name => \"red1\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.12\", :libvirt__forward_mode => \"veryisolated\" end Creo la m\u00e1quina: vagrant up backend3 6.2 Modificar el Ansible ansible/hosts : [servidor_ha] frontend ansible_ssh_host=192.168.121.61 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/frontend/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 [servidores_web] backend1 ansible_ssh_host=192.168.121.196 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend1/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 backend2 ansible_ssh_host=192.168.121.20 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend2/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 backend3 ansible_ssh_host=192.168.121.236 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend3/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook de nuevo para configurar la nueva m\u00e1quina como las dem\u00e1s: atlas@olympus:~/vagrant/vagrant_ansible_haproxy/ansible$ ansible-playbook site.yaml PLAY [all] ************************************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend2] ok: [frontend] ok: [backend3] ok: [backend1] TASK [commons : Ensure system is updated] ****************************************************************************************************************************** ok: [backend2] ok: [backend1] ok: [frontend] changed: [backend3] PLAY [servidor_ha] ***************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [frontend] TASK [haproxy : install haproxy] *************************************************************************************************************************************** ok: [frontend] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend3] ok: [backend1] ok: [backend2] TASK [nginx : install nginx, php-fpm] ********************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [nginx : Copy info.php] ******************************************************************************************************************************************* ok: [backend1] ok: [backend2] changed: [backend3] TASK [nginx : Copy virtualhost default] ******************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] RUNNING HANDLER [nginx : restart nginx] ******************************************************************************************************************************** changed: [backend3] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend1] ok: [backend2] ok: [backend3] TASK [mariadb : ensure mariadb is installed] *************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [mariadb : ensure mariadb binds to internal interface] ************************************************************************************************************ ok: [backend2] ok: [backend1] changed: [backend3] RUNNING HANDLER [mariadb : restart mariadb] **************************************************************************************************************************** changed: [backend3] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend1] ok: [backend2] ok: [backend3] TASK [wordpress : install unzip] *************************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [wordpress : download wordpress] ********************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [wordpress : unzip wordpress] ************************************************************************************************************************************* changed: [backend3] ok: [backend1] ok: [backend2] TASK [wordpress : Copy wordpress.sql] ********************************************************************************************************************************** changed: [backend1] changed: [backend2] changed: [backend3] TASK [wordpress : create database wordpress] *************************************************************************************************************************** changed: [backend3] changed: [backend2] changed: [backend1] TASK [wordpress : create user mysql wordpress] ************************************************************************************************************************* changed: [backend3] => (item=localhost) ok: [backend2] => (item=localhost) ok: [backend1] => (item=localhost) TASK [wordpress : copy wp-config.php] ********************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] RUNNING HANDLER [wordpress : restart nginx] **************************************************************************************************************************** changed: [backend3] PLAY RECAP ************************************************************************************************************************************************************* backend1 : ok=17 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 backend2 : ok=17 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 backend3 : ok=20 changed=16 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 frontend : ok=4 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 6.3 A\u00f1adir backend3 a /etc/haproxy/haproxy.cfg para que se tome en cuenta para el balanceo backend servidores_web_backend mode http balance roundrobin server backend1 10.0.0.10:80 check server backend2 10.0.0.11:80 check server backend3 10.0.0.12:80 check Reinicio HAProxy: sudo systemctl restart haproxy 6.4 Volver a hacer las pruebas de rendimiento Requests per second: 130.12 [#/sec] (mean) Requests per second: 129.43 [#/sec] (mean) Requests per second: 129.21 [#/sec] (mean) Requests per second: 129.64 [#/sec] (mean) Requests per second: 130.01 [#/sec] (mean) 6.5 \u00bfSe nota la diferencia al balancear a\u00f1adiendo un nuevo nodo? L\u00f3gicamente s\u00ed. El rendimiento aumenta proporcionalmente. Memcached 2.1 Crear y configurar el escenario vagrant_ansible_wordpress Clono el repo: git clone https://github.com/josedom24/vagrant_ansible_wordpress.git Creo la m\u00e1quina: vagrant up Entro en ella y apunto su IP: 192.168.121.239 Modifico ansible/hosts con esta IP: [servidores_web] servidor_web ansible_ssh_host=192.168.121.239 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/default/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook para configurar la m\u00e1quina: atlas@olympus:~/vagrant/vagrant_ansible_wordpress/ansible$ ansible-playbook site.yaml [WARNING]: ansible.utils.display.initialize_locale has not been called, this may result in incorrectly calculated text widths that can cause Display to print incorrect line lengths PLAY [all] ************************************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [commons : Ensure system is updated] ****************************************************************************************************************************** changed: [servidor_web] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [nginx : install nginx, php-fpm] ********************************************************************************************************************************** changed: [servidor_web] TASK [nginx : Copy info.php] ******************************************************************************************************************************************* changed: [servidor_web] TASK [nginx : Copy virtualhost default] ******************************************************************************************************************************** changed: [servidor_web] RUNNING HANDLER [nginx : restart nginx] ******************************************************************************************************************************** changed: [servidor_web] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [mariadb : ensure mariadb is installed] *************************************************************************************************************************** changed: [servidor_web] TASK [mariadb : ensure mariadb binds to internal interface] ************************************************************************************************************ changed: [servidor_web] RUNNING HANDLER [mariadb : restart mariadb] **************************************************************************************************************************** changed: [servidor_web] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [wordpress : install unzip] *************************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : download wordpress] ********************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : unzip wordpress] ************************************************************************************************************************************* changed: [servidor_web] TASK [wordpress : Copy wordpress.sql] ********************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : create database wordpress] *************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : create user mysql wordpress] ************************************************************************************************************************* changed: [servidor_web] => (item=localhost) TASK [wordpress : copy wp-config.php] ********************************************************************************************************************************** changed: [servidor_web] RUNNING HANDLER [wordpress : restart nginx] **************************************************************************************************************************** changed: [servidor_web] PLAY RECAP ************************************************************************************************************************************************************* servidor_web : ok=20 changed=16 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.2 Configurar la resoluci\u00f3n est\u00e1tica /etc/hosts : # memcached 192.168.121.239 www.example.org 2.3 Instalar memcached. Comprobar en info.php que funciona. sudo apt install php-memcached memcached Si se instal\u00f3 correctamente, nos aparece esta secci\u00f3n: 2.4 Instalar y configurar W3 Total Cache en Wordpress para que se pueda comunicar con memcached Comienzo la configuraci\u00f3n de forma manual: En General Settings hay distintas cach\u00e9s y opciones que podemos activar y configurar con este plugin. Lo hago: Guardo las configuraciones: Reinicio Nginx: sudo systemctl restart nginx 2.5 Realizar el c\u00e1lculo de rendimiento y obtener la media Requests per second: 1083.49 [#/sec] (mean) Requests per second: 991.49 [#/sec] (mean) Requests per second: 1075.94 [#/sec] (mean) Requests per second: 1089.48 [#/sec] (mean) Requests per second: 1088.40 [#/sec] (mean) 2.6 \u00bfSe ha aumentado el rendimiento de forma significativa? Bastante. Como he mostrado, hemos llegado a las mil peticiones por segundo. Varnish 3.1 Reutilizar el escenario anterior Borro la m\u00e1quina y la creo de nuevo: vagrant destroy vagrant up Entro en ella y apunto su IP: 192.168.121.53 Modifico ansible/hosts con esta IP: [servidores_web] servidor_web ansible_ssh_host=192.168.121.53 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/default/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook para configurar la m\u00e1quina: ansible-playbook site.yaml 3.2 Configurar la resoluci\u00f3n est\u00e1tica /etc/hosts : # Varnish 192.168.121.53 www.example.org 3.3 Instalar Varnish sudo apt install varnish 3.4 Cambiar Nginx al puerto 8080 /etc/nginx/sites-available/default : server { listen 8080 default_server; listen [::]:8080 default_server; Reinicio: sudo systemctl restart nginx Compruebo que ha cambiado: 3.5 Cambiar Varnish al puerto 80 Seg\u00fan la documentaci\u00f3n oficial de varnish no hace falta modificar el fichero /etc/default/varnish en versiones recientes de Debian (ya que es legacy) . En su lugar, modifico /lib/systemd/system/varnish.service : Reinicio la configuraci\u00f3n de los daemon: sudo systemctl daemon-reload Reinicio Varnish: sudo systemctl restart varnish Compruebo que ha cambiado el puerto: 3.6 Comprobar que la secci\u00f3n backend en /etc/varnish/default.vcl que tenemos por defecto sea correcta Lo es: 3.7 Comprobar que se puede acceder a Wordpress normalmente tras los cambios 3.8 Realizar las pruebas de rendimiento Requests per second: 5806.68 [#/sec] (mean) Requests per second: 5952.47 [#/sec] (mean) Requests per second: 5941.95 [#/sec] (mean) Requests per second: 5877.94 [#/sec] (mean) Requests per second: 5960.23 [#/sec] (mean) Casi llegamos a una media de 6.000 peticiones por segundo, as\u00ed que hemos aumentado el rendimiento considerablemente. 3.9 \u00bfCu\u00e1ntas peticiones llegan realmente a Nginx? /var/log/nginx/access.log : Como vemos, fij\u00e1ndonos en la hora, Nginx s\u00f3lo ha servido 2 peticiones de las miles que se han hecho.","title":"Pr\u00e1ctica: Aumento rendimiento web"},{"location":"practica-aumento-rendimiento-web/#practica-aumento-de-rendimiento-en-servidores-web","text":"","title":"Pr\u00e1ctica: Aumento de rendimiento en servidores web"},{"location":"practica-aumento-rendimiento-web/#haproxy-balanceador-de-carga","text":"","title":"HAProxy: Balanceador de carga"},{"location":"practica-aumento-rendimiento-web/#parte-1","text":"Crear y configurar el escenario usando el repositorio vagrant_ansible_haproxy Clono el repo: git clone https://github.com/josedom24/vagrant_ansible_haproxy.git Creo las m\u00e1quinas: vagrant up Entro en cada una de ellas y apunto sus IPs: frontend: 192.168.121.61 backend1: 192.168.121.196 backend2: 192.168.121.20 Modifico ansible/hosts con estas IPs: [servidor_ha] frontend ansible_ssh_host=192.168.121.61 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/frontend/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 [servidores_web] backend1 ansible_ssh_host=192.168.121.196 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend1/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 backend2 ansible_ssh_host=192.168.121.20 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend2/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook para configurar el escenario: ansible-playbook site.yaml Podemos llegar a encontrarnos con este fallo, y lo documento para que se sepa: Para arreglarlo tendr\u00edamos que entrar en cada m\u00e1quina y cambiar los repositorios en /etc/apt/sources.list a https: Una vez hecho esto, vuelvo a ejecutar el playbook y ya funcionar\u00eda: atlas@olympus:~/vagrant/vagrant_ansible_haproxy/ansible$ ansible-playbook site.yaml PLAY [all] ************************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ ok: [frontend] ok: [backend1] ok: [backend2] TASK [commons : Ensure system is updated] ***************************************************************************************************************** ok: [backend2] ok: [backend1] ok: [frontend] PLAY [servidor_ha] **************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************ ok: [frontend] TASK [haproxy : install haproxy] ************************************************************************************************************************** changed: [frontend] PLAY [servidores_web] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************ ok: [backend2] ok: [backend1] TASK [nginx : install nginx, php-fpm] ********************************************************************************************************************* changed: [backend1] changed: [backend2] TASK [nginx : Copy info.php] ****************************************************************************************************************************** changed: [backend1] changed: [backend2] TASK [nginx : Copy virtualhost default] ******************************************************************************************************************* changed: [backend1] changed: [backend2] RUNNING HANDLER [nginx : restart nginx] ******************************************************************************************************************* changed: [backend2] changed: [backend1] PLAY [servidores_web] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************ ok: [backend1] ok: [backend2] TASK [mariadb : ensure mariadb is installed] ************************************************************************************************************** changed: [backend1] changed: [backend2] TASK [mariadb : ensure mariadb binds to internal interface] *********************************************************************************************** changed: [backend2] changed: [backend1] RUNNING HANDLER [mariadb : restart mariadb] *************************************************************************************************************** changed: [backend2] changed: [backend1] PLAY [servidores_web] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************ ok: [backend1] ok: [backend2] TASK [wordpress : install unzip] ************************************************************************************************************************** changed: [backend2] changed: [backend1] TASK [wordpress : download wordpress] ********************************************************************************************************************* changed: [backend2] changed: [backend1] TASK [wordpress : unzip wordpress] ************************************************************************************************************************ changed: [backend2] changed: [backend1] TASK [wordpress : Copy wordpress.sql] ********************************************************************************************************************* changed: [backend1] changed: [backend2] TASK [wordpress : create database wordpress] ************************************************************************************************************** changed: [backend2] changed: [backend1] TASK [wordpress : create user mysql wordpress] ************************************************************************************************************ changed: [backend1] => (item=localhost) changed: [backend2] => (item=localhost) TASK [wordpress : copy wp-config.php] ********************************************************************************************************************* changed: [backend1] changed: [backend2] RUNNING HANDLER [wordpress : restart nginx] *************************************************************************************************************** changed: [backend1] changed: [backend2] PLAY RECAP ************************************************************************************************************************************************ backend1 : ok=20 changed=15 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 backend2 : ok=20 changed=15 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 frontend : ok=4 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"Parte 1"},{"location":"practica-aumento-rendimiento-web/#parte-2","text":"Configurar HAProxy en frontend Al final de /etc/haproxy/haproxy.cfg a\u00f1ado: frontend servidores_web bind *:80 mode http stats enable stats uri /ha_stats stats auth cda:cda default_backend servidores_web_backend backend servidores_web_backend mode http balance roundrobin server backend1 10.0.0.10:80 check server backend2 10.0.0.11:80 check Reinicio HAProxy: sudo systemctl restart haproxy Compruebo que ha empezado a escuchar en el puerto 80: vagrant@frontend:/etc/haproxy$ sudo lsof -i -P -n | grep LISTEN sshd 524 root 3u IPv4 12470 0t0 TCP *:22 (LISTEN) sshd 524 root 4u IPv6 12481 0t0 TCP *:22 (LISTEN) haproxy 20027 haproxy 7u IPv4 41481 0t0 TCP *:80 (LISTEN)","title":"Parte 2"},{"location":"practica-aumento-rendimiento-web/#parte-3","text":"Configurar la resoluci\u00f3n est\u00e1tica y acceder a wordpress /etc/hosts : # haproxy 192.168.121.61 www.example.org En cada nodo tenemos un info.php , as\u00ed que podemos comprobar si el balanceo funciona mirando los hostnames:","title":"Parte 3"},{"location":"practica-aumento-rendimiento-web/#parte-4","text":"Calcular el rendimiento haciendo 5 pruebas. Obtener la media de Requests per second Hago una primera prueba con: ab -t 10 -c 100 http://www.example.org/wordpress/ Estos son los resultados: This is ApacheBench, Version 2.3 <$Revision: 1879490 $> Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking www.example.org (be patient) Finished 917 requests Server Software: nginx/1.18.0 Server Hostname: www.example.org Server Port: 80 Document Path: /wordpress/ Document Length: 26892 bytes Concurrency Level: 100 Time taken for tests: 10.009 seconds Complete requests: 917 Failed requests: 508 (Connect: 0, Receive: 0, Length: 508, Exceptions: 0) Total transferred: 24881439 bytes HTML transferred: 24672135 bytes Requests per second: 91.62 [#/sec] (mean) Time per request: 1091.467 [ms] (mean) Time per request: 10.915 [ms] (mean, across all concurrent requests) Transfer rate: 2427.70 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.5 0 2 Processing: 14 954 945.3 559 2454 Waiting: 10 933 937.0 539 2427 Total: 14 954 945.2 559 2454 Percentage of the requests served within a certain time (ms) 50% 556 66% 1356 75% 2086 80% 2279 90% 2389 95% 2399 98% 2418 99% 2436 100% 2454 (longest request) La parte que nos importa: Requests per second: 91.62 [#/sec] (mean) Hago 4 pruebas m\u00e1s y saco una media: Requests per second: 102.89 [#/sec] (mean) Requests per second: 101.58 [#/sec] (mean) Requests per second: 101.68 [#/sec] (mean) Requests per second: 99.28 [#/sec] (mean)","title":"Parte 4"},{"location":"practica-aumento-rendimiento-web/#parte-5","text":"","title":"Parte 5"},{"location":"practica-aumento-rendimiento-web/#51","text":"Instalar hatop sudo apt install hatop","title":"5.1"},{"location":"practica-aumento-rendimiento-web/#52","text":"Acceder a las estad\u00edsticas/administraci\u00f3n sudo hatop -s /run/haproxy/admin.sock","title":"5.2"},{"location":"practica-aumento-rendimiento-web/#53","text":"Deshabilitar el nodo backend1 Pulso F10 encima del nodo para que entre en mantenimiento:","title":"5.3"},{"location":"practica-aumento-rendimiento-web/#54","text":"Volver a hacer las pruebas de rendimiento Requests per second: 43.26 [#/sec] (mean) Requests per second: 38.94 [#/sec] (mean) Requests per second: 45.58 [#/sec] (mean) Requests per second: 45.73 [#/sec] (mean) Requests per second: 45.78 [#/sec] (mean)","title":"5.4"},{"location":"practica-aumento-rendimiento-web/#55","text":"\u00bfSe nota la diferencia entre balancear y no balancear? S\u00ed, b\u00e1sicamente porque al tener un solo nodo el rendimiento baja a la mitad (l\u00f3gicamente) .","title":"5.5"},{"location":"practica-aumento-rendimiento-web/#56","text":"Habilitar de nuevo el nodo backend1 Hago lo mismo que para deshabilitarlo, pero esta vez pulso F9:","title":"5.6"},{"location":"practica-aumento-rendimiento-web/#parte-6","text":"A\u00f1adir un nuevo nodo backend3 donde se instale Wordpress.","title":"Parte 6"},{"location":"practica-aumento-rendimiento-web/#61","text":"Modificar el Vagrantfile config.vm.define :backend3 do |backend3| backend3.vm.box = \"debian/bullseye64\" backend3.vm.hostname = \"backend3\" backend3.vm.synced_folder \".\", \"/vagrant\", disabled: true backend3.vm.network :private_network, :libvirt__network_name => \"red1\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.12\", :libvirt__forward_mode => \"veryisolated\" end Creo la m\u00e1quina: vagrant up backend3","title":"6.1"},{"location":"practica-aumento-rendimiento-web/#62","text":"Modificar el Ansible ansible/hosts : [servidor_ha] frontend ansible_ssh_host=192.168.121.61 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/frontend/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 [servidores_web] backend1 ansible_ssh_host=192.168.121.196 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend1/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 backend2 ansible_ssh_host=192.168.121.20 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend2/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 backend3 ansible_ssh_host=192.168.121.236 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/backend3/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook de nuevo para configurar la nueva m\u00e1quina como las dem\u00e1s: atlas@olympus:~/vagrant/vagrant_ansible_haproxy/ansible$ ansible-playbook site.yaml PLAY [all] ************************************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend2] ok: [frontend] ok: [backend3] ok: [backend1] TASK [commons : Ensure system is updated] ****************************************************************************************************************************** ok: [backend2] ok: [backend1] ok: [frontend] changed: [backend3] PLAY [servidor_ha] ***************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [frontend] TASK [haproxy : install haproxy] *************************************************************************************************************************************** ok: [frontend] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend3] ok: [backend1] ok: [backend2] TASK [nginx : install nginx, php-fpm] ********************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [nginx : Copy info.php] ******************************************************************************************************************************************* ok: [backend1] ok: [backend2] changed: [backend3] TASK [nginx : Copy virtualhost default] ******************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] RUNNING HANDLER [nginx : restart nginx] ******************************************************************************************************************************** changed: [backend3] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend1] ok: [backend2] ok: [backend3] TASK [mariadb : ensure mariadb is installed] *************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [mariadb : ensure mariadb binds to internal interface] ************************************************************************************************************ ok: [backend2] ok: [backend1] changed: [backend3] RUNNING HANDLER [mariadb : restart mariadb] **************************************************************************************************************************** changed: [backend3] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [backend1] ok: [backend2] ok: [backend3] TASK [wordpress : install unzip] *************************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [wordpress : download wordpress] ********************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] TASK [wordpress : unzip wordpress] ************************************************************************************************************************************* changed: [backend3] ok: [backend1] ok: [backend2] TASK [wordpress : Copy wordpress.sql] ********************************************************************************************************************************** changed: [backend1] changed: [backend2] changed: [backend3] TASK [wordpress : create database wordpress] *************************************************************************************************************************** changed: [backend3] changed: [backend2] changed: [backend1] TASK [wordpress : create user mysql wordpress] ************************************************************************************************************************* changed: [backend3] => (item=localhost) ok: [backend2] => (item=localhost) ok: [backend1] => (item=localhost) TASK [wordpress : copy wp-config.php] ********************************************************************************************************************************** ok: [backend1] ok: [backend2] changed: [backend3] RUNNING HANDLER [wordpress : restart nginx] **************************************************************************************************************************** changed: [backend3] PLAY RECAP ************************************************************************************************************************************************************* backend1 : ok=17 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 backend2 : ok=17 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 backend3 : ok=20 changed=16 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 frontend : ok=4 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"6.2"},{"location":"practica-aumento-rendimiento-web/#63","text":"A\u00f1adir backend3 a /etc/haproxy/haproxy.cfg para que se tome en cuenta para el balanceo backend servidores_web_backend mode http balance roundrobin server backend1 10.0.0.10:80 check server backend2 10.0.0.11:80 check server backend3 10.0.0.12:80 check Reinicio HAProxy: sudo systemctl restart haproxy","title":"6.3"},{"location":"practica-aumento-rendimiento-web/#64","text":"Volver a hacer las pruebas de rendimiento Requests per second: 130.12 [#/sec] (mean) Requests per second: 129.43 [#/sec] (mean) Requests per second: 129.21 [#/sec] (mean) Requests per second: 129.64 [#/sec] (mean) Requests per second: 130.01 [#/sec] (mean)","title":"6.4"},{"location":"practica-aumento-rendimiento-web/#65","text":"\u00bfSe nota la diferencia al balancear a\u00f1adiendo un nuevo nodo? L\u00f3gicamente s\u00ed. El rendimiento aumenta proporcionalmente.","title":"6.5"},{"location":"practica-aumento-rendimiento-web/#memcached","text":"","title":"Memcached"},{"location":"practica-aumento-rendimiento-web/#21","text":"Crear y configurar el escenario vagrant_ansible_wordpress Clono el repo: git clone https://github.com/josedom24/vagrant_ansible_wordpress.git Creo la m\u00e1quina: vagrant up Entro en ella y apunto su IP: 192.168.121.239 Modifico ansible/hosts con esta IP: [servidores_web] servidor_web ansible_ssh_host=192.168.121.239 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/default/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook para configurar la m\u00e1quina: atlas@olympus:~/vagrant/vagrant_ansible_wordpress/ansible$ ansible-playbook site.yaml [WARNING]: ansible.utils.display.initialize_locale has not been called, this may result in incorrectly calculated text widths that can cause Display to print incorrect line lengths PLAY [all] ************************************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [commons : Ensure system is updated] ****************************************************************************************************************************** changed: [servidor_web] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [nginx : install nginx, php-fpm] ********************************************************************************************************************************** changed: [servidor_web] TASK [nginx : Copy info.php] ******************************************************************************************************************************************* changed: [servidor_web] TASK [nginx : Copy virtualhost default] ******************************************************************************************************************************** changed: [servidor_web] RUNNING HANDLER [nginx : restart nginx] ******************************************************************************************************************************** changed: [servidor_web] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [mariadb : ensure mariadb is installed] *************************************************************************************************************************** changed: [servidor_web] TASK [mariadb : ensure mariadb binds to internal interface] ************************************************************************************************************ changed: [servidor_web] RUNNING HANDLER [mariadb : restart mariadb] **************************************************************************************************************************** changed: [servidor_web] PLAY [servidores_web] ************************************************************************************************************************************************** TASK [Gathering Facts] ************************************************************************************************************************************************* ok: [servidor_web] TASK [wordpress : install unzip] *************************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : download wordpress] ********************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : unzip wordpress] ************************************************************************************************************************************* changed: [servidor_web] TASK [wordpress : Copy wordpress.sql] ********************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : create database wordpress] *************************************************************************************************************************** changed: [servidor_web] TASK [wordpress : create user mysql wordpress] ************************************************************************************************************************* changed: [servidor_web] => (item=localhost) TASK [wordpress : copy wp-config.php] ********************************************************************************************************************************** changed: [servidor_web] RUNNING HANDLER [wordpress : restart nginx] **************************************************************************************************************************** changed: [servidor_web] PLAY RECAP ************************************************************************************************************************************************************* servidor_web : ok=20 changed=16 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"2.1"},{"location":"practica-aumento-rendimiento-web/#22","text":"Configurar la resoluci\u00f3n est\u00e1tica /etc/hosts : # memcached 192.168.121.239 www.example.org","title":"2.2"},{"location":"practica-aumento-rendimiento-web/#23","text":"Instalar memcached. Comprobar en info.php que funciona. sudo apt install php-memcached memcached Si se instal\u00f3 correctamente, nos aparece esta secci\u00f3n:","title":"2.3"},{"location":"practica-aumento-rendimiento-web/#24","text":"Instalar y configurar W3 Total Cache en Wordpress para que se pueda comunicar con memcached Comienzo la configuraci\u00f3n de forma manual: En General Settings hay distintas cach\u00e9s y opciones que podemos activar y configurar con este plugin. Lo hago: Guardo las configuraciones: Reinicio Nginx: sudo systemctl restart nginx","title":"2.4"},{"location":"practica-aumento-rendimiento-web/#25","text":"Realizar el c\u00e1lculo de rendimiento y obtener la media Requests per second: 1083.49 [#/sec] (mean) Requests per second: 991.49 [#/sec] (mean) Requests per second: 1075.94 [#/sec] (mean) Requests per second: 1089.48 [#/sec] (mean) Requests per second: 1088.40 [#/sec] (mean)","title":"2.5"},{"location":"practica-aumento-rendimiento-web/#26","text":"\u00bfSe ha aumentado el rendimiento de forma significativa? Bastante. Como he mostrado, hemos llegado a las mil peticiones por segundo.","title":"2.6"},{"location":"practica-aumento-rendimiento-web/#varnish","text":"","title":"Varnish"},{"location":"practica-aumento-rendimiento-web/#31","text":"Reutilizar el escenario anterior Borro la m\u00e1quina y la creo de nuevo: vagrant destroy vagrant up Entro en ella y apunto su IP: 192.168.121.53 Modifico ansible/hosts con esta IP: [servidores_web] servidor_web ansible_ssh_host=192.168.121.53 ansible_ssh_user=vagrant ansible_ssh_private_key_file=../.vagrant/machines/default/libvirt/private_key ansible_python_interpreter=/usr/bin/python3 Ejecuto el playbook para configurar la m\u00e1quina: ansible-playbook site.yaml","title":"3.1"},{"location":"practica-aumento-rendimiento-web/#32","text":"Configurar la resoluci\u00f3n est\u00e1tica /etc/hosts : # Varnish 192.168.121.53 www.example.org","title":"3.2"},{"location":"practica-aumento-rendimiento-web/#33","text":"Instalar Varnish sudo apt install varnish","title":"3.3"},{"location":"practica-aumento-rendimiento-web/#34","text":"Cambiar Nginx al puerto 8080 /etc/nginx/sites-available/default : server { listen 8080 default_server; listen [::]:8080 default_server; Reinicio: sudo systemctl restart nginx Compruebo que ha cambiado:","title":"3.4"},{"location":"practica-aumento-rendimiento-web/#35","text":"Cambiar Varnish al puerto 80 Seg\u00fan la documentaci\u00f3n oficial de varnish no hace falta modificar el fichero /etc/default/varnish en versiones recientes de Debian (ya que es legacy) . En su lugar, modifico /lib/systemd/system/varnish.service : Reinicio la configuraci\u00f3n de los daemon: sudo systemctl daemon-reload Reinicio Varnish: sudo systemctl restart varnish Compruebo que ha cambiado el puerto:","title":"3.5"},{"location":"practica-aumento-rendimiento-web/#36","text":"Comprobar que la secci\u00f3n backend en /etc/varnish/default.vcl que tenemos por defecto sea correcta Lo es:","title":"3.6"},{"location":"practica-aumento-rendimiento-web/#37","text":"Comprobar que se puede acceder a Wordpress normalmente tras los cambios","title":"3.7"},{"location":"practica-aumento-rendimiento-web/#38","text":"Realizar las pruebas de rendimiento Requests per second: 5806.68 [#/sec] (mean) Requests per second: 5952.47 [#/sec] (mean) Requests per second: 5941.95 [#/sec] (mean) Requests per second: 5877.94 [#/sec] (mean) Requests per second: 5960.23 [#/sec] (mean) Casi llegamos a una media de 6.000 peticiones por segundo, as\u00ed que hemos aumentado el rendimiento considerablemente.","title":"3.8"},{"location":"practica-aumento-rendimiento-web/#39","text":"\u00bfCu\u00e1ntas peticiones llegan realmente a Nginx? /var/log/nginx/access.log : Como vemos, fij\u00e1ndonos en la hora, Nginx s\u00f3lo ha servido 2 peticiones de las miles que se han hecho.","title":"3.9"},{"location":"practica-cifrado-asimetrico-gpg-openssl/","text":"Pr\u00e1ctica: Cifrado asim\u00e9trico con gpg y openssl Tarea 1: Generaci\u00f3n de claves Ejercicio 0 Instalar gpg sudo apt update sudo apt install gnupg Ejercicio 1 Generar par de claves gpg --gen-key En rojo, marco lo que yo he tenido que escribir. Cuando pide una passphrase, no le pongo ninguna. \u00bfEn qu\u00e9 directorio se guardan las claves de un usuario? /home/vagrant/.gnupg Ejercicio 2 Listar las claves p\u00fablicas gpg --list-keys /home/vagrant/.gnupg/pubring.kbx -------------------------------- pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] Explicar el output /home/vagrant/.gnupg/pubring.kbx : anillo de claves pub : indicador de clave p\u00fablica rsa3072 : tipo de clave rsa y tama\u00f1o en bits de 3072 2021-11-15 : fecha de creaci\u00f3n [expires: 2023-11-15] : fecha de expiraci\u00f3n 5FAB740108563CA70D25EFA770B15EFFA5837AF8 : fingerprint de la clave uid : identificadores de la clave sub : indica una \"subkey\". Esto es un concepto un poco avanzado de gpg que no hemos visto, porque en realidad cada par de claves que creamos a su vez crean subpares de claves por debajo. \u00bfC\u00f3mo deber\u00edas haber generado las claves para indicar, por ejemplo, que tengan 1 mes de validez? gpg --full-gen-key En rojo he marcado cuando: Defino 1 mes de validez Aparece la fecha de expiraci\u00f3n correcta en la clave Ejercicio 3 Listar las claves privadas gpg --list-secret-keys /home/vagrant/.gnupg/pubring.kbx -------------------------------- sec rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> ssb rsa3072 2021-11-15 [E] [expires: 2023-11-15] Tarea 2: Importar / exportar clave p\u00fablica Ejercicio 1 Exportar tu clave p\u00fablica en ASCII al fichero adrian_jaramillo.asc gpg --armor --output adrian_jaramillo.asc --export adristudy@gmail.com Enviar adrian_jaramillo.asc a Carlos Enviado. Ejercicio 2 Importar la clave p\u00fablica recibida de Carlos He recibido: -rw-r--r-- 1 vagrant vagrant 2476 Nov 15 09:18 carlos_rivero.asc La importo: gpg --import carlos_rivero.asc gpg: key 69700115DE666C54: public key \"Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 Ejercicio 3 Comprobar que la clave se ha incluido correctamente gpg --list-keys /home/vagrant/.gnupg/pubring.kbx -------------------------------- pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 35AAEDB27BDF2918D11FB3B569700115DE666C54 uid [ unknown] Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] Abajo tenemos la de Carlos. Tarea 3: Cifrado asim\u00e9trico con claves p\u00fablicas Ejercicio 1 Cifrar un fichero con la clave p\u00fablica de Carlos gpg --output para_carlos.txt.gpg --encrypt --recipient carlosrivero1988@gmail.com para_carlos.txt gpg: A226D42A5B0599A6: There is no assurance this key belongs to the named user sub rsa3072/A226D42A5B0599A6 2021-11-15 Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> Primary key fingerprint: 35AA EDB2 7BDF 2918 D11F B3B5 6970 0115 DE66 6C54 Subkey fingerprint: 0FC1 7DA5 8FC3 9973 A4FA 5648 A226 D42A 5B05 99A6 It is NOT certain that the key belongs to the person named in the user ID. If you *really* know what you are doing, you may answer the next question with yes. Use this key anyway? (y/N) y Fichero generado: -rw-r--r-- 1 vagrant vagrant 498 Nov 15 09:46 para_carlos.txt.gpg Enviar el fichero cifrado a Carlos Enviado. Ejercicio 2 Carlos nos enviar\u00e1 un fichero cifrado -rw-r--r-- 1 vagrant vagrant 502 Nov 15 09:58 para_adrian.txt.gpg Ejercicio 3 Descifrar para_adrian.txt.gpg gpg --output para_adrian.txt --decrypt para_adrian.txt.gpg gpg: encrypted with 3072-bit RSA key, ID ABA647DE60867CB5, created 2021-11-15 \"Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com>\" Se nos indica la clave p\u00fablica original con la que se encript\u00f3 el mensaje. Fichero desencriptado: -rw-r--r-- 1 vagrant vagrant 30 Nov 15 10:11 para_adrian.txt Contenido: vagrant@practicacifradogpg:~$ cat para_adrian.txt Mensaje cifrado para Adri\u00e1n. Ejercicio 4 Enviar para_carlos.txt.gpg a Daniel Parrales Enviado. Comprobar que Daniel no puede descifrar para_carlos.txt.gpg Si intenta hacer: gpg --output para_carlos.txt --decrypt para_carlos.txt.gpg Le aparece: gpg: encrypted with RSA key, ID A226D42A5B0599A6 gpg: decryption failed: No secret key Esto sucede porque Daniel no tiene la clave privada asociada a la p\u00fablica con la que originalmente se encript\u00f3 el fichero. Ejercicio 5 Borrar tu clave privada gpg --delete-secret-key adristudy@gmail.com Muestro que se ha borrado: vagrant@practicacifradogpg:~$ gpg --list-secret-keys vagrant@practicacifradogpg:~$ Borrar todas las claves p\u00fablicas gpg --delete-key carlosrivero1988@gmail.com gpg --delete-key adristudy@gmail.com Muestro que no queda ninguna: vagrant@practicacifradogpg:~$ gpg --list-keys vagrant@practicacifradogpg:~$ Tarea 4: Exportar clave a un servidor p\u00fablico de claves PGP Ejercicio 1 Generar certificado de revocaci\u00f3n de tu clave p\u00fablica gpg --output revoke_adrianj.asc --gen-revoke adristudy@gmail.com Seguimos los pasos que se nos indican (en rojo, mis respuestas) : Fichero generado: -rw------- 1 vagrant vagrant 719 Nov 15 19:25 revoke_adrianj.asc Ejercicio 2 Exportar tu clave p\u00fablica a pgp.rediris.es gpg --keyserver pgp.rediris.es --send-key 5FAB740108563CA70D25EFA770B15EFFA5837AF8 gpg: sending key 70B15EFFA5837AF8 to hkp://pgp.rediris.es Obligatorio indicar el \"key ID\" despu\u00e9s de --send-key (no funcionar\u00eda, por ejemplo, indicando un correo). Compruebo que se haya subido correctamente: gpg --keyserver pgp.rediris.es --search-key adristudy@gmail.com La n\u00famero 1 es la que acabo de subir (las dem\u00e1s claves son de otros a\u00f1os) . La s\u00e9 identificar por: ID resumido (\u00faltimos 16 caracteres del ID original) Fecha de creaci\u00f3n Ejercicio 3 Borrar la clave p\u00fablica de Carlos gpg --delete-keys carlosrivero1988@gmail.com gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. pub rsa3072/69700115DE666C54 2021-11-15 Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> Delete this key from the keyring? (y/N) y Importarla desde pgp.rediris.es Para importar su clave p\u00fablica de nuevo a mi keybox, primero, tengo que averiguar su ID. gpg --keyserver pgp.rediris.es --search-key carlosrivero1988@gmail.com gpg: data source: http://130.206.1.8:11371 (1) Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> 3072 bit RSA key 69700115DE666C54, created: 2021-11-15, expires: 2023-11-15 Sabiendo su ID, 69700115DE666C54 , me bajo la clave: gpg --keyserver pgp.rediris.es --recv-key 69700115DE666C54 gpg: key 69700115DE666C54: public key \"Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 Vuelvo a listar mis claves p\u00fablicas, y la tengo: vagrant@practicacifradogpg:~$ gpg --list-key /home/vagrant/.gnupg/pubring.kbx -------------------------------- pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 35AAEDB27BDF2918D11FB3B569700115DE666C54 uid [ unknown] Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] Tarea 5: Cifrado asim\u00e9trico con openssl Ejercicio 1 Generar par de claves openssl genrsa -des3 -out keypair.pem 2048 Generating RSA private key, 2048 bit long modulus (2 primes) ......................................................................................+++++ ....................................................................................................................+++++ e is 65537 (0x010001) Enter pass phrase for keypair.pem: Verifying - Enter pass phrase for keypair.pem: Passphrase: 1234 Fichero resultante: -rw------- 1 vagrant vagrant 1743 Nov 15 22:56 keypair.pem Ejercicio 2 Enviar tu clave p\u00fablica a Carlos Exporto mi clave p\u00fablica del fichero keypair.pem : openssl rsa -in keypair.pem -outform PEM -pubout -out public_adrianj.pem Enter pass phrase for keypair.pem: writing RSA key Nos pregunta la passphrase, y nos genera: -rw-r--r-- 1 vagrant vagrant 451 Nov 15 23:15 public_adrianj.pem Este fichero, es el que env\u00edo a Carlos. Ejercicio 3 Recibir la clave p\u00fablica de Carlos -rw-r--r-- 1 vagrant vagrant 451 Nov 16 00:08 public_crivero.pem Utilizando esa clave, cifra un fichero de texto y env\u00edaselo openssl rsautl -encrypt -inkey public_crivero.pem -pubin -in para_carlos_openssl.txt -out para_carlos_openssl.txt.enc Nos genera este fichero cifrado: -rw-r--r-- 1 vagrant vagrant 256 Nov 16 00:24 para_carlos_openssl.txt.enc Se lo env\u00edo. Ejercicio 4 Recibe un fichero cifrado de Carlos -rw-r--r-- 1 vagrant vagrant 256 Nov 16 00:35 para_adrian_openssl.txt.enc Descifra el fichero openssl rsautl -decrypt -inkey keypair.pem -in para_adrian_openssl.txt.enc > para_adrian_openssl.txt Enter pass phrase for keypair.pem: Introducimos la passphrase, y obtenemos el fichero: -rw-r--r-- 1 vagrant vagrant 58 Nov 16 00:43 para_adrian_openssl.txt Con el contenido: vagrant@practicacifradogpg:~$ cat para_adrian_openssl.txt Este mensaje se cifrar\u00e1 con openssl. Es para Adri\u00e1n.","title":"Criptograf\u00eda 1: Cifrado as\u00edmetrico"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#practica-cifrado-asimetrico-con-gpg-y-openssl","text":"","title":"Pr\u00e1ctica: Cifrado asim\u00e9trico con gpg y openssl"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#tarea-1-generacion-de-claves","text":"","title":"Tarea 1: Generaci\u00f3n de claves"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-0","text":"Instalar gpg sudo apt update sudo apt install gnupg","title":"Ejercicio 0"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-1","text":"Generar par de claves gpg --gen-key En rojo, marco lo que yo he tenido que escribir. Cuando pide una passphrase, no le pongo ninguna. \u00bfEn qu\u00e9 directorio se guardan las claves de un usuario? /home/vagrant/.gnupg","title":"Ejercicio 1"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-2","text":"Listar las claves p\u00fablicas gpg --list-keys /home/vagrant/.gnupg/pubring.kbx -------------------------------- pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] Explicar el output /home/vagrant/.gnupg/pubring.kbx : anillo de claves pub : indicador de clave p\u00fablica rsa3072 : tipo de clave rsa y tama\u00f1o en bits de 3072 2021-11-15 : fecha de creaci\u00f3n [expires: 2023-11-15] : fecha de expiraci\u00f3n 5FAB740108563CA70D25EFA770B15EFFA5837AF8 : fingerprint de la clave uid : identificadores de la clave sub : indica una \"subkey\". Esto es un concepto un poco avanzado de gpg que no hemos visto, porque en realidad cada par de claves que creamos a su vez crean subpares de claves por debajo. \u00bfC\u00f3mo deber\u00edas haber generado las claves para indicar, por ejemplo, que tengan 1 mes de validez? gpg --full-gen-key En rojo he marcado cuando: Defino 1 mes de validez Aparece la fecha de expiraci\u00f3n correcta en la clave","title":"Ejercicio 2"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-3","text":"Listar las claves privadas gpg --list-secret-keys /home/vagrant/.gnupg/pubring.kbx -------------------------------- sec rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> ssb rsa3072 2021-11-15 [E] [expires: 2023-11-15]","title":"Ejercicio 3"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#tarea-2-importar-exportar-clave-publica","text":"","title":"Tarea 2: Importar / exportar clave p\u00fablica"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-1_1","text":"Exportar tu clave p\u00fablica en ASCII al fichero adrian_jaramillo.asc gpg --armor --output adrian_jaramillo.asc --export adristudy@gmail.com Enviar adrian_jaramillo.asc a Carlos Enviado.","title":"Ejercicio 1"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-2_1","text":"Importar la clave p\u00fablica recibida de Carlos He recibido: -rw-r--r-- 1 vagrant vagrant 2476 Nov 15 09:18 carlos_rivero.asc La importo: gpg --import carlos_rivero.asc gpg: key 69700115DE666C54: public key \"Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1","title":"Ejercicio 2"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-3_1","text":"Comprobar que la clave se ha incluido correctamente gpg --list-keys /home/vagrant/.gnupg/pubring.kbx -------------------------------- pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 35AAEDB27BDF2918D11FB3B569700115DE666C54 uid [ unknown] Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] Abajo tenemos la de Carlos.","title":"Ejercicio 3"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#tarea-3-cifrado-asimetrico-con-claves-publicas","text":"","title":"Tarea 3: Cifrado asim\u00e9trico con claves p\u00fablicas"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-1_2","text":"Cifrar un fichero con la clave p\u00fablica de Carlos gpg --output para_carlos.txt.gpg --encrypt --recipient carlosrivero1988@gmail.com para_carlos.txt gpg: A226D42A5B0599A6: There is no assurance this key belongs to the named user sub rsa3072/A226D42A5B0599A6 2021-11-15 Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> Primary key fingerprint: 35AA EDB2 7BDF 2918 D11F B3B5 6970 0115 DE66 6C54 Subkey fingerprint: 0FC1 7DA5 8FC3 9973 A4FA 5648 A226 D42A 5B05 99A6 It is NOT certain that the key belongs to the person named in the user ID. If you *really* know what you are doing, you may answer the next question with yes. Use this key anyway? (y/N) y Fichero generado: -rw-r--r-- 1 vagrant vagrant 498 Nov 15 09:46 para_carlos.txt.gpg Enviar el fichero cifrado a Carlos Enviado.","title":"Ejercicio 1"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-2_2","text":"Carlos nos enviar\u00e1 un fichero cifrado -rw-r--r-- 1 vagrant vagrant 502 Nov 15 09:58 para_adrian.txt.gpg","title":"Ejercicio 2"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-3_2","text":"Descifrar para_adrian.txt.gpg gpg --output para_adrian.txt --decrypt para_adrian.txt.gpg gpg: encrypted with 3072-bit RSA key, ID ABA647DE60867CB5, created 2021-11-15 \"Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com>\" Se nos indica la clave p\u00fablica original con la que se encript\u00f3 el mensaje. Fichero desencriptado: -rw-r--r-- 1 vagrant vagrant 30 Nov 15 10:11 para_adrian.txt Contenido: vagrant@practicacifradogpg:~$ cat para_adrian.txt Mensaje cifrado para Adri\u00e1n.","title":"Ejercicio 3"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-4","text":"Enviar para_carlos.txt.gpg a Daniel Parrales Enviado. Comprobar que Daniel no puede descifrar para_carlos.txt.gpg Si intenta hacer: gpg --output para_carlos.txt --decrypt para_carlos.txt.gpg Le aparece: gpg: encrypted with RSA key, ID A226D42A5B0599A6 gpg: decryption failed: No secret key Esto sucede porque Daniel no tiene la clave privada asociada a la p\u00fablica con la que originalmente se encript\u00f3 el fichero.","title":"Ejercicio 4"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-5","text":"Borrar tu clave privada gpg --delete-secret-key adristudy@gmail.com Muestro que se ha borrado: vagrant@practicacifradogpg:~$ gpg --list-secret-keys vagrant@practicacifradogpg:~$ Borrar todas las claves p\u00fablicas gpg --delete-key carlosrivero1988@gmail.com gpg --delete-key adristudy@gmail.com Muestro que no queda ninguna: vagrant@practicacifradogpg:~$ gpg --list-keys vagrant@practicacifradogpg:~$","title":"Ejercicio 5"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#tarea-4-exportar-clave-a-un-servidor-publico-de-claves-pgp","text":"","title":"Tarea 4: Exportar clave a un servidor p\u00fablico de claves PGP"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-1_3","text":"Generar certificado de revocaci\u00f3n de tu clave p\u00fablica gpg --output revoke_adrianj.asc --gen-revoke adristudy@gmail.com Seguimos los pasos que se nos indican (en rojo, mis respuestas) : Fichero generado: -rw------- 1 vagrant vagrant 719 Nov 15 19:25 revoke_adrianj.asc","title":"Ejercicio 1"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-2_3","text":"Exportar tu clave p\u00fablica a pgp.rediris.es gpg --keyserver pgp.rediris.es --send-key 5FAB740108563CA70D25EFA770B15EFFA5837AF8 gpg: sending key 70B15EFFA5837AF8 to hkp://pgp.rediris.es Obligatorio indicar el \"key ID\" despu\u00e9s de --send-key (no funcionar\u00eda, por ejemplo, indicando un correo). Compruebo que se haya subido correctamente: gpg --keyserver pgp.rediris.es --search-key adristudy@gmail.com La n\u00famero 1 es la que acabo de subir (las dem\u00e1s claves son de otros a\u00f1os) . La s\u00e9 identificar por: ID resumido (\u00faltimos 16 caracteres del ID original) Fecha de creaci\u00f3n","title":"Ejercicio 2"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-3_3","text":"Borrar la clave p\u00fablica de Carlos gpg --delete-keys carlosrivero1988@gmail.com gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. pub rsa3072/69700115DE666C54 2021-11-15 Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> Delete this key from the keyring? (y/N) y Importarla desde pgp.rediris.es Para importar su clave p\u00fablica de nuevo a mi keybox, primero, tengo que averiguar su ID. gpg --keyserver pgp.rediris.es --search-key carlosrivero1988@gmail.com gpg: data source: http://130.206.1.8:11371 (1) Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> 3072 bit RSA key 69700115DE666C54, created: 2021-11-15, expires: 2023-11-15 Sabiendo su ID, 69700115DE666C54 , me bajo la clave: gpg --keyserver pgp.rediris.es --recv-key 69700115DE666C54 gpg: key 69700115DE666C54: public key \"Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 Vuelvo a listar mis claves p\u00fablicas, y la tengo: vagrant@practicacifradogpg:~$ gpg --list-key /home/vagrant/.gnupg/pubring.kbx -------------------------------- pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 5FAB740108563CA70D25EFA770B15EFFA5837AF8 uid [ultimate] Adri\u00e1n Jaramillo Rodr\u00edguez <adristudy@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15] pub rsa3072 2021-11-15 [SC] [expires: 2023-11-15] 35AAEDB27BDF2918D11FB3B569700115DE666C54 uid [ unknown] Carlos Rivero Mart\u00edn <carlosrivero1988@gmail.com> sub rsa3072 2021-11-15 [E] [expires: 2023-11-15]","title":"Ejercicio 3"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#tarea-5-cifrado-asimetrico-con-openssl","text":"","title":"Tarea 5: Cifrado asim\u00e9trico con openssl"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-1_4","text":"Generar par de claves openssl genrsa -des3 -out keypair.pem 2048 Generating RSA private key, 2048 bit long modulus (2 primes) ......................................................................................+++++ ....................................................................................................................+++++ e is 65537 (0x010001) Enter pass phrase for keypair.pem: Verifying - Enter pass phrase for keypair.pem: Passphrase: 1234 Fichero resultante: -rw------- 1 vagrant vagrant 1743 Nov 15 22:56 keypair.pem","title":"Ejercicio 1"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-2_4","text":"Enviar tu clave p\u00fablica a Carlos Exporto mi clave p\u00fablica del fichero keypair.pem : openssl rsa -in keypair.pem -outform PEM -pubout -out public_adrianj.pem Enter pass phrase for keypair.pem: writing RSA key Nos pregunta la passphrase, y nos genera: -rw-r--r-- 1 vagrant vagrant 451 Nov 15 23:15 public_adrianj.pem Este fichero, es el que env\u00edo a Carlos.","title":"Ejercicio 2"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-3_4","text":"Recibir la clave p\u00fablica de Carlos -rw-r--r-- 1 vagrant vagrant 451 Nov 16 00:08 public_crivero.pem Utilizando esa clave, cifra un fichero de texto y env\u00edaselo openssl rsautl -encrypt -inkey public_crivero.pem -pubin -in para_carlos_openssl.txt -out para_carlos_openssl.txt.enc Nos genera este fichero cifrado: -rw-r--r-- 1 vagrant vagrant 256 Nov 16 00:24 para_carlos_openssl.txt.enc Se lo env\u00edo.","title":"Ejercicio 3"},{"location":"practica-cifrado-asimetrico-gpg-openssl/#ejercicio-4_1","text":"Recibe un fichero cifrado de Carlos -rw-r--r-- 1 vagrant vagrant 256 Nov 16 00:35 para_adrian_openssl.txt.enc Descifra el fichero openssl rsautl -decrypt -inkey keypair.pem -in para_adrian_openssl.txt.enc > para_adrian_openssl.txt Enter pass phrase for keypair.pem: Introducimos la passphrase, y obtenemos el fichero: -rw-r--r-- 1 vagrant vagrant 58 Nov 16 00:43 para_adrian_openssl.txt Con el contenido: vagrant@practicacifradogpg:~$ cat para_adrian_openssl.txt Este mensaje se cifrar\u00e1 con openssl. Es para Adri\u00e1n.","title":"Ejercicio 4"},{"location":"practica-cluster-ha/","text":"Pr\u00e1ctica: Cluster HA Cluster de HA activo-pasivo Entrega Parte 1 Mostrar la salida de sudo pcs status Ejecuto el comando, por ejemplo, en nodo1: vagrant@nodo1:~$ sudo pcs status Cluster name: mycluster Cluster Summary: * Stack: corosync * Current DC: nodo2 (version 2.0.5-ba59be7122) - partition with quorum * Last updated: Fri Feb 18 12:09:53 2022 * Last change: Fri Feb 18 12:05:38 2022 by root via cibadmin on nodo1 * 2 nodes configured * 5 resource instances configured Node List: * Online: [ nodo1 nodo2 ] Full List of Resources: * VirtualIP (ocf::heartbeat:IPaddr2): Started nodo1 * WebSite (ocf::heartbeat:apache): Started nodo1 * Clone Set: WebData-clone [WebData] (promotable): * Masters: [ nodo1 ] * Slaves: [ nodo2 ] * WebFS (ocf::heartbeat:Filesystem): Started nodo1 Daemon Status: corosync: active/enabled pacemaker: active/enabled pcsd: active/enabled Parte 2 2.1 Mostrar el acceso a index.php en nodo1) 2.2 Apagar nodo1 y mostrar de nuevo el acceso a index.php . Comprobar que se accede a nodo2. Hago vagrant halt nodo1 y muestro que realmente est\u00e1 apagado: 2+DRBD+GFS2/ansible/roles/bind/files$ vagrant status Current machine states: nodo1 shutoff (libvirt) nodo2 running (libvirt) dns running (libvirt) This environment represents multiple VMs. The VMs are all listed above with their current state. For more information about a specific VM, run `vagrant status NAME`. Recargo la p\u00e1gina y veo que el nodo ha cambiado: Parte 3 Comprobar que el cluster de Galera MariaDB tiene dos nodos Dentro de mariadb, en cualquiera de los nodos, ejecuto el siguiete comando: show status like 'wsrep_%'; El valor en wsrep_cluster_size nos indica que existen 2 nodos: Parte 4 Crear un post en Wordpress y mostrarlo Parte 5 Demostrar al profesor que apagando un nodo, WordPress sigue funcionando Hecho y funciona. Ejercicios Ejercicio 1 Lanzar Vagrant y Ansible sobre el escenario 06-HA-IPFailover-Apache2+DRBD+GFS2 vagrant up ansible-playbook site.yaml Ejercicio 2 Configurar el host para que use como servidor DNS primario el del escenario Modifico mi /etc/resolv.conf : # Generated by NetworkManager search gonzalonazareno.org 41011038.41.andared.ced.junta-andalucia.es nameserver 10.1.1.103 nameserver 192.168.202.2 nameserver 192.168.8.1 Ejercicio 3 3.1 Configuraciones de Galera MariaDB comunes a ambos nodos Instalo mariadb: sudo apt install mariadb-server Comento la siguiente l\u00ednea de /etc/mysql/mariadb.conf.d/50-server.cnf : # bind-address = 127 .0.0.1 Reinicio: sudo systemctl restart mariadb Compruebo que ahora mariadb acepta peticiones desde todas las IPs: 3.2 Configuraciones de Galera MariaDB en nodo1 Modifico /etc/mysql/mariadb.conf.d/60-galera.cnf : [galera] # Mandatory settings wsrep_on = ON wsrep_cluster_name = \"MariaDB Galera Cluster\" wsrep_provider = /usr/lib/galera/libgalera_smm.so wsrep_cluster_address = \"gcomm://nodo1,nodo2\" binlog_format = row default_storage_engine = InnoDB innodb_autoinc_lock_mode = 2 # Allow server to accept connections on all interfaces. bind-address = 0.0.0.0 wsrep_node_address = \"nodo1\" Inicializo el cluster y reinicio: sudo galera_new_cluster sudo systemctl restart mariadb 3.3 Configuraciones de Galera MariaDB en nodo2 Modifico /etc/mysql/mariadb.conf.d/60-galera.cnf : [galera] # Mandatory settings wsrep_on = ON wsrep_cluster_name = \"MariaDB Galera Cluster\" wsrep_provider = /usr/lib/galera/libgalera_smm.so wsrep_cluster_address = \"gcomm://nodo1,nodo2\" binlog_format = row default_storage_engine = InnoDB innodb_autoinc_lock_mode = 2 # Allow server to accept connections on all interfaces. bind-address = 0.0.0.0 wsrep_node_address = \"nodo2\" Reinicio: sudo systemctl restart mariadb Ejercicio 4 Tenemos que instalar Wordpress en el cluster. Esta instalaci\u00f3n ser\u00e1 id\u00e9ntica a la de un Wordpress sin cluster, s\u00f3lo que en este escenario el DocumentRoot se replicar\u00e1 al nodo2 en caso de fallo del nodo1. La base de datos se replica ya de por s\u00ed incluso sin fallos de nodo. 4.1 Configurar la BD La creo: CREATE DATABASE WORDPRESS ; Creo el usuario: CREATE USER 'WPUSER' @ localhost IDENTIFIED BY '1234' ; Asigno privilegios: GRANT ALL PRIVILEGES ON WORDPRESS . * TO WPUSER @ localhost IDENTIFIED BY '1234' ; FLUSH PRIVILEGES ; 4.2 Limpiar el DocumentRoot antiguo sudo rm -r /var/www/html/* 4.3 Descargar Wordpress Lo hago en /tmp : wget https://wordpress.org/latest.zip unzip latest.zip Muevo el contenido del directorio wordpress al DocumentRoot que ya ten\u00edamos funcionando: sudo mv /tmp/wordpress/* /var/www/html/ Dejo los permisos correctamente: sudo chown -R www-data:www-data /var/www/html/ 4.4 Instalar Wordpress","title":"Pr\u00e1ctica"},{"location":"practica-cluster-ha/#practica-cluster-ha","text":"","title":"Pr\u00e1ctica: Cluster HA"},{"location":"practica-cluster-ha/#cluster-de-ha-activo-pasivo","text":"","title":"Cluster de HA activo-pasivo"},{"location":"practica-cluster-ha/#entrega","text":"","title":"Entrega"},{"location":"practica-cluster-ha/#parte-1","text":"Mostrar la salida de sudo pcs status Ejecuto el comando, por ejemplo, en nodo1: vagrant@nodo1:~$ sudo pcs status Cluster name: mycluster Cluster Summary: * Stack: corosync * Current DC: nodo2 (version 2.0.5-ba59be7122) - partition with quorum * Last updated: Fri Feb 18 12:09:53 2022 * Last change: Fri Feb 18 12:05:38 2022 by root via cibadmin on nodo1 * 2 nodes configured * 5 resource instances configured Node List: * Online: [ nodo1 nodo2 ] Full List of Resources: * VirtualIP (ocf::heartbeat:IPaddr2): Started nodo1 * WebSite (ocf::heartbeat:apache): Started nodo1 * Clone Set: WebData-clone [WebData] (promotable): * Masters: [ nodo1 ] * Slaves: [ nodo2 ] * WebFS (ocf::heartbeat:Filesystem): Started nodo1 Daemon Status: corosync: active/enabled pacemaker: active/enabled pcsd: active/enabled","title":"Parte 1"},{"location":"practica-cluster-ha/#parte-2","text":"","title":"Parte 2"},{"location":"practica-cluster-ha/#21","text":"Mostrar el acceso a index.php en nodo1)","title":"2.1"},{"location":"practica-cluster-ha/#22","text":"Apagar nodo1 y mostrar de nuevo el acceso a index.php . Comprobar que se accede a nodo2. Hago vagrant halt nodo1 y muestro que realmente est\u00e1 apagado: 2+DRBD+GFS2/ansible/roles/bind/files$ vagrant status Current machine states: nodo1 shutoff (libvirt) nodo2 running (libvirt) dns running (libvirt) This environment represents multiple VMs. The VMs are all listed above with their current state. For more information about a specific VM, run `vagrant status NAME`. Recargo la p\u00e1gina y veo que el nodo ha cambiado:","title":"2.2"},{"location":"practica-cluster-ha/#parte-3","text":"Comprobar que el cluster de Galera MariaDB tiene dos nodos Dentro de mariadb, en cualquiera de los nodos, ejecuto el siguiete comando: show status like 'wsrep_%'; El valor en wsrep_cluster_size nos indica que existen 2 nodos:","title":"Parte 3"},{"location":"practica-cluster-ha/#parte-4","text":"Crear un post en Wordpress y mostrarlo","title":"Parte 4"},{"location":"practica-cluster-ha/#parte-5","text":"Demostrar al profesor que apagando un nodo, WordPress sigue funcionando Hecho y funciona.","title":"Parte 5"},{"location":"practica-cluster-ha/#ejercicios","text":"","title":"Ejercicios"},{"location":"practica-cluster-ha/#ejercicio-1","text":"Lanzar Vagrant y Ansible sobre el escenario 06-HA-IPFailover-Apache2+DRBD+GFS2 vagrant up ansible-playbook site.yaml","title":"Ejercicio 1"},{"location":"practica-cluster-ha/#ejercicio-2","text":"Configurar el host para que use como servidor DNS primario el del escenario Modifico mi /etc/resolv.conf : # Generated by NetworkManager search gonzalonazareno.org 41011038.41.andared.ced.junta-andalucia.es nameserver 10.1.1.103 nameserver 192.168.202.2 nameserver 192.168.8.1","title":"Ejercicio 2"},{"location":"practica-cluster-ha/#ejercicio-3","text":"","title":"Ejercicio 3"},{"location":"practica-cluster-ha/#31","text":"Configuraciones de Galera MariaDB comunes a ambos nodos Instalo mariadb: sudo apt install mariadb-server Comento la siguiente l\u00ednea de /etc/mysql/mariadb.conf.d/50-server.cnf : # bind-address = 127 .0.0.1 Reinicio: sudo systemctl restart mariadb Compruebo que ahora mariadb acepta peticiones desde todas las IPs:","title":"3.1"},{"location":"practica-cluster-ha/#32","text":"Configuraciones de Galera MariaDB en nodo1 Modifico /etc/mysql/mariadb.conf.d/60-galera.cnf : [galera] # Mandatory settings wsrep_on = ON wsrep_cluster_name = \"MariaDB Galera Cluster\" wsrep_provider = /usr/lib/galera/libgalera_smm.so wsrep_cluster_address = \"gcomm://nodo1,nodo2\" binlog_format = row default_storage_engine = InnoDB innodb_autoinc_lock_mode = 2 # Allow server to accept connections on all interfaces. bind-address = 0.0.0.0 wsrep_node_address = \"nodo1\" Inicializo el cluster y reinicio: sudo galera_new_cluster sudo systemctl restart mariadb","title":"3.2"},{"location":"practica-cluster-ha/#33","text":"Configuraciones de Galera MariaDB en nodo2 Modifico /etc/mysql/mariadb.conf.d/60-galera.cnf : [galera] # Mandatory settings wsrep_on = ON wsrep_cluster_name = \"MariaDB Galera Cluster\" wsrep_provider = /usr/lib/galera/libgalera_smm.so wsrep_cluster_address = \"gcomm://nodo1,nodo2\" binlog_format = row default_storage_engine = InnoDB innodb_autoinc_lock_mode = 2 # Allow server to accept connections on all interfaces. bind-address = 0.0.0.0 wsrep_node_address = \"nodo2\" Reinicio: sudo systemctl restart mariadb","title":"3.3"},{"location":"practica-cluster-ha/#ejercicio-4","text":"Tenemos que instalar Wordpress en el cluster. Esta instalaci\u00f3n ser\u00e1 id\u00e9ntica a la de un Wordpress sin cluster, s\u00f3lo que en este escenario el DocumentRoot se replicar\u00e1 al nodo2 en caso de fallo del nodo1. La base de datos se replica ya de por s\u00ed incluso sin fallos de nodo.","title":"Ejercicio 4"},{"location":"practica-cluster-ha/#41","text":"Configurar la BD La creo: CREATE DATABASE WORDPRESS ; Creo el usuario: CREATE USER 'WPUSER' @ localhost IDENTIFIED BY '1234' ; Asigno privilegios: GRANT ALL PRIVILEGES ON WORDPRESS . * TO WPUSER @ localhost IDENTIFIED BY '1234' ; FLUSH PRIVILEGES ;","title":"4.1"},{"location":"practica-cluster-ha/#42","text":"Limpiar el DocumentRoot antiguo sudo rm -r /var/www/html/*","title":"4.2"},{"location":"practica-cluster-ha/#43","text":"Descargar Wordpress Lo hago en /tmp : wget https://wordpress.org/latest.zip unzip latest.zip Muevo el contenido del directorio wordpress al DocumentRoot que ya ten\u00edamos funcionando: sudo mv /tmp/wordpress/* /var/www/html/ Dejo los permisos correctamente: sudo chown -R www-data:www-data /var/www/html/","title":"4.3"},{"location":"practica-cluster-ha/#44","text":"Instalar Wordpress","title":"4.4"},{"location":"practica-cms-java/","text":"Pr\u00e1ctica: Despliegue de CMS java Entrega Parte 1 Indica la aplicaci\u00f3n escogida y su funcionalidad. Parte 2 Escribe una gu\u00eda de los pasos fundamentales para realizar la instalaci\u00f3n. Parte 3 \u00bfHas necesitado instalar alguna librer\u00eda?\u00bfHas necesitado instalar un conector de una base de datos? Parte 4 Entrega una captura de pantalla donde se vea la aplicaci\u00f3n funcionando desde tomcat. Parte 5 Realiza la configuraci\u00f3n necesaria en apache2/nginx y tomcat para que la aplicaci\u00f3n sea servida por el servidor web. Parte 6 Muestra al profesor la aplicaci\u00f3n funcionando servida por apache2/nginx. Realizaci\u00f3n Debes desplegar la aplicaci\u00f3n desde un fichero war. No usar instalaciones \u201cbundler\u201d. Estas instalaciones instalan la aplicaci\u00f3n y tomcat al mismo tiempo. La aplicaci\u00f3n se debe desplegar en el tomcat que tienes instalado. Utiliza una m\u00e1quina virtual que tenga suficiente memoria, al menos 2Gb, algunos CMS requieren mucha memoria RAM. La aplicaci\u00f3n debe guardar los datos en una base de datos Alfresco Community Edition Parte 1 Prerequisitos end","title":"Pr\u00e1ctica: Despliegue de CMS java"},{"location":"practica-cms-java/#practica-despliegue-de-cms-java","text":"","title":"Pr\u00e1ctica: Despliegue de CMS java"},{"location":"practica-cms-java/#entrega","text":"","title":"Entrega"},{"location":"practica-cms-java/#parte-1","text":"Indica la aplicaci\u00f3n escogida y su funcionalidad.","title":"Parte 1"},{"location":"practica-cms-java/#parte-2","text":"Escribe una gu\u00eda de los pasos fundamentales para realizar la instalaci\u00f3n.","title":"Parte 2"},{"location":"practica-cms-java/#parte-3","text":"\u00bfHas necesitado instalar alguna librer\u00eda?\u00bfHas necesitado instalar un conector de una base de datos?","title":"Parte 3"},{"location":"practica-cms-java/#parte-4","text":"Entrega una captura de pantalla donde se vea la aplicaci\u00f3n funcionando desde tomcat.","title":"Parte 4"},{"location":"practica-cms-java/#parte-5","text":"Realiza la configuraci\u00f3n necesaria en apache2/nginx y tomcat para que la aplicaci\u00f3n sea servida por el servidor web.","title":"Parte 5"},{"location":"practica-cms-java/#parte-6","text":"Muestra al profesor la aplicaci\u00f3n funcionando servida por apache2/nginx.","title":"Parte 6"},{"location":"practica-cms-java/#realizacion","text":"Debes desplegar la aplicaci\u00f3n desde un fichero war. No usar instalaciones \u201cbundler\u201d. Estas instalaciones instalan la aplicaci\u00f3n y tomcat al mismo tiempo. La aplicaci\u00f3n se debe desplegar en el tomcat que tienes instalado. Utiliza una m\u00e1quina virtual que tenga suficiente memoria, al menos 2Gb, algunos CMS requieren mucha memoria RAM. La aplicaci\u00f3n debe guardar los datos en una base de datos Alfresco Community Edition","title":"Realizaci\u00f3n"},{"location":"practica-cms-java/#parte-1_1","text":"Prerequisitos end","title":"Parte 1"},{"location":"practica-cms-python/","text":"Pr\u00e1ctica: Instalaci\u00f3n de un CMS python Apartado 1 Instalar Django Fiber en desarrollo, utilizando un entorno virtual Escenario: Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :practicacmspython do |practicacmspython| practicacmspython.vm.box = \"rockylinux/8\" practicacmspython.vm.hostname = \"practicacmspython\" end end Creo entorno virtual: mkdir venv cd venv sudo dnf install virtualenv python3 -m venv . source bin/activate Descargo el proyecto: sudo dnf install git git clone https://github.com/django-fiber/django-fiber.git Instalo paquetes necesarios: sudo dnf groupinstall 'Development Tools' pip install --upgrade pip pip install -r requirements.txt pip install django-fiber Modifico settings.py : ALLOWED_HOSTS = ['192.168.121.54'] Creo las tablas: python3 manage.py migrate Creo el usuario admin: python3 manage.py createsuperuser Username (leave blank to use 'vagrant'): admin Email address: Password: Password (again): Superuser created successfully. Username : admin Password : 123admin456 Ejecuto el server web de desarrollo: python3 manage.py runserver 0.0.0.0:8000 Pruebo que funciona: Apartado 2 Personalizar la p\u00e1gina Para ello es necesario acceder a /admin . Principal: Art\u00edculo 1: Apartado 3 Volcar la base de datos python manage.py dumpdata --exclude auth.permission --exclude contenttypes > db.json Guardar la aplicaci\u00f3n en repositorio Lo creo: https://github.com/adriasir123/django-fiber Modifico .gitignore : *.pyc /build/ /dist/ /testproject/reports/ #/testproject/static/ django_fiber.egg-info .tox testproject/fiber_test/__pycache__ testproject/testproject/__pycache__ Subo cambios al repo: git remote remove origin git branch -M main git add . git config --global user.email \"adristudy@gmail.com\" git config --global user.name \"Adri\u00e1n Jaramillo\" git commit -m \"Initial commit\" git push --set-upstream origin master Apartado 4 Desplegar la app en hera con Utiliza uWSGI, y la BD en ares. . El contenido est\u00e1tico debe servirlo el servidor web. La aplicaci\u00f3n ser\u00e1 accesible en la url python.adrianj.gonzalonazareno.org. Clonar repositorio: sudo dnf install git git clone https://github.com/adriasir123/django-fiber.git Creo entorno virtual: mkdir venv cd venv sudo dnf install virtualenv python3 -m venv . source bin/activate Instalo paquetes necesarios: sudo dnf groupinstall 'Development Tools' pip install --upgrade pip pip install -r requirements.txt pip install django-fiber Instalar m\u00f3dulo para que python se pueda comunicar con MariaDB: sudo dnf install python3-devel mysql-devel pip install mysqlclient Crear BD: CREATE DATABASE `django_fiber_db`; Crear usuario con permisos sobre django_fiber_db : CREATE USER 'django_fiber_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'django_fiber_user'@'%' IDENTIFIED BY '1234'; GRANT ALL privileges ON `django_fiber_db`.* TO 'django_fiber_user'@'%'; FLUSH PRIVILEGES; Modificar la conexi\u00f3n a la BD en settings.py : DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'django_fiber_db', 'USER': 'django_fiber_user', 'PASSWORD': '1234', 'HOST': 'bd.adrianj.gonzalonazareno.org', 'PORT': '', } } Crear tablas en MariaDB: python3 manage.py migrate Recuperar de datos: python3 manage.py loaddata db.json Instalar uwsgi pip install uwsgi Creo /var/www/django-fiber/testproject/django-fiber.ini : [uwsgi] http = :8080 chdir = /var/www/django-fiber/testproject wsgi-file = /var/www/django-fiber/testproject/testproject/wsgi.py processes = 4 threads = 2 Crear unidad systemd, /etc/systemd/system/uwsgi-django-fiber.service : [Unit] Description=uwsgi-django-fiber After=network.target [Install] WantedBy=multi-user.target [Service] User=root Group=root Restart=always ExecStart=/home/vagrant/venv/bin/uwsgi /var/www/django-fiber/testproject/django-fiber.ini ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/var/www/django-fiber/testproject Environment=PYTHONPATH='/var/www/django-fiber/testproject:/home/vagrant/venv/lib/python3.6/site-packages' PrivateTmp=true Cambio permisos: sudo chown -R apache:apache /home/vagrant/django-fiber/ sudo chown -R apache:apache /home/vagrant/venv sudo chmod 777 django-fiber.ini Deshabilitar selinux: sudo setenforce 0 La activo e inicio: sudo systemctl enable uwsgi-django-fiber.service sudo systemctl start uwsgi-django-fiber.service Apache + uWSGI python manage.py collectstatic --link Creo /etc/httpd/conf.d/python.conf : <VirtualHost *:80> ServerName python.adrianj.gonzalonazareno.org DocumentRoot /var/www/django-fiber/testproject <Directory /var/www/django-fiber/testproject> Require all granted Options +FollowSymLinks </Directory> ProxyPass /static/ ! ProxyPass / http://127.0.0.1:8080/ ProxyPassReverse / http://127.0.0.1:8080/ </VirtualHost> Mover la app: sudo mv django-fiber/ /var/www/ Permisos: sudo chown -R root:root /var/www/django-fiber/ Reinicio Apache: sudo systemctl restart httpd Nuevos registro DNS A\u00f1ado a db.externa.adrianj.gonzalonazareno.org : python IN CNAME zeus A\u00f1ado a db.dmz.adrianj.gonzalonazareno.org : python IN CNAME hera A\u00f1ado a db.interna.adrianj.gonzalonazareno.org : python IN CNAME hera Reiniciar bind9: sudo systemctl restart bind9 Modifico puntos de entrada ALLOWED_HOSTS = ['python.adrianj.gonzalonazareno.org','127.0.0.1'] Reinicio uwsgi: sudo systemctl restart uwsgi-django-fiber.service","title":"Pr\u00e1ctica: CMS python"},{"location":"practica-cms-python/#practica-instalacion-de-un-cms-python","text":"","title":"Pr\u00e1ctica: Instalaci\u00f3n de un CMS python"},{"location":"practica-cms-python/#apartado-1","text":"Instalar Django Fiber en desarrollo, utilizando un entorno virtual Escenario: Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :practicacmspython do |practicacmspython| practicacmspython.vm.box = \"rockylinux/8\" practicacmspython.vm.hostname = \"practicacmspython\" end end Creo entorno virtual: mkdir venv cd venv sudo dnf install virtualenv python3 -m venv . source bin/activate Descargo el proyecto: sudo dnf install git git clone https://github.com/django-fiber/django-fiber.git Instalo paquetes necesarios: sudo dnf groupinstall 'Development Tools' pip install --upgrade pip pip install -r requirements.txt pip install django-fiber Modifico settings.py : ALLOWED_HOSTS = ['192.168.121.54'] Creo las tablas: python3 manage.py migrate Creo el usuario admin: python3 manage.py createsuperuser Username (leave blank to use 'vagrant'): admin Email address: Password: Password (again): Superuser created successfully. Username : admin Password : 123admin456 Ejecuto el server web de desarrollo: python3 manage.py runserver 0.0.0.0:8000 Pruebo que funciona:","title":"Apartado 1"},{"location":"practica-cms-python/#apartado-2","text":"Personalizar la p\u00e1gina Para ello es necesario acceder a /admin . Principal: Art\u00edculo 1:","title":"Apartado 2"},{"location":"practica-cms-python/#apartado-3","text":"Volcar la base de datos python manage.py dumpdata --exclude auth.permission --exclude contenttypes > db.json Guardar la aplicaci\u00f3n en repositorio Lo creo: https://github.com/adriasir123/django-fiber Modifico .gitignore : *.pyc /build/ /dist/ /testproject/reports/ #/testproject/static/ django_fiber.egg-info .tox testproject/fiber_test/__pycache__ testproject/testproject/__pycache__ Subo cambios al repo: git remote remove origin git branch -M main git add . git config --global user.email \"adristudy@gmail.com\" git config --global user.name \"Adri\u00e1n Jaramillo\" git commit -m \"Initial commit\" git push --set-upstream origin master","title":"Apartado 3"},{"location":"practica-cms-python/#apartado-4","text":"Desplegar la app en hera con Utiliza uWSGI, y la BD en ares. . El contenido est\u00e1tico debe servirlo el servidor web. La aplicaci\u00f3n ser\u00e1 accesible en la url python.adrianj.gonzalonazareno.org. Clonar repositorio: sudo dnf install git git clone https://github.com/adriasir123/django-fiber.git Creo entorno virtual: mkdir venv cd venv sudo dnf install virtualenv python3 -m venv . source bin/activate Instalo paquetes necesarios: sudo dnf groupinstall 'Development Tools' pip install --upgrade pip pip install -r requirements.txt pip install django-fiber Instalar m\u00f3dulo para que python se pueda comunicar con MariaDB: sudo dnf install python3-devel mysql-devel pip install mysqlclient Crear BD: CREATE DATABASE `django_fiber_db`; Crear usuario con permisos sobre django_fiber_db : CREATE USER 'django_fiber_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'django_fiber_user'@'%' IDENTIFIED BY '1234'; GRANT ALL privileges ON `django_fiber_db`.* TO 'django_fiber_user'@'%'; FLUSH PRIVILEGES; Modificar la conexi\u00f3n a la BD en settings.py : DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'django_fiber_db', 'USER': 'django_fiber_user', 'PASSWORD': '1234', 'HOST': 'bd.adrianj.gonzalonazareno.org', 'PORT': '', } } Crear tablas en MariaDB: python3 manage.py migrate Recuperar de datos: python3 manage.py loaddata db.json Instalar uwsgi pip install uwsgi Creo /var/www/django-fiber/testproject/django-fiber.ini : [uwsgi] http = :8080 chdir = /var/www/django-fiber/testproject wsgi-file = /var/www/django-fiber/testproject/testproject/wsgi.py processes = 4 threads = 2 Crear unidad systemd, /etc/systemd/system/uwsgi-django-fiber.service : [Unit] Description=uwsgi-django-fiber After=network.target [Install] WantedBy=multi-user.target [Service] User=root Group=root Restart=always ExecStart=/home/vagrant/venv/bin/uwsgi /var/www/django-fiber/testproject/django-fiber.ini ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/var/www/django-fiber/testproject Environment=PYTHONPATH='/var/www/django-fiber/testproject:/home/vagrant/venv/lib/python3.6/site-packages' PrivateTmp=true Cambio permisos: sudo chown -R apache:apache /home/vagrant/django-fiber/ sudo chown -R apache:apache /home/vagrant/venv sudo chmod 777 django-fiber.ini Deshabilitar selinux: sudo setenforce 0 La activo e inicio: sudo systemctl enable uwsgi-django-fiber.service sudo systemctl start uwsgi-django-fiber.service","title":"Apartado 4"},{"location":"practica-cms-python/#apache-uwsgi","text":"python manage.py collectstatic --link Creo /etc/httpd/conf.d/python.conf : <VirtualHost *:80> ServerName python.adrianj.gonzalonazareno.org DocumentRoot /var/www/django-fiber/testproject <Directory /var/www/django-fiber/testproject> Require all granted Options +FollowSymLinks </Directory> ProxyPass /static/ ! ProxyPass / http://127.0.0.1:8080/ ProxyPassReverse / http://127.0.0.1:8080/ </VirtualHost> Mover la app: sudo mv django-fiber/ /var/www/ Permisos: sudo chown -R root:root /var/www/django-fiber/ Reinicio Apache: sudo systemctl restart httpd","title":"Apache + uWSGI"},{"location":"practica-cms-python/#nuevos-registro-dns","text":"A\u00f1ado a db.externa.adrianj.gonzalonazareno.org : python IN CNAME zeus A\u00f1ado a db.dmz.adrianj.gonzalonazareno.org : python IN CNAME hera A\u00f1ado a db.interna.adrianj.gonzalonazareno.org : python IN CNAME hera Reiniciar bind9: sudo systemctl restart bind9","title":"Nuevos registro DNS"},{"location":"practica-cms-python/#modifico-puntos-de-entrada","text":"ALLOWED_HOSTS = ['python.adrianj.gonzalonazareno.org','127.0.0.1'] Reinicio uwsgi: sudo systemctl restart uwsgi-django-fiber.service","title":"Modifico puntos de entrada"},{"location":"practica-despliegue-apps-python/","text":"Pr\u00e1ctica: Despliegue de aplicaciones python En esta pr\u00e1ctica se usa la aplicaci\u00f3n Django tutorial . Tarea 1: Entorno de desarrollo Parte 0 Crear escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :desplieguepython do |desplieguepython| desplieguepython.vm.box = \"debian/bullseye64\" desplieguepython.vm.hostname = \"desplieguepython\" end end Parte 1 Hacer fork de https://github.com/josedom24/django_tutorial Clonar repo git clone git@github.com:adriasir123/django_tutorial.git Parte 2 Crear entorno virtual mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source ~/venv/bin/activate Instalar dependencias pip install -r requirements.txt Parte 3 Comprobar que se usa SQLite. \u00bfQu\u00e9 fichero la define? settings.py , en el siguiente bloque: DATABASES = { 'default': { 'ENGINE': 'django.db.backends.sqlite3', 'NAME': BASE_DIR / 'db.sqlite3', } } \u00bfNombre de la BD que se crear\u00e1? db.sqlite3 Parte 4 Crear tablas en SQLite python3 manage.py migrate Parte 5 Crear usuario admin python3 manage.py createsuperuser Username (leave blank to use 'vagrant'): admin Email address: Password: Password (again): Superuser created successfully. Username : admin Password : 123admin456 Parte 6 Habilitar acceso a la app settings.py : ALLOWED_HOSTS = ['192.168.121.102'] (Direcci\u00f3n de destino a habilitar) Ejecutar servidor web desarrollo python3 manage.py runserver 0.0.0.0:8000 Index: /admin: Comprobar que el usuario admin se ha a\u00f1adido correctamente: Parte 7 Crear dos preguntas con respuestas Pregunta 1: Pregunta 2: Parte 8 Comprobar que la URL /polls funciona /polls: Poll 1: Poll 2: Tarea 2: Entorno de producci\u00f3n (VPS) Parte 1 Clonar repositorio en VPS git clone https://github.com/adriasir123/django_tutorial.git Parte 2 Crear entorno virtual mkdir venv cd venv sudo apt install python3-venv python3 -m venv . source bin/activate Instalar dependencias pip install -r requirements.txt Parte 3 Instalar m\u00f3dulo para que python se pueda comunicar con MariaDB sudo apt install python3-dev default-libmysqlclient-dev build-essential pip install mysqlclient Parte 4 Crear BD CREATE DATABASE `django_tutorial_db`; Crear usuario con permisos sobre django_tutorial_db CREATE USER 'django_tutorial_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'django_tutorial_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `django_tutorial_db`.* TO 'django_tutorial_user'@localhost; FLUSH PRIVILEGES; Parte 5 Modificar la conexi\u00f3n a la BD en settings.py DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'django_tutorial_db', 'USER': 'django_tutorial_user', 'PASSWORD': '1234', 'HOST': 'localhost', 'PORT': '', } } Parte 6 Crear tablas en MariaDB python3 manage.py migrate Comprobar que se han creado MariaDB [django_tutorial_db]> show tables; +------------------------------+ | Tables_in_django_tutorial_db | +------------------------------+ | auth_group | | auth_group_permissions | | auth_permission | | auth_user | | auth_user_groups | | auth_user_user_permissions | | django_admin_log | | django_content_type | | django_migrations | | django_session | | polls_choice | | polls_question | +------------------------------+ 12 rows in set (0.001 sec) Volcado de datos en desarrollo python3 manage.py dumpdata > db.json Volcado de datos en VPS: python3 manage.py loaddata db.json Parte 7 Instalar y configurar Gunicorn para ejecutar Django. Luego, configurar Nginx como proxy inverso para servir django_tutorial Instalar Gunicorn pip install gunicorn Crear unidad systemd /etc/systemd/system/gunicorn-django-tutorial.service : [Unit] Description=gunicorn-django-tutorial After=network.target [Install] WantedBy=multi-user.target [Service] User=www-data Group=www-data Restart=always ExecStart=/home/blackmamba/venv/bin/gunicorn -w 2 -b :8080 django_tutorial.wsgi ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/home/blackmamba/django_tutorial Environment=PYTHONPATH='/home/blackmamba/django_tutorial:/home/blackmamba/venv/lib/python3.9/site-packages' PrivateTmp=true La activo e inicio: sudo systemctl enable gunicorn-django-tutorial.service sudo systemctl start gunicorn-django-tutorial.service Nginx + Gunicorn Creo /etc/nginx/sites-available/django.conf : server { listen 80; server_name django.adrianjaramillo.tk; root /home/blackmamba/django_tutorial; location / { proxy_pass http://localhost:8080; include proxy_params; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/django.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx A\u00f1adir nuevo registro DNS Modificar settings.py ALLOWED_HOSTS = ['django.adrianjaramillo.tk'] Reinicio: sudo systemctl restart gunicorn-django-tutorial.service Pruebo que funciona: Parte 8 \u00bfFunciona el css de polls? Arr\u00e9glalo. /etc/nginx/sites-available/django.conf : location /static/polls { alias /home/blackmamba/django_tutorial/polls/static/polls; } Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona: \u00bfFunciona el css de admin? Arr\u00e9glalo. /etc/nginx/sites-available/django.conf : location /static/admin { alias /home/blackmamba/venv/lib/python3.9/site-packages/django/contrib/admin/static/admin/; } Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona: Parte 9 Desactivar debug settings.py : DEBUG = False Reinicio: sudo systemctl restart gunicorn-django-tutorial.service Pruebo que funciona: Si DEBUG fuese True, al escribir esa URL que no existe, me habr\u00eda aparecido mucha m\u00e1s informaci\u00f3n: (DEBUG = True) Parte 10 Mostrar la p\u00e1gina funcionando Tarea 3: Modificaci\u00f3n de nuestra aplicaci\u00f3n En esta secci\u00f3n primero se cambia en desarrollo, y luego se pasa a producci\u00f3n. Parte 0 A\u00f1adir settings.py a .gitignore django_tutorial/settings.py \u00a1Esta acci\u00f3n es importante! El fichero cambia MUCHO con respecto a desarrollo/producci\u00f3n (DEBUG, ALLOWED_HOSTS, DATABASES) . Parte 1 Modificar django_tutorial/polls/templates/polls/index.html con tu nombre {% load static %} <link rel=\"stylesheet\" type=\"text/css\" href=\"{% static 'polls/style.css' %}\"> {% if latest_question_list %} <ul> {% for question in latest_question_list %} <li><a href=\"{% url 'polls:detail' question.id %}\">{{ question.question_text }}</a></li> {% endfor %} </ul> {% else %} <p>No polls are available.</p> {% endif %} <h2>Adri\u00e1n Jaramillo Rodr\u00edguez</h2> Prueba en desarrollo: Subir cambios desde desarrollo: git commit -am \"mi nombre polls index.html\" git push Bajar cambios en producci\u00f3n: git pull Reinicio gunicorn para que actualice la configuraci\u00f3n: sudo systemctl restart gunicorn-django-tutorial.service Prueba en producci\u00f3n: Parte 2 Modificar la imagen de fondo en la p\u00e1gina principal En /home/vagrant/django_tutorial/polls/templates/index.html ... A\u00f1adir en el head: <style> body { background-image: url('https://w.wallhaven.cc/full/lm/wallhaven-lm12ey.jpg'); } </style> Comentar en el body: <!-- <div id=\"stripes\"> <span></span> <span></span> <span></span> <span></span> <span></span> </div> --> Prueba en desarrollo: Subir cambios desde desarrollo: git commit -am \"fondo cambiado en index.html\" git push Bajar cambios en producci\u00f3n: git pull Reinicio gunicorn para que actualice la configuraci\u00f3n: sudo systemctl restart gunicorn-django-tutorial.service Prueba en producci\u00f3n: Parte 3 Crear una nueva tabla en la base de datos A\u00f1adir a django_tutorial/polls/models.py : class Categoria(models.Model): Abr = models.CharField(max_length=4) Nombre = models.CharField(max_length=50) def __str__(self): return self.Abr+\" - \"+self.Nombre Aplicar cambios: python manage.py makemigrations python manage.py migrate Modificar la siguiente l\u00ednea en django_tutorial/polls/admin.py ... from .models import Choice, Question, Categoria ...y a\u00f1adir esta otra: admin.site.register(Categoria) Prueba en desarrollo: (la tabla categor\u00edas se ha creado, y he rellenado datos) Vuelco los nuevos datos en desarrollo: python3 manage.py dumpdata > db2.json Subir cambios desde desarrollo: git add . git commit -am \"nueva tabla\" git push Bajar cambios en producci\u00f3n: git pull Creo la tabla: python manage.py migrate Cargo los datos: python3 manage.py loaddata db2.json Reinicio gunicorn para que actualice la configuraci\u00f3n: sudo systemctl restart gunicorn-django-tutorial.service Prueba en producci\u00f3n:","title":"Pr\u00e1ctica: Despliegue python"},{"location":"practica-despliegue-apps-python/#practica-despliegue-de-aplicaciones-python","text":"En esta pr\u00e1ctica se usa la aplicaci\u00f3n Django tutorial .","title":"Pr\u00e1ctica: Despliegue de aplicaciones python"},{"location":"practica-despliegue-apps-python/#tarea-1-entorno-de-desarrollo","text":"","title":"Tarea 1: Entorno de desarrollo"},{"location":"practica-despliegue-apps-python/#parte-0","text":"Crear escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :desplieguepython do |desplieguepython| desplieguepython.vm.box = \"debian/bullseye64\" desplieguepython.vm.hostname = \"desplieguepython\" end end","title":"Parte 0"},{"location":"practica-despliegue-apps-python/#parte-1","text":"Hacer fork de https://github.com/josedom24/django_tutorial Clonar repo git clone git@github.com:adriasir123/django_tutorial.git","title":"Parte 1"},{"location":"practica-despliegue-apps-python/#parte-2","text":"Crear entorno virtual mkdir venv cd venv sudo apt update sudo apt install python3-venv python3 -m venv . source ~/venv/bin/activate Instalar dependencias pip install -r requirements.txt","title":"Parte 2"},{"location":"practica-despliegue-apps-python/#parte-3","text":"Comprobar que se usa SQLite. \u00bfQu\u00e9 fichero la define? settings.py , en el siguiente bloque: DATABASES = { 'default': { 'ENGINE': 'django.db.backends.sqlite3', 'NAME': BASE_DIR / 'db.sqlite3', } } \u00bfNombre de la BD que se crear\u00e1? db.sqlite3","title":"Parte 3"},{"location":"practica-despliegue-apps-python/#parte-4","text":"Crear tablas en SQLite python3 manage.py migrate","title":"Parte 4"},{"location":"practica-despliegue-apps-python/#parte-5","text":"Crear usuario admin python3 manage.py createsuperuser Username (leave blank to use 'vagrant'): admin Email address: Password: Password (again): Superuser created successfully. Username : admin Password : 123admin456","title":"Parte 5"},{"location":"practica-despliegue-apps-python/#parte-6","text":"Habilitar acceso a la app settings.py : ALLOWED_HOSTS = ['192.168.121.102'] (Direcci\u00f3n de destino a habilitar) Ejecutar servidor web desarrollo python3 manage.py runserver 0.0.0.0:8000 Index: /admin: Comprobar que el usuario admin se ha a\u00f1adido correctamente:","title":"Parte 6"},{"location":"practica-despliegue-apps-python/#parte-7","text":"Crear dos preguntas con respuestas Pregunta 1: Pregunta 2:","title":"Parte 7"},{"location":"practica-despliegue-apps-python/#parte-8","text":"Comprobar que la URL /polls funciona /polls: Poll 1: Poll 2:","title":"Parte 8"},{"location":"practica-despliegue-apps-python/#tarea-2-entorno-de-produccion-vps","text":"","title":"Tarea 2: Entorno de producci\u00f3n (VPS)"},{"location":"practica-despliegue-apps-python/#parte-1_1","text":"Clonar repositorio en VPS git clone https://github.com/adriasir123/django_tutorial.git","title":"Parte 1"},{"location":"practica-despliegue-apps-python/#parte-2_1","text":"Crear entorno virtual mkdir venv cd venv sudo apt install python3-venv python3 -m venv . source bin/activate Instalar dependencias pip install -r requirements.txt","title":"Parte 2"},{"location":"practica-despliegue-apps-python/#parte-3_1","text":"Instalar m\u00f3dulo para que python se pueda comunicar con MariaDB sudo apt install python3-dev default-libmysqlclient-dev build-essential pip install mysqlclient","title":"Parte 3"},{"location":"practica-despliegue-apps-python/#parte-4_1","text":"Crear BD CREATE DATABASE `django_tutorial_db`; Crear usuario con permisos sobre django_tutorial_db CREATE USER 'django_tutorial_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'django_tutorial_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `django_tutorial_db`.* TO 'django_tutorial_user'@localhost; FLUSH PRIVILEGES;","title":"Parte 4"},{"location":"practica-despliegue-apps-python/#parte-5_1","text":"Modificar la conexi\u00f3n a la BD en settings.py DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'django_tutorial_db', 'USER': 'django_tutorial_user', 'PASSWORD': '1234', 'HOST': 'localhost', 'PORT': '', } }","title":"Parte 5"},{"location":"practica-despliegue-apps-python/#parte-6_1","text":"Crear tablas en MariaDB python3 manage.py migrate Comprobar que se han creado MariaDB [django_tutorial_db]> show tables; +------------------------------+ | Tables_in_django_tutorial_db | +------------------------------+ | auth_group | | auth_group_permissions | | auth_permission | | auth_user | | auth_user_groups | | auth_user_user_permissions | | django_admin_log | | django_content_type | | django_migrations | | django_session | | polls_choice | | polls_question | +------------------------------+ 12 rows in set (0.001 sec) Volcado de datos en desarrollo python3 manage.py dumpdata > db.json Volcado de datos en VPS: python3 manage.py loaddata db.json","title":"Parte 6"},{"location":"practica-despliegue-apps-python/#parte-7_1","text":"Instalar y configurar Gunicorn para ejecutar Django. Luego, configurar Nginx como proxy inverso para servir django_tutorial","title":"Parte 7"},{"location":"practica-despliegue-apps-python/#instalar-gunicorn","text":"pip install gunicorn","title":"Instalar Gunicorn"},{"location":"practica-despliegue-apps-python/#crear-unidad-systemd","text":"/etc/systemd/system/gunicorn-django-tutorial.service : [Unit] Description=gunicorn-django-tutorial After=network.target [Install] WantedBy=multi-user.target [Service] User=www-data Group=www-data Restart=always ExecStart=/home/blackmamba/venv/bin/gunicorn -w 2 -b :8080 django_tutorial.wsgi ExecReload=/bin/kill -s HUP $MAINPID ExecStop=/bin/kill -s TERM $MAINPID WorkingDirectory=/home/blackmamba/django_tutorial Environment=PYTHONPATH='/home/blackmamba/django_tutorial:/home/blackmamba/venv/lib/python3.9/site-packages' PrivateTmp=true La activo e inicio: sudo systemctl enable gunicorn-django-tutorial.service sudo systemctl start gunicorn-django-tutorial.service","title":"Crear unidad systemd"},{"location":"practica-despliegue-apps-python/#nginx-gunicorn","text":"Creo /etc/nginx/sites-available/django.conf : server { listen 80; server_name django.adrianjaramillo.tk; root /home/blackmamba/django_tutorial; location / { proxy_pass http://localhost:8080; include proxy_params; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/django.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx","title":"Nginx + Gunicorn"},{"location":"practica-despliegue-apps-python/#anadir-nuevo-registro-dns","text":"","title":"A\u00f1adir nuevo registro DNS"},{"location":"practica-despliegue-apps-python/#modificar-settingspy","text":"ALLOWED_HOSTS = ['django.adrianjaramillo.tk'] Reinicio: sudo systemctl restart gunicorn-django-tutorial.service Pruebo que funciona:","title":"Modificar settings.py"},{"location":"practica-despliegue-apps-python/#parte-8_1","text":"\u00bfFunciona el css de polls? Arr\u00e9glalo. /etc/nginx/sites-available/django.conf : location /static/polls { alias /home/blackmamba/django_tutorial/polls/static/polls; } Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona: \u00bfFunciona el css de admin? Arr\u00e9glalo. /etc/nginx/sites-available/django.conf : location /static/admin { alias /home/blackmamba/venv/lib/python3.9/site-packages/django/contrib/admin/static/admin/; } Reinicio Nginx: sudo systemctl restart nginx Pruebo que funciona:","title":"Parte 8"},{"location":"practica-despliegue-apps-python/#parte-9","text":"Desactivar debug settings.py : DEBUG = False Reinicio: sudo systemctl restart gunicorn-django-tutorial.service Pruebo que funciona: Si DEBUG fuese True, al escribir esa URL que no existe, me habr\u00eda aparecido mucha m\u00e1s informaci\u00f3n: (DEBUG = True)","title":"Parte 9"},{"location":"practica-despliegue-apps-python/#parte-10","text":"Mostrar la p\u00e1gina funcionando","title":"Parte 10"},{"location":"practica-despliegue-apps-python/#tarea-3-modificacion-de-nuestra-aplicacion","text":"En esta secci\u00f3n primero se cambia en desarrollo, y luego se pasa a producci\u00f3n.","title":"Tarea 3: Modificaci\u00f3n de nuestra aplicaci\u00f3n"},{"location":"practica-despliegue-apps-python/#parte-0_1","text":"A\u00f1adir settings.py a .gitignore django_tutorial/settings.py \u00a1Esta acci\u00f3n es importante! El fichero cambia MUCHO con respecto a desarrollo/producci\u00f3n (DEBUG, ALLOWED_HOSTS, DATABASES) .","title":"Parte 0"},{"location":"practica-despliegue-apps-python/#parte-1_2","text":"Modificar django_tutorial/polls/templates/polls/index.html con tu nombre {% load static %} <link rel=\"stylesheet\" type=\"text/css\" href=\"{% static 'polls/style.css' %}\"> {% if latest_question_list %} <ul> {% for question in latest_question_list %} <li><a href=\"{% url 'polls:detail' question.id %}\">{{ question.question_text }}</a></li> {% endfor %} </ul> {% else %} <p>No polls are available.</p> {% endif %} <h2>Adri\u00e1n Jaramillo Rodr\u00edguez</h2> Prueba en desarrollo: Subir cambios desde desarrollo: git commit -am \"mi nombre polls index.html\" git push Bajar cambios en producci\u00f3n: git pull Reinicio gunicorn para que actualice la configuraci\u00f3n: sudo systemctl restart gunicorn-django-tutorial.service Prueba en producci\u00f3n:","title":"Parte 1"},{"location":"practica-despliegue-apps-python/#parte-2_2","text":"Modificar la imagen de fondo en la p\u00e1gina principal En /home/vagrant/django_tutorial/polls/templates/index.html ... A\u00f1adir en el head: <style> body { background-image: url('https://w.wallhaven.cc/full/lm/wallhaven-lm12ey.jpg'); } </style> Comentar en el body: <!-- <div id=\"stripes\"> <span></span> <span></span> <span></span> <span></span> <span></span> </div> --> Prueba en desarrollo: Subir cambios desde desarrollo: git commit -am \"fondo cambiado en index.html\" git push Bajar cambios en producci\u00f3n: git pull Reinicio gunicorn para que actualice la configuraci\u00f3n: sudo systemctl restart gunicorn-django-tutorial.service Prueba en producci\u00f3n:","title":"Parte 2"},{"location":"practica-despliegue-apps-python/#parte-3_2","text":"Crear una nueva tabla en la base de datos A\u00f1adir a django_tutorial/polls/models.py : class Categoria(models.Model): Abr = models.CharField(max_length=4) Nombre = models.CharField(max_length=50) def __str__(self): return self.Abr+\" - \"+self.Nombre Aplicar cambios: python manage.py makemigrations python manage.py migrate Modificar la siguiente l\u00ednea en django_tutorial/polls/admin.py ... from .models import Choice, Question, Categoria ...y a\u00f1adir esta otra: admin.site.register(Categoria) Prueba en desarrollo: (la tabla categor\u00edas se ha creado, y he rellenado datos) Vuelco los nuevos datos en desarrollo: python3 manage.py dumpdata > db2.json Subir cambios desde desarrollo: git add . git commit -am \"nueva tabla\" git push Bajar cambios en producci\u00f3n: git pull Creo la tabla: python manage.py migrate Cargo los datos: python3 manage.py loaddata db2.json Reinicio gunicorn para que actualice la configuraci\u00f3n: sudo systemctl restart gunicorn-django-tutorial.service Prueba en producci\u00f3n:","title":"Parte 3"},{"location":"practica-escenario-libvirt/","text":"Pr\u00e1ctica: Instalaci\u00f3n y configuraci\u00f3n inicial de los servidores Vagrant Libvirt Entrega Parte 1 IP \"p\u00fablica\" de zeus 172.22.0.213 Parte 2 Actualizar esta entrada en la wiki de Redmine con informaci\u00f3n sobre el escenario Hecho. Realizaci\u00f3n Escenario de trabajo a usar durante el curso: Ejercicio 1 Crear escenario Vagrant Requisitos: vagrant box add rockylinux/8 vagrant box add generic/ubuntu2004 (libvirt) Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :zeus do |zeus| zeus.vm.box = \"debian/bullseye64\" zeus.vm.hostname = \"zeus\" zeus.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" zeus.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.1\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" zeus.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :hera do |hera| hera.vm.box = \"rockylinux/8\" hera.vm.hostname = \"hera\" hera.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.200\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :apolo do |apolo| apolo.vm.box = \"debian/bullseye64\" apolo.vm.hostname = \"apolo\" apolo.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.102\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :ares do |ares| ares.vm.box = \"generic/ubuntu2004\" ares.vm.hostname = \"ares\" ares.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.101\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end Ejercicio 2 Actualizar paqueter\u00eda en todos los servidores En zeus, apolo y ares: sudo apt update sudo apt upgrade En hera: sudo dnf check-update sudo dnf update Ejercicio 3 Contrase\u00f1a en todos los servidores (para poder modificar desde consola en caso necesario) En zeus, apolo, ares y hera: sudo passwd vagrant Contrase\u00f1a: 1234 Ejercicio 4 Crear usuario profesor en todos los servidores. Usa sudo sin contrase\u00f1a. En zeus, apolo y ares sudo adduser profesor sudo usermod -aG sudo profesor Contrase\u00f1a: 1234 /etc/sudoers : # Mis cambios profesor ALL=(ALL) NOPASSWD:ALL (al final del fichero) En hera sudo adduser profesor sudo passwd profesor sudo usermod -aG wheel profesor Contrase\u00f1a: 1234 /etc/sudoers : # Mis cambios profesor ALL=(ALL) NOPASSWD:ALL (al final del fichero) Ejercicio 5 Copiar clave p\u00fablica ssh de josedom en los servidores al usuario profesor En zeus, apolo y ares mkdir .ssh touch .ssh/authorized_keys Copio la clave: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCmjoVIoZCx4QFXvljqozXGqxxlSvO7V2aizqyPgMfGqnyl0J9YXo6zrcWYwyWMnMdRdwYZgHqfiiFCUn2QDm6ZuzC4Lcx0K3ZwO2lgL4XaATykVLneHR1ib6RNroFcClN69cxWsdwQW6dpjpiBDXf8m6/qxVP3EHwUTsP8XaOV7WkcCAqfYAMvpWLISqYme6e+6ZGJUIPkDTxavu5JTagDLwY+py1WB53eoDWsG99gmvyit2O1Eo+jRWN+mgRHIxJTrFtLS6o4iWeshPZ6LvCZ/Pum12Oj4B4bjGSHzrKjHZgTwhVJ/LDq3v71/PP4zaI3gVB9ZalemSxqomgbTlnT jose@debian En hera Lo mismo que arriba, a diferencia de hacer: chmod -R go= ~/.ssh Ejercicio 6 Definir nombre largo y corto en todos los servidores, con el dominio adrianj.gonzalonazareno.org En zeus /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 zeus.adrianj.gonzalonazareno.org zeus Compruebo nombre largo: vagrant@zeus:~$ hostname -f zeus.adrianj.gonzalonazareno.org Compruebo nombre corto: vagrant@zeus:~$ ping zeus -c 1 PING zeus.adrianj.gonzalonazareno.org (127.0.1.1) 56(84) bytes of data. 64 bytes from zeus.adrianj.gonzalonazareno.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.077 ms --- zeus.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.077/0.077/0.077/0.000 ms En apolo /etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 apolo.adrianj.gonzalonazareno.org apolo Compruebo nombre largo: vagrant@apolo:~$ hostname -f apolo.adrianj.gonzalonazareno.org Compruebo nombre corto: vagrant@apolo:~$ ping apolo -c 1 PING apolo.adrianj.gonzalonazareno.org (127.0.1.1) 56(84) bytes of data. 64 bytes from apolo.adrianj.gonzalonazareno.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.070 ms --- apolo.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.070/0.070/0.070/0.000 ms En ares /etc/hosts : 127.0.0.1 localhost 127.0.1.1 ubuntu2004.localdomain # The following lines are desirable for IPv6 capable hosts ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.0.1 ubuntu2004.localdomain 127.0.2.1 ares.adrianj.gonzalonazareno.org ares Compruebo nombre largo: vagrant@ares:~$ hostname -f ares.adrianj.gonzalonazareno.org Compruebo nombre corto: vagrant@ares:~$ ping ares -c 1 PING ares.adrianj.gonzalonazareno.org (127.0.2.1) 56(84) bytes of data. 64 bytes from ares.adrianj.gonzalonazareno.org (127.0.2.1): icmp_seq=1 ttl=64 time=0.136 ms --- ares.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.136/0.136/0.136/0.000 ms En hera /etc/hosts : 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 127.0.1.1 hera.adrianj.gonzalonazareno.org hera Compruebo nombre largo: [vagrant@hera ~]$ hostname -f hera.adrianj.gonzalonazareno.org Compruebo nombre corto: [vagrant@hera ~]$ ping hera -c 1 PING hera.adrianj.gonzalonazareno.org (127.0.1.1) 56(84) bytes of data. 64 bytes from hera.adrianj.gonzalonazareno.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.071 ms --- hera.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.071/0.071/0.071/0.000 ms Ejercicio 7 Instalar bind9 en apolo sudo apt install bind9 Ejercicio 8 SNAT en zeus + puerta de enlace sudo modprobe iptable_nat echo iptable_nat >> /etc/modules echo 1 > /proc/sys/net/ipv4/ip_forward sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE sudo apt install iptables-persistent sudo ip route del default sudo ip route add default via 172.22.0.1 En /etc/sysctl.conf descomentar: net.ipv4.ip_forward=1 /etc/network/interfaces : # interfaces(5) file used by ifup(8) and ifdown(8) # Include files from /etc/network/interfaces.d: source-directory /etc/network/interfaces.d # The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth1 iface eth1 inet dhcp post-up ip route add default via 172.22.0.1 #VAGRANT-END #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth2 iface eth2 inet static address 172.16.0.1 netmask 255.255.0.0 #VAGRANT-END #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth3 iface eth3 inet static address 10.0.1.1 netmask 255.255.255.0 #VAGRANT-END Puerta de enlace apolo sudo ip route del default sudo ip route add default via 10.0.1.1 /etc/network/interfaces : # interfaces(5) file used by ifup(8) and ifdown(8) # Include files from /etc/network/interfaces.d: source-directory /etc/network/interfaces.d # The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth1 iface eth1 inet static address 10.0.1.102 netmask 255.255.255.0 gateway 10.0.1.1 #VAGRANT-END Puerta de enlace ares sudo ip route del default sudo ip route add default via 10.0.1.1 /etc/netplan/50-vagrant.yaml : --- network: version: 2 renderer: networkd ethernets: eth1: addresses: - 10.0.1.101/24 routes: - to: default via: 10.0.1.1 Puerta de enlace hera sudo ip route del default sudo ip route add default via 172.16.0.1 /etc/sysconfig/network-scripts/ifcfg-eth0 : DEVICE=\"eth0\" BOOTPROTO=\"dhcp\" DEFROUTE=no ONBOOT=\"yes\" TYPE=\"Ethernet\" PERSISTENT_DHCLIENT=\"yes\" /etc/sysconfig/network-scripts/ifcfg-eth1 : #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. NM_CONTROLLED=yes BOOTPROTO=none ONBOOT=yes IPADDR=172.16.0.200 NETMASK=255.255.0.0 GATEWAY=172.16.0.1 DEFROUTE=yes DEVICE=eth1 PEERDNS=no #VAGRANT-END Ejercicio 9 ssh config en mi m\u00e1quina para acceder a todos los servidores ~/.ssh/config : ##################### # escenario libvirt # ##################### Host zeus-clase HostName 172.22.0.213 User vagrant Host apolo-clase HostName 10.0.1.102 User vagrant ProxyJump zeus-clase Host ares-clase HostName 10.0.1.101 User vagrant ProxyJump zeus-clase Host hera-clase HostName 172.16.0.200 User vagrant ProxyJump zeus-clase En principio esa es mi configuraci\u00f3n de conexiones para cuando est\u00e9 en la red de clase. Evidentemente, esta configuraci\u00f3n crecer\u00e1 cuando a\u00f1ada conexiones para mi casa.","title":"Escenario libvirt"},{"location":"practica-escenario-libvirt/#practica-instalacion-y-configuracion-inicial-de-los-servidores-vagrant-libvirt","text":"","title":"Pr\u00e1ctica: Instalaci\u00f3n y configuraci\u00f3n inicial de los servidores Vagrant Libvirt"},{"location":"practica-escenario-libvirt/#entrega","text":"","title":"Entrega"},{"location":"practica-escenario-libvirt/#parte-1","text":"IP \"p\u00fablica\" de zeus 172.22.0.213","title":"Parte 1"},{"location":"practica-escenario-libvirt/#parte-2","text":"Actualizar esta entrada en la wiki de Redmine con informaci\u00f3n sobre el escenario Hecho.","title":"Parte 2"},{"location":"practica-escenario-libvirt/#realizacion","text":"Escenario de trabajo a usar durante el curso:","title":"Realizaci\u00f3n"},{"location":"practica-escenario-libvirt/#ejercicio-1","text":"Crear escenario Vagrant Requisitos: vagrant box add rockylinux/8 vagrant box add generic/ubuntu2004 (libvirt) Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :zeus do |zeus| zeus.vm.box = \"debian/bullseye64\" zeus.vm.hostname = \"zeus\" zeus.vm.network :public_network, :dev => \"br0\", :mode => \"bridge\", :type => \"bridge\" zeus.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.1\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" zeus.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :hera do |hera| hera.vm.box = \"rockylinux/8\" hera.vm.hostname = \"hera\" hera.vm.network :private_network, :libvirt__network_name => \"red-dmz-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"172.16.0.200\", :libvirt__netmask => '255.255.0.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :apolo do |apolo| apolo.vm.box = \"debian/bullseye64\" apolo.vm.hostname = \"apolo\" apolo.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.102\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :ares do |ares| ares.vm.box = \"generic/ubuntu2004\" ares.vm.hostname = \"ares\" ares.vm.network :private_network, :libvirt__network_name => \"red-interna-de-adrianj\", :libvirt__dhcp_enabled => false, :ip => \"10.0.1.101\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end","title":"Ejercicio 1"},{"location":"practica-escenario-libvirt/#ejercicio-2","text":"Actualizar paqueter\u00eda en todos los servidores En zeus, apolo y ares: sudo apt update sudo apt upgrade En hera: sudo dnf check-update sudo dnf update","title":"Ejercicio 2"},{"location":"practica-escenario-libvirt/#ejercicio-3","text":"Contrase\u00f1a en todos los servidores (para poder modificar desde consola en caso necesario) En zeus, apolo, ares y hera: sudo passwd vagrant Contrase\u00f1a: 1234","title":"Ejercicio 3"},{"location":"practica-escenario-libvirt/#ejercicio-4","text":"Crear usuario profesor en todos los servidores. Usa sudo sin contrase\u00f1a.","title":"Ejercicio 4"},{"location":"practica-escenario-libvirt/#en-zeus-apolo-y-ares","text":"sudo adduser profesor sudo usermod -aG sudo profesor Contrase\u00f1a: 1234 /etc/sudoers : # Mis cambios profesor ALL=(ALL) NOPASSWD:ALL (al final del fichero)","title":"En zeus, apolo y ares"},{"location":"practica-escenario-libvirt/#en-hera","text":"sudo adduser profesor sudo passwd profesor sudo usermod -aG wheel profesor Contrase\u00f1a: 1234 /etc/sudoers : # Mis cambios profesor ALL=(ALL) NOPASSWD:ALL (al final del fichero)","title":"En hera"},{"location":"practica-escenario-libvirt/#ejercicio-5","text":"Copiar clave p\u00fablica ssh de josedom en los servidores al usuario profesor","title":"Ejercicio 5"},{"location":"practica-escenario-libvirt/#en-zeus-apolo-y-ares_1","text":"mkdir .ssh touch .ssh/authorized_keys Copio la clave: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCmjoVIoZCx4QFXvljqozXGqxxlSvO7V2aizqyPgMfGqnyl0J9YXo6zrcWYwyWMnMdRdwYZgHqfiiFCUn2QDm6ZuzC4Lcx0K3ZwO2lgL4XaATykVLneHR1ib6RNroFcClN69cxWsdwQW6dpjpiBDXf8m6/qxVP3EHwUTsP8XaOV7WkcCAqfYAMvpWLISqYme6e+6ZGJUIPkDTxavu5JTagDLwY+py1WB53eoDWsG99gmvyit2O1Eo+jRWN+mgRHIxJTrFtLS6o4iWeshPZ6LvCZ/Pum12Oj4B4bjGSHzrKjHZgTwhVJ/LDq3v71/PP4zaI3gVB9ZalemSxqomgbTlnT jose@debian","title":"En zeus, apolo y ares"},{"location":"practica-escenario-libvirt/#en-hera_1","text":"Lo mismo que arriba, a diferencia de hacer: chmod -R go= ~/.ssh","title":"En hera"},{"location":"practica-escenario-libvirt/#ejercicio-6","text":"Definir nombre largo y corto en todos los servidores, con el dominio adrianj.gonzalonazareno.org","title":"Ejercicio 6"},{"location":"practica-escenario-libvirt/#en-zeus","text":"/etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 zeus.adrianj.gonzalonazareno.org zeus Compruebo nombre largo: vagrant@zeus:~$ hostname -f zeus.adrianj.gonzalonazareno.org Compruebo nombre corto: vagrant@zeus:~$ ping zeus -c 1 PING zeus.adrianj.gonzalonazareno.org (127.0.1.1) 56(84) bytes of data. 64 bytes from zeus.adrianj.gonzalonazareno.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.077 ms --- zeus.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.077/0.077/0.077/0.000 ms","title":"En zeus"},{"location":"practica-escenario-libvirt/#en-apolo","text":"/etc/hosts : 127.0.0.1 localhost 127.0.0.2 bullseye ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.1.1 apolo.adrianj.gonzalonazareno.org apolo Compruebo nombre largo: vagrant@apolo:~$ hostname -f apolo.adrianj.gonzalonazareno.org Compruebo nombre corto: vagrant@apolo:~$ ping apolo -c 1 PING apolo.adrianj.gonzalonazareno.org (127.0.1.1) 56(84) bytes of data. 64 bytes from apolo.adrianj.gonzalonazareno.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.070 ms --- apolo.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.070/0.070/0.070/0.000 ms","title":"En apolo"},{"location":"practica-escenario-libvirt/#en-ares","text":"/etc/hosts : 127.0.0.1 localhost 127.0.1.1 ubuntu2004.localdomain # The following lines are desirable for IPv6 capable hosts ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 127.0.0.1 ubuntu2004.localdomain 127.0.2.1 ares.adrianj.gonzalonazareno.org ares Compruebo nombre largo: vagrant@ares:~$ hostname -f ares.adrianj.gonzalonazareno.org Compruebo nombre corto: vagrant@ares:~$ ping ares -c 1 PING ares.adrianj.gonzalonazareno.org (127.0.2.1) 56(84) bytes of data. 64 bytes from ares.adrianj.gonzalonazareno.org (127.0.2.1): icmp_seq=1 ttl=64 time=0.136 ms --- ares.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.136/0.136/0.136/0.000 ms","title":"En ares"},{"location":"practica-escenario-libvirt/#en-hera_2","text":"/etc/hosts : 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 127.0.1.1 hera.adrianj.gonzalonazareno.org hera Compruebo nombre largo: [vagrant@hera ~]$ hostname -f hera.adrianj.gonzalonazareno.org Compruebo nombre corto: [vagrant@hera ~]$ ping hera -c 1 PING hera.adrianj.gonzalonazareno.org (127.0.1.1) 56(84) bytes of data. 64 bytes from hera.adrianj.gonzalonazareno.org (127.0.1.1): icmp_seq=1 ttl=64 time=0.071 ms --- hera.adrianj.gonzalonazareno.org ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 0.071/0.071/0.071/0.000 ms","title":"En hera"},{"location":"practica-escenario-libvirt/#ejercicio-7","text":"Instalar bind9 en apolo sudo apt install bind9","title":"Ejercicio 7"},{"location":"practica-escenario-libvirt/#ejercicio-8","text":"SNAT en zeus + puerta de enlace sudo modprobe iptable_nat echo iptable_nat >> /etc/modules echo 1 > /proc/sys/net/ipv4/ip_forward sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE sudo apt install iptables-persistent sudo ip route del default sudo ip route add default via 172.22.0.1 En /etc/sysctl.conf descomentar: net.ipv4.ip_forward=1 /etc/network/interfaces : # interfaces(5) file used by ifup(8) and ifdown(8) # Include files from /etc/network/interfaces.d: source-directory /etc/network/interfaces.d # The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth1 iface eth1 inet dhcp post-up ip route add default via 172.22.0.1 #VAGRANT-END #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth2 iface eth2 inet static address 172.16.0.1 netmask 255.255.0.0 #VAGRANT-END #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth3 iface eth3 inet static address 10.0.1.1 netmask 255.255.255.0 #VAGRANT-END Puerta de enlace apolo sudo ip route del default sudo ip route add default via 10.0.1.1 /etc/network/interfaces : # interfaces(5) file used by ifup(8) and ifdown(8) # Include files from /etc/network/interfaces.d: source-directory /etc/network/interfaces.d # The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. auto eth1 iface eth1 inet static address 10.0.1.102 netmask 255.255.255.0 gateway 10.0.1.1 #VAGRANT-END Puerta de enlace ares sudo ip route del default sudo ip route add default via 10.0.1.1 /etc/netplan/50-vagrant.yaml : --- network: version: 2 renderer: networkd ethernets: eth1: addresses: - 10.0.1.101/24 routes: - to: default via: 10.0.1.1 Puerta de enlace hera sudo ip route del default sudo ip route add default via 172.16.0.1 /etc/sysconfig/network-scripts/ifcfg-eth0 : DEVICE=\"eth0\" BOOTPROTO=\"dhcp\" DEFROUTE=no ONBOOT=\"yes\" TYPE=\"Ethernet\" PERSISTENT_DHCLIENT=\"yes\" /etc/sysconfig/network-scripts/ifcfg-eth1 : #VAGRANT-BEGIN # The contents below are automatically generated by Vagrant. Do not modify. NM_CONTROLLED=yes BOOTPROTO=none ONBOOT=yes IPADDR=172.16.0.200 NETMASK=255.255.0.0 GATEWAY=172.16.0.1 DEFROUTE=yes DEVICE=eth1 PEERDNS=no #VAGRANT-END","title":"Ejercicio 8"},{"location":"practica-escenario-libvirt/#ejercicio-9","text":"ssh config en mi m\u00e1quina para acceder a todos los servidores ~/.ssh/config : ##################### # escenario libvirt # ##################### Host zeus-clase HostName 172.22.0.213 User vagrant Host apolo-clase HostName 10.0.1.102 User vagrant ProxyJump zeus-clase Host ares-clase HostName 10.0.1.101 User vagrant ProxyJump zeus-clase Host hera-clase HostName 172.16.0.200 User vagrant ProxyJump zeus-clase En principio esa es mi configuraci\u00f3n de conexiones para cuando est\u00e9 en la red de clase. Evidentemente, esta configuraci\u00f3n crecer\u00e1 cuando a\u00f1ada conexiones para mi casa.","title":"Ejercicio 9"},{"location":"practica-https-vps/","text":"Pr\u00e1ctica: Configuraci\u00f3n de HTTPS en el VPS Se configurar\u00e1 para todos los VirtualHosts usando Let's Encrypt . Parte 1 Comprobar que Brave tiene el certificado de Let\u2019s Encrypt Antes de comprobar nada, es esencial entender su chain of trust: Como vemos, existen muchas entidades certificadoras, pero las que nos interesan son ISRG Root X1 y R3 . \u00c9sta \u00faltima es la que suele firmar a los usuarios finales. Brave no tiene el certificado de R3 , sino el de ISRG Root X1 : \u00bfPor qu\u00e9 esto es as\u00ed? Por la chain of trust que he mostrado arriba. Podemos hacer una prueba de esto, si accedemos a la web oficial de Let\u2019s Encrypt y mostramos la jerarqu\u00eda del certificado: Directamente Brave \"no conf\u00eda\" en R3 , porque no tiene su certificado y por lo cual no puede verificar su firma, pero s\u00ed tiene el certificado root de ISRG Root X1 que firm\u00f3 a R3, entonces puede verificar esa firma en el certificado de R3 y en consecuencia, confiar en \u00e9l. Parte 2 Preguntas \u00bfQu\u00e9 funci\u00f3n tiene el cliente ACME? Verificar que somos due\u00f1os del nombre de dominio, y emitirnos un certificado. Hay muchos clientes , pero el recomendado es Certbot. \u00bfQu\u00e9 configuraci\u00f3n se realiza en el servidor web? Solicitamos el certificado Configuramos los VirtualHosts con el certificado \u00bfQu\u00e9 pruebas realiza Let\u2019s Encrypt para asegurar que somos los administrados del sitio web? Let's Encrypt realiza \"challenges\", y hay varios tipos . Los m\u00e1s comunes son HTTP-01 y DNS-01. En mi caso, como querr\u00e9 obtener un certificado wildcard, tendr\u00e9 que hacer el DNS-01. Su funcionamiento es simple: Let\u2019s Encrypt nos proporciona un registro TXT que tendremos que crear en nuestro DNS bajo el nombre _acme-challenge.adrianjaramillo.tk. Let\u2019s Encrypt hace una consulta a _acme-challenge.adrianjaramillo.tk. Si la consulta resolvi\u00f3 el nombre correctamente con la cadena que se nos proporcion\u00f3, Let\u2019s Encrypt verifica que somos los due\u00f1os del dominio, y nos proporciona el certificado firmado. \u00bfSe puede usar el DNS para verificar que somos administradores del sitio? S\u00ed. De hecho, es el \u00fanico challenge permitido si queremos obtener un certificado wildcard. Certificado wildcard *.adrianjaramillo.tk Instalo certbot y paquetes relacionados: sudo apt install letsencrypt A\u00f1ado el siguiente registro a mi DNS: Pido el certificado: sudo certbot certonly --manual --preferred-challenges dns -d *.adrianjaramillo.tk Saving debug log to /var/log/letsencrypt/letsencrypt.log Plugins selected: Authenticator manual, Installer None Requesting a certificate for *.adrianjaramillo.tk Performing the following challenges: dns-01 challenge for adrianjaramillo.tk - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Please deploy a DNS TXT record under the name _acme-challenge.adrianjaramillo.tk with the following value: Zjtt4Rws9cuSpcQ8yMGJ5cXGcMfhgWUPen36G2WOwSg Before continuing, verify the record is deployed. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Press Enter to Continue Waiting for verification... Cleaning up challenges IMPORTANT NOTES: - Congratulations! Your certificate and chain have been saved at: /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem Your key file has been saved at: /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem Your certificate will expire on 2022-03-06. To obtain a new or tweaked version of this certificate in the future, simply run certbot again. To non-interactively renew *all* of your certificates, run \"certbot renew\" - If you like Certbot, please consider supporting our work by: Donating to ISRG / Let's Encrypt: https://letsencrypt.org/donate Donating to EFF: https://eff.org/donate-le Verifico que tengo el certificado: sudo certbot certificates Saving debug log to /var/log/letsencrypt/letsencrypt.log - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Found the following certs: Certificate Name: adrianjaramillo.tk Serial Number: 348d745d49f1968da5ccfce5d50d4b3018d Key Type: RSA Domains: *.adrianjaramillo.tk Expiry Date: 2022-03-06 18:09:13+00:00 (VALID: 89 days) Certificate Path: /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem Private Key Path: /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Parte 3 Configurar 2 ficheros por VirtualHost (HTTP y HTTPS). Redirigir HTTP a HTTPS. django_http.conf : server { listen 80; server_name django.adrianjaramillo.tk; return 301 https://$host$request_uri; } django_https.conf : server { listen 443 ssl; server_name django.adrianjaramillo.tk; root /home/blackmamba/django_tutorial; ################### # RSA certificate # ################### ssl_certificate /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ############# # Locations # ############# location / { proxy_pass http://localhost:8080; include proxy_params; } location /static/polls { alias /home/blackmamba/django_tutorial/polls/static/polls; } location /static/admin { alias /home/blackmamba/venv/lib/python3.9/site-packages/django/contrib/admin/static/admin/; } } portal_http.conf : server { listen 80; server_name portal.adrianjaramillo.tk; return 301 https://$host$request_uri; } portal_https.conf : server { listen 443 ssl; server_name portal.adrianjaramillo.tk; root /var/www/portal; ################### # RSA certificate # ################### ssl_certificate /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ############# # Locations # ############# location / { index index.php index.html index.htm; } location ~ \\.php$ { include fastcgi_params; fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; } } www_http.conf : server { listen 80; server_name www.adrianjaramillo.tk; return 301 https://$host$request_uri; } www_https.conf : server { ########### # GENERAL # ########### listen 443 ssl; server_name www.adrianjaramillo.tk; root /var/www/www; index index.html index.htm; error_page 404 /error/404.html; error_page 403 /error/403.html; location ~ \\.php$ { fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } ################### # RSA certificate # ################### ssl_certificate /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ############# # PRINCIPAL # ############# rewrite ^/$ https://www.adrianjaramillo.tk/principal permanent; location /principal { autoindex off; disable_symlinks on; } location /principal/documentos { alias /srv/doc; autoindex on; disable_symlinks off; } location /secreto { auth_basic \"Acceso restringido\"; auth_basic_user_file /etc/nginx/.htpasswd; } ############# # NEXTCLOUD # ############# location = /robots.txt { allow all; log_not_found off; access_log off; } location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in the Nextcloud `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 /cloud/remote.php/dav/; } location = /.well-known/caldav { return 301 /cloud/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 /cloud/index.php$request_uri; } location ^~ /cloud { # set max upload size and increase upload timeout: client_max_body_size 512M; client_body_timeout 300s; fastcgi_buffers 64 4K; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Specify how to handle directories -- specifying `/nextcloud/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /nextcloud/index.php$request_uri` # always provides the desired behaviour. index index.php index.html /cloud/index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = /cloud { if ( $http_user_agent ~ ^DavClnt ) { return 302 /cloud/remote.php/webdav/$is_args$args; } } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends # `/nextcloud/index.php` to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { # Required for legacy support rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri; fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif|png|jpg|ico)$ { try_files $uri /cloud/index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /cloud/index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /cloud/remote { return 301 /cloud/remote.php$request_uri; } location /cloud { try_files $uri $uri/ /cloud/index.php$request_uri; } } } Parte 4 Comprobar que se ha creado una tarea cron para renovar el certificado /etc/cron.d/certbot : # /etc/cron.d/certbot: crontab entries for the certbot package # # Upstream recommends attempting renewal twice a day # # Eventually, this will be an opportunity to validate certificates # haven't been revoked, etc. Renewal will only occur if expiration # is within 30 days. # # Important Note! This cronjob will NOT be executed if you are # running systemd as your init system. If you are running systemd, # the cronjob.timer function takes precedence over this cronjob. For # more details, see the systemd.timer manpage, or use systemctl show # certbot.timer. SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin 0 */12 * * * root test -x /usr/bin/certbot -a \\! -d /run/systemd/system && perl -e 'sleep int(rand(43200))' && certbot -q renew La renovaci\u00f3n s\u00f3lo ocurrir\u00e1 si la expiraci\u00f3n es en 30 d\u00edas. Podemos usar herramientas online para entender la expresi\u00f3n cron: Es decir, la tarea cron se ejecuta cada 12 horas. Parte 5 Comprobar que las p\u00e1ginas son accesibles por HTTPS y visualizar los detalles del certificado En todos los VirtualHosts, los detalles del certificado son los mismos: Muestro el resto de VirtualHosts: Parte 6 Modificar el cliente Nextcloud para que siga funcionando con HTTPS Desde que hemos configurado HTTPS, el cliente da errores: Tenemos que borrar la conexi\u00f3n antigua, y crear una nueva HTTPS: Una vez terminada la configuraci\u00f3n, vemos que sigue funcionando con HTTPS: Adem\u00e1s, si queremos, el cliente de Nextcloud nos permite ver los detalles del certificado:","title":"Pr\u00e1ctica: HTTPS en VPS"},{"location":"practica-https-vps/#practica-configuracion-de-https-en-el-vps","text":"Se configurar\u00e1 para todos los VirtualHosts usando Let's Encrypt .","title":"Pr\u00e1ctica: Configuraci\u00f3n de HTTPS en el VPS"},{"location":"practica-https-vps/#parte-1","text":"Comprobar que Brave tiene el certificado de Let\u2019s Encrypt Antes de comprobar nada, es esencial entender su chain of trust: Como vemos, existen muchas entidades certificadoras, pero las que nos interesan son ISRG Root X1 y R3 . \u00c9sta \u00faltima es la que suele firmar a los usuarios finales. Brave no tiene el certificado de R3 , sino el de ISRG Root X1 : \u00bfPor qu\u00e9 esto es as\u00ed? Por la chain of trust que he mostrado arriba. Podemos hacer una prueba de esto, si accedemos a la web oficial de Let\u2019s Encrypt y mostramos la jerarqu\u00eda del certificado: Directamente Brave \"no conf\u00eda\" en R3 , porque no tiene su certificado y por lo cual no puede verificar su firma, pero s\u00ed tiene el certificado root de ISRG Root X1 que firm\u00f3 a R3, entonces puede verificar esa firma en el certificado de R3 y en consecuencia, confiar en \u00e9l.","title":"Parte 1"},{"location":"practica-https-vps/#parte-2","text":"","title":"Parte 2"},{"location":"practica-https-vps/#preguntas","text":"\u00bfQu\u00e9 funci\u00f3n tiene el cliente ACME? Verificar que somos due\u00f1os del nombre de dominio, y emitirnos un certificado. Hay muchos clientes , pero el recomendado es Certbot. \u00bfQu\u00e9 configuraci\u00f3n se realiza en el servidor web? Solicitamos el certificado Configuramos los VirtualHosts con el certificado \u00bfQu\u00e9 pruebas realiza Let\u2019s Encrypt para asegurar que somos los administrados del sitio web? Let's Encrypt realiza \"challenges\", y hay varios tipos . Los m\u00e1s comunes son HTTP-01 y DNS-01. En mi caso, como querr\u00e9 obtener un certificado wildcard, tendr\u00e9 que hacer el DNS-01. Su funcionamiento es simple: Let\u2019s Encrypt nos proporciona un registro TXT que tendremos que crear en nuestro DNS bajo el nombre _acme-challenge.adrianjaramillo.tk. Let\u2019s Encrypt hace una consulta a _acme-challenge.adrianjaramillo.tk. Si la consulta resolvi\u00f3 el nombre correctamente con la cadena que se nos proporcion\u00f3, Let\u2019s Encrypt verifica que somos los due\u00f1os del dominio, y nos proporciona el certificado firmado. \u00bfSe puede usar el DNS para verificar que somos administradores del sitio? S\u00ed. De hecho, es el \u00fanico challenge permitido si queremos obtener un certificado wildcard.","title":"Preguntas"},{"location":"practica-https-vps/#certificado-wildcard-adrianjaramillotk","text":"Instalo certbot y paquetes relacionados: sudo apt install letsencrypt A\u00f1ado el siguiente registro a mi DNS: Pido el certificado: sudo certbot certonly --manual --preferred-challenges dns -d *.adrianjaramillo.tk Saving debug log to /var/log/letsencrypt/letsencrypt.log Plugins selected: Authenticator manual, Installer None Requesting a certificate for *.adrianjaramillo.tk Performing the following challenges: dns-01 challenge for adrianjaramillo.tk - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Please deploy a DNS TXT record under the name _acme-challenge.adrianjaramillo.tk with the following value: Zjtt4Rws9cuSpcQ8yMGJ5cXGcMfhgWUPen36G2WOwSg Before continuing, verify the record is deployed. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Press Enter to Continue Waiting for verification... Cleaning up challenges IMPORTANT NOTES: - Congratulations! Your certificate and chain have been saved at: /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem Your key file has been saved at: /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem Your certificate will expire on 2022-03-06. To obtain a new or tweaked version of this certificate in the future, simply run certbot again. To non-interactively renew *all* of your certificates, run \"certbot renew\" - If you like Certbot, please consider supporting our work by: Donating to ISRG / Let's Encrypt: https://letsencrypt.org/donate Donating to EFF: https://eff.org/donate-le Verifico que tengo el certificado: sudo certbot certificates Saving debug log to /var/log/letsencrypt/letsencrypt.log - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Found the following certs: Certificate Name: adrianjaramillo.tk Serial Number: 348d745d49f1968da5ccfce5d50d4b3018d Key Type: RSA Domains: *.adrianjaramillo.tk Expiry Date: 2022-03-06 18:09:13+00:00 (VALID: 89 days) Certificate Path: /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem Private Key Path: /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -","title":"Certificado wildcard *.adrianjaramillo.tk"},{"location":"practica-https-vps/#parte-3","text":"Configurar 2 ficheros por VirtualHost (HTTP y HTTPS). Redirigir HTTP a HTTPS. django_http.conf : server { listen 80; server_name django.adrianjaramillo.tk; return 301 https://$host$request_uri; } django_https.conf : server { listen 443 ssl; server_name django.adrianjaramillo.tk; root /home/blackmamba/django_tutorial; ################### # RSA certificate # ################### ssl_certificate /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ############# # Locations # ############# location / { proxy_pass http://localhost:8080; include proxy_params; } location /static/polls { alias /home/blackmamba/django_tutorial/polls/static/polls; } location /static/admin { alias /home/blackmamba/venv/lib/python3.9/site-packages/django/contrib/admin/static/admin/; } } portal_http.conf : server { listen 80; server_name portal.adrianjaramillo.tk; return 301 https://$host$request_uri; } portal_https.conf : server { listen 443 ssl; server_name portal.adrianjaramillo.tk; root /var/www/portal; ################### # RSA certificate # ################### ssl_certificate /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ############# # Locations # ############# location / { index index.php index.html index.htm; } location ~ \\.php$ { include fastcgi_params; fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; } } www_http.conf : server { listen 80; server_name www.adrianjaramillo.tk; return 301 https://$host$request_uri; } www_https.conf : server { ########### # GENERAL # ########### listen 443 ssl; server_name www.adrianjaramillo.tk; root /var/www/www; index index.html index.htm; error_page 404 /error/404.html; error_page 403 /error/403.html; location ~ \\.php$ { fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } ################### # RSA certificate # ################### ssl_certificate /etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ############# # PRINCIPAL # ############# rewrite ^/$ https://www.adrianjaramillo.tk/principal permanent; location /principal { autoindex off; disable_symlinks on; } location /principal/documentos { alias /srv/doc; autoindex on; disable_symlinks off; } location /secreto { auth_basic \"Acceso restringido\"; auth_basic_user_file /etc/nginx/.htpasswd; } ############# # NEXTCLOUD # ############# location = /robots.txt { allow all; log_not_found off; access_log off; } location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in the Nextcloud `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 /cloud/remote.php/dav/; } location = /.well-known/caldav { return 301 /cloud/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 /cloud/index.php$request_uri; } location ^~ /cloud { # set max upload size and increase upload timeout: client_max_body_size 512M; client_body_timeout 300s; fastcgi_buffers 64 4K; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Specify how to handle directories -- specifying `/nextcloud/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /nextcloud/index.php$request_uri` # always provides the desired behaviour. index index.php index.html /cloud/index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = /cloud { if ( $http_user_agent ~ ^DavClnt ) { return 302 /cloud/remote.php/webdav/$is_args$args; } } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends # `/nextcloud/index.php` to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { # Required for legacy support rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri; fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif|png|jpg|ico)$ { try_files $uri /cloud/index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /cloud/index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /cloud/remote { return 301 /cloud/remote.php$request_uri; } location /cloud { try_files $uri $uri/ /cloud/index.php$request_uri; } } }","title":"Parte 3"},{"location":"practica-https-vps/#parte-4","text":"Comprobar que se ha creado una tarea cron para renovar el certificado /etc/cron.d/certbot : # /etc/cron.d/certbot: crontab entries for the certbot package # # Upstream recommends attempting renewal twice a day # # Eventually, this will be an opportunity to validate certificates # haven't been revoked, etc. Renewal will only occur if expiration # is within 30 days. # # Important Note! This cronjob will NOT be executed if you are # running systemd as your init system. If you are running systemd, # the cronjob.timer function takes precedence over this cronjob. For # more details, see the systemd.timer manpage, or use systemctl show # certbot.timer. SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin 0 */12 * * * root test -x /usr/bin/certbot -a \\! -d /run/systemd/system && perl -e 'sleep int(rand(43200))' && certbot -q renew La renovaci\u00f3n s\u00f3lo ocurrir\u00e1 si la expiraci\u00f3n es en 30 d\u00edas. Podemos usar herramientas online para entender la expresi\u00f3n cron: Es decir, la tarea cron se ejecuta cada 12 horas.","title":"Parte 4"},{"location":"practica-https-vps/#parte-5","text":"Comprobar que las p\u00e1ginas son accesibles por HTTPS y visualizar los detalles del certificado En todos los VirtualHosts, los detalles del certificado son los mismos: Muestro el resto de VirtualHosts:","title":"Parte 5"},{"location":"practica-https-vps/#parte-6","text":"Modificar el cliente Nextcloud para que siga funcionando con HTTPS Desde que hemos configurado HTTPS, el cliente da errores: Tenemos que borrar la conexi\u00f3n antigua, y crear una nueva HTTPS: Una vez terminada la configuraci\u00f3n, vemos que sigue funcionando con HTTPS: Adem\u00e1s, si queremos, el cliente de Nextcloud nos permite ver los detalles del certificado:","title":"Parte 6"},{"location":"practica-integridad-firmas-autenticacion/","text":"Pr\u00e1ctica: Integridad, firmas y autenticaci\u00f3n Tarea 1: Firmas electr\u00f3nicas 1.1 Enviar un fichero y la firma del mismo a Carlos Enviar\u00e9: -rw-r--r-- 1 vagrant vagrant 28 Apr 28 01:03 paracarlos.txt Genero la firma: gpg --detach-sign paracarlos.txt Obtengo: -rw-r--r-- 1 vagrant vagrant 438 Apr 28 01:12 paracarlos.txt.sig Esta firma tambi\u00e9n la enviar\u00e9. Ambos ficheros enviados por scp. Verificar la firma recibida Recibo por scp: -rw-r--r-- 1 vagrant vagrant 28 May 15 11:02 paraadrian.txt -rw-r--r-- 1 vagrant vagrant 438 May 15 11:02 paraadrian.txt.sig Verifico la firma: vagrant@practicafirmas:~$ gpg --verify paraadrian.txt.sig paraadrian.txt gpg: Signature made Sun May 15 10:44:25 2022 UTC gpg: using RSA key 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 gpg: Good signature from \"Carlos Rivero <carlosrivero198@gmail.com>\" [unknown] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: 4E8F F10E DF31 2F43 014B 7AE1 3F61 89C8 E59B 7714 La verificaci\u00f3n ha sido correcta. 1.2 \u00bfQu\u00e9 significa este mensaje al verificar la firma? gpg: Firma correcta de \"Pepe D <josedom24@gmail.com>\" [desconocido] gpg: ATENCI\u00d3N: \u00a1Esta clave no est\u00e1 certificada por una firma de confianza! gpg: No hay indicios de que la firma pertenezca al propietario. Huellas dactilares de la clave primaria: E8DD 5DA9 3B88 F08A DA1D 26BF 5141 3DDB 0C99 55FC Significa que la clave p\u00fablica con la que se ha verificado la firma, no es una clave en la que yo conf\u00ede / haya firmado. Por ejemplo, puede suceder cuando la trust es \"unknown\", como ha sido el caso del apartado anterior. 1.3 En este apartado crearemos un anillo de confianza entre varios compa\u00f1eros. 1.3.1 Subir tu clave p\u00fablica a pgp.rediris.es vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --send-keys 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 gpg: sending key 0C3C966CD1DC1A62 to hkp://pgp.rediris.es Compruebo que se ha subido correctamente: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --search-keys 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 gpg: data source: http://130.206.1.8:11371 (1) Adrian Jaramillo <adristudy@gmail.com> 3072 bit RSA key 0C3C966CD1DC1A62, created: 2022-05-16, expires: 2024-05-15 Keys 1-1 of 1 for \"69172731E9645F6ACB60CCBA0C3C966CD1DC1A62\". Enter number(s), N)ext, or Q)uit > 1.3.2 Pasar el fingerprint de tu clave subida a tus compa\u00f1eros para que la puedan descargar Hecho. 1.3.3 Bajar y firmar tres claves p\u00fablicas de compa\u00f1eros Me bajo la de Carlos: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --receive-keys 3F6189C8E59B7714 gpg: key 3F6189C8E59B7714: public key \"Carlos Rivero <carlosrivero198@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 La firmo: vagrant@practicafirmas:~$ gpg --sign-key 3F6189C8E59B7714 pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: unknown sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ unknown] (1). Carlos Rivero <carlosrivero198@gmail.com> pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: unknown Primary key fingerprint: 4E8F F10E DF31 2F43 014B 7AE1 3F61 89C8 E59B 7714 Carlos Rivero <carlosrivero198@gmail.com> This key is due to expire on 2024-05-14. Are you sure that you want to sign this key with your key \"Adrian Jaramillo <adristudy@gmail.com>\" (0C3C966CD1DC1A62) Really sign? (y/N) y Muestro que se aplic\u00f3 correctamente: vagrant@practicafirmas:~$ gpg --list-sig 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 pub rsa3072 2022-05-15 [SC] [expires: 2024-05-14] 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 uid [ full ] Carlos Rivero <carlosrivero198@gmail.com> sig 3 3F6189C8E59B7714 2022-05-15 Carlos Rivero <carlosrivero198@gmail.com> sig 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> sub rsa3072 2022-05-15 [E] [expires: 2024-05-14] sig 3F6189C8E59B7714 2022-05-15 Carlos Rivero <carlosrivero198@gmail.com> Me bajo la de Daniel: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --receive-keys 82805738F5FF4457 gpg: key 82805738F5FF4457: public key \"Daniel Parrales <daniparrales1@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 La firmo: vagrant@practicafirmas:~$ gpg --sign-key 82805738F5FF4457 pub rsa3072/82805738F5FF4457 created: 2022-05-16 expires: 2024-05-15 usage: SC trust: unknown validity: unknown sub rsa3072/408742D95A6657E5 created: 2022-05-16 expires: 2024-05-15 usage: E [ unknown] (1). Daniel Parrales <daniparrales1@gmail.com> pub rsa3072/82805738F5FF4457 created: 2022-05-16 expires: 2024-05-15 usage: SC trust: unknown validity: unknown Primary key fingerprint: 8595 30FB 6525 B22C 5F36 8117 8280 5738 F5FF 4457 Daniel Parrales <daniparrales1@gmail.com> This key is due to expire on 2024-05-15. Are you sure that you want to sign this key with your key \"Adrian Jaramillo <adristudy@gmail.com>\" (0C3C966CD1DC1A62) Really sign? (y/N) y Muestro que se aplic\u00f3 correctamente: vagrant@practicafirmas:~$ gpg --list-sig 82805738F5FF4457 pub rsa3072 2022-05-16 [SC] [expires: 2024-05-15] 859530FB6525B22C5F36811782805738F5FF4457 uid [ full ] Daniel Parrales <daniparrales1@gmail.com> sig 3 82805738F5FF4457 2022-05-16 Daniel Parrales <daniparrales1@gmail.com> sig 0C3C966CD1DC1A62 2022-06-07 Adrian Jaramillo <adristudy@gmail.com> sub rsa3072 2022-05-16 [E] [expires: 2024-05-15] sig 82805738F5FF4457 2022-05-16 Daniel Parrales <daniparrales1@gmail.com> Me bajo la de Lara: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --receive-keys EB5FEF455BD986A0 gpg: key EB5FEF455BD986A0: public key \"Lara Pruna Ternero <laraprute@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 La firmo: vagrant@practicafirmas:~$ gpg --sign-key EB5FEF455BD986A0 pub rsa3072/EB5FEF455BD986A0 created: 2022-06-07 expires: 2024-06-06 usage: SC trust: unknown validity: unknown sub rsa3072/C1F92F5A0AEA093D created: 2022-06-07 expires: 2024-06-06 usage: E [ unknown] (1). Lara Pruna Ternero <laraprute@gmail.com> pub rsa3072/EB5FEF455BD986A0 created: 2022-06-07 expires: 2024-06-06 usage: SC trust: unknown validity: unknown Primary key fingerprint: 8317 2CA2 F8FC 2124 94CB 677D EB5F EF45 5BD9 86A0 Lara Pruna Ternero <laraprute@gmail.com> This key is due to expire on 2024-06-06. Are you sure that you want to sign this key with your key \"Adrian Jaramillo <adristudy@gmail.com>\" (0C3C966CD1DC1A62) Really sign? (y/N) y Muestro que se aplic\u00f3 correctamente: vagrant@practicafirmas:~$ gpg --list-sig EB5FEF455BD986A0 pub rsa3072 2022-06-07 [SC] [expires: 2024-06-06] 83172CA2F8FC212494CB677DEB5FEF455BD986A0 uid [ full ] Lara Pruna Ternero <laraprute@gmail.com> sig 3 EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> sig 0C3C966CD1DC1A62 2022-06-07 Adrian Jaramillo <adristudy@gmail.com> sub rsa3072 2022-06-07 [E] [expires: 2024-06-06] sig EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> 1.3.4 Tu clave p\u00fablica tiene que tener 3 firmas vagrant@practicafirmas:~$ gpg --list-sigs adristudy@gmail.com pub rsa3072 2022-05-16 [SC] [expires: 2024-05-15] 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 uid [ultimate] Adrian Jaramillo <adristudy@gmail.com> sig 3 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> sig 3F6189C8E59B7714 2022-06-07 Carlos Rivero <carlosrivero198@gmail.com> sig 82805738F5FF4457 2022-06-07 Daniel Parrales <daniparrales1@gmail.com> sig EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> sub rsa3072 2022-05-16 [E] [expires: 2024-05-15] sig 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> 1.3.5 Al firmar claves, devolverlas a su due\u00f1o Todas las exporto de esta manera: gpg --export -a carlosrivero198@gmail.com > publiccarlos.key 1.3.6 Subir a pgp.rediris.es tu clave cuando tenga tres firmas vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --send-key 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 gpg: sending key 0C3C966CD1DC1A62 to hkp://pgp.rediris.es Muestro las 3 firmas en el keyserver: Rellenar datos de tu clave p\u00fablica aqu\u00ed 1.3.7 Bajar las claves p\u00fablicas de tus compa\u00f1eros con tres firmas Todas se bajar\u00e1n de la misma manera: gpg --keyserver pgp.rediris.es --recv-key 3F6189C8E59B7714 IMPORTANTE: AL BAJAR DIRECTAMENTE LAS CLAVES DE ESTA MANERA LAS FIRMAS SE ELIMINAN, AS\u00cd QUE ES MEJOR IMPORTAR LAS CLAVES DESDE UN FICHERO Y AS\u00cd MANTENDREMOS LAS FIRMAS 1.4 Mostrar las firmas de tu clave p\u00fablica vagrant@practicafirmas:~$ gpg --list-sigs adristudy@gmail.com pub rsa3072 2022-05-16 [SC] [expires: 2024-05-15] 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 uid [ultimate] Adrian Jaramillo <adristudy@gmail.com> sig 3 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> sig 3F6189C8E59B7714 2022-06-07 Carlos Rivero <carlosrivero198@gmail.com> sig 82805738F5FF4457 2022-06-07 Daniel Parrales <daniparrales1@gmail.com> sig EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> sub rsa3072 2022-05-16 [E] [expires: 2024-05-15] sig 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> 1.5 Comprobar que se puede verificar \"sin problemas\u201d la firma de Carlos, porque ya se conf\u00eda vagrant@practicafirmas:~$ gpg --verify paraadrian.txt.sig paraadrian.txt gpg: Signature made Sun May 15 10:44:25 2022 UTC gpg: using RSA key 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 gpg: Good signature from \"Carlos Rivero <carlosrivero198@gmail.com>\" [full] 1.6 Comprobar que puedes verificar con confianza una firma de una persona en la que no conf\u00edas, pero sin embargo si conf\u00eda otra persona en la que tu tienes confianza total En este apartado vamos a intentar verificar una firma de Miguel: -rw-r--r-- 1 vagrant vagrant 16 Jun 8 06:17 paraadriandemiguel.txt -rw-r--r-- 1 vagrant vagrant 438 Jun 8 06:18 paraadriandemiguel.txt.sig Tenemos su clave p\u00fablica firmada por Carlos (en el que confiamos), pero la propia clave de Miguel nosotros no la hemos firmado, por lo que no confiamos: vagrant@practicafirmas:~$ gpg --list-sigs miguelcor.rrs@gmail.com pub rsa3072 2022-06-07 [SC] [expires: 2024-06-06] 5173B9123875E25C833A855307F879A05A4147C3 uid [ undef ] Miguel Cordoba <miguelcor.rrs@gmail.com> sig 3 07F879A05A4147C3 2022-06-07 Miguel Cordoba <miguelcor.rrs@gmail.com> sig 3F6189C8E59B7714 2022-06-07 Carlos Rivero <carlosrivero198@gmail.com> sub rsa3072 2022-06-07 [E] [expires: 2024-06-06] sig 07F879A05A4147C3 2022-06-07 Miguel Cordoba <miguelcor.rrs@gmail.com> Bien, si intentamos verificar la firma de Miguel, \u00bfdeber\u00eda de no haber errores verdad? Porque como dijimos, Carlos firm\u00f3 la de Miguel, y yo conf\u00edo en Carlos. Hagamos la prueba: vagrant@practicafirmas:~$ gpg --verify paraadriandemiguel.txt.sig paraadriandemiguel.txt gpg: Signature made Wed Jun 8 06:15:58 2022 UTC gpg: using RSA key 5173B9123875E25C833A855307F879A05A4147C3 gpg: Good signature from \"Miguel Cordoba <miguelcor.rrs@gmail.com>\" [undefined] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: 5173 B912 3875 E25C 833A 8553 07F8 79A0 5A41 47C3 Error. \u00bfPor qu\u00e9 ha sucedido esto? Pues bien, debemos explicar antes 2 conceptos fundamentales, trust y validity : TRUST : la trust se configura manualmente. Describe si una clave puede firmar otras claves, y que se conf\u00eden en ellas aunque yo directamente no conf\u00ede (permite la confianza en terceros). Ej: Si se conf\u00eda completamente en una persona \"A\", y esa persona firma la clave de una persona \"B\", autom\u00e1ticamente veremos la clave de \"B\" como v\u00e1lida. VALIDITY : la validez en diferencia con la trust, s\u00ed puede ser autom\u00e1tica. Describe si una clave tiene las suficientes firmas para que se pruebe que es la clave correcta (cuando nosotros firmamos una clave, autom\u00e1ticamente la validez pasa a \"full\") Habiendo dicho esto, entonces lo que ha debido pasar es que no tenemos confianza en la clave de Carlos, aunque la validez est\u00e9 a full porque la firmamos en su momento. Es decir, sabemos que la clave de Carlos es de verdad de Carlos, pero no confiamos en que Carlos firme otras claves, y luego nos creamos que esas otras son verdaderas. Vamos a mostrar los datos de la clave de Carlos para comprobar lo ya dicho: vagrant@practicafirmas:~$ gpg --edit-key carlosrivero198@gmail.com gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> gpg> Est\u00e1 ocurriendo tal y como hemos explicado antes, la trust es \"unknown\" y la validity es \"full\". No estamos confiando en las firmas a terceros de Carlos. \u00bfEntonces qu\u00e9 debemos hacer? Cambiar la trust en la clave de Carlos para que confiemos en sus firmas a terceros. Debemos configurar el nivel de trust a 4, o full. Lo hacemos as\u00ed: vagrant@practicafirmas:~$ gpg --edit-key 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 trust gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> Please decide how far you trust this user to correctly verify other users' keys (by looking at passports, checking fingerprints from different sources, etc.) 1 = I don't know or won't say 2 = I do NOT trust 3 = I trust marginally 4 = I trust fully 5 = I trust ultimately m = back to the main menu Your decision? 4 pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: full validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> Please note that the shown key validity is not necessarily correct unless you restart the program. gpg> quit Ahora la trust est\u00e1 a full como podemos observar. Pues bien, ahora s\u00ed podremos verificar correctamente la firma de Miguel, porque ahora confiamos en las firmas de Carlos a terceros. Por esto, en nuestro listado de claves, ahora la clave de Miguel es confiada de forma full: pub rsa3072 2022-06-07 [SC] [expires: 2024-06-06] 5173B9123875E25C833A855307F879A05A4147C3 uid [ full ] Miguel Cordoba <miguelcor.rrs@gmail.com> sub rsa3072 2022-06-07 [E] [expires: 2024-06-06] Podremos ahora verificar su firma correctamente: vagrant@practicafirmas:~$ gpg --verify paraadriandemiguel.txt.sig paraadriandemiguel.txt gpg: Signature made Wed Jun 8 06:15:58 2022 UTC gpg: using RSA key 5173B9123875E25C833A855307F879A05A4147C3 gpg: Good signature from \"Miguel Cordoba <miguelcor.rrs@gmail.com>\" [full] Tarea 2: Correo seguro con Evolution 2.1 Configurar una cuenta de correo sudo apt install evolution Despu\u00e9s de instalarlo y configurarlo, muestro que funciona: 2.2 Configurar el firmado de correos con nuestra clave privada Primero tenemos que llegar al men\u00fa correspondiente: Una vez ah\u00ed, indicamos el fingerprint del par de claves con el que queremos firmar: Para que los correos de verdad se firmen al enviarse, tenemos que marcar la siguiente opci\u00f3n antes de enviarlos: 2.3 Configurar el cifrado de correos para otros destinatarios Para el cifrado no hace falta que configuremos en Evolution las claves p\u00fablicas, ya que las toma de nuestro keybox autom\u00e1ticamente seg\u00fan la direcci\u00f3n que escribamos en el \"To:\" . Para que los correos de verdad se cifren al enviarse, tenemos que marcar la siguiente opci\u00f3n antes de enviarlos: 2.4 Enviar un correo firmado y cifrado a Carlos Este es el correo que enviar\u00e9: Si yo lo intento abrir, no podr\u00e9 ver el contenido ya que no tengo la clave privada de Carlos para desencriptarlo: Este es el correo que le ha llegado a Carlos, desde su punto de vista, y vemos que todo es correcto: 2.5 Recibir un correo firmado y cifrado de Carlos Vemos que todo es correcto: 2.6 Mandar a Ra\u00fal un correo cifrado y firmado Busco la clave p\u00fablica de Ra\u00fal en RedIRIS y me la bajo (se necesitar\u00e1 para encriptar): atlas@olympus:~$ gpg --keyserver pgp.rediris.es --search-key rruizp@gmail.com gpg: data source: http://130.206.1.8:11371 (1) Ra\u00fal Ruiz Padilla <rruizp@gmail.com> 3072 bit RSA key A036DF623D608DE0, created: 2021-11-10, expires: 2023-11-10 (2) Ra\u00fal Ruiz (Claves para clase) <rruizp@gmail.com> 4096 bit RSA key 334BEE7E18D37DEA, created: 2017-12-16 (3) Raul Ruiz Padilla (Clave para SAD 1617) <rruizp@gmail.com> 4096 bit RSA key F6C88DC57C2FA472, created: 2016-12-11, expires: 2018-12-10 (expired) Keys 1-3 of 3 for \"rruizp@gmail.com\". Enter number(s), N)ext, or Q)uit > 1 gpg: key A036DF623D608DE0: public key \"Ra\u00fal Ruiz Padilla <rruizp@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 Antes de enviar el correo es importante que dejemos marcada esta opci\u00f3n, para evitar el tener que firmar las claves p\u00fablicas de las personas a quienes queramos enviar: Este es el correo que enviar\u00e9: La parte marcada en rojo quiere decir que el correo se encriptar\u00e1 y firmar\u00e1. \u00bfQU\u00c9 TENDR\u00c1 QUE HACER RA\u00daL PARA LEER ESTE CORREO CORRECTAMENTE? Necesitar\u00e1 2 cosas: La clave privada correspondiente a la p\u00fablica con la que se encript\u00f3 el correo para descifrarlo correctamente. Mi clave p\u00fablica para poder verificar la firma. La podr\u00e1 obtener con el comando gpg --keyserver pgp.rediris.es --search-key adristudy@gmail.com , eligiendo la de fingerprint CA350E4C295E2EF4. Tarea 3: Integridad de ficheros 3.1 Descargar la ISO de Debian wget https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-11.2.0-amd64-netinst.iso Obtengo el fichero: -rw-r--r-- 1 vagrant vagrant 396361728 Dec 18 13:24 debian-11.2.0-amd64-netinst.iso 3.2 Comprobar la integridad de la ISO descargada usando sha512sum En el fichero SHA512SUMS que nos proporciona Debian, nos encontramos el siguiente checksum para la ISO descargada: c685b85cf9f248633ba3cd2b9f9e781fa03225587e0c332aef2063f6877a1f0622f56d44cf0690087b0ca36883147ecb5593e3da6f965968402cdbdf12f6dd74 Luego utilizo sha512sum sobre la ISO que me he descargado: sha512sum debian-11.2.0-amd64-netinst.iso c685b85cf9f248633ba3cd2b9f9e781fa03225587e0c332aef2063f6877a1f0622f56d44cf0690087b0ca36883147ecb5593e3da6f965968402cdbdf12f6dd74 debian-11.2.0-amd64-netinst.iso Ambos hashes coinciden, as\u00ed que nos hemos descargado el fichero correctamente. Igualmente, si queremos evitar errores, podemos usar una herramienta online para comparar strings: 3.3 Verificar que SHA512SUMS no ha sido manipulado usando SHA512SUMS.sign Primero descargo ambos ficheros: wget https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/SHA512SUMS wget https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/SHA512SUMS.sign Muestro que los tengo: -rw-r--r-- 1 vagrant vagrant 494 Dec 18 20:42 SHA512SUMS -rw-r--r-- 1 vagrant vagrant 833 Dec 18 20:45 SHA512SUMS.sign Averiguo el fingerprint del par de claves que se us\u00f3 originalmente para crear la firma SHA512SUMS.sign : gpg --verify SHA512SUMS.sign No se puede verificar la firma porque no tenemos la clave p\u00fablica de Debian en nuestro keybox, pero ya sabemos su fingerprint para descargarla: gpg --keyserver keyring.debian.org --recv DF9B9C49EAA9298432589D76DA87E80D6294BE9B gpg: key DA87E80D6294BE9B: public key \"Debian CD signing key <debian-cd@lists.debian.org>\" imported gpg: Total number processed: 1 gpg: imported: 1 Finalmente, podemos verificar la firma: gpg --verify SHA512SUMS.sign SHA512SUMS gpg: Signature made Sat Dec 18 20:45:36 2021 UTC gpg: using RSA key DF9B9C49EAA9298432589D76DA87E80D6294BE9B gpg: Good signature from \"Debian CD signing key <debian-cd@lists.debian.org>\" [unknown] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: DF9B 9C49 EAA9 2984 3258 9D76 DA87 E80D 6294 BE9B Se ha podido verificar correctamente, SHA512SUMS es leg\u00edtimo. Tarea 4: Integridad y autenticidad (apt-secure) 4.1 \u00bfQu\u00e9 herramienta utiliza apt-secure para firmar y verificar firmas? GPG. 4.2 \u00bfPara qu\u00e9 sirve apt-key ? Se usa para gestionar la lista de claves que mantiene apt para autenticar paquetes. Los paquetes que sean autenticados usando estas claves se considerar\u00e1n \"trusted\". \u00bfQu\u00e9 muestra el comando apt-key list ? Lista las claves p\u00fablicas en las que confiamos. Muestro mi output de apt-key list : Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)). /etc/apt/trusted.gpg.d/debian-archive-bullseye-automatic.gpg ------------------------------------------------------------ pub rsa4096 2021-01-17 [SC] [expires: 2029-01-15] 1F89 983E 0081 FDE0 18F3 CC96 73A4 F27B 8DD4 7936 uid [ unknown] Debian Archive Automatic Signing Key (11/bullseye) <ftpmaster@debian.org> sub rsa4096 2021-01-17 [S] [expires: 2029-01-15] /etc/apt/trusted.gpg.d/debian-archive-bullseye-security-automatic.gpg --------------------------------------------------------------------- pub rsa4096 2021-01-17 [SC] [expires: 2029-01-15] AC53 0D52 0F2F 3269 F5E9 8313 A484 4904 4AAD 5C5D uid [ unknown] Debian Security Archive Automatic Signing Key (11/bullseye) <ftpmaster@debian.org> sub rsa4096 2021-01-17 [S] [expires: 2029-01-15] /etc/apt/trusted.gpg.d/debian-archive-bullseye-stable.gpg --------------------------------------------------------- pub rsa4096 2021-02-13 [SC] [expires: 2029-02-11] A428 5295 FC7B 1A81 6000 62A9 605C 66F0 0D6C 9793 uid [ unknown] Debian Stable Release Key (11/bullseye) <debian-release@lists.debian.org> /etc/apt/trusted.gpg.d/debian-archive-buster-automatic.gpg ---------------------------------------------------------- pub rsa4096 2019-04-14 [SC] [expires: 2027-04-12] 80D1 5823 B7FD 1561 F9F7 BCDD DC30 D7C2 3CBB ABEE uid [ unknown] Debian Archive Automatic Signing Key (10/buster) <ftpmaster@debian.org> sub rsa4096 2019-04-14 [S] [expires: 2027-04-12] /etc/apt/trusted.gpg.d/debian-archive-buster-security-automatic.gpg ------------------------------------------------------------------- pub rsa4096 2019-04-14 [SC] [expires: 2027-04-12] 5E61 B217 265D A980 7A23 C5FF 4DFA B270 CAA9 6DFA uid [ unknown] Debian Security Archive Automatic Signing Key (10/buster) <ftpmaster@debian.org> sub rsa4096 2019-04-14 [S] [expires: 2027-04-12] /etc/apt/trusted.gpg.d/debian-archive-buster-stable.gpg ------------------------------------------------------- pub rsa4096 2019-02-05 [SC] [expires: 2027-02-03] 6D33 866E DD8F FA41 C014 3AED DCC9 EFBF 77E1 1517 uid [ unknown] Debian Stable Release Key (10/buster) <debian-release@lists.debian.org> /etc/apt/trusted.gpg.d/debian-archive-stretch-automatic.gpg ----------------------------------------------------------- pub rsa4096 2017-05-22 [SC] [expires: 2025-05-20] E1CF 20DD FFE4 B89E 8026 58F1 E0B1 1894 F66A EC98 uid [ unknown] Debian Archive Automatic Signing Key (9/stretch) <ftpmaster@debian.org> sub rsa4096 2017-05-22 [S] [expires: 2025-05-20] /etc/apt/trusted.gpg.d/debian-archive-stretch-security-automatic.gpg -------------------------------------------------------------------- pub rsa4096 2017-05-22 [SC] [expires: 2025-05-20] 6ED6 F5CB 5FA6 FB2F 460A E88E EDA0 D238 8AE2 2BA9 uid [ unknown] Debian Security Archive Automatic Signing Key (9/stretch) <ftpmaster@debian.org> sub rsa4096 2017-05-22 [S] [expires: 2025-05-20] /etc/apt/trusted.gpg.d/debian-archive-stretch-stable.gpg -------------------------------------------------------- pub rsa4096 2017-05-20 [SC] [expires: 2025-05-18] 067E 3C45 6BAE 240A CEE8 8F6F EF0F 382A 1A7B 6500 uid [ unknown] Debian Stable Release Key (9/stretch) <debian-release@lists.debian.org> 4.3 \u00bfD\u00f3nde se encuentran los distintos keyrings que usa apt-key ? En /etc/apt/trusted.gpg.d/ . 4.4 \u00bfQu\u00e9 contiene el fichero Release de un repositorio? En otros datos, contiene los checksums de los ficheros que hay en el repositorio. Ejemplo: http://ftp.debian.org/debian/dists/Debian11.2/Release \u00bfY Release.gpg ? Contiene la firma detached ascii-armored del fichero Release . Ejemplo: http://ftp.debian.org/debian/dists/Debian11.2/Release.gpg 4.5 Explicar el proceso por el cual apt nos asegura que los ficheros que estamos descargando son leg\u00edtimos Se descargan los ficheros Release , Release.gpg , y el fichero Packages que corresponda. Se comprueba usando la firma Release.gpg m\u00e1s la clave p\u00fablica correspondiente, que el fichero Release es leg\u00edtimo. A partir de aqu\u00ed, apt ya conf\u00eda en todos sus checksums. Apt compara el checksum del fichero Packages con el que encuentra en el fichero Release ; si coinciden, quiere decir que se descarg\u00f3 el fichero correcto. Al descargarnos un paquete individual se compara su checksum con el que aparece en Packages ; si coinciden, quiere decir que se descarg\u00f3 el paquete correcto. 4.6 A\u00f1adir el repositorio de VirtualBox A\u00f1ado las claves gpg necesarias: wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add - wget -q https://www.virtualbox.org/download/oracle_vbox.asc -O- | sudo apt-key add - A\u00f1ado el repositorio: echo \"deb [arch=amd64] http://download.virtualbox.org/virtualbox/debian bullseye contrib\" | sudo tee /etc/apt/sources.list.d/virtualbox.list Tarea 5: Autenticaci\u00f3n en SSH 5.1 Explicar qu\u00e9 sucede entre el cliente y el servidor para que se cifre la comunicaci\u00f3n Una sesi\u00f3n SSH tiene 2 fases antes de que se pueda cifrar la comunicaci\u00f3n. Las explicar\u00e9 a continuaci\u00f3n. CONEXI\u00d3N El cliente establece una conexi\u00f3n TCP con el servidor, y este responde con las versiones del protocolo que soporta. Si el cliente usa una versi\u00f3n del protocolo que coincida con las que acepta el servidor, la conexi\u00f3n contin\u00faa. El servidor comparte su clave p\u00fablica con el cliente, para que este compruebe si efectivamente es la m\u00e1quina a la que quer\u00eda conectarse. A partir de ahora, ambas partes est\u00e1n preparadas para la negociaci\u00f3n de una clave de sesi\u00f3n usando Diffie-Hellman. NEGOCIACI\u00d3N DE LA ENCRIPTACI\u00d3N PARA LA SESI\u00d3N Ambas partes se ponen de acuerdo en un n\u00famero primo alto, que servir\u00e1 como \"seed value\". Ambas partes se ponen de acuerdo en un tipo de cifrado (normalmente AES). Ambas partes generan otro n\u00famero primo por separado, que mantienen en secreto de la otra parte. Se usar\u00e1 como clave privada durante esta fase de negociaci\u00f3n (esta clave privada NO es la misma que se usa para la autenticaci\u00f3n) . La clave privada generada + el tipo de cifrado + el n\u00famero primo compartido, se usar\u00e1n para generar una clave p\u00fablica que estar\u00e1 derivada de la clave privada. Ambas partes intercambian sus claves p\u00fablicas generadas (estas claves p\u00fablicas NO son las mismas que se usan para la autenticaci\u00f3n) . Cada parte usar\u00e1 su clave privada + la clave p\u00fablica de la otra parte + el n\u00famero primo compartido original, para calcular una clave compartida \"shared secret\". Aunque este proceso lo realiza cada parte por separado, mientras se usen claves p\u00fablicas y privadas opuestas, se llegar\u00e1 al mismo \"shared secret\". Este \"shared secret\" se usar\u00e1 para encriptar toda comunicaci\u00f3n a partir de ahora. Es una clave sim\u00e9trica. \u00bfPara qu\u00e9 se utiliza la criptograf\u00eda sim\u00e9trica? Para encriptar las conexiones, mediante el uso de una clave secreta. Esta se genera a trav\u00e9s de un proceso llamado \"key exchange algorithm\", y es \u00fanica por sesi\u00f3n. En cuanto ambas partes la sepan, el resto de la sesi\u00f3n se encriptar\u00e1 usando esta clave. \u00bfY la asim\u00e9trica? Se usa: Durante el intercambio de clave para la encriptaci\u00f3n sim\u00e9trica. Ambas partes generan un par de claves temporal e intercambian la clave p\u00fablica para poder generar el \"shared secret\" (clave sim\u00e9trica) que se usar\u00e1 posteriormente. En la autenticaci\u00f3n del cliente con el servidor. 5.2 Explicar los dos m\u00e9todos de autenticaci\u00f3n que existen. Con contrase\u00f1a Es el m\u00e9todo m\u00e1s simple. Funciona as\u00ed: El servidor pide al cliente que introduzca la contrase\u00f1a del usuario con el que se est\u00e1n intentando conectar. Esta contrase\u00f1a se env\u00eda usando la encriptaci\u00f3n previamente negociada, para que se mantenga en secreto frente a terceros. Con par de claves Es el m\u00e9todo m\u00e1s popular y recomendado. Funciona as\u00ed: El cliente env\u00eda el ID del par de claves con el que se quiere autenticar ante el servidor. El servidor comprueba el fichero authorized_keys del usuario al que el cliente est\u00e1 intentando conectarse, para comprobar si existe la clave correspondiente al ID que envi\u00f3 el cliente en el paso anterior. Si se encuentra una clave p\u00fablica que corresponda con el ID enviado, el servidor genera un n\u00famero aleatorio y usa esa clave p\u00fablica para encriptarlo. El servidor env\u00eda al cliente este n\u00famero encriptado. Si el cliente tiene la clave privada asociada, podr\u00e1 desencriptar este mensaje y revelar el n\u00famero original. El cliente combina el n\u00famero desencriptado con la clave compartida de sesi\u00f3n que se est\u00e1 usando para encriptar la comunicaci\u00f3n, y calcula el hash MD5 de este valor. El cliente env\u00eda este hash de vuelta al servidor como respuesta al mensaje del n\u00famero encriptado. El servidor usa la misma clave compartida de sesi\u00f3n junto con el n\u00famero original que envi\u00f3 al cliente, y calcula el hash MD5 \u00e9l tambi\u00e9n. El servidor compara el hash que \u00e9l mismo gener\u00f3 con el que el cliente le envi\u00f3. Si estos valores son iguales, se prueba que el cliente tiene la clave privada correcta y finalmente, este cliente es autenticado correctamente. 5.3 Explicar la funci\u00f3n del fichero ~/.ssh/known_hosts Es un fichero de cliente que contiene todas las claves p\u00fablicas de los servidores a los que nos conectamos. El cliente SSH usa este fichero para autenticar los servidores a los que se conecta. 5.4 Explicar el significado del siguiente mensaje que aparece la primera vez que nos conectamos a un servidor $ ssh debian@172.22.200.74 The authenticity of host '172.22.200.74 (172.22.200.74)' can't be established. ECDSA key fingerprint is SHA256:7ZoNZPCbQTnDso1meVSNoKszn38ZwUI4i6saebbfL4M. Are you sure you want to continue connecting (yes/no)? Nos indica que, al ser la primera vez que nos estamos conectando a este servidor, a\u00fan no tenemos su clave p\u00fablica almacenada en el fichero ~/.ssh/known_hosts . Por lo tanto, a\u00fan \"no podemos\" verificar la autenticidad del mismo. Si estamos seguros de su autenticidad, diremos que s\u00ed, y eso almacenar\u00e1 su clave p\u00fablica en ~/.ssh/known_hosts . 5.5 \u00bfQu\u00e9 significa el siguiente mensaje que aparece cuando reutilizamos una ip? $ ssh debian@172.22.200.74 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY! Someone could be eavesdropping on you right now (man-in-the-middle attack)! It is also possible that a host key has just been changed. The fingerprint for the ECDSA key sent by the remote host is SHA256:W05RrybmcnJxD3fbwJOgSNNWATkVftsQl7EzfeKJgNc. Please contact your system administrator. Add correct host key in /home/jose/.ssh/known_hosts to get rid of this message. Offending ECDSA key in /home/jose/.ssh/known_hosts:103 remove with: ssh-keygen -f \"/home/jose/.ssh/known_hosts\" -R \"172.22.200.74\" ECDSA host key for 172.22.200.74 has changed and you have requested strict checking. Este mensaje simplemente indica que la clave p\u00fablica del servidor al que nos estamos intentando conectar ha cambiado con respecto a la clave que ten\u00edamos guardada para esa IP en nuestro known_hosts previamente. Se nos avisa porque es una forma de ataque man-in-the-middle, pero si estamos seguros de que somos nosotros mismos reutilizando una IP, simplemente borraremos la l\u00ednea correspondiente en nuestro known_hosts sobre la antigua conexi\u00f3n y volveremos a conectarnos. 5.6 \u00bfQu\u00e9 guardamos y para qu\u00e9 sirve el fichero en el servidor ~/.ssh/authorized_keys ? Este es un fichero de servidor, diferente por cada usuario del sistema, y guarda todas las claves p\u00fablicas de clientes permitidos para conectarse. Sirve para que el servidor verifique que los clientes conect\u00e1ndose sean leg\u00edtimos (que tengan la clave privada correspondiente).","title":"Criptograf\u00eda 2: Firmas"},{"location":"practica-integridad-firmas-autenticacion/#practica-integridad-firmas-y-autenticacion","text":"","title":"Pr\u00e1ctica: Integridad, firmas y autenticaci\u00f3n"},{"location":"practica-integridad-firmas-autenticacion/#tarea-1-firmas-electronicas","text":"","title":"Tarea 1: Firmas electr\u00f3nicas"},{"location":"practica-integridad-firmas-autenticacion/#11","text":"Enviar un fichero y la firma del mismo a Carlos Enviar\u00e9: -rw-r--r-- 1 vagrant vagrant 28 Apr 28 01:03 paracarlos.txt Genero la firma: gpg --detach-sign paracarlos.txt Obtengo: -rw-r--r-- 1 vagrant vagrant 438 Apr 28 01:12 paracarlos.txt.sig Esta firma tambi\u00e9n la enviar\u00e9. Ambos ficheros enviados por scp. Verificar la firma recibida Recibo por scp: -rw-r--r-- 1 vagrant vagrant 28 May 15 11:02 paraadrian.txt -rw-r--r-- 1 vagrant vagrant 438 May 15 11:02 paraadrian.txt.sig Verifico la firma: vagrant@practicafirmas:~$ gpg --verify paraadrian.txt.sig paraadrian.txt gpg: Signature made Sun May 15 10:44:25 2022 UTC gpg: using RSA key 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 gpg: Good signature from \"Carlos Rivero <carlosrivero198@gmail.com>\" [unknown] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: 4E8F F10E DF31 2F43 014B 7AE1 3F61 89C8 E59B 7714 La verificaci\u00f3n ha sido correcta.","title":"1.1"},{"location":"practica-integridad-firmas-autenticacion/#12","text":"\u00bfQu\u00e9 significa este mensaje al verificar la firma? gpg: Firma correcta de \"Pepe D <josedom24@gmail.com>\" [desconocido] gpg: ATENCI\u00d3N: \u00a1Esta clave no est\u00e1 certificada por una firma de confianza! gpg: No hay indicios de que la firma pertenezca al propietario. Huellas dactilares de la clave primaria: E8DD 5DA9 3B88 F08A DA1D 26BF 5141 3DDB 0C99 55FC Significa que la clave p\u00fablica con la que se ha verificado la firma, no es una clave en la que yo conf\u00ede / haya firmado. Por ejemplo, puede suceder cuando la trust es \"unknown\", como ha sido el caso del apartado anterior.","title":"1.2"},{"location":"practica-integridad-firmas-autenticacion/#13","text":"En este apartado crearemos un anillo de confianza entre varios compa\u00f1eros.","title":"1.3"},{"location":"practica-integridad-firmas-autenticacion/#131","text":"Subir tu clave p\u00fablica a pgp.rediris.es vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --send-keys 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 gpg: sending key 0C3C966CD1DC1A62 to hkp://pgp.rediris.es Compruebo que se ha subido correctamente: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --search-keys 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 gpg: data source: http://130.206.1.8:11371 (1) Adrian Jaramillo <adristudy@gmail.com> 3072 bit RSA key 0C3C966CD1DC1A62, created: 2022-05-16, expires: 2024-05-15 Keys 1-1 of 1 for \"69172731E9645F6ACB60CCBA0C3C966CD1DC1A62\". Enter number(s), N)ext, or Q)uit >","title":"1.3.1"},{"location":"practica-integridad-firmas-autenticacion/#132","text":"Pasar el fingerprint de tu clave subida a tus compa\u00f1eros para que la puedan descargar Hecho.","title":"1.3.2"},{"location":"practica-integridad-firmas-autenticacion/#133","text":"Bajar y firmar tres claves p\u00fablicas de compa\u00f1eros Me bajo la de Carlos: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --receive-keys 3F6189C8E59B7714 gpg: key 3F6189C8E59B7714: public key \"Carlos Rivero <carlosrivero198@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 La firmo: vagrant@practicafirmas:~$ gpg --sign-key 3F6189C8E59B7714 pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: unknown sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ unknown] (1). Carlos Rivero <carlosrivero198@gmail.com> pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: unknown Primary key fingerprint: 4E8F F10E DF31 2F43 014B 7AE1 3F61 89C8 E59B 7714 Carlos Rivero <carlosrivero198@gmail.com> This key is due to expire on 2024-05-14. Are you sure that you want to sign this key with your key \"Adrian Jaramillo <adristudy@gmail.com>\" (0C3C966CD1DC1A62) Really sign? (y/N) y Muestro que se aplic\u00f3 correctamente: vagrant@practicafirmas:~$ gpg --list-sig 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 pub rsa3072 2022-05-15 [SC] [expires: 2024-05-14] 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 uid [ full ] Carlos Rivero <carlosrivero198@gmail.com> sig 3 3F6189C8E59B7714 2022-05-15 Carlos Rivero <carlosrivero198@gmail.com> sig 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> sub rsa3072 2022-05-15 [E] [expires: 2024-05-14] sig 3F6189C8E59B7714 2022-05-15 Carlos Rivero <carlosrivero198@gmail.com> Me bajo la de Daniel: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --receive-keys 82805738F5FF4457 gpg: key 82805738F5FF4457: public key \"Daniel Parrales <daniparrales1@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 La firmo: vagrant@practicafirmas:~$ gpg --sign-key 82805738F5FF4457 pub rsa3072/82805738F5FF4457 created: 2022-05-16 expires: 2024-05-15 usage: SC trust: unknown validity: unknown sub rsa3072/408742D95A6657E5 created: 2022-05-16 expires: 2024-05-15 usage: E [ unknown] (1). Daniel Parrales <daniparrales1@gmail.com> pub rsa3072/82805738F5FF4457 created: 2022-05-16 expires: 2024-05-15 usage: SC trust: unknown validity: unknown Primary key fingerprint: 8595 30FB 6525 B22C 5F36 8117 8280 5738 F5FF 4457 Daniel Parrales <daniparrales1@gmail.com> This key is due to expire on 2024-05-15. Are you sure that you want to sign this key with your key \"Adrian Jaramillo <adristudy@gmail.com>\" (0C3C966CD1DC1A62) Really sign? (y/N) y Muestro que se aplic\u00f3 correctamente: vagrant@practicafirmas:~$ gpg --list-sig 82805738F5FF4457 pub rsa3072 2022-05-16 [SC] [expires: 2024-05-15] 859530FB6525B22C5F36811782805738F5FF4457 uid [ full ] Daniel Parrales <daniparrales1@gmail.com> sig 3 82805738F5FF4457 2022-05-16 Daniel Parrales <daniparrales1@gmail.com> sig 0C3C966CD1DC1A62 2022-06-07 Adrian Jaramillo <adristudy@gmail.com> sub rsa3072 2022-05-16 [E] [expires: 2024-05-15] sig 82805738F5FF4457 2022-05-16 Daniel Parrales <daniparrales1@gmail.com> Me bajo la de Lara: vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --receive-keys EB5FEF455BD986A0 gpg: key EB5FEF455BD986A0: public key \"Lara Pruna Ternero <laraprute@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 La firmo: vagrant@practicafirmas:~$ gpg --sign-key EB5FEF455BD986A0 pub rsa3072/EB5FEF455BD986A0 created: 2022-06-07 expires: 2024-06-06 usage: SC trust: unknown validity: unknown sub rsa3072/C1F92F5A0AEA093D created: 2022-06-07 expires: 2024-06-06 usage: E [ unknown] (1). Lara Pruna Ternero <laraprute@gmail.com> pub rsa3072/EB5FEF455BD986A0 created: 2022-06-07 expires: 2024-06-06 usage: SC trust: unknown validity: unknown Primary key fingerprint: 8317 2CA2 F8FC 2124 94CB 677D EB5F EF45 5BD9 86A0 Lara Pruna Ternero <laraprute@gmail.com> This key is due to expire on 2024-06-06. Are you sure that you want to sign this key with your key \"Adrian Jaramillo <adristudy@gmail.com>\" (0C3C966CD1DC1A62) Really sign? (y/N) y Muestro que se aplic\u00f3 correctamente: vagrant@practicafirmas:~$ gpg --list-sig EB5FEF455BD986A0 pub rsa3072 2022-06-07 [SC] [expires: 2024-06-06] 83172CA2F8FC212494CB677DEB5FEF455BD986A0 uid [ full ] Lara Pruna Ternero <laraprute@gmail.com> sig 3 EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> sig 0C3C966CD1DC1A62 2022-06-07 Adrian Jaramillo <adristudy@gmail.com> sub rsa3072 2022-06-07 [E] [expires: 2024-06-06] sig EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com>","title":"1.3.3"},{"location":"practica-integridad-firmas-autenticacion/#134","text":"Tu clave p\u00fablica tiene que tener 3 firmas vagrant@practicafirmas:~$ gpg --list-sigs adristudy@gmail.com pub rsa3072 2022-05-16 [SC] [expires: 2024-05-15] 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 uid [ultimate] Adrian Jaramillo <adristudy@gmail.com> sig 3 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> sig 3F6189C8E59B7714 2022-06-07 Carlos Rivero <carlosrivero198@gmail.com> sig 82805738F5FF4457 2022-06-07 Daniel Parrales <daniparrales1@gmail.com> sig EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> sub rsa3072 2022-05-16 [E] [expires: 2024-05-15] sig 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com>","title":"1.3.4"},{"location":"practica-integridad-firmas-autenticacion/#135","text":"Al firmar claves, devolverlas a su due\u00f1o Todas las exporto de esta manera: gpg --export -a carlosrivero198@gmail.com > publiccarlos.key","title":"1.3.5"},{"location":"practica-integridad-firmas-autenticacion/#136","text":"Subir a pgp.rediris.es tu clave cuando tenga tres firmas vagrant@practicafirmas:~$ gpg --keyserver pgp.rediris.es --send-key 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 gpg: sending key 0C3C966CD1DC1A62 to hkp://pgp.rediris.es Muestro las 3 firmas en el keyserver: Rellenar datos de tu clave p\u00fablica aqu\u00ed","title":"1.3.6"},{"location":"practica-integridad-firmas-autenticacion/#137","text":"Bajar las claves p\u00fablicas de tus compa\u00f1eros con tres firmas Todas se bajar\u00e1n de la misma manera: gpg --keyserver pgp.rediris.es --recv-key 3F6189C8E59B7714 IMPORTANTE: AL BAJAR DIRECTAMENTE LAS CLAVES DE ESTA MANERA LAS FIRMAS SE ELIMINAN, AS\u00cd QUE ES MEJOR IMPORTAR LAS CLAVES DESDE UN FICHERO Y AS\u00cd MANTENDREMOS LAS FIRMAS","title":"1.3.7"},{"location":"practica-integridad-firmas-autenticacion/#14","text":"Mostrar las firmas de tu clave p\u00fablica vagrant@practicafirmas:~$ gpg --list-sigs adristudy@gmail.com pub rsa3072 2022-05-16 [SC] [expires: 2024-05-15] 69172731E9645F6ACB60CCBA0C3C966CD1DC1A62 uid [ultimate] Adrian Jaramillo <adristudy@gmail.com> sig 3 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com> sig 3F6189C8E59B7714 2022-06-07 Carlos Rivero <carlosrivero198@gmail.com> sig 82805738F5FF4457 2022-06-07 Daniel Parrales <daniparrales1@gmail.com> sig EB5FEF455BD986A0 2022-06-07 Lara Pruna Ternero <laraprute@gmail.com> sub rsa3072 2022-05-16 [E] [expires: 2024-05-15] sig 0C3C966CD1DC1A62 2022-05-16 Adrian Jaramillo <adristudy@gmail.com>","title":"1.4"},{"location":"practica-integridad-firmas-autenticacion/#15","text":"Comprobar que se puede verificar \"sin problemas\u201d la firma de Carlos, porque ya se conf\u00eda vagrant@practicafirmas:~$ gpg --verify paraadrian.txt.sig paraadrian.txt gpg: Signature made Sun May 15 10:44:25 2022 UTC gpg: using RSA key 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 gpg: Good signature from \"Carlos Rivero <carlosrivero198@gmail.com>\" [full]","title":"1.5"},{"location":"practica-integridad-firmas-autenticacion/#16","text":"Comprobar que puedes verificar con confianza una firma de una persona en la que no conf\u00edas, pero sin embargo si conf\u00eda otra persona en la que tu tienes confianza total En este apartado vamos a intentar verificar una firma de Miguel: -rw-r--r-- 1 vagrant vagrant 16 Jun 8 06:17 paraadriandemiguel.txt -rw-r--r-- 1 vagrant vagrant 438 Jun 8 06:18 paraadriandemiguel.txt.sig Tenemos su clave p\u00fablica firmada por Carlos (en el que confiamos), pero la propia clave de Miguel nosotros no la hemos firmado, por lo que no confiamos: vagrant@practicafirmas:~$ gpg --list-sigs miguelcor.rrs@gmail.com pub rsa3072 2022-06-07 [SC] [expires: 2024-06-06] 5173B9123875E25C833A855307F879A05A4147C3 uid [ undef ] Miguel Cordoba <miguelcor.rrs@gmail.com> sig 3 07F879A05A4147C3 2022-06-07 Miguel Cordoba <miguelcor.rrs@gmail.com> sig 3F6189C8E59B7714 2022-06-07 Carlos Rivero <carlosrivero198@gmail.com> sub rsa3072 2022-06-07 [E] [expires: 2024-06-06] sig 07F879A05A4147C3 2022-06-07 Miguel Cordoba <miguelcor.rrs@gmail.com> Bien, si intentamos verificar la firma de Miguel, \u00bfdeber\u00eda de no haber errores verdad? Porque como dijimos, Carlos firm\u00f3 la de Miguel, y yo conf\u00edo en Carlos. Hagamos la prueba: vagrant@practicafirmas:~$ gpg --verify paraadriandemiguel.txt.sig paraadriandemiguel.txt gpg: Signature made Wed Jun 8 06:15:58 2022 UTC gpg: using RSA key 5173B9123875E25C833A855307F879A05A4147C3 gpg: Good signature from \"Miguel Cordoba <miguelcor.rrs@gmail.com>\" [undefined] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: 5173 B912 3875 E25C 833A 8553 07F8 79A0 5A41 47C3 Error. \u00bfPor qu\u00e9 ha sucedido esto? Pues bien, debemos explicar antes 2 conceptos fundamentales, trust y validity : TRUST : la trust se configura manualmente. Describe si una clave puede firmar otras claves, y que se conf\u00eden en ellas aunque yo directamente no conf\u00ede (permite la confianza en terceros). Ej: Si se conf\u00eda completamente en una persona \"A\", y esa persona firma la clave de una persona \"B\", autom\u00e1ticamente veremos la clave de \"B\" como v\u00e1lida. VALIDITY : la validez en diferencia con la trust, s\u00ed puede ser autom\u00e1tica. Describe si una clave tiene las suficientes firmas para que se pruebe que es la clave correcta (cuando nosotros firmamos una clave, autom\u00e1ticamente la validez pasa a \"full\") Habiendo dicho esto, entonces lo que ha debido pasar es que no tenemos confianza en la clave de Carlos, aunque la validez est\u00e9 a full porque la firmamos en su momento. Es decir, sabemos que la clave de Carlos es de verdad de Carlos, pero no confiamos en que Carlos firme otras claves, y luego nos creamos que esas otras son verdaderas. Vamos a mostrar los datos de la clave de Carlos para comprobar lo ya dicho: vagrant@practicafirmas:~$ gpg --edit-key carlosrivero198@gmail.com gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> gpg> Est\u00e1 ocurriendo tal y como hemos explicado antes, la trust es \"unknown\" y la validity es \"full\". No estamos confiando en las firmas a terceros de Carlos. \u00bfEntonces qu\u00e9 debemos hacer? Cambiar la trust en la clave de Carlos para que confiemos en sus firmas a terceros. Debemos configurar el nivel de trust a 4, o full. Lo hacemos as\u00ed: vagrant@practicafirmas:~$ gpg --edit-key 4E8FF10EDF312F43014B7AE13F6189C8E59B7714 trust gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc. This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: unknown validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> Please decide how far you trust this user to correctly verify other users' keys (by looking at passports, checking fingerprints from different sources, etc.) 1 = I don't know or won't say 2 = I do NOT trust 3 = I trust marginally 4 = I trust fully 5 = I trust ultimately m = back to the main menu Your decision? 4 pub rsa3072/3F6189C8E59B7714 created: 2022-05-15 expires: 2024-05-14 usage: SC trust: full validity: full sub rsa3072/1707D1A73D4578B2 created: 2022-05-15 expires: 2024-05-14 usage: E [ full ] (1). Carlos Rivero <carlosrivero198@gmail.com> Please note that the shown key validity is not necessarily correct unless you restart the program. gpg> quit Ahora la trust est\u00e1 a full como podemos observar. Pues bien, ahora s\u00ed podremos verificar correctamente la firma de Miguel, porque ahora confiamos en las firmas de Carlos a terceros. Por esto, en nuestro listado de claves, ahora la clave de Miguel es confiada de forma full: pub rsa3072 2022-06-07 [SC] [expires: 2024-06-06] 5173B9123875E25C833A855307F879A05A4147C3 uid [ full ] Miguel Cordoba <miguelcor.rrs@gmail.com> sub rsa3072 2022-06-07 [E] [expires: 2024-06-06] Podremos ahora verificar su firma correctamente: vagrant@practicafirmas:~$ gpg --verify paraadriandemiguel.txt.sig paraadriandemiguel.txt gpg: Signature made Wed Jun 8 06:15:58 2022 UTC gpg: using RSA key 5173B9123875E25C833A855307F879A05A4147C3 gpg: Good signature from \"Miguel Cordoba <miguelcor.rrs@gmail.com>\" [full]","title":"1.6"},{"location":"practica-integridad-firmas-autenticacion/#tarea-2-correo-seguro-con-evolution","text":"","title":"Tarea 2: Correo seguro con Evolution"},{"location":"practica-integridad-firmas-autenticacion/#21","text":"Configurar una cuenta de correo sudo apt install evolution Despu\u00e9s de instalarlo y configurarlo, muestro que funciona:","title":"2.1"},{"location":"practica-integridad-firmas-autenticacion/#22","text":"Configurar el firmado de correos con nuestra clave privada Primero tenemos que llegar al men\u00fa correspondiente: Una vez ah\u00ed, indicamos el fingerprint del par de claves con el que queremos firmar: Para que los correos de verdad se firmen al enviarse, tenemos que marcar la siguiente opci\u00f3n antes de enviarlos:","title":"2.2"},{"location":"practica-integridad-firmas-autenticacion/#23","text":"Configurar el cifrado de correos para otros destinatarios Para el cifrado no hace falta que configuremos en Evolution las claves p\u00fablicas, ya que las toma de nuestro keybox autom\u00e1ticamente seg\u00fan la direcci\u00f3n que escribamos en el \"To:\" . Para que los correos de verdad se cifren al enviarse, tenemos que marcar la siguiente opci\u00f3n antes de enviarlos:","title":"2.3"},{"location":"practica-integridad-firmas-autenticacion/#24","text":"Enviar un correo firmado y cifrado a Carlos Este es el correo que enviar\u00e9: Si yo lo intento abrir, no podr\u00e9 ver el contenido ya que no tengo la clave privada de Carlos para desencriptarlo: Este es el correo que le ha llegado a Carlos, desde su punto de vista, y vemos que todo es correcto:","title":"2.4"},{"location":"practica-integridad-firmas-autenticacion/#25","text":"Recibir un correo firmado y cifrado de Carlos Vemos que todo es correcto:","title":"2.5"},{"location":"practica-integridad-firmas-autenticacion/#26","text":"Mandar a Ra\u00fal un correo cifrado y firmado Busco la clave p\u00fablica de Ra\u00fal en RedIRIS y me la bajo (se necesitar\u00e1 para encriptar): atlas@olympus:~$ gpg --keyserver pgp.rediris.es --search-key rruizp@gmail.com gpg: data source: http://130.206.1.8:11371 (1) Ra\u00fal Ruiz Padilla <rruizp@gmail.com> 3072 bit RSA key A036DF623D608DE0, created: 2021-11-10, expires: 2023-11-10 (2) Ra\u00fal Ruiz (Claves para clase) <rruizp@gmail.com> 4096 bit RSA key 334BEE7E18D37DEA, created: 2017-12-16 (3) Raul Ruiz Padilla (Clave para SAD 1617) <rruizp@gmail.com> 4096 bit RSA key F6C88DC57C2FA472, created: 2016-12-11, expires: 2018-12-10 (expired) Keys 1-3 of 3 for \"rruizp@gmail.com\". Enter number(s), N)ext, or Q)uit > 1 gpg: key A036DF623D608DE0: public key \"Ra\u00fal Ruiz Padilla <rruizp@gmail.com>\" imported gpg: Total number processed: 1 gpg: imported: 1 Antes de enviar el correo es importante que dejemos marcada esta opci\u00f3n, para evitar el tener que firmar las claves p\u00fablicas de las personas a quienes queramos enviar: Este es el correo que enviar\u00e9: La parte marcada en rojo quiere decir que el correo se encriptar\u00e1 y firmar\u00e1. \u00bfQU\u00c9 TENDR\u00c1 QUE HACER RA\u00daL PARA LEER ESTE CORREO CORRECTAMENTE? Necesitar\u00e1 2 cosas: La clave privada correspondiente a la p\u00fablica con la que se encript\u00f3 el correo para descifrarlo correctamente. Mi clave p\u00fablica para poder verificar la firma. La podr\u00e1 obtener con el comando gpg --keyserver pgp.rediris.es --search-key adristudy@gmail.com , eligiendo la de fingerprint CA350E4C295E2EF4.","title":"2.6"},{"location":"practica-integridad-firmas-autenticacion/#tarea-3-integridad-de-ficheros","text":"","title":"Tarea 3: Integridad de ficheros"},{"location":"practica-integridad-firmas-autenticacion/#31","text":"Descargar la ISO de Debian wget https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-11.2.0-amd64-netinst.iso Obtengo el fichero: -rw-r--r-- 1 vagrant vagrant 396361728 Dec 18 13:24 debian-11.2.0-amd64-netinst.iso","title":"3.1"},{"location":"practica-integridad-firmas-autenticacion/#32","text":"Comprobar la integridad de la ISO descargada usando sha512sum En el fichero SHA512SUMS que nos proporciona Debian, nos encontramos el siguiente checksum para la ISO descargada: c685b85cf9f248633ba3cd2b9f9e781fa03225587e0c332aef2063f6877a1f0622f56d44cf0690087b0ca36883147ecb5593e3da6f965968402cdbdf12f6dd74 Luego utilizo sha512sum sobre la ISO que me he descargado: sha512sum debian-11.2.0-amd64-netinst.iso c685b85cf9f248633ba3cd2b9f9e781fa03225587e0c332aef2063f6877a1f0622f56d44cf0690087b0ca36883147ecb5593e3da6f965968402cdbdf12f6dd74 debian-11.2.0-amd64-netinst.iso Ambos hashes coinciden, as\u00ed que nos hemos descargado el fichero correctamente. Igualmente, si queremos evitar errores, podemos usar una herramienta online para comparar strings:","title":"3.2"},{"location":"practica-integridad-firmas-autenticacion/#33","text":"Verificar que SHA512SUMS no ha sido manipulado usando SHA512SUMS.sign Primero descargo ambos ficheros: wget https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/SHA512SUMS wget https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/SHA512SUMS.sign Muestro que los tengo: -rw-r--r-- 1 vagrant vagrant 494 Dec 18 20:42 SHA512SUMS -rw-r--r-- 1 vagrant vagrant 833 Dec 18 20:45 SHA512SUMS.sign Averiguo el fingerprint del par de claves que se us\u00f3 originalmente para crear la firma SHA512SUMS.sign : gpg --verify SHA512SUMS.sign No se puede verificar la firma porque no tenemos la clave p\u00fablica de Debian en nuestro keybox, pero ya sabemos su fingerprint para descargarla: gpg --keyserver keyring.debian.org --recv DF9B9C49EAA9298432589D76DA87E80D6294BE9B gpg: key DA87E80D6294BE9B: public key \"Debian CD signing key <debian-cd@lists.debian.org>\" imported gpg: Total number processed: 1 gpg: imported: 1 Finalmente, podemos verificar la firma: gpg --verify SHA512SUMS.sign SHA512SUMS gpg: Signature made Sat Dec 18 20:45:36 2021 UTC gpg: using RSA key DF9B9C49EAA9298432589D76DA87E80D6294BE9B gpg: Good signature from \"Debian CD signing key <debian-cd@lists.debian.org>\" [unknown] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: DF9B 9C49 EAA9 2984 3258 9D76 DA87 E80D 6294 BE9B Se ha podido verificar correctamente, SHA512SUMS es leg\u00edtimo.","title":"3.3"},{"location":"practica-integridad-firmas-autenticacion/#tarea-4-integridad-y-autenticidad-apt-secure","text":"","title":"Tarea 4: Integridad y autenticidad (apt-secure)"},{"location":"practica-integridad-firmas-autenticacion/#41","text":"\u00bfQu\u00e9 herramienta utiliza apt-secure para firmar y verificar firmas? GPG.","title":"4.1"},{"location":"practica-integridad-firmas-autenticacion/#42","text":"\u00bfPara qu\u00e9 sirve apt-key ? Se usa para gestionar la lista de claves que mantiene apt para autenticar paquetes. Los paquetes que sean autenticados usando estas claves se considerar\u00e1n \"trusted\". \u00bfQu\u00e9 muestra el comando apt-key list ? Lista las claves p\u00fablicas en las que confiamos. Muestro mi output de apt-key list : Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)). /etc/apt/trusted.gpg.d/debian-archive-bullseye-automatic.gpg ------------------------------------------------------------ pub rsa4096 2021-01-17 [SC] [expires: 2029-01-15] 1F89 983E 0081 FDE0 18F3 CC96 73A4 F27B 8DD4 7936 uid [ unknown] Debian Archive Automatic Signing Key (11/bullseye) <ftpmaster@debian.org> sub rsa4096 2021-01-17 [S] [expires: 2029-01-15] /etc/apt/trusted.gpg.d/debian-archive-bullseye-security-automatic.gpg --------------------------------------------------------------------- pub rsa4096 2021-01-17 [SC] [expires: 2029-01-15] AC53 0D52 0F2F 3269 F5E9 8313 A484 4904 4AAD 5C5D uid [ unknown] Debian Security Archive Automatic Signing Key (11/bullseye) <ftpmaster@debian.org> sub rsa4096 2021-01-17 [S] [expires: 2029-01-15] /etc/apt/trusted.gpg.d/debian-archive-bullseye-stable.gpg --------------------------------------------------------- pub rsa4096 2021-02-13 [SC] [expires: 2029-02-11] A428 5295 FC7B 1A81 6000 62A9 605C 66F0 0D6C 9793 uid [ unknown] Debian Stable Release Key (11/bullseye) <debian-release@lists.debian.org> /etc/apt/trusted.gpg.d/debian-archive-buster-automatic.gpg ---------------------------------------------------------- pub rsa4096 2019-04-14 [SC] [expires: 2027-04-12] 80D1 5823 B7FD 1561 F9F7 BCDD DC30 D7C2 3CBB ABEE uid [ unknown] Debian Archive Automatic Signing Key (10/buster) <ftpmaster@debian.org> sub rsa4096 2019-04-14 [S] [expires: 2027-04-12] /etc/apt/trusted.gpg.d/debian-archive-buster-security-automatic.gpg ------------------------------------------------------------------- pub rsa4096 2019-04-14 [SC] [expires: 2027-04-12] 5E61 B217 265D A980 7A23 C5FF 4DFA B270 CAA9 6DFA uid [ unknown] Debian Security Archive Automatic Signing Key (10/buster) <ftpmaster@debian.org> sub rsa4096 2019-04-14 [S] [expires: 2027-04-12] /etc/apt/trusted.gpg.d/debian-archive-buster-stable.gpg ------------------------------------------------------- pub rsa4096 2019-02-05 [SC] [expires: 2027-02-03] 6D33 866E DD8F FA41 C014 3AED DCC9 EFBF 77E1 1517 uid [ unknown] Debian Stable Release Key (10/buster) <debian-release@lists.debian.org> /etc/apt/trusted.gpg.d/debian-archive-stretch-automatic.gpg ----------------------------------------------------------- pub rsa4096 2017-05-22 [SC] [expires: 2025-05-20] E1CF 20DD FFE4 B89E 8026 58F1 E0B1 1894 F66A EC98 uid [ unknown] Debian Archive Automatic Signing Key (9/stretch) <ftpmaster@debian.org> sub rsa4096 2017-05-22 [S] [expires: 2025-05-20] /etc/apt/trusted.gpg.d/debian-archive-stretch-security-automatic.gpg -------------------------------------------------------------------- pub rsa4096 2017-05-22 [SC] [expires: 2025-05-20] 6ED6 F5CB 5FA6 FB2F 460A E88E EDA0 D238 8AE2 2BA9 uid [ unknown] Debian Security Archive Automatic Signing Key (9/stretch) <ftpmaster@debian.org> sub rsa4096 2017-05-22 [S] [expires: 2025-05-20] /etc/apt/trusted.gpg.d/debian-archive-stretch-stable.gpg -------------------------------------------------------- pub rsa4096 2017-05-20 [SC] [expires: 2025-05-18] 067E 3C45 6BAE 240A CEE8 8F6F EF0F 382A 1A7B 6500 uid [ unknown] Debian Stable Release Key (9/stretch) <debian-release@lists.debian.org>","title":"4.2"},{"location":"practica-integridad-firmas-autenticacion/#43","text":"\u00bfD\u00f3nde se encuentran los distintos keyrings que usa apt-key ? En /etc/apt/trusted.gpg.d/ .","title":"4.3"},{"location":"practica-integridad-firmas-autenticacion/#44","text":"\u00bfQu\u00e9 contiene el fichero Release de un repositorio? En otros datos, contiene los checksums de los ficheros que hay en el repositorio. Ejemplo: http://ftp.debian.org/debian/dists/Debian11.2/Release \u00bfY Release.gpg ? Contiene la firma detached ascii-armored del fichero Release . Ejemplo: http://ftp.debian.org/debian/dists/Debian11.2/Release.gpg","title":"4.4"},{"location":"practica-integridad-firmas-autenticacion/#45","text":"Explicar el proceso por el cual apt nos asegura que los ficheros que estamos descargando son leg\u00edtimos Se descargan los ficheros Release , Release.gpg , y el fichero Packages que corresponda. Se comprueba usando la firma Release.gpg m\u00e1s la clave p\u00fablica correspondiente, que el fichero Release es leg\u00edtimo. A partir de aqu\u00ed, apt ya conf\u00eda en todos sus checksums. Apt compara el checksum del fichero Packages con el que encuentra en el fichero Release ; si coinciden, quiere decir que se descarg\u00f3 el fichero correcto. Al descargarnos un paquete individual se compara su checksum con el que aparece en Packages ; si coinciden, quiere decir que se descarg\u00f3 el paquete correcto.","title":"4.5"},{"location":"practica-integridad-firmas-autenticacion/#46","text":"A\u00f1adir el repositorio de VirtualBox A\u00f1ado las claves gpg necesarias: wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add - wget -q https://www.virtualbox.org/download/oracle_vbox.asc -O- | sudo apt-key add - A\u00f1ado el repositorio: echo \"deb [arch=amd64] http://download.virtualbox.org/virtualbox/debian bullseye contrib\" | sudo tee /etc/apt/sources.list.d/virtualbox.list","title":"4.6"},{"location":"practica-integridad-firmas-autenticacion/#tarea-5-autenticacion-en-ssh","text":"","title":"Tarea 5: Autenticaci\u00f3n en SSH"},{"location":"practica-integridad-firmas-autenticacion/#51","text":"Explicar qu\u00e9 sucede entre el cliente y el servidor para que se cifre la comunicaci\u00f3n Una sesi\u00f3n SSH tiene 2 fases antes de que se pueda cifrar la comunicaci\u00f3n. Las explicar\u00e9 a continuaci\u00f3n. CONEXI\u00d3N El cliente establece una conexi\u00f3n TCP con el servidor, y este responde con las versiones del protocolo que soporta. Si el cliente usa una versi\u00f3n del protocolo que coincida con las que acepta el servidor, la conexi\u00f3n contin\u00faa. El servidor comparte su clave p\u00fablica con el cliente, para que este compruebe si efectivamente es la m\u00e1quina a la que quer\u00eda conectarse. A partir de ahora, ambas partes est\u00e1n preparadas para la negociaci\u00f3n de una clave de sesi\u00f3n usando Diffie-Hellman. NEGOCIACI\u00d3N DE LA ENCRIPTACI\u00d3N PARA LA SESI\u00d3N Ambas partes se ponen de acuerdo en un n\u00famero primo alto, que servir\u00e1 como \"seed value\". Ambas partes se ponen de acuerdo en un tipo de cifrado (normalmente AES). Ambas partes generan otro n\u00famero primo por separado, que mantienen en secreto de la otra parte. Se usar\u00e1 como clave privada durante esta fase de negociaci\u00f3n (esta clave privada NO es la misma que se usa para la autenticaci\u00f3n) . La clave privada generada + el tipo de cifrado + el n\u00famero primo compartido, se usar\u00e1n para generar una clave p\u00fablica que estar\u00e1 derivada de la clave privada. Ambas partes intercambian sus claves p\u00fablicas generadas (estas claves p\u00fablicas NO son las mismas que se usan para la autenticaci\u00f3n) . Cada parte usar\u00e1 su clave privada + la clave p\u00fablica de la otra parte + el n\u00famero primo compartido original, para calcular una clave compartida \"shared secret\". Aunque este proceso lo realiza cada parte por separado, mientras se usen claves p\u00fablicas y privadas opuestas, se llegar\u00e1 al mismo \"shared secret\". Este \"shared secret\" se usar\u00e1 para encriptar toda comunicaci\u00f3n a partir de ahora. Es una clave sim\u00e9trica. \u00bfPara qu\u00e9 se utiliza la criptograf\u00eda sim\u00e9trica? Para encriptar las conexiones, mediante el uso de una clave secreta. Esta se genera a trav\u00e9s de un proceso llamado \"key exchange algorithm\", y es \u00fanica por sesi\u00f3n. En cuanto ambas partes la sepan, el resto de la sesi\u00f3n se encriptar\u00e1 usando esta clave. \u00bfY la asim\u00e9trica? Se usa: Durante el intercambio de clave para la encriptaci\u00f3n sim\u00e9trica. Ambas partes generan un par de claves temporal e intercambian la clave p\u00fablica para poder generar el \"shared secret\" (clave sim\u00e9trica) que se usar\u00e1 posteriormente. En la autenticaci\u00f3n del cliente con el servidor.","title":"5.1"},{"location":"practica-integridad-firmas-autenticacion/#52","text":"Explicar los dos m\u00e9todos de autenticaci\u00f3n que existen.","title":"5.2"},{"location":"practica-integridad-firmas-autenticacion/#con-contrasena","text":"Es el m\u00e9todo m\u00e1s simple. Funciona as\u00ed: El servidor pide al cliente que introduzca la contrase\u00f1a del usuario con el que se est\u00e1n intentando conectar. Esta contrase\u00f1a se env\u00eda usando la encriptaci\u00f3n previamente negociada, para que se mantenga en secreto frente a terceros.","title":"Con contrase\u00f1a"},{"location":"practica-integridad-firmas-autenticacion/#con-par-de-claves","text":"Es el m\u00e9todo m\u00e1s popular y recomendado. Funciona as\u00ed: El cliente env\u00eda el ID del par de claves con el que se quiere autenticar ante el servidor. El servidor comprueba el fichero authorized_keys del usuario al que el cliente est\u00e1 intentando conectarse, para comprobar si existe la clave correspondiente al ID que envi\u00f3 el cliente en el paso anterior. Si se encuentra una clave p\u00fablica que corresponda con el ID enviado, el servidor genera un n\u00famero aleatorio y usa esa clave p\u00fablica para encriptarlo. El servidor env\u00eda al cliente este n\u00famero encriptado. Si el cliente tiene la clave privada asociada, podr\u00e1 desencriptar este mensaje y revelar el n\u00famero original. El cliente combina el n\u00famero desencriptado con la clave compartida de sesi\u00f3n que se est\u00e1 usando para encriptar la comunicaci\u00f3n, y calcula el hash MD5 de este valor. El cliente env\u00eda este hash de vuelta al servidor como respuesta al mensaje del n\u00famero encriptado. El servidor usa la misma clave compartida de sesi\u00f3n junto con el n\u00famero original que envi\u00f3 al cliente, y calcula el hash MD5 \u00e9l tambi\u00e9n. El servidor compara el hash que \u00e9l mismo gener\u00f3 con el que el cliente le envi\u00f3. Si estos valores son iguales, se prueba que el cliente tiene la clave privada correcta y finalmente, este cliente es autenticado correctamente.","title":"Con par de claves"},{"location":"practica-integridad-firmas-autenticacion/#53","text":"Explicar la funci\u00f3n del fichero ~/.ssh/known_hosts Es un fichero de cliente que contiene todas las claves p\u00fablicas de los servidores a los que nos conectamos. El cliente SSH usa este fichero para autenticar los servidores a los que se conecta.","title":"5.3"},{"location":"practica-integridad-firmas-autenticacion/#54","text":"Explicar el significado del siguiente mensaje que aparece la primera vez que nos conectamos a un servidor $ ssh debian@172.22.200.74 The authenticity of host '172.22.200.74 (172.22.200.74)' can't be established. ECDSA key fingerprint is SHA256:7ZoNZPCbQTnDso1meVSNoKszn38ZwUI4i6saebbfL4M. Are you sure you want to continue connecting (yes/no)? Nos indica que, al ser la primera vez que nos estamos conectando a este servidor, a\u00fan no tenemos su clave p\u00fablica almacenada en el fichero ~/.ssh/known_hosts . Por lo tanto, a\u00fan \"no podemos\" verificar la autenticidad del mismo. Si estamos seguros de su autenticidad, diremos que s\u00ed, y eso almacenar\u00e1 su clave p\u00fablica en ~/.ssh/known_hosts .","title":"5.4"},{"location":"practica-integridad-firmas-autenticacion/#55","text":"\u00bfQu\u00e9 significa el siguiente mensaje que aparece cuando reutilizamos una ip? $ ssh debian@172.22.200.74 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY! Someone could be eavesdropping on you right now (man-in-the-middle attack)! It is also possible that a host key has just been changed. The fingerprint for the ECDSA key sent by the remote host is SHA256:W05RrybmcnJxD3fbwJOgSNNWATkVftsQl7EzfeKJgNc. Please contact your system administrator. Add correct host key in /home/jose/.ssh/known_hosts to get rid of this message. Offending ECDSA key in /home/jose/.ssh/known_hosts:103 remove with: ssh-keygen -f \"/home/jose/.ssh/known_hosts\" -R \"172.22.200.74\" ECDSA host key for 172.22.200.74 has changed and you have requested strict checking. Este mensaje simplemente indica que la clave p\u00fablica del servidor al que nos estamos intentando conectar ha cambiado con respecto a la clave que ten\u00edamos guardada para esa IP en nuestro known_hosts previamente. Se nos avisa porque es una forma de ataque man-in-the-middle, pero si estamos seguros de que somos nosotros mismos reutilizando una IP, simplemente borraremos la l\u00ednea correspondiente en nuestro known_hosts sobre la antigua conexi\u00f3n y volveremos a conectarnos.","title":"5.5"},{"location":"practica-integridad-firmas-autenticacion/#56","text":"\u00bfQu\u00e9 guardamos y para qu\u00e9 sirve el fichero en el servidor ~/.ssh/authorized_keys ? Este es un fichero de servidor, diferente por cada usuario del sistema, y guarda todas las claves p\u00fablicas de clientes permitidos para conectarse. Sirve para que el servidor verifique que los clientes conect\u00e1ndose sean leg\u00edtimos (que tengan la clave privada correspondiente).","title":"5.6"},{"location":"practica-servidor-correo/","text":"Pr\u00e1ctica: Servidor de correos en VPS Pasos previos Instalo postfix: sudo apt update sudo apt install postfix Selecciono \"Internet Site\": Escribo mi nombre de dominio. Se tomar\u00e1 como dominio origen de los correos que se env\u00eden desde el vps ( myorigin = /etc/mailname ) : Instalo mailutils : sudo apt install mailutils Gesti\u00f3n de correos desde el servidor Tarea 1 1.1 Crear registro SPF en el DNS 1.2 Enviar un correo desde la vps a gmail blackmamba@kampe:~$ mail -r blackmamba@adrianjaramillo.tk adristudy@gmail.com Cc: Subject: Correo con SPF Mensaje 1.3 Mostrar /var/log/mail.log para verificar que el correo se ha enviado correctamente L\u00ednea relevante: Feb 14 16:20:33 kampe postfix/smtp[516217]: 242F742268: to=<adristudy@gmail.com>, relay=gmail-smtp-in.l.google.com[64.233.167.26]:25, delay=1.3, delays=0.03/0.01/0.29/0.95, dsn=2.0.0, status=sent (250 2.0.0 OK 1644855633 l11si9233120wms.107 - gsmtp) 1.4 Mostrar el correo recibido en gmail Para estar seguros de que este correo ha llegado con SPF v\u00e1lido, tenemos que mostrar el correo original: Ha pasado el checkeo SPF, pero si queremos ver informaci\u00f3n a\u00fan m\u00e1s espec\u00edfica, podemos hacer scroll al contenido en bruto del correo recibido: Al ver eso, queda totalmente claro que el checkeo SPF ha sido exitoso. Tarea 2 2.1 Crear registro MX y CNAME correspondiente en el DNS 2.2 Habilitar en el firewall del vps el tr\u00e1fico entrante al puerto 25 2.3 Enviar un correo desde gmail a la vps 2.4 Comprobar que la vps ha recibido correctamente el correo mirando /var/log/mail.log 2.5 Mostrar el correo recibido blackmamba@kampe:~$ mail \"/var/mail/blackmamba\": 1 message 1 new > N 1 adristudy Mon Feb 14 18 :17 52 /2630 Correo para la VPS ? 1 Return-Path: <adristudy@gmail.com> X-Original-To: blackmamba@adrianjaramillo.tk Delivered-To: blackmamba@adrianjaramillo.tk Received: from mail-pl1-f176.google.com (mail-pl1-f176.google.com [209.85.214.176]) by kampe.adrianjaramillo.tk (Postfix) with ESMTPS id 4F393422CB for <blackmamba@adrianjaramillo.tk>; Mon, 14 Feb 2022 18:17:40 +0000 (UTC) Received: by mail-pl1-f176.google.com with SMTP id l8so5186364pls.7 for <blackmamba@adrianjaramillo.tk>; Mon, 14 Feb 2022 10:17:40 -0800 (PST) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112; h=mime-version:from:date:message-id:subject:to; bh=MudV18FBtYjZJPFyKfQ5hC6U6ERmLoC4WY7BpsZqJUs=; b=hpLYd8Radagaj5ilgByYq41SIVkdDFuM28I2tHi2qxE6yANOJnGC22x6FepMkW/ur3 2iqHhmlw72u8he4u1VNxYsP3xCORcgx77iI3nxCkAYG7l9Tx6L7cScNNBMmsgfzP0Xp2 ukKClt9Nc38F0xHSwF1qKrpie4OsxxB+blYUnUzx5SvUl18WtuHjfxLHM2cPpueYrYvc Ls0dR/Hyt9pWXEthi9ueHnWTprlauAdxKANUJMnbYA1C5z6YH0F+i/6NnHa96ZQ2E2Dv JrRzfqVYRwNwDzQAHa5ViqbgyepDPLmu9gnbytlfJCoQSrAs9diH/8gLU7b3ymnlkxQS HkNg== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20210112; h=x-gm-message-state:mime-version:from:date:message-id:subject:to; bh=MudV18FBtYjZJPFyKfQ5hC6U6ERmLoC4WY7BpsZqJUs=; b=VUVBAkMaD/qnhm92cnmVBYhTFj0HuNxKqtgGNEVlEge780WB2QaXPMtaSMGSz77aHc nC3VQvj18EtItjtccAywt/FLLqP4ucH2gcellCvn0UreOCFoP8v7RaZTMYG4RBYrCOMD WKGXOXO2ay9fsCIQSNp429tQnRumifl3XaVMfy3jSZAbt1HUghtRP2VgE6Y/SLz5Lmkq NKEFW1u4IHqk8aXvM1cBzD6szJvPs5LSJjkmNuq/k/P+kH1QWQhrvs85Lyxzfgo3RSj+ qIG6+H1TK4JI3bBMbhwEiiapEJOVYj2DsGmeSoDTvNChGryidxJMQqpDTdz3mZ+ZE37K bWxA== X-Gm-Message-State: AOAM530YXJN7SPi6YOZ/UjMpMOMY71KTCE4ZLpC/AcW60wbzOkjuyN9M fWHiGc3H9WbfeAMOAzOBkY8vtybUr+Pw96kZMXAREDN/ X-Google-Smtp-Source: ABdhPJz6Vyx6fBNDRDGMOl88iRuxk0moB4G3eJTCNLmoXHc1ZDYlXFgmJdhK8aHYgutvtMLZmiO1TJ06tqf6XTu1iHA= X-Received: by 2002:a17:90a:2e0a:: with SMTP id q10mr1050878pjd.130.1644862658470; Mon, 14 Feb 2022 10:17:38 -0800 (PST) MIME-Version: 1.0 From: adristudy <adristudy@gmail.com> Date: Mon, 14 Feb 2022 19:17:27 +0100 Message-ID: <CAG5uPRccDy2iqjcOTT29ekY6tNCcnsgy0VsA5pXjzdm7KCcLgw@mail.gmail.com> Subject: Correo para la VPS To: blackmamba@adrianjaramillo.tk Content-Type: multipart/alternative; boundary=\"00000000000076676e05d7fe6ef6\" --00000000000076676e05d7fe6ef6 Content-Type: text/plain; charset=\"UTF-8\" Prueba --00000000000076676e05d7fe6ef6 Content-Type: text/html; charset=\"UTF-8\" <div dir=\"ltr\">Prueba</div> --00000000000076676e05d7fe6ef6-- Tarea 3: Uso de alias y redirecciones 3.1 Crear tarea cron Abro la configuraci\u00f3n: crontab -e A\u00f1ado lo siguiente: MAILTO = root * * * * * echo Prueba de mensajes crontab Esta tarea ejecuta un echo cada minuto y env\u00eda un correo a root con el resultado. No vemos ese echo por terminal ni en la sesi\u00f3n de nuestro usuario ni en la de root, pero nos sirve para hacer pruebas. 3.2 Comprobar que llegan correos en root root@kampe:~# mail \"/var/mail/root\": 64 messages 64 unread > U 1 Cron Daemon Mon Feb 14 21 :20 23 /788 Cron <blackmamba@kampe> echo Prueba de mensajes crontab U 2 Cron Daemon Mon Feb 14 21:21 22/762 Cron <blackmamba@kampe> echo Prueba de mensajes crontab U 3 Cron Daemon Mon Feb 14 21:22 22/762 Cron <blackmamba@kampe> echo Prueba de mensajes crontab U 4 Cron Daemon Mon Feb 14 21:23 22/762 Cron <blackmamba@kampe> echo Prueba de mensajes crontab Son todos iguales, as\u00ed que muestro uno de ellos: La parte que nos interesa es la marcada, el \"From\" y el \"To\". Los correos los env\u00eda el daemon de Cron usando root, hacia el usuario root. En el cuerpo del correo est\u00e1 el resultado del echo. Seg\u00fan como est\u00e1 ahora configurado cron, no nos llegar\u00edan esos correos a nuestro usuario. 3.3 Crear un alias para que lleguen los correos a blackmamba Modifico /etc/aliases : # See man 5 aliases for format postmaster: root root: blackmamba Para que este cambio tome efecto ejecuto: sudo newaliases 3.4 Comprobar que ya llegan los correos a blackmamba blackmamba@kampe:~$ mail \"/var/mail/blackmamba\": 1 message 1 new > N 1 Cron Daemon Mon Feb 14 22 :59 20 /743 Cron <blackmamba@kampe> echo Prueba de mensajes crontab ? Lo abro: ? 1 Return-Path: <blackmamba@adrianjaramillo.tk> X-Original-To: root Delivered-To: root@adrianjaramillo.tk Received: by kampe.adrianjaramillo.tk (Postfix, from userid 1000) id BC48442AC0; Mon, 14 Feb 2022 22:59:01 +0000 (UTC) From: root@adrianjaramillo.tk (Cron Daemon) To: root@adrianjaramillo.tk Subject: Cron <blackmamba@kampe> echo Prueba de mensajes crontab MIME-Version: 1.0 Content-Type: text/plain; charset=UTF-8 Content-Transfer-Encoding: 8bit X-Cron-Env: <MAILTO=root> X-Cron-Env: <SHELL=/bin/sh> X-Cron-Env: <HOME=/home/blackmamba> X-Cron-Env: <PATH=/usr/bin:/bin> X-Cron-Env: <LOGNAME=blackmamba> Message-Id: <20220214225901.BC48442AC0@kampe.adrianjaramillo.tk> Date: Mon, 14 Feb 2022 22:59:01 +0000 (UTC) Prueba de mensajes crontab ? He mostrado el contenido para que se vea el campo \"To:\", que apunta a root, pero el alias funciona as\u00ed que me llega a mi usuario principal blackmamba . 3.5 Crear una redirecci\u00f3n para enviar esos correos a gmail Creo /home/blackmamba/.forward con el siguiente contenido: adristudy@gmail.com Veo en gmail que me est\u00e1n llegando: Tarea 4: Para asegurar el env\u00edo (opcional) Configurar postfix con opendkim para firmar los correos que env\u00eda. 4.1 Pasos iniciales Instalo los paquetes: sudo apt install opendkim opendkim-tools A\u00f1ado el usuario postfix al grupo opendkim: sudo gpasswd -a postfix opendkim 4.2 Configuraci\u00f3n OpenDKIM /etc/opendkim.conf : # This is a basic configuration for signing and verifying. It can easily be # adapted to suit a basic installation. See opendkim.conf ( 5 ) and # /usr/share/doc/opendkim/examples/opendkim.conf.sample for complete # documentation of available configuration parameters. Syslog yes SyslogSuccess yes # LogWhy no # Common signing and verification parameters. In Debian, the \"From\" header is # oversigned, because it is often the identity key used by reputation systems # and thus somewhat security sensitive. Canonicalization relaxed/simple Mode s SubDomains no OversignHeaders From # Signing domain, selector, and key ( required ) . For example, perform signing # for domain \"example.com\" with selector \"2020\" ( 2020 ._domainkey.example.com ) , # using the private key stored in /etc/dkimkeys/example.private. More granular # setup options can be found in /usr/share/doc/opendkim/README.opendkim. # Domain example.com # Selector 2020 # KeyFile /etc/dkimkeys/example.private # In Debian, opendkim runs as user \"opendkim\" . A umask of 007 is required when # using a local socket with MTAs that access the socket as a non-privileged # user ( for example, Postfix ) . You may need to add user \"postfix\" to group # \"opendkim\" in that case . UserID opendkim UMask 007 # Socket for the MTA connection ( required ) . If the MTA is inside a chroot jail, # it must be ensured that the socket is accessible. In Debian, Postfix runs in # a chroot in /var/spool/postfix, therefore a Unix socket would have to be # configured as shown on the last line below. # Socket local:/run/opendkim/opendkim.sock # Socket inet:8891@localhost # Socket inet:8891 Socket local:/var/spool/postfix/opendkim/opendkim.sock PidFile /run/opendkim/opendkim.pid # Hosts for which to sign rather than verify, default is 127 .0.0.1. See the # OPERATION section of opendkim ( 8 ) for more information. # InternalHosts 192 .168.0.0/16, 10 .0.0.0/8, 172 .16.0.0/12 # The trust anchor enables DNSSEC. In Debian, the trust anchor file is provided # by the package dns-root-data. TrustAnchorFile /usr/share/dns/root.key # Nameservers 127 .0.0.1 # Map domains in From addresses to keys used to sign messages KeyTable refile:/etc/opendkim/key.table SigningTable refile:/etc/opendkim/signing.table 4.3 Creaci\u00f3n de Signing y Key Table Creo la estructura de directorios para las claves: sudo mkdir -p /etc/opendkim/keys Modifico propietarios y permisos: sudo chown -R opendkim:opendkim /etc/opendkim sudo chmod go-rw /etc/opendkim/keys Creo la signing table... sudo touch /etc/opendkim/signing.table ...con el siguiente contenido: *@adrianjaramillo.tk default._domainkey.adrianjaramillo.tk Creo la key table... sudo touch /etc/opendkim/key.table ...con el siguiente contenido: default._domainkey.adrianjaramillo.tk adrianjaramillo.tk:default:/etc/opendkim/keys/adrianjaramillo.tk/default.private 4.4 Generaci\u00f3n de claves Creo un directorio para las claves del dominio: sudo mkdir /etc/opendkim/keys/adrianjaramillo.tk Genero las claves... sudo opendkim-genkey -b 2048 -d adrianjaramillo.tk -D /etc/opendkim/keys/adrianjaramillo.tk -s default -v ...y este es el output: opendkim-genkey: generating private key opendkim-genkey: private key written to default.private opendkim-genkey: extracting public key opendkim-genkey: DNS TXT record written to default.txt Cambio los propietarios de la clave privada: sudo chown opendkim:opendkim /etc/opendkim/keys/adrianjaramillo.tk/default.private Compruebo que los permisos de la clave privada son correctos: -rw------- 1 opendkim opendkim 1679 Mar 7 19:57 /etc/opendkim/keys/adrianjaramillo.tk/default.private 4.5 Publicaci\u00f3n de la clave p\u00fablica en mi DNS La clave p\u00fablica generada se encuentra en el fichero /etc/opendkim/keys/adrianjaramillo.tk/default.txt .: default._domainkey IN TXT ( \"v=DKIM1; h=sha256; k=rsa; \" \"p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA66vm0/BhAdiyHkYz/AcaWPkUbnTXOlxCxKZQP3skWmCI5fZSBfwJpndYg1C05UyiCh3qsVXXnOZsiRoKK09vzDobKFw2ngRA5y3vTPKufY/Va/VNfNRdXd8fhUjffnAbxQ231WyTqHNrb2XjXoTY8/QBy/2Hexg1f7zZ4PqcM5+L6kzCGtzPJ0m7MfWCL6HQCbg82JX0aywITl\" \"sKhieEJg0WXHnzX/wYD4rreOxG05QCfIT7zWMamJdaDfEuua8qLMdPnb714MnTq1zPizBQ+YEDkFKwSDkaeKRq44CBYjjZ+ma9yI7PMwYQ+LEkA0kKtFm8IaQMoAyMQQcF0dzIwQIDAQAB\" ) ; ----- DKIM key default for adrianjaramillo.tk La string que aparece despu\u00e9s de la p es mi clave p\u00fablica. \u00bfC\u00f3mo la publicamos? En nuestro DNS tenemos que crear un registro TXT con nombre default._domainkey y valor todo lo que haya entre par\u00e9ntesis del fichero que acabo de mostrar. IMPORTANTE: tenemos que eliminar todas las comillas dobles y espacios no necesarios. La string de la clave p\u00fablica por alguna raz\u00f3n la parte en 2, pero hay que unirla . Es decir, el valor final se nos quedar\u00eda as\u00ed: v=DKIM1; h=sha256; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA66vm0/BhAdiyHkYz/AcaWPkUbnTXOlxCxKZQP3skWmCI5fZSBfwJpndYg1C05UyiCh3qsVXXnOZsiRoKK09vzDobKFw2ngRA5y3vTPKufY/Va/VNfNRdXd8fhUjffnAbxQ231WyTqHNrb2XjXoTY8/QBy/2Hexg1f7zZ4PqcM5+L6kzCGtzPJ0m7MfWCL6HQCbg82JX0aywITlsKhieEJg0WXHnzX/wYD4rreOxG05QCfIT7zWMamJdaDfEuua8qLMdPnb714MnTq1zPizBQ+YEDkFKwSDkaeKRq44CBYjjZ+ma9yI7PMwYQ+LEkA0kKtFm8IaQMoAyMQQcF0dzIwQIDAQAB Muestro que he creado dicho registro en mi DNS: 4.6 Testeo de la clave p\u00fablica Uso el siguiente comando: sudo opendkim-testkey -d adrianjaramillo.tk -s default -vvv Si todo funciona, deber\u00edamos de obtener un \"Key OK\": opendkim-testkey: using default configfile /etc/opendkim.conf opendkim-testkey: checking key 'default._domainkey.adrianjaramillo.tk' opendkim-testkey: key not secure opendkim-testkey: key OK Este comando lo que hace realmente es una consulta DNS. Se compara la clave privada que tenemos configurada con la p\u00fablica que aparece en el DNS, y se verifica si efectivamente ambas claves son del mismo par. Aparece \"key not secure\" pero de esto no tenemos que preocuparnos, simplemente significa que no tenemos habilitado DNSSEC en nuestro dominio. Por lo que he investigado, freenom no lo soporta. Tambi\u00e9n podemos usar la web https://mxtoolbox.com/dkim.aspx para comprobar el registro DKIM. Importante que escribamos nuestro selector correctamente: Vemos que el registro DKIM publicado en mi DNS es v\u00e1lido: 4.7 Configuraci\u00f3n de Postfix con OpenDKIM Creo el directorio donde se crear\u00e1 el socket de OpenDKIM: sudo mkdir /var/spool/postfix/opendkim Modifico los propietarios: sudo chown opendkim:postfix /var/spool/postfix/opendkim Modifico /etc/opendkim.conf para cambiar el socket que utiliza. Comento la l\u00ednea: Socket local:/run/opendkim/opendkim.sock Y descomento la l\u00ednea: Socket local:/var/spool/postfix/opendkim/opendkim.sock Por \u00faltimo, a\u00f1ado lo siguiente al final de /etc/postfix/main.cf : # Milter configuration smtpd_milters = local:opendkim/opendkim.sock non_smtpd_milters = $smtpd_milters milter_default_action = accept milter_protocol = 6 4.8 Reinicio de servicios sudo systemctl restart opendkim postfix 4.9 Comprobaciones Tras haberme enviado un correo a gmail, muestro el original para ver que haya pasado el chequeo DKIM: En el correo en crudo vemos que tenemos un campo de firma DKIM: Tambi\u00e9n podemos mirar /var/log/mail.log filtrando por dkim para ver que se realiza la firma: Gesti\u00f3n de correos desde un cliente Tarea 8 8.1 Borrar el fichero .forward anteriormente creado rm .forward Es obligatorio que borremos este fichero para que lo que hagamos durante esta tarea funcione, y los correos lleguen a Maildir correctamente. \u00bfPor qu\u00e9? El fichero .forward tiene el siguiente funcionamiento: Es decir, si tenemos un fichero .forward no podremos recibir ning\u00fan correo en usuarios locales . 8.2 Configurar postfix con buz\u00f3n Maildir A\u00f1ado lo siguiente a /etc/postfix/main.cf : home_mailbox = Maildir/ Reinicio postfix: sudo systemctl restart postfix 8.3 Enviar un correo a blackmamba Hago la prueba: blackmamba@kampe:~$ mail -r blackmamba@localhost blackmamba@localhost Cc: Subject: Prueba Maildir Mensaje 8.4 Comprobar que el correo se ha guardado en el buz\u00f3n Maildir Primero compruebo /var/log/mail.log para ver que haya llegado correctamente: \"delivered to maildir\" significa que ha funcionado correctamente. Lo siguiente a comprobar es la estructura de Maildir que se nos ha generado en el home: blackmamba@kampe:~$ tree Maildir/ Maildir/ |-- cur |-- new | `-- 1644944881.Vfe01I605c1M715492.kampe `-- tmp 3 directories, 1 file \u00a1Atenci\u00f3n! NO TENEMOS que crear esta estructura de directorios manualmente para que funcione, lo hace postfix. 8.5 Visualizar el correo recibido en Maildir Podr\u00edamos perfectamente abrir manualmente los ficheros con cat , pero esto es rudimentario, usaremos la herramienta mail . Seg\u00fan se dice en la gu\u00eda de Jos\u00e9 Domingo, desde que usamos Maildir como buz\u00f3n ya no podremos visualizar los correos con mail . Esto es cierto si ejecutamos el comando sin argumentos: blackmamba@kampe:~$ mail No mail for blackmamba PERO podemos hacer lo siguiente: blackmamba@kampe:~$ mail -f Maildir \"/home/blackmamba/Maildir\": 1 message 1 new > N 1 blackmamba@localho Tue Feb 15 17 :08 13 /459 Prueba Maildir ? 1 Return-Path: <blackmamba@localhost> X-Original-To: blackmamba@localhost Delivered-To: blackmamba@localhost Received: by kampe.adrianjaramillo.tk (Postfix, from userid 1000) id A9FDB42CF6; Tue, 15 Feb 2022 17:08:01 +0000 (UTC) To: <blackmamba@localhost> Subject: Prueba Maildir X-Mailer: mail (GNU Mailutils 3.10) Message-Id: <20220215170801.A9FDB42CF6@kampe.adrianjaramillo.tk> Date: Tue, 15 Feb 2022 17:08:01 +0000 (UTC) From: blackmamba@localhost Mensaje ? Indicando la ruta de Maildir con mail -f nos posibilita ver los correos perfectamente. Muestro el man de mail para un mejor entendimiento: Tarea 9 9.1 Instalar Dovecot para ofrecer el protocolo IMAPS sudo apt install dovecot-imapd Lo primero que podemos ver es que estar\u00e1 escuchando en el puerto que necesitamos: Tenemos que permitir ese tr\u00e1fico en el firewall de la vps: Hacemos una primera prueba de comunicaci\u00f3n con el puerto desde nuestro host: atlas@olympus:~$ telnet 87 .106.228.149 993 Trying 87.106.228.149... Connected to 87.106.228.149. Escape character is '^]'. 9.2 Configurar Dovecot para que use el buz\u00f3n Maildir Modifico /etc/dovecot/conf.d/10-mail.conf : mail_location = maildir:~/Maildir Reinicio dovecot: sudo systemctl restart dovecot 9.3 Configurar el cifrado de la comunicaci\u00f3n por IMAPS en Dovecot con certificado. Usar el wildcard *.adrianjaramillo.tk que ya ten\u00edamos. Modifico /etc/dovecot/conf.d/10-ssl.conf : # # # # SSL settings # # # SSL/TLS support: yes, no, required. <doc/wiki/SSL.txt> ssl = yes # PEM encoded X.509 SSL/TLS certificate and private key. They ' re opened before # dropping root privileges, so keep the key file unreadable by anyone but # root. Included doc/mkcert.sh can be used to easily generate self-signed # certificate, just make sure to update the domains in dovecot-openssl.cnf ssl_cert = </etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem ssl_key = </etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem S\u00f3lo muestro el principio del fichero, porque es lo que he modificado. Reinicio dovecot: sudo systemctl restart dovecot 9.4 Configurar evolution para recibir los correos del vps Abro la configuraci\u00f3n para una nueva cuenta de mail: Indico mi cuenta de correo y un nombre (podr\u00e1 ser cualquiera, evolution s\u00f3lo lo usa para identificar la conexi\u00f3n) : Configuro la recepci\u00f3n de correos: La autenticaci\u00f3n se va a realizar con usuarios del sistema, por eso escribo blackmamba . Para que funcione la autenticaci\u00f3n en Dovecot no he tenido que configurar nada, ya funciona por defecto. Mantengo las opciones de recepci\u00f3n por defecto: Relleno las opciones de env\u00edo para que me deje terminar la configuraci\u00f3n, pero ESTE NO ES el objetivo de este apartado, as\u00ed que la configuraci\u00f3n estar\u00e1 incompleta y por supuesto, no funcional : El env\u00edo se configurar\u00e1 en la tarea 11. Muestro el resumen final de la configuraci\u00f3n, y de nuevo ignoramos la parte referente al env\u00edo: Por \u00faltimo se nos pregunta la contrase\u00f1a del usuario que hemos indicado anteriormente: Compruebo que puedo leer el correo de Maildir que envi\u00e9 en la tarea anterior: Evolution se sincroniza con Dovecot de forma live, as\u00ed que podr\u00edamos enviar un correo y Evolution lo recibir\u00eda autom\u00e1ticamente. Muestro la prueba: Tarea 11 11.1 Configurar postfix para ofrecer el protocolo SMTPS Descomento el siguiente bloque en /etc/postfix/master.cf : smtps inet n - y - - smtpd -o syslog_name=postfix/smtps -o smtpd_tls_wrappermode=yes -o smtpd_sasl_auth_enable=yes -o smtpd_reject_unlisted_recipient=no -o smtpd_client_restrictions=$mua_client_restrictions -o smtpd_helo_restrictions=$mua_helo_restrictions -o smtpd_sender_restrictions=$mua_sender_restrictions -o smtpd_recipient_restrictions= -o smtpd_relay_restrictions=permit_sasl_authenticated,reject -o milter_macro_daemon_name=ORIGINATING Reinicio postfix: sudo systemctl restart postfix Compruebo que ahora funciona el puerto SMTPS 465: Tenemos que permitir ese tr\u00e1fico en el firewall de la vps: Hago una primera prueba de comunicaci\u00f3n con el puerto desde nuestro host: atlas@olympus:~$ telnet 87 .106.228.149 465 Trying 87.106.228.149... Connected to 87.106.228.149. Escape character is '^]'. 11.2 Usar certificados para cifrar el env\u00edo de correos Modifico lo siguiente en /etc/postfix/main.cf : smtpd_tls_cert_file=/etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem smtpd_tls_key_file=/etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem Reinicio postfix: sudo systemctl restart postfix 11.3 Configurar autenticaci\u00f3n SASL tanto en Postfix como en Dovecot A\u00f1ado lo siguiente a /etc/postfix/main.cf : # Authentication smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes Reinicio postfix: sudo systemctl restart postfix Descomento el siguiente bloque en /etc/dovecot/conf.d/10-master.conf : # Postfix smtp-auth unix_listener /var/spool/postfix/private/auth { mode = 0666 } Reinicio dovecot: sudo systemctl restart dovecot 11.4 Configurar evolution para enviar correos y mostrar una prueba de env\u00edo Borro la conexi\u00f3n anterior para poder crear una nueva: Creo una nueva conexi\u00f3n, y muestro directamente la configuraci\u00f3n de env\u00edo: En el resumen final compruebo que la informaci\u00f3n de env\u00edo sea correcta: Env\u00edo un correo: Antes de que se realice el env\u00edo, se pide autenticaci\u00f3n: Compruebo que me ha llegado el correo a gmail: Si queremos estar incluso m\u00e1s seguros de que este correo efectivamente se ha enviado desde Evolution y alg\u00fan detalle m\u00e1s, podemos abrir el original y mostrar sus cabeceras: Tarea 13: comprobaci\u00f3n final Enviar un correo a esta p\u00e1gina para obtener una puntuaci\u00f3n. Mostrar el resultado. Este es el correo que enviaremos: Haz click aqu\u00ed para ver mis resultados.","title":"Pr\u00e1ctica: Servidor de correos en VPS"},{"location":"practica-servidor-correo/#practica-servidor-de-correos-en-vps","text":"","title":"Pr\u00e1ctica: Servidor de correos en VPS"},{"location":"practica-servidor-correo/#pasos-previos","text":"Instalo postfix: sudo apt update sudo apt install postfix Selecciono \"Internet Site\": Escribo mi nombre de dominio. Se tomar\u00e1 como dominio origen de los correos que se env\u00eden desde el vps ( myorigin = /etc/mailname ) : Instalo mailutils : sudo apt install mailutils","title":"Pasos previos"},{"location":"practica-servidor-correo/#gestion-de-correos-desde-el-servidor","text":"","title":"Gesti\u00f3n de correos desde el servidor"},{"location":"practica-servidor-correo/#tarea-1","text":"","title":"Tarea 1"},{"location":"practica-servidor-correo/#11","text":"Crear registro SPF en el DNS","title":"1.1"},{"location":"practica-servidor-correo/#12","text":"Enviar un correo desde la vps a gmail blackmamba@kampe:~$ mail -r blackmamba@adrianjaramillo.tk adristudy@gmail.com Cc: Subject: Correo con SPF Mensaje","title":"1.2"},{"location":"practica-servidor-correo/#13","text":"Mostrar /var/log/mail.log para verificar que el correo se ha enviado correctamente L\u00ednea relevante: Feb 14 16:20:33 kampe postfix/smtp[516217]: 242F742268: to=<adristudy@gmail.com>, relay=gmail-smtp-in.l.google.com[64.233.167.26]:25, delay=1.3, delays=0.03/0.01/0.29/0.95, dsn=2.0.0, status=sent (250 2.0.0 OK 1644855633 l11si9233120wms.107 - gsmtp)","title":"1.3"},{"location":"practica-servidor-correo/#14","text":"Mostrar el correo recibido en gmail Para estar seguros de que este correo ha llegado con SPF v\u00e1lido, tenemos que mostrar el correo original: Ha pasado el checkeo SPF, pero si queremos ver informaci\u00f3n a\u00fan m\u00e1s espec\u00edfica, podemos hacer scroll al contenido en bruto del correo recibido: Al ver eso, queda totalmente claro que el checkeo SPF ha sido exitoso.","title":"1.4"},{"location":"practica-servidor-correo/#tarea-2","text":"","title":"Tarea 2"},{"location":"practica-servidor-correo/#21","text":"Crear registro MX y CNAME correspondiente en el DNS","title":"2.1"},{"location":"practica-servidor-correo/#22","text":"Habilitar en el firewall del vps el tr\u00e1fico entrante al puerto 25","title":"2.2"},{"location":"practica-servidor-correo/#23","text":"Enviar un correo desde gmail a la vps","title":"2.3"},{"location":"practica-servidor-correo/#24","text":"Comprobar que la vps ha recibido correctamente el correo mirando /var/log/mail.log","title":"2.4"},{"location":"practica-servidor-correo/#25","text":"Mostrar el correo recibido blackmamba@kampe:~$ mail \"/var/mail/blackmamba\": 1 message 1 new > N 1 adristudy Mon Feb 14 18 :17 52 /2630 Correo para la VPS ? 1 Return-Path: <adristudy@gmail.com> X-Original-To: blackmamba@adrianjaramillo.tk Delivered-To: blackmamba@adrianjaramillo.tk Received: from mail-pl1-f176.google.com (mail-pl1-f176.google.com [209.85.214.176]) by kampe.adrianjaramillo.tk (Postfix) with ESMTPS id 4F393422CB for <blackmamba@adrianjaramillo.tk>; Mon, 14 Feb 2022 18:17:40 +0000 (UTC) Received: by mail-pl1-f176.google.com with SMTP id l8so5186364pls.7 for <blackmamba@adrianjaramillo.tk>; Mon, 14 Feb 2022 10:17:40 -0800 (PST) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20210112; h=mime-version:from:date:message-id:subject:to; bh=MudV18FBtYjZJPFyKfQ5hC6U6ERmLoC4WY7BpsZqJUs=; b=hpLYd8Radagaj5ilgByYq41SIVkdDFuM28I2tHi2qxE6yANOJnGC22x6FepMkW/ur3 2iqHhmlw72u8he4u1VNxYsP3xCORcgx77iI3nxCkAYG7l9Tx6L7cScNNBMmsgfzP0Xp2 ukKClt9Nc38F0xHSwF1qKrpie4OsxxB+blYUnUzx5SvUl18WtuHjfxLHM2cPpueYrYvc Ls0dR/Hyt9pWXEthi9ueHnWTprlauAdxKANUJMnbYA1C5z6YH0F+i/6NnHa96ZQ2E2Dv JrRzfqVYRwNwDzQAHa5ViqbgyepDPLmu9gnbytlfJCoQSrAs9diH/8gLU7b3ymnlkxQS HkNg== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20210112; h=x-gm-message-state:mime-version:from:date:message-id:subject:to; bh=MudV18FBtYjZJPFyKfQ5hC6U6ERmLoC4WY7BpsZqJUs=; b=VUVBAkMaD/qnhm92cnmVBYhTFj0HuNxKqtgGNEVlEge780WB2QaXPMtaSMGSz77aHc nC3VQvj18EtItjtccAywt/FLLqP4ucH2gcellCvn0UreOCFoP8v7RaZTMYG4RBYrCOMD WKGXOXO2ay9fsCIQSNp429tQnRumifl3XaVMfy3jSZAbt1HUghtRP2VgE6Y/SLz5Lmkq NKEFW1u4IHqk8aXvM1cBzD6szJvPs5LSJjkmNuq/k/P+kH1QWQhrvs85Lyxzfgo3RSj+ qIG6+H1TK4JI3bBMbhwEiiapEJOVYj2DsGmeSoDTvNChGryidxJMQqpDTdz3mZ+ZE37K bWxA== X-Gm-Message-State: AOAM530YXJN7SPi6YOZ/UjMpMOMY71KTCE4ZLpC/AcW60wbzOkjuyN9M fWHiGc3H9WbfeAMOAzOBkY8vtybUr+Pw96kZMXAREDN/ X-Google-Smtp-Source: ABdhPJz6Vyx6fBNDRDGMOl88iRuxk0moB4G3eJTCNLmoXHc1ZDYlXFgmJdhK8aHYgutvtMLZmiO1TJ06tqf6XTu1iHA= X-Received: by 2002:a17:90a:2e0a:: with SMTP id q10mr1050878pjd.130.1644862658470; Mon, 14 Feb 2022 10:17:38 -0800 (PST) MIME-Version: 1.0 From: adristudy <adristudy@gmail.com> Date: Mon, 14 Feb 2022 19:17:27 +0100 Message-ID: <CAG5uPRccDy2iqjcOTT29ekY6tNCcnsgy0VsA5pXjzdm7KCcLgw@mail.gmail.com> Subject: Correo para la VPS To: blackmamba@adrianjaramillo.tk Content-Type: multipart/alternative; boundary=\"00000000000076676e05d7fe6ef6\" --00000000000076676e05d7fe6ef6 Content-Type: text/plain; charset=\"UTF-8\" Prueba --00000000000076676e05d7fe6ef6 Content-Type: text/html; charset=\"UTF-8\" <div dir=\"ltr\">Prueba</div> --00000000000076676e05d7fe6ef6--","title":"2.5"},{"location":"practica-servidor-correo/#tarea-3-uso-de-alias-y-redirecciones","text":"","title":"Tarea 3: Uso de alias y redirecciones"},{"location":"practica-servidor-correo/#31","text":"Crear tarea cron Abro la configuraci\u00f3n: crontab -e A\u00f1ado lo siguiente: MAILTO = root * * * * * echo Prueba de mensajes crontab Esta tarea ejecuta un echo cada minuto y env\u00eda un correo a root con el resultado. No vemos ese echo por terminal ni en la sesi\u00f3n de nuestro usuario ni en la de root, pero nos sirve para hacer pruebas.","title":"3.1"},{"location":"practica-servidor-correo/#32","text":"Comprobar que llegan correos en root root@kampe:~# mail \"/var/mail/root\": 64 messages 64 unread > U 1 Cron Daemon Mon Feb 14 21 :20 23 /788 Cron <blackmamba@kampe> echo Prueba de mensajes crontab U 2 Cron Daemon Mon Feb 14 21:21 22/762 Cron <blackmamba@kampe> echo Prueba de mensajes crontab U 3 Cron Daemon Mon Feb 14 21:22 22/762 Cron <blackmamba@kampe> echo Prueba de mensajes crontab U 4 Cron Daemon Mon Feb 14 21:23 22/762 Cron <blackmamba@kampe> echo Prueba de mensajes crontab Son todos iguales, as\u00ed que muestro uno de ellos: La parte que nos interesa es la marcada, el \"From\" y el \"To\". Los correos los env\u00eda el daemon de Cron usando root, hacia el usuario root. En el cuerpo del correo est\u00e1 el resultado del echo. Seg\u00fan como est\u00e1 ahora configurado cron, no nos llegar\u00edan esos correos a nuestro usuario.","title":"3.2"},{"location":"practica-servidor-correo/#33","text":"Crear un alias para que lleguen los correos a blackmamba Modifico /etc/aliases : # See man 5 aliases for format postmaster: root root: blackmamba Para que este cambio tome efecto ejecuto: sudo newaliases","title":"3.3"},{"location":"practica-servidor-correo/#34","text":"Comprobar que ya llegan los correos a blackmamba blackmamba@kampe:~$ mail \"/var/mail/blackmamba\": 1 message 1 new > N 1 Cron Daemon Mon Feb 14 22 :59 20 /743 Cron <blackmamba@kampe> echo Prueba de mensajes crontab ? Lo abro: ? 1 Return-Path: <blackmamba@adrianjaramillo.tk> X-Original-To: root Delivered-To: root@adrianjaramillo.tk Received: by kampe.adrianjaramillo.tk (Postfix, from userid 1000) id BC48442AC0; Mon, 14 Feb 2022 22:59:01 +0000 (UTC) From: root@adrianjaramillo.tk (Cron Daemon) To: root@adrianjaramillo.tk Subject: Cron <blackmamba@kampe> echo Prueba de mensajes crontab MIME-Version: 1.0 Content-Type: text/plain; charset=UTF-8 Content-Transfer-Encoding: 8bit X-Cron-Env: <MAILTO=root> X-Cron-Env: <SHELL=/bin/sh> X-Cron-Env: <HOME=/home/blackmamba> X-Cron-Env: <PATH=/usr/bin:/bin> X-Cron-Env: <LOGNAME=blackmamba> Message-Id: <20220214225901.BC48442AC0@kampe.adrianjaramillo.tk> Date: Mon, 14 Feb 2022 22:59:01 +0000 (UTC) Prueba de mensajes crontab ? He mostrado el contenido para que se vea el campo \"To:\", que apunta a root, pero el alias funciona as\u00ed que me llega a mi usuario principal blackmamba .","title":"3.4"},{"location":"practica-servidor-correo/#35","text":"Crear una redirecci\u00f3n para enviar esos correos a gmail Creo /home/blackmamba/.forward con el siguiente contenido: adristudy@gmail.com Veo en gmail que me est\u00e1n llegando:","title":"3.5"},{"location":"practica-servidor-correo/#tarea-4-para-asegurar-el-envio-opcional","text":"Configurar postfix con opendkim para firmar los correos que env\u00eda.","title":"Tarea 4: Para asegurar el env\u00edo (opcional)"},{"location":"practica-servidor-correo/#41-pasos-iniciales","text":"Instalo los paquetes: sudo apt install opendkim opendkim-tools A\u00f1ado el usuario postfix al grupo opendkim: sudo gpasswd -a postfix opendkim","title":"4.1 Pasos iniciales"},{"location":"practica-servidor-correo/#42-configuracion-opendkim","text":"/etc/opendkim.conf : # This is a basic configuration for signing and verifying. It can easily be # adapted to suit a basic installation. See opendkim.conf ( 5 ) and # /usr/share/doc/opendkim/examples/opendkim.conf.sample for complete # documentation of available configuration parameters. Syslog yes SyslogSuccess yes # LogWhy no # Common signing and verification parameters. In Debian, the \"From\" header is # oversigned, because it is often the identity key used by reputation systems # and thus somewhat security sensitive. Canonicalization relaxed/simple Mode s SubDomains no OversignHeaders From # Signing domain, selector, and key ( required ) . For example, perform signing # for domain \"example.com\" with selector \"2020\" ( 2020 ._domainkey.example.com ) , # using the private key stored in /etc/dkimkeys/example.private. More granular # setup options can be found in /usr/share/doc/opendkim/README.opendkim. # Domain example.com # Selector 2020 # KeyFile /etc/dkimkeys/example.private # In Debian, opendkim runs as user \"opendkim\" . A umask of 007 is required when # using a local socket with MTAs that access the socket as a non-privileged # user ( for example, Postfix ) . You may need to add user \"postfix\" to group # \"opendkim\" in that case . UserID opendkim UMask 007 # Socket for the MTA connection ( required ) . If the MTA is inside a chroot jail, # it must be ensured that the socket is accessible. In Debian, Postfix runs in # a chroot in /var/spool/postfix, therefore a Unix socket would have to be # configured as shown on the last line below. # Socket local:/run/opendkim/opendkim.sock # Socket inet:8891@localhost # Socket inet:8891 Socket local:/var/spool/postfix/opendkim/opendkim.sock PidFile /run/opendkim/opendkim.pid # Hosts for which to sign rather than verify, default is 127 .0.0.1. See the # OPERATION section of opendkim ( 8 ) for more information. # InternalHosts 192 .168.0.0/16, 10 .0.0.0/8, 172 .16.0.0/12 # The trust anchor enables DNSSEC. In Debian, the trust anchor file is provided # by the package dns-root-data. TrustAnchorFile /usr/share/dns/root.key # Nameservers 127 .0.0.1 # Map domains in From addresses to keys used to sign messages KeyTable refile:/etc/opendkim/key.table SigningTable refile:/etc/opendkim/signing.table","title":"4.2 Configuraci\u00f3n OpenDKIM"},{"location":"practica-servidor-correo/#43-creacion-de-signing-y-key-table","text":"Creo la estructura de directorios para las claves: sudo mkdir -p /etc/opendkim/keys Modifico propietarios y permisos: sudo chown -R opendkim:opendkim /etc/opendkim sudo chmod go-rw /etc/opendkim/keys Creo la signing table... sudo touch /etc/opendkim/signing.table ...con el siguiente contenido: *@adrianjaramillo.tk default._domainkey.adrianjaramillo.tk Creo la key table... sudo touch /etc/opendkim/key.table ...con el siguiente contenido: default._domainkey.adrianjaramillo.tk adrianjaramillo.tk:default:/etc/opendkim/keys/adrianjaramillo.tk/default.private","title":"4.3 Creaci\u00f3n de Signing y Key Table"},{"location":"practica-servidor-correo/#44-generacion-de-claves","text":"Creo un directorio para las claves del dominio: sudo mkdir /etc/opendkim/keys/adrianjaramillo.tk Genero las claves... sudo opendkim-genkey -b 2048 -d adrianjaramillo.tk -D /etc/opendkim/keys/adrianjaramillo.tk -s default -v ...y este es el output: opendkim-genkey: generating private key opendkim-genkey: private key written to default.private opendkim-genkey: extracting public key opendkim-genkey: DNS TXT record written to default.txt Cambio los propietarios de la clave privada: sudo chown opendkim:opendkim /etc/opendkim/keys/adrianjaramillo.tk/default.private Compruebo que los permisos de la clave privada son correctos: -rw------- 1 opendkim opendkim 1679 Mar 7 19:57 /etc/opendkim/keys/adrianjaramillo.tk/default.private","title":"4.4 Generaci\u00f3n de claves"},{"location":"practica-servidor-correo/#45-publicacion-de-la-clave-publica-en-mi-dns","text":"La clave p\u00fablica generada se encuentra en el fichero /etc/opendkim/keys/adrianjaramillo.tk/default.txt .: default._domainkey IN TXT ( \"v=DKIM1; h=sha256; k=rsa; \" \"p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA66vm0/BhAdiyHkYz/AcaWPkUbnTXOlxCxKZQP3skWmCI5fZSBfwJpndYg1C05UyiCh3qsVXXnOZsiRoKK09vzDobKFw2ngRA5y3vTPKufY/Va/VNfNRdXd8fhUjffnAbxQ231WyTqHNrb2XjXoTY8/QBy/2Hexg1f7zZ4PqcM5+L6kzCGtzPJ0m7MfWCL6HQCbg82JX0aywITl\" \"sKhieEJg0WXHnzX/wYD4rreOxG05QCfIT7zWMamJdaDfEuua8qLMdPnb714MnTq1zPizBQ+YEDkFKwSDkaeKRq44CBYjjZ+ma9yI7PMwYQ+LEkA0kKtFm8IaQMoAyMQQcF0dzIwQIDAQAB\" ) ; ----- DKIM key default for adrianjaramillo.tk La string que aparece despu\u00e9s de la p es mi clave p\u00fablica. \u00bfC\u00f3mo la publicamos? En nuestro DNS tenemos que crear un registro TXT con nombre default._domainkey y valor todo lo que haya entre par\u00e9ntesis del fichero que acabo de mostrar. IMPORTANTE: tenemos que eliminar todas las comillas dobles y espacios no necesarios. La string de la clave p\u00fablica por alguna raz\u00f3n la parte en 2, pero hay que unirla . Es decir, el valor final se nos quedar\u00eda as\u00ed: v=DKIM1; h=sha256; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA66vm0/BhAdiyHkYz/AcaWPkUbnTXOlxCxKZQP3skWmCI5fZSBfwJpndYg1C05UyiCh3qsVXXnOZsiRoKK09vzDobKFw2ngRA5y3vTPKufY/Va/VNfNRdXd8fhUjffnAbxQ231WyTqHNrb2XjXoTY8/QBy/2Hexg1f7zZ4PqcM5+L6kzCGtzPJ0m7MfWCL6HQCbg82JX0aywITlsKhieEJg0WXHnzX/wYD4rreOxG05QCfIT7zWMamJdaDfEuua8qLMdPnb714MnTq1zPizBQ+YEDkFKwSDkaeKRq44CBYjjZ+ma9yI7PMwYQ+LEkA0kKtFm8IaQMoAyMQQcF0dzIwQIDAQAB Muestro que he creado dicho registro en mi DNS:","title":"4.5 Publicaci\u00f3n de la clave p\u00fablica en mi DNS"},{"location":"practica-servidor-correo/#46-testeo-de-la-clave-publica","text":"Uso el siguiente comando: sudo opendkim-testkey -d adrianjaramillo.tk -s default -vvv Si todo funciona, deber\u00edamos de obtener un \"Key OK\": opendkim-testkey: using default configfile /etc/opendkim.conf opendkim-testkey: checking key 'default._domainkey.adrianjaramillo.tk' opendkim-testkey: key not secure opendkim-testkey: key OK Este comando lo que hace realmente es una consulta DNS. Se compara la clave privada que tenemos configurada con la p\u00fablica que aparece en el DNS, y se verifica si efectivamente ambas claves son del mismo par. Aparece \"key not secure\" pero de esto no tenemos que preocuparnos, simplemente significa que no tenemos habilitado DNSSEC en nuestro dominio. Por lo que he investigado, freenom no lo soporta. Tambi\u00e9n podemos usar la web https://mxtoolbox.com/dkim.aspx para comprobar el registro DKIM. Importante que escribamos nuestro selector correctamente: Vemos que el registro DKIM publicado en mi DNS es v\u00e1lido:","title":"4.6 Testeo de la clave p\u00fablica"},{"location":"practica-servidor-correo/#47-configuracion-de-postfix-con-opendkim","text":"Creo el directorio donde se crear\u00e1 el socket de OpenDKIM: sudo mkdir /var/spool/postfix/opendkim Modifico los propietarios: sudo chown opendkim:postfix /var/spool/postfix/opendkim Modifico /etc/opendkim.conf para cambiar el socket que utiliza. Comento la l\u00ednea: Socket local:/run/opendkim/opendkim.sock Y descomento la l\u00ednea: Socket local:/var/spool/postfix/opendkim/opendkim.sock Por \u00faltimo, a\u00f1ado lo siguiente al final de /etc/postfix/main.cf : # Milter configuration smtpd_milters = local:opendkim/opendkim.sock non_smtpd_milters = $smtpd_milters milter_default_action = accept milter_protocol = 6","title":"4.7 Configuraci\u00f3n de Postfix con OpenDKIM"},{"location":"practica-servidor-correo/#48-reinicio-de-servicios","text":"sudo systemctl restart opendkim postfix","title":"4.8 Reinicio de servicios"},{"location":"practica-servidor-correo/#49-comprobaciones","text":"Tras haberme enviado un correo a gmail, muestro el original para ver que haya pasado el chequeo DKIM: En el correo en crudo vemos que tenemos un campo de firma DKIM: Tambi\u00e9n podemos mirar /var/log/mail.log filtrando por dkim para ver que se realiza la firma:","title":"4.9 Comprobaciones"},{"location":"practica-servidor-correo/#gestion-de-correos-desde-un-cliente","text":"","title":"Gesti\u00f3n de correos desde un cliente"},{"location":"practica-servidor-correo/#tarea-8","text":"","title":"Tarea 8"},{"location":"practica-servidor-correo/#81","text":"Borrar el fichero .forward anteriormente creado rm .forward Es obligatorio que borremos este fichero para que lo que hagamos durante esta tarea funcione, y los correos lleguen a Maildir correctamente. \u00bfPor qu\u00e9? El fichero .forward tiene el siguiente funcionamiento: Es decir, si tenemos un fichero .forward no podremos recibir ning\u00fan correo en usuarios locales .","title":"8.1"},{"location":"practica-servidor-correo/#82","text":"Configurar postfix con buz\u00f3n Maildir A\u00f1ado lo siguiente a /etc/postfix/main.cf : home_mailbox = Maildir/ Reinicio postfix: sudo systemctl restart postfix","title":"8.2"},{"location":"practica-servidor-correo/#83","text":"Enviar un correo a blackmamba Hago la prueba: blackmamba@kampe:~$ mail -r blackmamba@localhost blackmamba@localhost Cc: Subject: Prueba Maildir Mensaje","title":"8.3"},{"location":"practica-servidor-correo/#84","text":"Comprobar que el correo se ha guardado en el buz\u00f3n Maildir Primero compruebo /var/log/mail.log para ver que haya llegado correctamente: \"delivered to maildir\" significa que ha funcionado correctamente. Lo siguiente a comprobar es la estructura de Maildir que se nos ha generado en el home: blackmamba@kampe:~$ tree Maildir/ Maildir/ |-- cur |-- new | `-- 1644944881.Vfe01I605c1M715492.kampe `-- tmp 3 directories, 1 file \u00a1Atenci\u00f3n! NO TENEMOS que crear esta estructura de directorios manualmente para que funcione, lo hace postfix.","title":"8.4"},{"location":"practica-servidor-correo/#85","text":"Visualizar el correo recibido en Maildir Podr\u00edamos perfectamente abrir manualmente los ficheros con cat , pero esto es rudimentario, usaremos la herramienta mail . Seg\u00fan se dice en la gu\u00eda de Jos\u00e9 Domingo, desde que usamos Maildir como buz\u00f3n ya no podremos visualizar los correos con mail . Esto es cierto si ejecutamos el comando sin argumentos: blackmamba@kampe:~$ mail No mail for blackmamba PERO podemos hacer lo siguiente: blackmamba@kampe:~$ mail -f Maildir \"/home/blackmamba/Maildir\": 1 message 1 new > N 1 blackmamba@localho Tue Feb 15 17 :08 13 /459 Prueba Maildir ? 1 Return-Path: <blackmamba@localhost> X-Original-To: blackmamba@localhost Delivered-To: blackmamba@localhost Received: by kampe.adrianjaramillo.tk (Postfix, from userid 1000) id A9FDB42CF6; Tue, 15 Feb 2022 17:08:01 +0000 (UTC) To: <blackmamba@localhost> Subject: Prueba Maildir X-Mailer: mail (GNU Mailutils 3.10) Message-Id: <20220215170801.A9FDB42CF6@kampe.adrianjaramillo.tk> Date: Tue, 15 Feb 2022 17:08:01 +0000 (UTC) From: blackmamba@localhost Mensaje ? Indicando la ruta de Maildir con mail -f nos posibilita ver los correos perfectamente. Muestro el man de mail para un mejor entendimiento:","title":"8.5"},{"location":"practica-servidor-correo/#tarea-9","text":"","title":"Tarea 9"},{"location":"practica-servidor-correo/#91","text":"Instalar Dovecot para ofrecer el protocolo IMAPS sudo apt install dovecot-imapd Lo primero que podemos ver es que estar\u00e1 escuchando en el puerto que necesitamos: Tenemos que permitir ese tr\u00e1fico en el firewall de la vps: Hacemos una primera prueba de comunicaci\u00f3n con el puerto desde nuestro host: atlas@olympus:~$ telnet 87 .106.228.149 993 Trying 87.106.228.149... Connected to 87.106.228.149. Escape character is '^]'.","title":"9.1"},{"location":"practica-servidor-correo/#92","text":"Configurar Dovecot para que use el buz\u00f3n Maildir Modifico /etc/dovecot/conf.d/10-mail.conf : mail_location = maildir:~/Maildir Reinicio dovecot: sudo systemctl restart dovecot","title":"9.2"},{"location":"practica-servidor-correo/#93","text":"Configurar el cifrado de la comunicaci\u00f3n por IMAPS en Dovecot con certificado. Usar el wildcard *.adrianjaramillo.tk que ya ten\u00edamos. Modifico /etc/dovecot/conf.d/10-ssl.conf : # # # # SSL settings # # # SSL/TLS support: yes, no, required. <doc/wiki/SSL.txt> ssl = yes # PEM encoded X.509 SSL/TLS certificate and private key. They ' re opened before # dropping root privileges, so keep the key file unreadable by anyone but # root. Included doc/mkcert.sh can be used to easily generate self-signed # certificate, just make sure to update the domains in dovecot-openssl.cnf ssl_cert = </etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem ssl_key = </etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem S\u00f3lo muestro el principio del fichero, porque es lo que he modificado. Reinicio dovecot: sudo systemctl restart dovecot","title":"9.3"},{"location":"practica-servidor-correo/#94","text":"Configurar evolution para recibir los correos del vps Abro la configuraci\u00f3n para una nueva cuenta de mail: Indico mi cuenta de correo y un nombre (podr\u00e1 ser cualquiera, evolution s\u00f3lo lo usa para identificar la conexi\u00f3n) : Configuro la recepci\u00f3n de correos: La autenticaci\u00f3n se va a realizar con usuarios del sistema, por eso escribo blackmamba . Para que funcione la autenticaci\u00f3n en Dovecot no he tenido que configurar nada, ya funciona por defecto. Mantengo las opciones de recepci\u00f3n por defecto: Relleno las opciones de env\u00edo para que me deje terminar la configuraci\u00f3n, pero ESTE NO ES el objetivo de este apartado, as\u00ed que la configuraci\u00f3n estar\u00e1 incompleta y por supuesto, no funcional : El env\u00edo se configurar\u00e1 en la tarea 11. Muestro el resumen final de la configuraci\u00f3n, y de nuevo ignoramos la parte referente al env\u00edo: Por \u00faltimo se nos pregunta la contrase\u00f1a del usuario que hemos indicado anteriormente: Compruebo que puedo leer el correo de Maildir que envi\u00e9 en la tarea anterior: Evolution se sincroniza con Dovecot de forma live, as\u00ed que podr\u00edamos enviar un correo y Evolution lo recibir\u00eda autom\u00e1ticamente. Muestro la prueba:","title":"9.4"},{"location":"practica-servidor-correo/#tarea-11","text":"","title":"Tarea 11"},{"location":"practica-servidor-correo/#111","text":"Configurar postfix para ofrecer el protocolo SMTPS Descomento el siguiente bloque en /etc/postfix/master.cf : smtps inet n - y - - smtpd -o syslog_name=postfix/smtps -o smtpd_tls_wrappermode=yes -o smtpd_sasl_auth_enable=yes -o smtpd_reject_unlisted_recipient=no -o smtpd_client_restrictions=$mua_client_restrictions -o smtpd_helo_restrictions=$mua_helo_restrictions -o smtpd_sender_restrictions=$mua_sender_restrictions -o smtpd_recipient_restrictions= -o smtpd_relay_restrictions=permit_sasl_authenticated,reject -o milter_macro_daemon_name=ORIGINATING Reinicio postfix: sudo systemctl restart postfix Compruebo que ahora funciona el puerto SMTPS 465: Tenemos que permitir ese tr\u00e1fico en el firewall de la vps: Hago una primera prueba de comunicaci\u00f3n con el puerto desde nuestro host: atlas@olympus:~$ telnet 87 .106.228.149 465 Trying 87.106.228.149... Connected to 87.106.228.149. Escape character is '^]'.","title":"11.1"},{"location":"practica-servidor-correo/#112","text":"Usar certificados para cifrar el env\u00edo de correos Modifico lo siguiente en /etc/postfix/main.cf : smtpd_tls_cert_file=/etc/letsencrypt/live/adrianjaramillo.tk/fullchain.pem smtpd_tls_key_file=/etc/letsencrypt/live/adrianjaramillo.tk/privkey.pem Reinicio postfix: sudo systemctl restart postfix","title":"11.2"},{"location":"practica-servidor-correo/#113","text":"Configurar autenticaci\u00f3n SASL tanto en Postfix como en Dovecot A\u00f1ado lo siguiente a /etc/postfix/main.cf : # Authentication smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes Reinicio postfix: sudo systemctl restart postfix Descomento el siguiente bloque en /etc/dovecot/conf.d/10-master.conf : # Postfix smtp-auth unix_listener /var/spool/postfix/private/auth { mode = 0666 } Reinicio dovecot: sudo systemctl restart dovecot","title":"11.3"},{"location":"practica-servidor-correo/#114","text":"Configurar evolution para enviar correos y mostrar una prueba de env\u00edo Borro la conexi\u00f3n anterior para poder crear una nueva: Creo una nueva conexi\u00f3n, y muestro directamente la configuraci\u00f3n de env\u00edo: En el resumen final compruebo que la informaci\u00f3n de env\u00edo sea correcta: Env\u00edo un correo: Antes de que se realice el env\u00edo, se pide autenticaci\u00f3n: Compruebo que me ha llegado el correo a gmail: Si queremos estar incluso m\u00e1s seguros de que este correo efectivamente se ha enviado desde Evolution y alg\u00fan detalle m\u00e1s, podemos abrir el original y mostrar sus cabeceras:","title":"11.4"},{"location":"practica-servidor-correo/#tarea-13-comprobacion-final","text":"Enviar un correo a esta p\u00e1gina para obtener una puntuaci\u00f3n. Mostrar el resultado. Este es el correo que enviaremos: Haz click aqu\u00ed para ver mis resultados.","title":"Tarea 13: comprobaci\u00f3n final"},{"location":"practica-servidor-dhcp/","text":"Pr\u00e1ctica: Servidor DHCP Tarea 1 Escenario: Servidor: NAT para dar salida a Internet (la tratamos como si fuera una p\u00fablica) Privada1 (veryisolated) Privada2 (veryisolated) nodo_lan1: cliente conectado a privada1 nodo_lan2: cliente conectado a privada2 nodowin10: cliente conectado a privada1 Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :servidor do |servidor| servidor.vm.box = \"debian/bullseye64\" servidor.vm.hostname = \"servidor\" servidor.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-nat\", :ip => \"192.168.0.2\" servidor.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada1\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.1\", :libvirt__forward_mode => \"veryisolated\" servidor.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.200.1\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :nodolan1 do |nodolan1| nodolan1.vm.box = \"debian/bullseye64\" nodolan1.vm.hostname = \"nodolan1\" nodolan1.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada1\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end config.vm.define :nodolan2 do |nodolan2| nodolan2.vm.box = \"debian/bullseye64\" nodolan2.vm.hostname = \"nodolan2\" nodolan2.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada2\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end config.vm.define :nodowin10 do |nodowin10| nodowin10.vm.box = \"jborean93/WindowsServer2016\" nodowin10.vm.guest = :windows nodowin10.vm.hostname = \"nodowin10\" nodowin10.vm.communicator = \"winrm\" nodowin10.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada1\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end end Para conectarnos a nodowin10 hacemos: vagrant ssh nodowin10 Tarea 2 Instalaci\u00f3n servidor DHCP sudo apt update && sudo apt install isc-dhcp-server Configuraci\u00f3n DHCP En /etc/default/isc-dhcp-server : Descomentar la l\u00ednea: DHCPDv4_CONF=/etc/dhcp/dhcpd.conf Especificar interfaces: INTERFACESv4=\"eth2 eth3\" En /etc/dhcp/dhcpd.conf : subnet 192.168.100.0 netmask 255.255.255.0 { range 192.168.100.100 192.168.100.150; option subnet-mask 255.255.255.0; option routers 192.168.100.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 43200; max-lease-time 43200; } subnet 192.168.200.0 netmask 255.255.255.0 { range 192.168.200.100 192.168.200.150; option subnet-mask 255.255.255.0; option routers 192.168.200.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 3600; max-lease-time 3600; } Reiniciar el servicio: sudo systemctl restart isc-dhcp-server Listar concesiones y comprobaci\u00f3n Nodolan1 concesi\u00f3n: lease 192.168.100.101 { starts 3 2021/10/20 06:40:30; ends 3 2021/10/20 18:40:30; cltt 3 2021/10/20 06:40:30; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:57:5b:cf; client-hostname \"nodolan1\"; } Nodolan1 comprobaci\u00f3n: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:57:5b:cf brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.100.101/24 brd 192.168.100.255 scope global dynamic eth1 valid_lft 41316sec preferred_lft 41316sec inet6 fe80::5054:ff:fe57:5bcf/64 scope link valid_lft forever preferred_lft forever Nodolan2 concesi\u00f3n: lease 192.168.200.101 { starts 3 2021/10/20 07:15:53; ends 3 2021/10/20 08:15:53; cltt 3 2021/10/20 07:15:53; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:eb:66:51; client-hostname \"nodolan2\"; } Nodolan2 comprobaci\u00f3n: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:eb:66:51 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.200.101/24 brd 192.168.200.255 scope global dynamic eth1 valid_lft 3599sec preferred_lft 3599sec inet6 fe80::5054:ff:feeb:6651/64 scope link valid_lft forever preferred_lft forever Nodowin10 concesi\u00f3n: lease 192.168.100.102 { starts 3 2021/10/20 07:37:44; ends 3 2021/10/20 19:37:44; cltt 3 2021/10/20 07:37:44; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:57:de:32; uid \"\\001RT\\000W\\3362\"; set vendor-class-identifier = \"MSFT 5.0\"; client-hostname \"nodowin10\"; } Nodowin10 comprobaci\u00f3n: Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Red Hat VirtIO Ethernet Adapter #2 Physical Address. . . . . . . . . : 52-54-00-57-DE-32 DHCP Enabled. . . . . . . . . . . : Yes Autoconfiguration Enabled . . . . : Yes Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2(Preferred) IPv4 Address. . . . . . . . . . . : 192.168.100.102(Preferred) Subnet Mask . . . . . . . . . . . : 255.255.255.0 Lease Obtained. . . . . . . . . . : Wednesday, October 20, 2021 7:37:44 AM Lease Expires . . . . . . . . . . : Wednesday, October 20, 2021 7:37:43 PM Default Gateway . . . . . . . . . : 192.168.100.1 DHCP Server . . . . . . . . . . . : 192.168.100.1 DHCPv6 IAID . . . . . . . . . . . : 72504320 DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-29-01-8E-B1-52-54-00-CE-85-A1 DNS Servers . . . . . . . . . . . : 1.1.1.1 1.0.0.1 NetBIOS over Tcpip. . . . . . . . : Enabled Cambios en clientes para configuraci\u00f3n DHCP En nodolan1 : Cambiar /etc/network/interfaces : allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE || true auto eth1 iface eth1 inet dhcp Pedir configuraci\u00f3n: sudo dhclient eth1 En nodolan2 : Cambiar /etc/network/interfaces : allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE || true auto eth1 iface eth1 inet dhcp - Pedir configuraci\u00f3n: sudo dhclient eth1 En nodowin10 : ipconfig /renew \"Ethernet 2\" Tarea 3 Servidor DHCP como router-NAT para que los clientes tengan internet Hago router-nat y persistente: sudo modprobe iptable_nat echo \"iptable_nat\" >> /etc/modules echo \"1\" > /proc/sys/net/ipv4/ip_forward echo \"net.ipv4.ip_forward=1\" >> /etc/sysctl.conf sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE sudo apt install iptables-persistent Cambio ruta por defecto para que el tr\u00e1fico salga por la interfaz NAT que hab\u00edamos definido: sudo ip route del default sudo ip route add default via 192.168.0.1 Hago este cambio persistente modificando /etc/network/interfaces : allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE auto eth1 iface eth1 inet static address 192.168.0.2 netmask 255.255.255.0 gateway 192.168.0.1 (muestro s\u00f3lo los fragmentos modificados) Mostrar rutas por defecto En servidor vagrant@servidor:~$ ip r default via 192.168.0.1 dev eth1 onlink 192.168.0.0/24 dev eth1 proto kernel scope link src 192.168.0.2 192.168.100.0/24 dev eth2 proto kernel scope link src 192.168.100.1 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.164 192.168.200.0/24 dev eth3 proto kernel scope link src 192.168.200.1 En nodolan1 vagrant@nodolan1:~$ ip r default via 192.168.100.1 dev eth1 192.168.100.0/24 dev eth1 proto kernel scope link src 192.168.100.100 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.193 En nodolan2 vagrant@nodolan2:~$ ip r default via 192.168.200.1 dev eth1 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.97 192.168.200.0/24 dev eth1 proto kernel scope link src 192.168.200.100 En nodowin10 Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2 IPv4 Address. . . . . . . . . . . : 192.168.100.102 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.100.1 Pruebas de acceso a Internet en clientes En nodolan1 : ping vagrant@nodolan1:~$ ping www.example.org PING www.example.org (93.184.216.34) 56(84) bytes of data. 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=1 ttl=52 time=142 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=2 ttl=52 time=160 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=3 ttl=52 time=185 ms ^C --- www.example.org ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2003ms rtt min/avg/max/mdev = 142.480/162.336/184.700/17.327 ms dig vagrant@nodolan1:~$ dig www.example.org ; <<>> DiG 9.16.15-Debian <<>> www.example.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21798 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 82705 IN A 93.184.216.34 ;; Query time: 48 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Wed Oct 20 10:16:57 UTC 2021 ;; MSG SIZE rcvd: 60 En nodolan2 : ping vagrant@nodolan2:~$ ping www.example.org PING www.example.org (93.184.216.34) 56(84) bytes of data. 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=1 ttl=52 time=143 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=2 ttl=52 time=332 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=3 ttl=52 time=193 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=4 ttl=52 time=142 ms ^C --- www.example.org ping statistics --- 5 packets transmitted, 4 received, 20% packet loss, time 4000ms rtt min/avg/max/mdev = 142.189/202.596/332.117/77.558 ms dig vagrant@nodolan2:~$ dig www.example.org ; <<>> DiG 9.16.15-Debian <<>> www.example.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4706 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 82395 IN A 93.184.216.34 ;; Query time: 472 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Wed Oct 20 10:22:02 UTC 2021 ;; MSG SIZE rcvd: 60 En nodowin10 : ping vagrant@NODOWIN10 C:\\Users\\vagrant>ping www.example.org Pinging www.example.org [93.184.216.34] with 32 bytes of data: Reply from 93.184.216.34: bytes=32 time=141ms TTL=52 Reply from 93.184.216.34: bytes=32 time=149ms TTL=52 Reply from 93.184.216.34: bytes=32 time=141ms TTL=52 Reply from 93.184.216.34: bytes=32 time=142ms TTL=52 Ping statistics for 93.184.216.34: Packets: Sent = 4, Received = 4, Lost = 0 (0% loss), Approximate round trip times in milli-seconds: Minimum = 141ms, Maximum = 149ms, Average = 143ms nslookup Hay 2 interfaces con configuraci\u00f3n DNS, por lo que modifico la prioridad de interfaces. De esta manera me aseguro de que use los DNS que reparte nuestro servidor DHCP en las resoluciones. Averiguar el \" InterfaceIndex \" de \" Ethernet 2 \": Get-NetIPInterface ifIndex InterfaceAlias AddressFamily NlMtu(Bytes) InterfaceMetric Dhcp ConnectionS tate ------- -------------- ------------- ------------ --------------- ---- ----------- 4 isatap.{05B72441-FF4C-475D-B... IPv6 1280 75 Disabled Disconne... 2 Ethernet 2 IPv6 1500 15 Enabled Connected 5 Teredo Tunneling Pseudo-Inte... IPv6 1280 75 Enabled Connected 7 Ethernet IPv6 1500 15 Enabled Connected 3 isatap.{D6D1085A-1F02-4C69-A... IPv6 1280 75 Disabled Disconne... 1 Loopback Pseudo-Interface 1 IPv6 4294967295 75 Disabled Connected 2 Ethernet 2 IPv4 1500 15 Enabled Connected 7 Ethernet IPv4 1500 15 Enabled Connected 1 Loopback Pseudo-Interface 1 IPv4 4294967295 75 Disabled Connected Modificamos su prioridad: Set-NetIPInterface -InterfaceIndex 2 -InterfaceMetric 10 Vemos que la prioridad ha cambiado: PS C:\\Users\\vagrant> Get-NetIPInterface ifIndex InterfaceAlias AddressFamily NlMtu(Bytes) InterfaceMetric Dhcp ConnectionS tate ------- -------------- ------------- ------------ --------------- ---- ----------- 4 isatap.{05B72441-FF4C-475D-B... IPv6 1280 75 Disabled Disconne... 2 Ethernet 2 IPv6 1500 10 Enabled Connected 5 Teredo Tunneling Pseudo-Inte... IPv6 1280 75 Enabled Connected 7 Ethernet IPv6 1500 15 Enabled Connected 3 isatap.{D6D1085A-1F02-4C69-A... IPv6 1280 75 Disabled Disconne... 1 Loopback Pseudo-Interface 1 IPv6 4294967295 75 Disabled Connected 2 Ethernet 2 IPv4 1500 10 Enabled Connected 7 Ethernet IPv4 1500 15 Enabled Connected 1 Loopback Pseudo-Interface 1 IPv4 4294967295 75 Disabled Connected Hacemos la consulta DNS: PS C:\\Users\\vagrant> nslookup www.example.org Server: one.one.one.one Address: 1.1.1.1 Non-authoritative answer: Name: www.example.org Addresses: 2606:2800:220:1:248:1893:25c8:1946 93.184.216.34 Tarea 4 Con los clientes configurados apagamos el servidor DHCP. \u00bfQu\u00e9 ocurrir\u00e1 tanto en Linux como en Windows? De ahora en adelante, default-lease-time y max-lease-time ser\u00e1n de 10 segundos para realizar esta tarea y la siguiente. As\u00ed queda: subnet 192.168.100.0 netmask 255.255.255.0 { range 192.168.100.100 192.168.100.150; option subnet-mask 255.255.255.0; option routers 192.168.100.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } subnet 192.168.200.0 netmask 255.255.255.0 { range 192.168.200.100 192.168.200.150; option subnet-mask 255.255.255.0; option routers 192.168.200.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } Tenemos que reiniciar el servicio para que se apliquen estos cambios: sudo systemctl restart isc-dhcp-server Despu\u00e9s de esto los clientes no actualizar\u00e1n sus tiempos hasta que no pase el tiempo indicado, pero forzamos esto soltando el lease y pidiendo uno nuevo. En los clientes linux hacemos: sudo dhclient -r eth1 sudo dhclient eth1 En el cliente Windows hacemos: ipconfig /release \"Ethernet 2\" ipconfig /renew \"Ethernet 2\" Ya teniendo los tiempos actualizados en todos los clientes, procedo a apagar el servidor. Los clientes linux pierden la configuraci\u00f3n por completo: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:57:5b:cf brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet6 fe80::5054:ff:fe57:5bcf/64 scope link valid_lft forever preferred_lft forever El cliente Windows pierde la configuraci\u00f3n y se autoconfigura con APIPA: Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Red Hat VirtIO Ethernet Adapter #2 Physical Address. . . . . . . . . : 52-54-00-57-DE-32 DHCP Enabled. . . . . . . . . . . : Yes Autoconfiguration Enabled . . . . : Yes Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2(Preferred) Autoconfiguration IPv4 Address. . : 169.254.236.200(Preferred) Subnet Mask . . . . . . . . . . . : 255.255.0.0 Default Gateway . . . . . . . . . : DHCPv6 IAID . . . . . . . . . . . : 72504320 DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-29-01-8E-B1-52-54-00-CE-85-A1 DNS Servers . . . . . . . . . . . : fec0:0:0:ffff::1%1 fec0:0:0:ffff::2%1 fec0:0:0:ffff::3%1 NetBIOS over Tcpip. . . . . . . . : Enabled Tarea 5 Con los clientes configurados cambiamos la configuraci\u00f3n del servidor DHCP (rango). \u00bfQu\u00e9 ocurrir\u00e1 tanto en Linux como en Windows? Nuevos rangos: subnet 192.168.100.0 netmask 255.255.255.0 { range 192.168.100.200 192.168.100.210; option subnet-mask 255.255.255.0; option routers 192.168.100.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } subnet 192.168.200.0 netmask 255.255.255.0 { range 192.168.200.200 192.168.200.210; option subnet-mask 255.255.255.0; option routers 192.168.200.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } Tenemos que reiniciar el servicio para que se apliquen estos cambios: sudo systemctl restart isc-dhcp-server Los clientes linux actualizan su configuraci\u00f3n sin problema: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:57:5b:cf brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.100.200/24 brd 192.168.100.255 scope global dynamic eth1 valid_lft 9sec preferred_lft 9sec inet6 fe80::5054:ff:fe57:5bcf/64 scope link valid_lft forever preferred_lft forever El cliente Windows actualiza su configuraci\u00f3n sin problema tambi\u00e9n: Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2 IPv4 Address. . . . . . . . . . . : 192.168.100.201 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.100.1 Tarea 6 Realizar un playbook en ansible que configure el servidor como: DHCP Router-NAT https://github.com/adriasir123/servidor-dhcp-ansible","title":"Pr\u00e1ctica"},{"location":"practica-servidor-dhcp/#practica-servidor-dhcp","text":"","title":"Pr\u00e1ctica: Servidor DHCP"},{"location":"practica-servidor-dhcp/#tarea-1","text":"Escenario: Servidor: NAT para dar salida a Internet (la tratamos como si fuera una p\u00fablica) Privada1 (veryisolated) Privada2 (veryisolated) nodo_lan1: cliente conectado a privada1 nodo_lan2: cliente conectado a privada2 nodowin10: cliente conectado a privada1 Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :servidor do |servidor| servidor.vm.box = \"debian/bullseye64\" servidor.vm.hostname = \"servidor\" servidor.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-nat\", :ip => \"192.168.0.2\" servidor.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada1\", :libvirt__dhcp_enabled => false, :ip => \"192.168.100.1\", :libvirt__forward_mode => \"veryisolated\" servidor.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.200.1\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :nodolan1 do |nodolan1| nodolan1.vm.box = \"debian/bullseye64\" nodolan1.vm.hostname = \"nodolan1\" nodolan1.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada1\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end config.vm.define :nodolan2 do |nodolan2| nodolan2.vm.box = \"debian/bullseye64\" nodolan2.vm.hostname = \"nodolan2\" nodolan2.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada2\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end config.vm.define :nodowin10 do |nodowin10| nodowin10.vm.box = \"jborean93/WindowsServer2016\" nodowin10.vm.guest = :windows nodowin10.vm.hostname = \"nodowin10\" nodowin10.vm.communicator = \"winrm\" nodowin10.vm.network :private_network, :libvirt__network_name => \"practica-dhcp-privada1\", :libvirt__dhcp_enabled => false, :libvirt__forward_mode => \"veryisolated\" end end Para conectarnos a nodowin10 hacemos: vagrant ssh nodowin10","title":"Tarea 1"},{"location":"practica-servidor-dhcp/#tarea-2","text":"Instalaci\u00f3n servidor DHCP sudo apt update && sudo apt install isc-dhcp-server Configuraci\u00f3n DHCP En /etc/default/isc-dhcp-server : Descomentar la l\u00ednea: DHCPDv4_CONF=/etc/dhcp/dhcpd.conf Especificar interfaces: INTERFACESv4=\"eth2 eth3\" En /etc/dhcp/dhcpd.conf : subnet 192.168.100.0 netmask 255.255.255.0 { range 192.168.100.100 192.168.100.150; option subnet-mask 255.255.255.0; option routers 192.168.100.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 43200; max-lease-time 43200; } subnet 192.168.200.0 netmask 255.255.255.0 { range 192.168.200.100 192.168.200.150; option subnet-mask 255.255.255.0; option routers 192.168.200.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 3600; max-lease-time 3600; } Reiniciar el servicio: sudo systemctl restart isc-dhcp-server Listar concesiones y comprobaci\u00f3n Nodolan1 concesi\u00f3n: lease 192.168.100.101 { starts 3 2021/10/20 06:40:30; ends 3 2021/10/20 18:40:30; cltt 3 2021/10/20 06:40:30; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:57:5b:cf; client-hostname \"nodolan1\"; } Nodolan1 comprobaci\u00f3n: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:57:5b:cf brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.100.101/24 brd 192.168.100.255 scope global dynamic eth1 valid_lft 41316sec preferred_lft 41316sec inet6 fe80::5054:ff:fe57:5bcf/64 scope link valid_lft forever preferred_lft forever Nodolan2 concesi\u00f3n: lease 192.168.200.101 { starts 3 2021/10/20 07:15:53; ends 3 2021/10/20 08:15:53; cltt 3 2021/10/20 07:15:53; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:eb:66:51; client-hostname \"nodolan2\"; } Nodolan2 comprobaci\u00f3n: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:eb:66:51 brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.200.101/24 brd 192.168.200.255 scope global dynamic eth1 valid_lft 3599sec preferred_lft 3599sec inet6 fe80::5054:ff:feeb:6651/64 scope link valid_lft forever preferred_lft forever Nodowin10 concesi\u00f3n: lease 192.168.100.102 { starts 3 2021/10/20 07:37:44; ends 3 2021/10/20 19:37:44; cltt 3 2021/10/20 07:37:44; binding state active; next binding state free; rewind binding state free; hardware ethernet 52:54:00:57:de:32; uid \"\\001RT\\000W\\3362\"; set vendor-class-identifier = \"MSFT 5.0\"; client-hostname \"nodowin10\"; } Nodowin10 comprobaci\u00f3n: Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Red Hat VirtIO Ethernet Adapter #2 Physical Address. . . . . . . . . : 52-54-00-57-DE-32 DHCP Enabled. . . . . . . . . . . : Yes Autoconfiguration Enabled . . . . : Yes Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2(Preferred) IPv4 Address. . . . . . . . . . . : 192.168.100.102(Preferred) Subnet Mask . . . . . . . . . . . : 255.255.255.0 Lease Obtained. . . . . . . . . . : Wednesday, October 20, 2021 7:37:44 AM Lease Expires . . . . . . . . . . : Wednesday, October 20, 2021 7:37:43 PM Default Gateway . . . . . . . . . : 192.168.100.1 DHCP Server . . . . . . . . . . . : 192.168.100.1 DHCPv6 IAID . . . . . . . . . . . : 72504320 DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-29-01-8E-B1-52-54-00-CE-85-A1 DNS Servers . . . . . . . . . . . : 1.1.1.1 1.0.0.1 NetBIOS over Tcpip. . . . . . . . : Enabled Cambios en clientes para configuraci\u00f3n DHCP En nodolan1 : Cambiar /etc/network/interfaces : allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE || true auto eth1 iface eth1 inet dhcp Pedir configuraci\u00f3n: sudo dhclient eth1 En nodolan2 : Cambiar /etc/network/interfaces : allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE || true auto eth1 iface eth1 inet dhcp - Pedir configuraci\u00f3n: sudo dhclient eth1 En nodowin10 : ipconfig /renew \"Ethernet 2\"","title":"Tarea 2"},{"location":"practica-servidor-dhcp/#tarea-3","text":"Servidor DHCP como router-NAT para que los clientes tengan internet Hago router-nat y persistente: sudo modprobe iptable_nat echo \"iptable_nat\" >> /etc/modules echo \"1\" > /proc/sys/net/ipv4/ip_forward echo \"net.ipv4.ip_forward=1\" >> /etc/sysctl.conf sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE sudo apt install iptables-persistent Cambio ruta por defecto para que el tr\u00e1fico salga por la interfaz NAT que hab\u00edamos definido: sudo ip route del default sudo ip route add default via 192.168.0.1 Hago este cambio persistente modificando /etc/network/interfaces : allow-hotplug eth0 iface eth0 inet dhcp post-up ip route del default dev $IFACE auto eth1 iface eth1 inet static address 192.168.0.2 netmask 255.255.255.0 gateway 192.168.0.1 (muestro s\u00f3lo los fragmentos modificados) Mostrar rutas por defecto En servidor vagrant@servidor:~$ ip r default via 192.168.0.1 dev eth1 onlink 192.168.0.0/24 dev eth1 proto kernel scope link src 192.168.0.2 192.168.100.0/24 dev eth2 proto kernel scope link src 192.168.100.1 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.164 192.168.200.0/24 dev eth3 proto kernel scope link src 192.168.200.1 En nodolan1 vagrant@nodolan1:~$ ip r default via 192.168.100.1 dev eth1 192.168.100.0/24 dev eth1 proto kernel scope link src 192.168.100.100 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.193 En nodolan2 vagrant@nodolan2:~$ ip r default via 192.168.200.1 dev eth1 192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.97 192.168.200.0/24 dev eth1 proto kernel scope link src 192.168.200.100 En nodowin10 Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2 IPv4 Address. . . . . . . . . . . : 192.168.100.102 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.100.1 Pruebas de acceso a Internet en clientes En nodolan1 : ping vagrant@nodolan1:~$ ping www.example.org PING www.example.org (93.184.216.34) 56(84) bytes of data. 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=1 ttl=52 time=142 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=2 ttl=52 time=160 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=3 ttl=52 time=185 ms ^C --- www.example.org ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2003ms rtt min/avg/max/mdev = 142.480/162.336/184.700/17.327 ms dig vagrant@nodolan1:~$ dig www.example.org ; <<>> DiG 9.16.15-Debian <<>> www.example.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21798 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 82705 IN A 93.184.216.34 ;; Query time: 48 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Wed Oct 20 10:16:57 UTC 2021 ;; MSG SIZE rcvd: 60 En nodolan2 : ping vagrant@nodolan2:~$ ping www.example.org PING www.example.org (93.184.216.34) 56(84) bytes of data. 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=1 ttl=52 time=143 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=2 ttl=52 time=332 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=3 ttl=52 time=193 ms 64 bytes from 93.184.216.34 (93.184.216.34): icmp_seq=4 ttl=52 time=142 ms ^C --- www.example.org ping statistics --- 5 packets transmitted, 4 received, 20% packet loss, time 4000ms rtt min/avg/max/mdev = 142.189/202.596/332.117/77.558 ms dig vagrant@nodolan2:~$ dig www.example.org ; <<>> DiG 9.16.15-Debian <<>> www.example.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4706 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ;; QUESTION SECTION: ;www.example.org. IN A ;; ANSWER SECTION: www.example.org. 82395 IN A 93.184.216.34 ;; Query time: 472 msec ;; SERVER: 1.1.1.1#53(1.1.1.1) ;; WHEN: Wed Oct 20 10:22:02 UTC 2021 ;; MSG SIZE rcvd: 60 En nodowin10 : ping vagrant@NODOWIN10 C:\\Users\\vagrant>ping www.example.org Pinging www.example.org [93.184.216.34] with 32 bytes of data: Reply from 93.184.216.34: bytes=32 time=141ms TTL=52 Reply from 93.184.216.34: bytes=32 time=149ms TTL=52 Reply from 93.184.216.34: bytes=32 time=141ms TTL=52 Reply from 93.184.216.34: bytes=32 time=142ms TTL=52 Ping statistics for 93.184.216.34: Packets: Sent = 4, Received = 4, Lost = 0 (0% loss), Approximate round trip times in milli-seconds: Minimum = 141ms, Maximum = 149ms, Average = 143ms nslookup Hay 2 interfaces con configuraci\u00f3n DNS, por lo que modifico la prioridad de interfaces. De esta manera me aseguro de que use los DNS que reparte nuestro servidor DHCP en las resoluciones. Averiguar el \" InterfaceIndex \" de \" Ethernet 2 \": Get-NetIPInterface ifIndex InterfaceAlias AddressFamily NlMtu(Bytes) InterfaceMetric Dhcp ConnectionS tate ------- -------------- ------------- ------------ --------------- ---- ----------- 4 isatap.{05B72441-FF4C-475D-B... IPv6 1280 75 Disabled Disconne... 2 Ethernet 2 IPv6 1500 15 Enabled Connected 5 Teredo Tunneling Pseudo-Inte... IPv6 1280 75 Enabled Connected 7 Ethernet IPv6 1500 15 Enabled Connected 3 isatap.{D6D1085A-1F02-4C69-A... IPv6 1280 75 Disabled Disconne... 1 Loopback Pseudo-Interface 1 IPv6 4294967295 75 Disabled Connected 2 Ethernet 2 IPv4 1500 15 Enabled Connected 7 Ethernet IPv4 1500 15 Enabled Connected 1 Loopback Pseudo-Interface 1 IPv4 4294967295 75 Disabled Connected Modificamos su prioridad: Set-NetIPInterface -InterfaceIndex 2 -InterfaceMetric 10 Vemos que la prioridad ha cambiado: PS C:\\Users\\vagrant> Get-NetIPInterface ifIndex InterfaceAlias AddressFamily NlMtu(Bytes) InterfaceMetric Dhcp ConnectionS tate ------- -------------- ------------- ------------ --------------- ---- ----------- 4 isatap.{05B72441-FF4C-475D-B... IPv6 1280 75 Disabled Disconne... 2 Ethernet 2 IPv6 1500 10 Enabled Connected 5 Teredo Tunneling Pseudo-Inte... IPv6 1280 75 Enabled Connected 7 Ethernet IPv6 1500 15 Enabled Connected 3 isatap.{D6D1085A-1F02-4C69-A... IPv6 1280 75 Disabled Disconne... 1 Loopback Pseudo-Interface 1 IPv6 4294967295 75 Disabled Connected 2 Ethernet 2 IPv4 1500 10 Enabled Connected 7 Ethernet IPv4 1500 15 Enabled Connected 1 Loopback Pseudo-Interface 1 IPv4 4294967295 75 Disabled Connected Hacemos la consulta DNS: PS C:\\Users\\vagrant> nslookup www.example.org Server: one.one.one.one Address: 1.1.1.1 Non-authoritative answer: Name: www.example.org Addresses: 2606:2800:220:1:248:1893:25c8:1946 93.184.216.34","title":"Tarea 3"},{"location":"practica-servidor-dhcp/#tarea-4","text":"Con los clientes configurados apagamos el servidor DHCP. \u00bfQu\u00e9 ocurrir\u00e1 tanto en Linux como en Windows? De ahora en adelante, default-lease-time y max-lease-time ser\u00e1n de 10 segundos para realizar esta tarea y la siguiente. As\u00ed queda: subnet 192.168.100.0 netmask 255.255.255.0 { range 192.168.100.100 192.168.100.150; option subnet-mask 255.255.255.0; option routers 192.168.100.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } subnet 192.168.200.0 netmask 255.255.255.0 { range 192.168.200.100 192.168.200.150; option subnet-mask 255.255.255.0; option routers 192.168.200.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } Tenemos que reiniciar el servicio para que se apliquen estos cambios: sudo systemctl restart isc-dhcp-server Despu\u00e9s de esto los clientes no actualizar\u00e1n sus tiempos hasta que no pase el tiempo indicado, pero forzamos esto soltando el lease y pidiendo uno nuevo. En los clientes linux hacemos: sudo dhclient -r eth1 sudo dhclient eth1 En el cliente Windows hacemos: ipconfig /release \"Ethernet 2\" ipconfig /renew \"Ethernet 2\" Ya teniendo los tiempos actualizados en todos los clientes, procedo a apagar el servidor. Los clientes linux pierden la configuraci\u00f3n por completo: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:57:5b:cf brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet6 fe80::5054:ff:fe57:5bcf/64 scope link valid_lft forever preferred_lft forever El cliente Windows pierde la configuraci\u00f3n y se autoconfigura con APIPA: Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Red Hat VirtIO Ethernet Adapter #2 Physical Address. . . . . . . . . : 52-54-00-57-DE-32 DHCP Enabled. . . . . . . . . . . : Yes Autoconfiguration Enabled . . . . : Yes Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2(Preferred) Autoconfiguration IPv4 Address. . : 169.254.236.200(Preferred) Subnet Mask . . . . . . . . . . . : 255.255.0.0 Default Gateway . . . . . . . . . : DHCPv6 IAID . . . . . . . . . . . : 72504320 DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-29-01-8E-B1-52-54-00-CE-85-A1 DNS Servers . . . . . . . . . . . : fec0:0:0:ffff::1%1 fec0:0:0:ffff::2%1 fec0:0:0:ffff::3%1 NetBIOS over Tcpip. . . . . . . . : Enabled","title":"Tarea 4"},{"location":"practica-servidor-dhcp/#tarea-5","text":"Con los clientes configurados cambiamos la configuraci\u00f3n del servidor DHCP (rango). \u00bfQu\u00e9 ocurrir\u00e1 tanto en Linux como en Windows? Nuevos rangos: subnet 192.168.100.0 netmask 255.255.255.0 { range 192.168.100.200 192.168.100.210; option subnet-mask 255.255.255.0; option routers 192.168.100.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } subnet 192.168.200.0 netmask 255.255.255.0 { range 192.168.200.200 192.168.200.210; option subnet-mask 255.255.255.0; option routers 192.168.200.1; option domain-name-servers 1.1.1.1, 1.0.0.1; default-lease-time 10; max-lease-time 10; } Tenemos que reiniciar el servicio para que se apliquen estos cambios: sudo systemctl restart isc-dhcp-server Los clientes linux actualizan su configuraci\u00f3n sin problema: 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:57:5b:cf brd ff:ff:ff:ff:ff:ff altname enp0s6 altname ens6 inet 192.168.100.200/24 brd 192.168.100.255 scope global dynamic eth1 valid_lft 9sec preferred_lft 9sec inet6 fe80::5054:ff:fe57:5bcf/64 scope link valid_lft forever preferred_lft forever El cliente Windows actualiza su configuraci\u00f3n sin problema tambi\u00e9n: Ethernet adapter Ethernet 2: Connection-specific DNS Suffix . : Link-local IPv6 Address . . . . . : fe80::c1c4:20a1:511b:ecc8%2 IPv4 Address. . . . . . . . . . . : 192.168.100.201 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.100.1","title":"Tarea 5"},{"location":"practica-servidor-dhcp/#tarea-6","text":"Realizar un playbook en ansible que configure el servidor como: DHCP Router-NAT https://github.com/adriasir123/servidor-dhcp-ansible","title":"Tarea 6"},{"location":"practica-vpn-sad/","text":"Pr\u00e1ctica: VPN Parte 1: acceso remoto OpenVPN Escenario Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientevpn do |clientevpn| clientevpn.vm.box = \"debian/bullseye64\" clientevpn.vm.hostname = \"clientevpn\" clientevpn.vm.network :private_network, :libvirt__network_name => \"externa-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :servervpn do |servervpn| servervpn.vm.box = \"debian/bullseye64\" servervpn.vm.hostname = \"servervpn\" servervpn.vm.network :private_network, :libvirt__network_name => \"externa-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" servervpn.vm.network :private_network, :libvirt__network_name => \"interna-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal do |clientenormal| clientenormal.vm.box = \"debian/bullseye64\" clientenormal.vm.hostname = \"clientenormal\" clientenormal.vm.network :private_network, :libvirt__network_name => \"interna-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.5\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end En servervpn Instalar OpenVPN sudo apt update sudo apt install openvpn Habilitar forwarding echo 1 > /proc/sys/net/ipv4/ip_forward Crear infraestructura de clave p\u00fablica Seg\u00fan la gu\u00eda que estoy siguiendo es necesario copiar la configuraci\u00f3n de /usr/share/easy-rsa a /etc/openvpn antes de continuar, para prevenir que futuras actualizaciones del paquete OpenVPN modifiquen las configuraciones que hagamos. En nuestro caso esta posibilidad nunca llegar\u00eda a hacerse realidad , puesto que lo que estamos haciendo es simplemente una pr\u00e1ctica, que se extiende durante un periodo de tiempo relativamente corto. A\u00fan as\u00ed, lo hago por razones de organizaci\u00f3n, ya que todas las configuraciones manuales deben estar bajo /etc . sudo cp -r /usr/share/easy-rsa /etc/openvpn cd /etc/openvpn/easy-rsa Inicializamos la PKI: sudo ./easyrsa init-pki init-pki complete; you may now create a CA or requests. Your newly created PKI dir is: /etc/openvpn/easy-rsa/pki Generar certificado + clave privada de la CA En este paso obtendremos el par de claves necesario de la Autoridad Certificadora (CA). Posteriormente, es esta clave privada la que se usar\u00e1 para firmar los certificados tanto del servidor como del cliente. sudo ./easyrsa build-ca Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Enter New CA Key Passphrase: Re-Enter New CA Key Passphrase: Generating RSA private key, 2048 bit long modulus (2 primes) ........................................................................................+++++ .......................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Adrianj CA CA creation complete and you may now import and sign cert requests. Your new CA certificate file for publishing is at: /etc/openvpn/easy-rsa/pki/ca.crt Passphrase: 1234 Certificado generado: /etc/openvpn/easy-rsa/pki/ca.crt Clave privada generada: /etc/openvpn/easy-rsa/pki/private/ca.key Generar certificado + clave privada del servidor VPN sudo ./easyrsa build-server-full server nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key .......+++++ ............................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2389.Tqf1G1/tmp.Ow20MK' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2389.Tqf1G1/tmp.5Exl9Q Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'server' Certificate is to be certified until Mar 18 08:30:09 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated Certificado generado: /etc/openvpn/easy-rsa/pki/issued/server.crt Clave privada generada: /etc/openvpn/easy-rsa/pki/private/server.key Generar par\u00e1metros Diffie\u2013Hellman sudo ./easyrsa gen-dh Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time .......................+.....................+..............................................................+......................+................................................................................+...................................................................................................................................................+....................+....................................................................+..................+.......+..............................................................+...........................................................................+................................................................................................................................+.....................................+...........................................................................................................................................................................+................................................................................................................................................................................................................+.+.............................+.........................+..............................................................................................................................................................................................................................+..............+......................................................................+................................+.................................+......................................................................................................+............................................................................................+...........................................................................................................................................................................................+........................................+.............................................................................+....................................................................................................+...........+...........................................................+.....................................................................+...............................................................................................................................................+...........................................................................................................................................+.....................................+........................................................................................+...................+.............+.......................+.......................................................................................+.........................................................+...........................................................................+...............................................................................................................................................................+.......................................+........................................................+..........................................+................................................................................................................+.........+.............................+..........................................................................+...............................................+............................................................................................................+.......+...............................................................................................................+............................................+................+..................................................+...............+..............................................................................+.......................................................................+.................................+..+.+.+..............................................................................................+.............................................................................+...................................................................................................................................................................................................+...........+................................................................................+............................................................................................................................................................................................................+............................+..+......................................................................................................................................................................................+..............................................................................................+......................................................................................................................................................................................................................................................................................................................................................................................................+........................................+......................+...............................+...........................+...............................................................................................+..........................................................................................................................+.......................................................................+.................................................................................+....................................................................+................................+.++*++*++*++* DH parameters of size 2048 created at /etc/openvpn/easy-rsa/pki/dh.pem Generar certificado + clave privada del cliente VPN sudo ./easyrsa build-client-full clientevpn nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key ..............+++++ ................................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2541.yaiUd0/tmp.WePx19' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2541.yaiUd0/tmp.GMaG7k Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'clientevpn' Certificate is to be certified until Mar 18 08:49:43 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated Certificado generado: /etc/openvpn/easy-rsa/pki/issued/clientevpn.crt Clave privada generada: /etc/openvpn/easy-rsa/pki/private/clientevpn.key Pasar ficheros necesarios al cliente VPN sudo cp -rp /etc/openvpn/easy-rsa/pki/{ca.crt,issued/clientevpn.crt,private/clientevpn.key} ~ sudo chown vagrant: ~/{ca.crt,clientevpn.crt,clientevpn.key} scp ~/{ca.crt,clientevpn.crt,clientevpn.key} vagrant@192.88.99.11:/home/vagrant Configurar el servidor VPN Copio la plantilla oficial de configuraci\u00f3n para servidores openvpn, para partir de ella: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf Modifico /etc/openvpn/server/servidor.conf : port 1194 proto udp dev tun ca /etc/openvpn/easy-rsa/pki/ca.crt cert /etc/openvpn/easy-rsa/pki/issued/server.crt key /etc/openvpn/easy-rsa/pki/private/server.key dh /etc/openvpn/easy-rsa/pki/dh.pem topology subnet # DIRECCIONAMIENTO PARA EL T\u00daNEL # # El servidor ser\u00e1: 10.99.99.1 # El resto de IPs estar\u00e1n disponibles para los clientes server 10.99.99.0 255.255.255.0 ifconfig-pool-persist /var/log/openvpn/ipp.txt push \"route 192.168.0.0 255.255.255.0\" keepalive 10 120 cipher AES-256-CBC persist-key persist-tun status /var/log/openvpn/openvpn-status.log verb 3 explicit-exit-notify 1 Iniciar el servidor sudo systemctl enable --now openvpn-server@servidor Verifico que est\u00e1 funcionando: sudo systemctl status openvpn-server@servidor \u25cf openvpn-server@servidor.service - OpenVPN service for servidor Loaded: loaded (/lib/systemd/system/openvpn-server@.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2021-12-14 09:16:30 UTC; 35s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 2800 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1.0M CPU: 9ms CGroup: /system.slice/system-openvpn\\x2dserver.slice/openvpn-server@servidor.service \u2514\u25002800 /usr/sbin/openvpn --status /run/openvpn-server/status-servidor.log --status-version 2 --suppress-timestamps --config servidor.conf Dec 14 09:16:30 servervpn openvpn[2800]: net_iface_up: set tun0 up Dec 14 09:16:30 servervpn openvpn[2800]: net_addr_v4_add: 10.99.99.1/24 dev tun0 Dec 14 09:16:30 servervpn openvpn[2800]: Could not determine IPv4/IPv6 protocol. Using AF_INET Dec 14 09:16:30 servervpn openvpn[2800]: Socket Buffers: R=[212992->212992] S=[212992->212992] Dec 14 09:16:30 servervpn openvpn[2800]: UDPv4 link local (bound): [AF_INET][undef]:1194 Dec 14 09:16:30 servervpn openvpn[2800]: UDPv4 link remote: [AF_UNSPEC] Dec 14 09:16:30 servervpn openvpn[2800]: MULTI: multi_init called, r=256 v=256 Dec 14 09:16:30 servervpn openvpn[2800]: IFCONFIG POOL IPv4: base=10.99.99.2 size=252 Dec 14 09:16:30 servervpn openvpn[2800]: IFCONFIG POOL LIST Dec 14 09:16:30 servervpn openvpn[2800]: Initialization Sequence Completed En clientevpn Instalar OpenVPN sudo apt update sudo apt install openvpn Mover ficheros a la ruta adecuada sudo mv ~/{ca.crt,clientevpn.crt,clientevpn.key} /etc/openvpn/client sudo chown root: /etc/openvpn/client/* /etc/openvpn/client queda as\u00ed: vagrant@clientevpn:/etc/openvpn/client$ ls -la total 24 drwxr-xr-x 2 root root 4096 Dec 14 09:31 . drwxr-xr-x 4 root root 4096 Dec 14 09:30 .. -rw------- 1 root root 1200 Dec 14 09:01 ca.crt -rw------- 1 root root 4498 Dec 14 09:01 clientevpn.crt -rw------- 1 root root 1704 Dec 14 09:01 clientevpn.key Configurar el cliente VPN Copio la plantilla oficial de configuraci\u00f3n para clientes openvpn, para partir de ella: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client/cliente.conf Modifico /etc/openvpn/client/cliente.conf : client dev tun proto udp remote 192.88.99.10 1194 resolv-retry infinite nobind persist-key persist-tun ca /etc/openvpn/client/ca.crt cert /etc/openvpn/client/clientevpn.crt key /etc/openvpn/client/clientevpn.key remote-cert-tls server cipher AES-256-CBC verb 3 Habilito el servicio: sudo systemctl enable --now openvpn-client@cliente Verifico que funciona: sudo systemctl status openvpn-client@cliente \u25cf openvpn-client@cliente.service - OpenVPN tunnel for cliente Loaded: loaded (/lib/systemd/system/openvpn-client@.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2021-12-14 09:43:44 UTC; 5s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 12859 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1.9M CPU: 17ms CGroup: /system.slice/system-openvpn\\x2dclient.slice/openvpn-client@cliente.service \u2514\u250012859 /usr/sbin/openvpn --suppress-timestamps --nobind --config cliente.conf Dec 14 09:43:44 clientevpn openvpn[12859]: net_route_v4_best_gw query: dst 0.0.0.0 Dec 14 09:43:44 clientevpn openvpn[12859]: net_route_v4_best_gw result: via 192.168.121.1 dev eth0 Dec 14 09:43:44 clientevpn openvpn[12859]: ROUTE_GATEWAY 192.168.121.1/255.255.255.0 IFACE=eth0 HWADD> Dec 14 09:43:44 clientevpn openvpn[12859]: TUN/TAP device tun0 opened Dec 14 09:43:44 clientevpn openvpn[12859]: net_iface_mtu_set: mtu 1500 for tun0 Dec 14 09:43:44 clientevpn openvpn[12859]: net_iface_up: set tun0 up Dec 14 09:43:44 clientevpn openvpn[12859]: net_addr_v4_add: 10.99.99.2/24 dev tun0 Dec 14 09:43:44 clientevpn openvpn[12859]: net_route_v4_add: 192.168.0.0/24 via 10.99.99.1 dev [NULL]> Dec 14 09:43:44 clientevpn openvpn[12859]: WARNING: this configuration may cache passwords in memory > Dec 14 09:43:44 clientevpn openvpn[12859]: Initialization Sequence Completed En clientenormal Cambiar ruta por defecto sudo ip route del default sudo ip route add default via 192.168.0.1 Pruebas de funcionamiento (todas estar\u00e1n hechas desde clientevpn) Ping al otro extremo del t\u00fanel (servervpn) : vagrant@clientevpn:/etc/openvpn/client$ ping 10.99.99.1 PING 10.99.99.1 (10.99.99.1) 56(84) bytes of data. 64 bytes from 10.99.99.1: icmp_seq=1 ttl=64 time=0.412 ms 64 bytes from 10.99.99.1: icmp_seq=2 ttl=64 time=0.696 ms 64 bytes from 10.99.99.1: icmp_seq=3 ttl=64 time=0.455 ms ^C --- 10.99.99.1 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2048ms rtt min/avg/max/mdev = 0.412/0.521/0.696/0.124 ms Ping a clientenormal: vagrant@clientevpn:/etc/openvpn/client$ ping 192.168.0.5 PING 192.168.0.5 (192.168.0.5) 56(84) bytes of data. 64 bytes from 192.168.0.5: icmp_seq=1 ttl=63 time=0.849 ms 64 bytes from 192.168.0.5: icmp_seq=2 ttl=63 time=0.839 ms ^C --- 192.168.0.5 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 0.839/0.844/0.849/0.005 ms Traceroute a clientenormal (para que se vea claro la utilizaci\u00f3n del t\u00fanel VPN) : vagrant@clientevpn:/etc/openvpn/client$ traceroute 192.168.0.5 traceroute to 192.168.0.5 (192.168.0.5), 30 hops max, 60 byte packets 1 10.99.99.1 (10.99.99.1) 0.446 ms 0.364 ms 0.331 ms 2 192.168.0.5 (192.168.0.5) 0.553 ms 0.612 ms 0.581 ms Parte 2: sitio a sitio OpenVPN Escenario Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientenormal1 do |clientenormal1| clientenormal1.vm.box = \"debian/bullseye64\" clientenormal1.vm.hostname = \"clientenormal1\" clientenormal1.vm.network :private_network, :libvirt__network_name => \"privada1-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientevpn do |clientevpn| clientevpn.vm.box = \"debian/bullseye64\" clientevpn.vm.hostname = \"clientevpn\" clientevpn.vm.network :private_network, :libvirt__network_name => \"privada1-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" clientevpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :servervpn do |servervpn| servervpn.vm.box = \"debian/bullseye64\" servervpn.vm.hostname = \"servervpn\" servervpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" servervpn.vm.network :private_network, :libvirt__network_name => \"privada2-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal2 do |clientenormal2| clientenormal2.vm.box = \"debian/bullseye64\" clientenormal2.vm.hostname = \"clientenormal2\" clientenormal2.vm.network :private_network, :libvirt__network_name => \"privada2-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end En servervpn Instalar OpenVPN sudo apt update sudo apt install openvpn Habilitar forwarding echo 1 > /proc/sys/net/ipv4/ip_forward Crear PKI sudo cp -r /usr/share/easy-rsa /etc/openvpn cd /etc/openvpn/easy-rsa sudo ./easyrsa init-pki init-pki complete; you may now create a CA or requests. Your newly created PKI dir is: /etc/openvpn/easy-rsa/pki Generar certificado + clave privada de la CA sudo ./easyrsa build-ca Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Enter New CA Key Passphrase: Re-Enter New CA Key Passphrase: Generating RSA private key, 2048 bit long modulus (2 primes) ..................+++++ ..................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Adrianj CA CA creation complete and you may now import and sign cert requests. Your new CA certificate file for publishing is at: /etc/openvpn/easy-rsa/pki/ca.crt Passphrase: 1234 Generar certificado + clave privada del servidor VPN sudo ./easyrsa build-server-full server nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key ..............................................................+++++ ........................................................................................................................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2046.nRVdyM/tmp.6vm2xf' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2046.nRVdyM/tmp.3Nm9uS Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'server' Certificate is to be certified until Apr 3 09:13:11 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated Generar par\u00e1metros Diffie\u2013Hellman sudo ./easyrsa gen-dh Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time ...................................+....................+..........................+....................................................................................................................................................................................................................+.....................+.....................................................................................................................................................................................................................................+...........+.................................................................................................................................+.................................................+....................................................+.........................................................................................................................................................................................................................+.............................+.............................................+..................................................................................................................................................................+............................................................................................................................................................................................................................................................................+..............................................................................................................................+.........................................................................................................+.......................................................................+................................................................................................................................................................+.......................................................................................................................................................+........................................................................................................................................................................................+...................................................................................+............................................................................+....................................+...............................................................+...............................................................................................................+.....................................................................................................................................................................................................................................+.....................+...................................+..................................................................................................+.............................................................................................+.......................................................................+..................................+......................................................................................................................................+....................................................+........................................................................................................................................................................................................................................................+........................................................................................................................................+...................................................................................................................................+....................................+....................+.....................................................................................................+..+...............................+..................................+...........................+.....................................................................................................................+...............................................................................................................................................................................................+................+...+.........................................................+..+.........+....+...+................................................................................................+...............................................................................................................................................................................................................................................................................................................................................+..................................................................+...............................................................................................................................+.....................................................................................................+............+...................................+.............................................................................................................................................+...............................................................................................+.........+.................+...........................................................................................................................................+....+........................................................................................+................+........+................................................................................................................................................................................................................................................+.......................................................................................................+.............................................................................................................................................................................................................................................+................................................................+...........................................................................................................................................................................+..................+..................................+...................................................................................................................................................................................................................................+....................................................................................................+.......................................................................................................................................................................................+..................................++*++*++*++* DH parameters of size 2048 created at /etc/openvpn/easy-rsa/pki/dh.pem Generar certificado + clave privada del cliente VPN sudo ./easyrsa build-client-full clientevpn nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key .......................................................................+++++ ................................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2162.MUtxW0/tmp.cwHjMI' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2162.MUtxW0/tmp.tJCZID Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'clientevpn' Certificate is to be certified until Apr 3 09:28:02 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated Pasar ficheros necesarios al cliente VPN sudo cp -rp /etc/openvpn/easy-rsa/pki/{ca.crt,issued/clientevpn.crt,private/clientevpn.key} ~ sudo chown vagrant: ~/{ca.crt,clientevpn.crt,clientevpn.key} scp ~/{ca.crt,clientevpn.crt,clientevpn.key} vagrant@192.88.99.11:/home/vagrant Configurar el servidor VPN Creo el client-config-dir junto con un fichero con informaci\u00f3n sobre clientevpn : cd /etc/openvpn sudo mkdir ccd cd ccd sudo touch clientevpn echo iroute 192.168.0.0 255.255.255.0 > /etc/openvpn/ccd/clientevpn Creo el fichero de configuraci\u00f3n partiendo de una plantilla: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf Modifico /etc/openvpn/server/servidor.conf : port 1194 proto udp dev tun ca /etc/openvpn/easy-rsa/pki/ca.crt cert /etc/openvpn/easy-rsa/pki/issued/server.crt key /etc/openvpn/easy-rsa/pki/private/server.key dh /etc/openvpn/easy-rsa/pki/dh.pem topology subnet server 10.99.99.0 255.255.255.0 ifconfig-pool-persist /var/log/openvpn/ipp.txt push \"route 192.168.1.0 255.255.255.0\" client-config-dir /etc/openvpn/ccd route 192.168.0.0 255.255.255.0 keepalive 10 120 cipher AES-256-CBC persist-key persist-tun status /var/log/openvpn/openvpn-status.log verb 3 explicit-exit-notify 1 Iniciar el servidor sudo systemctl enable --now openvpn-server@servidor Verifico que est\u00e1 funcionando: sudo systemctl status openvpn-server@servidor \u25cf openvpn-server@servidor.service - OpenVPN service for servidor Loaded: loaded (/lib/systemd/system/openvpn-server@.service; enabled; vendor preset: enabled) Active: active (running) since Thu 2021-12-30 09:47:53 UTC; 12s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 2291 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1020.0K CPU: 7ms CGroup: /system.slice/system-openvpn\\x2dserver.slice/openvpn-server@servidor.service \u2514\u25002291 /usr/sbin/openvpn --status /run/openvpn-server/status-servidor.log --status-vers> Dec 30 09:47:53 servervpn openvpn[2291]: net_addr_v4_add: 10.99.99.1/24 dev tun0 Dec 30 09:47:53 servervpn openvpn[2291]: net_route_v4_add: 192.168.0.0/24 via 10.99.99.2 dev [NULL] > Dec 30 09:47:53 servervpn openvpn[2291]: Could not determine IPv4/IPv6 protocol. Using AF_INET Dec 30 09:47:53 servervpn openvpn[2291]: Socket Buffers: R=[212992->212992] S=[212992->212992] Dec 30 09:47:53 servervpn openvpn[2291]: UDPv4 link local (bound): [AF_INET][undef]:1194 Dec 30 09:47:53 servervpn openvpn[2291]: UDPv4 link remote: [AF_UNSPEC] Dec 30 09:47:53 servervpn openvpn[2291]: MULTI: multi_init called, r=256 v=256 Dec 30 09:47:53 servervpn openvpn[2291]: IFCONFIG POOL IPv4: base=10.99.99.2 size=252 Dec 30 09:47:53 servervpn openvpn[2291]: IFCONFIG POOL LIST En clientevpn Instalar OpenVPN sudo apt update sudo apt install openvpn Habilitar forwarding echo 1 > /proc/sys/net/ipv4/ip_forward Mover ficheros a la ruta adecuada sudo mv ~/{ca.crt,clientevpn.crt,clientevpn.key} /etc/openvpn/client sudo chown root: /etc/openvpn/client/* Configurar el cliente VPN Copio la plantilla oficial de configuraci\u00f3n para clientes openvpn, para partir de ella: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client/cliente.conf Modifico /etc/openvpn/client/cliente.conf : client dev tun proto udp remote 192.88.99.10 1194 resolv-retry infinite nobind persist-key persist-tun ca /etc/openvpn/client/ca.crt cert /etc/openvpn/client/clientevpn.crt key /etc/openvpn/client/clientevpn.key remote-cert-tls server cipher AES-256-CBC verb 3 Habilito el servicio: sudo systemctl enable --now openvpn-client@cliente Verifico que funciona: sudo systemctl status openvpn-client@cliente \u25cf openvpn-client@cliente.service - OpenVPN tunnel for cliente Loaded: loaded (/lib/systemd/system/openvpn-client@.service; enabled; vendor preset: enabled) Active: active (running) since Thu 2021-12-30 10:20:45 UTC; 39s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 10909 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1.4M CPU: 11ms CGroup: /system.slice/system-openvpn\\x2dclient.slice/openvpn-client@cliente.service \u2514\u250010909 /usr/sbin/openvpn --suppress-timestamps --nobind --config cliente.conf Dec 30 10:20:45 clientevpn openvpn[10909]: net_route_v4_best_gw query: dst 0.0.0.0 Dec 30 10:20:45 clientevpn openvpn[10909]: net_route_v4_best_gw result: via 192.168.121.1 dev eth0 Dec 30 10:20:45 clientevpn openvpn[10909]: ROUTE_GATEWAY 192.168.121.1/255.255.255.0 IFACE=eth0 HWADDR=52:54:00:> Dec 30 10:20:45 clientevpn openvpn[10909]: TUN/TAP device tun0 opened Dec 30 10:20:45 clientevpn openvpn[10909]: net_iface_mtu_set: mtu 1500 for tun0 Dec 30 10:20:45 clientevpn openvpn[10909]: net_iface_up: set tun0 up Dec 30 10:20:45 clientevpn openvpn[10909]: net_addr_v4_add: 10.99.99.2/24 dev tun0 Dec 30 10:20:45 clientevpn openvpn[10909]: net_route_v4_add: 192.168.1.0/24 via 10.99.99.1 dev [NULL] table 0 me> Dec 30 10:20:45 clientevpn openvpn[10909]: WARNING: this configuration may cache passwords in memory -- use the > En clientenormal1 Cambiar ruta por defecto sudo ip route del default sudo ip route add default via 192.168.0.1 En clientenormal2 Cambiar ruta por defecto sudo ip route del default sudo ip route add default via 192.168.1.1 Pruebas de funcionamiento Ping desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ ping 192.168.1.2 PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data. 64 bytes from 192.168.1.2: icmp_seq=1 ttl=62 time=4.45 ms 64 bytes from 192.168.1.2: icmp_seq=2 ttl=62 time=2.30 ms ^C --- 192.168.1.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 2.301/3.376/4.451/1.075 ms Ping desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=62 time=2.26 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=62 time=2.24 ms 64 bytes from 192.168.0.2: icmp_seq=3 ttl=62 time=2.19 ms ^C --- 192.168.0.2 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2004ms rtt min/avg/max/mdev = 2.188/2.229/2.264/0.031 ms Traceroute desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ traceroute 192.168.1.2 traceroute to 192.168.1.2 (192.168.1.2), 30 hops max, 60 byte packets 1 192.168.0.1 (192.168.0.1) 0.521 ms 0.438 ms 0.433 ms 2 10.99.99.1 (10.99.99.1) 2.229 ms 2.196 ms 2.177 ms 3 192.168.1.2 (192.168.1.2) 2.129 ms 2.082 ms 2.035 ms Traceroute desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ traceroute 192.168.0.2 traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets 1 192.168.1.1 (192.168.1.1) 0.613 ms 0.538 ms 0.507 ms 2 10.99.99.2 (10.99.99.2) 2.864 ms 2.828 ms 2.812 ms 3 192.168.0.2 (192.168.0.2) 2.824 ms 2.778 ms 3.276 ms Parte 3: acceso remoto WireGuard Escenario Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientevpn do |clientevpn| clientevpn.vm.box = \"debian/bullseye64\" clientevpn.vm.hostname = \"clientevpn\" clientevpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :servervpn do |servervpn| servervpn.vm.box = \"debian/bullseye64\" servervpn.vm.hostname = \"servervpn\" servervpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" servervpn.vm.network :private_network, :libvirt__network_name => \"privada-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal do |clientenormal| clientenormal.vm.box = \"debian/bullseye64\" clientenormal.vm.hostname = \"clientenormal\" clientenormal.vm.network :private_network, :libvirt__network_name => \"privada-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end En servervpn Instalar WireGuard sudo apt update sudo apt install wireguard Generar par de claves wg genkey | sudo tee /etc/wireguard/server_private.key | wg pubkey | sudo tee /etc/wireguard/server_public.key Configurar Creo el fichero de configuraci\u00f3n (wg0 ser\u00e1 el nombre de la interfaz) : sudo touch /etc/wireguard/wg0.conf Lo modifico: [Interface] Address = 10.99.99.1/24 ListenPort = 51820 PrivateKey = wPO8E5rUB9hFCwJMQYsLwDtNV7eX9SZmL9h/VO+NwFY= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] PublicKey = GLJ8rEoPu22e+t2xPP54TJoGCoq09+HiOuiwBV3TzSw= AllowedIPs = 10.99.99.2/32 Modificar permisos sudo chmod 600 /etc/wireguard/ -R Iniciar WireGuard sudo wg-quick up /etc/wireguard/wg0.conf [#] sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 [#] ip link add wg0 type wireguard [#] wg setconf wg0 /dev/fd/63 [#] ip -4 address add 10.99.99.1/24 dev wg0 [#] ip link set mtu 1420 up dev wg0 Se nos crea la interfaz: 5: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.1/24 scope global wg0 valid_lft forever preferred_lft forever Y la ruta: 10.99.99.0/24 dev wg0 proto kernel scope link src 10.99.99.1 En clientevpn (debian 11) Instalar WireGuard sudo apt update sudo apt install wireguard Generar par de claves wg genkey | sudo tee /etc/wireguard/client_private.key | wg pubkey | sudo tee /etc/wireguard/client_public.key Configurar Creo el fichero de configuraci\u00f3n (wg-client0 ser\u00e1 el nombre de la interfaz) : sudo touch /etc/wireguard/wg-client0.conf Lo modifico: [Interface] Address = 10.99.99.2/24 PrivateKey = iO5lDgbhB6cGsJL6Udw0SP+9x4N0FHrRj2irMiNM93Y= [Peer] PublicKey = K7noXpmRF60rW7BjqGTHTF8PaOVLASb1UJJF62YsFw8= AllowedIPs = 0.0.0.0/0 Endpoint = 192.88.99.10:51820 PersistentKeepalive = 25 Modificar permisos sudo chmod 600 /etc/wireguard/ -R Iniciar WireGuard sudo wg-quick up /etc/wireguard/wg-client0.conf [#] ip link add wg-client0 type wireguard [#] wg setconf wg-client0 /dev/fd/63 [#] ip -4 address add 10.99.99.2/24 dev wg-client0 [#] ip link set mtu 1420 up dev wg-client0 [#] wg set wg-client0 fwmark 51820 [#] ip -4 route add 0.0.0.0/0 dev wg-client0 table 51820 [#] ip -4 rule add not fwmark 51820 table 51820 [#] ip -4 rule add table main suppress_prefixlength 0 [#] sysctl -q net.ipv4.conf.all.src_valid_mark=1 [#] nft -f /dev/fd/63 Se nos crea la interfaz: 4: wg-client0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.2/24 scope global wg-client0 valid_lft forever preferred_lft forever Y la ruta: 10.99.99.0/24 dev wg-client0 proto kernel scope link src 10.99.99.2 En clientenormal Cambiar ruta por defecto sudo ip route del default sudo ip route add default via 192.168.0.1 Pruebas de funcionamiento (todas hechas desde clientevpn) Ping al otro extremo del t\u00fanel: vagrant@clientevpn:~$ ping 10.99.99.1 PING 10.99.99.1 (10.99.99.1) 56(84) bytes of data. 64 bytes from 10.99.99.1: icmp_seq=1 ttl=64 time=2.43 ms 64 bytes from 10.99.99.1: icmp_seq=2 ttl=64 time=0.232 ms ^C --- 10.99.99.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.232/1.328/2.425/1.096 ms Ping a clientenormal: vagrant@clientevpn:~$ ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=63 time=1.56 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=63 time=0.360 ms ^C --- 192.168.0.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.360/0.959/1.559/0.599 ms Traceroute a clientenormal: vagrant@clientevpn:~$ traceroute 192.168.0.2 traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets 1 10.99.99.1 (10.99.99.1) 0.734 ms 0.275 ms 0.242 ms 2 192.168.0.2 (192.168.0.2) 0.712 ms 0.664 ms 0.617 ms Extra: cliente VPN Windows Conectar cliente Conecto la VM a la red internet-vpn3 : Configuro est\u00e1ticamente la interfaz: netsh interface ip set address name=\"Ethernet\" static 192.88.99.12 255.255.255.0 192.88.99.10 Compruebo que la configuraci\u00f3n se aplic\u00f3 correctamente: Compruebo que tengo conectividad con servervpn: Configurar cliente Descargo e instalo Wireguard: Compruebo que funciona el programa: Creo un nuevo t\u00fanel en blanco: Como nos podemos dar cuenta, la generaci\u00f3n de claves ha sido autom\u00e1tica: Completo la configuraci\u00f3n y nombro el t\u00fanel: Verifico que se ha creado correctamente: Nos damos cuenta de que est\u00e1 inactivo (por ahora). Modificar el servidor Tengo que a\u00f1adir el nuevo peer a wg0.conf . El fichero se quedar\u00eda as\u00ed: [Interface] Address = 10.99.99.1/24 ListenPort = 51820 PrivateKey = wPO8E5rUB9hFCwJMQYsLwDtNV7eX9SZmL9h/VO+NwFY= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] PublicKey = GLJ8rEoPu22e+t2xPP54TJoGCoq09+HiOuiwBV3TzSw= AllowedIPs = 10.99.99.2/32 [Peer] PublicKey = 3CNoT/Zae2eXK+yW0wm13qFWOEOwUcfCQrcIGttUPyk= AllowedIPs = 10.99.99.3/32 Reinicio el servidor para que los cambios tomen efecto: sudo wg-quick down /etc/wireguard/wg0.conf sudo wg-quick up /etc/wireguard/wg0.conf Activar cliente Vemos que se nos crea la interfaz de t\u00fanel: Pruebas de funcionamiento Ping al otro extremo del t\u00fanel: Ping a clientenormal: Tracert a clientenormal: Extra: cliente VPN Android Conectar cliente Conecto la VM a la red internet-vpn3 : Configuro est\u00e1ticamente la interfaz: ifconfig wlan0 192.88.99.13 netmask 255.255.255.0 up Compruebo que la configuraci\u00f3n se aplic\u00f3 correctamente: Compruebo que tengo conectividad con servervpn: Configurar cliente Instalo Wireguard: Compruebo que funciona el programa: Creo un nuevo t\u00fanel en blanco: Genero un par de claves: Completo la configuraci\u00f3n: Verifico que se ha creado correctamente el t\u00fanel: Est\u00e1 inactivo (por ahora). Modificar el servidor Tengo que a\u00f1adir el nuevo peer a wg0.conf . El fichero se quedar\u00eda as\u00ed: [Interface] Address = 10.99.99.1/24 ListenPort = 51820 PrivateKey = wPO8E5rUB9hFCwJMQYsLwDtNV7eX9SZmL9h/VO+NwFY= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] PublicKey = GLJ8rEoPu22e+t2xPP54TJoGCoq09+HiOuiwBV3TzSw= AllowedIPs = 10.99.99.2/32 [Peer] PublicKey = 3CNoT/Zae2eXK+yW0wm13qFWOEOwUcfCQrcIGttUPyk= AllowedIPs = 10.99.99.3/32 [Peer] PublicKey = DJusByULiqhbzBhSCDdVJZAjH6mNEUVE9qlyYc/CylM= AllowedIPs = 10.99.99.4/32 Reinicio el servidor para que los cambios tomen efecto: sudo wg-quick down /etc/wireguard/wg0.conf sudo wg-quick up /etc/wireguard/wg0.conf Activar cliente Vemos que se nos crea la interfaz de t\u00fanel: Pruebas de funcionamiento Ping al otro extremo del t\u00fanel: Ping a clientenormal: Traceroute a clientenormal: Conclusiones Aqu\u00ed expondr\u00e9 las conclusiones a las que he llegado tras comparar el acceso remoto de WireGuard con el de OpenVPN. Con WireGuard no existe realmente el concepto de cliente-servidor, sino el de peer-to-peer. Aunque en la pr\u00e1ctica, se distingue f\u00e1cilmente cu\u00e1l es el \"servidor\" porque es en el que abrimos un puerto espec\u00edfico durante la configuraci\u00f3n. La autenticaci\u00f3n es mucho m\u00e1s sencilla con WireGuard, ya que se usa un par de claves y no certificados. Conceptualmente ambos mecanismos son casi iguales, pero en la pr\u00e1ctica es mucho m\u00e1s c\u00f3modo trabajar con un par de claves porque nos ahorramos el tener que crear una Autoridad Certificadora, el firmado de certificados...etc. Es muy parecido, por no decir casi igual, a como se trabaja con SSH. Los ficheros de configuraci\u00f3n son notoriamente m\u00e1s cortos y sencillos en WireGuard. WireGuard nos proporciona la herramienta wg-quick para controlar el servicio, lo cual es mucho m\u00e1s sencillo que trabajar con systemd. Parte 4: sitio a sitio WireGuard Escenario Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientenormal1 do |clientenormal1| clientenormal1.vm.box = \"debian/bullseye64\" clientenormal1.vm.hostname = \"clientenormal1\" clientenormal1.vm.network :private_network, :libvirt__network_name => \"privada1-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :peervpn1 do |peervpn1| peervpn1.vm.box = \"debian/bullseye64\" peervpn1.vm.hostname = \"peervpn1\" peervpn1.vm.network :private_network, :libvirt__network_name => \"privada1-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" peervpn1.vm.network :private_network, :libvirt__network_name => \"internet-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :peervpn2 do |peervpn2| peervpn2.vm.box = \"debian/bullseye64\" peervpn2.vm.hostname = \"peervpn2\" peervpn2.vm.network :private_network, :libvirt__network_name => \"internet-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" peervpn2.vm.network :private_network, :libvirt__network_name => \"privada2-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal2 do |clientenormal2| clientenormal2.vm.box = \"debian/bullseye64\" clientenormal2.vm.hostname = \"clientenormal2\" clientenormal2.vm.network :private_network, :libvirt__network_name => \"privada2-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end En peervpn1 Instalar WireGuard sudo apt update sudo apt install wireguard Generar par de claves wg genkey | sudo tee /etc/wireguard/peervpn1_private.key | wg pubkey | sudo tee /etc/wireguard/peervpn1_public.key Configurar Creo el fichero de configuraci\u00f3n: sudo touch /etc/wireguard/wg0.conf Lo modifico: [Interface] Address = 10.99.99.1/32 ListenPort = 51820 PrivateKey = 4FMOxWlQLSGHlfgjFKBkmPDeURsHh7RBeCAoYMd/vGw= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] Endpoint = 192.88.99.10:51820 AllowedIPs = 10.99.99.2/32, 192.168.1.0/24 PublicKey = FMJMI1Cg7jOLPTZj49DP/KE7RVK9/J8X5l3KG4LVf2Q= Modificar permisos sudo chmod 600 /etc/wireguard/ -R Iniciar WireGuard sudo wg-quick up /etc/wireguard/wg0.conf [#] sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 [#] ip link add wg0 type wireguard [#] wg setconf wg0 /dev/fd/63 [#] ip -4 address add 10.99.99.1/32 dev wg0 [#] ip link set mtu 1420 up dev wg0 [#] ip -4 route add 10.99.99.2/32 dev wg0 [#] ip -4 route add 192.168.1.0/24 dev wg0 Se crea la interfaz: 7: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.1/32 scope global wg0 valid_lft forever preferred_lft forever Y las rutas: 10.99.99.2 dev wg0 scope link 192.168.1.0/24 dev wg0 scope link En peervpn2 Instalar WireGuard sudo apt update sudo apt install wireguard Generar par de claves wg genkey | sudo tee /etc/wireguard/peervpn2_private.key | wg pubkey | sudo tee /etc/wireguard/peervpn2_public.key Configurar Creo el fichero de configuraci\u00f3n: sudo touch /etc/wireguard/wg0.conf Lo modifico: [Interface] Address = 10.99.99.2/32 ListenPort = 51820 PrivateKey = UP7xLuRK2JtsFxUwWqHxeREAwKPQPO9mvYfI+neNd3E= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] Endpoint = 192.88.99.11:51820 AllowedIPs = 10.99.99.1/32, 192.168.0.0/24 PublicKey = nN/tik1TNOkFuupFVlNOaEO5hwQFKlsUWoKYsSCutzA= Modificar permisos sudo chmod 600 /etc/wireguard/ -R Iniciar WireGuard sudo wg-quick up /etc/wireguard/wg0.conf [#] sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 [#] ip link add wg0 type wireguard [#] wg setconf wg0 /dev/fd/63 [#] ip -4 address add 10.99.99.2/32 dev wg0 [#] ip link set mtu 1420 up dev wg0 [#] ip -4 route add 10.99.99.1/32 dev wg0 [#] ip -4 route add 192.168.0.0/24 dev wg0 Se nos crea la interfaz: 7: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.2/32 scope global wg0 valid_lft forever preferred_lft forever Y las rutas: 10.99.99.1 dev wg0 scope link 192.168.0.0/24 dev wg0 scope link En clientenormal1 Cambiar ruta por defecto sudo ip route del default sudo ip route add default via 192.168.0.1 En clientenormal2 Cambiar ruta por defecto sudo ip route del default sudo ip route add default via 192.168.1.1 Pruebas de funcionamiento Ping desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ ping 192.168.1.2 PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data. 64 bytes from 192.168.1.2: icmp_seq=1 ttl=62 time=2.77 ms 64 bytes from 192.168.1.2: icmp_seq=2 ttl=62 time=0.958 ms ^C --- 192.168.1.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.958/1.865/2.772/0.907 ms Ping desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=62 time=1.26 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=62 time=0.721 ms ^C --- 192.168.0.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 0.721/0.992/1.264/0.271 ms Traceroute desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ traceroute 192.168.1.2 traceroute to 192.168.1.2 (192.168.1.2), 30 hops max, 60 byte packets 1 192.168.0.1 (192.168.0.1) 0.264 ms 0.244 ms 0.228 ms 2 10.99.99.2 (10.99.99.2) 0.558 ms 0.540 ms 0.495 ms 3 192.168.1.2 (192.168.1.2) 0.748 ms 0.700 ms 0.685 ms Traceroute desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ traceroute 192.168.0.2 traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets 1 192.168.1.1 (192.168.1.1) 0.800 ms 0.774 ms 0.764 ms 2 10.99.99.1 (10.99.99.1) 1.665 ms 1.653 ms 1.760 ms 3 192.168.0.2 (192.168.0.2) 2.553 ms 2.544 ms 2.535 ms Conclusiones Aqu\u00ed expondr\u00e9 las conclusiones a las que he llegado tras comparar el sitio a sitio de WireGuard con el de OpenVPN. Adem\u00e1s de las ya mencionadas en el anterior apartado de conclusiones, s\u00f3lo quedar\u00eda una m\u00e1s por destacar, y que s\u00f3lo ha sucedido con la configuraci\u00f3n de sitio a sitio: El manejo de rutas es mucho m\u00e1s sencillo con WireGuard, ya que s\u00f3lo nos tenemos que preocupar de que el par\u00e1metro AllowedIPs est\u00e9 correctamente relleno con las rutas que necesitamos en cada peer. Con OpenVPN influyen los ccd , \"complicando\" un poco la configuraci\u00f3n. Bibliograf\u00eda PARTE 1: https://kifarunix.com/install-openvpn-server-on-debian-11-debian-10/ PARTE 2: https://medium.com/@bjammal/site-to-site-vpn-on-a-single-host-using-openvpn-e9c5cdb22f92 https://www.matoski.com/article/site-to-site-openvpn-firewalld-debian/ https://openvpn.net/community-resources/how-to/#scope (secci\u00f3n Including multiple machines on the client side when using a routed VPN (dev tun) ) PARTE 3: https://www.linuxbabe.com/debian/wireguard-vpn-server-debian https://www.makeuseof.com/how-to-set-up-wireguard-windows/ PARTE 4: https://www.procustodibus.com/blog/2020/12/wireguard-site-to-site-config/","title":"Pr\u00e1ctica: VPN"},{"location":"practica-vpn-sad/#practica-vpn","text":"","title":"Pr\u00e1ctica: VPN"},{"location":"practica-vpn-sad/#parte-1-acceso-remoto-openvpn","text":"","title":"Parte 1: acceso remoto OpenVPN"},{"location":"practica-vpn-sad/#escenario","text":"Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientevpn do |clientevpn| clientevpn.vm.box = \"debian/bullseye64\" clientevpn.vm.hostname = \"clientevpn\" clientevpn.vm.network :private_network, :libvirt__network_name => \"externa-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :servervpn do |servervpn| servervpn.vm.box = \"debian/bullseye64\" servervpn.vm.hostname = \"servervpn\" servervpn.vm.network :private_network, :libvirt__network_name => \"externa-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" servervpn.vm.network :private_network, :libvirt__network_name => \"interna-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal do |clientenormal| clientenormal.vm.box = \"debian/bullseye64\" clientenormal.vm.hostname = \"clientenormal\" clientenormal.vm.network :private_network, :libvirt__network_name => \"interna-vpn\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.5\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end","title":"Escenario"},{"location":"practica-vpn-sad/#en-servervpn","text":"","title":"En servervpn"},{"location":"practica-vpn-sad/#instalar-openvpn","text":"sudo apt update sudo apt install openvpn","title":"Instalar OpenVPN"},{"location":"practica-vpn-sad/#habilitar-forwarding","text":"echo 1 > /proc/sys/net/ipv4/ip_forward","title":"Habilitar forwarding"},{"location":"practica-vpn-sad/#crear-infraestructura-de-clave-publica","text":"Seg\u00fan la gu\u00eda que estoy siguiendo es necesario copiar la configuraci\u00f3n de /usr/share/easy-rsa a /etc/openvpn antes de continuar, para prevenir que futuras actualizaciones del paquete OpenVPN modifiquen las configuraciones que hagamos. En nuestro caso esta posibilidad nunca llegar\u00eda a hacerse realidad , puesto que lo que estamos haciendo es simplemente una pr\u00e1ctica, que se extiende durante un periodo de tiempo relativamente corto. A\u00fan as\u00ed, lo hago por razones de organizaci\u00f3n, ya que todas las configuraciones manuales deben estar bajo /etc . sudo cp -r /usr/share/easy-rsa /etc/openvpn cd /etc/openvpn/easy-rsa Inicializamos la PKI: sudo ./easyrsa init-pki init-pki complete; you may now create a CA or requests. Your newly created PKI dir is: /etc/openvpn/easy-rsa/pki","title":"Crear infraestructura de clave p\u00fablica"},{"location":"practica-vpn-sad/#generar-certificado-clave-privada-de-la-ca","text":"En este paso obtendremos el par de claves necesario de la Autoridad Certificadora (CA). Posteriormente, es esta clave privada la que se usar\u00e1 para firmar los certificados tanto del servidor como del cliente. sudo ./easyrsa build-ca Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Enter New CA Key Passphrase: Re-Enter New CA Key Passphrase: Generating RSA private key, 2048 bit long modulus (2 primes) ........................................................................................+++++ .......................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Adrianj CA CA creation complete and you may now import and sign cert requests. Your new CA certificate file for publishing is at: /etc/openvpn/easy-rsa/pki/ca.crt Passphrase: 1234 Certificado generado: /etc/openvpn/easy-rsa/pki/ca.crt Clave privada generada: /etc/openvpn/easy-rsa/pki/private/ca.key","title":"Generar certificado + clave privada de la CA"},{"location":"practica-vpn-sad/#generar-certificado-clave-privada-del-servidor-vpn","text":"sudo ./easyrsa build-server-full server nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key .......+++++ ............................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2389.Tqf1G1/tmp.Ow20MK' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2389.Tqf1G1/tmp.5Exl9Q Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'server' Certificate is to be certified until Mar 18 08:30:09 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated Certificado generado: /etc/openvpn/easy-rsa/pki/issued/server.crt Clave privada generada: /etc/openvpn/easy-rsa/pki/private/server.key","title":"Generar certificado + clave privada del servidor VPN"},{"location":"practica-vpn-sad/#generar-parametros-diffiehellman","text":"sudo ./easyrsa gen-dh Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time .......................+.....................+..............................................................+......................+................................................................................+...................................................................................................................................................+....................+....................................................................+..................+.......+..............................................................+...........................................................................+................................................................................................................................+.....................................+...........................................................................................................................................................................+................................................................................................................................................................................................................+.+.............................+.........................+..............................................................................................................................................................................................................................+..............+......................................................................+................................+.................................+......................................................................................................+............................................................................................+...........................................................................................................................................................................................+........................................+.............................................................................+....................................................................................................+...........+...........................................................+.....................................................................+...............................................................................................................................................+...........................................................................................................................................+.....................................+........................................................................................+...................+.............+.......................+.......................................................................................+.........................................................+...........................................................................+...............................................................................................................................................................+.......................................+........................................................+..........................................+................................................................................................................+.........+.............................+..........................................................................+...............................................+............................................................................................................+.......+...............................................................................................................+............................................+................+..................................................+...............+..............................................................................+.......................................................................+.................................+..+.+.+..............................................................................................+.............................................................................+...................................................................................................................................................................................................+...........+................................................................................+............................................................................................................................................................................................................+............................+..+......................................................................................................................................................................................+..............................................................................................+......................................................................................................................................................................................................................................................................................................................................................................................................+........................................+......................+...............................+...........................+...............................................................................................+..........................................................................................................................+.......................................................................+.................................................................................+....................................................................+................................+.++*++*++*++* DH parameters of size 2048 created at /etc/openvpn/easy-rsa/pki/dh.pem","title":"Generar par\u00e1metros Diffie\u2013Hellman"},{"location":"practica-vpn-sad/#generar-certificado-clave-privada-del-cliente-vpn","text":"sudo ./easyrsa build-client-full clientevpn nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key ..............+++++ ................................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2541.yaiUd0/tmp.WePx19' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2541.yaiUd0/tmp.GMaG7k Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'clientevpn' Certificate is to be certified until Mar 18 08:49:43 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated Certificado generado: /etc/openvpn/easy-rsa/pki/issued/clientevpn.crt Clave privada generada: /etc/openvpn/easy-rsa/pki/private/clientevpn.key","title":"Generar certificado + clave privada del cliente VPN"},{"location":"practica-vpn-sad/#pasar-ficheros-necesarios-al-cliente-vpn","text":"sudo cp -rp /etc/openvpn/easy-rsa/pki/{ca.crt,issued/clientevpn.crt,private/clientevpn.key} ~ sudo chown vagrant: ~/{ca.crt,clientevpn.crt,clientevpn.key} scp ~/{ca.crt,clientevpn.crt,clientevpn.key} vagrant@192.88.99.11:/home/vagrant","title":"Pasar ficheros necesarios al cliente VPN"},{"location":"practica-vpn-sad/#configurar-el-servidor-vpn","text":"Copio la plantilla oficial de configuraci\u00f3n para servidores openvpn, para partir de ella: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf Modifico /etc/openvpn/server/servidor.conf : port 1194 proto udp dev tun ca /etc/openvpn/easy-rsa/pki/ca.crt cert /etc/openvpn/easy-rsa/pki/issued/server.crt key /etc/openvpn/easy-rsa/pki/private/server.key dh /etc/openvpn/easy-rsa/pki/dh.pem topology subnet # DIRECCIONAMIENTO PARA EL T\u00daNEL # # El servidor ser\u00e1: 10.99.99.1 # El resto de IPs estar\u00e1n disponibles para los clientes server 10.99.99.0 255.255.255.0 ifconfig-pool-persist /var/log/openvpn/ipp.txt push \"route 192.168.0.0 255.255.255.0\" keepalive 10 120 cipher AES-256-CBC persist-key persist-tun status /var/log/openvpn/openvpn-status.log verb 3 explicit-exit-notify 1","title":"Configurar el servidor VPN"},{"location":"practica-vpn-sad/#iniciar-el-servidor","text":"sudo systemctl enable --now openvpn-server@servidor Verifico que est\u00e1 funcionando: sudo systemctl status openvpn-server@servidor \u25cf openvpn-server@servidor.service - OpenVPN service for servidor Loaded: loaded (/lib/systemd/system/openvpn-server@.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2021-12-14 09:16:30 UTC; 35s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 2800 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1.0M CPU: 9ms CGroup: /system.slice/system-openvpn\\x2dserver.slice/openvpn-server@servidor.service \u2514\u25002800 /usr/sbin/openvpn --status /run/openvpn-server/status-servidor.log --status-version 2 --suppress-timestamps --config servidor.conf Dec 14 09:16:30 servervpn openvpn[2800]: net_iface_up: set tun0 up Dec 14 09:16:30 servervpn openvpn[2800]: net_addr_v4_add: 10.99.99.1/24 dev tun0 Dec 14 09:16:30 servervpn openvpn[2800]: Could not determine IPv4/IPv6 protocol. Using AF_INET Dec 14 09:16:30 servervpn openvpn[2800]: Socket Buffers: R=[212992->212992] S=[212992->212992] Dec 14 09:16:30 servervpn openvpn[2800]: UDPv4 link local (bound): [AF_INET][undef]:1194 Dec 14 09:16:30 servervpn openvpn[2800]: UDPv4 link remote: [AF_UNSPEC] Dec 14 09:16:30 servervpn openvpn[2800]: MULTI: multi_init called, r=256 v=256 Dec 14 09:16:30 servervpn openvpn[2800]: IFCONFIG POOL IPv4: base=10.99.99.2 size=252 Dec 14 09:16:30 servervpn openvpn[2800]: IFCONFIG POOL LIST Dec 14 09:16:30 servervpn openvpn[2800]: Initialization Sequence Completed","title":"Iniciar el servidor"},{"location":"practica-vpn-sad/#en-clientevpn","text":"","title":"En clientevpn"},{"location":"practica-vpn-sad/#instalar-openvpn_1","text":"sudo apt update sudo apt install openvpn","title":"Instalar OpenVPN"},{"location":"practica-vpn-sad/#mover-ficheros-a-la-ruta-adecuada","text":"sudo mv ~/{ca.crt,clientevpn.crt,clientevpn.key} /etc/openvpn/client sudo chown root: /etc/openvpn/client/* /etc/openvpn/client queda as\u00ed: vagrant@clientevpn:/etc/openvpn/client$ ls -la total 24 drwxr-xr-x 2 root root 4096 Dec 14 09:31 . drwxr-xr-x 4 root root 4096 Dec 14 09:30 .. -rw------- 1 root root 1200 Dec 14 09:01 ca.crt -rw------- 1 root root 4498 Dec 14 09:01 clientevpn.crt -rw------- 1 root root 1704 Dec 14 09:01 clientevpn.key","title":"Mover ficheros a la ruta adecuada"},{"location":"practica-vpn-sad/#configurar-el-cliente-vpn","text":"Copio la plantilla oficial de configuraci\u00f3n para clientes openvpn, para partir de ella: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client/cliente.conf Modifico /etc/openvpn/client/cliente.conf : client dev tun proto udp remote 192.88.99.10 1194 resolv-retry infinite nobind persist-key persist-tun ca /etc/openvpn/client/ca.crt cert /etc/openvpn/client/clientevpn.crt key /etc/openvpn/client/clientevpn.key remote-cert-tls server cipher AES-256-CBC verb 3 Habilito el servicio: sudo systemctl enable --now openvpn-client@cliente Verifico que funciona: sudo systemctl status openvpn-client@cliente \u25cf openvpn-client@cliente.service - OpenVPN tunnel for cliente Loaded: loaded (/lib/systemd/system/openvpn-client@.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2021-12-14 09:43:44 UTC; 5s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 12859 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1.9M CPU: 17ms CGroup: /system.slice/system-openvpn\\x2dclient.slice/openvpn-client@cliente.service \u2514\u250012859 /usr/sbin/openvpn --suppress-timestamps --nobind --config cliente.conf Dec 14 09:43:44 clientevpn openvpn[12859]: net_route_v4_best_gw query: dst 0.0.0.0 Dec 14 09:43:44 clientevpn openvpn[12859]: net_route_v4_best_gw result: via 192.168.121.1 dev eth0 Dec 14 09:43:44 clientevpn openvpn[12859]: ROUTE_GATEWAY 192.168.121.1/255.255.255.0 IFACE=eth0 HWADD> Dec 14 09:43:44 clientevpn openvpn[12859]: TUN/TAP device tun0 opened Dec 14 09:43:44 clientevpn openvpn[12859]: net_iface_mtu_set: mtu 1500 for tun0 Dec 14 09:43:44 clientevpn openvpn[12859]: net_iface_up: set tun0 up Dec 14 09:43:44 clientevpn openvpn[12859]: net_addr_v4_add: 10.99.99.2/24 dev tun0 Dec 14 09:43:44 clientevpn openvpn[12859]: net_route_v4_add: 192.168.0.0/24 via 10.99.99.1 dev [NULL]> Dec 14 09:43:44 clientevpn openvpn[12859]: WARNING: this configuration may cache passwords in memory > Dec 14 09:43:44 clientevpn openvpn[12859]: Initialization Sequence Completed","title":"Configurar el cliente VPN"},{"location":"practica-vpn-sad/#en-clientenormal","text":"","title":"En clientenormal"},{"location":"practica-vpn-sad/#cambiar-ruta-por-defecto","text":"sudo ip route del default sudo ip route add default via 192.168.0.1","title":"Cambiar ruta por defecto"},{"location":"practica-vpn-sad/#pruebas-de-funcionamiento","text":"(todas estar\u00e1n hechas desde clientevpn) Ping al otro extremo del t\u00fanel (servervpn) : vagrant@clientevpn:/etc/openvpn/client$ ping 10.99.99.1 PING 10.99.99.1 (10.99.99.1) 56(84) bytes of data. 64 bytes from 10.99.99.1: icmp_seq=1 ttl=64 time=0.412 ms 64 bytes from 10.99.99.1: icmp_seq=2 ttl=64 time=0.696 ms 64 bytes from 10.99.99.1: icmp_seq=3 ttl=64 time=0.455 ms ^C --- 10.99.99.1 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2048ms rtt min/avg/max/mdev = 0.412/0.521/0.696/0.124 ms Ping a clientenormal: vagrant@clientevpn:/etc/openvpn/client$ ping 192.168.0.5 PING 192.168.0.5 (192.168.0.5) 56(84) bytes of data. 64 bytes from 192.168.0.5: icmp_seq=1 ttl=63 time=0.849 ms 64 bytes from 192.168.0.5: icmp_seq=2 ttl=63 time=0.839 ms ^C --- 192.168.0.5 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 0.839/0.844/0.849/0.005 ms Traceroute a clientenormal (para que se vea claro la utilizaci\u00f3n del t\u00fanel VPN) : vagrant@clientevpn:/etc/openvpn/client$ traceroute 192.168.0.5 traceroute to 192.168.0.5 (192.168.0.5), 30 hops max, 60 byte packets 1 10.99.99.1 (10.99.99.1) 0.446 ms 0.364 ms 0.331 ms 2 192.168.0.5 (192.168.0.5) 0.553 ms 0.612 ms 0.581 ms","title":"Pruebas de funcionamiento"},{"location":"practica-vpn-sad/#parte-2-sitio-a-sitio-openvpn","text":"","title":"Parte 2: sitio a sitio OpenVPN"},{"location":"practica-vpn-sad/#escenario_1","text":"Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientenormal1 do |clientenormal1| clientenormal1.vm.box = \"debian/bullseye64\" clientenormal1.vm.hostname = \"clientenormal1\" clientenormal1.vm.network :private_network, :libvirt__network_name => \"privada1-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientevpn do |clientevpn| clientevpn.vm.box = \"debian/bullseye64\" clientevpn.vm.hostname = \"clientevpn\" clientevpn.vm.network :private_network, :libvirt__network_name => \"privada1-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" clientevpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :servervpn do |servervpn| servervpn.vm.box = \"debian/bullseye64\" servervpn.vm.hostname = \"servervpn\" servervpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" servervpn.vm.network :private_network, :libvirt__network_name => \"privada2-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal2 do |clientenormal2| clientenormal2.vm.box = \"debian/bullseye64\" clientenormal2.vm.hostname = \"clientenormal2\" clientenormal2.vm.network :private_network, :libvirt__network_name => \"privada2-vpn2\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end","title":"Escenario"},{"location":"practica-vpn-sad/#en-servervpn_1","text":"","title":"En servervpn"},{"location":"practica-vpn-sad/#instalar-openvpn_2","text":"sudo apt update sudo apt install openvpn","title":"Instalar OpenVPN"},{"location":"practica-vpn-sad/#habilitar-forwarding_1","text":"echo 1 > /proc/sys/net/ipv4/ip_forward","title":"Habilitar forwarding"},{"location":"practica-vpn-sad/#crear-pki","text":"sudo cp -r /usr/share/easy-rsa /etc/openvpn cd /etc/openvpn/easy-rsa sudo ./easyrsa init-pki init-pki complete; you may now create a CA or requests. Your newly created PKI dir is: /etc/openvpn/easy-rsa/pki","title":"Crear PKI"},{"location":"practica-vpn-sad/#generar-certificado-clave-privada-de-la-ca_1","text":"sudo ./easyrsa build-ca Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Enter New CA Key Passphrase: Re-Enter New CA Key Passphrase: Generating RSA private key, 2048 bit long modulus (2 primes) ..................+++++ ..................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Adrianj CA CA creation complete and you may now import and sign cert requests. Your new CA certificate file for publishing is at: /etc/openvpn/easy-rsa/pki/ca.crt Passphrase: 1234","title":"Generar certificado + clave privada de la CA"},{"location":"practica-vpn-sad/#generar-certificado-clave-privada-del-servidor-vpn_1","text":"sudo ./easyrsa build-server-full server nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key ..............................................................+++++ ........................................................................................................................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2046.nRVdyM/tmp.6vm2xf' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2046.nRVdyM/tmp.3Nm9uS Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'server' Certificate is to be certified until Apr 3 09:13:11 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated","title":"Generar certificado + clave privada del servidor VPN"},{"location":"practica-vpn-sad/#generar-parametros-diffiehellman_1","text":"sudo ./easyrsa gen-dh Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time ...................................+....................+..........................+....................................................................................................................................................................................................................+.....................+.....................................................................................................................................................................................................................................+...........+.................................................................................................................................+.................................................+....................................................+.........................................................................................................................................................................................................................+.............................+.............................................+..................................................................................................................................................................+............................................................................................................................................................................................................................................................................+..............................................................................................................................+.........................................................................................................+.......................................................................+................................................................................................................................................................+.......................................................................................................................................................+........................................................................................................................................................................................+...................................................................................+............................................................................+....................................+...............................................................+...............................................................................................................+.....................................................................................................................................................................................................................................+.....................+...................................+..................................................................................................+.............................................................................................+.......................................................................+..................................+......................................................................................................................................+....................................................+........................................................................................................................................................................................................................................................+........................................................................................................................................+...................................................................................................................................+....................................+....................+.....................................................................................................+..+...............................+..................................+...........................+.....................................................................................................................+...............................................................................................................................................................................................+................+...+.........................................................+..+.........+....+...+................................................................................................+...............................................................................................................................................................................................................................................................................................................................................+..................................................................+...............................................................................................................................+.....................................................................................................+............+...................................+.............................................................................................................................................+...............................................................................................+.........+.................+...........................................................................................................................................+....+........................................................................................+................+........+................................................................................................................................................................................................................................................+.......................................................................................................+.............................................................................................................................................................................................................................................+................................................................+...........................................................................................................................................................................+..................+..................................+...................................................................................................................................................................................................................................+....................................................................................................+.......................................................................................................................................................................................+..................................++*++*++*++* DH parameters of size 2048 created at /etc/openvpn/easy-rsa/pki/dh.pem","title":"Generar par\u00e1metros Diffie\u2013Hellman"},{"location":"practica-vpn-sad/#generar-certificado-clave-privada-del-cliente-vpn_1","text":"sudo ./easyrsa build-client-full clientevpn nopass Using SSL: openssl OpenSSL 1.1.1k 25 Mar 2021 Generating a RSA private key .......................................................................+++++ ................................+++++ writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-2162.MUtxW0/tmp.cwHjMI' ----- Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-2162.MUtxW0/tmp.tJCZID Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'clientevpn' Certificate is to be certified until Apr 3 09:28:02 2024 GMT (825 days) Write out database with 1 new entries Data Base Updated","title":"Generar certificado + clave privada del cliente VPN"},{"location":"practica-vpn-sad/#pasar-ficheros-necesarios-al-cliente-vpn_1","text":"sudo cp -rp /etc/openvpn/easy-rsa/pki/{ca.crt,issued/clientevpn.crt,private/clientevpn.key} ~ sudo chown vagrant: ~/{ca.crt,clientevpn.crt,clientevpn.key} scp ~/{ca.crt,clientevpn.crt,clientevpn.key} vagrant@192.88.99.11:/home/vagrant","title":"Pasar ficheros necesarios al cliente VPN"},{"location":"practica-vpn-sad/#configurar-el-servidor-vpn_1","text":"Creo el client-config-dir junto con un fichero con informaci\u00f3n sobre clientevpn : cd /etc/openvpn sudo mkdir ccd cd ccd sudo touch clientevpn echo iroute 192.168.0.0 255.255.255.0 > /etc/openvpn/ccd/clientevpn Creo el fichero de configuraci\u00f3n partiendo de una plantilla: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf Modifico /etc/openvpn/server/servidor.conf : port 1194 proto udp dev tun ca /etc/openvpn/easy-rsa/pki/ca.crt cert /etc/openvpn/easy-rsa/pki/issued/server.crt key /etc/openvpn/easy-rsa/pki/private/server.key dh /etc/openvpn/easy-rsa/pki/dh.pem topology subnet server 10.99.99.0 255.255.255.0 ifconfig-pool-persist /var/log/openvpn/ipp.txt push \"route 192.168.1.0 255.255.255.0\" client-config-dir /etc/openvpn/ccd route 192.168.0.0 255.255.255.0 keepalive 10 120 cipher AES-256-CBC persist-key persist-tun status /var/log/openvpn/openvpn-status.log verb 3 explicit-exit-notify 1","title":"Configurar el servidor VPN"},{"location":"practica-vpn-sad/#iniciar-el-servidor_1","text":"sudo systemctl enable --now openvpn-server@servidor Verifico que est\u00e1 funcionando: sudo systemctl status openvpn-server@servidor \u25cf openvpn-server@servidor.service - OpenVPN service for servidor Loaded: loaded (/lib/systemd/system/openvpn-server@.service; enabled; vendor preset: enabled) Active: active (running) since Thu 2021-12-30 09:47:53 UTC; 12s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 2291 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1020.0K CPU: 7ms CGroup: /system.slice/system-openvpn\\x2dserver.slice/openvpn-server@servidor.service \u2514\u25002291 /usr/sbin/openvpn --status /run/openvpn-server/status-servidor.log --status-vers> Dec 30 09:47:53 servervpn openvpn[2291]: net_addr_v4_add: 10.99.99.1/24 dev tun0 Dec 30 09:47:53 servervpn openvpn[2291]: net_route_v4_add: 192.168.0.0/24 via 10.99.99.2 dev [NULL] > Dec 30 09:47:53 servervpn openvpn[2291]: Could not determine IPv4/IPv6 protocol. Using AF_INET Dec 30 09:47:53 servervpn openvpn[2291]: Socket Buffers: R=[212992->212992] S=[212992->212992] Dec 30 09:47:53 servervpn openvpn[2291]: UDPv4 link local (bound): [AF_INET][undef]:1194 Dec 30 09:47:53 servervpn openvpn[2291]: UDPv4 link remote: [AF_UNSPEC] Dec 30 09:47:53 servervpn openvpn[2291]: MULTI: multi_init called, r=256 v=256 Dec 30 09:47:53 servervpn openvpn[2291]: IFCONFIG POOL IPv4: base=10.99.99.2 size=252 Dec 30 09:47:53 servervpn openvpn[2291]: IFCONFIG POOL LIST","title":"Iniciar el servidor"},{"location":"practica-vpn-sad/#en-clientevpn_1","text":"","title":"En clientevpn"},{"location":"practica-vpn-sad/#instalar-openvpn_3","text":"sudo apt update sudo apt install openvpn","title":"Instalar OpenVPN"},{"location":"practica-vpn-sad/#habilitar-forwarding_2","text":"echo 1 > /proc/sys/net/ipv4/ip_forward","title":"Habilitar forwarding"},{"location":"practica-vpn-sad/#mover-ficheros-a-la-ruta-adecuada_1","text":"sudo mv ~/{ca.crt,clientevpn.crt,clientevpn.key} /etc/openvpn/client sudo chown root: /etc/openvpn/client/*","title":"Mover ficheros a la ruta adecuada"},{"location":"practica-vpn-sad/#configurar-el-cliente-vpn_1","text":"Copio la plantilla oficial de configuraci\u00f3n para clientes openvpn, para partir de ella: sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client/cliente.conf Modifico /etc/openvpn/client/cliente.conf : client dev tun proto udp remote 192.88.99.10 1194 resolv-retry infinite nobind persist-key persist-tun ca /etc/openvpn/client/ca.crt cert /etc/openvpn/client/clientevpn.crt key /etc/openvpn/client/clientevpn.key remote-cert-tls server cipher AES-256-CBC verb 3 Habilito el servicio: sudo systemctl enable --now openvpn-client@cliente Verifico que funciona: sudo systemctl status openvpn-client@cliente \u25cf openvpn-client@cliente.service - OpenVPN tunnel for cliente Loaded: loaded (/lib/systemd/system/openvpn-client@.service; enabled; vendor preset: enabled) Active: active (running) since Thu 2021-12-30 10:20:45 UTC; 39s ago Docs: man:openvpn(8) https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage https://community.openvpn.net/openvpn/wiki/HOWTO Main PID: 10909 (openvpn) Status: \"Initialization Sequence Completed\" Tasks: 1 (limit: 528) Memory: 1.4M CPU: 11ms CGroup: /system.slice/system-openvpn\\x2dclient.slice/openvpn-client@cliente.service \u2514\u250010909 /usr/sbin/openvpn --suppress-timestamps --nobind --config cliente.conf Dec 30 10:20:45 clientevpn openvpn[10909]: net_route_v4_best_gw query: dst 0.0.0.0 Dec 30 10:20:45 clientevpn openvpn[10909]: net_route_v4_best_gw result: via 192.168.121.1 dev eth0 Dec 30 10:20:45 clientevpn openvpn[10909]: ROUTE_GATEWAY 192.168.121.1/255.255.255.0 IFACE=eth0 HWADDR=52:54:00:> Dec 30 10:20:45 clientevpn openvpn[10909]: TUN/TAP device tun0 opened Dec 30 10:20:45 clientevpn openvpn[10909]: net_iface_mtu_set: mtu 1500 for tun0 Dec 30 10:20:45 clientevpn openvpn[10909]: net_iface_up: set tun0 up Dec 30 10:20:45 clientevpn openvpn[10909]: net_addr_v4_add: 10.99.99.2/24 dev tun0 Dec 30 10:20:45 clientevpn openvpn[10909]: net_route_v4_add: 192.168.1.0/24 via 10.99.99.1 dev [NULL] table 0 me> Dec 30 10:20:45 clientevpn openvpn[10909]: WARNING: this configuration may cache passwords in memory -- use the >","title":"Configurar el cliente VPN"},{"location":"practica-vpn-sad/#en-clientenormal1","text":"","title":"En clientenormal1"},{"location":"practica-vpn-sad/#cambiar-ruta-por-defecto_1","text":"sudo ip route del default sudo ip route add default via 192.168.0.1","title":"Cambiar ruta por defecto"},{"location":"practica-vpn-sad/#en-clientenormal2","text":"","title":"En clientenormal2"},{"location":"practica-vpn-sad/#cambiar-ruta-por-defecto_2","text":"sudo ip route del default sudo ip route add default via 192.168.1.1","title":"Cambiar ruta por defecto"},{"location":"practica-vpn-sad/#pruebas-de-funcionamiento_1","text":"Ping desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ ping 192.168.1.2 PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data. 64 bytes from 192.168.1.2: icmp_seq=1 ttl=62 time=4.45 ms 64 bytes from 192.168.1.2: icmp_seq=2 ttl=62 time=2.30 ms ^C --- 192.168.1.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 2.301/3.376/4.451/1.075 ms Ping desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=62 time=2.26 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=62 time=2.24 ms 64 bytes from 192.168.0.2: icmp_seq=3 ttl=62 time=2.19 ms ^C --- 192.168.0.2 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2004ms rtt min/avg/max/mdev = 2.188/2.229/2.264/0.031 ms Traceroute desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ traceroute 192.168.1.2 traceroute to 192.168.1.2 (192.168.1.2), 30 hops max, 60 byte packets 1 192.168.0.1 (192.168.0.1) 0.521 ms 0.438 ms 0.433 ms 2 10.99.99.1 (10.99.99.1) 2.229 ms 2.196 ms 2.177 ms 3 192.168.1.2 (192.168.1.2) 2.129 ms 2.082 ms 2.035 ms Traceroute desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ traceroute 192.168.0.2 traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets 1 192.168.1.1 (192.168.1.1) 0.613 ms 0.538 ms 0.507 ms 2 10.99.99.2 (10.99.99.2) 2.864 ms 2.828 ms 2.812 ms 3 192.168.0.2 (192.168.0.2) 2.824 ms 2.778 ms 3.276 ms","title":"Pruebas de funcionamiento"},{"location":"practica-vpn-sad/#parte-3-acceso-remoto-wireguard","text":"","title":"Parte 3: acceso remoto WireGuard"},{"location":"practica-vpn-sad/#escenario_2","text":"Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientevpn do |clientevpn| clientevpn.vm.box = \"debian/bullseye64\" clientevpn.vm.hostname = \"clientevpn\" clientevpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :servervpn do |servervpn| servervpn.vm.box = \"debian/bullseye64\" servervpn.vm.hostname = \"servervpn\" servervpn.vm.network :private_network, :libvirt__network_name => \"internet-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" servervpn.vm.network :private_network, :libvirt__network_name => \"privada-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal do |clientenormal| clientenormal.vm.box = \"debian/bullseye64\" clientenormal.vm.hostname = \"clientenormal\" clientenormal.vm.network :private_network, :libvirt__network_name => \"privada-vpn3\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end","title":"Escenario"},{"location":"practica-vpn-sad/#en-servervpn_2","text":"","title":"En servervpn"},{"location":"practica-vpn-sad/#instalar-wireguard","text":"sudo apt update sudo apt install wireguard","title":"Instalar WireGuard"},{"location":"practica-vpn-sad/#generar-par-de-claves","text":"wg genkey | sudo tee /etc/wireguard/server_private.key | wg pubkey | sudo tee /etc/wireguard/server_public.key","title":"Generar par de claves"},{"location":"practica-vpn-sad/#configurar","text":"Creo el fichero de configuraci\u00f3n (wg0 ser\u00e1 el nombre de la interfaz) : sudo touch /etc/wireguard/wg0.conf Lo modifico: [Interface] Address = 10.99.99.1/24 ListenPort = 51820 PrivateKey = wPO8E5rUB9hFCwJMQYsLwDtNV7eX9SZmL9h/VO+NwFY= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] PublicKey = GLJ8rEoPu22e+t2xPP54TJoGCoq09+HiOuiwBV3TzSw= AllowedIPs = 10.99.99.2/32","title":"Configurar"},{"location":"practica-vpn-sad/#modificar-permisos","text":"sudo chmod 600 /etc/wireguard/ -R","title":"Modificar permisos"},{"location":"practica-vpn-sad/#iniciar-wireguard","text":"sudo wg-quick up /etc/wireguard/wg0.conf [#] sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 [#] ip link add wg0 type wireguard [#] wg setconf wg0 /dev/fd/63 [#] ip -4 address add 10.99.99.1/24 dev wg0 [#] ip link set mtu 1420 up dev wg0 Se nos crea la interfaz: 5: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.1/24 scope global wg0 valid_lft forever preferred_lft forever Y la ruta: 10.99.99.0/24 dev wg0 proto kernel scope link src 10.99.99.1","title":"Iniciar WireGuard"},{"location":"practica-vpn-sad/#en-clientevpn-debian-11","text":"","title":"En clientevpn (debian 11)"},{"location":"practica-vpn-sad/#instalar-wireguard_1","text":"sudo apt update sudo apt install wireguard","title":"Instalar WireGuard"},{"location":"practica-vpn-sad/#generar-par-de-claves_1","text":"wg genkey | sudo tee /etc/wireguard/client_private.key | wg pubkey | sudo tee /etc/wireguard/client_public.key","title":"Generar par de claves"},{"location":"practica-vpn-sad/#configurar_1","text":"Creo el fichero de configuraci\u00f3n (wg-client0 ser\u00e1 el nombre de la interfaz) : sudo touch /etc/wireguard/wg-client0.conf Lo modifico: [Interface] Address = 10.99.99.2/24 PrivateKey = iO5lDgbhB6cGsJL6Udw0SP+9x4N0FHrRj2irMiNM93Y= [Peer] PublicKey = K7noXpmRF60rW7BjqGTHTF8PaOVLASb1UJJF62YsFw8= AllowedIPs = 0.0.0.0/0 Endpoint = 192.88.99.10:51820 PersistentKeepalive = 25","title":"Configurar"},{"location":"practica-vpn-sad/#modificar-permisos_1","text":"sudo chmod 600 /etc/wireguard/ -R","title":"Modificar permisos"},{"location":"practica-vpn-sad/#iniciar-wireguard_1","text":"sudo wg-quick up /etc/wireguard/wg-client0.conf [#] ip link add wg-client0 type wireguard [#] wg setconf wg-client0 /dev/fd/63 [#] ip -4 address add 10.99.99.2/24 dev wg-client0 [#] ip link set mtu 1420 up dev wg-client0 [#] wg set wg-client0 fwmark 51820 [#] ip -4 route add 0.0.0.0/0 dev wg-client0 table 51820 [#] ip -4 rule add not fwmark 51820 table 51820 [#] ip -4 rule add table main suppress_prefixlength 0 [#] sysctl -q net.ipv4.conf.all.src_valid_mark=1 [#] nft -f /dev/fd/63 Se nos crea la interfaz: 4: wg-client0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.2/24 scope global wg-client0 valid_lft forever preferred_lft forever Y la ruta: 10.99.99.0/24 dev wg-client0 proto kernel scope link src 10.99.99.2","title":"Iniciar WireGuard"},{"location":"practica-vpn-sad/#en-clientenormal_1","text":"","title":"En clientenormal"},{"location":"practica-vpn-sad/#cambiar-ruta-por-defecto_3","text":"sudo ip route del default sudo ip route add default via 192.168.0.1","title":"Cambiar ruta por defecto"},{"location":"practica-vpn-sad/#pruebas-de-funcionamiento_2","text":"(todas hechas desde clientevpn) Ping al otro extremo del t\u00fanel: vagrant@clientevpn:~$ ping 10.99.99.1 PING 10.99.99.1 (10.99.99.1) 56(84) bytes of data. 64 bytes from 10.99.99.1: icmp_seq=1 ttl=64 time=2.43 ms 64 bytes from 10.99.99.1: icmp_seq=2 ttl=64 time=0.232 ms ^C --- 10.99.99.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.232/1.328/2.425/1.096 ms Ping a clientenormal: vagrant@clientevpn:~$ ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=63 time=1.56 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=63 time=0.360 ms ^C --- 192.168.0.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.360/0.959/1.559/0.599 ms Traceroute a clientenormal: vagrant@clientevpn:~$ traceroute 192.168.0.2 traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets 1 10.99.99.1 (10.99.99.1) 0.734 ms 0.275 ms 0.242 ms 2 192.168.0.2 (192.168.0.2) 0.712 ms 0.664 ms 0.617 ms","title":"Pruebas de funcionamiento"},{"location":"practica-vpn-sad/#extra-cliente-vpn-windows","text":"","title":"Extra: cliente VPN Windows"},{"location":"practica-vpn-sad/#conectar-cliente","text":"Conecto la VM a la red internet-vpn3 : Configuro est\u00e1ticamente la interfaz: netsh interface ip set address name=\"Ethernet\" static 192.88.99.12 255.255.255.0 192.88.99.10 Compruebo que la configuraci\u00f3n se aplic\u00f3 correctamente: Compruebo que tengo conectividad con servervpn:","title":"Conectar cliente"},{"location":"practica-vpn-sad/#configurar-cliente","text":"Descargo e instalo Wireguard: Compruebo que funciona el programa: Creo un nuevo t\u00fanel en blanco: Como nos podemos dar cuenta, la generaci\u00f3n de claves ha sido autom\u00e1tica: Completo la configuraci\u00f3n y nombro el t\u00fanel: Verifico que se ha creado correctamente: Nos damos cuenta de que est\u00e1 inactivo (por ahora).","title":"Configurar cliente"},{"location":"practica-vpn-sad/#modificar-el-servidor","text":"Tengo que a\u00f1adir el nuevo peer a wg0.conf . El fichero se quedar\u00eda as\u00ed: [Interface] Address = 10.99.99.1/24 ListenPort = 51820 PrivateKey = wPO8E5rUB9hFCwJMQYsLwDtNV7eX9SZmL9h/VO+NwFY= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] PublicKey = GLJ8rEoPu22e+t2xPP54TJoGCoq09+HiOuiwBV3TzSw= AllowedIPs = 10.99.99.2/32 [Peer] PublicKey = 3CNoT/Zae2eXK+yW0wm13qFWOEOwUcfCQrcIGttUPyk= AllowedIPs = 10.99.99.3/32 Reinicio el servidor para que los cambios tomen efecto: sudo wg-quick down /etc/wireguard/wg0.conf sudo wg-quick up /etc/wireguard/wg0.conf","title":"Modificar el servidor"},{"location":"practica-vpn-sad/#activar-cliente","text":"Vemos que se nos crea la interfaz de t\u00fanel:","title":"Activar cliente"},{"location":"practica-vpn-sad/#pruebas-de-funcionamiento_3","text":"Ping al otro extremo del t\u00fanel: Ping a clientenormal: Tracert a clientenormal:","title":"Pruebas de funcionamiento"},{"location":"practica-vpn-sad/#extra-cliente-vpn-android","text":"","title":"Extra: cliente VPN Android"},{"location":"practica-vpn-sad/#conectar-cliente_1","text":"Conecto la VM a la red internet-vpn3 : Configuro est\u00e1ticamente la interfaz: ifconfig wlan0 192.88.99.13 netmask 255.255.255.0 up Compruebo que la configuraci\u00f3n se aplic\u00f3 correctamente: Compruebo que tengo conectividad con servervpn:","title":"Conectar cliente"},{"location":"practica-vpn-sad/#configurar-cliente_1","text":"Instalo Wireguard: Compruebo que funciona el programa: Creo un nuevo t\u00fanel en blanco: Genero un par de claves: Completo la configuraci\u00f3n: Verifico que se ha creado correctamente el t\u00fanel: Est\u00e1 inactivo (por ahora).","title":"Configurar cliente"},{"location":"practica-vpn-sad/#modificar-el-servidor_1","text":"Tengo que a\u00f1adir el nuevo peer a wg0.conf . El fichero se quedar\u00eda as\u00ed: [Interface] Address = 10.99.99.1/24 ListenPort = 51820 PrivateKey = wPO8E5rUB9hFCwJMQYsLwDtNV7eX9SZmL9h/VO+NwFY= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] PublicKey = GLJ8rEoPu22e+t2xPP54TJoGCoq09+HiOuiwBV3TzSw= AllowedIPs = 10.99.99.2/32 [Peer] PublicKey = 3CNoT/Zae2eXK+yW0wm13qFWOEOwUcfCQrcIGttUPyk= AllowedIPs = 10.99.99.3/32 [Peer] PublicKey = DJusByULiqhbzBhSCDdVJZAjH6mNEUVE9qlyYc/CylM= AllowedIPs = 10.99.99.4/32 Reinicio el servidor para que los cambios tomen efecto: sudo wg-quick down /etc/wireguard/wg0.conf sudo wg-quick up /etc/wireguard/wg0.conf","title":"Modificar el servidor"},{"location":"practica-vpn-sad/#activar-cliente_1","text":"Vemos que se nos crea la interfaz de t\u00fanel:","title":"Activar cliente"},{"location":"practica-vpn-sad/#pruebas-de-funcionamiento_4","text":"Ping al otro extremo del t\u00fanel: Ping a clientenormal: Traceroute a clientenormal:","title":"Pruebas de funcionamiento"},{"location":"practica-vpn-sad/#conclusiones","text":"Aqu\u00ed expondr\u00e9 las conclusiones a las que he llegado tras comparar el acceso remoto de WireGuard con el de OpenVPN. Con WireGuard no existe realmente el concepto de cliente-servidor, sino el de peer-to-peer. Aunque en la pr\u00e1ctica, se distingue f\u00e1cilmente cu\u00e1l es el \"servidor\" porque es en el que abrimos un puerto espec\u00edfico durante la configuraci\u00f3n. La autenticaci\u00f3n es mucho m\u00e1s sencilla con WireGuard, ya que se usa un par de claves y no certificados. Conceptualmente ambos mecanismos son casi iguales, pero en la pr\u00e1ctica es mucho m\u00e1s c\u00f3modo trabajar con un par de claves porque nos ahorramos el tener que crear una Autoridad Certificadora, el firmado de certificados...etc. Es muy parecido, por no decir casi igual, a como se trabaja con SSH. Los ficheros de configuraci\u00f3n son notoriamente m\u00e1s cortos y sencillos en WireGuard. WireGuard nos proporciona la herramienta wg-quick para controlar el servicio, lo cual es mucho m\u00e1s sencillo que trabajar con systemd.","title":"Conclusiones"},{"location":"practica-vpn-sad/#parte-4-sitio-a-sitio-wireguard","text":"","title":"Parte 4: sitio a sitio WireGuard"},{"location":"practica-vpn-sad/#escenario_3","text":"Vagrantfile : Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.provider :libvirt do |libvirt| libvirt.cpus = 1 libvirt.memory = 512 end config.vm.define :clientenormal1 do |clientenormal1| clientenormal1.vm.box = \"debian/bullseye64\" clientenormal1.vm.hostname = \"clientenormal1\" clientenormal1.vm.network :private_network, :libvirt__network_name => \"privada1-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :peervpn1 do |peervpn1| peervpn1.vm.box = \"debian/bullseye64\" peervpn1.vm.hostname = \"peervpn1\" peervpn1.vm.network :private_network, :libvirt__network_name => \"privada1-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.0.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" peervpn1.vm.network :private_network, :libvirt__network_name => \"internet-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.11\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :peervpn2 do |peervpn2| peervpn2.vm.box = \"debian/bullseye64\" peervpn2.vm.hostname = \"peervpn2\" peervpn2.vm.network :private_network, :libvirt__network_name => \"internet-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.88.99.10\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" peervpn2.vm.network :private_network, :libvirt__network_name => \"privada2-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.1\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end config.vm.define :clientenormal2 do |clientenormal2| clientenormal2.vm.box = \"debian/bullseye64\" clientenormal2.vm.hostname = \"clientenormal2\" clientenormal2.vm.network :private_network, :libvirt__network_name => \"privada2-vpn4\", :libvirt__dhcp_enabled => false, :ip => \"192.168.1.2\", :libvirt__netmask => '255.255.255.0', :libvirt__forward_mode => \"veryisolated\" end end","title":"Escenario"},{"location":"practica-vpn-sad/#en-peervpn1","text":"","title":"En peervpn1"},{"location":"practica-vpn-sad/#instalar-wireguard_2","text":"sudo apt update sudo apt install wireguard","title":"Instalar WireGuard"},{"location":"practica-vpn-sad/#generar-par-de-claves_2","text":"wg genkey | sudo tee /etc/wireguard/peervpn1_private.key | wg pubkey | sudo tee /etc/wireguard/peervpn1_public.key","title":"Generar par de claves"},{"location":"practica-vpn-sad/#configurar_2","text":"Creo el fichero de configuraci\u00f3n: sudo touch /etc/wireguard/wg0.conf Lo modifico: [Interface] Address = 10.99.99.1/32 ListenPort = 51820 PrivateKey = 4FMOxWlQLSGHlfgjFKBkmPDeURsHh7RBeCAoYMd/vGw= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] Endpoint = 192.88.99.10:51820 AllowedIPs = 10.99.99.2/32, 192.168.1.0/24 PublicKey = FMJMI1Cg7jOLPTZj49DP/KE7RVK9/J8X5l3KG4LVf2Q=","title":"Configurar"},{"location":"practica-vpn-sad/#modificar-permisos_2","text":"sudo chmod 600 /etc/wireguard/ -R","title":"Modificar permisos"},{"location":"practica-vpn-sad/#iniciar-wireguard_2","text":"sudo wg-quick up /etc/wireguard/wg0.conf [#] sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 [#] ip link add wg0 type wireguard [#] wg setconf wg0 /dev/fd/63 [#] ip -4 address add 10.99.99.1/32 dev wg0 [#] ip link set mtu 1420 up dev wg0 [#] ip -4 route add 10.99.99.2/32 dev wg0 [#] ip -4 route add 192.168.1.0/24 dev wg0 Se crea la interfaz: 7: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.1/32 scope global wg0 valid_lft forever preferred_lft forever Y las rutas: 10.99.99.2 dev wg0 scope link 192.168.1.0/24 dev wg0 scope link","title":"Iniciar WireGuard"},{"location":"practica-vpn-sad/#en-peervpn2","text":"","title":"En peervpn2"},{"location":"practica-vpn-sad/#instalar-wireguard_3","text":"sudo apt update sudo apt install wireguard","title":"Instalar WireGuard"},{"location":"practica-vpn-sad/#generar-par-de-claves_3","text":"wg genkey | sudo tee /etc/wireguard/peervpn2_private.key | wg pubkey | sudo tee /etc/wireguard/peervpn2_public.key","title":"Generar par de claves"},{"location":"practica-vpn-sad/#configurar_3","text":"Creo el fichero de configuraci\u00f3n: sudo touch /etc/wireguard/wg0.conf Lo modifico: [Interface] Address = 10.99.99.2/32 ListenPort = 51820 PrivateKey = UP7xLuRK2JtsFxUwWqHxeREAwKPQPO9mvYfI+neNd3E= # IP forwarding PreUp = sysctl -w net.ipv4.ip_forward=1 [Peer] Endpoint = 192.88.99.11:51820 AllowedIPs = 10.99.99.1/32, 192.168.0.0/24 PublicKey = nN/tik1TNOkFuupFVlNOaEO5hwQFKlsUWoKYsSCutzA=","title":"Configurar"},{"location":"practica-vpn-sad/#modificar-permisos_3","text":"sudo chmod 600 /etc/wireguard/ -R","title":"Modificar permisos"},{"location":"practica-vpn-sad/#iniciar-wireguard_3","text":"sudo wg-quick up /etc/wireguard/wg0.conf [#] sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 [#] ip link add wg0 type wireguard [#] wg setconf wg0 /dev/fd/63 [#] ip -4 address add 10.99.99.2/32 dev wg0 [#] ip link set mtu 1420 up dev wg0 [#] ip -4 route add 10.99.99.1/32 dev wg0 [#] ip -4 route add 192.168.0.0/24 dev wg0 Se nos crea la interfaz: 7: wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000 link/none inet 10.99.99.2/32 scope global wg0 valid_lft forever preferred_lft forever Y las rutas: 10.99.99.1 dev wg0 scope link 192.168.0.0/24 dev wg0 scope link","title":"Iniciar WireGuard"},{"location":"practica-vpn-sad/#en-clientenormal1_1","text":"","title":"En clientenormal1"},{"location":"practica-vpn-sad/#cambiar-ruta-por-defecto_4","text":"sudo ip route del default sudo ip route add default via 192.168.0.1","title":"Cambiar ruta por defecto"},{"location":"practica-vpn-sad/#en-clientenormal2_1","text":"","title":"En clientenormal2"},{"location":"practica-vpn-sad/#cambiar-ruta-por-defecto_5","text":"sudo ip route del default sudo ip route add default via 192.168.1.1","title":"Cambiar ruta por defecto"},{"location":"practica-vpn-sad/#pruebas-de-funcionamiento_5","text":"Ping desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ ping 192.168.1.2 PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data. 64 bytes from 192.168.1.2: icmp_seq=1 ttl=62 time=2.77 ms 64 bytes from 192.168.1.2: icmp_seq=2 ttl=62 time=0.958 ms ^C --- 192.168.1.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1002ms rtt min/avg/max/mdev = 0.958/1.865/2.772/0.907 ms Ping desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=62 time=1.26 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=62 time=0.721 ms ^C --- 192.168.0.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 0.721/0.992/1.264/0.271 ms Traceroute desde clientenormal1 a clientenormal2 : vagrant@clientenormal1:~$ traceroute 192.168.1.2 traceroute to 192.168.1.2 (192.168.1.2), 30 hops max, 60 byte packets 1 192.168.0.1 (192.168.0.1) 0.264 ms 0.244 ms 0.228 ms 2 10.99.99.2 (10.99.99.2) 0.558 ms 0.540 ms 0.495 ms 3 192.168.1.2 (192.168.1.2) 0.748 ms 0.700 ms 0.685 ms Traceroute desde clientenormal2 a clientenormal1 : vagrant@clientenormal2:~$ traceroute 192.168.0.2 traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets 1 192.168.1.1 (192.168.1.1) 0.800 ms 0.774 ms 0.764 ms 2 10.99.99.1 (10.99.99.1) 1.665 ms 1.653 ms 1.760 ms 3 192.168.0.2 (192.168.0.2) 2.553 ms 2.544 ms 2.535 ms","title":"Pruebas de funcionamiento"},{"location":"practica-vpn-sad/#conclusiones_1","text":"Aqu\u00ed expondr\u00e9 las conclusiones a las que he llegado tras comparar el sitio a sitio de WireGuard con el de OpenVPN. Adem\u00e1s de las ya mencionadas en el anterior apartado de conclusiones, s\u00f3lo quedar\u00eda una m\u00e1s por destacar, y que s\u00f3lo ha sucedido con la configuraci\u00f3n de sitio a sitio: El manejo de rutas es mucho m\u00e1s sencillo con WireGuard, ya que s\u00f3lo nos tenemos que preocupar de que el par\u00e1metro AllowedIPs est\u00e9 correctamente relleno con las rutas que necesitamos en cada peer. Con OpenVPN influyen los ccd , \"complicando\" un poco la configuraci\u00f3n.","title":"Conclusiones"},{"location":"practica-vpn-sad/#bibliografia","text":"PARTE 1: https://kifarunix.com/install-openvpn-server-on-debian-11-debian-10/ PARTE 2: https://medium.com/@bjammal/site-to-site-vpn-on-a-single-host-using-openvpn-e9c5cdb22f92 https://www.matoski.com/article/site-to-site-openvpn-firewalld-debian/ https://openvpn.net/community-resources/how-to/#scope (secci\u00f3n Including multiple machines on the client side when using a routed VPN (dev tun) ) PARTE 3: https://www.linuxbabe.com/debian/wireguard-vpn-server-debian https://www.makeuseof.com/how-to-set-up-wireguard-windows/ PARTE 4: https://www.procustodibus.com/blog/2020/12/wireguard-site-to-site-config/","title":"Bibliograf\u00eda"},{"location":"practica-web-bd-dns-escenario/","text":"Pr\u00e1ctica: Servidores Web, Base de Datos y DNS en escenario Entrega Parte 1 Entregar configuraci\u00f3n de cliente DNS en cada servidor En zeus A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 10.0.1.102; En apolo A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 127.0.0.1; En ares /etc/netplan/01-netcfg.yaml : network: version: 2 renderer: networkd ethernets: eth0: dhcp4: true dhcp6: false optional: true (elimino nameservers) /etc/systemd/resolved.conf : # This file is part of systemd. # # systemd is free software; you can redistribute it and/or modify it # under the terms of the GNU Lesser General Public License as published by # the Free Software Foundation; either version 2.1 of the License, or # (at your option) any later version. # # Entries in this file show the compile time defaults. # You can change settings by editing this file. # Defaults can be restored by simply deleting this file. # # See resolved.conf(5) for details [Resolve] DNS=10.0.1.102 Domains=adrianj.gonzalonazareno.org #FallbackDNS= #LLMNR=no #MulticastDNS=no #DNSSEC=yes #DNSOverTLS=no #Cache=yes DNSStubListener=no #ReadEtcHosts=yes (este fichero modifica /etc/resolv.conf ) Reinicio systemd-resolved : sudo systemctl restart systemd-resolved (esto actualiza /etc/resolv.conf ) \u00a1Atenci\u00f3n! Por un error de systemd con DNSStubListener=no hay que actualizar manualmente el enlace simb\u00f3lico, porque no lo hace autom\u00e1ticamente: sudo rm /etc/resolv.conf sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf En hera /etc/NetworkManager/conf.d/90-dns-none.conf : [main] dns=none (evito que NetworkManager modifique /etc/resolv.conf ) Reinicio: sudo systemctl restart NetworkManager Escribo mi configuraci\u00f3n en /etc/resolv.conf : domain adrianj.gonzalonazareno.org search adrianj.gonzalonazareno.org. nameserver 10.0.1.102 Parte 2 Entregar definici\u00f3n de vistas y ficheros de zona A\u00f1adir a named.conf.options : allow-recursion { any; }; recursion yes; allow-query { any; }; Comentar en named.conf : // include \"/etc/bind/named.conf.default-zones\"; Comentar en zones.rfc1918 : // zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.empty\"; }; named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization view externa { match-clients { 172.22.0.0/16; 192.168.202.2/32; 192.168.1.0/24; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.externa.adrianj.gonzalonazareno.org\"; }; }; view dmz { match-clients { 172.16.0.0/16; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.dmz.adrianj.gonzalonazareno.org\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; view interna { match-clients { 10.0.1.0/24; 127.0.0.1/32; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.interna.adrianj.gonzalonazareno.org\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; (en la vista externa he a\u00f1adido la red de mi casa) db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. ; zeus IN A 172.22.0.213 ; clase zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus (la IP externa cambia seg\u00fan est\u00e9 en clase o en casa) db.dmz.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 172.16.0.1 hera IN A 172.16.0.200 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 www IN CNAME hera bd IN CNAME ares db.interna.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 10.0.1.1 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 hera IN A 172.16.0.200 www IN CNAME hera bd IN CNAME ares db.172.16 : $ORIGIN 16.172.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062502 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1.0 IN PTR zeus.adrianj.gonzalonazareno.org. 200.0 IN PTR hera.adrianj.gonzalonazareno.org. db.10.0.1 : $ORIGIN 1.0.10.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1 IN PTR zeus.adrianj.gonzalonazareno.org. 102 IN PTR apolo.adrianj.gonzalonazareno.org. 101 IN PTR ares.adrianj.gonzalonazareno.org. Parte 3 Consultas desde un cliente externo (en estas consultas usar\u00e9 @192.168.1.106 porque en mi casa no existe delegaci\u00f3n del dominio) dig @192.168.1.106 NS adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 NS adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58348 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: e4468067cae8269e01000000619ff86a197a3852650fd14f (good) ;; QUESTION SECTION: ;adrianj.gonzalonazareno.org. IN NS ;; ANSWER SECTION: adrianj.gonzalonazareno.org. 86400 IN NS zeus.adrianj.gonzalonazareno.org. ;; ADDITIONAL SECTION: zeus.adrianj.gonzalonazareno.org. 86400 IN A 192.168.1.106 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 21:56:10 CET 2021 ;; MSG SIZE rcvd: 119 dig @192.168.1.106 zeus.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 zeus.adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37293 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 84a54d72b820320701000000619ff98b8b9e767129e71df3 (good) ;; QUESTION SECTION: ;zeus.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: zeus.adrianj.gonzalonazareno.org. 86400 IN A 192.168.1.106 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:00:59 CET 2021 ;; MSG SIZE rcvd: 105 dig @192.168.1.106 www.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 www.adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 41074 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: e1cddf11d68022f801000000619ff9cf5d2b25377cbac1b2 (good) ;; QUESTION SECTION: ;www.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: www.adrianj.gonzalonazareno.org. 86400 IN CNAME zeus.adrianj.gonzalonazareno.org. zeus.adrianj.gonzalonazareno.org. 86400 IN A 192.168.1.106 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:02:07 CET 2021 ;; MSG SIZE rcvd: 123 dig @192.168.1.106 bd.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 bd.adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 40461 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: a06ac8db7750971101000000619ffa4950b175b5a1d7d627 (good) ;; QUESTION SECTION: ;bd.adrianj.gonzalonazareno.org. IN A ;; AUTHORITY SECTION: adrianj.gonzalonazareno.org. 86400 IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. 2001062501 21600 3600 604800 86400 ;; Query time: 4 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:04:09 CET 2021 ;; MSG SIZE rcvd: 134 (no hay respuesta porque bd no existe en la vista externa ) Consultas desde un cliente interno dig NS adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> NS adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 17610 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 3f12cd4ba620cf1501000000619ffc618b1029d6fd6ee025 (good) ;; QUESTION SECTION: ;adrianj.gonzalonazareno.org. IN NS ;; ANSWER SECTION: adrianj.gonzalonazareno.org. 86400 IN NS apolo.adrianj.gonzalonazareno.org. ;; ADDITIONAL SECTION: apolo.adrianj.gonzalonazareno.org. 86400 IN A 10.0.1.102 ;; Query time: 24 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:13:05 UTC 2021 ;; MSG SIZE rcvd: 120 dig zeus.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> zeus.adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15547 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 6268af10a08da00101000000619ffd1d5a37dcbdf9bcad63 (good) ;; QUESTION SECTION: ;zeus.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: zeus.adrianj.gonzalonazareno.org. 86400 IN A 10.0.1.1 ;; Query time: 4 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:16:13 UTC 2021 ;; MSG SIZE rcvd: 105 dig www.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> www.adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 35003 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: ddc4f5521915c21901000000619ffd8ec03f6e53f09e84af (good) ;; QUESTION SECTION: ;www.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: www.adrianj.gonzalonazareno.org. 86400 IN CNAME hera.adrianj.gonzalonazareno.org. hera.adrianj.gonzalonazareno.org. 86400 IN A 172.16.0.200 ;; Query time: 0 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:18:06 UTC 2021 ;; MSG SIZE rcvd: 123 dig bd.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> bd.adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3419 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 022009393ab949eb01000000619ffdec08dac774ea4bf941 (good) ;; QUESTION SECTION: ;bd.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: bd.adrianj.gonzalonazareno.org. 86400 IN CNAME ares.adrianj.gonzalonazareno.org. ares.adrianj.gonzalonazareno.org. 86400 IN A 10.0.1.101 ;; Query time: 4 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:19:40 UTC 2021 ;; MSG SIZE rcvd: 122 Consultas inversas en cada una de las redes (interna+dmz+externa) En red interna: dig -x 10.0.1.1 ; <<>> DiG 9.16.1-Ubuntu <<>> -x 10.0.1.1 ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4421 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 0d9da3496030523401000000619fff3ccb3de97da07c83e9 (good) ;; QUESTION SECTION: ;1.1.0.10.in-addr.arpa. IN PTR ;; ANSWER SECTION: 1.1.0.10.in-addr.arpa. 86400 IN PTR zeus.adrianj.gonzalonazareno.org. ;; Query time: 8 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:25:16 UTC 2021 ;; MSG SIZE rcvd: 124 En red DMZ: dig -x 172.16.0.1 ; <<>> DiG 9.11.26-RedHat-9.11.26-6.el8 <<>> -x 172.16.0.1 ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58791 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 7c0c4c54f5e88ddd01000000619fffb8fd24258dd7580093 (good) ;; QUESTION SECTION: ;1.0.16.172.in-addr.arpa. IN PTR ;; ANSWER SECTION: 1.0.16.172.in-addr.arpa. 86400 IN PTR zeus.adrianj.gonzalonazareno.org. ;; Query time: 3 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:27:20 UTC 2021 ;; MSG SIZE rcvd: 126 En red externa: dig @192.168.1.106 -x 10.0.1.101 ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 -x 10.0.1.101 ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 27352 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: c10440dae46509270100000061a00236623d14bb17cbdef9 (good) ;; QUESTION SECTION: ;101.1.0.10.in-addr.arpa. IN PTR ;; AUTHORITY SECTION: 10.IN-ADDR.ARPA. 86400 IN SOA 10.IN-ADDR.ARPA. . 0 28800 7200 604800 86400 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:37:58 CET 2021 ;; MSG SIZE rcvd: 130 (no responde porque en la vista externa no existen zonas de resoluci\u00f3n inversa ) Parte 4 Captura de www.adrianj.gonzalonazareno.org/info.php Parte 5 Entregar conexi\u00f3n a MariaDB desde hera Servidor DNS (apolo) Parte 1 DNAT en zeus redirigiendo puerto 53 a apolo sudo iptables -t nat -A PREROUTING -i eth1 -p udp --dport 53 -j DNAT --to-destination 10.0.1.102:53 (regla para clase) DNAT en zeus redirigiendo puerto 80 a hera sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.200:80 (regla para clase) Guardar reglas iptables-save > /etc/iptables/rules.v4 Parte 2 Configurar todos los servidores para resolver con apolo En zeus A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 10.0.1.102; En apolo A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 127.0.0.1; En ares /etc/netplan/01-netcfg.yaml : network: version: 2 renderer: networkd ethernets: eth0: dhcp4: true dhcp6: false optional: true (elimino nameservers) /etc/systemd/resolved.conf : # This file is part of systemd. # # systemd is free software; you can redistribute it and/or modify it # under the terms of the GNU Lesser General Public License as published by # the Free Software Foundation; either version 2.1 of the License, or # (at your option) any later version. # # Entries in this file show the compile time defaults. # You can change settings by editing this file. # Defaults can be restored by simply deleting this file. # # See resolved.conf(5) for details [Resolve] DNS=10.0.1.102 Domains=adrianj.gonzalonazareno.org #FallbackDNS= #LLMNR=no #MulticastDNS=no #DNSSEC=yes #DNSOverTLS=no #Cache=yes DNSStubListener=no #ReadEtcHosts=yes (este fichero modifica /etc/resolv.conf ) Reinicio systemd-resolved : sudo systemctl restart systemd-resolved (esto actualiza /etc/resolv.conf ) \u00a1Atenci\u00f3n! Por un error de systemd con DNSStubListener=no hay que actualizar manualmente el enlace simb\u00f3lico, porque no lo hace autom\u00e1ticamente: sudo rm /etc/resolv.conf sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf En hera /etc/NetworkManager/conf.d/90-dns-none.conf : [main] dns=none (evito que NetworkManager modifique /etc/resolv.conf ) Reinicio: sudo systemctl restart NetworkManager Escribo mi configuraci\u00f3n en /etc/resolv.conf : domain adrianj.gonzalonazareno.org search adrianj.gonzalonazareno.org. nameserver 10.0.1.102 Parte 3 Configurar bind9 A\u00f1adir a named.conf.options : allow-recursion { any; }; recursion yes; allow-query { any; }; Comentar en named.conf : // include \"/etc/bind/named.conf.default-zones\"; Comentar en zones.rfc1918 : // zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.empty\"; }; named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization view externa { match-clients { 172.22.0.0/16; 192.168.202.2/32; 192.168.1.0/24; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.externa.adrianj.gonzalonazareno.org\"; }; }; view dmz { match-clients { 172.16.0.0/16; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.dmz.adrianj.gonzalonazareno.org\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; view interna { match-clients { 10.0.1.0/24; 127.0.0.1/32; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.interna.adrianj.gonzalonazareno.org\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; (en la vista externa he a\u00f1adido la red de mi casa) db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. ; zeus IN A 172.22.0.213 ; clase zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus (la IP externa cambia seg\u00fan est\u00e9 en clase o en casa) db.dmz.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 172.16.0.1 hera IN A 172.16.0.200 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 www IN CNAME hera bd IN CNAME ares db.interna.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 10.0.1.1 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 hera IN A 172.16.0.200 www IN CNAME hera bd IN CNAME ares db.172.16 : $ORIGIN 16.172.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062502 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1.0 IN PTR zeus.adrianj.gonzalonazareno.org. 200.0 IN PTR hera.adrianj.gonzalonazareno.org. db.10.0.1 : $ORIGIN 1.0.10.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1 IN PTR zeus.adrianj.gonzalonazareno.org. 102 IN PTR apolo.adrianj.gonzalonazareno.org. 101 IN PTR ares.adrianj.gonzalonazareno.org. Servidor Web (hera) Parte 1 Instalar Apache sudo dnf install httpd systemctl enable --now httpd Parte 2 Instalar php + PHP-FPM sudo dnf install php (instala PHP-FPM por dependencia) En /var/www/www descargo: sudo wget https://gist.githubusercontent.com/SyntaxC4/5648247/raw/94277156638f9c309f2e36e19bff378ba7364907/info.php Parte 3 Crear VirtualHost /etc/httpd/conf.d/www.conf : <VirtualHost *:80> ServerName www.adrianj.gonzalonazareno.org DocumentRoot /var/www/www </VirtualHost> Parte 4 Reiniciar Apache sudo systemctl restart httpd Parte 5 Instalar cliente MariaDB (para entrega parte 5) curl -LsS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash sudo dnf install MariaDB-client Servidor de BD (ares) Parte 1 Instalar MariaDB sudo apt install mariadb-server Parte 2 Habilitar conexiones remotas /etc/mysql/mariadb.conf.d/50-server.cnf : bind-address = 0.0.0.0 Parte 3 Habilitar root con acceso remoto use mysql; update user set plugin='' where User='root'; grant all privileges on *.* to 'root'@'%' identified by '1234'; flush privileges; Parte 4 Reiniciar sudo systemctl restart mariadb","title":"Pr\u00e1ctica: DNS+Web+BD en escenario"},{"location":"practica-web-bd-dns-escenario/#practica-servidores-web-base-de-datos-y-dns-en-escenario","text":"","title":"Pr\u00e1ctica: Servidores Web, Base de Datos y DNS en escenario"},{"location":"practica-web-bd-dns-escenario/#entrega","text":"","title":"Entrega"},{"location":"practica-web-bd-dns-escenario/#parte-1","text":"Entregar configuraci\u00f3n de cliente DNS en cada servidor","title":"Parte 1"},{"location":"practica-web-bd-dns-escenario/#en-zeus","text":"A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 10.0.1.102;","title":"En zeus"},{"location":"practica-web-bd-dns-escenario/#en-apolo","text":"A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 127.0.0.1;","title":"En apolo"},{"location":"practica-web-bd-dns-escenario/#en-ares","text":"/etc/netplan/01-netcfg.yaml : network: version: 2 renderer: networkd ethernets: eth0: dhcp4: true dhcp6: false optional: true (elimino nameservers) /etc/systemd/resolved.conf : # This file is part of systemd. # # systemd is free software; you can redistribute it and/or modify it # under the terms of the GNU Lesser General Public License as published by # the Free Software Foundation; either version 2.1 of the License, or # (at your option) any later version. # # Entries in this file show the compile time defaults. # You can change settings by editing this file. # Defaults can be restored by simply deleting this file. # # See resolved.conf(5) for details [Resolve] DNS=10.0.1.102 Domains=adrianj.gonzalonazareno.org #FallbackDNS= #LLMNR=no #MulticastDNS=no #DNSSEC=yes #DNSOverTLS=no #Cache=yes DNSStubListener=no #ReadEtcHosts=yes (este fichero modifica /etc/resolv.conf ) Reinicio systemd-resolved : sudo systemctl restart systemd-resolved (esto actualiza /etc/resolv.conf ) \u00a1Atenci\u00f3n! Por un error de systemd con DNSStubListener=no hay que actualizar manualmente el enlace simb\u00f3lico, porque no lo hace autom\u00e1ticamente: sudo rm /etc/resolv.conf sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf","title":"En ares"},{"location":"practica-web-bd-dns-escenario/#en-hera","text":"/etc/NetworkManager/conf.d/90-dns-none.conf : [main] dns=none (evito que NetworkManager modifique /etc/resolv.conf ) Reinicio: sudo systemctl restart NetworkManager Escribo mi configuraci\u00f3n en /etc/resolv.conf : domain adrianj.gonzalonazareno.org search adrianj.gonzalonazareno.org. nameserver 10.0.1.102","title":"En hera"},{"location":"practica-web-bd-dns-escenario/#parte-2","text":"Entregar definici\u00f3n de vistas y ficheros de zona A\u00f1adir a named.conf.options : allow-recursion { any; }; recursion yes; allow-query { any; }; Comentar en named.conf : // include \"/etc/bind/named.conf.default-zones\"; Comentar en zones.rfc1918 : // zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.empty\"; }; named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization view externa { match-clients { 172.22.0.0/16; 192.168.202.2/32; 192.168.1.0/24; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.externa.adrianj.gonzalonazareno.org\"; }; }; view dmz { match-clients { 172.16.0.0/16; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.dmz.adrianj.gonzalonazareno.org\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; view interna { match-clients { 10.0.1.0/24; 127.0.0.1/32; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.interna.adrianj.gonzalonazareno.org\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; (en la vista externa he a\u00f1adido la red de mi casa) db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. ; zeus IN A 172.22.0.213 ; clase zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus (la IP externa cambia seg\u00fan est\u00e9 en clase o en casa) db.dmz.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 172.16.0.1 hera IN A 172.16.0.200 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 www IN CNAME hera bd IN CNAME ares db.interna.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 10.0.1.1 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 hera IN A 172.16.0.200 www IN CNAME hera bd IN CNAME ares db.172.16 : $ORIGIN 16.172.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062502 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1.0 IN PTR zeus.adrianj.gonzalonazareno.org. 200.0 IN PTR hera.adrianj.gonzalonazareno.org. db.10.0.1 : $ORIGIN 1.0.10.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1 IN PTR zeus.adrianj.gonzalonazareno.org. 102 IN PTR apolo.adrianj.gonzalonazareno.org. 101 IN PTR ares.adrianj.gonzalonazareno.org.","title":"Parte 2"},{"location":"practica-web-bd-dns-escenario/#parte-3","text":"Consultas desde un cliente externo (en estas consultas usar\u00e9 @192.168.1.106 porque en mi casa no existe delegaci\u00f3n del dominio) dig @192.168.1.106 NS adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 NS adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58348 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: e4468067cae8269e01000000619ff86a197a3852650fd14f (good) ;; QUESTION SECTION: ;adrianj.gonzalonazareno.org. IN NS ;; ANSWER SECTION: adrianj.gonzalonazareno.org. 86400 IN NS zeus.adrianj.gonzalonazareno.org. ;; ADDITIONAL SECTION: zeus.adrianj.gonzalonazareno.org. 86400 IN A 192.168.1.106 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 21:56:10 CET 2021 ;; MSG SIZE rcvd: 119 dig @192.168.1.106 zeus.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 zeus.adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37293 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 84a54d72b820320701000000619ff98b8b9e767129e71df3 (good) ;; QUESTION SECTION: ;zeus.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: zeus.adrianj.gonzalonazareno.org. 86400 IN A 192.168.1.106 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:00:59 CET 2021 ;; MSG SIZE rcvd: 105 dig @192.168.1.106 www.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 www.adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 41074 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: e1cddf11d68022f801000000619ff9cf5d2b25377cbac1b2 (good) ;; QUESTION SECTION: ;www.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: www.adrianj.gonzalonazareno.org. 86400 IN CNAME zeus.adrianj.gonzalonazareno.org. zeus.adrianj.gonzalonazareno.org. 86400 IN A 192.168.1.106 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:02:07 CET 2021 ;; MSG SIZE rcvd: 123 dig @192.168.1.106 bd.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 bd.adrianj.gonzalonazareno.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 40461 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: a06ac8db7750971101000000619ffa4950b175b5a1d7d627 (good) ;; QUESTION SECTION: ;bd.adrianj.gonzalonazareno.org. IN A ;; AUTHORITY SECTION: adrianj.gonzalonazareno.org. 86400 IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. 2001062501 21600 3600 604800 86400 ;; Query time: 4 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:04:09 CET 2021 ;; MSG SIZE rcvd: 134 (no hay respuesta porque bd no existe en la vista externa ) Consultas desde un cliente interno dig NS adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> NS adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 17610 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 3f12cd4ba620cf1501000000619ffc618b1029d6fd6ee025 (good) ;; QUESTION SECTION: ;adrianj.gonzalonazareno.org. IN NS ;; ANSWER SECTION: adrianj.gonzalonazareno.org. 86400 IN NS apolo.adrianj.gonzalonazareno.org. ;; ADDITIONAL SECTION: apolo.adrianj.gonzalonazareno.org. 86400 IN A 10.0.1.102 ;; Query time: 24 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:13:05 UTC 2021 ;; MSG SIZE rcvd: 120 dig zeus.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> zeus.adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15547 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 6268af10a08da00101000000619ffd1d5a37dcbdf9bcad63 (good) ;; QUESTION SECTION: ;zeus.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: zeus.adrianj.gonzalonazareno.org. 86400 IN A 10.0.1.1 ;; Query time: 4 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:16:13 UTC 2021 ;; MSG SIZE rcvd: 105 dig www.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> www.adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 35003 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: ddc4f5521915c21901000000619ffd8ec03f6e53f09e84af (good) ;; QUESTION SECTION: ;www.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: www.adrianj.gonzalonazareno.org. 86400 IN CNAME hera.adrianj.gonzalonazareno.org. hera.adrianj.gonzalonazareno.org. 86400 IN A 172.16.0.200 ;; Query time: 0 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:18:06 UTC 2021 ;; MSG SIZE rcvd: 123 dig bd.adrianj.gonzalonazareno.org ; <<>> DiG 9.16.1-Ubuntu <<>> bd.adrianj.gonzalonazareno.org ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3419 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 022009393ab949eb01000000619ffdec08dac774ea4bf941 (good) ;; QUESTION SECTION: ;bd.adrianj.gonzalonazareno.org. IN A ;; ANSWER SECTION: bd.adrianj.gonzalonazareno.org. 86400 IN CNAME ares.adrianj.gonzalonazareno.org. ares.adrianj.gonzalonazareno.org. 86400 IN A 10.0.1.101 ;; Query time: 4 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:19:40 UTC 2021 ;; MSG SIZE rcvd: 122 Consultas inversas en cada una de las redes (interna+dmz+externa) En red interna: dig -x 10.0.1.1 ; <<>> DiG 9.16.1-Ubuntu <<>> -x 10.0.1.1 ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4421 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 0d9da3496030523401000000619fff3ccb3de97da07c83e9 (good) ;; QUESTION SECTION: ;1.1.0.10.in-addr.arpa. IN PTR ;; ANSWER SECTION: 1.1.0.10.in-addr.arpa. 86400 IN PTR zeus.adrianj.gonzalonazareno.org. ;; Query time: 8 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:25:16 UTC 2021 ;; MSG SIZE rcvd: 124 En red DMZ: dig -x 172.16.0.1 ; <<>> DiG 9.11.26-RedHat-9.11.26-6.el8 <<>> -x 172.16.0.1 ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58791 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: 7c0c4c54f5e88ddd01000000619fffb8fd24258dd7580093 (good) ;; QUESTION SECTION: ;1.0.16.172.in-addr.arpa. IN PTR ;; ANSWER SECTION: 1.0.16.172.in-addr.arpa. 86400 IN PTR zeus.adrianj.gonzalonazareno.org. ;; Query time: 3 msec ;; SERVER: 10.0.1.102#53(10.0.1.102) ;; WHEN: Thu Nov 25 21:27:20 UTC 2021 ;; MSG SIZE rcvd: 126 En red externa: dig @192.168.1.106 -x 10.0.1.101 ; <<>> DiG 9.16.15-Debian <<>> @192.168.1.106 -x 10.0.1.101 ; (1 server found) ;; global options: +cmd ;; Got answer: ;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 27352 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 1232 ; COOKIE: c10440dae46509270100000061a00236623d14bb17cbdef9 (good) ;; QUESTION SECTION: ;101.1.0.10.in-addr.arpa. IN PTR ;; AUTHORITY SECTION: 10.IN-ADDR.ARPA. 86400 IN SOA 10.IN-ADDR.ARPA. . 0 28800 7200 604800 86400 ;; Query time: 0 msec ;; SERVER: 192.168.1.106#53(192.168.1.106) ;; WHEN: Thu Nov 25 22:37:58 CET 2021 ;; MSG SIZE rcvd: 130 (no responde porque en la vista externa no existen zonas de resoluci\u00f3n inversa )","title":"Parte 3"},{"location":"practica-web-bd-dns-escenario/#parte-4","text":"Captura de www.adrianj.gonzalonazareno.org/info.php","title":"Parte 4"},{"location":"practica-web-bd-dns-escenario/#parte-5","text":"Entregar conexi\u00f3n a MariaDB desde hera","title":"Parte 5"},{"location":"practica-web-bd-dns-escenario/#servidor-dns-apolo","text":"","title":"Servidor DNS (apolo)"},{"location":"practica-web-bd-dns-escenario/#parte-1_1","text":"DNAT en zeus redirigiendo puerto 53 a apolo sudo iptables -t nat -A PREROUTING -i eth1 -p udp --dport 53 -j DNAT --to-destination 10.0.1.102:53 (regla para clase) DNAT en zeus redirigiendo puerto 80 a hera sudo iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.200:80 (regla para clase) Guardar reglas iptables-save > /etc/iptables/rules.v4","title":"Parte 1"},{"location":"practica-web-bd-dns-escenario/#parte-2_1","text":"Configurar todos los servidores para resolver con apolo","title":"Parte 2"},{"location":"practica-web-bd-dns-escenario/#en-zeus_1","text":"A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 10.0.1.102;","title":"En zeus"},{"location":"practica-web-bd-dns-escenario/#en-apolo_1","text":"A\u00f1ado a /etc/dhcp/dhclient.conf : ############# # My config # ############# supersede domain-name \"adrianj.gonzalonazareno.org\"; supersede domain-search \"adrianj.gonzalonazareno.org\"; supersede domain-name-servers 127.0.0.1;","title":"En apolo"},{"location":"practica-web-bd-dns-escenario/#en-ares_1","text":"/etc/netplan/01-netcfg.yaml : network: version: 2 renderer: networkd ethernets: eth0: dhcp4: true dhcp6: false optional: true (elimino nameservers) /etc/systemd/resolved.conf : # This file is part of systemd. # # systemd is free software; you can redistribute it and/or modify it # under the terms of the GNU Lesser General Public License as published by # the Free Software Foundation; either version 2.1 of the License, or # (at your option) any later version. # # Entries in this file show the compile time defaults. # You can change settings by editing this file. # Defaults can be restored by simply deleting this file. # # See resolved.conf(5) for details [Resolve] DNS=10.0.1.102 Domains=adrianj.gonzalonazareno.org #FallbackDNS= #LLMNR=no #MulticastDNS=no #DNSSEC=yes #DNSOverTLS=no #Cache=yes DNSStubListener=no #ReadEtcHosts=yes (este fichero modifica /etc/resolv.conf ) Reinicio systemd-resolved : sudo systemctl restart systemd-resolved (esto actualiza /etc/resolv.conf ) \u00a1Atenci\u00f3n! Por un error de systemd con DNSStubListener=no hay que actualizar manualmente el enlace simb\u00f3lico, porque no lo hace autom\u00e1ticamente: sudo rm /etc/resolv.conf sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf","title":"En ares"},{"location":"practica-web-bd-dns-escenario/#en-hera_1","text":"/etc/NetworkManager/conf.d/90-dns-none.conf : [main] dns=none (evito que NetworkManager modifique /etc/resolv.conf ) Reinicio: sudo systemctl restart NetworkManager Escribo mi configuraci\u00f3n en /etc/resolv.conf : domain adrianj.gonzalonazareno.org search adrianj.gonzalonazareno.org. nameserver 10.0.1.102","title":"En hera"},{"location":"practica-web-bd-dns-escenario/#parte-3_1","text":"Configurar bind9 A\u00f1adir a named.conf.options : allow-recursion { any; }; recursion yes; allow-query { any; }; Comentar en named.conf : // include \"/etc/bind/named.conf.default-zones\"; Comentar en zones.rfc1918 : // zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.empty\"; }; named.conf.local : // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization view externa { match-clients { 172.22.0.0/16; 192.168.202.2/32; 192.168.1.0/24; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.externa.adrianj.gonzalonazareno.org\"; }; }; view dmz { match-clients { 172.16.0.0/16; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.dmz.adrianj.gonzalonazareno.org\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; view interna { match-clients { 10.0.1.0/24; 127.0.0.1/32; }; zone \"adrianj.gonzalonazareno.org\" { type master; file \"/etc/bind/db.interna.adrianj.gonzalonazareno.org\"; }; zone \"1.0.10.in-addr.arpa\" { type master; file \"/etc/bind/db.10.0.1\"; }; zone \"16.172.in-addr.arpa\" { type master; file \"/etc/bind/db.172.16\"; }; include \"/etc/bind/zones.rfc1918\"; include \"/etc/bind/named.conf.default-zones\"; }; (en la vista externa he a\u00f1adido la red de mi casa) db.externa.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA zeus.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS zeus.adrianj.gonzalonazareno.org. ; zeus IN A 172.22.0.213 ; clase zeus IN A 192.168.1.106 ; casa-eth www IN CNAME zeus (la IP externa cambia seg\u00fan est\u00e9 en clase o en casa) db.dmz.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 172.16.0.1 hera IN A 172.16.0.200 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 www IN CNAME hera bd IN CNAME ares db.interna.adrianj.gonzalonazareno.org : $ORIGIN adrianj.gonzalonazareno.org. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. zeus IN A 10.0.1.1 apolo IN A 10.0.1.102 ares IN A 10.0.1.101 hera IN A 172.16.0.200 www IN CNAME hera bd IN CNAME ares db.172.16 : $ORIGIN 16.172.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062502 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1.0 IN PTR zeus.adrianj.gonzalonazareno.org. 200.0 IN PTR hera.adrianj.gonzalonazareno.org. db.10.0.1 : $ORIGIN 1.0.10.in-addr.arpa. $TTL 86400 @ IN SOA apolo.adrianj.gonzalonazareno.org. admin.adrianj.gonzalonazareno.org. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day @ IN NS apolo.adrianj.gonzalonazareno.org. 1 IN PTR zeus.adrianj.gonzalonazareno.org. 102 IN PTR apolo.adrianj.gonzalonazareno.org. 101 IN PTR ares.adrianj.gonzalonazareno.org.","title":"Parte 3"},{"location":"practica-web-bd-dns-escenario/#servidor-web-hera","text":"","title":"Servidor Web (hera)"},{"location":"practica-web-bd-dns-escenario/#parte-1_2","text":"Instalar Apache sudo dnf install httpd systemctl enable --now httpd","title":"Parte 1"},{"location":"practica-web-bd-dns-escenario/#parte-2_2","text":"Instalar php + PHP-FPM sudo dnf install php (instala PHP-FPM por dependencia) En /var/www/www descargo: sudo wget https://gist.githubusercontent.com/SyntaxC4/5648247/raw/94277156638f9c309f2e36e19bff378ba7364907/info.php","title":"Parte 2"},{"location":"practica-web-bd-dns-escenario/#parte-3_2","text":"Crear VirtualHost /etc/httpd/conf.d/www.conf : <VirtualHost *:80> ServerName www.adrianj.gonzalonazareno.org DocumentRoot /var/www/www </VirtualHost>","title":"Parte 3"},{"location":"practica-web-bd-dns-escenario/#parte-4_1","text":"Reiniciar Apache sudo systemctl restart httpd","title":"Parte 4"},{"location":"practica-web-bd-dns-escenario/#parte-5_1","text":"Instalar cliente MariaDB (para entrega parte 5) curl -LsS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash sudo dnf install MariaDB-client","title":"Parte 5"},{"location":"practica-web-bd-dns-escenario/#servidor-de-bd-ares","text":"","title":"Servidor de BD (ares)"},{"location":"practica-web-bd-dns-escenario/#parte-1_3","text":"Instalar MariaDB sudo apt install mariadb-server","title":"Parte 1"},{"location":"practica-web-bd-dns-escenario/#parte-2_3","text":"Habilitar conexiones remotas /etc/mysql/mariadb.conf.d/50-server.cnf : bind-address = 0.0.0.0","title":"Parte 2"},{"location":"practica-web-bd-dns-escenario/#parte-3_3","text":"Habilitar root con acceso remoto use mysql; update user set plugin='' where User='root'; grant all privileges on *.* to 'root'@'%' identified by '1234'; flush privileges;","title":"Parte 3"},{"location":"practica-web-bd-dns-escenario/#parte-4_2","text":"Reiniciar sudo systemctl restart mariadb","title":"Parte 4"},{"location":"practica1-implantacion-apps-php/","text":"Pr\u00e1ctica 1: Implantaci\u00f3n de aplicaciones web PHP Tarea 0: Preliminares Paso 1 Mostrar escenario Vagrant Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :implantacionphp do |implantacionphp| implantacionphp.vm.box = \"debian/bullseye64\" implantacionphp.vm.hostname = \"implantacionphp\" end end Paso 2 Instalar LAMP en esa m\u00e1quina sudo apt update && sudo apt -y upgrade sudo apt install mariadb-server sudo apt install apache2 sudo chown -R www-data:www-data /var/www/ sudo apt install php libapache2-mod-php php-cli php-fpm php-json php-pdo php-mysql php-zip php-gd php-mbstring php-curl php-xml php-pear php-bcmath Tarea 1: Instalaci\u00f3n de phpBB en servidor local Paso 1 Crear VirtualHost con ServerName www.adrianjaramillo-phpBB.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.adrianjaramillo-phpBB.org DocumentRoot /var/www/phpBB # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite phpBB.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # practica-implantacion-apps-php resolutions 192.168.121.245 www.adrianjaramillo-phpBB.org Paso 2 Crear BD para phpBB CREATE DATABASE `phpBB_db`; Paso 3 Crear usuario con permisos sobre phpBB_db CREATE USER 'phpBB_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpBB_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpBB_db`.* TO 'phpBB_user'@localhost; FLUSH PRIVILEGES; Paso 4 Descargar phpBB sudo apt install unzip sudo wget https://download.phpbb.com/pub/release/3.3/3.3.5/phpBB-3.3.5.zip sudo unzip phpBB-3.3.5.zip sudo mv phpBB3 phpBB Todo este proceso lo hago sobre /var/www , para que el directorio resultante coincida con el DocumentRoot del VirtualHost previamente configurado. Paso 5 Instalaci\u00f3n de phpBB Credenciales para el usuario administrador: Usuario: admin Contrase\u00f1a: admin1 Correo: adristudy@gmail.com Introducimos los datos de conexi\u00f3n con la BD: Configuraci\u00f3n del servidor: Configuraci\u00f3n de email: Configuraci\u00f3n del tabl\u00f3n: Proceso de instalaci\u00f3n completado: Vemos que phpBB ya est\u00e1 funcionando: Tal como nos indica en ese mensaje, es importante que borremos el directorio install sudo rm -r install A partir de ahora, s\u00ed que est\u00e1 funcionando phpBB completamente: Paso 6 Cambiar el tema Descargo el tema \"Ultra Light\": wget https://www.phpbb.com/customise/db/download/192276 -P /tmp Descomprimo el tema en el directorio requerido: sudo unzip 192276 -d /var/www/phpBB/styles/ Compruebo la estructura del tema para ver que se haya descomprimido correctamente: vagrant@implantacionphp:/var/www/phpBB/styles/ultra_light$ ls -la total 36 drwxr-xr-x 4 root root 4096 Oct 28 07:36 . drwxr-xr-x 5 www-data www-data 4096 Oct 28 07:36 .. -rw-rw-rw- 1 root root 15405 Oct 4 09:26 license.txt -rw-rw-rw- 1 root root 938 Oct 4 09:26 style.cfg drwxr-xr-x 2 root root 4096 Oct 28 07:36 template drwxr-xr-x 5 root root 4096 Oct 28 07:36 theme En nuestro ACP (panel de administraci\u00f3n) , instalamos el tema: Se instal\u00f3 correctamente: En el ACP, dentro de General -> Board Configuration -> Board settings, aplicamos el nuevo tema: Muestro que ya funciona: Paso 7 Crear contenido Hago un post de prueba en el foro: Paso 8 Instalar una extensi\u00f3n a phpBB Descargo la extensi\u00f3n \"Media Embed PlugIn\": wget https://www.phpbb.com/customise/db/download/182026 -P /tmp Descomprimo la extensi\u00f3n en el directorio requerido: sudo unzip 182026 -d /var/www/phpBB/ext/ Compruebo que se haya descomprimido correctamente: vagrant@implantacionphp:/var/www/phpBB/ext/phpbb/mediaembed$ ls -la total 80 drwxr-xr-x 12 root root 4096 Oct 28 09:06 . drwxr-xr-x 4 www-data www-data 4096 Oct 28 09:06 .. -rw-rw-rw- 1 root root 2392 Aug 14 2020 CHANGELOG.md drwxr-xr-x 2 root root 4096 Oct 28 09:06 acp drwxr-xr-x 3 root root 4096 Oct 28 09:06 adm drwxr-xr-x 2 root root 4096 Oct 28 09:06 cache drwxr-xr-x 3 root root 4096 Oct 28 09:06 collection -rw-rw-rw- 1 root root 1631 Aug 14 2020 composer.json drwxr-xr-x 2 root root 4096 Oct 28 09:06 config drwxr-xr-x 2 root root 4096 Oct 28 09:06 cron drwxr-xr-x 2 root root 4096 Oct 28 09:06 event -rw-rw-rw- 1 root root 1946 Aug 14 2020 ext.php drwxr-xr-x 19 root root 4096 Oct 28 09:06 language -rw-rw-rw- 1 root root 18092 Aug 14 2020 license.txt drwxr-xr-x 2 root root 4096 Oct 28 09:06 migrations drwxr-xr-x 3 root root 4096 Oct 28 09:06 styles En nuestro ACP, habilitamos la extensi\u00f3n: Mi extensi\u00f3n a\u00f1adida posibilita los v\u00eddeos embebidos en los posts. Muestro que funciona: Tarea 2: Configuraci\u00f3n multinodo Paso 1 Realizar backup de la base de datos sudo mysqldump -u root phpBB_db > phpBB_db_backup.sql Paso 2 Crear otra m\u00e1quina Vagrant, conectada con una red interna a la anterior Vagrantfile actualizado: Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :implantacionphp do |implantacionphp| implantacionphp.vm.box = \"debian/bullseye64\" implantacionphp.vm.hostname = \"implantacionphp\" implantacionphp.vm.network :private_network, :libvirt__network_name => \"implantacionphpnet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :dbserver do |dbserver| dbserver.vm.box = \"debian/bullseye64\" dbserver.vm.hostname = \"dbserver\" dbserver.vm.network :private_network, :libvirt__network_name => \"implantacionphpnet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end end Paso 3 Instalar mariadb-server y crear la BD en la segunda m\u00e1quina sudo apt update sudo apt install mariadb-server CREATE DATABASE `phpBB_db`; Paso 4 Crear usuario con privilegios sobre la nueva BD CREATE USER 'phpBB_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpBB_user'@'%' IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpBB_db`.* TO 'phpBB_user'@'%'; FLUSH PRIVILEGES; Paso 5 Restaurar la backup en la nueva BD use phpBB_db; source phpBB_db_backup.sql; Paso 6 Habilitar conexiones remotas en el nuevo servidor de BD En /etc/mysql/mariadb.conf.d/50-server.cnf modificar: bind-address = 0.0.0.0 Reiniciar mariadb: sudo systemctl restart mariadb Paso 7 Desinstalar mariadb en el servidor principal sudo apt purge \"mariadb*\" Paso 8 Modificar config.php con los nuevos datos de conexi\u00f3n a la BD <?php // phpBB 3.3.x auto-generated configuration file // Do not change anything in this file! $dbms = 'phpbb\\\\db\\\\driver\\\\mysqli'; $dbhost = '10.0.0.3'; $dbport = ''; $dbname = 'phpBB_db'; $dbuser = 'phpBB_user'; $dbpasswd = '1234'; $table_prefix = 'phpbb_'; $phpbb_adm_relative_path = 'adm/'; $acm_type = 'phpbb\\\\cache\\\\driver\\\\file'; @define('PHPBB_INSTALLED', true); @define('PHPBB_ENVIRONMENT', 'production'); // @define('DEBUG_CONTAINER', true); Solamente hemos modificado la variable $dbhost , porque lo \u00fanico que ha cambiado de la BD es la ubicaci\u00f3n. Paso 9 Mostrar de nuevo phpBB funcionando La \u00fanica diferencia es que ahora, se accede a la BD remotamente. Tarea 3: Instalaci\u00f3n de ConcreteCMS Paso 1 Configurar otro VirtualHost, ahora con ServerName www.adrianjaramillo-concretecms.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.adrianjaramillo-concretecms.org DocumentRoot /var/www/ConcreteCMS # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite ConcreteCMS.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # practica-implantacion-apps-php resolutions 192.168.121.31 www.adrianjaramillo-phpBB.org 192.168.121.31 www.adrianjaramillo-concretecms.org Paso 2 Crear BD para ConcreteCMS CREATE DATABASE `ConcreteCMS_db`; Paso 3 Crear usuario con permisos sobre ConcreteCMS_db CREATE USER 'ConcreteCMS_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'ConcreteCMS_user'@'%' IDENTIFIED BY '1234'; GRANT ALL privileges ON `ConcreteCMS_db`.* TO 'ConcreteCMS_user'@'%'; FLUSH PRIVILEGES; Paso 4 Descargar ConcreteCMS sudo wget https://www.concretecms.com/download_file/61dab82f-fb01-47bc-8cf1-deffff890224 sudo unzip 61dab82f-fb01-47bc-8cf1-deffff890224 sudo mv concrete5-8.5.6 ConcreteCMS Todo este proceso lo hago sobre /var/www , para que el directorio resultante coincida con el DocumentRoot del VirtualHost previamente configurado. ConcreteCMS va a necesitar escribir sobre su DocumentRoot, as\u00ed que cambiamos los propietarios a www-data : sudo chown -R www-data:www-data /var/www/ConcreteCMS Paso 5 Instalaci\u00f3n de ConcreteCMS Accedemos a www.adrianjaramillo-concretecms.org y comenzamos: Tenemos todos los requerimientos, as\u00ed que podemos seguir. Datos de la cuenta admin introducidos: Email: adristudy@gmail.com Username: admin (no aparece en la instalaci\u00f3n, pero es as\u00ed) Password: admin Datos de conexi\u00f3n a la BD introducidos: Server: 10.0.0.3 Username: ConcreteCMS_user Password: 1234 Database Name: ConcreteCMS_db Esos datos son los que a\u00f1ado en la instalaci\u00f3n: ConcreteCMS se empieza a instalar: Instalaci\u00f3n completada: Vemos que la web funciona: Paso 6 Cambiar el tema Paso el zip de mi m\u00e1quina al home de la VM: scp Downloads/theme_neat.zip vagrant@192.168.121.31:~/ No he podido pasar el zip directamente al directorio requerido, porque el usuario Vagrant no tiene permiso de escritura all\u00ed. Extraigo el zip en el directorio requerido: sudo unzip ~/theme_neat.zip -d /var/www/ConcreteCMS/packages Para instalarlo, hacemos lo siguiente: Para activarlo, hacemos lo siguiente: Vemos que el tema se ha aplicado: Paso 7 Crear contenido He creado una entrada en el blog, y muestro que funciona: Paso 8 Instalar un add-on en ConcreteCMS Paso el zip de mi m\u00e1quina al home de la VM: scp Downloads/hw_back_to_top.zip vagrant@192.168.121.31:~/ Extraigo el zip en el directorio requerido: sudo unzip ~/hw_back_to_top.zip -d /var/www/ConcreteCMS/packages Instalo el add-on: Lo a\u00f1ado a la web: Muestro que funciona: Tarea 4: Migraci\u00f3n de ConcreteCMS a hosting Paso 1 Eligir un servicio de hosting con PHP y base de datos https://freehostingnoads.net/ Paso 2 Crear un subdominio gratuito Paso 3 Subir todo el DocumentRoot de ConcreteCMS usando FTP Instalo un cliente FTP: sudo apt show ncftp Las credenciales FTP que me ofrece el hosting son las siguientes: FTP Username: 3976052 FTP Password: concretecmsadmin1 (cambiada por m\u00ed) Hostname: concretecms.atwebpages.com Subo todo el DocumentRoot al directorio remoto (nos pregunta la contrase\u00f1a antes de empezar a subir ficheros) : ncftpput -R -v -u \"3976052\" concretecms.atwebpages.com /concretecms.atwebpages.com /var/www/ConcreteCMS/* Paso 4 Crear BD Introduzco lo siguiente en el hosting para crear la BD: Ya la tengo creada: Mi hosting por motivos de seguridad no permite las conexiones remotas a la BD, as\u00ed que... Exporto la BD: sudo mysqldump -u root ConcreteCMS_db > ConcreteCMS_db_backup.sql Paso el fichero a mi m\u00e1quina: scp ConcreteCMS_db_backup.sql atlas@192.168.121.1:~/Downloads Importo la BD en mi hosting: Paso 5 Modificar los datos de conexi\u00f3n a la BD Modifico el fichero application/config/database.php en el hosting de la siguiente manera: Paso 6 Borrar el directorio application/files/cache/ en el hosting Este paso es MUY IMPORTANTE , porque tal y como dicen en la documentaci\u00f3n oficial de Concrete CMS sobre mover un site... Si no borramos ese directorio con cach\u00e9, nuestra web no funcionar\u00e1 . Paso 7 Mostrar la web funcionando en el hosting","title":"Pr\u00e1ctica 1: Apps PHP"},{"location":"practica1-implantacion-apps-php/#practica-1-implantacion-de-aplicaciones-web-php","text":"","title":"Pr\u00e1ctica 1: Implantaci\u00f3n de aplicaciones web PHP"},{"location":"practica1-implantacion-apps-php/#tarea-0-preliminares","text":"","title":"Tarea 0: Preliminares"},{"location":"practica1-implantacion-apps-php/#paso-1","text":"Mostrar escenario Vagrant Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :implantacionphp do |implantacionphp| implantacionphp.vm.box = \"debian/bullseye64\" implantacionphp.vm.hostname = \"implantacionphp\" end end","title":"Paso 1"},{"location":"practica1-implantacion-apps-php/#paso-2","text":"Instalar LAMP en esa m\u00e1quina sudo apt update && sudo apt -y upgrade sudo apt install mariadb-server sudo apt install apache2 sudo chown -R www-data:www-data /var/www/ sudo apt install php libapache2-mod-php php-cli php-fpm php-json php-pdo php-mysql php-zip php-gd php-mbstring php-curl php-xml php-pear php-bcmath","title":"Paso 2"},{"location":"practica1-implantacion-apps-php/#tarea-1-instalacion-de-phpbb-en-servidor-local","text":"","title":"Tarea 1: Instalaci\u00f3n de phpBB en servidor local"},{"location":"practica1-implantacion-apps-php/#paso-1_1","text":"Crear VirtualHost con ServerName www.adrianjaramillo-phpBB.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.adrianjaramillo-phpBB.org DocumentRoot /var/www/phpBB # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite phpBB.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # practica-implantacion-apps-php resolutions 192.168.121.245 www.adrianjaramillo-phpBB.org","title":"Paso 1"},{"location":"practica1-implantacion-apps-php/#paso-2_1","text":"Crear BD para phpBB CREATE DATABASE `phpBB_db`;","title":"Paso 2"},{"location":"practica1-implantacion-apps-php/#paso-3","text":"Crear usuario con permisos sobre phpBB_db CREATE USER 'phpBB_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpBB_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpBB_db`.* TO 'phpBB_user'@localhost; FLUSH PRIVILEGES;","title":"Paso 3"},{"location":"practica1-implantacion-apps-php/#paso-4","text":"Descargar phpBB sudo apt install unzip sudo wget https://download.phpbb.com/pub/release/3.3/3.3.5/phpBB-3.3.5.zip sudo unzip phpBB-3.3.5.zip sudo mv phpBB3 phpBB Todo este proceso lo hago sobre /var/www , para que el directorio resultante coincida con el DocumentRoot del VirtualHost previamente configurado.","title":"Paso 4"},{"location":"practica1-implantacion-apps-php/#paso-5","text":"Instalaci\u00f3n de phpBB Credenciales para el usuario administrador: Usuario: admin Contrase\u00f1a: admin1 Correo: adristudy@gmail.com Introducimos los datos de conexi\u00f3n con la BD: Configuraci\u00f3n del servidor: Configuraci\u00f3n de email: Configuraci\u00f3n del tabl\u00f3n: Proceso de instalaci\u00f3n completado: Vemos que phpBB ya est\u00e1 funcionando: Tal como nos indica en ese mensaje, es importante que borremos el directorio install sudo rm -r install A partir de ahora, s\u00ed que est\u00e1 funcionando phpBB completamente:","title":"Paso 5"},{"location":"practica1-implantacion-apps-php/#paso-6","text":"Cambiar el tema Descargo el tema \"Ultra Light\": wget https://www.phpbb.com/customise/db/download/192276 -P /tmp Descomprimo el tema en el directorio requerido: sudo unzip 192276 -d /var/www/phpBB/styles/ Compruebo la estructura del tema para ver que se haya descomprimido correctamente: vagrant@implantacionphp:/var/www/phpBB/styles/ultra_light$ ls -la total 36 drwxr-xr-x 4 root root 4096 Oct 28 07:36 . drwxr-xr-x 5 www-data www-data 4096 Oct 28 07:36 .. -rw-rw-rw- 1 root root 15405 Oct 4 09:26 license.txt -rw-rw-rw- 1 root root 938 Oct 4 09:26 style.cfg drwxr-xr-x 2 root root 4096 Oct 28 07:36 template drwxr-xr-x 5 root root 4096 Oct 28 07:36 theme En nuestro ACP (panel de administraci\u00f3n) , instalamos el tema: Se instal\u00f3 correctamente: En el ACP, dentro de General -> Board Configuration -> Board settings, aplicamos el nuevo tema: Muestro que ya funciona:","title":"Paso 6"},{"location":"practica1-implantacion-apps-php/#paso-7","text":"Crear contenido Hago un post de prueba en el foro:","title":"Paso 7"},{"location":"practica1-implantacion-apps-php/#paso-8","text":"Instalar una extensi\u00f3n a phpBB Descargo la extensi\u00f3n \"Media Embed PlugIn\": wget https://www.phpbb.com/customise/db/download/182026 -P /tmp Descomprimo la extensi\u00f3n en el directorio requerido: sudo unzip 182026 -d /var/www/phpBB/ext/ Compruebo que se haya descomprimido correctamente: vagrant@implantacionphp:/var/www/phpBB/ext/phpbb/mediaembed$ ls -la total 80 drwxr-xr-x 12 root root 4096 Oct 28 09:06 . drwxr-xr-x 4 www-data www-data 4096 Oct 28 09:06 .. -rw-rw-rw- 1 root root 2392 Aug 14 2020 CHANGELOG.md drwxr-xr-x 2 root root 4096 Oct 28 09:06 acp drwxr-xr-x 3 root root 4096 Oct 28 09:06 adm drwxr-xr-x 2 root root 4096 Oct 28 09:06 cache drwxr-xr-x 3 root root 4096 Oct 28 09:06 collection -rw-rw-rw- 1 root root 1631 Aug 14 2020 composer.json drwxr-xr-x 2 root root 4096 Oct 28 09:06 config drwxr-xr-x 2 root root 4096 Oct 28 09:06 cron drwxr-xr-x 2 root root 4096 Oct 28 09:06 event -rw-rw-rw- 1 root root 1946 Aug 14 2020 ext.php drwxr-xr-x 19 root root 4096 Oct 28 09:06 language -rw-rw-rw- 1 root root 18092 Aug 14 2020 license.txt drwxr-xr-x 2 root root 4096 Oct 28 09:06 migrations drwxr-xr-x 3 root root 4096 Oct 28 09:06 styles En nuestro ACP, habilitamos la extensi\u00f3n: Mi extensi\u00f3n a\u00f1adida posibilita los v\u00eddeos embebidos en los posts. Muestro que funciona:","title":"Paso 8"},{"location":"practica1-implantacion-apps-php/#tarea-2-configuracion-multinodo","text":"","title":"Tarea 2: Configuraci\u00f3n multinodo"},{"location":"practica1-implantacion-apps-php/#paso-1_2","text":"Realizar backup de la base de datos sudo mysqldump -u root phpBB_db > phpBB_db_backup.sql","title":"Paso 1"},{"location":"practica1-implantacion-apps-php/#paso-2_2","text":"Crear otra m\u00e1quina Vagrant, conectada con una red interna a la anterior Vagrantfile actualizado: Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :implantacionphp do |implantacionphp| implantacionphp.vm.box = \"debian/bullseye64\" implantacionphp.vm.hostname = \"implantacionphp\" implantacionphp.vm.network :private_network, :libvirt__network_name => \"implantacionphpnet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.2\", :libvirt__forward_mode => \"veryisolated\" end config.vm.define :dbserver do |dbserver| dbserver.vm.box = \"debian/bullseye64\" dbserver.vm.hostname = \"dbserver\" dbserver.vm.network :private_network, :libvirt__network_name => \"implantacionphpnet\", :libvirt__dhcp_enabled => false, :ip => \"10.0.0.3\", :libvirt__forward_mode => \"veryisolated\" end end","title":"Paso 2"},{"location":"practica1-implantacion-apps-php/#paso-3_1","text":"Instalar mariadb-server y crear la BD en la segunda m\u00e1quina sudo apt update sudo apt install mariadb-server CREATE DATABASE `phpBB_db`;","title":"Paso 3"},{"location":"practica1-implantacion-apps-php/#paso-4_1","text":"Crear usuario con privilegios sobre la nueva BD CREATE USER 'phpBB_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpBB_user'@'%' IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpBB_db`.* TO 'phpBB_user'@'%'; FLUSH PRIVILEGES;","title":"Paso 4"},{"location":"practica1-implantacion-apps-php/#paso-5_1","text":"Restaurar la backup en la nueva BD use phpBB_db; source phpBB_db_backup.sql;","title":"Paso 5"},{"location":"practica1-implantacion-apps-php/#paso-6_1","text":"Habilitar conexiones remotas en el nuevo servidor de BD En /etc/mysql/mariadb.conf.d/50-server.cnf modificar: bind-address = 0.0.0.0 Reiniciar mariadb: sudo systemctl restart mariadb","title":"Paso 6"},{"location":"practica1-implantacion-apps-php/#paso-7_1","text":"Desinstalar mariadb en el servidor principal sudo apt purge \"mariadb*\"","title":"Paso 7"},{"location":"practica1-implantacion-apps-php/#paso-8_1","text":"Modificar config.php con los nuevos datos de conexi\u00f3n a la BD <?php // phpBB 3.3.x auto-generated configuration file // Do not change anything in this file! $dbms = 'phpbb\\\\db\\\\driver\\\\mysqli'; $dbhost = '10.0.0.3'; $dbport = ''; $dbname = 'phpBB_db'; $dbuser = 'phpBB_user'; $dbpasswd = '1234'; $table_prefix = 'phpbb_'; $phpbb_adm_relative_path = 'adm/'; $acm_type = 'phpbb\\\\cache\\\\driver\\\\file'; @define('PHPBB_INSTALLED', true); @define('PHPBB_ENVIRONMENT', 'production'); // @define('DEBUG_CONTAINER', true); Solamente hemos modificado la variable $dbhost , porque lo \u00fanico que ha cambiado de la BD es la ubicaci\u00f3n.","title":"Paso 8"},{"location":"practica1-implantacion-apps-php/#paso-9","text":"Mostrar de nuevo phpBB funcionando La \u00fanica diferencia es que ahora, se accede a la BD remotamente.","title":"Paso 9"},{"location":"practica1-implantacion-apps-php/#tarea-3-instalacion-de-concretecms","text":"","title":"Tarea 3: Instalaci\u00f3n de ConcreteCMS"},{"location":"practica1-implantacion-apps-php/#paso-1_3","text":"Configurar otro VirtualHost, ahora con ServerName www.adrianjaramillo-concretecms.org <VirtualHost *:80> # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request's Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. ServerName www.adrianjaramillo-concretecms.org DocumentRoot /var/www/ConcreteCMS # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \"a2disconf\". #Include conf-available/serve-cgi-bin.conf </VirtualHost> # vim: syntax=apache ts=4 sw=4 sts=4 sr noet Lo habilito: sudo a2ensite ConcreteCMS.conf Reinicio Apache: sudo systemctl restart apache2 Modifico mi /etc/hosts : # practica-implantacion-apps-php resolutions 192.168.121.31 www.adrianjaramillo-phpBB.org 192.168.121.31 www.adrianjaramillo-concretecms.org","title":"Paso 1"},{"location":"practica1-implantacion-apps-php/#paso-2_3","text":"Crear BD para ConcreteCMS CREATE DATABASE `ConcreteCMS_db`;","title":"Paso 2"},{"location":"practica1-implantacion-apps-php/#paso-3_2","text":"Crear usuario con permisos sobre ConcreteCMS_db CREATE USER 'ConcreteCMS_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'ConcreteCMS_user'@'%' IDENTIFIED BY '1234'; GRANT ALL privileges ON `ConcreteCMS_db`.* TO 'ConcreteCMS_user'@'%'; FLUSH PRIVILEGES;","title":"Paso 3"},{"location":"practica1-implantacion-apps-php/#paso-4_2","text":"Descargar ConcreteCMS sudo wget https://www.concretecms.com/download_file/61dab82f-fb01-47bc-8cf1-deffff890224 sudo unzip 61dab82f-fb01-47bc-8cf1-deffff890224 sudo mv concrete5-8.5.6 ConcreteCMS Todo este proceso lo hago sobre /var/www , para que el directorio resultante coincida con el DocumentRoot del VirtualHost previamente configurado. ConcreteCMS va a necesitar escribir sobre su DocumentRoot, as\u00ed que cambiamos los propietarios a www-data : sudo chown -R www-data:www-data /var/www/ConcreteCMS","title":"Paso 4"},{"location":"practica1-implantacion-apps-php/#paso-5_2","text":"Instalaci\u00f3n de ConcreteCMS Accedemos a www.adrianjaramillo-concretecms.org y comenzamos: Tenemos todos los requerimientos, as\u00ed que podemos seguir. Datos de la cuenta admin introducidos: Email: adristudy@gmail.com Username: admin (no aparece en la instalaci\u00f3n, pero es as\u00ed) Password: admin Datos de conexi\u00f3n a la BD introducidos: Server: 10.0.0.3 Username: ConcreteCMS_user Password: 1234 Database Name: ConcreteCMS_db Esos datos son los que a\u00f1ado en la instalaci\u00f3n: ConcreteCMS se empieza a instalar: Instalaci\u00f3n completada: Vemos que la web funciona:","title":"Paso 5"},{"location":"practica1-implantacion-apps-php/#paso-6_2","text":"Cambiar el tema Paso el zip de mi m\u00e1quina al home de la VM: scp Downloads/theme_neat.zip vagrant@192.168.121.31:~/ No he podido pasar el zip directamente al directorio requerido, porque el usuario Vagrant no tiene permiso de escritura all\u00ed. Extraigo el zip en el directorio requerido: sudo unzip ~/theme_neat.zip -d /var/www/ConcreteCMS/packages Para instalarlo, hacemos lo siguiente: Para activarlo, hacemos lo siguiente: Vemos que el tema se ha aplicado:","title":"Paso 6"},{"location":"practica1-implantacion-apps-php/#paso-7_2","text":"Crear contenido He creado una entrada en el blog, y muestro que funciona:","title":"Paso 7"},{"location":"practica1-implantacion-apps-php/#paso-8_2","text":"Instalar un add-on en ConcreteCMS Paso el zip de mi m\u00e1quina al home de la VM: scp Downloads/hw_back_to_top.zip vagrant@192.168.121.31:~/ Extraigo el zip en el directorio requerido: sudo unzip ~/hw_back_to_top.zip -d /var/www/ConcreteCMS/packages Instalo el add-on: Lo a\u00f1ado a la web: Muestro que funciona:","title":"Paso 8"},{"location":"practica1-implantacion-apps-php/#tarea-4-migracion-de-concretecms-a-hosting","text":"","title":"Tarea 4: Migraci\u00f3n de ConcreteCMS a hosting"},{"location":"practica1-implantacion-apps-php/#paso-1_4","text":"Eligir un servicio de hosting con PHP y base de datos https://freehostingnoads.net/","title":"Paso 1"},{"location":"practica1-implantacion-apps-php/#paso-2_4","text":"Crear un subdominio gratuito","title":"Paso 2"},{"location":"practica1-implantacion-apps-php/#paso-3_3","text":"Subir todo el DocumentRoot de ConcreteCMS usando FTP Instalo un cliente FTP: sudo apt show ncftp Las credenciales FTP que me ofrece el hosting son las siguientes: FTP Username: 3976052 FTP Password: concretecmsadmin1 (cambiada por m\u00ed) Hostname: concretecms.atwebpages.com Subo todo el DocumentRoot al directorio remoto (nos pregunta la contrase\u00f1a antes de empezar a subir ficheros) : ncftpput -R -v -u \"3976052\" concretecms.atwebpages.com /concretecms.atwebpages.com /var/www/ConcreteCMS/*","title":"Paso 3"},{"location":"practica1-implantacion-apps-php/#paso-4_3","text":"Crear BD Introduzco lo siguiente en el hosting para crear la BD: Ya la tengo creada: Mi hosting por motivos de seguridad no permite las conexiones remotas a la BD, as\u00ed que... Exporto la BD: sudo mysqldump -u root ConcreteCMS_db > ConcreteCMS_db_backup.sql Paso el fichero a mi m\u00e1quina: scp ConcreteCMS_db_backup.sql atlas@192.168.121.1:~/Downloads Importo la BD en mi hosting:","title":"Paso 4"},{"location":"practica1-implantacion-apps-php/#paso-5_3","text":"Modificar los datos de conexi\u00f3n a la BD Modifico el fichero application/config/database.php en el hosting de la siguiente manera:","title":"Paso 5"},{"location":"practica1-implantacion-apps-php/#paso-6_3","text":"Borrar el directorio application/files/cache/ en el hosting Este paso es MUY IMPORTANTE , porque tal y como dicen en la documentaci\u00f3n oficial de Concrete CMS sobre mover un site... Si no borramos ese directorio con cach\u00e9, nuestra web no funcionar\u00e1 .","title":"Paso 6"},{"location":"practica1-implantacion-apps-php/#paso-7_3","text":"Mostrar la web funcionando en el hosting","title":"Paso 7"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/","text":"Pr\u00e1ctica 2: Instalaci\u00f3n/migraci\u00f3n de aplicaciones web PHP en tu VPS Tarea 1: Migraci\u00f3n de phpBB Ejercicio 1 Crear VirtualHost con server_name portal.adrianjaramillo.tk Creo /etc/nginx/sites-available/portal.conf : server { listen 80; server_name portal.adrianjaramillo.tk; root /var/www/portal; location / { index index.php index.html index.htm; } location ~ \\.php$ { include fastcgi_params; fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/portal.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx Creo un registro CNAME en la zona DNS p\u00fablica para portal.adrianjaramillo.tk : Ejercicio 2 Nombrar en /etc/hosts la BD como bd.adrianjaramillo.tk Modifico la siguiente l\u00ednea en /etc/hosts : 127.0.0.1 localhost.localdomain localhost bd.adrianjaramillo.tk Muestro que funciona: blackmamba@kampe:/etc/nginx/sites-available$ ping bd.adrianjaramillo.tk PING localhost.localdomain (127.0.0.1) 56(84) bytes of data. 64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=1 ttl=64 time=0.039 ms 64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=2 ttl=64 time=0.058 ms ^C --- localhost.localdomain ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1031ms rtt min/avg/max/mdev = 0.039/0.048/0.058/0.009 ms Ejercicio 3 Realizar la migraci\u00f3n de phpBB. Parte 1 Instalar las dependencias de paqueter\u00eda requeridas para que phpBB funcione sudo apt install php-json php-mbstring php-xml php-mysql php-pdo php-zip php-gd php-curl php-pear php-bcmath Parte 2 Transferir el DocumentRoot de phpBB al VPS mediante repositorios Hago una copia del DocumentRoot en el home: sudo cp -r /var/www/phpBB ~ Cambio los propietarios: sudo chown -R vagrant:vagrant ~/phpBB/ Inicializo el directorio como repo git: git init Creo el repositorio en github: https://github.com/adriasir123/phpBB-document-root Subo el directorio al repositorio creado: git remote add origin git@github.com:adriasir123/phpBB-document-root.git git branch -M main git add . git config --global user.email \"adristudy@gmail.com\" git config --global user.name \"Adri\u00e1n Jaramillo Rodr\u00edguez\" git commit -m \"Initial commit\" git push -u origin main Me bajo el repositorio en /var/www/portal del VPS: sudo git clone https://github.com/adriasir123/phpBB-document-root.git . Modifico los propietarios correctamente en /var/www/portal/ : sudo chown -R www-data:www-data /var/www/portal/ Parte 3 Migrar la BD al VPS Exporto la BD: sudo mysqldump -u root phpBB_db > phpBB_db.sql Creo la BD en el VPS: CREATE DATABASE `phpBB_db`; Creo un usuario con permisos sobre phpBB_db : CREATE USER 'phpBB_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpBB_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpBB_db`.* TO 'phpBB_user'@localhost; FLUSH PRIVILEGES; Importo la copia de seguridad: sudo mysql -u root phpBB_db < phpBB_db.sql Parte 4 Cambiar los datos de conexi\u00f3n a la base de datos Modifico la siguiente l\u00ednea en config.php : $dbhost = 'bd.adrianjaramillo.tk'; Ejercicio 4 Comprobar que phpBB sigue funcionando en portal.adrianjaramillo.tk Tarea 2: Instalaci\u00f3n/migraci\u00f3n Nextcloud Ejercicio 1 Instalar Nextcloud en el entorno de desarrollo. Parte 1 Crear el escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :nextcloudnginx do |nextcloudnginx| nextcloudnginx.vm.box = \"debian/bullseye64\" nextcloudnginx.vm.hostname = \"nextcloudnginx\" end end Parte 2 Instalar y configurar Nginx Lo instalo: sudo apt update sudo apt install curl gnupg2 ca-certificates lsb-release sudo apt install nginx Creo /etc/nginx/sites-available/nextcloud.conf , con server_name www.nextcloud-adrianj.com : server { listen 80; server_name www.nextcloud-adrianj.com; # Path to the root of the domain root /var/www/nextcloud; location = /robots.txt { allow all; log_not_found off; access_log off; } location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in the Nextcloud `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 /cloud/remote.php/dav/; } location = /.well-known/caldav { return 301 /cloud/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 /cloud/index.php$request_uri; } location ^~ /cloud { # set max upload size and increase upload timeout: client_max_body_size 512M; client_body_timeout 300s; fastcgi_buffers 64 4K; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Specify how to handle directories -- specifying `/nextcloud/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /nextcloud/index.php$request_uri` # always provides the desired behaviour. index index.php index.html /cloud/index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = /cloud { if ( $http_user_agent ~ ^DavClnt ) { return 302 /cloud/remote.php/webdav/$is_args$args; } } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends # `/nextcloud/index.php` to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { # Required for legacy support rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri; fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif|png|jpg|ico)$ { try_files $uri /cloud/index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /cloud/index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /cloud/remote { return 301 /cloud/remote.php$request_uri; } location /cloud { try_files $uri $uri/ /cloud/index.php$request_uri; } } } Nextcloud no est\u00e1 oficialmente soportado para Nginx, as\u00ed que esta configuraci\u00f3n est\u00e1 hecha por contribuidores. Igualmente, est\u00e1 publicada en la documentaci\u00f3n oficial de Nextcloud: https://docs.nextcloud.com/server/latest/admin_manual/installation/nginx.html#nextcloud-in-a-subdir-of-the-nginx-webroot Espec\u00edficamente, he elegido hacer la manera en subdirectorio, para que mi entorno de desarrollo y el de producci\u00f3n sean lo m\u00e1s parecidos posible. As\u00ed, la migraci\u00f3n luego ser\u00e1 m\u00e1s sencilla. Lo habilito: sudo ln -s /etc/nginx/sites-available/nextcloud.conf /etc/nginx/sites-enabled/ Compruebo que la configuraci\u00f3n sea correcta: sudo nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful Reinicio Nginx: sudo systemctl restart nginx Modifico mi /etc/hosts : # nextcloudnginx resolutions 192.168.121.62 www.nextcloud-adrianj.com Parte 3 Instalar y configurar php Instalo PHP-FPM y dependencias php para Nextcloud: sudo apt install php-fpm php-mysql php-zip php-xml php-mbstring php-gd php-curl php-cli php-common php-json php-intl php-pear php-imagick php-dev php-soap php-bz2 Modifico las siguientes l\u00edneas en /etc/php/7.4/fpm/php.ini y /etc/php/7.4/cli/php.ini : date.timezone = Europe/Madrid cgi.fix_pathinfo=0 Descomentar las siguientes l\u00edneas en /etc/php/7.4/fpm/pool.d/www.conf : env[HOSTNAME] = $HOSTNAME env[PATH] = /usr/local/bin:/usr/bin:/bin env[TMP] = /tmp env[TMPDIR] = /tmp env[TEMP] = /tmp Habilito y reinicio php-fpm: sudo systemctl enable php7.4-fpm sudo systemctl restart php7.4-fpm Parte 4 Instalar servidor MariaDB sudo apt install mariadb-server Creo la BD para Nextcloud: CREATE DATABASE `nextcloud_db`; Creo un usuario con permisos sobre nextcloud_db : CREATE USER 'nextcloud_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'nextcloud_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `nextcloud_db`.* TO 'nextcloud_user'@localhost; FLUSH PRIVILEGES; Parte 5 Descargar Nextcloud En /var/www/nextcloud hago lo siguiente: sudo apt install unzip sudo wget https://download.nextcloud.com/server/releases/nextcloud-22.2.1.zip sudo unzip nextcloud-22.2.1.zip sudo mv nextcloud cloud Cambio los propietarios: sudo chown -R www-data:www-data /var/www/nextcloud/ As\u00ed, consigo tener Nextcloud descargado en un directorio cloud dentro del Document Root /var/www/nextcloud , lo cual ser\u00e1 una situaci\u00f3n muy parecida a lo que tendr\u00e9 en el entorno de producci\u00f3n. Parte 6 Instalaci\u00f3n de Nextcloud Para empezar, accedo a www.nextcloud-adrianj.com/cloud Datos de la cuenta admin: Username: admin Password: admin1 Introduciendo esos datos, junto con los de conexi\u00f3n a la BD, instalamos: Despu\u00e9s de esto, ya tendr\u00edamos Nextcloud funcionando: Ejercicio 2 Realizar la migraci\u00f3n de Nextcloud, para que se acceda en www.adrianjaramillo.tk/cloud . Parte 1 Instalar dependencias y configurar php Instalo los siguientes paquetes necesarios para que Nextcloud funcione, y que faltan en el VPS: sudo apt install php-cli php-intl php-imagick php-dev php-soap php-bz2 Modifico las siguientes l\u00edneas en /etc/php/7.4/fpm/php.ini y /etc/php/7.4/cli/php.ini : date.timezone = Europe/Madrid cgi.fix_pathinfo=0 Descomentar las siguientes l\u00edneas en /etc/php/7.4/fpm/pool.d/www.conf : env[HOSTNAME] = $HOSTNAME env[PATH] = /usr/local/bin:/usr/bin:/bin env[TMP] = /tmp env[TMPDIR] = /tmp env[TEMP] = /tmp Habilito y reinicio php-fpm: sudo systemctl enable php7.4-fpm sudo systemctl restart php7.4-fpm Parte 2 Transferir el subdirectorio de Nextcloud al VPS mediante repositorios Hago una copia del subdirectorio que contiene la app en el home: sudo cp -r /var/www/nextcloud/cloud ~ Cambio los propietarios: sudo chown -R vagrant:vagrant ~/cloud/ Inicializo el directorio como repo git: git init Creo el repositorio en github: https://github.com/adriasir123/nextcloud-subdirectorio-cloud Subo el directorio al repositorio creado: git remote add origin git@github.com:adriasir123/nextcloud-subdirectorio-cloud.git git branch -M main git add . git config --global user.email \"adristudy@gmail.com\" git config --global user.name \"Adri\u00e1n Jaramillo Rodr\u00edguez\" git commit -m \"Initial commit\" git push -u origin main Me bajo el repositorio en /var/www/www/cloud del VPS: sudo git clone https://github.com/adriasir123/nextcloud-subdirectorio-cloud.git . Modifico los propietarios correctamente en /var/www/www/cloud/ : sudo chown -R www-data:www-data /var/www/www/cloud/ Parte 3 Migrar la BD al VPS Exporto la BD: sudo mysqldump -u root nextcloud_db > nextcloud_db.sql Creo la BD para Nextcloud: CREATE DATABASE `nextcloud_db`; Creo un usuario con permisos sobre nextcloud_db : CREATE USER 'nextcloud_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'nextcloud_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `nextcloud_db`.* TO 'nextcloud_user'@localhost; FLUSH PRIVILEGES; Importo la copia de seguridad: sudo mysql -u root nextcloud_db < nextcloud_db.sql Parte 4 Cambiar el fichero de configuraci\u00f3n de Nextcloud Modifico /var/www/www/cloud/config/config.php : <?php $CONFIG = array ( 'instanceid' => 'ocr2lp6lisyt', 'passwordsalt' => 'RjrrSdcDyvgGXhx/Grnoccv298gljL', 'secret' => 'b7JkIA6v1+MGT70voUpA9XOvvMRVAc/PsgImxoDmYQytgHut', 'trusted_domains' => array ( 0 => 'www.adrianjaramillo.tk', ), 'datadirectory' => '/var/www/www/cloud/data', 'dbtype' => 'mysql', 'version' => '22.2.1.2', 'overwrite.cli.url' => 'http://www.adrianjaramillo.tk/cloud', 'dbname' => 'nextcloud_db', 'dbhost' => 'bd.adrianjaramillo.tk', 'dbport' => '', 'dbtableprefix' => 'oc_', 'mysql.utf8mb4' => true, 'dbuser' => 'nextcloud_user', 'dbpassword' => '1234', 'installed' => true, ); Parte 5 Configurar Nginx Hago una copia de seguridad del VirtualHost que voy a modificar: sudo cp www.conf www.conf.backup Modifico www.conf : server { ########### # GENERAL # ########### listen 80; server_name www.adrianjaramillo.tk; root /var/www/www; index index.html index.htm; error_page 404 /error/404.html; error_page 403 /error/403.html; ############# # PRINCIPAL # ############# rewrite ^/$ http://www.adrianjaramillo.tk/principal permanent; location /principal { autoindex off; disable_symlinks on; } location /principal/documentos { alias /srv/doc; autoindex on; disable_symlinks off; } location /secreto { auth_basic \"Acceso restringido\"; auth_basic_user_file /etc/nginx/.htpasswd; } ############# # NEXTCLOUD # ############# location = /robots.txt { allow all; log_not_found off; access_log off; } location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in the Nextcloud `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 /cloud/remote.php/dav/; } location = /.well-known/caldav { return 301 /cloud/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 /cloud/index.php$request_uri; } location ^~ /cloud { # set max upload size and increase upload timeout: client_max_body_size 512M; client_body_timeout 300s; fastcgi_buffers 64 4K; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Specify how to handle directories -- specifying `/nextcloud/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /nextcloud/index.php$request_uri` # always provides the desired behaviour. index index.php index.html /cloud/index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = /cloud { if ( $http_user_agent ~ ^DavClnt ) { return 302 /cloud/remote.php/webdav/$is_args$args; } } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends # `/nextcloud/index.php` to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { # Required for legacy support rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri; fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif|png|jpg|ico)$ { try_files $uri /cloud/index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /cloud/index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /cloud/remote { return 301 /cloud/remote.php$request_uri; } location /cloud { try_files $uri $uri/ /cloud/index.php$request_uri; } } } Despu\u00e9s de esto, reinicio tanto Nginx como PHP-FPM para asegurarme de que no tendr\u00e9 problemas al hacer las pruebas: sudo systemctl restart nginx.service sudo systemctl restart php7.4-fpm.service Parte 6 Comprobar que Nextcloud funciona en el VPS accediendo a www.adrianjaramillo.tk/cloud Parte 7 Comprobar que la p\u00e1gina principal sigue funcionando, junto con las configuraciones que ten\u00eda Ejercicio 3 Instalar en tu m\u00e1quina el cliente de Nextcloud y configurarlo para el acceso al VPS. Est\u00e1 disponible en los repositorios de Debian, por lo que: sudo apt update sudo apt install nextcloud-desktop Paso a configurarlo: Nos pide autenticarnos desde el navegador antes de entrar: El directorio local indicado, es el que se utilizar\u00e1 para la sincronizaci\u00f3n: As\u00ed se ver\u00eda nuestro cliente despu\u00e9s de haber sincronizado y estar funcionando: Abajo muestro el directorio local que me ha sincronizado el cliente: Tarea 3 Modificar la web principal con accesos a las 2 apps migradas","title":"Pr\u00e1ctica 2: Instalaci\u00f3n/migraci\u00f3n de apps a VPS"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#practica-2-instalacionmigracion-de-aplicaciones-web-php-en-tu-vps","text":"","title":"Pr\u00e1ctica 2: Instalaci\u00f3n/migraci\u00f3n de aplicaciones web PHP en tu VPS"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#tarea-1-migracion-de-phpbb","text":"","title":"Tarea 1: Migraci\u00f3n de phpBB"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-1","text":"Crear VirtualHost con server_name portal.adrianjaramillo.tk Creo /etc/nginx/sites-available/portal.conf : server { listen 80; server_name portal.adrianjaramillo.tk; root /var/www/portal; location / { index index.php index.html index.htm; } location ~ \\.php$ { include fastcgi_params; fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/portal.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx Creo un registro CNAME en la zona DNS p\u00fablica para portal.adrianjaramillo.tk :","title":"Ejercicio 1"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-2","text":"Nombrar en /etc/hosts la BD como bd.adrianjaramillo.tk Modifico la siguiente l\u00ednea en /etc/hosts : 127.0.0.1 localhost.localdomain localhost bd.adrianjaramillo.tk Muestro que funciona: blackmamba@kampe:/etc/nginx/sites-available$ ping bd.adrianjaramillo.tk PING localhost.localdomain (127.0.0.1) 56(84) bytes of data. 64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=1 ttl=64 time=0.039 ms 64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=2 ttl=64 time=0.058 ms ^C --- localhost.localdomain ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1031ms rtt min/avg/max/mdev = 0.039/0.048/0.058/0.009 ms","title":"Ejercicio 2"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-3","text":"Realizar la migraci\u00f3n de phpBB.","title":"Ejercicio 3"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-1","text":"Instalar las dependencias de paqueter\u00eda requeridas para que phpBB funcione sudo apt install php-json php-mbstring php-xml php-mysql php-pdo php-zip php-gd php-curl php-pear php-bcmath","title":"Parte 1"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-2","text":"Transferir el DocumentRoot de phpBB al VPS mediante repositorios Hago una copia del DocumentRoot en el home: sudo cp -r /var/www/phpBB ~ Cambio los propietarios: sudo chown -R vagrant:vagrant ~/phpBB/ Inicializo el directorio como repo git: git init Creo el repositorio en github: https://github.com/adriasir123/phpBB-document-root Subo el directorio al repositorio creado: git remote add origin git@github.com:adriasir123/phpBB-document-root.git git branch -M main git add . git config --global user.email \"adristudy@gmail.com\" git config --global user.name \"Adri\u00e1n Jaramillo Rodr\u00edguez\" git commit -m \"Initial commit\" git push -u origin main Me bajo el repositorio en /var/www/portal del VPS: sudo git clone https://github.com/adriasir123/phpBB-document-root.git . Modifico los propietarios correctamente en /var/www/portal/ : sudo chown -R www-data:www-data /var/www/portal/","title":"Parte 2"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-3","text":"Migrar la BD al VPS Exporto la BD: sudo mysqldump -u root phpBB_db > phpBB_db.sql Creo la BD en el VPS: CREATE DATABASE `phpBB_db`; Creo un usuario con permisos sobre phpBB_db : CREATE USER 'phpBB_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'phpBB_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `phpBB_db`.* TO 'phpBB_user'@localhost; FLUSH PRIVILEGES; Importo la copia de seguridad: sudo mysql -u root phpBB_db < phpBB_db.sql","title":"Parte 3"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-4","text":"Cambiar los datos de conexi\u00f3n a la base de datos Modifico la siguiente l\u00ednea en config.php : $dbhost = 'bd.adrianjaramillo.tk';","title":"Parte 4"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-4","text":"Comprobar que phpBB sigue funcionando en portal.adrianjaramillo.tk","title":"Ejercicio 4"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#tarea-2-instalacionmigracion-nextcloud","text":"","title":"Tarea 2: Instalaci\u00f3n/migraci\u00f3n Nextcloud"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-1_1","text":"Instalar Nextcloud en el entorno de desarrollo.","title":"Ejercicio 1"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-1_1","text":"Crear el escenario Vagrant.configure(\"2\") do |config| config.vm.synced_folder \".\", \"/vagrant\", disabled: true config.vm.define :nextcloudnginx do |nextcloudnginx| nextcloudnginx.vm.box = \"debian/bullseye64\" nextcloudnginx.vm.hostname = \"nextcloudnginx\" end end","title":"Parte 1"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-2_1","text":"Instalar y configurar Nginx Lo instalo: sudo apt update sudo apt install curl gnupg2 ca-certificates lsb-release sudo apt install nginx Creo /etc/nginx/sites-available/nextcloud.conf , con server_name www.nextcloud-adrianj.com : server { listen 80; server_name www.nextcloud-adrianj.com; # Path to the root of the domain root /var/www/nextcloud; location = /robots.txt { allow all; log_not_found off; access_log off; } location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in the Nextcloud `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 /cloud/remote.php/dav/; } location = /.well-known/caldav { return 301 /cloud/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 /cloud/index.php$request_uri; } location ^~ /cloud { # set max upload size and increase upload timeout: client_max_body_size 512M; client_body_timeout 300s; fastcgi_buffers 64 4K; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Specify how to handle directories -- specifying `/nextcloud/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /nextcloud/index.php$request_uri` # always provides the desired behaviour. index index.php index.html /cloud/index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = /cloud { if ( $http_user_agent ~ ^DavClnt ) { return 302 /cloud/remote.php/webdav/$is_args$args; } } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends # `/nextcloud/index.php` to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { # Required for legacy support rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri; fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif|png|jpg|ico)$ { try_files $uri /cloud/index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /cloud/index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /cloud/remote { return 301 /cloud/remote.php$request_uri; } location /cloud { try_files $uri $uri/ /cloud/index.php$request_uri; } } } Nextcloud no est\u00e1 oficialmente soportado para Nginx, as\u00ed que esta configuraci\u00f3n est\u00e1 hecha por contribuidores. Igualmente, est\u00e1 publicada en la documentaci\u00f3n oficial de Nextcloud: https://docs.nextcloud.com/server/latest/admin_manual/installation/nginx.html#nextcloud-in-a-subdir-of-the-nginx-webroot Espec\u00edficamente, he elegido hacer la manera en subdirectorio, para que mi entorno de desarrollo y el de producci\u00f3n sean lo m\u00e1s parecidos posible. As\u00ed, la migraci\u00f3n luego ser\u00e1 m\u00e1s sencilla. Lo habilito: sudo ln -s /etc/nginx/sites-available/nextcloud.conf /etc/nginx/sites-enabled/ Compruebo que la configuraci\u00f3n sea correcta: sudo nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful Reinicio Nginx: sudo systemctl restart nginx Modifico mi /etc/hosts : # nextcloudnginx resolutions 192.168.121.62 www.nextcloud-adrianj.com","title":"Parte 2"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-3_1","text":"Instalar y configurar php Instalo PHP-FPM y dependencias php para Nextcloud: sudo apt install php-fpm php-mysql php-zip php-xml php-mbstring php-gd php-curl php-cli php-common php-json php-intl php-pear php-imagick php-dev php-soap php-bz2 Modifico las siguientes l\u00edneas en /etc/php/7.4/fpm/php.ini y /etc/php/7.4/cli/php.ini : date.timezone = Europe/Madrid cgi.fix_pathinfo=0 Descomentar las siguientes l\u00edneas en /etc/php/7.4/fpm/pool.d/www.conf : env[HOSTNAME] = $HOSTNAME env[PATH] = /usr/local/bin:/usr/bin:/bin env[TMP] = /tmp env[TMPDIR] = /tmp env[TEMP] = /tmp Habilito y reinicio php-fpm: sudo systemctl enable php7.4-fpm sudo systemctl restart php7.4-fpm","title":"Parte 3"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-4_1","text":"Instalar servidor MariaDB sudo apt install mariadb-server Creo la BD para Nextcloud: CREATE DATABASE `nextcloud_db`; Creo un usuario con permisos sobre nextcloud_db : CREATE USER 'nextcloud_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'nextcloud_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `nextcloud_db`.* TO 'nextcloud_user'@localhost; FLUSH PRIVILEGES;","title":"Parte 4"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-5","text":"Descargar Nextcloud En /var/www/nextcloud hago lo siguiente: sudo apt install unzip sudo wget https://download.nextcloud.com/server/releases/nextcloud-22.2.1.zip sudo unzip nextcloud-22.2.1.zip sudo mv nextcloud cloud Cambio los propietarios: sudo chown -R www-data:www-data /var/www/nextcloud/ As\u00ed, consigo tener Nextcloud descargado en un directorio cloud dentro del Document Root /var/www/nextcloud , lo cual ser\u00e1 una situaci\u00f3n muy parecida a lo que tendr\u00e9 en el entorno de producci\u00f3n.","title":"Parte 5"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-6","text":"Instalaci\u00f3n de Nextcloud Para empezar, accedo a www.nextcloud-adrianj.com/cloud Datos de la cuenta admin: Username: admin Password: admin1 Introduciendo esos datos, junto con los de conexi\u00f3n a la BD, instalamos: Despu\u00e9s de esto, ya tendr\u00edamos Nextcloud funcionando:","title":"Parte 6"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-2_1","text":"Realizar la migraci\u00f3n de Nextcloud, para que se acceda en www.adrianjaramillo.tk/cloud .","title":"Ejercicio 2"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-1_2","text":"Instalar dependencias y configurar php Instalo los siguientes paquetes necesarios para que Nextcloud funcione, y que faltan en el VPS: sudo apt install php-cli php-intl php-imagick php-dev php-soap php-bz2 Modifico las siguientes l\u00edneas en /etc/php/7.4/fpm/php.ini y /etc/php/7.4/cli/php.ini : date.timezone = Europe/Madrid cgi.fix_pathinfo=0 Descomentar las siguientes l\u00edneas en /etc/php/7.4/fpm/pool.d/www.conf : env[HOSTNAME] = $HOSTNAME env[PATH] = /usr/local/bin:/usr/bin:/bin env[TMP] = /tmp env[TMPDIR] = /tmp env[TEMP] = /tmp Habilito y reinicio php-fpm: sudo systemctl enable php7.4-fpm sudo systemctl restart php7.4-fpm","title":"Parte 1"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-2_2","text":"Transferir el subdirectorio de Nextcloud al VPS mediante repositorios Hago una copia del subdirectorio que contiene la app en el home: sudo cp -r /var/www/nextcloud/cloud ~ Cambio los propietarios: sudo chown -R vagrant:vagrant ~/cloud/ Inicializo el directorio como repo git: git init Creo el repositorio en github: https://github.com/adriasir123/nextcloud-subdirectorio-cloud Subo el directorio al repositorio creado: git remote add origin git@github.com:adriasir123/nextcloud-subdirectorio-cloud.git git branch -M main git add . git config --global user.email \"adristudy@gmail.com\" git config --global user.name \"Adri\u00e1n Jaramillo Rodr\u00edguez\" git commit -m \"Initial commit\" git push -u origin main Me bajo el repositorio en /var/www/www/cloud del VPS: sudo git clone https://github.com/adriasir123/nextcloud-subdirectorio-cloud.git . Modifico los propietarios correctamente en /var/www/www/cloud/ : sudo chown -R www-data:www-data /var/www/www/cloud/","title":"Parte 2"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-3_2","text":"Migrar la BD al VPS Exporto la BD: sudo mysqldump -u root nextcloud_db > nextcloud_db.sql Creo la BD para Nextcloud: CREATE DATABASE `nextcloud_db`; Creo un usuario con permisos sobre nextcloud_db : CREATE USER 'nextcloud_user' IDENTIFIED BY '1234'; GRANT USAGE ON *.* TO 'nextcloud_user'@localhost IDENTIFIED BY '1234'; GRANT ALL privileges ON `nextcloud_db`.* TO 'nextcloud_user'@localhost; FLUSH PRIVILEGES; Importo la copia de seguridad: sudo mysql -u root nextcloud_db < nextcloud_db.sql","title":"Parte 3"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-4_2","text":"Cambiar el fichero de configuraci\u00f3n de Nextcloud Modifico /var/www/www/cloud/config/config.php : <?php $CONFIG = array ( 'instanceid' => 'ocr2lp6lisyt', 'passwordsalt' => 'RjrrSdcDyvgGXhx/Grnoccv298gljL', 'secret' => 'b7JkIA6v1+MGT70voUpA9XOvvMRVAc/PsgImxoDmYQytgHut', 'trusted_domains' => array ( 0 => 'www.adrianjaramillo.tk', ), 'datadirectory' => '/var/www/www/cloud/data', 'dbtype' => 'mysql', 'version' => '22.2.1.2', 'overwrite.cli.url' => 'http://www.adrianjaramillo.tk/cloud', 'dbname' => 'nextcloud_db', 'dbhost' => 'bd.adrianjaramillo.tk', 'dbport' => '', 'dbtableprefix' => 'oc_', 'mysql.utf8mb4' => true, 'dbuser' => 'nextcloud_user', 'dbpassword' => '1234', 'installed' => true, );","title":"Parte 4"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-5_1","text":"Configurar Nginx Hago una copia de seguridad del VirtualHost que voy a modificar: sudo cp www.conf www.conf.backup Modifico www.conf : server { ########### # GENERAL # ########### listen 80; server_name www.adrianjaramillo.tk; root /var/www/www; index index.html index.htm; error_page 404 /error/404.html; error_page 403 /error/403.html; ############# # PRINCIPAL # ############# rewrite ^/$ http://www.adrianjaramillo.tk/principal permanent; location /principal { autoindex off; disable_symlinks on; } location /principal/documentos { alias /srv/doc; autoindex on; disable_symlinks off; } location /secreto { auth_basic \"Acceso restringido\"; auth_basic_user_file /etc/nginx/.htpasswd; } ############# # NEXTCLOUD # ############# location = /robots.txt { allow all; log_not_found off; access_log off; } location ^~ /.well-known { # The rules in this block are an adaptation of the rules # in the Nextcloud `.htaccess` that concern `/.well-known`. location = /.well-known/carddav { return 301 /cloud/remote.php/dav/; } location = /.well-known/caldav { return 301 /cloud/remote.php/dav/; } location /.well-known/acme-challenge { try_files $uri $uri/ =404; } location /.well-known/pki-validation { try_files $uri $uri/ =404; } # Let Nextcloud's API for `/.well-known` URIs handle all other # requests by passing them to the front-end controller. return 301 /cloud/index.php$request_uri; } location ^~ /cloud { # set max upload size and increase upload timeout: client_max_body_size 512M; client_body_timeout 300s; fastcgi_buffers 64 4K; # Enable gzip but do not remove ETag headers gzip on; gzip_vary on; gzip_comp_level 4; gzip_min_length 256; gzip_proxied expired no-cache no-store private no_last_modified no_etag auth; gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy; # Pagespeed is not supported by Nextcloud, so if your server is built # with the `ngx_pagespeed` module, uncomment this line to disable it. #pagespeed off; # HTTP response headers borrowed from Nextcloud `.htaccess` add_header Referrer-Policy \"no-referrer\" always; add_header X-Content-Type-Options \"nosniff\" always; add_header X-Download-Options \"noopen\" always; add_header X-Frame-Options \"SAMEORIGIN\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always; add_header X-Robots-Tag \"none\" always; add_header X-XSS-Protection \"1; mode=block\" always; # Remove X-Powered-By, which is an information leak fastcgi_hide_header X-Powered-By; # Specify how to handle directories -- specifying `/nextcloud/index.php$request_uri` # here as the fallback means that Nginx always exhibits the desired behaviour # when a client requests a path that corresponds to a directory that exists # on the server. In particular, if that directory contains an index.php file, # that file is correctly served; if it doesn't, then the request is passed to # the front-end controller. This consistent behaviour means that we don't need # to specify custom rules for certain paths (e.g. images and other assets, # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus # `try_files $uri $uri/ /nextcloud/index.php$request_uri` # always provides the desired behaviour. index index.php index.html /cloud/index.php$request_uri; # Rule borrowed from `.htaccess` to handle Microsoft DAV clients location = /cloud { if ( $http_user_agent ~ ^DavClnt ) { return 302 /cloud/remote.php/webdav/$is_args$args; } } # Rules borrowed from `.htaccess` to hide certain paths from clients location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; } location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console) { return 404; } # Ensure this block, which passes PHP files to the PHP process, is above the blocks # which handle static assets (as seen below). If this block is not declared first, # then Nginx will encounter an infinite rewriting loop when it prepends # `/nextcloud/index.php` to the URI, resulting in a HTTP 500 error response. location ~ \\.php(?:$|/) { # Required for legacy support rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri; fastcgi_split_path_info ^(.+?\\.php)(/.*)$; set $path_info $fastcgi_path_info; try_files $fastcgi_script_name =404; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $path_info; fastcgi_param modHeadersAvailable true; # Avoid sending the security headers twice fastcgi_param front_controller_active true; # Enable pretty urls fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; fastcgi_intercept_errors on; fastcgi_request_buffering off; } location ~ \\.(?:css|js|svg|gif|png|jpg|ico)$ { try_files $uri /cloud/index.php$request_uri; expires 6M; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } location ~ \\.woff2?$ { try_files $uri /cloud/index.php$request_uri; expires 7d; # Cache-Control policy borrowed from `.htaccess` access_log off; # Optional: Don't log access to assets } # Rule borrowed from `.htaccess` location /cloud/remote { return 301 /cloud/remote.php$request_uri; } location /cloud { try_files $uri $uri/ /cloud/index.php$request_uri; } } } Despu\u00e9s de esto, reinicio tanto Nginx como PHP-FPM para asegurarme de que no tendr\u00e9 problemas al hacer las pruebas: sudo systemctl restart nginx.service sudo systemctl restart php7.4-fpm.service","title":"Parte 5"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-6_1","text":"Comprobar que Nextcloud funciona en el VPS accediendo a www.adrianjaramillo.tk/cloud","title":"Parte 6"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#parte-7","text":"Comprobar que la p\u00e1gina principal sigue funcionando, junto con las configuraciones que ten\u00eda","title":"Parte 7"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#ejercicio-3_1","text":"Instalar en tu m\u00e1quina el cliente de Nextcloud y configurarlo para el acceso al VPS. Est\u00e1 disponible en los repositorios de Debian, por lo que: sudo apt update sudo apt install nextcloud-desktop Paso a configurarlo: Nos pide autenticarnos desde el navegador antes de entrar: El directorio local indicado, es el que se utilizar\u00e1 para la sincronizaci\u00f3n: As\u00ed se ver\u00eda nuestro cliente despu\u00e9s de haber sincronizado y estar funcionando: Abajo muestro el directorio local que me ha sincronizado el cliente:","title":"Ejercicio 3"},{"location":"practica2-instalacion-migracion-apps-PHP-en-VPS/#tarea-3","text":"Modificar la web principal con accesos a las 2 apps migradas","title":"Tarea 3"},{"location":"practica3-LEMP-VPS/","text":"Pr\u00e1ctica : Instalaci\u00f3n de un servidor LEMP en nuestra VPS Instalaci\u00f3n Ejercicio 1 Instalar Nginx sudo apt update sudo apt install curl gnupg2 ca-certificates lsb-release sudo apt install nginx Ejercicio 2 Instalar servidor MariaDB sudo apt install mariadb-server Ejecutar mysql_secure_installation sudo mysql_secure_installation Enter current password for root (enter for none): Switch to unix_socket authentication [Y/n] n Change the root password? [Y/n] n Remove anonymous users? [Y/n] y Disallow root login remotely? [Y/n] y Remove test database and access to it? [Y/n] y Reload privilege tables now? [Y/n] y Muestro s\u00f3lo mis respuestas durante el script, el resto del output innecesario lo he borrado. Ejercicio 3 Instalar un servidor de aplicaciones PHP-FPM sudo apt install php-fpm VirtualHosting Ejercicio 1 Crear VirtualHost con server_name www.adrianjaramillo.tk Creo /etc/nginx/sites-available/www.conf : server { listen 80; server_name www.adrianjaramillo.tk; location / { root /var/www/www; index index.html index.htm; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/www.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx Crear nuevo registro CNAME en la zona DNS p\u00fablica para www.adrianjaramillo.tk Ejercicio 2 Redirige el VirtualHost por defecto default al VirtualHost de www.adrianjaramillo.tk A\u00f1ado la siguiente l\u00ednea a /etc/nginx/sites-available/default : return 301 $scheme://www.adrianjaramillo.tk$request_uri; Reinicio Nginx: sudo systemctl restart nginx Muestro que funciona la redirecci\u00f3n: Mapeo de URL Ejercicio 1 Redigir www.adrianjaramillo.tk a www.adrianjaramillo.tk/principal A\u00f1ado la siguiente l\u00ednea a /etc/nginx/sites-available/www.conf : rewrite ^/$ http://www.adrianjaramillo.tk/principal permanent; Reinicio Nginx: sudo systemctl restart nginx En principal , creo un index.html de prueba. Muestro que funciona la redirecci\u00f3n: En principal no se permite: Listar ficheros Enlaces simb\u00f3licos Antes de nada, borro el /var/www/www/principal/index.html que previamente cre\u00e9. \u00bfRaz\u00f3n? ngx_http_autoindex_module s\u00f3lo empieza a funcionar cuando no encuentra un index.html . Creo la siguiente estructura de prueba en principal : blackmamba@kampe:/var/www/www/principal$ ls -la total 16 drwxr-xr-x 2 root root 4096 Nov 9 22:23 . drwxr-xr-x 3 root root 4096 Nov 9 19:55 .. -rw-r--r-- 1 root root 9 Nov 9 19:55 fich1.txt -rw-r--r-- 1 root root 9 Nov 9 19:56 fich2.txt lrwxrwxrwx 1 root root 9 Nov 9 19:58 motd -> /etc/motd Modifico /etc/nginx/sites-available/www.conf : server { listen 80; server_name www.adrianjaramillo.tk; root /var/www/www; rewrite ^/$ http://www.adrianjaramillo.tk/principal permanent; location / { index index.html index.htm; } location /principal { autoindex off; disable_symlinks on; } } Reinicio Nginx: sudo systemctl restart nginx Muestro que autoindex off funciona: Intento acceder al enlace simb\u00f3lico para mostrar que disable_symlinks on funciona: Ejercicio 2 En www.adrianjaramillo.tk/principal , bajar una plantilla de index.html con tu nombre, y una lista de enlaces a las aplicaciones que desplegaremos Me bajo la plantilla en principal : sudo apt install unzip sudo wget https://www.free-css.com/assets/files/free-css-templates/download/page270/univers.zip sudo unzip univers.zip Muestro que funciona y tiene mi nombre: Ejercicio 3 Al acceder a www.adrianjaramillo.tk/principal/documentos se visualizar\u00e1 /srv/doc Se permitir\u00e1: Listar ficheros Enlaces simb\u00f3licos Creo la siguiente estructura en /srv/doc : blackmamba@kampe:/srv/doc$ ls -la total 28 drwxr-xr-x 2 root root 4096 Nov 10 09:58 . drwxr-xr-x 3 root root 4096 Nov 10 09:25 .. -rw-r--r-- 1 root root 13264 Aug 27 2007 dummy.pdf lrwxrwxrwx 1 root root 32 Nov 10 09:58 fich1.txt -> /var/www/www/principal/fich1.txt -rw-r--r-- 1 root root 3028 Feb 24 2017 sample.pdf A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : location /principal/documentos { alias /srv/doc; autoindex on; disable_symlinks off; } Reinicio Nginx: sudo systemctl restart nginx Muestro que funciona autoindex : Muestro que se ven los ficheros: Muestro que se ve el enlace simb\u00f3lico: Ejercicio 4 Redirigir errores 404 y 403 para todo el VirtualHost www.adrianjaramillo.tk . Crear 2 html dentro del directorio error. Creo la siguiente estructura en /error : blackmamba@kampe:/var/www/www/error$ ls -la total 24 drwxr-xr-x 2 root root 4096 Nov 10 11:43 . drwxr-xr-x 4 root root 4096 Nov 10 11:12 .. -rw-r--r-- 1 root root 2518 Nov 10 11:43 403.html -rw-r--r-- 1 root root 8788 Nov 10 11:22 404.html A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : error_page 404 /error/404.html; error_page 403 /error/403.html; Reinicio Nginx: sudo systemctl restart nginx Muestro que el error 404 funciona accediendo a /noexiste : Muestro que el error 403 funciona accediendo al enlace simb\u00f3lico dentro de /principal (recordamos que en ese directorio ten\u00edamos disable_symlinks on ) : Autenticaci\u00f3n Ejercicio 1 Autenticaci\u00f3n b\u00e1sica en www.adrianjaramillo.tk/secreto Creo la siguiente estructura en /var/www/www/secreto : blackmamba@kampe:/var/www/www/secreto$ ls -la total 12 drwxr-xr-x 2 root root 4096 Nov 10 17:44 . drwxr-xr-x 5 root root 4096 Nov 10 17:39 .. -rw-r--r-- 1 root root 235 Nov 10 17:44 index.html Instalo el paquete que nos proporciona el binario htpasswd , que necesitaremos: sudo apt install apache2-utils Creo el fichero de credenciales, a\u00f1adiendo un usuario admin con contrase\u00f1a admin : sudo htpasswd -c /etc/nginx/.htpasswd admin A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : location /secreto { auth_basic \"Acceso restringido\"; auth_basic_user_file /etc/nginx/.htpasswd; } Reinicio Nginx: sudo systemctl restart nginx Muestro que funciona: PHP Ejercicio 1 Comprobar la configuraci\u00f3n de PHP-FPM por defecto (socket unix o socket TCP) Para comprobarlo, ejecuto: cat /etc/php/7.4/fpm/pool.d/www.conf | grep \"listen =\" listen = /run/php/php7.4-fpm.sock Vemos que por defecto PHP-FPM se configura escuchando en un socket unix. Configurar VirtualHost www.adrianjaramillo.tk para que pueda ejecutar PHP A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : location ~ \\.php$ { fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } Reinicio Nginx: sudo systemctl restart nginx Ejercicio 2 Crear un info.php que demuestre que funciona la ejecuci\u00f3n PHP En /var/www/www/principal me descargo un info.php de prueba: sudo wget https://gist.githubusercontent.com/SyntaxC4/5648247/raw/94277156638f9c309f2e36e19bff378ba7364907/info.php Muestro que funciona: Ansible Hacer configuraci\u00f3n b\u00e1sica de Nginx con ansible, partiendo de: https://fp.josedomingo.org/sri2122/u03/doc/ejercicio_proxy/ejercicio_proxy.zip Repositorio con mi configuraci\u00f3n: https://github.com/adriasir123/ansible-nginx","title":"Pr\u00e1ctica: LEMP en VPS"},{"location":"practica3-LEMP-VPS/#practica-instalacion-de-un-servidor-lemp-en-nuestra-vps","text":"","title":"Pr\u00e1ctica : Instalaci\u00f3n de un servidor LEMP en nuestra VPS"},{"location":"practica3-LEMP-VPS/#instalacion","text":"","title":"Instalaci\u00f3n"},{"location":"practica3-LEMP-VPS/#ejercicio-1","text":"Instalar Nginx sudo apt update sudo apt install curl gnupg2 ca-certificates lsb-release sudo apt install nginx","title":"Ejercicio 1"},{"location":"practica3-LEMP-VPS/#ejercicio-2","text":"Instalar servidor MariaDB sudo apt install mariadb-server Ejecutar mysql_secure_installation sudo mysql_secure_installation Enter current password for root (enter for none): Switch to unix_socket authentication [Y/n] n Change the root password? [Y/n] n Remove anonymous users? [Y/n] y Disallow root login remotely? [Y/n] y Remove test database and access to it? [Y/n] y Reload privilege tables now? [Y/n] y Muestro s\u00f3lo mis respuestas durante el script, el resto del output innecesario lo he borrado.","title":"Ejercicio 2"},{"location":"practica3-LEMP-VPS/#ejercicio-3","text":"Instalar un servidor de aplicaciones PHP-FPM sudo apt install php-fpm","title":"Ejercicio 3"},{"location":"practica3-LEMP-VPS/#virtualhosting","text":"","title":"VirtualHosting"},{"location":"practica3-LEMP-VPS/#ejercicio-1_1","text":"Crear VirtualHost con server_name www.adrianjaramillo.tk Creo /etc/nginx/sites-available/www.conf : server { listen 80; server_name www.adrianjaramillo.tk; location / { root /var/www/www; index index.html index.htm; } } Lo habilito: sudo ln -s /etc/nginx/sites-available/www.conf /etc/nginx/sites-enabled/ Reinicio Nginx: sudo systemctl restart nginx Crear nuevo registro CNAME en la zona DNS p\u00fablica para www.adrianjaramillo.tk","title":"Ejercicio 1"},{"location":"practica3-LEMP-VPS/#ejercicio-2_1","text":"Redirige el VirtualHost por defecto default al VirtualHost de www.adrianjaramillo.tk A\u00f1ado la siguiente l\u00ednea a /etc/nginx/sites-available/default : return 301 $scheme://www.adrianjaramillo.tk$request_uri; Reinicio Nginx: sudo systemctl restart nginx Muestro que funciona la redirecci\u00f3n:","title":"Ejercicio 2"},{"location":"practica3-LEMP-VPS/#mapeo-de-url","text":"","title":"Mapeo de URL"},{"location":"practica3-LEMP-VPS/#ejercicio-1_2","text":"Redigir www.adrianjaramillo.tk a www.adrianjaramillo.tk/principal A\u00f1ado la siguiente l\u00ednea a /etc/nginx/sites-available/www.conf : rewrite ^/$ http://www.adrianjaramillo.tk/principal permanent; Reinicio Nginx: sudo systemctl restart nginx En principal , creo un index.html de prueba. Muestro que funciona la redirecci\u00f3n: En principal no se permite: Listar ficheros Enlaces simb\u00f3licos Antes de nada, borro el /var/www/www/principal/index.html que previamente cre\u00e9. \u00bfRaz\u00f3n? ngx_http_autoindex_module s\u00f3lo empieza a funcionar cuando no encuentra un index.html . Creo la siguiente estructura de prueba en principal : blackmamba@kampe:/var/www/www/principal$ ls -la total 16 drwxr-xr-x 2 root root 4096 Nov 9 22:23 . drwxr-xr-x 3 root root 4096 Nov 9 19:55 .. -rw-r--r-- 1 root root 9 Nov 9 19:55 fich1.txt -rw-r--r-- 1 root root 9 Nov 9 19:56 fich2.txt lrwxrwxrwx 1 root root 9 Nov 9 19:58 motd -> /etc/motd Modifico /etc/nginx/sites-available/www.conf : server { listen 80; server_name www.adrianjaramillo.tk; root /var/www/www; rewrite ^/$ http://www.adrianjaramillo.tk/principal permanent; location / { index index.html index.htm; } location /principal { autoindex off; disable_symlinks on; } } Reinicio Nginx: sudo systemctl restart nginx Muestro que autoindex off funciona: Intento acceder al enlace simb\u00f3lico para mostrar que disable_symlinks on funciona:","title":"Ejercicio 1"},{"location":"practica3-LEMP-VPS/#ejercicio-2_2","text":"En www.adrianjaramillo.tk/principal , bajar una plantilla de index.html con tu nombre, y una lista de enlaces a las aplicaciones que desplegaremos Me bajo la plantilla en principal : sudo apt install unzip sudo wget https://www.free-css.com/assets/files/free-css-templates/download/page270/univers.zip sudo unzip univers.zip Muestro que funciona y tiene mi nombre:","title":"Ejercicio 2"},{"location":"practica3-LEMP-VPS/#ejercicio-3_1","text":"Al acceder a www.adrianjaramillo.tk/principal/documentos se visualizar\u00e1 /srv/doc Se permitir\u00e1: Listar ficheros Enlaces simb\u00f3licos Creo la siguiente estructura en /srv/doc : blackmamba@kampe:/srv/doc$ ls -la total 28 drwxr-xr-x 2 root root 4096 Nov 10 09:58 . drwxr-xr-x 3 root root 4096 Nov 10 09:25 .. -rw-r--r-- 1 root root 13264 Aug 27 2007 dummy.pdf lrwxrwxrwx 1 root root 32 Nov 10 09:58 fich1.txt -> /var/www/www/principal/fich1.txt -rw-r--r-- 1 root root 3028 Feb 24 2017 sample.pdf A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : location /principal/documentos { alias /srv/doc; autoindex on; disable_symlinks off; } Reinicio Nginx: sudo systemctl restart nginx Muestro que funciona autoindex : Muestro que se ven los ficheros: Muestro que se ve el enlace simb\u00f3lico:","title":"Ejercicio 3"},{"location":"practica3-LEMP-VPS/#ejercicio-4","text":"Redirigir errores 404 y 403 para todo el VirtualHost www.adrianjaramillo.tk . Crear 2 html dentro del directorio error. Creo la siguiente estructura en /error : blackmamba@kampe:/var/www/www/error$ ls -la total 24 drwxr-xr-x 2 root root 4096 Nov 10 11:43 . drwxr-xr-x 4 root root 4096 Nov 10 11:12 .. -rw-r--r-- 1 root root 2518 Nov 10 11:43 403.html -rw-r--r-- 1 root root 8788 Nov 10 11:22 404.html A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : error_page 404 /error/404.html; error_page 403 /error/403.html; Reinicio Nginx: sudo systemctl restart nginx Muestro que el error 404 funciona accediendo a /noexiste : Muestro que el error 403 funciona accediendo al enlace simb\u00f3lico dentro de /principal (recordamos que en ese directorio ten\u00edamos disable_symlinks on ) :","title":"Ejercicio 4"},{"location":"practica3-LEMP-VPS/#autenticacion","text":"","title":"Autenticaci\u00f3n"},{"location":"practica3-LEMP-VPS/#ejercicio-1_3","text":"Autenticaci\u00f3n b\u00e1sica en www.adrianjaramillo.tk/secreto Creo la siguiente estructura en /var/www/www/secreto : blackmamba@kampe:/var/www/www/secreto$ ls -la total 12 drwxr-xr-x 2 root root 4096 Nov 10 17:44 . drwxr-xr-x 5 root root 4096 Nov 10 17:39 .. -rw-r--r-- 1 root root 235 Nov 10 17:44 index.html Instalo el paquete que nos proporciona el binario htpasswd , que necesitaremos: sudo apt install apache2-utils Creo el fichero de credenciales, a\u00f1adiendo un usuario admin con contrase\u00f1a admin : sudo htpasswd -c /etc/nginx/.htpasswd admin A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : location /secreto { auth_basic \"Acceso restringido\"; auth_basic_user_file /etc/nginx/.htpasswd; } Reinicio Nginx: sudo systemctl restart nginx Muestro que funciona:","title":"Ejercicio 1"},{"location":"practica3-LEMP-VPS/#php","text":"","title":"PHP"},{"location":"practica3-LEMP-VPS/#ejercicio-1_4","text":"Comprobar la configuraci\u00f3n de PHP-FPM por defecto (socket unix o socket TCP) Para comprobarlo, ejecuto: cat /etc/php/7.4/fpm/pool.d/www.conf | grep \"listen =\" listen = /run/php/php7.4-fpm.sock Vemos que por defecto PHP-FPM se configura escuchando en un socket unix. Configurar VirtualHost www.adrianjaramillo.tk para que pueda ejecutar PHP A\u00f1ado lo siguiente a /etc/nginx/sites-available/www.conf : location ~ \\.php$ { fastcgi_pass unix:/run/php/php7.4-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } Reinicio Nginx: sudo systemctl restart nginx","title":"Ejercicio 1"},{"location":"practica3-LEMP-VPS/#ejercicio-2_3","text":"Crear un info.php que demuestre que funciona la ejecuci\u00f3n PHP En /var/www/www/principal me descargo un info.php de prueba: sudo wget https://gist.githubusercontent.com/SyntaxC4/5648247/raw/94277156638f9c309f2e36e19bff378ba7364907/info.php Muestro que funciona:","title":"Ejercicio 2"},{"location":"practica3-LEMP-VPS/#ansible","text":"Hacer configuraci\u00f3n b\u00e1sica de Nginx con ansible, partiendo de: https://fp.josedomingo.org/sri2122/u03/doc/ejercicio_proxy/ejercicio_proxy.zip Repositorio con mi configuraci\u00f3n: https://github.com/adriasir123/ansible-nginx","title":"Ansible"}]}